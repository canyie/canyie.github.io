<!DOCTYPE html><html><head hexo-theme="https://volantis.js.org/#2.5.1"><meta charset="utf-8"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>Android Runtime Resources Overlay 加载时序分析 - 残页的小博客</title><meta name="keywords" content="android,system,resources"><meta name="description" content="Fabricated Runtime Resources Overlay （FRRO） 是 Android 12 引入的一项新功能，它让开发者可以用代码或 shell 命令的方式动态操作 Runtime Resources Overlay（RRO） 而不需要像以前一样必须创建一个单独的 overlay app。然..."><link rel="alternate" href="/atom.xml" title="残页的小博客"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css"><link rel="shortcut icon" type="image/x-icon" href="/data/image/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>function setLoadingBarProgress(e){document.getElementById("loading-bar").style.width=e+"%"}</script><script type="text/javascript" src="/sw-register.js"></script></head><body><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><header class="l_header shadow blur"><div class="container"><div class="wrapper"><div class="nav-sub"><p class="title"></p><ul class="switcher nav-list-h"><li><a class="s-comment fas fa-comments fa-fw" target="_self" href="javascript:void(0)"></a></li><li><a class="s-toc fas fa-list fa-fw" target="_self" href="javascript:void(0)"></a></li></ul></div><div class="nav-main"><a class="title flat-box" target="_self" href="/">残页的小博客</a><div class="menu navigation"><ul class="nav-list-h"><li><a class="flat-box" href="/" id="home"><i class="fas fa-rss fa-fw"></i>博客</a></li><li><a class="flat-box" href="/tags/" id="tags"><i class="fas fa-tags fa-fw"></i>标签</a></li><li><a class="flat-box" href="/archives/" id="archives"><i class="fas fa-archive fa-fw"></i>归档</a></li><li><a class="flat-box" href="/friends/" id="friends"><i class="fas fa-link fa-fw"></i>友链</a></li><li><a class="flat-box" href="/about/" id="about"><i class="fas fa-info-circle fa-fw"></i>关于</a></li></ul></div><div class="m_search"><form name="searchform" class="form u-search-form"><i class="icon fas fa-search fa-fw"></i> <input type="text" class="input u-search-input" placeholder="搜索……"></form></div><ul class="switcher nav-list-h"><li><a class="s-search fas fa-search fa-fw" target="_self" href="javascript:void(0)"></a></li><li><a class="s-menu fas fa-bars fa-fw" target="_self" href="javascript:void(0)"></a><ul class="menu-phone list-v navigation white-box"><li><a class="flat-box" href="/" id="home"><i class="fas fa-rss fa-fw"></i>博客</a></li><li><a class="flat-box" href="/tags/" id="tags"><i class="fas fa-tags fa-fw"></i>标签</a></li><li><a class="flat-box" href="/archives/" id="archives"><i class="fas fa-archive fa-fw"></i>归档</a></li><li><a class="flat-box" href="/friends/" id="friends"><i class="fas fa-link fa-fw"></i>友链</a></li><li><a class="flat-box" href="/about/" id="about"><i class="fas fa-info-circle fa-fw"></i>关于</a></li></ul></li></ul></div></div></div></header><script>setLoadingBarProgress(40)</script><div class="l_body nocover"><div class="body-wrapper"><div class="l_main"><article id="post" class="post white-box shadow blur article-type-post" itemscope itemprop="blogPost"><section class="meta"><div class="meta" id="header-meta"><h1 class="title"><a href="/2025/08/24/android-runtime-resources-overlay-sequence/">Android Runtime Resources Overlay 加载时序分析</a></h1><div class="new-meta-box"><div class="new-meta-item author"><a href="https://blog.canyie.top/" rel="nofollow"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/data/image/avatar_new.jpg"><p>canyie</p></a></div><div class="new-meta-item date"><a class="notlink"><i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i><p>发布于2025年8月24日</p></a></div><div class="new-meta-item wordcount"><a class="notlink"><i class="fas fa-keyboard fa-fw" aria-hidden="true"></i><p>字数：6k字</p></a></div><div class="new-meta-item readtime"><a class="notlink"><i class="fas fa-hourglass-half fa-fw" aria-hidden="true"></i><p>时长：32分钟</p></a></div><div class="new-meta-item browse busuanzi"><a class="notlink"><i class="fas fa-eye fa-fw" aria-hidden="true"></i><p><span id="busuanzi_value_page_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></p></a></div></div><hr></div></section><section class="article typo"><div class="article-entry" itemprop="articleBody"><p>Fabricated Runtime Resources Overlay （FRRO） 是 Android 12 引入的一项新功能，它让开发者可以用代码或 shell 命令的方式动态操作 Runtime Resources Overlay（RRO） 而不需要像以前一样必须创建一个单独的 overlay app。然而四年后，网络上关于 FRRO 的文章依然少得可怜，所以在这里记录一次我调试 FRRO 问题的过程。</p><a id="more"></a><p>推荐阅读：</p><ul><li><a href="https://source.android.com/docs/core/runtime/rros?hl=zh-cn" target="_blank" rel="noopener">RRO 官方文档</a></li><li><a href="https://android.googlesource.com/platform/frameworks/base/+/6a2ca782d497e6fdb616f6a273409786a0b81f99" target="_blank" rel="noopener">引入 FRRO 的提交</a></li></ul><h2 id="起因：FRRO-失效？"><a href="#起因：FRRO-失效？" class="headerlink" title="起因：FRRO 失效？"></a>起因：FRRO 失效？</h2><p>在 PackageManagerService 内有如下伪代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getConfig</span><span class="params">(Context systemContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> systemContext.getResources().getString(R.string.config_xxxxxx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <code>frameworks/base/core/res/res/values/config.xml</code> 内有如下配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">"config_xxxxxx"</span>&gt;</span><span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br></pre></td></tr></table></figure><p>系统内部有一个包名为 <code>android.auto_generated_rro_product__</code> 的 RRO app 对该 string 进行了 overlay：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">"config_xxxxxx"</span>&gt;</span>From RRO<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br></pre></td></tr></table></figure><p>现在我想进行动态调试，快速修改这个 string 的值并观察系统反应。以往我们需要修改 RRO 中的值并重新编译系统，现在让我们试试 FRRO，root 下使用命令 <code>cmd overlay fabricate --target android --name test android:string/config_xxxxxx test</code> 创建一个 FRRO 然后 <code>cmd overlay enable</code> 一下，然后重启系统，看看反应！<br>嗯，一点反应都没有……在预期里，应该是哪里没做对，俗话说遇事不决就重启，换个重启方式试试？事实证明，无论是杀掉 zygote 触发软重启，还是使用 <code>reboot</code> 或 <code>svc power reboot</code> 发起真正的重启都没有任何改变。<br>那跑命令看一下 overlay 有没有生效？还好命令行也是能查询资源值的：<code>cmd overlay lookup android android:string/config_xxxxxx</code>。看输出结果确实已经被替换了。<br>脑袋要烧了，写代码验证一下是不是真的被替换了吧：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Resources res = Resouces.getSystem();</span><br><span class="line">print(res.getString(res.getIdentifier(<span class="string">"config_xxxxxx"</span>, <span class="string">"string"</span>, <span class="string">"android"</span>)));</span><br></pre></td></tr></table></figure><p>神奇的事情发生了，代码输出的结果是来自 RRO 的值，FRRO 没有替换成功！为什么呢？<br>会不会是出现某种权限问题，导致 app 进程无法打开 FRRO 所需的文件，所以 FRRO 没有生效呢？验证这个结论很简单，<code>cat /proc/$(pidof 进程名)/maps | grep frro</code> 看一下有没有我们自己的 FRRO 路径就好了。经过确认，是有的，这个结论不攻自破。<br>那会不会是系统原本自带的 RRO 比我们的 FRRO 优先级更高所以被优先使用了呢？<code>cmd overlay dump</code> 看一下就能知道新建的 FRRO 是启用状态，且优先级已经是最高的 <code>2147483647</code>。反之如果真的是这样，那么 <code>cmd overlay lookup</code> 也不会返回我们的值。又是一条死路。<br>这个时候我发现一个更神奇的现象：把上面代码的 <code>Resouces.getSystem()</code> 换成 <code>context.getResources()</code>，结果就正常了。<br>是什么导致了这个差异？它是 FRRO 对 PackageManagerService 内代码不生效的原因吗？想搞清楚这个问题，只能钻一遍 RRO 的加载流程了……</p><h2 id="不可变-RRO-在-Zygote-中的预加载"><a href="#不可变-RRO-在-Zygote-中的预加载" class="headerlink" title="不可变 RRO 在 Zygote 中的预加载"></a>不可变 RRO 在 Zygote 中的预加载</h2><p>想搞清楚 <code>Resources.getSystem()</code> 和 <code>context.getResources()</code> 的差别，首先让我们搞清楚它们都是从哪来的。点开 <code>Resources.getSystem()</code> 看一下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return a global shared Resources object that provides access to only</span></span><br><span class="line"><span class="comment"> * system resources (no application resources), is not configured for the</span></span><br><span class="line"><span class="comment"> * current screen (can not use dimension units, does not change based on</span></span><br><span class="line"><span class="comment"> * orientation, etc), and is not affected by Runtime Resource Overlay.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Resources <span class="title">getSystem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (sSync) &#123;</span><br><span class="line">        Resources ret = mSystem;</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ret = <span class="keyword">new</span> Resources();</span><br><span class="line">            mSystem = ret;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>它的注释里明确表示 <code>is not affected by Runtime Resource Overlay</code>，似乎我们的问题就这么简单地解决了，只是简单的 API 用错了而已……？<br>如果 <code>Resources.getSystem()</code> 真的完全不受 RRO 影响，那测试代码应该输出来自 <code>frameworks/base/core/res/res/values/config.xml</code> 的空值而不是来自 RRO 的值。所以问题并没有这么简单，我们继续。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Only for creating the System resources. This is the only constructor that doesn't add</span></span><br><span class="line"><span class="comment"> * Resources itself to the ResourcesManager list of all Resources references.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Resources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mClassLoader = ClassLoader.getSystemClassLoader();</span><br><span class="line">    sResourcesHistory.add(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> DisplayMetrics metrics = <span class="keyword">new</span> DisplayMetrics();</span><br><span class="line">    metrics.setToDefaults();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Configuration config = <span class="keyword">new</span> Configuration();</span><br><span class="line">    config.setToDefaults();</span><br><span class="line"></span><br><span class="line">    mResourcesImpl = <span class="keyword">new</span> ResourcesImpl(AssetManager.getSystem(), metrics, config,</span><br><span class="line">            <span class="keyword">new</span> DisplayAdjustments());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意 <code>AssetManager.getSystem()</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return a global shared asset manager that provides access to only</span></span><br><span class="line"><span class="comment"> * system assets (no application assets).</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AssetManager <span class="title">getSystem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (sSync) &#123;</span><br><span class="line">        createSystemAssetsInZygoteLocked(<span class="keyword">false</span>, FRAMEWORK_APK_PATH);</span><br><span class="line">        <span class="keyword">return</span> sSystem;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This must be called from Zygote so that system assets are shared by all applications.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"sSync"</span>)</span><br><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createSystemAssetsInZygoteLocked</span><span class="params">(<span class="keyword">boolean</span> reinitialize,</span></span></span><br><span class="line"><span class="function"><span class="params">        String frameworkPath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sSystem != <span class="keyword">null</span> &amp;&amp; !reinitialize) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;ApkAssets&gt; apkAssets = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        apkAssets.add(ApkAssets.loadFromPath(frameworkPath, ApkAssets.PROPERTY_SYSTEM));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO(Ravenwood): overlay support?</span></span><br><span class="line">        <span class="keyword">final</span> String[] systemIdmapPaths =</span><br><span class="line">                RavenwoodEnvironment.getInstance().isRunningOnRavenwood() ? <span class="keyword">new</span> String[<span class="number">0</span>] :</span><br><span class="line">                OverlayConfig.getZygoteInstance().createImmutableFrameworkIdmapsInZygote();</span><br><span class="line">        <span class="keyword">for</span> (String idmapPath : systemIdmapPaths) &#123;</span><br><span class="line">            apkAssets.add(ApkAssets.loadOverlayFromPath(idmapPath, ApkAssets.PROPERTY_SYSTEM));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sSystemApkAssetsSet = <span class="keyword">new</span> ArraySet&lt;&gt;(apkAssets);</span><br><span class="line">        sSystemApkAssets = apkAssets.toArray(<span class="keyword">new</span> ApkAssets[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (sSystem == <span class="keyword">null</span>) &#123;</span><br><span class="line">            sSystem = <span class="keyword">new</span> AssetManager(<span class="keyword">true</span> <span class="comment">/*sentinel*/</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sSystem.setApkAssets(sSystemApkAssets, <span class="keyword">false</span> <span class="comment">/*invalidateCaches*/</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to create system AssetManager"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们在这里首次看见了 overlay 字眼，<code>OverlayConfig</code> 这个类看名字就是解析 overlay 相关配置文件的，看一下它怎么做的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">OverlayConfig</span><span class="params">(@Nullable File rootDirectory,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable Supplier&lt;OverlayScanner&gt; scannerFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable PackageProvider packageProvider)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkArgument((scannerFactory == <span class="keyword">null</span>) != (packageProvider == <span class="keyword">null</span>),</span><br><span class="line">            <span class="string">"scannerFactory and packageProvider cannot be both null or both non-null"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;OverlayPartition&gt; partitions;</span><br><span class="line">    <span class="keyword">if</span> (rootDirectory == <span class="keyword">null</span>) &#123;</span><br><span class="line">        partitions = <span class="keyword">new</span> ArrayList&lt;&gt;(</span><br><span class="line">                PackagePartitions.getOrderedPartitions(OverlayPartition::<span class="keyword">new</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Rebase the system partitions and settings file on the specified root directory.</span></span><br><span class="line">        partitions = <span class="keyword">new</span> ArrayList&lt;&gt;(PackagePartitions.getOrderedPartitions(</span><br><span class="line">                p -&gt; <span class="keyword">new</span> OverlayPartition(</span><br><span class="line">                        <span class="keyword">new</span> File(rootDirectory, p.getNonConicalFolder().getPath()),</span><br><span class="line">                        p)));</span><br><span class="line">    &#125;</span><br><span class="line">    mIsDefaultPartitionOrder = !sortPartitions(PARTITION_ORDER_FILE_PATH, partitions);</span><br><span class="line">    mPartitionOrder = generatePartitionOrderString(partitions);</span><br><span class="line"></span><br><span class="line">    ArrayMap&lt;Integer, List&lt;String&gt;&gt; activeApexesPerPartition = getActiveApexes(partitions);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, ParsedOverlayInfo&gt; packageManagerOverlayInfos =</span><br><span class="line">            packageProvider == <span class="keyword">null</span> ? <span class="keyword">null</span> : getOverlayPackageInfos(packageProvider);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;ParsedConfiguration&gt; overlays = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, n = partitions.size(); i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> OverlayPartition partition = partitions.get(i);</span><br><span class="line">        <span class="keyword">final</span> OverlayScanner scanner = (scannerFactory == <span class="keyword">null</span>) ? <span class="keyword">null</span> : scannerFactory.get();</span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;ParsedConfiguration&gt; partitionOverlays =</span><br><span class="line">                OverlayConfigParser.getConfigurations(partition, scanner,</span><br><span class="line">                        packageManagerOverlayInfos,</span><br><span class="line">                        activeApexesPerPartition.getOrDefault(partition.type,</span><br><span class="line">                                Collections.emptyList()));</span><br><span class="line">        <span class="keyword">if</span> (partitionOverlays != <span class="keyword">null</span>) &#123;</span><br><span class="line">            overlays.addAll(partitionOverlays);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the configuration file is not present, then use android:isStatic and</span></span><br><span class="line">        <span class="comment">// android:priority to configure the overlays in the partition.</span></span><br><span class="line">        <span class="comment">// TODO(147840005): Remove converting static overlays to immutable, default-enabled</span></span><br><span class="line">        <span class="comment">//  overlays when android:siStatic and android:priority are fully deprecated.</span></span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;ParsedOverlayInfo&gt; partitionOverlayInfos;</span><br><span class="line">        <span class="keyword">if</span> (scannerFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">            partitionOverlayInfos = <span class="keyword">new</span> ArrayList&lt;&gt;(scanner.getAllParsedInfos());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Filter out overlays not present in the partition.</span></span><br><span class="line">            partitionOverlayInfos = <span class="keyword">new</span> ArrayList&lt;&gt;(packageManagerOverlayInfos.values());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = partitionOverlayInfos.size() - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!partition.containsFile(partitionOverlayInfos.get(j)</span><br><span class="line">                        .getOriginalPartitionPath())) &#123;</span><br><span class="line">                    partitionOverlayInfos.remove(j);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Static overlays are configured as immutable, default-enabled overlays.</span></span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;ParsedConfiguration&gt; partitionConfigs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>, m = partitionOverlayInfos.size(); j &lt; m; j++) &#123;</span><br><span class="line">            <span class="keyword">final</span> ParsedOverlayInfo p = partitionOverlayInfos.get(j);</span><br><span class="line">            <span class="keyword">if</span> (p.isStatic) &#123;</span><br><span class="line">                partitionConfigs.add(<span class="keyword">new</span> ParsedConfiguration(p.packageName,</span><br><span class="line">                        <span class="keyword">true</span> <span class="comment">/* enabled */</span>, <span class="keyword">false</span> <span class="comment">/* mutable */</span>, partition.policy, p, <span class="keyword">null</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        partitionConfigs.sort(sStaticOverlayComparator);</span><br><span class="line">        overlays.addAll(partitionConfigs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, n = overlays.size(); i &lt; n; i++) &#123;</span><br><span class="line">        <span class="comment">// Add the configurations to a map so definitions of an overlay in an earlier</span></span><br><span class="line">        <span class="comment">// partition can be replaced by an overlay with the same package name in a later</span></span><br><span class="line">        <span class="comment">// partition.</span></span><br><span class="line">        <span class="keyword">final</span> ParsedConfiguration config = overlays.get(i);</span><br><span class="line">        mConfigurations.put(config.packageName, <span class="keyword">new</span> Configuration(config, i));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieves a list of immutable framework overlays in order of least precedence to greatest</span></span><br><span class="line"><span class="comment"> * precedence.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;IdmapInvocation&gt; <span class="title">getImmutableFrameworkOverlayIdmapInvocations</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;IdmapInvocation&gt; idmapInvocations = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;Configuration&gt; sortedConfigs = getSortedOverlays();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, n = sortedConfigs.size(); i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> Configuration overlay = sortedConfigs.get(i);</span><br><span class="line">        <span class="keyword">if</span> (overlay.parsedConfig.mutable || !overlay.parsedConfig.enabled</span><br><span class="line">                || !<span class="string">"android"</span>.equals(overlay.parsedConfig.parsedInfo.targetPackageName)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Only enforce that overlays targeting packages with overlayable declarations abide by</span></span><br><span class="line">        <span class="comment">// those declarations if the target sdk of the overlay is at least Q (when overlayable</span></span><br><span class="line">        <span class="comment">// was introduced).</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> enforceOverlayable = overlay.parsedConfig.parsedInfo.targetSdkVersion</span><br><span class="line">                &gt;= Build.VERSION_CODES.Q;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Determine if the idmap for the current overlay can be generated in the last idmap</span></span><br><span class="line">        <span class="comment">// create-multiple invocation.</span></span><br><span class="line">        IdmapInvocation invocation = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!idmapInvocations.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">final</span> IdmapInvocation last = idmapInvocations.get(idmapInvocations.size() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (last.enforceOverlayable == enforceOverlayable</span><br><span class="line">                    &amp;&amp; last.policy.equals(overlay.parsedConfig.policy)) &#123;</span><br><span class="line">                invocation = last;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (invocation == <span class="keyword">null</span>) &#123;</span><br><span class="line">            invocation = <span class="keyword">new</span> IdmapInvocation(enforceOverlayable, overlay.parsedConfig.policy);</span><br><span class="line">            idmapInvocations.add(invocation);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        invocation.overlayPaths.add(overlay.parsedConfig.parsedInfo.path.getAbsolutePath());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> idmapInvocations;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先在构造函数里扫描了 <code>/apex</code> 及其他系统分区内所有的 apk 文件，记录下所有的 overlay app 然后将所有在启用状态、不可变且目标是 <code>android</code> 的 overlay app 返回给 zygote 预加载。具体会扫描的分区如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The list of all system partitions that may contain packages in ascending order of</span></span><br><span class="line"><span class="comment"> * specificity (the more generic, the earlier in the list a partition appears).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ArrayList&lt;SystemPartition&gt; SYSTEM_PARTITIONS =</span><br><span class="line">        <span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(</span><br><span class="line">                <span class="keyword">new</span> SystemPartition(Environment.getRootDirectory(),</span><br><span class="line">                        PARTITION_SYSTEM, Partition.PARTITION_NAME_SYSTEM,</span><br><span class="line">                        <span class="keyword">true</span> <span class="comment">/* containsPrivApp */</span>, <span class="keyword">false</span> <span class="comment">/* containsOverlay */</span>), <span class="comment">// </span></span><br><span class="line">                <span class="keyword">new</span> SystemPartition(Environment.getVendorDirectory(),</span><br><span class="line">                        PARTITION_VENDOR, Partition.PARTITION_NAME_VENDOR,</span><br><span class="line">                        <span class="keyword">true</span> <span class="comment">/* containsPrivApp */</span>, <span class="keyword">true</span> <span class="comment">/* containsOverlay */</span>),</span><br><span class="line">                <span class="keyword">new</span> SystemPartition(Environment.getOdmDirectory(),</span><br><span class="line">                        PARTITION_ODM, Partition.PARTITION_NAME_ODM,</span><br><span class="line">                        <span class="keyword">true</span> <span class="comment">/* containsPrivApp */</span>, <span class="keyword">true</span> <span class="comment">/* containsOverlay */</span>),</span><br><span class="line">                <span class="keyword">new</span> SystemPartition(Environment.getOemDirectory(),</span><br><span class="line">                        PARTITION_OEM, Partition.PARTITION_NAME_OEM,</span><br><span class="line">                        <span class="keyword">false</span> <span class="comment">/* containsPrivApp */</span>, <span class="keyword">true</span> <span class="comment">/* containsOverlay */</span>),</span><br><span class="line">                <span class="keyword">new</span> SystemPartition(Environment.getProductDirectory(),</span><br><span class="line">                        PARTITION_PRODUCT, Partition.PARTITION_NAME_PRODUCT,</span><br><span class="line">                        <span class="keyword">true</span> <span class="comment">/* containsPrivApp */</span>, <span class="keyword">true</span> <span class="comment">/* containsOverlay */</span>),</span><br><span class="line">                <span class="keyword">new</span> SystemPartition(Environment.getSystemExtDirectory(),</span><br><span class="line">                        PARTITION_SYSTEM_EXT, Partition.PARTITION_NAME_SYSTEM_EXT,</span><br><span class="line">                        <span class="keyword">true</span> <span class="comment">/* containsPrivApp */</span>, <span class="keyword">true</span> <span class="comment">/* containsOverlay */</span>)));</span><br></pre></td></tr></table></figure><p>扫描逻辑如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Recursively searches the directory for overlay APKs. If an overlay is found with the same</span></span><br><span class="line"><span class="comment"> * package name as a previously scanned overlay, the info of the new overlay will replace the</span></span><br><span class="line"><span class="comment"> * info of the previously scanned overlay.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanDir</span><span class="params">(File partitionOverlayDir)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!partitionOverlayDir.exists() || !partitionOverlayDir.isDirectory()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!partitionOverlayDir.canRead()) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Directory "</span> + partitionOverlayDir + <span class="string">" cannot be read"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> File[] files = partitionOverlayDir.listFiles();</span><br><span class="line">    <span class="keyword">if</span> (files == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; files.length; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> File f = files[i];</span><br><span class="line">        <span class="keyword">if</span> (f.isDirectory()) &#123;</span><br><span class="line">            scanDir(f);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!f.isFile() || !f.getPath().endsWith(<span class="string">".apk"</span>)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ParsedOverlayInfo info = parseOverlayManifest(f, mExcludedOverlayPackages);</span><br><span class="line">        <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mParsedOverlayInfos.put(info.packageName, info);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上逻辑都在 zygote 里完成，存在一个专门的 <code>Resources.preloadResources()</code> 函数用来预加载：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Load in commonly used resources, so they can be shared across processes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * These tend to be a few Kbytes, but are frequently in the 20-40K range, and occasionally even</span></span><br><span class="line"><span class="comment"> * larger.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preloadResources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Resources sysRes = Resources.getSystem();</span><br><span class="line">        sysRes.startPreloading();</span><br><span class="line">        <span class="keyword">if</span> (PRELOAD_RESOURCES) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"Preloading resources..."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line">            TypedArray ar = sysRes.obtainTypedArray(</span><br><span class="line">                    com.android.internal.R.array.preloaded_drawables);</span><br><span class="line">            <span class="keyword">int</span> numberOfEntries = preloadDrawables(sysRes, ar);</span><br><span class="line">            ar.recycle();</span><br><span class="line">            Log.i(TAG, <span class="string">"...preloaded "</span> + numberOfEntries + <span class="string">" resources in "</span></span><br><span class="line">                    + (SystemClock.uptimeMillis() - startTime) + <span class="string">"ms."</span>);</span><br><span class="line"></span><br><span class="line">            startTime = SystemClock.uptimeMillis();</span><br><span class="line">            ar = sysRes.obtainTypedArray(</span><br><span class="line">                    com.android.internal.R.array.preloaded_color_state_lists);</span><br><span class="line">            numberOfEntries = preloadColorStateLists(sysRes, ar);</span><br><span class="line">            ar.recycle();</span><br><span class="line">            Log.i(TAG, <span class="string">"...preloaded "</span> + numberOfEntries + <span class="string">" resources in "</span></span><br><span class="line">                    + (SystemClock.uptimeMillis() - startTime) + <span class="string">"ms."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sysRes.finishPreloading();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Failure preloading resources"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而 FRRO 位于 <code>/data/resource/cache</code> 下，以 <code>.frro</code> 为后缀，显然扫描结果不可能包含任何一个 FRRO，所以不会被 zygote 预加载也不会影响 <code>Resources.getSystem()</code>。而虽然 <code>android.auto_generated_rro_product__</code> 所属的 <code>/product/overlay</code> 下没有 <code>config.xml</code> 文件，但它被配置为静态 RRO：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">overlay</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:priority</span>=<span class="string">"1"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:targetPackage</span>=<span class="string">"android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:isStatic</span>=<span class="string">"true"</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>静态 RRO 默认就是启用且不可变的，所以被 zygote 预加载了。通过 <code>cat /proc/$(pidof zygote)/maps | grep idmap</code> 也可以确认输出结果含有 <code>android.auto_generated_rro_product__</code> 的 idmap 但没有 FRRO 的。</p><h2 id="可变-RRO-的加载"><a href="#可变-RRO-的加载" class="headerlink" title="可变 RRO 的加载"></a>可变 RRO 的加载</h2><p>上面这么一大串生效的前提是 1. RRO 不是 FRRO；2. RRO 不可变且处于启用状态。我们还是没有找到 FRRO 的处理逻辑，不知道这段代码藏在哪处。我们用代码或者 shell 命令创建 FRRO 的时候实际上是在和 OverlayManagerService 交互，看一下它的代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function">Set&lt;UserPackage&gt; <span class="title">registerFabricatedOverlay</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull <span class="keyword">final</span> FabricatedOverlayInternal overlay)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> OperationFailedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (FrameworkParsingPackageUtils.validateName(overlay.overlayName,</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/* requireSeparator */</span>, <span class="keyword">true</span> <span class="comment">/* requireFilename */</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OperationFailedException(</span><br><span class="line">                <span class="string">"overlay name can only consist of alphanumeric characters, '_', and '.'"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> FabricatedOverlayInfo info = mIdmapManager.createFabricatedOverlay(overlay);</span><br><span class="line">    <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OperationFailedException(<span class="string">"failed to create fabricated overlay"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Set&lt;UserPackage&gt; updatedTargets = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> userId : mSettings.getUsers()) &#123;</span><br><span class="line">        updatedTargets.addAll(registerFabricatedOverlay(info, userId));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> updatedTargets;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用了 Idmap2Service 来实际创建 FRRO：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constexpr</span> <span class="built_in">std</span>::string_view kIdmapCacheDir = <span class="string">"/data/resource-cache"</span>;</span><br><span class="line"></span><br><span class="line">Status Idmap2Service::createFabricatedOverlay(</span><br><span class="line">    <span class="keyword">const</span> os::FabricatedOverlayInternal&amp; overlay,</span><br><span class="line">    <span class="built_in">std</span>::optional&lt;os::FabricatedOverlayInfo&gt;* _aidl_return) &#123;</span><br><span class="line">  idmap2::FabricatedOverlay::<span class="function">Builder <span class="title">builder</span><span class="params">(overlay.packageName, overlay.overlayName,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             overlay.targetPackageName)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (!overlay.targetOverlayable.empty()) &#123;</span><br><span class="line">    builder.SetOverlayable(overlay.targetOverlayable);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; res : overlay.entries) &#123;</span><br><span class="line">    <span class="keyword">if</span> (res.dataType == Res_value::TYPE_STRING) &#123;</span><br><span class="line">      builder.SetResourceValue(res.resourceName, res.dataType, res.stringData.value(),</span><br><span class="line">            res.configuration.value_or(<span class="built_in">std</span>::<span class="built_in">string</span>()));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.binaryData.has_value()) &#123;</span><br><span class="line">      builder.SetResourceValue(res.resourceName, res.binaryData-&gt;get(),</span><br><span class="line">                               res.binaryDataOffset, res.binaryDataSize,</span><br><span class="line">                               res.configuration.value_or(<span class="built_in">std</span>::<span class="built_in">string</span>()),</span><br><span class="line">                               res.isNinePatch);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      builder.SetResourceValue(res.resourceName, res.dataType, res.data,</span><br><span class="line">            res.configuration.value_or(<span class="built_in">std</span>::<span class="built_in">string</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Generate the file path of the fabricated overlay and ensure it does not collide with an</span></span><br><span class="line">  <span class="comment">// existing path. Re-registering a fabricated overlay will always result in an updated path.</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> path;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> file_name;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="keyword">size_t</span> kSuffixLength = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> random_suffix = RandomStringForPath(kSuffixLength);</span><br><span class="line">    file_name = StringPrintf(<span class="string">"%s-%s-%s.frro"</span>, overlay.packageName.c_str(),</span><br><span class="line">                             overlay.overlayName.c_str(), random_suffix.c_str());</span><br><span class="line">    path = StringPrintf(<span class="string">"%s/%s"</span>, kIdmapCacheDir.data(), file_name.c_str());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invoking std::filesystem::exists with a file name greater than 255 characters will cause this</span></span><br><span class="line">    <span class="comment">// process to abort since the name exceeds the maximum file name size.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> kMaxFileNameLength = <span class="number">255</span>;</span><br><span class="line">    <span class="keyword">if</span> (file_name.size() &gt; kMaxFileNameLength) &#123;</span><br><span class="line">      <span class="keyword">return</span> error(</span><br><span class="line">          base::StringPrintf(<span class="string">"fabricated overlay file name '%s' longer than %zu characters"</span>,</span><br><span class="line">                             file_name.c_str(), kMaxFileNameLength));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="built_in">std</span>::filesystem::exists(path));</span><br><span class="line">  builder.setFrroPath(path);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">uid_t</span> uid = IPCThreadState::self()-&gt;getCallingUid();</span><br><span class="line">  <span class="keyword">if</span> (!UidHasWriteAccessToPath(uid, path)) &#123;</span><br><span class="line">    <span class="keyword">return</span> error(base::StringPrintf(<span class="string">"will not write to %s: calling uid %d lacks write access"</span>,</span><br><span class="line">                                    path.c_str(), uid));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> frro = builder.Build();</span><br><span class="line">  <span class="keyword">if</span> (!frro) &#123;</span><br><span class="line">    <span class="keyword">return</span> error(StringPrintf(<span class="string">"failed to serialize '%s:%s': %s"</span>, overlay.packageName.c_str(),</span><br><span class="line">                              overlay.overlayName.c_str(), frro.GetErrorMessage().c_str()));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Persist the fabricated overlay.</span></span><br><span class="line">  umask(kIdmapFilePermissionMask);</span><br><span class="line">  <span class="built_in">std</span>::<span class="function">ofstream <span class="title">fout</span><span class="params">(path)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (fout.fail()) &#123;</span><br><span class="line">    <span class="keyword">return</span> error(<span class="string">"failed to open frro path "</span> + path);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> result = frro-&gt;ToBinaryStream(fout);</span><br><span class="line">  <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">    unlink(path.c_str());</span><br><span class="line">    <span class="keyword">return</span> error(<span class="string">"failed to write to frro path "</span> + path + <span class="string">": "</span> + result.GetErrorMessage());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (fout.fail()) &#123;</span><br><span class="line">    unlink(path.c_str());</span><br><span class="line">    <span class="keyword">return</span> error(<span class="string">"failed to write to frro path "</span> + path);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  os::FabricatedOverlayInfo out_info;</span><br><span class="line">  out_info.packageName = overlay.packageName;</span><br><span class="line">  out_info.overlayName = overlay.overlayName;</span><br><span class="line">  out_info.targetPackageName = overlay.targetPackageName;</span><br><span class="line">  out_info.targetOverlayable = overlay.targetOverlayable;</span><br><span class="line">  out_info.path = path;</span><br><span class="line">  *_aidl_return = out_info;</span><br><span class="line">  <span class="keyword">return</span> ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据调用者的包名和 overlay 的名字，在 <code>/data/resource-cache</code> 下随机生成 FRRO 文件。猜测应该会有个地方列出这个文件夹里所有的 FRRO 然后逐个加载，搜索发现 OverlayManagerService 启动时会调用 <code>OverlayManagerServiceImpl.updateOverlaysForUser()</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Call this to synchronize the Settings for a user with what PackageManager knows about a user.</span></span><br><span class="line"><span class="comment"> * Returns a list of target packages that must refresh their overlays. This list is the union</span></span><br><span class="line"><span class="comment"> * of two sets: the set of targets with currently active overlays, and the</span></span><br><span class="line"><span class="comment"> * set of targets that had, but no longer have, active overlays.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function">ArraySet&lt;UserPackage&gt; <span class="title">updateOverlaysForUser</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> newUserId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"updateOverlaysForUser newUserId="</span> + newUserId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove the settings of all overlays that are no longer installed for this user.</span></span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;UserPackage&gt; updatedTargets = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">    <span class="keyword">final</span> ArrayMap&lt;String, PackageState&gt; userPackages = mPackageManager.initializeForUser(</span><br><span class="line">            newUserId);</span><br><span class="line">    CollectionUtils.addAll(updatedTargets, removeOverlaysForUser(</span><br><span class="line">            (info) -&gt; !userPackages.containsKey(info.packageName), newUserId));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;String&gt; overlaidByOthers = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (PackageState packageState : userPackages.values()) &#123;</span><br><span class="line">        <span class="keyword">var</span> pkg = packageState.getAndroidPackage();</span><br><span class="line">        <span class="keyword">final</span> String overlayTarget = pkg == <span class="keyword">null</span> ? <span class="keyword">null</span> : pkg.getOverlayTarget();</span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(overlayTarget)) &#123;</span><br><span class="line">            overlaidByOthers.add(overlayTarget);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update the state of all installed packages containing overlays, and initialize new</span></span><br><span class="line">    <span class="comment">// overlays that are not currently in the settings.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, n = userPackages.size(); i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageState packageState = userPackages.valueAt(i);</span><br><span class="line">        <span class="keyword">var</span> pkg = packageState.getAndroidPackage();</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> packageName = packageState.getPackageName();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            CollectionUtils.addAll(updatedTargets,</span><br><span class="line">                    updatePackageOverlays(pkg, newUserId, <span class="number">0</span> <span class="comment">/* flags */</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// When a new user is switched to for the first time, package manager must be</span></span><br><span class="line">            <span class="comment">// informed of the overlay paths for all overlaid packages installed in the user.</span></span><br><span class="line">            <span class="keyword">if</span> (overlaidByOthers.contains(packageName)) &#123;</span><br><span class="line">                updatedTargets.add(UserPackage.of(newUserId, packageName));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OperationFailedException e) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"failed to initialize overlays of '"</span> + packageName</span><br><span class="line">                    + <span class="string">"' for user "</span> + newUserId + <span class="string">""</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update the state of all fabricated overlays, and initialize fabricated overlays in the</span></span><br><span class="line">    <span class="comment">// new user.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> FabricatedOverlayInfo info : getFabricatedOverlayInfos()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            CollectionUtils.addAll(updatedTargets, registerFabricatedOverlay(</span><br><span class="line">                    info, newUserId));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OperationFailedException e) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"failed to initialize fabricated overlay of '"</span> + info.path</span><br><span class="line">                    + <span class="string">"' for user "</span> + newUserId + <span class="string">""</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Collect all of the categories in which we have at least one overlay enabled.</span></span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;String&gt; enabledCategories = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">    <span class="keyword">final</span> ArrayMap&lt;String, List&lt;OverlayInfo&gt;&gt; userOverlays =</span><br><span class="line">            mSettings.getOverlaysForUser(newUserId);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userOverlayTargetCount = userOverlays.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; userOverlayTargetCount; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;OverlayInfo&gt; overlayList = userOverlays.valueAt(i);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> overlayCount = overlayList != <span class="keyword">null</span> ? overlayList.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; overlayCount; j++) &#123;</span><br><span class="line">            <span class="keyword">final</span> OverlayInfo oi = overlayList.get(j);</span><br><span class="line">            <span class="keyword">if</span> (oi.isEnabled()) &#123;</span><br><span class="line">                enabledCategories.add(oi.category);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enable the default overlay if its category does not have a single overlay enabled.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> String defaultOverlay : mDefaultOverlays) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// OverlayConfig is the new preferred way to enable overlays by default. This legacy</span></span><br><span class="line">            <span class="comment">// default enabled method was created before overlays could have a name specified.</span></span><br><span class="line">            <span class="comment">// Only allow enabling overlays without a name using this mechanism.</span></span><br><span class="line">            <span class="keyword">final</span> OverlayIdentifier overlay = <span class="keyword">new</span> OverlayIdentifier(defaultOverlay);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> OverlayInfo oi = mSettings.getOverlayInfo(overlay, newUserId);</span><br><span class="line">            <span class="keyword">if</span> (!enabledCategories.contains(oi.category)) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Enabling default overlay '"</span> + defaultOverlay + <span class="string">"' for target '"</span></span><br><span class="line">                        + oi.targetPackageName + <span class="string">"' in category '"</span> + oi.category + <span class="string">"' for user "</span></span><br><span class="line">                        + newUserId);</span><br><span class="line">                mSettings.setEnabled(overlay, newUserId, <span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">if</span> (updateState(oi, newUserId, <span class="number">0</span>)) &#123;</span><br><span class="line">                    CollectionUtils.add(updatedTargets,</span><br><span class="line">                            UserPackage.of(oi.userId, oi.targetPackageName));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OverlayManagerSettings.BadKeyException e) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Failed to set default overlay '"</span> + defaultOverlay + <span class="string">"' for user "</span></span><br><span class="line">                    + newUserId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cleanStaleResourceCache();</span><br><span class="line">    <span class="keyword">return</span> updatedTargets;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>它收集了所有 overlay app 然后调用 Idmap2Service 遍历 <code>/data/resource-cache</code> 收集所有 FRRO：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">Status Idmap2Service::acquireFabricatedOverlayIterator(<span class="keyword">int32_t</span>* _aidl_return) &#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="function">lock_guard <span class="title">l</span><span class="params">(frro_iter_mutex_)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (frro_iter_.has_value()) &#123;</span><br><span class="line">    LOG(WARNING) &lt;&lt; <span class="string">"active ffro iterator was not previously released"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  frro_iter_ = <span class="built_in">std</span>::filesystem::directory_iterator(kIdmapCacheDir);</span><br><span class="line">  <span class="keyword">if</span> (frro_iter_id_ == <span class="built_in">std</span>::numeric_limits&lt;<span class="keyword">int32_t</span>&gt;::max()) &#123;</span><br><span class="line">    frro_iter_id_ = <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ++frro_iter_id_;</span><br><span class="line">  &#125;</span><br><span class="line">  *_aidl_return = frro_iter_id_;</span><br><span class="line">  <span class="keyword">return</span> ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Status Idmap2Service::nextFabricatedOverlayInfos(<span class="keyword">int32_t</span> iteratorId,</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;os::FabricatedOverlayInfo&gt;* _aidl_return) &#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="function">lock_guard <span class="title">l</span><span class="params">(frro_iter_mutex_)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constexpr</span> <span class="keyword">size_t</span> kMaxEntryCount = <span class="number">100</span>;</span><br><span class="line">  <span class="keyword">if</span> (!frro_iter_.has_value()) &#123;</span><br><span class="line">    <span class="keyword">return</span> error(<span class="string">"no active frro iterator"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frro_iter_id_ != iteratorId) &#123;</span><br><span class="line">    <span class="keyword">return</span> error(<span class="string">"incorrect iterator id in a call to next"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">auto</span>&amp; entry_iter = *frro_iter_;</span><br><span class="line">  <span class="keyword">auto</span> entry_iter_end = end(*frro_iter_);</span><br><span class="line">  <span class="keyword">for</span> (; entry_iter != entry_iter_end &amp;&amp; count &lt; kMaxEntryCount; ++entry_iter) &#123;</span><br><span class="line">    <span class="keyword">auto</span>&amp; entry = *entry_iter;</span><br><span class="line">    <span class="keyword">if</span> (!entry.is_regular_file() || !android::IsFabricatedOverlay(entry.path().native())) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> overlay = FabricatedOverlayContainer::FromPath(entry.path().native());</span><br><span class="line">    <span class="keyword">if</span> (!overlay) &#123;</span><br><span class="line">      LOG(WARNING) &lt;&lt; <span class="string">"Failed to open '"</span> &lt;&lt; entry.path() &lt;&lt; <span class="string">"': "</span> &lt;&lt; overlay.GetErrorMessage();</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> info = (*overlay)-&gt;GetManifestInfo();</span><br><span class="line">    os::FabricatedOverlayInfo out_info;</span><br><span class="line">    out_info.packageName = <span class="built_in">std</span>::move(info.package_name);</span><br><span class="line">    out_info.overlayName = <span class="built_in">std</span>::move(info.name);</span><br><span class="line">    out_info.targetPackageName = <span class="built_in">std</span>::move(info.target_package);</span><br><span class="line">    out_info.targetOverlayable = <span class="built_in">std</span>::move(info.target_name);</span><br><span class="line">    out_info.path = entry.path();</span><br><span class="line">    _aidl_return-&gt;emplace_back(<span class="built_in">std</span>::move(out_info));</span><br><span class="line">    count++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>计算完所有 RRO 的状态后，通知 PackageManagerService 更新信息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Updates the target packages' set of enabled overlays in PackageManager.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the package names of affected targets (a superset of</span></span><br><span class="line"><span class="comment"> *         targetPackageNames: the target themselves and shared libraries)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">updatePackageManagerLocked</span><span class="params">(@NonNull Collection&lt;String&gt; targetPackageNames,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        traceBegin(TRACE_TAG_RRO, <span class="string">"OMS#updatePackageManagerLocked "</span> + targetPackageNames);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Update package manager about changed overlays"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> PackageManagerInternal pm =</span><br><span class="line">                LocalServices.getService(PackageManagerInternal.class);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> updateFrameworkRes = targetPackageNames.contains(<span class="string">"android"</span>);</span><br><span class="line">        <span class="keyword">if</span> (updateFrameworkRes) &#123;</span><br><span class="line">            targetPackageNames = pm.getTargetPackageNames(userId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ArrayMap&lt;String, OverlayPaths&gt; pendingChanges =</span><br><span class="line">                <span class="keyword">new</span> ArrayMap&lt;&gt;(targetPackageNames.size());</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">final</span> OverlayPaths frameworkOverlays =</span><br><span class="line">                    mImpl.getEnabledOverlayPaths(<span class="string">"android"</span>, userId, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> String targetPackageName : targetPackageNames) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">var</span> list = <span class="keyword">new</span> OverlayPaths.Builder(frameworkOverlays);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="string">"android"</span>.equals(targetPackageName)) &#123;</span><br><span class="line">                    list.addAll(mImpl.getEnabledOverlayPaths(targetPackageName, userId, <span class="keyword">true</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                pendingChanges.put(targetPackageName, list.build());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> HashSet&lt;String&gt; updatedPackages = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        <span class="keyword">final</span> HashSet&lt;String&gt; invalidPackages = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        pm.setEnabledOverlayPackages(userId, pendingChanges, updatedPackages, invalidPackages);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;(updatedPackages);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        traceEnd(TRACE_TAG_RRO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PackageManagerService 更新受影响包的状态，最重要的是 ApplicationInfo 内的两个字段：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Full paths to the locations of extra resource packages (runtime overlays)</span></span><br><span class="line"><span class="comment"> * this application uses. This field is only used if there are extra resource</span></span><br><span class="line"><span class="comment"> * packages, otherwise it is null.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@hide</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="keyword">public</span> String[] resourceDirs;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Contains the contents of &#123;<span class="doctag">@link</span> #resourceDirs&#125; and along with paths for overlays that may or</span></span><br><span class="line"><span class="comment"> * may not be APK packages.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@hide</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> String[] overlayPaths;</span><br></pre></td></tr></table></figure><p>对应进程启动时会读取它们，创建 Resources 对象的时候会用到：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Resources <span class="title">getResources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mResources == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> String[] splitPaths;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            splitPaths = getSplitPaths(<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// This should never fail.</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"null split not found"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Process.myUid() == mApplicationInfo.uid) &#123;</span><br><span class="line">            ResourcesManager.getInstance().initializeApplicationPaths(mResDir, splitPaths);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mResources = ResourcesManager.getInstance().getResources(<span class="keyword">null</span>, mResDir,</span><br><span class="line">                splitPaths, mLegacyOverlayDirs, mOverlayPaths,</span><br><span class="line">                mApplicationInfo.sharedLibraryFiles, <span class="keyword">null</span>, <span class="keyword">null</span>, getCompatibilityInfo(),</span><br><span class="line">                getClassLoader(), <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mResources;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那如果受影响的进程已经启动了（比如是 system_server 自己）又会是什么情况呢？回到 <code>PackageManagerService#setEnabledOverlayPackages()</code>，里面有一段特殊处理，修改了 <code>android</code> 包对应的 ApplicationInfo：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (userId == UserHandle.USER_SYSTEM) &#123;</span><br><span class="line">    <span class="comment">// Keep the overlays in the system application info (and anything special cased as well)</span></span><br><span class="line">    <span class="comment">// up to date to make sure system ui is themed correctly.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numberOfPendingChanges; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> String targetPackageName = pendingChanges.keyAt(i);</span><br><span class="line">        <span class="keyword">final</span> OverlayPaths newOverlayPaths = pendingChanges.valueAt(i);</span><br><span class="line">        maybeUpdateSystemOverlays(targetPackageName, newOverlayPaths);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeUpdateSystemOverlays</span><span class="params">(String targetPackageName, OverlayPaths newOverlayPaths)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mResolverReplaced) &#123;</span><br><span class="line">        <span class="keyword">if</span> (targetPackageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (newOverlayPaths == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPlatformPackageOverlayPaths = <span class="keyword">null</span>;</span><br><span class="line">                mPlatformPackageOverlayResourceDirs = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mPlatformPackageOverlayPaths = newOverlayPaths.getOverlayPaths().toArray(</span><br><span class="line">                        <span class="keyword">new</span> String[<span class="number">0</span>]);</span><br><span class="line">                mPlatformPackageOverlayResourceDirs = newOverlayPaths.getResourceDirs().toArray(</span><br><span class="line">                        <span class="keyword">new</span> String[<span class="number">0</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            applyUpdatedSystemOverlayPaths();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (targetPackageName.equals(mResolveActivity.applicationInfo.packageName)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (newOverlayPaths == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mReplacedResolverPackageOverlayPaths = <span class="keyword">null</span>;</span><br><span class="line">                mReplacedResolverPackageOverlayResourceDirs = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mReplacedResolverPackageOverlayPaths =</span><br><span class="line">                        newOverlayPaths.getOverlayPaths().toArray(<span class="keyword">new</span> String[<span class="number">0</span>]);</span><br><span class="line">                mReplacedResolverPackageOverlayResourceDirs =</span><br><span class="line">                        newOverlayPaths.getResourceDirs().toArray(<span class="keyword">new</span> String[<span class="number">0</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            applyUpdatedSystemOverlayPaths();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyUpdatedSystemOverlayPaths</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mAndroidApplication == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"Skipped the AndroidApplication overlay paths update - no app yet"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mAndroidApplication.overlayPaths = mPlatformPackageOverlayPaths;</span><br><span class="line">        mAndroidApplication.resourceDirs = mPlatformPackageOverlayResourceDirs;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mResolverReplaced) &#123;</span><br><span class="line">        mResolveActivity.applicationInfo.overlayPaths = mReplacedResolverPackageOverlayPaths;</span><br><span class="line">        mResolveActivity.applicationInfo.resourceDirs =</span><br><span class="line">                mReplacedResolverPackageOverlayResourceDirs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通知完 PackageManagerService 后，OverlayManagerService 会通知 ActivityManagerService，由 ActivityManagerService 通知相关进程刷新 ApplicationInfo：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GuardedBy</span>(anyOf = &#123;<span class="string">"this"</span>, <span class="string">"mProcLock"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateApplicationInfoLOSP</span><span class="params">(@NonNull List&lt;String&gt; packagesToUpdate,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> updateFrameworkRes, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (updateFrameworkRes) &#123;</span><br><span class="line">        ParsingPackageUtils.readConfigUseRoundIcon(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mProcessList.updateApplicationInfoLOSP(packagesToUpdate, userId, updateFrameworkRes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (updateFrameworkRes) &#123;</span><br><span class="line">        <span class="comment">// Update system server components that need to know about changed overlays. Because the</span></span><br><span class="line">        <span class="comment">// overlay is applied in ActivityThread, we need to serialize through its thread too.</span></span><br><span class="line">        <span class="keyword">final</span> Executor executor = ActivityThread.currentActivityThread().getExecutor();</span><br><span class="line">        <span class="keyword">final</span> DisplayManagerInternal display =</span><br><span class="line">                LocalServices.getService(DisplayManagerInternal.class);</span><br><span class="line">        <span class="keyword">if</span> (display != <span class="keyword">null</span>) &#123;</span><br><span class="line">            executor.execute(display::onOverlayChanged);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mWindowManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            executor.execute(mWindowManager::onOverlayChanged);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GuardedBy</span>(anyOf = &#123;<span class="string">"mService"</span>, <span class="string">"mProcLock"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateApplicationInfoLOSP</span><span class="params">(List&lt;String&gt; packagesToUpdate, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> updateFrameworkRes)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ArrayMap&lt;String, ApplicationInfo&gt; applicationInfoByPackage = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = packagesToUpdate.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">final</span> String packageName = packagesToUpdate.get(i);</span><br><span class="line">        <span class="keyword">final</span> ApplicationInfo ai = mService.getPackageManagerInternal().getApplicationInfo(</span><br><span class="line">                packageName, STOCK_PM_FLAGS, Process.SYSTEM_UID, userId);</span><br><span class="line">        <span class="keyword">if</span> (ai != <span class="keyword">null</span>) &#123;</span><br><span class="line">            applicationInfoByPackage.put(packageName, ai);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mService.mActivityTaskManager.updateActivityApplicationInfo(userId,</span><br><span class="line">            applicationInfoByPackage);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;WindowProcessController&gt; targetProcesses = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = mLruProcesses.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">final</span> ProcessRecord app = mLruProcesses.get(i);</span><br><span class="line">        <span class="keyword">if</span> (app.getThread() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (userId != UserHandle.USER_ALL &amp;&amp; app.userId != userId) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        app.getPkgList().forEachPackage(packageName -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (updateFrameworkRes || packagesToUpdate.contains(packageName)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> ApplicationInfo ai = applicationInfoByPackage.get(packageName);</span><br><span class="line">                    <span class="keyword">if</span> (ai != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (ai.packageName.equals(app.info.packageName)) &#123;</span><br><span class="line">                            app.info = ai;</span><br><span class="line">                            app.getWindowProcessController().updateApplicationInfo(ai);</span><br><span class="line">                            PlatformCompatCache.getInstance()</span><br><span class="line">                                    .onApplicationInfoChanged(ai);</span><br><span class="line">                        &#125;</span><br><span class="line">                        app.getThread().scheduleApplicationInfoChanged(ai);</span><br><span class="line">                        targetProcesses.add(app.getWindowProcessController());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    Slog.w(TAG, String.format(<span class="string">"Failed to update %s ApplicationInfo for %s"</span>,</span><br><span class="line">                                packageName, app));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mService.mActivityTaskManager.updateAssetConfiguration(targetProcesses, updateFrameworkRes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进程收到消息后，刷新 ApplicationInfo：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@VisibleForTesting</span>(visibility = PACKAGE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleApplicationInfoChanged</span><span class="params">(@NonNull <span class="keyword">final</span> ApplicationInfo ai)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Updates triggered by package installation go through a package update</span></span><br><span class="line">    <span class="comment">// receiver. Here we try to capture ApplicationInfo changes that are</span></span><br><span class="line">    <span class="comment">// caused by other sources, such as overlays. That means we want to be as conservative</span></span><br><span class="line">    <span class="comment">// about code changes as possible. Take the diff of the old ApplicationInfo and the new</span></span><br><span class="line">    <span class="comment">// to see if anything needs to change.</span></span><br><span class="line">    LoadedApk apk;</span><br><span class="line">    LoadedApk resApk;</span><br><span class="line">    <span class="comment">// Update all affected loaded packages with new package information</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mResourcesManager) &#123;</span><br><span class="line">        WeakReference&lt;LoadedApk&gt; ref = mPackages.get(ai.packageName);</span><br><span class="line">        apk = ref != <span class="keyword">null</span> ? ref.get() : <span class="keyword">null</span>;</span><br><span class="line">        ref = mResourcePackages.get(ai.packageName);</span><br><span class="line">        resApk = ref != <span class="keyword">null</span> ? ref.get() : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (ActivityClientRecord ar : mActivities.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ar.activityInfo.applicationInfo.packageName.equals(ai.packageName)) &#123;</span><br><span class="line">                ar.activityInfo.applicationInfo = ai;</span><br><span class="line">                <span class="keyword">if</span> (apk != <span class="keyword">null</span> || resApk != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ar.packageInfo = apk != <span class="keyword">null</span> ? apk : resApk;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    apk = ar.packageInfo;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (apk != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;String&gt; oldPaths = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        LoadedApk.makePaths(<span class="keyword">this</span>, apk.getApplicationInfo(), oldPaths);</span><br><span class="line">        apk.updateApplicationInfo(ai, oldPaths);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resApk != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;String&gt; oldPaths = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        LoadedApk.makePaths(<span class="keyword">this</span>, resApk.getApplicationInfo(), oldPaths);</span><br><span class="line">        resApk.updateApplicationInfo(ai, oldPaths);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (android.content.res.Flags.systemContextHandleAppInfoChanged() &amp;&amp; mSystemThread) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">var</span> systemContext = getSystemContext();</span><br><span class="line">        <span class="keyword">if</span> (systemContext.getPackageName().equals(ai.packageName)) &#123;</span><br><span class="line">            <span class="comment">// The system package is not tracked directly, but still needs to receive updates to</span></span><br><span class="line">            <span class="comment">// its application info.</span></span><br><span class="line">            <span class="keyword">final</span> ArrayList&lt;String&gt; oldPaths = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            LoadedApk.makePaths(<span class="keyword">this</span>, systemContext.getApplicationInfo(), oldPaths);</span><br><span class="line">            systemContext.mPackageInfo.updateApplicationInfo(ai, oldPaths);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ResourcesImpl beforeImpl = getApplication().getResources().getImpl();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mResourcesManager) &#123;</span><br><span class="line">        <span class="comment">// Update all affected Resources objects to use new ResourcesImpl</span></span><br><span class="line">        mResourcesManager.applyAllPendingAppInfoUpdates();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ResourcesImpl afterImpl = getApplication().getResources().getImpl();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((beforeImpl != afterImpl) &amp;&amp; !Arrays.equals(beforeImpl.getAssets().getApkAssets(),</span><br><span class="line">            afterImpl.getAssets().getApkAssets())) &#123;</span><br><span class="line">        List&lt;String&gt; beforeAssets = Arrays.asList(beforeImpl.getAssets().getApkPaths());</span><br><span class="line">        List&lt;String&gt; afterAssets = Arrays.asList(afterImpl.getAssets().getApkPaths());</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; onlyBefore = <span class="keyword">new</span> ArrayList&lt;&gt;(beforeAssets);</span><br><span class="line">        onlyBefore.removeAll(afterAssets);</span><br><span class="line">        List&lt;String&gt; onlyAfter = <span class="keyword">new</span> ArrayList&lt;&gt;(afterAssets);</span><br><span class="line">        onlyAfter.removeAll(beforeAssets);</span><br><span class="line"></span><br><span class="line">        Slog.i(TAG, <span class="string">"ApplicationInfo updating for "</span> + ai.packageName + <span class="string">", new timestamp: "</span></span><br><span class="line">                + ai.createTimestamp + <span class="string">"\nassets removed: "</span> + onlyBefore + <span class="string">"\nassets added: "</span></span><br><span class="line">                + onlyAfter);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_APP_INFO) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">"ApplicationInfo updating for "</span> + ai.packageName</span><br><span class="line">                    + <span class="string">", assets before change: "</span> + beforeAssets + <span class="string">"\n assets after change: "</span></span><br><span class="line">                    + afterAssets);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看见了熟悉的 <code>updateApplicationInfo()</code>，里面就会重新创建出 Resources 对象了，完成资源的刷新：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Update the ApplicationInfo for an app. If oldPaths is null, all the paths are considered</span></span><br><span class="line"><span class="comment"> * new.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> aInfo The new ApplicationInfo to use for this LoadedApk</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> oldPaths The code paths for the old ApplicationInfo object. null means no paths can</span></span><br><span class="line"><span class="comment"> *                 be reused.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateApplicationInfo</span><span class="params">(@NonNull ApplicationInfo aInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable List&lt;String&gt; oldPaths)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!setApplicationInfo(aInfo)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; newPaths = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    makePaths(mActivityThread, aInfo, newPaths);</span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; addedPaths = <span class="keyword">new</span> ArrayList&lt;&gt;(newPaths.size());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldPaths != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String path : newPaths) &#123;</span><br><span class="line">            <span class="keyword">final</span> String apkName = path.substring(path.lastIndexOf(File.separator));</span><br><span class="line">            <span class="keyword">boolean</span> match = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (String oldPath : oldPaths) &#123;</span><br><span class="line">                <span class="keyword">final</span> String oldApkName = oldPath.substring(oldPath.lastIndexOf(File.separator));</span><br><span class="line">                <span class="keyword">if</span> (apkName.equals(oldApkName)) &#123;</span><br><span class="line">                    match = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">                addedPaths.add(path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        addedPaths.addAll(newPaths);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        createOrUpdateClassLoaderLocked(addedPaths);</span><br><span class="line">        <span class="keyword">if</span> (mResources != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> String[] splitPaths;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                splitPaths = getSplitPaths(<span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// This should NEVER fail.</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"null split not found"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mResources = ResourcesManager.getInstance().getResources(<span class="keyword">null</span>, mResDir,</span><br><span class="line">                    splitPaths, mLegacyOverlayDirs, mOverlayPaths,</span><br><span class="line">                    mApplicationInfo.sharedLibraryFiles, <span class="keyword">null</span>, <span class="keyword">null</span>, getCompatibilityInfo(),</span><br><span class="line">                    getClassLoader(), mApplication == <span class="keyword">null</span> ? <span class="keyword">null</span></span><br><span class="line">                            : mApplication.getResources().getLoaders());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mAppComponentFactory = createAppFactory(aInfo, mDefaultClassLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至此整个加载流程完成。</p><h2 id="问题解答"><a href="#问题解答" class="headerlink" title="问题解答"></a>问题解答</h2><p>回到我们开头抛出的两个问题：</p><ol><li>为什么 FRRO 对 <code>Resources.getSystem()</code> 不生效？答：<code>Resources.getSystem()</code> 反映的是 zygote 中预加载的系统资源，只有不可变且启用的传统 app 格式的 RRO 会对其生效。</li><li>为什么 PackageManagerService 内没有读取到 FRRO 替换的数据？答：首先肯定跟 <code>Resources.getSystem()</code> 没有关系，看示意代码就已经能知道是用 context 拿的 Resources 了……那根据我们之前的分析，FRRO 应该会生效，所以肯定还存在什么我们还没有发现的东西。其实答案很简单，点开 SystemServer.java 看一下系统服务的启动顺序：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Starts the small tangle of critical services that are needed to get the system off the</span></span><br><span class="line"><span class="comment"> * ground.  These services have complex mutual dependencies which is why we initialize them all</span></span><br><span class="line"><span class="comment"> * in one place here.  Unless your service is also entwined in these dependencies, it should be</span></span><br><span class="line"><span class="comment"> * initialized in one of the other functions.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">(@NonNull TimingsTraceAndSlog t)</span> </span>&#123;</span><br><span class="line">    t.traceBegin(<span class="string">"startBootstrapServices"</span>);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    t.traceBegin(<span class="string">"StartPackageManagerService"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Watchdog.getInstance().pauseWatchingCurrentThread(<span class="string">"packagemanagermain"</span>);</span><br><span class="line">        mPackageManagerService = PackageManagerService.main(</span><br><span class="line">                mSystemContext, installer, domainVerificationService,</span><br><span class="line">                mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Watchdog.getInstance().resumeWatchingCurrentThread(<span class="string">"packagemanagermain"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// Set up the Application instance for the system process and get started.</span></span><br><span class="line">    t.traceBegin(<span class="string">"SetSystemProcess"</span>);</span><br><span class="line">    mActivityManagerService.setSystemProcess();</span><br><span class="line">    t.traceEnd();</span><br><span class="line">    <span class="comment">// Manages Overlay packages</span></span><br><span class="line">    t.traceBegin(<span class="string">"StartOverlayManagerService"</span>);</span><br><span class="line">    mSystemServiceManager.startService(<span class="keyword">new</span> OverlayManagerService(mSystemContext));</span><br><span class="line">    t.traceEnd();</span><br><span class="line">    t.traceEnd(); <span class="comment">// startBootstrapServices</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>我们前面提到过，所有可变 RRO 及所有 FRRO 都是在 OverlayManagerService 启动的时候被处理然后加入到 Resources 中的，而 PackageManagerService 刚好在 OverlayManagerService 之前启动（毕竟 OverlayManagerService 的初始化还要依赖 PackageManagerService 呢），在 PackageManagerService 去 <code>getString()</code> 的时候 FRRO 根本还没被加载呢，自然不可能读到我们预期的值，只能读到已经在 zygote 里被预加载的另一个 RRO 设定的值……</li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>FRRO 是一个很好的新东西，但是仍然不能完全替代传统的 app 格式的 RRO，除了能替换的资源类型受限之外，如果需要替换在系统启动非常早期就需要获取的值，遇到的加载时序问题可以说是根本无法解决的。另一方面，Google 的文档真的可用性堪忧，FRRO 这个特性可以说是完全没有任何文档，只能硬啃代码。这次可以说是踩了大部分人都碰不到的坑，以后还是老老实实用有文档的东西吧……</p><br><section class="widget copyright desktop mobile"><div class="content"><blockquote><p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p><p>本文永久链接是：<a href="https://blog.canyie.top/2025/08/24/android-runtime-resources-overlay-sequence/">https://blog.canyie.top/2025/08/24/android-runtime-resources-overlay-sequence/</a></p></blockquote></div></section></div><section class="meta" id="footer-meta"><div class="new-meta-box"><div class="new-meta-item date" itemprop="dateUpdated" datetime="2025-08-24T22:31:47+08:00"><a class="notlink"><i class="fas fa-edit fa-fw" aria-hidden="true"></i><p>更新于2025年8月24日</p></a></div><div class="new-meta-item meta-tags"><a class="tag" href="/tags/android/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>android</p></a></div><div class="new-meta-item meta-tags"><a class="tag" href="/tags/system/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>system</p></a></div><div class="new-meta-item meta-tags"><a class="tag" href="/tags/resources/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>resources</p></a></div><div class="new-meta-item share -mob-share-list"><div class="-mob-share-list share-body"><a class="-mob-share-qq" rel="external nofollow noopener noreferrer noopener" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.canyie.top/2025/08/24/android-runtime-resources-overlay-sequence/&title=Android Runtime Resources Overlay 加载时序分析 - 残页的小博客&summary=Fabricated Runtime Resources Overlay （FRRO） 是 Android 12 引入的一项新功能，它让开发者可以用代码或 shell 命令的方式动态操作 Runtime Resources Overlay（RRO） 而不需要像以前一样必须创建一个单独的 overlay app。然而四年后，网络上关于 FRRO 的文章依然少得可怜，所以在这里记录一次我调试 FRRO 问题的过程。" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qq.png"> </a><a class="-mob-share-qzone" rel="external nofollow noopener noreferrer noopener" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://blog.canyie.top/2025/08/24/android-runtime-resources-overlay-sequence/&title=Android Runtime Resources Overlay 加载时序分析 - 残页的小博客&summary=Fabricated Runtime Resources Overlay （FRRO） 是 Android 12 引入的一项新功能，它让开发者可以用代码或 shell 命令的方式动态操作 Runtime Resources Overlay（RRO） 而不需要像以前一样必须创建一个单独的 overlay app。然而四年后，网络上关于 FRRO 的文章依然少得可怜，所以在这里记录一次我调试 FRRO 问题的过程。" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qzone.png"> </a><a class="-mob-share-weibo" rel="external nofollow noopener noreferrer noopener" href="http://service.weibo.com/share/share.php?url=https://blog.canyie.top/2025/08/24/android-runtime-resources-overlay-sequence/&title=Android Runtime Resources Overlay 加载时序分析 - 残页的小博客&summary=Fabricated Runtime Resources Overlay （FRRO） 是 Android 12 引入的一项新功能，它让开发者可以用代码或 shell 命令的方式动态操作 Runtime Resources Overlay（RRO） 而不需要像以前一样必须创建一个单独的 overlay app。然而四年后，网络上关于 FRRO 的文章依然少得可怜，所以在这里记录一次我调试 FRRO 问题的过程。" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/weibo.png"></a></div></div></div></section><div class="prev-next"><a class="next" href="/2025/02/04/CVE-2024-49721/"><p class="title">CVE-2024-49721 InputMethodSubtypeArray 反序列化漏洞分析<i class="fas fa-chevron-right" aria-hidden="true"></i></p><p class="content">神马，都 2025 年啦，还有 Parcel Mismatch 漏洞？！？对！你没听错！最经典最被广泛利用的 Parcel Mismatch 漏洞，它又双叒叕来了！怕了吗？！？去年我和 Cxxs...</p></a></div></section></article><script>window.subData={title:"Android Runtime Resources Overlay 加载时序分析",tools:!0}</script></div><aside class="l_side"><section class="widget toc-wrapper shadow blur desktop mobile"><header><i class="fas fa-list fa-fw" aria-hidden="true"></i><span class="name">本文目录</span></header><div class="content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#起因：FRRO-失效？"><span class="toc-text">起因：FRRO 失效？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#不可变-RRO-在-Zygote-中的预加载"><span class="toc-text">不可变 RRO 在 Zygote 中的预加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#可变-RRO-的加载"><span class="toc-text">可变 RRO 的加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题解答"><span class="toc-text">问题解答</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol></div></section><section class="widget tagcloud shadow blur desktop mobile"><header><a href="/tags/"><i class="fas fa-tags fa-fw" aria-hidden="true"></i><span class="name">热门标签</span></a></header><div class="content"><a href="/tags/AOP/" style="font-size:15.67px;color:#8e8e8e">AOP</a> <a href="/tags/android/" style="font-size:24px;color:#555">android</a> <a href="/tags/art/" style="font-size:19px;color:#777">art</a> <a href="/tags/dex/" style="font-size:14px;color:#999">dex</a> <a href="/tags/hidden-api/" style="font-size:14px;color:#999">hidden-api</a> <a href="/tags/hook/" style="font-size:15.67px;color:#8e8e8e">hook</a> <a href="/tags/kernel/" style="font-size:15.67px;color:#8e8e8e">kernel</a> <a href="/tags/magisk/" style="font-size:17.33px;color:#828282">magisk</a> <a href="/tags/parcel/" style="font-size:14px;color:#999">parcel</a> <a href="/tags/property/" style="font-size:14px;color:#999">property</a> <a href="/tags/resources/" style="font-size:14px;color:#999">resources</a> <a href="/tags/system/" style="font-size:22.33px;color:#606060">system</a> <a href="/tags/xposed/" style="font-size:17.33px;color:#828282">xposed</a> <a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size:20.67px;color:#6c6c6c">安全</a> <a href="/tags/%E5%AE%89%E5%85%A8%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90%E6%A0%8F%E7%9B%AE/" style="font-size:15.67px;color:#8e8e8e">安全补丁分析栏目</a> <a href="/tags/%E5%B9%B4%E9%89%B4/" style="font-size:15.67px;color:#8e8e8e">年鉴</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" style="font-size:14px;color:#999">数据结构与算法</a> <a href="/tags/%E6%B3%A8%E5%85%A5/" style="font-size:15.67px;color:#8e8e8e">注入</a> <a href="/tags/%E8%88%AA%E7%A9%BA/" style="font-size:14px;color:#999">航空</a> <a href="/tags/%E9%97%B2%E8%81%8A/" style="font-size:17.33px;color:#828282">闲聊</a></div></section></aside><footer class="clearfix"><br><br><br><div class="social-wrapper"><a href="/atom.xml" class="social fas fa-rss flat-btn" target="_blank" rel="external nofollow noopener noreferrer"></a> <a href="mailto:a1364259@163.com" class="social fas fa-envelope flat-btn" target="_blank" rel="external nofollow noopener noreferrer"></a> <a href="https://github.com/canyie" class="social fab fa-github flat-btn" target="_blank" rel="external nofollow noopener noreferrer"></a></div><div><p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p></div>本站使用 <a href="https://volantis.js.org/" target="_blank" class="codename">Volantis</a> 作为主题，总访问量为 <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span> 次<div class="copyright"><p>如对本站有任何疑问或建议，欢迎到 <a href="https://github.com/canyie/canyie.github.io/issues/" target="_blank" rel="noopener">issues 区</a> 反馈~</p></div></footer><script>setLoadingBarProgress(80)</script><script>setLoadingBarProgress(60)</script></div><a class="s-top fas fa-arrow-up fa-fw" href="javascript:void(0)"></a></div><script src="https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js"></script><script>var SEARCH_SERVICE="hexo",ROOT="/";ROOT.endsWith("/")||(ROOT+="/")</script><script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script><script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script><script type="text/javascript">$(function(){Waves.attach(".flat-btn",["waves-button"]),Waves.attach(".float-btn",["waves-button","waves-float"]),Waves.attach(".float-btn-light",["waves-button","waves-float","waves-light"]),Waves.attach(".flat-box",["waves-block"]),Waves.attach(".float-box",["waves-block","waves-float"]),Waves.attach(".waves-image"),Waves.init()})</script><script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script><script type="text/javascript">$(function(){var a=["https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/BBC19066-E176-47C2-9D22-48C81EE5DF6B.jpeg"];!function(a){for(var t=a.length;t--;){var r=Math.floor(Math.random()*t),n=a[r];a[r]=a[t],a[t]=n}}(a),$.backstretch(a,{duration:"20000",fade:"1500"})})</script><script src="/js/app.js"></script><script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.4/js/search.js"></script><script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script><script>function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-check-circle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('fa-check-circle');
          $icon.addClass('fa-copy');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-times-circle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('fa-times-circle');
          $icon.addClass('fa-copy');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);</script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script>let LAZY_LOAD_IMAGE = "[object Object]";
  $(".article-entry").find("div.fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });</script><script>setLoadingBarProgress(100)</script><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var i=n.imageLazyLoadSetting.isSPA,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){i&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,e,a=0;a<r.length;a++)t=r[a],e=void 0,0<=(e=t.getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(n.innerHeight||document.documentElement.clientHeight)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},n.src=i}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body></html>